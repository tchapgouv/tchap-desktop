/*! For license information please see 4613.js.LICENSE.txt */
(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[4613],{"./res/img/element-icons/brands/apple.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/brands/apple.734de1e.svg"},"./res/img/element-icons/brands/facebook.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/brands/facebook.2061182.svg"},"./res/img/element-icons/brands/github.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/brands/github.a229f06.svg"},"./res/img/element-icons/brands/gitlab.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/brands/gitlab.9958062.svg"},"./res/img/element-icons/brands/google.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/brands/google.1573797.svg"},"./res/img/element-icons/brands/twitter.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/brands/twitter.b825e3c.svg"},"./res/img/element-icons/room/default_app.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/room/default_app.79b63ba.svg"},"./res/img/element-icons/room/default_cal.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/room/default_cal.6bea887.svg"},"./res/img/element-icons/room/default_clock.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/room/default_clock.d7c6411.svg"},"./res/img/element-icons/room/default_doc.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/room/default_doc.a42767c.svg"},"./res/img/element-icons/room/default_video.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/room/default_video.f29df7d.svg"},"./res/img/external-link.svg":(e,t,n)=>{"use strict";n.d(t,{I:()=>a});var i,r=n("./node_modules/react/index.js");function s(){return s=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},s.apply(null,arguments)}var o=function(e,t){return r.createElement("svg",s({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 11 10",role:"presentation","aria-hidden":!0,ref:t},e),i||(i=r.createElement("path",{fill:"none",fillRule:"evenodd",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",d:"M8.5 5.5v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h3M7 .5h3v3M4.5 6 10 .5"})))},a=(0,r.forwardRef)(o)},"./res/img/matrix.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/matrix.9166e4b.svg"},"./src/components/structures/ErrorMessage.tsx":(e,t,n)=>{"use strict";n.d(t,{K:()=>s});var i=n("./node_modules/react/index.js"),r=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/warning.js");const s=({message:e})=>{const t=e?i.createElement(r.A,{className:"mx_Icon mx_Icon_16"}):null;return i.createElement("div",{className:"mx_ErrorMessage"},t,e)}},"./src/components/views/auth/LoginWithQR-types.ts":(e,t,n)=>{"use strict";n.d(t,{HY:()=>s,Kt:()=>i,a0:()=>r});let i=function(e){return e.Show="show",e}({}),r=function(e){return e[e.Loading=0]="Loading",e[e.ShowingQR=1]="ShowingQR",e[e.OutOfBandConfirmation=2]="OutOfBandConfirmation",e[e.WaitingForDevice=3]="WaitingForDevice",e[e.Verifying=4]="Verifying",e[e.Error=5]="Error",e}({}),s=function(e){return e[e.Cancel=0]="Cancel",e[e.Decline=1]="Decline",e[e.Approve=2]="Approve",e[e.Back=3]="Back",e[e.ShowQr=4]="ShowQr",e}({})},"./src/components/views/auth/PassphraseConfirmField.tsx":(e,t,n)=>{"use strict";n.d(t,{A:()=>c});var i=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=n("./node_modules/react/index.js"),s=n("./src/components/views/elements/Field.tsx"),o=n("./src/components/views/elements/Validation.tsx"),a=n("./src/languageHandler.tsx");class l extends r.PureComponent{constructor(...e){super(...e),(0,i.A)(this,"validate",(0,o.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,a._t)(this.props.labelRequired)},{key:"match",test:({value:e})=>!e||e===this.props.password,invalid:()=>(0,a._t)(this.props.labelInvalid)}]})),(0,i.A)(this,"onValidate",(async e=>{const t=await this.validate(e);return this.props.onValidate&&this.props.onValidate(t),t}))}render(){return r.createElement(s.A,{id:this.props.id,ref:this.props.fieldRef,type:"password",label:(0,a._t)(this.props.label),autoComplete:this.props.autoComplete,value:this.props.value,onChange:this.props.onChange,onValidate:this.onValidate,autoFocus:this.props.autoFocus,tooltipAlignment:this.props.tooltipAlignment})}}(0,i.A)(l,"defaultProps",{label:(0,a.AO)("auth|change_password_confirm_label"),labelRequired:(0,a.AO)("auth|change_password_confirm_label"),labelInvalid:(0,a.AO)("auth|change_password_confirm_invalid")});const c=l},"./src/components/views/auth/PassphraseField.tsx":(e,t,n)=>{"use strict";n.d(t,{A:()=>f});var i,r=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=n("./node_modules/react/index.js"),o=n("./node_modules/classnames/index.js"),a=n.n(o),l=n("./src/SdkConfig.ts"),c=n("./src/components/views/elements/Validation.tsx"),d=n("./src/languageHandler.tsx"),u=n("./src/components/views/elements/Field.tsx"),m=n("./src/MatrixClientPeg.ts"),p=n("./src/tchap/util/TchapApi.ts"),h=n("./src/tchap/util/TchapUtils.ts");class g{static async getRules(){if(!this.passwordRules){const e=h.A.randomHomeServer().base_url,t=await fetch(`${e}${p.A.passwordRulesUrl}`);this.passwordRules=await t.json()}return this.passwordRules}static minimumLength(e,t){return e.length>=t}static requireUppercase(e,t){return!t||/[A-Z]/.test(e)}static requireSymbol(e,t){return!t||/[^a-zA-Z0-9]/.test(e)}static requireDigit(e,t){return!t||/[0-9]/.test(e)}static requireLowercase(e,t){return!t||/[a-z]/.test(e)}}i=g,(0,r.A)(g,"passwordRules",null),(0,r.A)(g,"validate",(async e=>{const t=e.value,n=await i.getRules(),r=Object.entries(n).reduce(((e,[n,r])=>{const s=((e,n)=>{switch(e){case"m.minimum_length":return i.minimumLength(t,n)?"":(0,d._t)("a minimum of %(number)s characters",{number:n});case"m.require_digit":return i.requireDigit(t,n)?"":(0,d._t)("a number");case"m.require_symbol":return i.requireSymbol(t,n)?"":(0,d._t)("a symbol");case"m.require_lowercase":return i.requireLowercase(t,n)?"":(0,d._t)("a lowercase letter");case"m.require_uppercase":return i.requireUppercase(t,n)?"":(0,d._t)("an uppercase letter");default:throw new Error("Unknown password rule : "+e)}})(n,r);return s.length&&e.push(s),e}),[]);return 0===r.length?{valid:!0}:{valid:!1,feedback:s.createElement("div",{className:"mx_Validation mx_Validation_invalid"},s.createElement("div",{className:"mx_Validation_description mx_Validation_invalid"},(0,d._t)("Your password must include:")),s.createElement("ul",{className:"mx_Validation_details"},r.map((e=>s.createElement("li",{className:"mx_Validation_detail mx_Validation_invalid"},e)))))}}));class v extends s.PureComponent{constructor(...e){super(...e),(0,r.A)(this,"validate",(0,c.A)({description:function(e){const t=e?e.score:0;return s.createElement("progress",{className:"mx_PassphraseField_progress",max:4,value:t})},deriveData:async({value:e})=>{if(!e)return null;const{scorePassword:t}=await Promise.all([n.e(6501),n.e(9393)]).then(n.bind(n,"./src/utils/PasswordScorer.ts"));return t(m.J.get(),e,this.props.userInputs)},rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,d._t)(this.props.labelEnterPassword)},{key:"complexity",test:async function({value:e},t){if(!e||!t)return!1;const n=t.score>=this.props.minScore;return l.Ay.get("dangerously_allow_unsafe_and_insecure_passwords")||n},valid:function(e){return e&&e.score>=this.props.minScore?(0,d._t)(this.props.labelStrongPassword):(0,d._t)(this.props.labelAllowedButUnsafe)},invalid:function(e){if(!e)return null;const{feedback:t}=e;return t.warning||t.suggestions[0]||(0,d._t)("auth|password_field_keep_going_prompt")}}],memoize:!0})),(0,r.A)(this,"onValidate",(async e=>{const t=await g.validate(e);return this.props.onValidate&&this.props.onValidate(t),t}))}render(){return s.createElement(u.A,{id:this.props.id,autoFocus:this.props.autoFocus,className:a()("mx_PassphraseField",this.props.className),ref:this.props.fieldRef,type:"password",autoComplete:"new-password",label:(0,d._t)(this.props.label),value:this.props.value,onChange:this.props.onChange,onValidate:this.onValidate,tooltipAlignment:this.props.tooltipAlignment})}}(0,r.A)(v,"defaultProps",{label:(0,d.AO)("common|password"),labelEnterPassword:(0,d.AO)("auth|password_field_label"),labelStrongPassword:(0,d.AO)("auth|password_field_strong_label"),labelAllowedButUnsafe:(0,d.AO)("auth|password_field_weak_label")});const f=v},"./src/components/views/dialogs/security/RestoreKeyBackupDialog.tsx":(e,t,n)=>{"use strict";n.d(t,{A:()=>f});var i=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=n("./node_modules/react/index.js"),s=n("./node_modules/matrix-js-sdk/src/matrix.ts"),o=n("./node_modules/matrix-js-sdk/src/crypto-api/index.ts"),a=n("./node_modules/matrix-js-sdk/src/logger.ts"),l=n("./src/MatrixClientPeg.ts"),c=n("./src/languageHandler.tsx"),d=n("./src/SecurityManager.ts"),u=n("./src/components/views/elements/Spinner.tsx"),m=n("./src/components/views/elements/DialogButtons.tsx"),p=n("./src/components/views/elements/AccessibleButton.tsx"),h=n("./src/components/views/dialogs/BaseDialog.tsx"),g=function(e){return e.Passphrase="passphrase",e.RecoveryKey="recovery_key",e.SecretStorage="secret_storage",e}(g||{}),v=function(e){return e.PreFetch="prefetch",e.Fetch="fetch",e.LoadKeys="load_keys",e}(v||{});class f extends r.PureComponent{constructor(e){super(e),(0,i.A)(this,"onCancel",(()=>{this.props.onFinished(!1)})),(0,i.A)(this,"onDone",(()=>{this.props.onFinished(!0)})),(0,i.A)(this,"onUseRecoveryKeyClick",(()=>{this.setState({forceRecoveryKey:!0})})),(0,i.A)(this,"progressCallback",(e=>{this.setState({progress:e})})),(0,i.A)(this,"onResetRecoveryClick",(()=>{this.props.onFinished(!1),(0,d.cb)((async()=>{}),{forceReset:!0})})),(0,i.A)(this,"onRecoveryKeyChange",(e=>{this.setState({recoveryKey:e.target.value,recoveryKeyValid:this.isValidRecoveryKey(e.target.value)})})),(0,i.A)(this,"onPassPhraseNext",(async()=>{const e=l.J.safeGet().getCrypto();if(e){this.setState({loading:!0,restoreError:null,restoreType:g.Passphrase});try{const t=await e.restoreKeyBackupWithPassphrase(this.state.passPhrase,{progressCallback:this.progressCallback});if(!this.props.showSummary)return void this.props.onFinished(!0);this.setState({loading:!1,recoverInfo:t})}catch(e){a.v.log("Error restoring backup",e),this.setState({loading:!1,restoreError:e})}}})),(0,i.A)(this,"onRecoveryKeyNext",(async()=>{var e;const t=l.J.safeGet().getCrypto();if(this.state.recoveryKeyValid&&null!==(e=this.state.backupInfo)&&void 0!==e&&e.version&&t){this.setState({loading:!0,restoreError:null,restoreType:g.RecoveryKey});try{await t.storeSessionBackupPrivateKey((0,o.decodeRecoveryKey)(this.state.recoveryKey),this.state.backupInfo.version);const e=await t.restoreKeyBackup({progressCallback:this.progressCallback});if(!this.props.showSummary)return void this.props.onFinished(!0);this.setState({loading:!1,recoverInfo:e})}catch(e){a.v.log("Error restoring backup",e),this.setState({loading:!1,restoreError:e})}}})),(0,i.A)(this,"onPassPhraseChange",(e=>{this.setState({passPhrase:e.target.value})})),this.state={backupInfo:null,loading:!1,loadError:null,restoreError:null,recoveryKey:"",recoverInfo:null,recoveryKeyValid:!1,forceRecoveryKey:!1,passPhrase:"",restoreType:null,progress:{stage:v.PreFetch}}}componentDidMount(){this.loadBackupStatus()}isValidRecoveryKey(e){try{return(0,o.decodeRecoveryKey)(e),!0}catch{return!1}}async restoreWithSecretStorage(){const e=l.J.safeGet().getCrypto();if(!e)return!1;this.setState({restoreError:null,restoreType:g.SecretStorage});try{let t=null;return await(0,d.cb)((async()=>{await e.loadSessionBackupPrivateKeyFromSecretStorage(),t=await e.restoreKeyBackup({progressCallback:this.progressCallback})})),this.setState({loading:!1,recoverInfo:t}),!0}catch(e){return a.v.log("restoreWithSecretStorage failed:",e),this.setState({restoreError:e,loading:!1}),!1}}async restoreWithCachedKey(e){const t=l.J.safeGet().getCrypto();if(!t)return!1;try{const e=await t.restoreKeyBackup({progressCallback:this.progressCallback});return this.setState({recoverInfo:e}),!0}catch(e){return a.v.log("restoreWithCachedKey failed:",e),!1}}async loadBackupStatus(){this.setState({loading:!0,loadError:null});try{var e,t;const n=l.J.safeGet(),i=null!==(e=await(null===(t=n.getCrypto())||void 0===t?void 0:t.getKeyBackupInfo()))&&void 0!==e?e:null,r=await n.secretStorage.hasKey()?await n.isKeyBackupKeyStored():null;this.setState({backupInfo:i});if(await this.restoreWithCachedKey(i))return a.v.log("RestoreKeyBackupDialog: found cached backup key"),void this.setState({loading:!1});if(r&&await this.restoreWithSecretStorage())return a.v.log("RestoreKeyBackupDialog: found backup key in secret storage"),void this.setState({loading:!1});this.setState({loadError:null,loading:!1})}catch(e){a.v.log("Error loading backup status",e),this.setState({loadError:!0,loading:!1})}}render(){const e=this.state.backupInfo&&this.state.backupInfo.auth_data&&this.state.backupInfo.auth_data.private_key_salt&&this.state.backupInfo.auth_data.private_key_iterations;let t,n;if(this.state.loading){let e;if(n=(0,c._t)("encryption|access_secret_storage_dialog|restoring"),this.state.progress.stage===v.Fetch)e=(0,c._t)("restore_key_backup_dialog|key_fetch_in_progress");else if(this.state.progress.stage===v.LoadKeys){const{total:t,successes:n,failures:i}=this.state.progress;e=(0,c._t)("restore_key_backup_dialog|load_keys_progress",{total:t,completed:(null!=n?n:0)+(null!=i?i:0)})}else this.state.progress.stage===v.PreFetch&&(e=(0,c._t)("restore_key_backup_dialog|key_fetch_in_progress"));t=r.createElement("div",null,r.createElement("div",null,e),r.createElement(u.A,null))}else if(this.state.loadError)n=(0,c._t)("common|error"),t=(0,c._t)("restore_key_backup_dialog|load_error_content");else if(this.state.restoreError)this.state.restoreError instanceof s.MatrixError&&this.state.restoreError.errcode===s.MatrixClient.RESTORE_BACKUP_ERROR_BAD_KEY?this.state.restoreType===g.RecoveryKey?(n=(0,c._t)("restore_key_backup_dialog|recovery_key_mismatch_title"),t=r.createElement("div",null,r.createElement("p",null,(0,c._t)("restore_key_backup_dialog|recovery_key_mismatch_description")))):(n=(0,c._t)("restore_key_backup_dialog|incorrect_security_phrase_title"),t=r.createElement("div",null,r.createElement("p",null,(0,c._t)("restore_key_backup_dialog|incorrect_security_phrase_dialog")))):(n=(0,c._t)("common|error"),t=(0,c._t)("restore_key_backup_dialog|restore_failed_error"));else if(null===this.state.backupInfo)n=(0,c._t)("common|error"),t=(0,c._t)("restore_key_backup_dialog|no_backup_error");else if(this.state.recoverInfo){let e;n=(0,c._t)("restore_key_backup_dialog|keys_restored_title"),this.state.recoverInfo.total>this.state.recoverInfo.imported&&(e=r.createElement("p",null,(0,c._t)("restore_key_backup_dialog|count_of_decryption_failures",{failedCount:this.state.recoverInfo.total-this.state.recoverInfo.imported}))),t=r.createElement("div",null,r.createElement("p",null,(0,c._t)("restore_key_backup_dialog|count_of_successfully_restored_keys",{sessionCount:this.state.recoverInfo.imported})),e,r.createElement(m.A,{primaryButton:(0,c._t)("action|ok"),onPrimaryButtonClick:this.onDone,hasCancel:!1,focus:!0}))}else if(e&&!this.state.forceRecoveryKey)n=(0,c._t)("restore_key_backup_dialog|enter_phrase_title"),t=r.createElement("div",null,r.createElement("p",null,(0,c._t)("restore_key_backup_dialog|key_backup_warning",{},{b:e=>r.createElement("strong",null,e)})),r.createElement("p",null,(0,c._t)("restore_key_backup_dialog|enter_phrase_description")),r.createElement("form",{className:"mx_RestoreKeyBackupDialog_primaryContainer"},r.createElement("input",{type:"password",className:"mx_RestoreKeyBackupDialog_passPhraseInput",onChange:this.onPassPhraseChange,value:this.state.passPhrase,autoFocus:!0}),r.createElement(m.A,{primaryButton:(0,c._t)("action|next"),onPrimaryButtonClick:this.onPassPhraseNext,primaryIsSubmit:!0,hasCancel:!0,onCancel:this.onCancel,focus:!1})),(0,c._t)("restore_key_backup_dialog|phrase_forgotten_text",{},{button1:e=>r.createElement(p.A,{kind:"link_inline",onClick:this.onUseRecoveryKeyClick},e),button2:e=>r.createElement(p.A,{kind:"link_inline",onClick:this.onResetRecoveryClick},e)}));else{let e;n=(0,c._t)("restore_key_backup_dialog|enter_key_title"),e=0===this.state.recoveryKey.length?r.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"}):this.state.recoveryKeyValid?r.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"},"ðŸ‘ ",(0,c._t)("restore_key_backup_dialog|key_is_valid")):r.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"},"ðŸ‘Ž ",(0,c._t)("restore_key_backup_dialog|key_is_invalid")),t=r.createElement("div",null,r.createElement("p",null,(0,c._t)("restore_key_backup_dialog|key_backup_warning",{},{b:e=>r.createElement("strong",null,e)})),r.createElement("p",null,(0,c._t)("restore_key_backup_dialog|enter_key_description")),r.createElement("div",{className:"mx_RestoreKeyBackupDialog_primaryContainer"},r.createElement("input",{className:"mx_RestoreKeyBackupDialog_recoveryKeyInput",onChange:this.onRecoveryKeyChange,value:this.state.recoveryKey,autoFocus:!0}),e,r.createElement(m.A,{primaryButton:(0,c._t)("action|next"),onPrimaryButtonClick:this.onRecoveryKeyNext,hasCancel:!0,onCancel:this.onCancel,focus:!1,primaryDisabled:!this.state.recoveryKeyValid})),(0,c._t)("restore_key_backup_dialog|key_forgotten_text",{},{button:e=>r.createElement(p.A,{kind:"link_inline",onClick:this.onResetRecoveryClick},e)}))}return r.createElement(h.A,{className:"mx_RestoreKeyBackupDialog",onFinished:this.props.onFinished,title:n},r.createElement("div",{className:"mx_RestoreKeyBackupDialog_content"},t))}}(0,i.A)(f,"defaultProps",{showSummary:!0})},"./src/components/views/settings/KeyboardShortcut.tsx":(e,t,n)=>{"use strict";n.d(t,{S:()=>l});var i=n("./node_modules/react/index.js"),r=n("./src/accessibility/KeyboardShortcuts.ts"),s=n("./src/Keyboard.ts"),o=n("./src/languageHandler.tsx");const a=({name:e,last:t})=>{const n=r.GA[e],s=r.hm[e];return i.createElement(i.Fragment,null,i.createElement("kbd",null," ",n||s&&(0,o._t)(s)||e," "),!t&&"+")},l=({value:e,className:t="mx_KeyboardShortcut"})=>{if(!e)return null;const n=[];return e.ctrlOrCmdKey?n.push(i.createElement(a,{key:"ctrlOrCmdKey",name:s.vL?s.Uz.META:s.Uz.CONTROL})):e.ctrlKey?n.push(i.createElement(a,{key:"ctrlKey",name:s.Uz.CONTROL})):e.metaKey&&n.push(i.createElement(a,{key:"metaKey",name:s.Uz.META})),e.altKey&&n.push(i.createElement(a,{key:"altKey",name:s.Uz.ALT})),e.shiftKey&&n.push(i.createElement(a,{key:"shiftKey",name:s.Uz.SHIFT})),i.createElement("div",{className:t},n,i.createElement(a,{name:e.key,last:!0}))}},"./src/vector/app.tsx":(e,t,n)=>{"use strict";n.r(t),n.d(t,{loadApp:()=>$P});var i=n("./node_modules/matrix-js-sdk/src/matrix.ts");if(globalThis.__js_sdk_entrypoint)throw new Error("Multiple matrix-js-sdk entrypoints detected!");let r;globalThis.__js_sdk_entrypoint=!0;try{r=globalThis.indexedDB}catch{}r&&i.setCryptoStoreFactory((()=>new i.IndexedDBCryptoStore(r,"matrix-js-sdk:crypto"))),globalThis.matrixcs=i;var s=n("./node_modules/react/index.js"),o=n("./node_modules/matrix-js-sdk/src/logger.ts"),a=n("./node_modules/@matrix-org/react-sdk-module-api/lib/lifecycles/WrapperLifecycle.js"),l=n("./src/PlatformPeg.ts"),c=n("./src/utils/AutoDiscoveryUtils.tsx"),d=n("./src/Lifecycle.ts"),u=n("./src/SdkConfig.ts"),m=n("./src/utils/SnakedObject.ts"),p=n("./node_modules/@babel/runtime/helpers/esm/extends.js"),h=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),g=n("./node_modules/matrix-js-sdk/src/utils.ts"),v=n("./node_modules/lodash/lodash.js"),f=n("./node_modules/matrix-js-sdk/src/crypto-api/index.ts"),_=n("./node_modules/@vector-im/compound-web/dist/components/Tooltip/TooltipProvider.js"),y=(n("./node_modules/what-input/dist/what-input.js"),n("./src/PosthogTrackers.ts")),b=n("./src/DecryptionFailureTracker.ts"),E=n("./src/MatrixClientPeg.ts"),w=n("./src/dispatcher/dispatcher.ts"),S=n("./src/Notifier.ts"),A=n("./src/Modal.tsx"),C=n("./src/RoomInvite.tsx"),x=n("./src/Rooms.ts"),k=n("./node_modules/matrix-js-sdk/src/version-support.ts"),R=n("./src/dispatcher/actions.ts"),I=n("./src/stores/AsyncStore.ts"),T=n("./src/stores/ToastStore.ts"),P=n("./src/languageHandler.tsx"),N=n("./src/components/views/toasts/GenericToast.tsx");const D={deferredAction:null};class M extends I.y{constructor(){super(w.A,D)}onDispatch(e){switch(e.action){case R.r.DoAfterSyncPrepared:this.updateState({deferredAction:e.deferred_action});break;case"cancel_after_sync_prepared":this.updateState({deferredAction:null});break;case"MatrixActions.sync":{if(e.state===i.SyncState.Syncing&&e.prevState!==i.SyncState.Syncing&&async function(){try{const e=E.J.get();if(!e)return;for(const t of k.Hr)if(await e.isVersionSupported(t))return;const t="LEGACY_SERVER";T.A.sharedInstance().addOrReplaceToast({key:t,title:(0,P._t)("unsupported_server_title"),props:{description:(0,P._t)("unsupported_server_description",{version:k.eD,brand:u.Ay.get().brand}),primaryLabel:(0,P._t)("action|ok"),onPrimaryClick:()=>{T.A.sharedInstance().dismissToast(t)}},component:N.A,priority:98})}catch(e){o.v.warn("Failed to check server versions",e)}}(),"PREPARED"!==e.state)break;if(!this.state.deferredAction)break;const t=Object.assign({},this.state.deferredAction);this.updateState({deferredAction:null}),w.A.dispatch(t);break}case"on_client_not_viable":case R.r.OnLoggedOut:this.reset()}}}let O=null;O||(O=new M);var L,F=n("./node_modules/uuid/dist/esm-browser/v4.js"),U=n("./src/rageshake/submit-rageshake.ts"),B=n("./src/stores/AsyncStoreWithClient.ts"),V=n("./src/settings/SettingsStore.ts");function j(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function z(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?j(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):j(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const W="im.vector.auto_rs_request";class H extends B.r{constructor(){super(w.A,{reportedSessionIds:new Set,lastRageshakeTime:0,initialSyncCompleted:!1}),this.onDecryptionAttempt=this.onDecryptionAttempt.bind(this),this.onDeviceMessage=this.onDeviceMessage.bind(this),this.onSyncStateChange=this.onSyncStateChange.bind(this)}static get instance(){return H.internalInstance}async onAction(e){if(e.action===R.r.ReportKeyBackupNotEnabled)this.onReportKeyBackupNotEnabled()}async onReady(){V.A.getValue("automaticDecryptionErrorReporting")&&this.matrixClient&&(this.matrixClient.on(i.MatrixEventEvent.Decrypted,this.onDecryptionAttempt),this.matrixClient.on(i.ClientEvent.ToDeviceEvent,this.onDeviceMessage),this.matrixClient.on(i.ClientEvent.Sync,this.onSyncStateChange))}async onNotReady(){this.matrixClient&&(this.matrixClient.removeListener(i.ClientEvent.ToDeviceEvent,this.onDeviceMessage),this.matrixClient.removeListener(i.MatrixEventEvent.Decrypted,this.onDecryptionAttempt),this.matrixClient.removeListener(i.ClientEvent.Sync,this.onSyncStateChange))}async onDecryptionAttempt(e){if(!this.state.initialSyncCompleted)return;const t=e.getWireContent(),n=t.session_id;if(e.isDecryptionFailure()&&!this.state.reportedSessionIds.has(n)){var r;if(await(0,g.yy)(5e3),!e.isDecryptionFailure())return;const s=new Set(this.state.reportedSessionIds);await this.updateState({reportedSessionIds:s.add(n)});const a=(new Date).getTime();if(a-this.state.lastRageshakeTime<6e4)return void o.v.info(`Not sending recipient-side autorageshake for event ${e.getId()}/session ${n}: last rageshake was too recent`);await this.updateState({lastRageshakeTime:a});const l=e.getSender(),c={event_id:e.getId(),room_id:e.getRoomId(),session_id:n,device_id:t.device_id,user_id:l,sender_key:t.sender_key};o.v.info(`Sending recipient-side autorageshake for event ${e.getId()}/session ${n}`);const d=await(0,U.Ay)(u.Ay.get().bug_report_endpoint_url,{userText:"Auto-reporting decryption error (recipient)",sendLogs:!0,labels:["Z-UISI","web","uisi-recipient"],customApp:u.Ay.get().uisi_autorageshake_app,customFields:{auto_uisi:JSON.stringify(c)}}),m=z(z({},c),{},{recipient_rageshake:d,[i.ToDeviceMessageId]:(0,F.A)()});null===(r=this.matrixClient)||void 0===r||r.sendToDevice(W,new Map([[l,new Map([[m.device_id,m]])]]))}}async onSyncStateChange(e,t,n){this.state.initialSyncCompleted||await this.updateState({initialSyncCompleted:!(null==n||!n.nextSyncToken)})}async onDeviceMessage(e){if(e.getType()!==W)return;const t=e.getContent(),n=t.recipient_rageshake||"",i=(new Date).getTime();i-this.state.lastRageshakeTime>6e4?(await this.updateState({lastRageshakeTime:i}),o.v.info(`Sending sender-side autorageshake for event ${t.event_id}/session ${t.session_id}`),await(0,U.Ay)(u.Ay.get().bug_report_endpoint_url,{userText:`Auto-reporting decryption error (sender)\nRecipient rageshake: ${n}`,sendLogs:!0,labels:["Z-UISI","web","uisi-sender"],customApp:u.Ay.get().uisi_autorageshake_app,customFields:{recipient_rageshake:n,auto_uisi:JSON.stringify(t)}})):o.v.info(`Not sending sender-side autorageshake for event ${t.event_id}/session ${t.session_id}: last rageshake was too recent`)}async onReportKeyBackupNotEnabled(){V.A.getValue("automaticKeyBackNotEnabledReporting")&&await(0,U.Ay)(u.Ay.get().bug_report_endpoint_url,{userText:"Auto-reporting key backup not enabled",sendLogs:!0,labels:["web",R.r.ReportKeyBackupNotEnabled]})}}L=H,(0,h.A)(H,"internalInstance",(()=>{const e=new L;return e.start(),e})()),window.mxAutoRageshakeStore=H.instance;var G=n("./src/PageTypes.ts"),K=n("./src/createRoom.ts"),J=n("./src/settings/controllers/ThemeController.ts"),q=n("./src/components/views/dialogs/QuestionDialog.tsx"),$=n("./src/settings/UIFeature.ts");const Y=/^[a-z0-9=_\-./]+$/;var Z=n("./node_modules/events/events.js");class X extends Z.EventEmitter{constructor(...e){super(...e),(0,h.A)(this,"_isResizing",!1),(0,h.A)(this,"throttledMiddlePanel",(0,v.throttle)((()=>this.emit("middlePanelResized")),200))}get isResizing(){return this._isResizing}startResizing(){this._isResizing=!0,this.emit("isResizing",!0)}stopResizing(){this._isResizing=!1,this.emit("isResizing",!1)}noisyMiddlePanel(){this.emit("middlePanelResizedNoisy")}updateMiddlePanel(){this.throttledMiddlePanel(),this.noisyMiddlePanel()}notifyLeftHandleResized(){this.updateMiddlePanel()}notifyRightHandleResized(){this.updateMiddlePanel()}notifyTimelineHeightChanged(){this.updateMiddlePanel()}notifyWindowResized(){this.updateMiddlePanel()}}var Q=n("./src/settings/watchers/ThemeWatcher.ts"),ee=n("./src/settings/watchers/FontWatcher.ts"),te=n("./src/RoomAliasCache.ts"),ne=n("./src/utils/StorageManager.ts"),ie=n("./node_modules/classnames/index.js"),re=n.n(ie),se=n("./src/Keyboard.ts"),oe=n("./src/MediaDeviceHandler.ts"),ae=n("./src/settings/SettingLevel.ts");const le=({vertical:e,reverse:t,id:n,passRef:i})=>{const r=["mx_ResizeHandle"];return e?r.push("mx_ResizeHandle--vertical"):r.push("mx_ResizeHandle--horizontal"),t&&r.push("mx_ResizeHandle_reverse"),s.createElement("div",{ref:i,className:r.join(" "),"data-id":n},s.createElement("div",null))};class ce{constructor(e,t,n,i){(0,h.A)(this,"domNode",void 0),(0,h.A)(this,"id",void 0),(0,h.A)(this,"reverse",void 0),this.resizer=t,this.sizer=n,this.container=i,this.reverse=t.isReverseResizeHandle(e),this.domNode=i||(this.reverse?e.nextElementSibling:e.previousElementSibling),this.id=e.getAttribute("data-id")}copyWith(e,t,n,i){return new(0,this.constructor)(e,t,n,i)}advance(e){let t=this.reverse?this.domNode.previousElementSibling:this.domNode.nextElementSibling;const n=e!==this.reverse;do{var i,r;if(n)t=null===(i=t)||void 0===i?void 0:i.nextElementSibling;else t=null===(r=t)||void 0===r?void 0:r.previousElementSibling}while(t&&!this.resizer.isResizeHandle(t));if(t){const e=this.copyWith(t,this.resizer,this.sizer);return e.reverse=this.reverse,e}}next(){return this.advance(!0)}previous(){return this.advance(!1)}size(){return this.sizer.getItemSize(this.domNode)}offset(){return this.sizer.getItemOffset(this.domNode)}start(){this.sizer.start(this.domNode)}finish(){this.sizer.finish(this.domNode)}getSize(){return this.sizer.getDesiredItemSize(this.domNode)}setRawSize(e){this.sizer.setItemSize(this.domNode,e)}setSize(e){var t,n;this.setRawSize(`${Math.round(e)}px`),null===(t=this.resizer.config)||void 0===t||null===(n=t.onResized)||void 0===n||n.call(t,e,this.id,this.domNode)}clearSize(){var e,t;this.sizer.clearItemSize(this.domNode),null===(e=this.resizer.config)||void 0===e||null===(t=e.onResized)||void 0===t||t.call(e,null,this.id,this.domNode)}first(){var e;if(null===(e=this.domNode.parentElement)||void 0===e||!e.children)return;const t=Array.from(this.domNode.parentElement.children).find((e=>this.resizer.isResizeHandle(e)));return t?this.copyWith(t,this.resizer,this.sizer):void 0}last(){var e;if(null===(e=this.domNode.parentElement)||void 0===e||!e.children)return;const t=Array.from(this.domNode.parentElement.children).reverse().find((e=>this.resizer.isResizeHandle(e)));return t?this.copyWith(t,this.resizer,this.sizer):void 0}}class de{constructor(e,t,n){this.container=e,this.vertical=t,this.reverse=n}getItemOffset(e){const t=(this.vertical?e.offsetTop:e.offsetLeft)-this.getOffset();return this.reverse?this.getTotalSize()-(t+this.getItemSize(e)):t}getItemSize(e){return this.vertical?e.offsetHeight:e.offsetWidth}getTotalSize(){return this.vertical?this.container.offsetHeight:this.container.offsetWidth}getOffset(){return this.vertical?this.container.offsetTop:this.container.offsetLeft}getPageOffset(){let e=this.container,t=0;for(;e;){t+=this.vertical?e.offsetTop:e.offsetLeft,e=e.offsetParent}return t}getDesiredItemSize(e){return this.vertical?e.style.height:e.style.width}setItemSize(e,t){this.vertical?e.style.height=t:e.style.width=t}clearItemSize(e){this.vertical?e.style.removeProperty("height"):e.style.removeProperty("width")}start(e){}finish(e){}offsetFromEvent(e){const t=this.vertical?e.pageY:e.pageX;return this.reverse?this.getPageOffset()+this.getTotalSize()-t:t-this.getPageOffset()}}class ue{static createSizer(e,t,n){return new de(e,t,n)}constructor(e){(0,h.A)(this,"beforeOffset",void 0),this.item=e,this.beforeOffset=e.offset()}get size(){return this.item.getSize()}set size(e){this.item.setRawSize(e)}resize(e){this.item.setSize(e)}resizeFromContainerOffset(e){this.resize(e-this.beforeOffset)}start(){this.item.start()}finish(){this.item.finish()}}class me extends ue{static createItem(e,t,n){return new ce(e,t,n)}}class pe extends ce{notifyCollapsed(e){var t,n;null===(t=this.resizer.config)||void 0===t||null===(n=t.onCollapsed)||void 0===n||n.call(t,e,this.id,this.domNode)}get isCollapsed(){var e,t,n;return null!==(e=null===(t=this.resizer.config)||void 0===t||null===(n=t.isItemCollapsed)||void 0===n?void 0:n.call(t,this.domNode))&&void 0!==e&&e}}class he extends ue{static createItem(e,t,n,i){return new pe(e,t,n,i)}constructor(e){var t;super(e),(0,h.A)(this,"toggleSize",void 0),(0,h.A)(this,"isCollapsed",void 0),this.toggleSize=null===(t=e.resizer)||void 0===t||null===(t=t.config)||void 0===t?void 0:t.toggleSize,this.isCollapsed=e.isCollapsed}resize(e){const t=!!this.toggleSize&&e<this.toggleSize;t!==this.isCollapsed&&(this.isCollapsed=t,this.item.notifyCollapsed(t)),t||super.resize(e)}}class ge{constructor(e,t,n){(0,h.A)(this,"classNames",void 0),(0,h.A)(this,"onMouseDown",(e=>{var t,n,i;if(0!==e.button)return;const r=e.target&&e.target.closest(`.${this.classNames.handle}`),s=null==this||null===(t=this.config)||void 0===t?void 0:t.handler;if(!r||!s&&r.parentElement!==this.container||s&&r!==s)return;var o;(e.preventDefault(),this.classNames.resizing)&&(null===(o=this.container)||void 0===o||null===(o=o.classList)||void 0===o||o.add(this.classNames.resizing));null===(n=this.config)||void 0===n||null===(i=n.onResizeStart)||void 0===i||i.call(n);const{sizer:a,distributor:l}=this.createSizerAndDistributor(r);l.start();const c=e=>{const t=a.offsetFromEvent(e);l.resizeFromContainerOffset(t)},d=document.body,u=()=>{var e,t,n;this.classNames.resizing&&(null===(n=this.container)||void 0===n||null===(n=n.classList)||void 0===n||n.remove(this.classNames.resizing));l.finish(),null===(e=this.config)||void 0===e||null===(t=e.onResizeStop)||void 0===t||t.call(e),d.removeEventListener("mouseup",u,!1),document.removeEventListener("mouseleave",u,!1),d.removeEventListener("mousemove",c,!1)};d.addEventListener("mouseup",u,!1),document.addEventListener("mouseleave",u,!1),d.addEventListener("mousemove",c,!1)})),(0,h.A)(this,"onResize",(0,v.throttle)((()=>{const e=this.getDistributors();e.forEach((e=>e.start())),e.forEach((e=>e.finish()))}),100,{trailing:!0,leading:!0})),(0,h.A)(this,"getDistributors",(()=>this.getResizeHandles().map((e=>{const{distributor:t}=this.createSizerAndDistributor(e);return t})))),this.container=e,this.distributorCtor=t,this.config=n,this.classNames={handle:"resizer-handle",reverse:"resizer-reverse",vertical:"resizer-vertical",resizing:"resizer-resizing"}}setClassNames(e){this.classNames=e}attach(){var e,t;const n=null!==(e=null==this||null===(t=this.config)||void 0===t||null===(t=t.handler)||void 0===t?void 0:t.parentElement)&&void 0!==e?e:this.container;null==n||n.addEventListener("mousedown",this.onMouseDown,!1),window.addEventListener("resize",this.onResize)}detach(){var e,t;const n=null!==(e=null==this||null===(t=this.config)||void 0===t||null===(t=t.handler)||void 0===t?void 0:t.parentElement)&&void 0!==e?e:this.container;null==n||n.removeEventListener("mousedown",this.onMouseDown,!1),window.removeEventListener("resize",this.onResize)}forHandleAt(e){const t=this.getResizeHandles()[e];if(t){const{distributor:e}=this.createSizerAndDistributor(t);return e}}forHandleWithId(e){const t=this.getResizeHandles().find((t=>t.getAttribute("data-id")===e));if(t){const{distributor:e}=this.createSizerAndDistributor(t);return e}}isReverseResizeHandle(e){return e.classList.contains(this.classNames.reverse)}isResizeHandle(e){return e.classList.contains(this.classNames.handle)}createSizerAndDistributor(e){var t;const n=e.classList.contains(this.classNames.vertical),i=this.isReverseResizeHandle(e),r=this.distributorCtor,s=null!==(t=this.config)&&void 0!==t&&t.handler?this.container:void 0,o=r.createSizer(this.container,n,i),a=r.createItem(e,this,o,null!=s?s:void 0);return{sizer:o,distributor:new r(a)}}getResizeHandles(){var e,t;return null!=this&&null!==(e=this.config)&&void 0!==e&&e.handler?[this.config.handler]:null!==(t=this.container)&&void 0!==t&&t.children?Array.from(this.container.querySelectorAll(`.${this.classNames.handle}`)):[]}}var ve=n("./src/stores/room-list/models.ts"),fe=n("./src/utils/ErrorUtils.tsx");const _e="serverlimit",ye=()=>{T.A.sharedInstance().dismissToast(_e)};var be=n("./src/components/views/rooms/RoomList.tsx"),Ee=n("./src/LegacyCallHandler.tsx"),we=n("./src/components/views/rooms/RoomSublist.tsx"),Se=n("./src/accessibility/KeyboardShortcuts.ts"),Ae=n("./src/components/views/elements/AccessibleButton.tsx");class Ce extends s.PureComponent{constructor(...e){super(...e),(0,h.A)(this,"dispatcherRef",void 0),(0,h.A)(this,"onAction",(e=>{"focus_room_filter"===e.action&&this.openSpotlight()}))}componentDidMount(){this.dispatcherRef=w.A.register(this.onAction)}componentWillUnmount(){w.A.unregister(this.dispatcherRef)}openSpotlight(){w.A.fire(R.r.OpenSpotlight)}render(){const e=re()({mx_RoomSearch:!0,mx_RoomSearch_minimized:this.props.isMinimized},"mx_RoomSearch_spotlightTrigger"),t=s.createElement("div",{className:"mx_RoomSearch_icon"}),n=s.createElement("kbd",{className:"mx_RoomSearch_shortcutPrompt"},se.vL?"âŒ˜ K":(0,P._t)(Se.hm[se.Uz.CONTROL])+" K");return s.createElement(Ae.A,{onClick:this.openSpotlight,className:e,"aria-label":(0,P._t)("action|search")},t,!this.props.isMinimized&&s.createElement("div",{className:"mx_RoomSearch_spotlightTriggerText"},(0,P._t)("action|search")),n)}}var xe=n("./src/stores/spaces/SpaceStore.ts"),ke=n("./src/stores/spaces/index.ts"),Re=n("./src/KeyBindingsManager.ts"),Ie=n("./src/stores/UIStore.ts"),Te=n("./node_modules/@vector-im/compound-web/dist/components/Tooltip/Tooltip.js"),Pe=n("./src/contexts/MatrixClientContext.tsx"),Ne=n("./src/customisations/helpers/UIComponents.ts"),De=n("./src/hooks/useDispatcher.ts"),Me=n("./src/hooks/useEventEmitter.ts"),Oe=n("./src/hooks/useSettings.ts"),Le=n("./src/utils/space.tsx"),Fe=n("./src/components/structures/ContextMenu.tsx"),Ue=n("./src/components/views/beta/BetaCard.tsx"),Be=n("./src/components/views/context_menus/IconizedContextMenu.tsx"),Ve=n("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),je=n("./src/utils/leave-behaviour.ts");const ze=["space","hideHeader","onFinished"],We=e=>{let{space:t,hideHeader:n,onFinished:r}=e,o=(0,Ve.A)(e,ze);const a=(0,s.useContext)(Pe.Ay).getSafeUserId(),l=(0,Oe.ny)("feature_video_rooms"),c=(0,Oe.ny)("feature_element_call_video_rooms");if(!t)return null;let d=null;if("public"===t.getJoinRule()||t.canInvite(a)){const e=e=>{e.preventDefault(),e.stopPropagation(),(0,Le.Lo)(t),r()};d=s.createElement(Be.R$,{className:"mx_SpacePanel_contextMenu_inviteButton",iconClassName:"mx_SpacePanel_iconInvite",label:(0,P._t)("action|invite"),onClick:e})}let u=null,m=null;if((0,Le.Kv)(t)){const e=e=>{e.preventDefault(),e.stopPropagation(),(0,Le.hL)(t),r()};u=s.createElement(Be.R$,{iconClassName:"mx_SpacePanel_iconSettings",label:(0,P._t)("common|settings"),onClick:e})}else{const e=e=>{e.preventDefault(),e.stopPropagation(),(0,je.e)(t),r()};m=s.createElement(Be.R$,{iconClassName:"mx_SpacePanel_iconLeave",className:"mx_IconizedContextMenu_option_red",label:(0,P._t)("space|leave_dialog_action"),onClick:e})}let h=null;if(V.A.getValue("developerMode")){const e=e=>{e.preventDefault(),e.stopPropagation(),w.A.dispatch({action:R.r.ViewRoom,room_id:t.roomId,forceTimeline:!0,metricsTrigger:void 0}),r()};h=s.createElement(Be.R$,{iconClassName:"mx_SpacePanel_iconSettings",label:(0,P._t)("space|context_menu|devtools_open_timeline"),onClick:e})}const g=t.currentState.maySendStateEvent(i.EventType.SpaceChild,a),v=g&&(0,Ne.g)($.C.CreateRooms),f=v&&l,_=g&&(0,Ne.g)($.C.CreateSpaces);let b=null;if(v||_){const e=e=>{e.preventDefault(),e.stopPropagation(),y.A.trackInteraction("WebSpaceContextMenuNewRoomItem",e),(0,Le.PT)(t),r()},n=e=>{e.preventDefault(),e.stopPropagation(),(0,Le.PT)(t,c?i.RoomType.UnstableCall:i.RoomType.ElementVideo),r()};b=s.createElement(s.Fragment,null,s.createElement("div",{className:"mx_SpacePanel_contextMenu_separatorLabel"},(0,P._t)("action|add")),v&&s.createElement(Be.R$,{iconClassName:"mx_SpacePanel_iconPlus",label:(0,P._t)("common|room"),onClick:e}),f&&s.createElement(Be.R$,{iconClassName:"mx_SpacePanel_iconPlus",label:(0,P._t)("common|video_room"),onClick:n},s.createElement(Ue.s,null)))}const E=e=>{e.preventDefault(),e.stopPropagation(),w.A.dispatch({action:R.r.ViewRoom,room_id:t.roomId,metricsTrigger:void 0}),r()};return s.createElement(Be.Ay,(0,p.A)({},o,{onFinished:r,className:"mx_SpacePanel_contextMenu",compact:!0}),!n&&s.createElement("div",{className:"mx_SpacePanel_contextMenu_header"},t.name),s.createElement(Be.tx,{first:!0},s.createElement(Be.R$,{iconClassName:"mx_SpacePanel_iconHome",label:(0,P._t)("space|context_menu|home"),onClick:e=>{y.A.trackInteraction("WebSpaceContextMenuHomeItem",e),E(e)}}),d,s.createElement(Be.R$,{iconClassName:"mx_SpacePanel_iconExplore",label:v?(0,P._t)("space|context_menu|manage_and_explore"):(0,P._t)("space|context_menu|explore"),onClick:e=>{y.A.trackInteraction("WebSpaceContextMenuExploreRoomsItem",e),E(e)}}),s.createElement(Be.R$,{iconClassName:"mx_SpacePanel_iconPreferences",label:(0,P._t)("common|preferences"),onClick:e=>{e.preventDefault(),e.stopPropagation(),(0,Le.Wi)(t),r()}}),h,u,m,b))};var He=n("./src/components/views/elements/InlineSpinner.tsx"),Ge=n("./node_modules/@babel/runtime/helpers/esm/inheritsLoose.js");function Ke(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Je(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ke(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ke(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function qe(e){return"Minified Redux error #"+e+"; visit https://redux.js.org/Errors?code="+e+" for the full message or use the non-minified dev environment for full errors. "}var $e="function"==typeof Symbol&&Symbol.observable||"@@observable",Ye=function(){return Math.random().toString(36).substring(7).split("").join(".")},Ze={INIT:"@@redux/INIT"+Ye(),REPLACE:"@@redux/REPLACE"+Ye(),PROBE_UNKNOWN_ACTION:function(){return"@@redux/PROBE_UNKNOWN_ACTION"+Ye()}};function Xe(e){if("object"!=typeof e||null===e)return!1;for(var t=e;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}function Qe(e,t,n){var i;if("function"==typeof t&&"function"==typeof n||"function"==typeof n&&"function"==typeof arguments[3])throw new Error(qe(0));if("function"==typeof t&&void 0===n&&(n=t,t=void 0),void 0!==n){if("function"!=typeof n)throw new Error(qe(1));return n(Qe)(e,t)}if("function"!=typeof e)throw new Error(qe(2));var r=e,s=t,o=[],a=o,l=!1;function c(){a===o&&(a=o.slice())}function d(){if(l)throw new Error(qe(3));return s}function u(e){if("function"!=typeof e)throw new Error(qe(4));if(l)throw new Error(qe(5));var t=!0;return c(),a.push(e),function(){if(t){if(l)throw new Error(qe(6));t=!1,c();var n=a.indexOf(e);a.splice(n,1),o=null}}}function m(e){if(!Xe(e))throw new Error(qe(7));if(void 0===e.type)throw new Error(qe(8));if(l)throw new Error(qe(9));try{l=!0,s=r(s,e)}finally{l=!1}for(var t=o=a,n=0;n<t.length;n++){(0,t[n])()}return e}return m({type:Ze.INIT}),(i={dispatch:m,subscribe:u,getState:d,replaceReducer:function(e){if("function"!=typeof e)throw new Error(qe(10));r=e,m({type:Ze.REPLACE})}})[$e]=function(){var e,t=u;return(e={subscribe:function(e){if("object"!=typeof e||null===e)throw new Error(qe(11));function n(){e.next&&e.next(d())}return n(),{unsubscribe:t(n)}}})[$e]=function(){return this},e},i}function et(e,t){return function(){return t(e.apply(this,arguments))}}function tt(e,t){if("function"==typeof e)return et(e,t);if("object"!=typeof e||null===e)throw new Error(qe(16));var n={};for(var i in e){var r=e[i];"function"==typeof r&&(n[i]=et(r,t))}return n}function nt(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return 0===t.length?function(e){return e}:1===t.length?t[0]:t.reduce((function(e,t){return function(){return e(t.apply(void 0,arguments))}}))}var it=s.createContext(null);var rt=function(e){e()},st=function(){return rt};var ot={notify:function(){},get:function(){return[]}};function at(e,t){var n,i=ot;function r(){o.onStateChange&&o.onStateChange()}function s(){n||(n=t?t.addNestedSub(r):e.subscribe(r),i=function(){var e=st(),t=null,n=null;return{clear:function(){t=null,n=null},notify:function(){e((function(){for(var e=t;e;)e.callback(),e=e.next}))},get:function(){for(var e=[],n=t;n;)e.push(n),n=n.next;return e},subscribe:function(e){var i=!0,r=n={callback:e,next:null,prev:n};return r.prev?r.prev.next=r:t=r,function(){i&&null!==t&&(i=!1,r.next?r.next.prev=r.prev:n=r.prev,r.prev?r.prev.next=r.next:t=r.next)}}}}())}var o={addNestedSub:function(e){return s(),i.subscribe(e)},notifyNestedSubs:function(){i.notify()},handleChangeWrapper:r,isSubscribed:function(){return Boolean(n)},trySubscribe:s,tryUnsubscribe:function(){n&&(n(),n=void 0,i.clear(),i=ot)},getListeners:function(){return i}};return o}var lt="undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement?s.useLayoutEffect:s.useEffect;const ct=function(e){var t=e.store,n=e.context,i=e.children,r=(0,s.useMemo)((function(){var e=at(t);return{store:t,subscription:e}}),[t]),o=(0,s.useMemo)((function(){return t.getState()}),[t]);lt((function(){var e=r.subscription;return e.onStateChange=e.notifyNestedSubs,e.trySubscribe(),o!==t.getState()&&e.notifyNestedSubs(),function(){e.tryUnsubscribe(),e.onStateChange=null}}),[r,o]);var a=n||it;return s.createElement(a.Provider,{value:r},i)};var dt=n("./node_modules/@babel/runtime/helpers/esm/objectWithoutPropertiesLoose.js"),ut=n("./node_modules/hoist-non-react-statics/dist/hoist-non-react-statics.cjs.js"),mt=n.n(ut),pt=n("./node_modules/react-redux/node_modules/react-is/index.js"),ht=["getDisplayName","methodName","renderCountProp","shouldHandleStateChanges","storeKey","withRef","forwardRef","context"],gt=["reactReduxForwardedRef"],vt=[],ft=[null,null];function _t(e,t){var n=e[1];return[t.payload,n+1]}function yt(e,t,n){lt((function(){return e.apply(void 0,t)}),n)}function bt(e,t,n,i,r,s,o){e.current=i,t.current=r,n.current=!1,s.current&&(s.current=null,o())}function Et(e,t,n,i,r,s,o,a,l,c){if(e){var d=!1,u=null,m=function(){if(!d){var e,n,m=t.getState();try{e=i(m,r.current)}catch(e){n=e,u=e}n||(u=null),e===s.current?o.current||l():(s.current=e,a.current=e,o.current=!0,c({type:"STORE_UPDATED",payload:{error:n}}))}};n.onStateChange=m,n.trySubscribe(),m();return function(){if(d=!0,n.tryUnsubscribe(),n.onStateChange=null,u)throw u}}}var wt=function(){return[null,0]};function St(e,t){void 0===t&&(t={});var n=t,i=n.getDisplayName,r=void 0===i?function(e){return"ConnectAdvanced("+e+")"}:i,o=n.methodName,a=void 0===o?"connectAdvanced":o,l=n.renderCountProp,c=void 0===l?void 0:l,d=n.shouldHandleStateChanges,u=void 0===d||d,m=n.storeKey,h=void 0===m?"store":m,g=(n.withRef,n.forwardRef),v=void 0!==g&&g,f=n.context,_=void 0===f?it:f,y=(0,dt.A)(n,ht),b=_;return function(t){var n=t.displayName||t.name||"Component",i=r(n),o=(0,p.A)({},y,{getDisplayName:r,methodName:a,renderCountProp:c,shouldHandleStateChanges:u,storeKey:h,displayName:i,wrappedComponentName:n,WrappedComponent:t}),l=y.pure;var d=l?s.useMemo:function(e){return e()};function m(n){var i=(0,s.useMemo)((function(){var e=n.reactReduxForwardedRef,t=(0,dt.A)(n,gt);return[n.context,e,t]}),[n]),r=i[0],a=i[1],l=i[2],c=(0,s.useMemo)((function(){return r&&r.Consumer&&(0,pt.isContextConsumer)(s.createElement(r.Consumer,null))?r:b}),[r,b]),m=(0,s.useContext)(c),h=Boolean(n.store)&&Boolean(n.store.getState)&&Boolean(n.store.dispatch);Boolean(m)&&Boolean(m.store);var g=h?n.store:m.store,v=(0,s.useMemo)((function(){return function(t){return e(t.dispatch,o)}(g)}),[g]),f=(0,s.useMemo)((function(){if(!u)return ft;var e=at(g,h?null:m.subscription),t=e.notifyNestedSubs.bind(e);return[e,t]}),[g,h,m]),_=f[0],y=f[1],E=(0,s.useMemo)((function(){return h?m:(0,p.A)({},m,{subscription:_})}),[h,m,_]),w=(0,s.useReducer)(_t,vt,wt),S=w[0][0],A=w[1];if(S&&S.error)throw S.error;var C=(0,s.useRef)(),x=(0,s.useRef)(l),k=(0,s.useRef)(),R=(0,s.useRef)(!1),I=d((function(){return k.current&&l===x.current?k.current:v(g.getState(),l)}),[g,S,l]);yt(bt,[x,C,R,l,I,k,y]),yt(Et,[u,g,_,v,x,C,R,k,y,A],[g,_,v]);var T=(0,s.useMemo)((function(){return s.createElement(t,(0,p.A)({},I,{ref:a}))}),[a,t,I]);return(0,s.useMemo)((function(){return u?s.createElement(c.Provider,{value:E},T):T}),[c,T,E])}var g=l?s.memo(m):m;if(g.WrappedComponent=t,g.displayName=m.displayName=i,v){var f=s.forwardRef((function(e,t){return s.createElement(g,(0,p.A)({},e,{reactReduxForwardedRef:t}))}));return f.displayName=i,f.WrappedComponent=t,mt()(f,t)}return mt()(g,t)}}function At(e,t){return e===t?0!==e||0!==t||1/e==1/t:e!=e&&t!=t}function Ct(e,t){if(At(e,t))return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;var n=Object.keys(e),i=Object.keys(t);if(n.length!==i.length)return!1;for(var r=0;r<n.length;r++)if(!Object.prototype.hasOwnProperty.call(t,n[r])||!At(e[n[r]],t[n[r]]))return!1;return!0}function xt(e){return function(t,n){var i=e(t,n);function r(){return i}return r.dependsOnOwnProps=!1,r}}function kt(e){return null!==e.dependsOnOwnProps&&void 0!==e.dependsOnOwnProps?Boolean(e.dependsOnOwnProps):1!==e.length}function Rt(e,t){return function(t,n){n.displayName;var i=function(e,t){return i.dependsOnOwnProps?i.mapToProps(e,t):i.mapToProps(e)};return i.dependsOnOwnProps=!0,i.mapToProps=function(t,n){i.mapToProps=e,i.dependsOnOwnProps=kt(e);var r=i(t,n);return"function"==typeof r&&(i.mapToProps=r,i.dependsOnOwnProps=kt(r),r=i(t,n)),r},i}}const It=[function(e){return"function"==typeof e?Rt(e):void 0},function(e){return e?void 0:xt((function(e){return{dispatch:e}}))},function(e){return e&&"object"==typeof e?xt((function(t){return function(e,t){var n={},i=function(i){var r=e[i];"function"==typeof r&&(n[i]=function(){return t(r.apply(void 0,arguments))})};for(var r in e)i(r);return n}(e,t)})):void 0}];const Tt=[function(e){return"function"==typeof e?Rt(e):void 0},function(e){return e?void 0:xt((function(){return{}}))}];function Pt(e,t,n){return(0,p.A)({},n,e,t)}const Nt=[function(e){return"function"==typeof e?function(e){return function(t,n){n.displayName;var i,r=n.pure,s=n.areMergedPropsEqual,o=!1;return function(t,n,a){var l=e(t,n,a);return o?r&&s(l,i)||(i=l):(o=!0,i=l),i}}}(e):void 0},function(e){return e?void 0:function(){return Pt}}];var Dt=["initMapStateToProps","initMapDispatchToProps","initMergeProps"];function Mt(e,t,n,i){return function(r,s){return n(e(r,s),t(i,s),s)}}function Ot(e,t,n,i,r){var s,o,a,l,c,d=r.areStatesEqual,u=r.areOwnPropsEqual,m=r.areStatePropsEqual,p=!1;function h(r,p){var h,g,v=!u(p,o),f=!d(r,s,p,o);return s=r,o=p,v&&f?(a=e(s,o),t.dependsOnOwnProps&&(l=t(i,o)),c=n(a,l,o)):v?(e.dependsOnOwnProps&&(a=e(s,o)),t.dependsOnOwnProps&&(l=t(i,o)),c=n(a,l,o)):f?(h=e(s,o),g=!m(h,a),a=h,g&&(c=n(a,l,o)),c):c}return function(r,d){return p?h(r,d):(a=e(s=r,o=d),l=t(i,o),c=n(a,l,o),p=!0,c)}}function Lt(e,t){var n=t.initMapStateToProps,i=t.initMapDispatchToProps,r=t.initMergeProps,s=(0,dt.A)(t,Dt),o=n(e,s),a=i(e,s),l=r(e,s);return(s.pure?Ot:Mt)(o,a,l,e,s)}var Ft=["pure","areStatesEqual","areOwnPropsEqual","areStatePropsEqual","areMergedPropsEqual"];function Ut(e,t,n){for(var i=t.length-1;i>=0;i--){var r=t[i](e);if(r)return r}return function(t,i){throw new Error("Invalid value of type "+typeof e+" for "+n+" argument when connecting component "+i.wrappedComponentName+".")}}function Bt(e,t){return e===t}function Vt(e){var t=void 0===e?{}:e,n=t.connectHOC,i=void 0===n?St:n,r=t.mapStateToPropsFactories,s=void 0===r?Tt:r,o=t.mapDispatchToPropsFactories,a=void 0===o?It:o,l=t.mergePropsFactories,c=void 0===l?Nt:l,d=t.selectorFactory,u=void 0===d?Lt:d;return function(e,t,n,r){void 0===r&&(r={});var o=r,l=o.pure,d=void 0===l||l,m=o.areStatesEqual,h=void 0===m?Bt:m,g=o.areOwnPropsEqual,v=void 0===g?Ct:g,f=o.areStatePropsEqual,_=void 0===f?Ct:f,y=o.areMergedPropsEqual,b=void 0===y?Ct:y,E=(0,dt.A)(o,Ft),w=Ut(e,s,"mapStateToProps"),S=Ut(t,a,"mapDispatchToProps"),A=Ut(n,c,"mergeProps");return i(u,(0,p.A)({methodName:"connect",getDisplayName:function(e){return"Connect("+e+")"},shouldHandleStateChanges:Boolean(e),initMapStateToProps:w,initMapDispatchToProps:S,initMergeProps:A,pure:d,areStatesEqual:h,areOwnPropsEqual:v,areStatePropsEqual:_,areMergedPropsEqual:b},E))}}const jt=Vt();var zt,Wt=n("./node_modules/react-dom/index.js");function Ht(e,t){var n=(0,s.useState)((function(){return{inputs:t,result:e()}}))[0],i=(0,s.useRef)(!0),r=(0,s.useRef)(n),o=i.current||Boolean(t&&r.current.inputs&&function(e,t){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}(t,r.current.inputs))?r.current:{inputs:t,result:e()};return(0,s.useEffect)((function(){i.current=!1,r.current=o}),[o]),o.result}zt=Wt.unstable_batchedUpdates,rt=zt;var Gt=Ht,Kt=function(e,t){return Ht((function(){return e}),t)},Jt="Invariant failed";var qt=function(e){var t=e.top,n=e.right,i=e.bottom,r=e.left;return{top:t,right:n,bottom:i,left:r,width:n-r,height:i-t,x:r,y:t,center:{x:(n+r)/2,y:(i+t)/2}}},$t=function(e,t){return{top:e.top-t.top,left:e.left-t.left,bottom:e.bottom+t.bottom,right:e.right+t.right}},Yt=function(e,t){return{top:e.top+t.top,left:e.left+t.left,bottom:e.bottom-t.bottom,right:e.right-t.right}},Zt={top:0,right:0,bottom:0,left:0},Xt=function(e){var t=e.borderBox,n=e.margin,i=void 0===n?Zt:n,r=e.border,s=void 0===r?Zt:r,o=e.padding,a=void 0===o?Zt:o,l=qt($t(t,i)),c=qt(Yt(t,s)),d=qt(Yt(c,a));return{marginBox:l,borderBox:qt(t),paddingBox:c,contentBox:d,margin:i,border:s,padding:a}},Qt=function(e){var t=e.slice(0,-2);if("px"!==e.slice(-2))return 0;var n=Number(t);return isNaN(n)&&function(e){if(!e)throw new Error(Jt)}(!1),n},en=function(e,t){var n,i,r=e.borderBox,s=e.border,o=e.margin,a=e.padding,l=(i=t,{top:(n=r).top+i.y,left:n.left+i.x,bottom:n.bottom+i.y,right:n.right+i.x});return Xt({borderBox:l,border:s,margin:o,padding:a})},tn=function(e,t){return void 0===t&&(t={x:window.pageXOffset,y:window.pageYOffset}),en(e,t)},nn=function(e,t){var n={top:Qt(t.marginTop),right:Qt(t.marginRight),bottom:Qt(t.marginBottom),left:Qt(t.marginLeft)},i={top:Qt(t.paddingTop),right:Qt(t.paddingRight),bottom:Qt(t.paddingBottom),left:Qt(t.paddingLeft)},r={top:Qt(t.borderTopWidth),right:Qt(t.borderRightWidth),bottom:Qt(t.borderBottomWidth),left:Qt(t.borderLeftWidth)};return Xt({borderBox:e,margin:n,padding:i,border:r})},rn=function(e){var t=e.getBoundingClientRect(),n=window.getComputedStyle(e);return nn(t,n)},sn=Number.isNaN||function(e){return"number"==typeof e&&e!=e};function on(e,t){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(i=e[n],r=t[n],!(i===r||sn(i)&&sn(r)))return!1;var i,r;return!0}const an=function(e,t){var n;void 0===t&&(t=on);var i,r=[],s=!1;return function(){for(var o=[],a=0;a<arguments.length;a++)o[a]=arguments[a];return s&&n===this&&t(o,r)||(i=e.apply(this,o),s=!0,n=this,r=o),i}};const ln=function(e){var t=[],n=null,i=function(){for(var i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];t=r,n||(n=requestAnimationFrame((function(){n=null,e.apply(void 0,t)})))};return i.cancel=function(){n&&(cancelAnimationFrame(n),n=null)},i};function cn(e,t){}cn.bind(null,"warn"),cn.bind(null,"error");function dn(){}function un(e,t,n){var i=t.map((function(t){var i=function(e,t){return(0,p.A)({},e,{},t)}(n,t.options);return e.addEventListener(t.eventName,t.fn,i),function(){e.removeEventListener(t.eventName,t.fn,i)}}));return function(){i.forEach((function(e){e()}))}}var mn="Invariant failed";function pn(e){this.message=e}function hn(e,t){if(!e)throw new pn(mn)}pn.prototype.toString=function(){return this.message};var gn=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).callbacks=null,t.unbind=dn,t.onWindowError=function(e){var n=t.getCallbacks();n.isDragging()&&n.tryAbort(),e.error instanceof pn&&e.preventDefault()},t.getCallbacks=function(){if(!t.callbacks)throw new Error("Unable to find AppCallbacks in <ErrorBoundary/>");return t.callbacks},t.setCallbacks=function(e){t.callbacks=e},t}(0,Ge.A)(t,e);var n=t.prototype;return n.componentDidMount=function(){this.unbind=un(window,[{eventName:"error",fn:this.onWindowError}])},n.componentDidCatch=function(e){if(!(e instanceof pn))throw e;this.setState({})},n.componentWillUnmount=function(){this.unbind()},n.render=function(){return this.props.children(this.setCallbacks)},t}(s.Component),vn=function(e){return e+1},fn=function(e,t){var n=e.droppableId===t.droppableId,i=vn(e.index),r=vn(t.index);return n?"\n      You have moved the item from position "+i+"\n      to position "+r+"\n    ":"\n    You have moved the item from position "+i+"\n    in list "+e.droppableId+"\n    to list "+t.droppableId+"\n    in position "+r+"\n  "},_n=function(e,t,n){return t.droppableId===n.droppableId?"\n      The item "+e+"\n      has been combined with "+n.draggableId:"\n      The item "+e+"\n      in list "+t.droppableId+"\n      has been combined with "+n.draggableId+"\n      in list "+n.droppableId+"\n    "},yn=function(e){return"\n  The item has returned to its starting position\n  of "+vn(e.index)+"\n"},bn="\n  Press space bar to start a drag.\n  When dragging you can use the arrow keys to move the item around and escape to cancel.\n  Some screen readers may require you to be in focus mode or to use your pass through key\n",En=function(e){return"\n  You have lifted an item in position "+vn(e.source.index)+"\n"},wn=function(e){var t=e.destination;if(t)return fn(e.source,t);var n=e.combine;return n?_n(e.draggableId,e.source,n):"You are over an area that cannot be dropped on"},Sn=function(e){if("CANCEL"===e.reason)return"\n      Movement cancelled.\n      "+yn(e.source)+"\n    ";var t=e.destination,n=e.combine;return t?"\n      You have dropped the item.\n      "+fn(e.source,t)+"\n    ":n?"\n      You have dropped the item.\n      "+_n(e.draggableId,e.source,n)+"\n    ":"\n    The item has been dropped while not over a drop area.\n    "+yn(e.source)+"\n  "},An={x:0,y:0},Cn=function(e,t){return{x:e.x+t.x,y:e.y+t.y}},xn=function(e,t){return{x:e.x-t.x,y:e.y-t.y}},kn=function(e,t){return e.x===t.x&&e.y===t.y},Rn=function(e){return{x:0!==e.x?-e.x:0,y:0!==e.y?-e.y:0}},In=function(e,t,n){var i;return void 0===n&&(n=0),(i={})[e]=t,i["x"===e?"y":"x"]=n,i},Tn=function(e,t){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))},Pn=function(e,t){return Math.min.apply(Math,t.map((function(t){return Tn(e,t)})))},Nn=function(e){return function(t){return{x:e(t.x),y:e(t.y)}}},Dn=function(e,t){return{top:e.top+t.y,left:e.left+t.x,bottom:e.bottom+t.y,right:e.right+t.x}},Mn=function(e){return[{x:e.left,y:e.top},{x:e.right,y:e.top},{x:e.left,y:e.bottom},{x:e.right,y:e.bottom}]},On=function(e,t){return t&&t.shouldClipSubject?function(e,t){var n=qt({top:Math.max(t.top,e.top),right:Math.min(t.right,e.right),bottom:Math.min(t.bottom,e.bottom),left:Math.max(t.left,e.left)});return n.width<=0||n.height<=0?null:n}(t.pageMarginBox,e):qt(e)},Ln=function(e){var t=e.page,n=e.withPlaceholder,i=e.axis,r=e.frame,s=function(e,t){return t?Dn(e,t.scroll.diff.displacement):e}(t.marginBox,r),o=function(e,t,n){var i;return n&&n.increasedBy?(0,p.A)({},e,((i={})[t.end]=e[t.end]+n.increasedBy[t.line],i)):e}(s,i,n);return{page:t,withPlaceholder:n,active:On(o,r)}},Fn=function(e,t){e.frame||hn(!1);var n=e.frame,i=xn(t,n.scroll.initial),r=Rn(i),s=(0,p.A)({},n,{scroll:{initial:n.scroll.initial,current:t,diff:{value:i,displacement:r},max:n.scroll.max}}),o=Ln({page:e.subject.page,withPlaceholder:e.subject.withPlaceholder,axis:e.axis,frame:s});return(0,p.A)({},e,{frame:s,subject:o})};function Un(e){return Object.values?Object.values(e):Object.keys(e).map((function(t){return e[t]}))}function Bn(e,t){if(e.findIndex)return e.findIndex(t);for(var n=0;n<e.length;n++)if(t(e[n]))return n;return-1}function Vn(e,t){if(e.find)return e.find(t);var n=Bn(e,t);return-1!==n?e[n]:void 0}function jn(e){return Array.prototype.slice.call(e)}var zn=an((function(e){return e.reduce((function(e,t){return e[t.descriptor.id]=t,e}),{})})),Wn=an((function(e){return e.reduce((function(e,t){return e[t.descriptor.id]=t,e}),{})})),Hn=an((function(e){return Un(e)})),Gn=an((function(e){return Un(e)})),Kn=an((function(e,t){var n=Gn(t).filter((function(t){return e===t.descriptor.droppableId})).sort((function(e,t){return e.descriptor.index-t.descriptor.index}));return n}));function Jn(e){return e.at&&"REORDER"===e.at.type?e.at.destination:null}function qn(e){return e.at&&"COMBINE"===e.at.type?e.at.combine:null}var $n=an((function(e,t){return t.filter((function(t){return t.descriptor.id!==e.descriptor.id}))})),Yn=function(e,t){return e.descriptor.droppableId===t.descriptor.id},Zn={point:An,value:0},Xn={invisible:{},visible:{},all:[]},Qn={displaced:Xn,displacedBy:Zn,at:null},ei=function(e,t){return function(n){return e<=n&&n<=t}},ti=function(e){var t=ei(e.top,e.bottom),n=ei(e.left,e.right);return function(i){if(t(i.top)&&t(i.bottom)&&n(i.left)&&n(i.right))return!0;var r=t(i.top)||t(i.bottom),s=n(i.left)||n(i.right);if(r&&s)return!0;var o=i.top<e.top&&i.bottom>e.bottom,a=i.left<e.left&&i.right>e.right;return!(!o||!a)||(o&&s||a&&r)}},ni=function(e){var t=ei(e.top,e.bottom),n=ei(e.left,e.right);return function(e){return t(e.top)&&t(e.bottom)&&n(e.left)&&n(e.right)}},ii={direction:"vertical",line:"y",crossAxisLine:"x",start:"top",end:"bottom",size:"height",crossAxisStart:"left",crossAxisEnd:"right",crossAxisSize:"width"},ri={direction:"horizontal",line:"x",crossAxisLine:"y",start:"left",end:"right",size:"width",crossAxisStart:"top",crossAxisEnd:"bottom",crossAxisSize:"height"},si=function(e){var t=e.target,n=e.destination,i=e.viewport,r=e.withDroppableDisplacement,s=e.isVisibleThroughFrameFn,o=r?function(e,t){var n=t.frame?t.frame.scroll.diff.displacement:An;return Dn(e,n)}(t,n):t;return function(e,t,n){return!!t.subject.active&&n(t.subject.active)(e)}(o,n,s)&&function(e,t,n){return n(t)(e)}(o,i,s)},oi=function(e){return si((0,p.A)({},e,{isVisibleThroughFrameFn:ti}))},ai=function(e){return si((0,p.A)({},e,{isVisibleThroughFrameFn:ni}))};function li(e){var t=e.afterDragging,n=e.destination,i=e.displacedBy,r=e.viewport,s=e.forceShouldAnimate,o=e.last;return t.reduce((function(e,t){var a=function(e,t){var n=e.page.marginBox,i={top:t.point.y,right:0,bottom:0,left:t.point.x};return qt($t(n,i))}(t,i),l=t.descriptor.id;if(e.all.push(l),!oi({target:a,destination:n,viewport:r,withDroppableDisplacement:!0}))return e.invisible[t.descriptor.id]=!0,e;var c=function(e,t,n){if("boolean"==typeof n)return n;if(!t)return!0;var i=t.invisible,r=t.visible;if(i[e])return!1;var s=r[e];return!s||s.shouldAnimate}(l,o,s),d={draggableId:l,shouldAnimate:c};return e.visible[l]=d,e}),{all:[],visible:{},invisible:{}})}function ci(e){var t=e.insideDestination,n=e.inHomeList,i=e.displacedBy,r=e.destination,s=function(e,t){if(!e.length)return 0;var n=e[e.length-1].descriptor.index;return t.inHomeList?n:n+1}(t,{inHomeList:n});return{displaced:Xn,displacedBy:i,at:{type:"REORDER",destination:{droppableId:r.descriptor.id,index:s}}}}function di(e){var t=e.draggable,n=e.insideDestination,i=e.destination,r=e.viewport,s=e.displacedBy,o=e.last,a=e.index,l=e.forceShouldAnimate,c=Yn(t,i);if(null==a)return ci({insideDestination:n,inHomeList:c,displacedBy:s,destination:i});var d=Vn(n,(function(e){return e.descriptor.index===a}));if(!d)return ci({insideDestination:n,inHomeList:c,displacedBy:s,destination:i});var u=$n(t,n),m=n.indexOf(d);return{displaced:li({afterDragging:u.slice(m),destination:i,displacedBy:s,last:o,viewport:r.frame,forceShouldAnimate:l}),displacedBy:s,at:{type:"REORDER",destination:{droppableId:i.descriptor.id,index:a}}}}function ui(e,t){return Boolean(t.effected[e])}var mi=function(e){var t=e.isMovingForward,n=e.isInHomeList,i=e.draggable,r=e.draggables,s=e.destination,o=e.insideDestination,a=e.previousImpact,l=e.viewport,c=e.afterCritical,d=a.at;if(d||hn(!1),"REORDER"===d.type){var u=function(e){var t=e.isMovingForward,n=e.isInHomeList,i=e.insideDestination,r=e.location;if(!i.length)return null;var s=r.index,o=t?s+1:s-1,a=i[0].descriptor.index,l=i[i.length-1].descriptor.index;return o<a||o>(n?l:l+1)?null:o}({isMovingForward:t,isInHomeList:n,location:d.destination,insideDestination:o});return null==u?null:di({draggable:i,insideDestination:o,destination:s,viewport:l,last:a.displaced,displacedBy:a.displacedBy,index:u})}var m=function(e){var t=e.isMovingForward,n=e.destination,i=e.draggables,r=e.combine,s=e.afterCritical;if(!n.isCombineEnabled)return null;var o=r.draggableId,a=i[o].descriptor.index;return ui(o,s)?t?a:a-1:t?a+1:a}({isMovingForward:t,destination:s,displaced:a.displaced,draggables:r,combine:d.combine,afterCritical:c});return null==m?null:di({draggable:i,insideDestination:o,destination:s,viewport:l,last:a.displaced,displacedBy:a.displacedBy,index:m})},pi=function(e){var t=e.afterCritical,n=e.impact,i=e.draggables,r=qn(n);r||hn(!1);var s=r.draggableId,o=i[s].page.borderBox.center,a=function(e){var t=e.displaced,n=e.afterCritical,i=e.combineWith,r=e.displacedBy,s=Boolean(t.visible[i]||t.invisible[i]);return ui(i,n)?s?An:Rn(r.point):s?r.point:An}({displaced:n.displaced,afterCritical:t,combineWith:s,displacedBy:n.displacedBy});return Cn(o,a)},hi=function(e,t){return t.margin[e.start]+t.borderBox[e.size]/2},gi=function(e,t,n){return t[e.crossAxisStart]+n.margin[e.crossAxisStart]+n.borderBox[e.crossAxisSize]/2},vi=function(e){var t=e.axis,n=e.moveRelativeTo,i=e.isMoving;return In(t.line,n.marginBox[t.end]+hi(t,i),gi(t,n.marginBox,i))},fi=function(e){var t=e.axis,n=e.moveRelativeTo,i=e.isMoving;return In(t.line,n.marginBox[t.start]-function(e,t){return t.margin[e.end]+t.borderBox[e.size]/2}(t,i),gi(t,n.marginBox,i))},_i=function(e){var t=e.impact,n=e.draggable,i=e.draggables,r=e.droppable,s=e.afterCritical,o=Kn(r.descriptor.id,i),a=n.page,l=r.axis;if(!o.length)return function(e){var t=e.axis,n=e.moveInto,i=e.isMoving;return In(t.line,n.contentBox[t.start]+hi(t,i),gi(t,n.contentBox,i))}({axis:l,moveInto:r.page,isMoving:a});var c=t.displaced,d=t.displacedBy,u=c.all[0];if(u){var m=i[u];if(ui(u,s))return fi({axis:l,moveRelativeTo:m.page,isMoving:a});var p=en(m.page,d.point);return fi({axis:l,moveRelativeTo:p,isMoving:a})}var h=o[o.length-1];if(h.descriptor.id===n.descriptor.id)return a.borderBox.center;if(ui(h.descriptor.id,s)){var g=en(h.page,Rn(s.displacedBy.point));return vi({axis:l,moveRelativeTo:g,isMoving:a})}return vi({axis:l,moveRelativeTo:h.page,isMoving:a})},yi=function(e,t){var n=e.frame;return n?Cn(t,n.scroll.diff.displacement):t},bi=function(e){var t=function(e){var t=e.impact,n=e.draggable,i=e.droppable,r=e.draggables,s=e.afterCritical,o=n.page.borderBox.center,a=t.at;return i&&a?"REORDER"===a.type?_i({impact:t,draggable:n,draggables:r,droppable:i,afterCritical:s}):pi({impact:t,draggables:r,afterCritical:s}):o}(e),n=e.droppable;return n?yi(n,t):t},Ei=function(e,t){var n=xn(t,e.scroll.initial),i=Rn(n);return{frame:qt({top:t.y,bottom:t.y+e.frame.height,left:t.x,right:t.x+e.frame.width}),scroll:{initial:e.scroll.initial,max:e.scroll.max,current:t,diff:{value:n,displacement:i}}}};function wi(e,t){return e.map((function(e){return t[e]}))}var Si=function(e){var t=e.pageBorderBoxCenter,n=e.draggable,i=function(e,t){return Cn(e.scroll.diff.displacement,t)}(e.viewport,t),r=xn(i,n.page.borderBox.center);return Cn(n.client.borderBox.center,r)},Ai=function(e){var t=e.draggable,n=e.destination,i=e.newPageBorderBoxCenter,r=e.viewport,s=e.withDroppableDisplacement,o=e.onlyOnMainAxis,a=void 0!==o&&o,l=xn(i,t.page.borderBox.center),c={target:Dn(t.page.borderBox,l),destination:n,withDroppableDisplacement:s,viewport:r};return a?function(e){return si((0,p.A)({},e,{isVisibleThroughFrameFn:(t=e.destination.axis,function(e){var n=ei(e.top,e.bottom),i=ei(e.left,e.right);return function(e){return t===ii?n(e.top)&&n(e.bottom):i(e.left)&&i(e.right)}})}));var t}(c):ai(c)},Ci=function(e){var t=e.isMovingForward,n=e.draggable,i=e.destination,r=e.draggables,s=e.previousImpact,o=e.viewport,a=e.previousPageBorderBoxCenter,l=e.previousClientSelection,c=e.afterCritical;if(!i.isEnabled)return null;var d=Kn(i.descriptor.id,r),u=Yn(n,i),m=function(e){var t=e.isMovingForward,n=e.draggable,i=e.destination,r=e.insideDestination,s=e.previousImpact;if(!i.isCombineEnabled)return null;if(!Jn(s))return null;function o(e){var t={type:"COMBINE",combine:{draggableId:e,droppableId:i.descriptor.id}};return(0,p.A)({},s,{at:t})}var a=s.displaced.all,l=a.length?a[0]:null;if(t)return l?o(l):null;var c=$n(n,r);if(!l)return c.length?o(c[c.length-1].descriptor.id):null;var d=Bn(c,(function(e){return e.descriptor.id===l}));-1===d&&hn(!1);var u=d-1;return u<0?null:o(c[u].descriptor.id)}({isMovingForward:t,draggable:n,destination:i,insideDestination:d,previousImpact:s})||mi({isMovingForward:t,isInHomeList:u,draggable:n,draggables:r,destination:i,insideDestination:d,previousImpact:s,viewport:o,afterCritical:c});if(!m)return null;var h=bi({impact:m,draggable:n,droppable:i,draggables:r,afterCritical:c});if(Ai({draggable:n,destination:i,newPageBorderBoxCenter:h,viewport:o.frame,withDroppableDisplacement:!1,onlyOnMainAxis:!0}))return{clientSelection:Si({pageBorderBoxCenter:h,draggable:n,viewport:o}),impact:m,scrollJumpRequest:null};var g=xn(h,a),v=function(e){var t=e.impact,n=e.viewport,i=e.destination,r=e.draggables,s=e.maxScrollChange,o=Ei(n,Cn(n.scroll.current,s)),a=i.frame?Fn(i,Cn(i.frame.scroll.current,s)):i,l=t.displaced,c=li({afterDragging:wi(l.all,r),destination:i,displacedBy:t.displacedBy,viewport:o.frame,last:l,forceShouldAnimate:!1}),d=li({afterDragging:wi(l.all,r),destination:a,displacedBy:t.displacedBy,viewport:n.frame,last:l,forceShouldAnimate:!1}),u={},m={},h=[l,c,d];return l.all.forEach((function(e){var t=function(e,t){for(var n=0;n<t.length;n++){var i=t[n].visible[e];if(i)return i}return null}(e,h);t?m[e]=t:u[e]=!0})),(0,p.A)({},t,{displaced:{all:l.all,invisible:u,visible:m}})}({impact:m,viewport:o,destination:i,draggables:r,maxScrollChange:g});return{clientSelection:l,impact:v,scrollJumpRequest:g}},xi=function(e){var t=e.subject.active;return t||hn(!1),t},ki=function(e,t){var n=e.page.borderBox.center;return ui(e.descriptor.id,t)?xn(n,t.displacedBy.point):n},Ri=function(e,t){var n=e.page.borderBox;return ui(e.descriptor.id,t)?Dn(n,Rn(t.displacedBy.point)):n},Ii=an((function(e,t){var n=t[e.line];return{value:n,point:In(e.line,n)}})),Ti=function(e,t){return(0,p.A)({},e,{scroll:(0,p.A)({},e.scroll,{max:t})})},Pi=function(e,t,n){var i=e.frame;Yn(t,e)&&hn(!1),e.subject.withPlaceholder&&hn(!1);var r=Ii(e.axis,t.displaceBy).point,s=function(e,t,n){var i=e.axis;if("virtual"===e.descriptor.mode)return In(i.line,t[i.line]);var r=e.subject.page.contentBox[i.size],s=Kn(e.descriptor.id,n).reduce((function(e,t){return e+t.client.marginBox[i.size]}),0)+t[i.line]-r;return s<=0?null:In(i.line,s)}(e,r,n),o={placeholderSize:r,increasedBy:s,oldFrameMaxScroll:e.frame?e.frame.scroll.max:null};if(!i){var a=Ln({page:e.subject.page,withPlaceholder:o,axis:e.axis,frame:e.frame});return(0,p.A)({},e,{subject:a})}var l=s?Cn(i.scroll.max,s):i.scroll.max,c=Ti(i,l),d=Ln({page:e.subject.page,withPlaceholder:o,axis:e.axis,frame:c});return(0,p.A)({},e,{subject:d,frame:c})},Ni=function(e){var t=e.isMovingForward,n=e.previousPageBorderBoxCenter,i=e.draggable,r=e.isOver,s=e.draggables,o=e.droppables,a=e.viewport,l=e.afterCritical,c=function(e){var t=e.isMovingForward,n=e.pageBorderBoxCenter,i=e.source,r=e.droppables,s=e.viewport,o=i.subject.active;if(!o)return null;var a=i.axis,l=ei(o[a.start],o[a.end]),c=Hn(r).filter((function(e){return e!==i})).filter((function(e){return e.isEnabled})).filter((function(e){return Boolean(e.subject.active)})).filter((function(e){return ti(s.frame)(xi(e))})).filter((function(e){var n=xi(e);return t?o[a.crossAxisEnd]<n[a.crossAxisEnd]:n[a.crossAxisStart]<o[a.crossAxisStart]})).filter((function(e){var t=xi(e),n=ei(t[a.start],t[a.end]);return l(t[a.start])||l(t[a.end])||n(o[a.start])||n(o[a.end])})).sort((function(e,n){var i=xi(e)[a.crossAxisStart],r=xi(n)[a.crossAxisStart];return t?i-r:r-i})).filter((function(e,t,n){return xi(e)[a.crossAxisStart]===xi(n[0])[a.crossAxisStart]}));if(!c.length)return null;if(1===c.length)return c[0];var d=c.filter((function(e){return ei(xi(e)[a.start],xi(e)[a.end])(n[a.line])}));return 1===d.length?d[0]:d.length>1?d.sort((function(e,t){return xi(e)[a.start]-xi(t)[a.start]}))[0]:c.sort((function(e,t){var i=Pn(n,Mn(xi(e))),r=Pn(n,Mn(xi(t)));return i!==r?i-r:xi(e)[a.start]-xi(t)[a.start]}))[0]}({isMovingForward:t,pageBorderBoxCenter:n,source:r,droppables:o,viewport:a});if(!c)return null;var d=Kn(c.descriptor.id,s),u=function(e){var t=e.pageBorderBoxCenter,n=e.viewport,i=e.destination,r=e.insideDestination,s=e.afterCritical,o=r.filter((function(e){return ai({target:Ri(e,s),destination:i,viewport:n.frame,withDroppableDisplacement:!0})})).sort((function(e,n){var r=Tn(t,yi(i,ki(e,s))),o=Tn(t,yi(i,ki(n,s)));return r<o?-1:o<r?1:e.descriptor.index-n.descriptor.index}));return o[0]||null}({pageBorderBoxCenter:n,viewport:a,destination:c,insideDestination:d,afterCritical:l}),m=function(e){var t=e.previousPageBorderBoxCenter,n=e.moveRelativeTo,i=e.insideDestination,r=e.draggable,s=e.draggables,o=e.destination,a=e.viewport,l=e.afterCritical;if(!n){if(i.length)return null;var c={displaced:Xn,displacedBy:Zn,at:{type:"REORDER",destination:{droppableId:o.descriptor.id,index:0}}},d=bi({impact:c,draggable:r,droppable:o,draggables:s,afterCritical:l}),u=Yn(r,o)?o:Pi(o,r,s);return Ai({draggable:r,destination:u,newPageBorderBoxCenter:d,viewport:a.frame,withDroppableDisplacement:!1,onlyOnMainAxis:!0})?c:null}var m,p=Boolean(t[o.axis.line]<=n.page.borderBox.center[o.axis.line]),h=(m=n.descriptor.index,n.descriptor.id===r.descriptor.id||p?m:m+1),g=Ii(o.axis,r.displaceBy);return di({draggable:r,insideDestination:i,destination:o,viewport:a,displacedBy:g,last:Xn,index:h})}({previousPageBorderBoxCenter:n,destination:c,draggable:i,draggables:s,moveRelativeTo:u,insideDestination:d,viewport:a,afterCritical:l});if(!m)return null;var p=bi({impact:m,draggable:i,droppable:c,draggables:s,afterCritical:l});return{clientSelection:Si({pageBorderBoxCenter:p,draggable:i,viewport:a}),impact:m,scrollJumpRequest:null}},Di=function(e){var t=e.at;return t?"REORDER"===t.type?t.destination.droppableId:t.combine.droppableId:null},Mi=function(e){var t=e.state,n=e.type,i=function(e,t){var n=Di(e);return n?t[n]:null}(t.impact,t.dimensions.droppables),r=Boolean(i),s=t.dimensions.droppables[t.critical.droppable.id],o=i||s,a=o.axis.direction,l="vertical"===a&&("MOVE_UP"===n||"MOVE_DOWN"===n)||"horizontal"===a&&("MOVE_LEFT"===n||"MOVE_RIGHT"===n);if(l&&!r)return null;var c="MOVE_DOWN"===n||"MOVE_RIGHT"===n,d=t.dimensions.draggables[t.critical.draggable.id],u=t.current.page.borderBoxCenter,m=t.dimensions,p=m.draggables,h=m.droppables;return l?Ci({isMovingForward:c,previousPageBorderBoxCenter:u,draggable:d,destination:o,draggables:p,viewport:t.viewport,previousClientSelection:t.current.client.selection,previousImpact:t.impact,afterCritical:t.afterCritical}):Ni({isMovingForward:c,previousPageBorderBoxCenter:u,draggable:d,isOver:o,draggables:p,droppables:h,viewport:t.viewport,afterCritical:t.afterCritical})};function Oi(e){return"DRAGGING"===e.phase||"COLLECTING"===e.phase}function Li(e){var t=ei(e.top,e.bottom),n=ei(e.left,e.right);return function(e){return t(e.y)&&n(e.x)}}function Fi(e){var t=e.pageBorderBox,n=e.draggable,i=e.droppables,r=Hn(i).filter((function(e){if(!e.isEnabled)return!1;var n,i,r=e.subject.active;if(!r)return!1;if(i=r,!((n=t).left<i.right&&n.right>i.left&&n.top<i.bottom&&n.bottom>i.top))return!1;if(Li(r)(t.center))return!0;var s=e.axis,o=r.center[s.crossAxisLine],a=t[s.crossAxisStart],l=t[s.crossAxisEnd],c=ei(r[s.crossAxisStart],r[s.crossAxisEnd]),d=c(a),u=c(l);return!d&&!u||(d?a<o:l>o)}));return r.length?1===r.length?r[0].descriptor.id:function(e){var t=e.pageBorderBox,n=e.draggable,i=e.candidates,r=n.page.borderBox.center,s=i.map((function(e){var n=e.axis,i=In(e.axis.line,t.center[n.line],e.page.borderBox.center[n.crossAxisLine]);return{id:e.descriptor.id,distance:Tn(r,i)}})).sort((function(e,t){return t.distance-e.distance}));return s[0]?s[0].id:null}({pageBorderBox:t,draggable:n,candidates:r}):null}var Ui=function(e,t){return qt(Dn(e,t))};function Bi(e){var t=e.displaced,n=e.id;return Boolean(t.visible[n]||t.invisible[n])}var Vi=function(e){var t=e.pageOffset,n=e.draggable,i=e.draggables,r=e.droppables,s=e.previousImpact,o=e.viewport,a=e.afterCritical,l=Ui(n.page.borderBox,t),c=Fi({pageBorderBox:l,draggable:n,droppables:r});if(!c)return Qn;var d=r[c],u=Kn(d.descriptor.id,i),m=function(e,t){var n=e.frame;return n?Ui(t,n.scroll.diff.value):t}(d,l);return function(e){var t=e.draggable,n=e.pageBorderBoxWithDroppableScroll,i=e.previousImpact,r=e.destination,s=e.insideDestination,o=e.afterCritical;if(!r.isCombineEnabled)return null;var a=r.axis,l=Ii(r.axis,t.displaceBy),c=l.value,d=n[a.start],u=n[a.end],m=Vn($n(t,s),(function(e){var t=e.descriptor.id,n=e.page.borderBox,r=n[a.size]/4,s=ui(t,o),l=Bi({displaced:i.displaced,id:t});return s?l?u>n[a.start]+r&&u<n[a.end]-r:d>n[a.start]-c+r&&d<n[a.end]-c-r:l?u>n[a.start]+c+r&&u<n[a.end]+c-r:d>n[a.start]+r&&d<n[a.end]-r}));return m?{displacedBy:l,displaced:i.displaced,at:{type:"COMBINE",combine:{draggableId:m.descriptor.id,droppableId:r.descriptor.id}}}:null}({pageBorderBoxWithDroppableScroll:m,draggable:n,previousImpact:s,destination:d,insideDestination:u,afterCritical:a})||function(e){var t=e.pageBorderBoxWithDroppableScroll,n=e.draggable,i=e.destination,r=e.insideDestination,s=e.last,o=e.viewport,a=e.afterCritical,l=i.axis,c=Ii(i.axis,n.displaceBy),d=c.value,u=t[l.start],m=t[l.end],p=function(e){var t=e.draggable,n=e.closest,i=e.inHomeList;return n?i&&n.descriptor.index>t.descriptor.index?n.descriptor.index-1:n.descriptor.index:null}({draggable:n,closest:Vn($n(n,r),(function(e){var t=e.descriptor.id,n=e.page.borderBox.center[l.line],i=ui(t,a),r=Bi({displaced:s,id:t});return i?r?m<=n:u<n-d:r?m<=n+d:u<n})),inHomeList:Yn(n,i)});return di({draggable:n,insideDestination:r,destination:i,viewport:o,last:s,displacedBy:c,index:p})}({pageBorderBoxWithDroppableScroll:m,draggable:n,destination:d,insideDestination:u,last:s.displaced,viewport:o,afterCritical:a})},ji=function(e,t){var n;return(0,p.A)({},e,((n={})[t.descriptor.id]=t,n))},zi=function(e){var t=e.previousImpact,n=e.impact,i=e.droppables,r=Di(t),s=Di(n);if(!r)return i;if(r===s)return i;var o=i[r];if(!o.subject.withPlaceholder)return i;var a=function(e){var t=e.subject.withPlaceholder;t||hn(!1);var n=e.frame;if(!n){var i=Ln({page:e.subject.page,axis:e.axis,frame:null,withPlaceholder:null});return(0,p.A)({},e,{subject:i})}var r=t.oldFrameMaxScroll;r||hn(!1);var s=Ti(n,r),o=Ln({page:e.subject.page,axis:e.axis,frame:s,withPlaceholder:null});return(0,p.A)({},e,{subject:o,frame:s})}(o);return ji(i,a)},Wi=function(e){var t=e.state,n=e.clientSelection,i=e.dimensions,r=e.viewport,s=e.impact,o=e.scrollJumpRequest,a=r||t.viewport,l=i||t.dimensions,c=n||t.current.client.selection,d=xn(c,t.initial.client.selection),u={offset:d,selection:c,borderBoxCenter:Cn(t.initial.client.borderBoxCenter,d)},m={selection:Cn(u.selection,a.scroll.current),borderBoxCenter:Cn(u.borderBoxCenter,a.scroll.current),offset:Cn(u.offset,a.scroll.diff.value)},h={client:u,page:m};if("COLLECTING"===t.phase)return(0,p.A)({phase:"COLLECTING"},t,{dimensions:l,viewport:a,current:h});var g=l.draggables[t.critical.draggable.id],v=s||Vi({pageOffset:m.offset,draggable:g,draggables:l.draggables,droppables:l.droppables,previousImpact:t.impact,viewport:a,afterCritical:t.afterCritical}),f=function(e){var t=e.draggable,n=e.draggables,i=e.droppables,r=e.previousImpact,s=e.impact,o=zi({previousImpact:r,impact:s,droppables:i}),a=Di(s);if(!a)return o;var l=i[a];if(Yn(t,l))return o;if(l.subject.withPlaceholder)return o;var c=Pi(l,t,n);return ji(o,c)}({draggable:g,impact:v,previousImpact:t.impact,draggables:l.draggables,droppables:l.droppables});return(0,p.A)({},t,{current:h,dimensions:{draggables:l.draggables,droppables:f},impact:v,viewport:a,scrollJumpRequest:o||null,forceShouldAnimate:!o&&null})};var Hi=function(e){var t=e.impact,n=e.viewport,i=e.draggables,r=e.destination,s=e.forceShouldAnimate,o=t.displaced,a=function(e,t){return e.map((function(e){return t[e]}))}(o.all,i),l=li({afterDragging:a,destination:r,displacedBy:t.displacedBy,viewport:n.frame,forceShouldAnimate:s,last:o});return(0,p.A)({},t,{displaced:l})},Gi=function(e){var t=e.impact,n=e.draggable,i=e.droppable,r=e.draggables,s=e.viewport,o=e.afterCritical,a=bi({impact:t,draggable:n,draggables:r,droppable:i,afterCritical:o});return Si({pageBorderBoxCenter:a,draggable:n,viewport:s})},Ki=function(e){var t=e.state,n=e.dimensions,i=e.viewport;"SNAP"!==t.movementMode&&hn(!1);var r=t.impact,s=i||t.viewport,o=n||t.dimensions,a=o.draggables,l=o.droppables,c=a[t.critical.draggable.id],d=Di(r);d||hn(!1);var u=l[d],m=Hi({impact:r,viewport:s,destination:u,draggables:a}),p=Gi({impact:m,draggable:c,droppable:u,draggables:a,viewport:s,afterCritical:t.afterCritical});return Wi({impact:m,clientSelection:p,state:t,dimensions:o,viewport:s})},Ji=function(e){var t=e.draggable,n=e.home,i=e.draggables,r=e.viewport,s=Ii(n.axis,t.displaceBy),o=Kn(n.descriptor.id,i),a=o.indexOf(t);-1===a&&hn(!1);var l,c=o.slice(a+1),d=c.reduce((function(e,t){return e[t.descriptor.id]=!0,e}),{}),u={inVirtualList:"virtual"===n.descriptor.mode,displacedBy:s,effected:d};return{impact:{displaced:li({afterDragging:c,destination:n,displacedBy:s,last:null,viewport:r.frame,forceShouldAnimate:!1}),displacedBy:s,at:{type:"REORDER",destination:(l=t.descriptor,{index:l.index,droppableId:l.droppableId})}},afterCritical:u}},qi=function(e){0},$i=function(e){0},Yi=function(e){var t=e.additions,n=e.updatedDroppables,i=e.viewport,r=i.scroll.diff.value;return t.map((function(e){var t=e.descriptor.droppableId,s=function(e){var t=e.frame;return t||hn(!1),t}(n[t]),o=s.scroll.diff.value,a=function(e){var t=e.draggable,n=e.offset,i=e.initialWindowScroll,r=en(t.client,n),s=tn(r,i);return(0,p.A)({},t,{placeholder:(0,p.A)({},t.placeholder,{client:r}),client:r,page:s})}({draggable:e,offset:Cn(r,o),initialWindowScroll:i.scroll.initial});return a}))},Zi=function(e){return"SNAP"===e.movementMode},Xi=function(e,t,n){var i=function(e,t){return{draggables:e.draggables,droppables:ji(e.droppables,t)}}(e.dimensions,t);return!Zi(e)||n?Wi({state:e,dimensions:i}):Ki({state:e,dimensions:i})};function Qi(e){return e.isDragging&&"SNAP"===e.movementMode?(0,p.A)({phase:"DRAGGING"},e,{scrollJumpRequest:null}):e}var er={phase:"IDLE",completed:null,shouldFlush:!1},tr=function(e,t){if(void 0===e&&(e=er),"FLUSH"===t.type)return(0,p.A)({},er,{shouldFlush:!0});if("INITIAL_PUBLISH"===t.type){"IDLE"!==e.phase&&hn(!1);var n=t.payload,i=n.critical,r=n.clientSelection,s=n.viewport,o=n.dimensions,a=n.movementMode,l=o.draggables[i.draggable.id],c=o.droppables[i.droppable.id],d={selection:r,borderBoxCenter:l.client.borderBox.center,offset:An},u={client:d,page:{selection:Cn(d.selection,s.scroll.initial),borderBoxCenter:Cn(d.selection,s.scroll.initial),offset:Cn(d.selection,s.scroll.diff.value)}},m=Hn(o.droppables).every((function(e){return!e.isFixedOnPage})),h=Ji({draggable:l,home:c,draggables:o.draggables,viewport:s}),g=h.impact;return{phase:"DRAGGING",isDragging:!0,critical:i,movementMode:a,dimensions:o,initial:u,current:u,isWindowScrollAllowed:m,impact:g,afterCritical:h.afterCritical,onLiftImpact:g,viewport:s,scrollJumpRequest:null,forceShouldAnimate:null}}if("COLLECTION_STARTING"===t.type)return"COLLECTING"===e.phase||"DROP_PENDING"===e.phase?e:("DRAGGING"!==e.phase&&hn(!1),(0,p.A)({phase:"COLLECTING"},e,{phase:"COLLECTING"}));if("PUBLISH_WHILE_DRAGGING"===t.type)return"COLLECTING"!==e.phase&&"DROP_PENDING"!==e.phase&&hn(!1),function(e){var t=e.state,n=e.published;qi();var i=n.modified.map((function(e){var n=t.dimensions.droppables[e.droppableId];return Fn(n,e.scroll)})),r=(0,p.A)({},t.dimensions.droppables,{},zn(i)),s=Wn(Yi({additions:n.additions,updatedDroppables:r,viewport:t.viewport})),o=(0,p.A)({},t.dimensions.draggables,{},s);n.removals.forEach((function(e){delete o[e]}));var a={droppables:r,draggables:o},l=Di(t.impact),c=l?a.droppables[l]:null,d=a.draggables[t.critical.draggable.id],u=a.droppables[t.critical.droppable.id],m=Ji({draggable:d,home:u,draggables:o,viewport:t.viewport}),h=m.impact,g=m.afterCritical,v=c&&c.isCombineEnabled?t.impact:h,f=Vi({pageOffset:t.current.page.offset,draggable:a.draggables[t.critical.draggable.id],draggables:a.draggables,droppables:a.droppables,previousImpact:v,viewport:t.viewport,afterCritical:g});$i();var _=(0,p.A)({phase:"DRAGGING"},t,{phase:"DRAGGING",impact:f,onLiftImpact:h,dimensions:a,afterCritical:g,forceShouldAnimate:!1});return"COLLECTING"===t.phase?_:(0,p.A)({phase:"DROP_PENDING"},_,{phase:"DROP_PENDING",reason:t.reason,isWaiting:!1})}({state:e,published:t.payload});if("MOVE"===t.type){if("DROP_PENDING"===e.phase)return e;Oi(e)||hn(!1);var v=t.payload.client;return kn(v,e.current.client.selection)?e:Wi({state:e,clientSelection:v,impact:Zi(e)?e.impact:null})}if("UPDATE_DROPPABLE_SCROLL"===t.type){if("DROP_PENDING"===e.phase)return Qi(e);if("COLLECTING"===e.phase)return Qi(e);Oi(e)||hn(!1);var f=t.payload,_=f.id,y=f.newScroll,b=e.dimensions.droppables[_];if(!b)return e;var E=Fn(b,y);return Xi(e,E,!1)}if("UPDATE_DROPPABLE_IS_ENABLED"===t.type){if("DROP_PENDING"===e.phase)return e;Oi(e)||hn(!1);var w=t.payload,S=w.id,A=w.isEnabled,C=e.dimensions.droppables[S];C||hn(!1),C.isEnabled===A&&hn(!1);var x=(0,p.A)({},C,{isEnabled:A});return Xi(e,x,!0)}if("UPDATE_DROPPABLE_IS_COMBINE_ENABLED"===t.type){if("DROP_PENDING"===e.phase)return e;Oi(e)||hn(!1);var k=t.payload,R=k.id,I=k.isCombineEnabled,T=e.dimensions.droppables[R];T||hn(!1),T.isCombineEnabled===I&&hn(!1);var P=(0,p.A)({},T,{isCombineEnabled:I});return Xi(e,P,!0)}if("MOVE_BY_WINDOW_SCROLL"===t.type){if("DROP_PENDING"===e.phase||"DROP_ANIMATING"===e.phase)return e;Oi(e)||hn(!1),e.isWindowScrollAllowed||hn(!1);var N=t.payload.newScroll;if(kn(e.viewport.scroll.current,N))return Qi(e);var D=Ei(e.viewport,N);return Zi(e)?Ki({state:e,viewport:D}):Wi({state:e,viewport:D})}if("UPDATE_VIEWPORT_MAX_SCROLL"===t.type){if(!Oi(e))return e;var M=t.payload.maxScroll;if(kn(M,e.viewport.scroll.max))return e;var O=(0,p.A)({},e.viewport,{scroll:(0,p.A)({},e.viewport.scroll,{max:M})});return(0,p.A)({phase:"DRAGGING"},e,{viewport:O})}if("MOVE_UP"===t.type||"MOVE_DOWN"===t.type||"MOVE_LEFT"===t.type||"MOVE_RIGHT"===t.type){if("COLLECTING"===e.phase||"DROP_PENDING"===e.phase)return e;"DRAGGING"!==e.phase&&hn(!1);var L=Mi({state:e,type:t.type});return L?Wi({state:e,impact:L.impact,clientSelection:L.clientSelection,scrollJumpRequest:L.scrollJumpRequest}):e}if("DROP_PENDING"===t.type){var F=t.payload.reason;return"COLLECTING"!==e.phase&&hn(!1),(0,p.A)({phase:"DROP_PENDING"},e,{phase:"DROP_PENDING",isWaiting:!0,reason:F})}if("DROP_ANIMATE"===t.type){var U=t.payload,B=U.completed,V=U.dropDuration,j=U.newHomeClientOffset;return"DRAGGING"!==e.phase&&"DROP_PENDING"!==e.phase&&hn(!1),{phase:"DROP_ANIMATING",completed:B,dropDuration:V,newHomeClientOffset:j,dimensions:e.dimensions}}return"DROP_COMPLETE"===t.type?{phase:"IDLE",completed:t.payload.completed,shouldFlush:!1}:e},nr=function(e){return{type:"PUBLISH_WHILE_DRAGGING",payload:e}},ir=function(){return{type:"COLLECTION_STARTING",payload:null}},rr=function(e){return{type:"UPDATE_DROPPABLE_SCROLL",payload:e}},sr=function(e){return{type:"UPDATE_DROPPABLE_IS_ENABLED",payload:e}},or=function(e){return{type:"UPDATE_DROPPABLE_IS_COMBINE_ENABLED",payload:e}},ar=function(e){return{type:"MOVE",payload:e}},lr=function(){return{type:"MOVE_UP",payload:null}},cr=function(){return{type:"MOVE_DOWN",payload:null}},dr=function(){return{type:"MOVE_RIGHT",payload:null}},ur=function(){return{type:"MOVE_LEFT",payload:null}},mr=function(e){return{type:"DROP_COMPLETE",payload:e}},pr=function(e){return{type:"DROP",payload:e}},hr=function(){return{type:"DROP_ANIMATION_FINISHED",payload:null}};var gr="cubic-bezier(.2,1,.1,1)",vr={drop:0,combining:.7},fr={drop:.75},_r=.2+"s "+"cubic-bezier(0.2, 0, 0, 1)",yr={fluid:"opacity "+_r,snap:"transform "+_r+", opacity "+_r,drop:function(e){var t=e+"s "+gr;return"transform "+t+", opacity "+t},outOfTheWay:"transform "+_r,placeholder:"height "+_r+", width "+_r+", margin "+_r},br=function(e){return kn(e,An)?null:"translate("+e.x+"px, "+e.y+"px)"},Er=br,wr=function(e,t){var n=br(e);return n?t?n+" scale("+fr.drop+")":n:null},Sr=.33,Ar=.55,Cr=Ar-Sr,xr=function(e){var t=e.getState,n=e.dispatch;return function(e){return function(i){if("DROP"===i.type){var r=t(),s=i.payload.reason;if("COLLECTING"!==r.phase){if("IDLE"!==r.phase){"DROP_PENDING"===r.phase&&r.isWaiting&&hn(!1),"DRAGGING"!==r.phase&&"DROP_PENDING"!==r.phase&&hn(!1);var o=r.critical,a=r.dimensions,l=a.draggables[r.critical.draggable.id],c=function(e){var t=e.draggables,n=e.reason,i=e.lastImpact,r=e.home,s=e.viewport,o=e.onLiftImpact;return i.at&&"DROP"===n?"REORDER"===i.at.type?{impact:i,didDropInsideDroppable:!0}:{impact:(0,p.A)({},i,{displaced:Xn}),didDropInsideDroppable:!0}:{impact:Hi({draggables:t,impact:o,destination:r,viewport:s,forceShouldAnimate:!0}),didDropInsideDroppable:!1}}({reason:s,lastImpact:r.impact,afterCritical:r.afterCritical,onLiftImpact:r.onLiftImpact,home:r.dimensions.droppables[r.critical.droppable.id],viewport:r.viewport,draggables:r.dimensions.draggables}),d=c.impact,u=c.didDropInsideDroppable,m=u?Jn(d):null,h=u?qn(d):null,g={index:o.draggable.index,droppableId:o.droppable.id},v={draggableId:l.descriptor.id,type:l.descriptor.type,source:g,reason:s,mode:r.movementMode,destination:m,combine:h},f=function(e){var t=e.impact,n=e.draggable,i=e.dimensions,r=e.viewport,s=e.afterCritical,o=i.draggables,a=i.droppables,l=Di(t),c=l?a[l]:null,d=a[n.descriptor.droppableId],u=Gi({impact:t,draggable:n,draggables:o,afterCritical:s,droppable:c||d,viewport:r});return xn(u,n.client.borderBox.center)}({impact:d,draggable:l,dimensions:a,viewport:r.viewport,afterCritical:r.afterCritical}),_={critical:r.critical,afterCritical:r.afterCritical,result:v,impact:d};if(!kn(r.current.client.offset,f)||Boolean(v.combine)){var y=function(e){var t=e.current,n=e.destination,i=e.reason,r=Tn(t,n);if(r<=0)return Sr;if(r>=1500)return Ar;var s=Sr+Cr*(r/1500);return Number(("CANCEL"===i?.6*s:s).toFixed(2))}({current:r.current.client.offset,destination:f,reason:s});n(function(e){return{type:"DROP_ANIMATE",payload:e}}({newHomeClientOffset:f,dropDuration:y,completed:_}))}else n(mr({completed:_}))}}else n(function(e){return{type:"DROP_PENDING",payload:e}}({reason:s}))}else e(i)}}},kr=function(){return{x:window.pageXOffset,y:window.pageYOffset}};function Rr(e){var t=e.onWindowScroll;var n=ln((function(){t(kr())})),i=function(e){return{eventName:"scroll",options:{passive:!0,capture:!1},fn:function(t){t.target!==window&&t.target!==window.document||e()}}}(n),r=dn;function s(){return r!==dn}return{start:function(){s()&&hn(!1),r=un(window,[i])},stop:function(){s()||hn(!1),n.cancel(),r(),r=dn},isActive:s}}var Ir=function(e){var t=Rr({onWindowScroll:function(t){e.dispatch({type:"MOVE_BY_WINDOW_SCROLL",payload:{newScroll:t}})}});return function(e){return function(n){t.isActive()||"INITIAL_PUBLISH"!==n.type||t.start(),t.isActive()&&function(e){return"DROP_COMPLETE"===e.type||"DROP_ANIMATE"===e.type||"FLUSH"===e.type}(n)&&t.stop(),e(n)}}},Tr=function(){var e=[];return{add:function(t){var n=setTimeout((function(){return function(t){var n=Bn(e,(function(e){return e.timerId===t}));-1===n&&hn(!1),e.splice(n,1)[0].callback()}(n)})),i={timerId:n,callback:t};e.push(i)},flush:function(){if(e.length){var t=[].concat(e);e.length=0,t.forEach((function(e){clearTimeout(e.timerId),e.callback()}))}}}},Pr=function(e,t){qi(),t(),$i()},Nr=function(e,t){return{draggableId:e.draggable.id,type:e.droppable.type,source:{droppableId:e.droppable.id,index:e.draggable.index},mode:t}},Dr=function(e,t,n,i){if(e){var r=function(e){var t=!1,n=!1,i=setTimeout((function(){n=!0})),r=function(r){t||n||(t=!0,e(r),clearTimeout(i))};return r.wasCalled=function(){return t},r}(n);e(t,{announce:r}),r.wasCalled()||n(i(t))}else n(i(t))},Mr=function(e,t){var n=function(e,t){var n=Tr(),i=null,r=function(n){i||hn(!1),i=null,Pr(0,(function(){return Dr(e().onDragEnd,n,t,Sn)}))};return{beforeCapture:function(t,n){i&&hn(!1),Pr(0,(function(){var i=e().onBeforeCapture;i&&i({draggableId:t,mode:n})}))},beforeStart:function(t,n){i&&hn(!1),Pr(0,(function(){var i=e().onBeforeDragStart;i&&i(Nr(t,n))}))},start:function(r,s){i&&hn(!1);var o=Nr(r,s);i={mode:s,lastCritical:r,lastLocation:o.source,lastCombine:null},n.add((function(){Pr(0,(function(){return Dr(e().onDragStart,o,t,En)}))}))},update:function(r,s){var o=Jn(s),a=qn(s);i||hn(!1);var l=!function(e,t){if(e===t)return!0;var n=e.draggable.id===t.draggable.id&&e.draggable.droppableId===t.draggable.droppableId&&e.draggable.type===t.draggable.type&&e.draggable.index===t.draggable.index,i=e.droppable.id===t.droppable.id&&e.droppable.type===t.droppable.type;return n&&i}(r,i.lastCritical);l&&(i.lastCritical=r);var c,d,u=(d=o,!(null==(c=i.lastLocation)&&null==d||null!=c&&null!=d&&c.droppableId===d.droppableId&&c.index===d.index));u&&(i.lastLocation=o);var m=!function(e,t){return null==e&&null==t||null!=e&&null!=t&&e.draggableId===t.draggableId&&e.droppableId===t.droppableId}(i.lastCombine,a);if(m&&(i.lastCombine=a),l||u||m){var h=(0,p.A)({},Nr(r,i.mode),{combine:a,destination:o});n.add((function(){Pr(0,(function(){return Dr(e().onDragUpdate,h,t,wn)}))}))}},flush:function(){i||hn(!1),n.flush()},drop:r,abort:function(){if(i){var e=(0,p.A)({},Nr(i.lastCritical,i.mode),{combine:null,destination:null,reason:"CANCEL"});r(e)}}}}(e,t);return function(e){return function(t){return function(i){if("BEFORE_INITIAL_CAPTURE"!==i.type){if("INITIAL_PUBLISH"===i.type){var r=i.payload.critical;return n.beforeStart(r,i.payload.movementMode),t(i),void n.start(r,i.payload.movementMode)}if("DROP_COMPLETE"===i.type){var s=i.payload.completed.result;return n.flush(),t(i),void n.drop(s)}if(t(i),"FLUSH"!==i.type){var o=e.getState();"DRAGGING"===o.phase&&n.update(o.critical,o.impact)}else n.abort()}else n.beforeCapture(i.payload.draggableId,i.payload.movementMode)}}}},Or=function(e){return function(t){return function(n){if("DROP_ANIMATION_FINISHED"===n.type){var i=e.getState();"DROP_ANIMATING"!==i.phase&&hn(!1),e.dispatch(mr({completed:i.completed}))}else t(n)}}},Lr=function(e){var t=null,n=null;return function(i){return function(r){if("FLUSH"!==r.type&&"DROP_COMPLETE"!==r.type&&"DROP_ANIMATION_FINISHED"!==r.type||(n&&(cancelAnimationFrame(n),n=null),t&&(t(),t=null)),i(r),"DROP_ANIMATE"===r.type){var s={eventName:"scroll",options:{capture:!0,passive:!1,once:!0},fn:function(){"DROP_ANIMATING"===e.getState().phase&&e.dispatch({type:"DROP_ANIMATION_FINISHED",payload:null})}};n=requestAnimationFrame((function(){n=null,t=un(window,[s])}))}}}},Fr=function(e){return function(t){return function(n){if(t(n),"PUBLISH_WHILE_DRAGGING"===n.type){var i=e.getState();"DROP_PENDING"===i.phase&&(i.isWaiting||e.dispatch(pr({reason:i.reason})))}}}},Ur=nt,Br=function(e){var t,n=e.dimensionMarshal,i=e.focusMarshal,r=e.styleMarshal,s=e.getResponders,o=e.announce,a=e.autoScroller;return Qe(tr,Ur(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return function(e){return function(){var n=e.apply(void 0,arguments),i=function(){throw new Error(qe(15))},r={getState:n.getState,dispatch:function(){return i.apply(void 0,arguments)}},s=t.map((function(e){return e(r)}));return i=nt.apply(void 0,s)(n.dispatch),Je(Je({},n),{},{dispatch:i})}}}((t=r,function(){return function(e){return function(n){"INITIAL_PUBLISH"===n.type&&t.dragging(),"DROP_ANIMATE"===n.type&&t.dropping(n.payload.completed.result.reason),"FLUSH"!==n.type&&"DROP_COMPLETE"!==n.type||t.resting(),e(n)}}}),function(e){return function(){return function(t){return function(n){"DROP_COMPLETE"!==n.type&&"FLUSH"!==n.type&&"DROP_ANIMATE"!==n.type||e.stopPublishing(),t(n)}}}}(n),function(e){return function(t){var n=t.getState,i=t.dispatch;return function(t){return function(r){if("LIFT"===r.type){var s=r.payload,o=s.id,a=s.clientSelection,l=s.movementMode,c=n();"DROP_ANIMATING"===c.phase&&i(mr({completed:c.completed})),"IDLE"!==n().phase&&hn(!1),i({type:"FLUSH",payload:null}),i({type:"BEFORE_INITIAL_CAPTURE",payload:{draggableId:o,movementMode:l}});var d={draggableId:o,scrollOptions:{shouldPublishImmediately:"SNAP"===l}},u=e.startPublishing(d),m=u.critical,p=u.dimensions,h=u.viewport;i({type:"INITIAL_PUBLISH",payload:{critical:m,dimensions:p,clientSelection:a,movementMode:l,viewport:h}})}else t(r)}}}}(n),xr,Or,Lr,Fr,function(e){return function(t){return function(n){return function(i){if(function(e){return"DROP_COMPLETE"===e.type||"DROP_ANIMATE"===e.type||"FLUSH"===e.type}(i))return e.stop(),void n(i);if("INITIAL_PUBLISH"===i.type){n(i);var r=t.getState();return"DRAGGING"!==r.phase&&hn(!1),void e.start(r)}n(i),e.scroll(t.getState())}}}}(a),Ir,function(e){var t=!1;return function(){return function(n){return function(i){if("INITIAL_PUBLISH"===i.type)return t=!0,e.tryRecordFocus(i.payload.critical.draggable.id),n(i),void e.tryRestoreFocusRecorded();if(n(i),t){if("FLUSH"===i.type)return t=!1,void e.tryRestoreFocusRecorded();if("DROP_COMPLETE"===i.type){t=!1;var r=i.payload.completed.result;r.combine&&e.tryShiftRecord(r.draggableId,r.combine.draggableId),e.tryRestoreFocusRecorded()}}}}}}(i),Mr(s,o))))};var Vr=function(e){var t=e.scrollHeight,n=e.scrollWidth,i=e.height,r=e.width,s=xn({x:n,y:t},{x:r,y:i});return{x:Math.max(0,s.x),y:Math.max(0,s.y)}},jr=function(){var e=document.documentElement;return e||hn(!1),e},zr=function(){var e=jr();return Vr({scrollHeight:e.scrollHeight,scrollWidth:e.scrollWidth,width:e.clientWidth,height:e.clientHeight})},Wr=function(e){var t=e.critical,n=e.scrollOptions,i=e.registry;qi();var r,s,o,a,l,c,d,u=(r=kr(),s=zr(),o=r.y,a=r.x,l=jr(),c=l.clientWidth,d=l.clientHeight,{frame:qt({top:o,left:a,right:a+c,bottom:o+d}),scroll:{initial:r,current:r,max:s,diff:{value:An,displacement:An}}}),m=u.scroll.current,p=t.droppable,h=i.droppable.getAllByType(p.type).map((function(e){return e.callbacks.getDimensionAndWatchScroll(m,n)})),g=i.draggable.getAllByType(t.draggable.type).map((function(e){return e.getDimension(m)})),v={draggables:Wn(g),droppables:zn(h)};return $i(),{dimensions:v,critical:t,viewport:u}};function Hr(e,t,n){return n.descriptor.id!==t.id&&(n.descriptor.type===t.type&&"virtual"===e.droppable.getById(n.descriptor.droppableId).descriptor.mode)}var Gr,Kr,Jr=function(e,t){var n=null,i=function(e){var t=e.registry,n=e.callbacks,i={additions:{},removals:{},modified:{}},r=null,s=function(){r||(n.collectionStarting(),r=requestAnimationFrame((function(){r=null,qi();var e=i,s=e.additions,o=e.removals,a=e.modified,l=Object.keys(s).map((function(e){return t.draggable.getById(e).getDimension(An)})).sort((function(e,t){return e.descriptor.index-t.descriptor.index})),c=Object.keys(a).map((function(e){return{droppableId:e,scroll:t.droppable.getById(e).callbacks.getScrollWhileDragging()}})),d={additions:l,removals:Object.keys(o),modified:c};i={additions:{},removals:{},modified:{}},$i(),n.publish(d)})))};return{add:function(e){var t=e.descriptor.id;i.additions[t]=e,i.modified[e.descriptor.droppableId]=!0,i.removals[t]&&delete i.removals[t],s()},remove:function(e){var t=e.descriptor;i.removals[t.id]=!0,i.modified[t.droppableId]=!0,i.additions[t.id]&&delete i.additions[t.id],s()},stop:function(){r&&(cancelAnimationFrame(r),r=null,i={additions:{},removals:{},modified:{}})}}}({callbacks:{publish:t.publishWhileDragging,collectionStarting:t.collectionStarting},registry:e}),r=function(t){n||hn(!1);var r=n.critical.draggable;"ADDITION"===t.type&&Hr(e,r,t.value)&&i.add(t.value),"REMOVAL"===t.type&&Hr(e,r,t.value)&&i.remove(t.value)},s={updateDroppableIsEnabled:function(i,r){e.droppable.exists(i)||hn(!1),n&&t.updateDroppableIsEnabled({id:i,isEnabled:r})},updateDroppableIsCombineEnabled:function(i,r){n&&(e.droppable.exists(i)||hn(!1),t.updateDroppableIsCombineEnabled({id:i,isCombineEnabled:r}))},scrollDroppable:function(t,i){n&&e.droppable.getById(t).callbacks.scroll(i)},updateDroppableScroll:function(i,r){n&&(e.droppable.exists(i)||hn(!1),t.updateDroppableScroll({id:i,newScroll:r}))},startPublishing:function(t){n&&hn(!1);var i=e.draggable.getById(t.draggableId),s=e.droppable.getById(i.descriptor.droppableId),o={draggable:i.descriptor,droppable:s.descriptor},a=e.subscribe(r);return n={critical:o,unsubscribe:a},Wr({critical:o,registry:e,scrollOptions:t.scrollOptions})},stopPublishing:function(){if(n){i.stop();var t=n.critical.droppable;e.droppable.getAllByType(t.type).forEach((function(e){return e.callbacks.dragStopped()})),n.unsubscribe(),n=null}}};return s},qr=function(e,t){return"IDLE"===e.phase||"DROP_ANIMATING"===e.phase&&(e.completed.result.draggableId!==t&&"DROP"===e.completed.result.reason)},$r=function(e){window.scrollBy(e.x,e.y)},Yr=an((function(e){return Hn(e).filter((function(e){return!!e.isEnabled&&!!e.frame}))})),Zr=function(e){var t=e.center,n=e.destination,i=e.droppables;if(n){var r=i[n];return r.frame?r:null}var s=function(e,t){var n=Vn(Yr(t),(function(t){return t.frame||hn(!1),Li(t.frame.pageMarginBox)(e)}));return n}(t,i);return s},Xr=.25,Qr=.05,es=28,ts=function(e){return Math.pow(e,2)},ns={stopDampeningAt:1200,accelerateAt:360},is=function(e){var t=e.startOfRange,n=e.endOfRange,i=e.current,r=n-t;return 0===r?0:(i-t)/r},rs=ns.accelerateAt,ss=ns.stopDampeningAt,os=function(e){var t=e.distanceToEdge,n=e.thresholds,i=e.dragStartTime,r=e.shouldUseTimeDampening,s=function(e,t){if(e>t.startScrollingFrom)return 0;if(e<=t.maxScrollValueAt)return es;if(e===t.startScrollingFrom)return 1;var n=is({startOfRange:t.maxScrollValueAt,endOfRange:t.startScrollingFrom,current:e}),i=es*ts(1-n);return Math.ceil(i)}(t,n);return 0===s?0:r?Math.max(function(e,t){var n=t,i=ss,r=Date.now()-n;if(r>=ss)return e;if(r<rs)return 1;var s=is({startOfRange:rs,endOfRange:i,current:r}),o=e*ts(s);return Math.ceil(o)}(s,i),1):s},as=function(e){var t=e.container,n=e.distanceToEdges,i=e.dragStartTime,r=e.axis,s=e.shouldUseTimeDampening,o=function(e,t){return{startScrollingFrom:e[t.size]*Xr,maxScrollValueAt:e[t.size]*Qr}}(t,r);return n[r.end]<n[r.start]?os({distanceToEdge:n[r.end],thresholds:o,dragStartTime:i,shouldUseTimeDampening:s}):-1*os({distanceToEdge:n[r.start],thresholds:o,dragStartTime:i,shouldUseTimeDampening:s})},ls=Nn((function(e){return 0===e?0:e})),cs=function(e){var t=e.dragStartTime,n=e.container,i=e.subject,r=e.center,s=e.shouldUseTimeDampening,o={top:r.y-n.top,right:n.right-r.x,bottom:n.bottom-r.y,left:r.x-n.left},a=as({container:n,distanceToEdges:o,dragStartTime:t,axis:ii,shouldUseTimeDampening:s}),l=as({container:n,distanceToEdges:o,dragStartTime:t,axis:ri,shouldUseTimeDampening:s}),c=ls({x:l,y:a});if(kn(c,An))return null;var d=function(e){var t=e.container,n=e.subject,i=e.proposedScroll,r=n.height>t.height,s=n.width>t.width;return s||r?s&&r?null:{x:s?0:i.x,y:r?0:i.y}:i}({container:n,subject:i,proposedScroll:c});return d?kn(d,An)?null:d:null},ds=Nn((function(e){return 0===e?0:e>0?1:-1})),us=(Gr=function(e,t){return e<0?e:e>t?e-t:0},function(e){var t=e.current,n=e.max,i=e.change,r=Cn(t,i),s={x:Gr(r.x,n.x),y:Gr(r.y,n.y)};return kn(s,An)?null:s}),ms=function(e){var t=e.max,n=e.current,i=e.change,r={x:Math.max(n.x,t.x),y:Math.max(n.y,t.y)},s=ds(i),o=us({max:r,current:n,change:s});return!o||(0!==s.x&&0===o.x||0!==s.y&&0===o.y)},ps=function(e,t){return ms({current:e.scroll.current,max:e.scroll.max,change:t})},hs=function(e,t){var n=e.frame;return!!n&&ms({current:n.scroll.current,max:n.scroll.max,change:t})},gs=function(e){var t=e.state,n=e.dragStartTime,i=e.shouldUseTimeDampening,r=e.scrollWindow,s=e.scrollDroppable,o=t.current.page.borderBoxCenter,a=t.dimensions.draggables[t.critical.draggable.id].page.marginBox;if(t.isWindowScrollAllowed){var l=function(e){var t=e.viewport,n=e.subject,i=e.center,r=e.dragStartTime,s=e.shouldUseTimeDampening,o=cs({dragStartTime:r,container:t.frame,subject:n,center:i,shouldUseTimeDampening:s});return o&&ps(t,o)?o:null}({dragStartTime:n,viewport:t.viewport,subject:a,center:o,shouldUseTimeDampening:i});if(l)return void r(l)}var c=Zr({center:o,destination:Di(t.impact),droppables:t.dimensions.droppables});if(c){var d=function(e){var t=e.droppable,n=e.subject,i=e.center,r=e.dragStartTime,s=e.shouldUseTimeDampening,o=t.frame;if(!o)return null;var a=cs({dragStartTime:r,container:o.pageMarginBox,subject:n,center:i,shouldUseTimeDampening:s});return a&&hs(t,a)?a:null}({dragStartTime:n,droppable:c,subject:a,center:o,shouldUseTimeDampening:i});d&&s(c.descriptor.id,d)}},vs=function(e){var t=e.move,n=e.scrollDroppable,i=e.scrollWindow,r=function(e,t){if(!hs(e,t))return t;var i=function(e,t){var n=e.frame;return n&&hs(e,t)?us({current:n.scroll.current,max:n.scroll.max,change:t}):null}(e,t);if(!i)return n(e.descriptor.id,t),null;var r=xn(t,i);return n(e.descriptor.id,r),xn(t,r)},s=function(e,t,n){if(!e)return n;if(!ps(t,n))return n;var r=function(e,t){if(!ps(e,t))return null;var n=e.scroll.max,i=e.scroll.current;return us({current:i,max:n,change:t})}(t,n);if(!r)return i(n),null;var s=xn(n,r);return i(s),xn(n,s)};return function(e){var n=e.scrollJumpRequest;if(n){var i=Di(e.impact);i||hn(!1);var o=r(e.dimensions.droppables[i],n);if(o){var a=e.viewport,l=s(e.isWindowScrollAllowed,a,o);l&&function(e,n){var i=Cn(e.current.client.selection,n);t({client:i})}(e,l)}}}},fs=function(e){var t=e.scrollDroppable,n=e.scrollWindow,i=e.move,r=function(e){var t=e.scrollWindow,n=e.scrollDroppable,i=ln(t),r=ln(n),s=null,o=function(e){s||hn(!1);var t=s,n=t.shouldUseTimeDampening,o=t.dragStartTime;gs({state:e,scrollWindow:i,scrollDroppable:r,dragStartTime:o,shouldUseTimeDampening:n})};return{start:function(e){qi(),s&&hn(!1);var t=Date.now(),n=!1,i=function(){n=!0};gs({state:e,dragStartTime:0,shouldUseTimeDampening:!1,scrollWindow:i,scrollDroppable:i}),s={dragStartTime:t,shouldUseTimeDampening:n},$i(),n&&o(e)},stop:function(){s&&(i.cancel(),r.cancel(),s=null)},scroll:o}}({scrollWindow:n,scrollDroppable:t}),s=vs({move:i,scrollWindow:n,scrollDroppable:t});return{scroll:function(e){"DRAGGING"===e.phase&&("FLUID"!==e.movementMode?e.scrollJumpRequest&&s(e):r.scroll(e))},start:r.start,stop:r.stop}},_s="data-rbd",ys={base:Kr=_s+"-drag-handle",draggableId:Kr+"-draggable-id",contextId:Kr+"-context-id"},bs=function(){var e=_s+"-draggable";return{base:e,contextId:e+"-context-id",id:e+"-id"}}(),Es=function(){var e=_s+"-droppable";return{base:e,contextId:e+"-context-id",id:e+"-id"}}(),ws={contextId:_s+"-scroll-container-context-id"},Ss=function(e,t){return e.map((function(e){var n=e.styles[t];return n?e.selector+" { "+n+" }":""})).join(" ")},As="undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement?s.useLayoutEffect:s.useEffect,Cs=function(){var e=document.querySelector("head");return e||hn(!1),e},xs=function(e){var t=document.createElement("style");return e&&t.setAttribute("nonce",e),t.type="text/css",t};function ks(e,t){var n=Gt((function(){return function(e){var t,n,i,r=(t=e,function(e){return"["+e+'="'+t+'"]'}),s=(n="\n      cursor: -webkit-grab;\n      cursor: grab;\n    ",{selector:r(ys.contextId),styles:{always:"\n          -webkit-touch-callout: none;\n          -webkit-tap-highlight-color: rgba(0,0,0,0);\n          touch-action: manipulation;\n        ",resting:n,dragging:"pointer-events: none;",dropAnimating:n}}),o=[(i="\n      transition: "+yr.outOfTheWay+";\n    ",{selector:r(bs.contextId),styles:{dragging:i,dropAnimating:i,userCancel:i}}),s,{selector:r(Es.contextId),styles:{always:"overflow-anchor: none;"}},{selector:"body",styles:{dragging:"\n        cursor: grabbing;\n        cursor: -webkit-grabbing;\n        user-select: none;\n        -webkit-user-select: none;\n        -moz-user-select: none;\n        -ms-user-select: none;\n        overflow-anchor: none;\n      "}}];return{always:Ss(o,"always"),resting:Ss(o,"resting"),dragging:Ss(o,"dragging"),dropAnimating:Ss(o,"dropAnimating"),userCancel:Ss(o,"userCancel")}}(e)}),[e]),i=(0,s.useRef)(null),r=(0,s.useRef)(null),o=Kt(an((function(e){var t=r.current;t||hn(!1),t.textContent=e})),[]),a=Kt((function(e){var t=i.current;t||hn(!1),t.textContent=e}),[]);As((function(){(i.current||r.current)&&hn(!1);var s=xs(t),l=xs(t);return i.current=s,r.current=l,s.setAttribute(_s+"-always",e),l.setAttribute(_s+"-dynamic",e),Cs().appendChild(s),Cs().appendChild(l),a(n.always),o(n.resting),function(){var e=function(e){var t=e.current;t||hn(!1),Cs().removeChild(t),e.current=null};e(i),e(r)}}),[t,a,o,n.always,n.resting,e]);var l=Kt((function(){return o(n.dragging)}),[o,n.dragging]),c=Kt((function(e){o("DROP"!==e?n.userCancel:n.dropAnimating)}),[o,n.dropAnimating,n.userCancel]),d=Kt((function(){r.current&&o(n.resting)}),[o,n.resting]);return Gt((function(){return{dragging:l,dropping:c,resting:d}}),[l,c,d])}var Rs=function(e){return e&&e.ownerDocument?e.ownerDocument.defaultView:window};function Is(e){return e instanceof Rs(e).HTMLElement}function Ts(e,t){var n="["+ys.contextId+'="'+e+'"]',i=jn(document.querySelectorAll(n));if(!i.length)return null;var r=Vn(i,(function(e){return e.getAttribute(ys.draggableId)===t}));return r&&Is(r)?r:null}function Ps(){var e={draggables:{},droppables:{}},t=[];function n(e){t.length&&t.forEach((function(t){return t(e)}))}function i(t){return e.draggables[t]||null}function r(t){return e.droppables[t]||null}return{draggable:{register:function(t){e.draggables[t.descriptor.id]=t,n({type:"ADDITION",value:t})},update:function(t,n){var i=e.draggables[n.descriptor.id];i&&i.uniqueId===t.uniqueId&&(delete e.draggables[n.descriptor.id],e.draggables[t.descriptor.id]=t)},unregister:function(t){var r=t.descriptor.id,s=i(r);s&&t.uniqueId===s.uniqueId&&(delete e.draggables[r],n({type:"REMOVAL",value:t}))},getById:function(e){var t=i(e);return t||hn(!1),t},findById:i,exists:function(e){return Boolean(i(e))},getAllByType:function(t){return Un(e.draggables).filter((function(e){return e.descriptor.type===t}))}},droppable:{register:function(t){e.droppables[t.descriptor.id]=t},unregister:function(t){var n=r(t.descriptor.id);n&&t.uniqueId===n.uniqueId&&delete e.droppables[t.descriptor.id]},getById:function(e){var t=r(e);return t||hn(!1),t},findById:r,exists:function(e){return Boolean(r(e))},getAllByType:function(t){return Un(e.droppables).filter((function(e){return e.descriptor.type===t}))}},subscribe:function(e){return t.push(e),function(){var n=t.indexOf(e);-1!==n&&t.splice(n,1)}},clean:function(){e.draggables={},e.droppables={},t.length=0}}}var Ns=s.createContext(null),Ds=function(){var e=document.body;return e||hn(!1),e},Ms={position:"absolute",width:"1px",height:"1px",margin:"-1px",border:"0",padding:"0",overflow:"hidden",clip:"rect(0 0 0 0)","clip-path":"inset(100%)"};var Os=0,Ls={separator:"::"};function Fs(e,t){return void 0===t&&(t=Ls),Gt((function(){return""+e+t.separator+Os++}),[t.separator,e])}var Us=s.createContext(null);function Bs(e){0}function Vs(e,t){Bs()}function js(){Vs()}function zs(e){var t=(0,s.useRef)(e);return(0,s.useEffect)((function(){t.current=e})),t}var Ws,Hs=((Ws={})[13]=!0,Ws[9]=!0,Ws),Gs=function(e){Hs[e.keyCode]&&e.preventDefault()},Ks=function(){var e="visibilitychange";return"undefined"==typeof document?e:Vn([e,"ms"+e,"webkit"+e,"moz"+e,"o"+e],(function(e){return"on"+e in document}))||e}();var Js,qs={type:"IDLE"};function $s(e){var t=e.cancel,n=e.completed,i=e.getPhase,r=e.setPhase;return[{eventName:"mousemove",fn:function(e){var t=e.button,n=e.clientX,s=e.clientY;if(0===t){var o={x:n,y:s},a=i();if("DRAGGING"===a.type)return e.preventDefault(),void a.actions.move(o);"PENDING"!==a.type&&hn(!1);var l=a.point;if(c=l,d=o,Math.abs(d.x-c.x)>=5||Math.abs(d.y-c.y)>=5){var c,d;e.preventDefault();var u=a.actions.fluidLift(o);r({type:"DRAGGING",actions:u})}}}},{eventName:"mouseup",fn:function(e){var r=i();"DRAGGING"===r.type?(e.preventDefault(),r.actions.drop({shouldBlockNextClick:!0}),n()):t()}},{eventName:"mousedown",fn:function(e){"DRAGGING"===i().type&&e.preventDefault(),t()}},{eventName:"keydown",fn:function(e){if("PENDING"!==i().type)return 27===e.keyCode?(e.preventDefault(),void t()):void Gs(e);t()}},{eventName:"resize",fn:t},{eventName:"scroll",options:{passive:!0,capture:!1},fn:function(){"PENDING"===i().type&&t()}},{eventName:"webkitmouseforcedown",fn:function(e){var n=i();"IDLE"===n.type&&hn(!1),n.actions.shouldRespectForcePress()?t():e.preventDefault()}},{eventName:Ks,fn:t}]}function Ys(){}var Zs=((Js={})[34]=!0,Js[33]=!0,Js[36]=!0,Js[35]=!0,Js);function Xs(e,t){function n(){t(),e.cancel()}return[{eventName:"keydown",fn:function(i){return 27===i.keyCode?(i.preventDefault(),void n()):32===i.keyCode?(i.preventDefault(),t(),void e.drop()):40===i.keyCode?(i.preventDefault(),void e.moveDown()):38===i.keyCode?(i.preventDefault(),void e.moveUp()):39===i.keyCode?(i.preventDefault(),void e.moveRight()):37===i.keyCode?(i.preventDefault(),void e.moveLeft()):void(Zs[i.keyCode]?i.preventDefault():Gs(i))}},{eventName:"mousedown",fn:n},{eventName:"mouseup",fn:n},{eventName:"click",fn:n},{eventName:"touchstart",fn:n},{eventName:"resize",fn:n},{eventName:"wheel",fn:n,options:{passive:!0}},{eventName:Ks,fn:n}]}var Qs={type:"IDLE"};var eo={input:!0,button:!0,textarea:!0,select:!0,option:!0,optgroup:!0,video:!0,audio:!0};function to(e,t){if(null==t)return!1;if(Boolean(eo[t.tagName.toLowerCase()]))return!0;var n=t.getAttribute("contenteditable");return"true"===n||""===n||t!==e&&to(e,t.parentElement)}function no(e,t){var n=t.target;return!!Is(n)&&to(e,n)}var io=function(e){return qt(e.getBoundingClientRect()).center};var ro=function(){var e="matches";return"undefined"==typeof document?e:Vn([e,"msMatchesSelector","webkitMatchesSelector"],(function(e){return e in Element.prototype}))||e}();function so(e,t){return null==e?null:e[ro](t)?e:so(e.parentElement,t)}function oo(e,t){return e.closest?e.closest(t):so(e,t)}function ao(e,t){var n,i=t.target;if(!((n=i)instanceof Rs(n).Element))return null;var r=function(e){return"["+ys.contextId+'="'+e+'"]'}(e),s=oo(i,r);return s&&Is(s)?s:null}function lo(e){e.preventDefault()}function co(e){var t=e.expected,n=e.phase,i=e.isLockActive;e.shouldWarn;return!!i()&&t===n}function uo(e){var t=e.lockAPI,n=e.store,i=e.registry,r=e.draggableId;if(t.isClaimed())return!1;var s=i.draggable.findById(r);return!!s&&(!!s.options.isEnabled&&!!qr(n.getState(),r))}function mo(e){var t=e.lockAPI,n=e.contextId,i=e.store,r=e.registry,s=e.draggableId,o=e.forceSensorStop,a=e.sourceEvent;if(!uo({lockAPI:t,store:i,registry:r,draggableId:s}))return null;var l=r.draggable.getById(s),c=function(e,t){var n="["+bs.contextId+'="'+e+'"]',i=Vn(jn(document.querySelectorAll(n)),(function(e){return e.getAttribute(bs.id)===t}));return i&&Is(i)?i:null}(n,l.descriptor.id);if(!c)return null;if(a&&!l.options.canDragInteractiveElements&&no(c,a))return null;var d=t.claim(o||dn),u="PRE_DRAG";function m(){return l.options.shouldRespectForcePress}function h(){return t.isActive(d)}var g=function(e,t){co({expected:e,phase:u,isLockActive:h,shouldWarn:!0})&&i.dispatch(t())}.bind(null,"DRAGGING");function v(e){function n(){t.release(),u="COMPLETED"}function r(t,r){if(void 0===r&&(r={shouldBlockNextClick:!1}),e.cleanup(),r.shouldBlockNextClick){var s=un(window,[{eventName:"click",fn:lo,options:{once:!0,passive:!1,capture:!0}}]);setTimeout(s)}n(),i.dispatch(pr({reason:t}))}return"PRE_DRAG"!==u&&(n(),"PRE_DRAG"!==u&&hn(!1)),i.dispatch(function(e){return{type:"LIFT",payload:e}}(e.liftActionArgs)),u="DRAGGING",(0,p.A)({isActive:function(){return co({expected:"DRAGGING",phase:u,isLockActive:h,shouldWarn:!1})},shouldRespectForcePress:m,drop:function(e){return r("DROP",e)},cancel:function(e){return r("CANCEL",e)}},e.actions)}var f={isActive:function(){return co({expected:"PRE_DRAG",phase:u,isLockActive:h,shouldWarn:!1})},shouldRespectForcePress:m,fluidLift:function(e){var t=ln((function(e){g((function(){return ar({client:e})}))})),n=v({liftActionArgs:{id:s,clientSelection:e,movementMode:"FLUID"},cleanup:function(){return t.cancel()},actions:{move:t}});return(0,p.A)({},n,{move:t})},snapLift:function(){var e={moveUp:function(){return g(lr)},moveRight:function(){return g(dr)},moveDown:function(){return g(cr)},moveLeft:function(){return g(ur)}};return v({liftActionArgs:{id:s,clientSelection:io(c),movementMode:"SNAP"},cleanup:dn,actions:e})},abort:function(){co({expected:"PRE_DRAG",phase:u,isLockActive:h,shouldWarn:!0})&&t.release()}};return f}var po=[function(e){var t=(0,s.useRef)(qs),n=(0,s.useRef)(dn),i=Gt((function(){return{eventName:"mousedown",fn:function(t){if(!t.defaultPrevented&&0===t.button&&!(t.ctrlKey||t.metaKey||t.shiftKey||t.altKey)){var i=e.findClosestDraggableId(t);if(i){var r=e.tryGetLock(i,a,{sourceEvent:t});if(r){t.preventDefault();var s={x:t.clientX,y:t.clientY};n.current(),d(r,s)}}}}}}),[e]),r=Gt((function(){return{eventName:"webkitmouseforcewillbegin",fn:function(t){if(!t.defaultPrevented){var n=e.findClosestDraggableId(t);if(n){var i=e.findOptionsForDraggable(n);i&&(i.shouldRespectForcePress||e.canGetLock(n)&&t.preventDefault())}}}}}),[e]),o=Kt((function(){n.current=un(window,[r,i],{passive:!1,capture:!0})}),[r,i]),a=Kt((function(){"IDLE"!==t.current.type&&(t.current=qs,n.current(),o())}),[o]),l=Kt((function(){var e=t.current;a(),"DRAGGING"===e.type&&e.actions.cancel({shouldBlockNextClick:!0}),"PENDING"===e.type&&e.actions.abort()}),[a]),c=Kt((function(){var e=$s({cancel:l,completed:a,getPhase:function(){return t.current},setPhase:function(e){t.current=e}});n.current=un(window,e,{capture:!0,passive:!1})}),[l,a]),d=Kt((function(e,n){"IDLE"!==t.current.type&&hn(!1),t.current={type:"PENDING",point:n,actions:e},c()}),[c]);As((function(){return o(),function(){n.current()}}),[o])},function(e){var t=(0,s.useRef)(Ys),n=Gt((function(){return{eventName:"keydown",fn:function(n){if(!n.defaultPrevented&&32===n.keyCode){var r=e.findClosestDraggableId(n);if(r){var s=e.tryGetLock(r,l,{sourceEvent:n});if(s){n.preventDefault();var o=!0,a=s.snapLift();t.current(),t.current=un(window,Xs(a,l),{capture:!0,passive:!1})}}}function l(){o||hn(!1),o=!1,t.current(),i()}}}}),[e]),i=Kt((function(){t.current=un(window,[n],{passive:!1,capture:!0})}),[n]);As((function(){return i(),function(){t.current()}}),[i])},function(e){var t=(0,s.useRef)(Qs),n=(0,s.useRef)(dn),i=Kt((function(){return t.current}),[]),r=Kt((function(e){t.current=e}),[]),o=Gt((function(){return{eventName:"touchstart",fn:function(t){if(!t.defaultPrevented){var i=e.findClosestDraggableId(t);if(i){var r=e.tryGetLock(i,l,{sourceEvent:t});if(r){var s=t.touches[0],o={x:s.clientX,y:s.clientY};n.current(),m(r,o)}}}}}}),[e]),a=Kt((function(){n.current=un(window,[o],{capture:!0,passive:!1})}),[o]),l=Kt((function(){var e=t.current;"IDLE"!==e.type&&("PENDING"===e.type&&clearTimeout(e.longPressTimerId),r(Qs),n.current(),a())}),[a,r]),c=Kt((function(){var e=t.current;l(),"DRAGGING"===e.type&&e.actions.cancel({shouldBlockNextClick:!0}),"PENDING"===e.type&&e.actions.abort()}),[l]),d=Kt((function(){var e={capture:!0,passive:!1},t={cancel:c,completed:l,getPhase:i},r=un(window,function(e){var t=e.cancel,n=e.completed,i=e.getPhase;return[{eventName:"touchmove",options:{capture:!1},fn:function(e){var n=i();if("DRAGGING"===n.type){n.hasMoved=!0;var r=e.touches[0],s={x:r.clientX,y:r.clientY};e.preventDefault(),n.actions.move(s)}else t()}},{eventName:"touchend",fn:function(e){var r=i();"DRAGGING"===r.type?(e.preventDefault(),r.actions.drop({shouldBlockNextClick:!0}),n()):t()}},{eventName:"touchcancel",fn:function(e){"DRAGGING"===i().type?(e.preventDefault(),t()):t()}},{eventName:"touchforcechange",fn:function(e){var n=i();"IDLE"===n.type&&hn(!1);var r=e.touches[0];if(r&&r.force>=.15){var s=n.actions.shouldRespectForcePress();if("PENDING"!==n.type)return s?n.hasMoved?void e.preventDefault():void t():void e.preventDefault();s&&t()}}},{eventName:Ks,fn:t}]}(t),e),s=un(window,function(e){var t=e.cancel,n=e.getPhase;return[{eventName:"orientationchange",fn:t},{eventName:"resize",fn:t},{eventName:"contextmenu",fn:function(e){e.preventDefault()}},{eventName:"keydown",fn:function(e){"DRAGGING"===n().type?(27===e.keyCode&&e.preventDefault(),t()):t()}},{eventName:Ks,fn:t}]}(t),e);n.current=function(){r(),s()}}),[c,i,l]),u=Kt((function(){var e=i();"PENDING"!==e.type&&hn(!1);var t=e.actions.fluidLift(e.point);r({type:"DRAGGING",actions:t,hasMoved:!1})}),[i,r]),m=Kt((function(e,t){"IDLE"!==i().type&&hn(!1);var n=setTimeout(u,120);r({type:"PENDING",point:t,actions:e,longPressTimerId:n}),d()}),[d,i,r,u]);As((function(){return a(),function(){n.current();var e=i();"PENDING"===e.type&&(clearTimeout(e.longPressTimerId),r(Qs))}}),[i,a,r]),As((function(){return un(window,[{eventName:"touchmove",fn:function(){},options:{capture:!1,passive:!1}}])}),[])}];function ho(e){var t=e.contextId,n=e.store,i=e.registry,r=e.customSensors,o=e.enableDefaultSensors,a=[].concat(o?po:[],r||[]),l=(0,s.useState)((function(){return function(){var e=null;function t(){e||hn(!1),e=null}return{isClaimed:function(){return Boolean(e)},isActive:function(t){return t===e},claim:function(t){e&&hn(!1);var n={abandon:t};return e=n,n},release:t,tryAbandon:function(){e&&(e.abandon(),t())}}}()}))[0],c=Kt((function(e,t){e.isDragging&&!t.isDragging&&l.tryAbandon()}),[l]);As((function(){var e=n.getState();return n.subscribe((function(){var t=n.getState();c(e,t),e=t}))}),[l,n,c]),As((function(){return l.tryAbandon}),[l.tryAbandon]);var d=Kt((function(e){return uo({lockAPI:l,registry:i,store:n,draggableId:e})}),[l,i,n]),u=Kt((function(e,r,s){return mo({lockAPI:l,registry:i,contextId:t,store:n,draggableId:e,forceSensorStop:r,sourceEvent:s&&s.sourceEvent?s.sourceEvent:null})}),[t,l,i,n]),m=Kt((function(e){return function(e,t){var n=ao(e,t);return n?n.getAttribute(ys.draggableId):null}(t,e)}),[t]),p=Kt((function(e){var t=i.draggable.findById(e);return t?t.options:null}),[i.draggable]),h=Kt((function(){l.isClaimed()&&(l.tryAbandon(),"IDLE"!==n.getState().phase&&n.dispatch({type:"FLUSH",payload:null}))}),[l,n]),g=Kt(l.isClaimed,[l]),v=Gt((function(){return{canGetLock:d,tryGetLock:u,findClosestDraggableId:m,findOptionsForDraggable:p,tryReleaseLock:h,isLockClaimed:g}}),[d,u,m,p,h,g]);Bs();for(var f=0;f<a.length;f++)a[f](v)}function go(e){return e.current||hn(!1),e.current}function vo(e){var t=e.contextId,n=e.setCallbacks,i=e.sensors,r=e.nonce,o=e.dragHandleUsageInstructions,a=(0,s.useRef)(null);js();var l=zs(e),c=Kt((function(){return function(e){return{onBeforeCapture:e.onBeforeCapture,onBeforeDragStart:e.onBeforeDragStart,onDragStart:e.onDragStart,onDragEnd:e.onDragEnd,onDragUpdate:e.onDragUpdate}}(l.current)}),[l]),d=function(e){var t=Gt((function(){return function(e){return"rbd-announcement-"+e}(e)}),[e]),n=(0,s.useRef)(null);(0,s.useEffect)((function(){var e=document.createElement("div");return n.current=e,e.id=t,e.setAttribute("aria-live","assertive"),e.setAttribute("aria-atomic","true"),(0,p.A)(e.style,Ms),Ds().appendChild(e),function(){setTimeout((function(){var t=Ds();t.contains(e)&&t.removeChild(e),e===n.current&&(n.current=null)}))}}),[t]);var i=Kt((function(e){var t=n.current;t&&(t.textContent=e)}),[]);return i}(t),u=function(e){var t=e.contextId,n=e.text,i=Fs("hidden-text",{separator:"-"}),r=Gt((function(){return"rbd-hidden-text-"+(e={contextId:t,uniqueId:i}).contextId+"-"+e.uniqueId;var e}),[i,t]);return(0,s.useEffect)((function(){var e=document.createElement("div");return e.id=r,e.textContent=n,e.style.display="none",Ds().appendChild(e),function(){var t=Ds();t.contains(e)&&t.removeChild(e)}}),[r,n]),r}({contextId:t,text:o}),m=ks(t,r),h=Kt((function(e){go(a).dispatch(e)}),[]),g=Gt((function(){return tt({publishWhileDragging:nr,updateDroppableScroll:rr,updateDroppableIsEnabled:sr,updateDroppableIsCombineEnabled:or,collectionStarting:ir},h)}),[h]),v=function(){var e=Gt(Ps,[]);return(0,s.useEffect)((function(){return function(){requestAnimationFrame(e.clean)}}),[e]),e}(),f=Gt((function(){return Jr(v,g)}),[v,g]),_=Gt((function(){return fs((0,p.A)({scrollWindow:$r,scrollDroppable:f.scrollDroppable},tt({move:ar},h)))}),[f.scrollDroppable,h]),y=function(e){var t=(0,s.useRef)({}),n=(0,s.useRef)(null),i=(0,s.useRef)(null),r=(0,s.useRef)(!1),o=Kt((function(e,n){var i={id:e,focus:n};return t.current[e]=i,function(){var n=t.current;n[e]!==i&&delete n[e]}}),[]),a=Kt((function(t){var n=Ts(e,t);n&&n!==document.activeElement&&n.focus()}),[e]),l=Kt((function(e,t){n.current===e&&(n.current=t)}),[]),c=Kt((function(){i.current||r.current&&(i.current=requestAnimationFrame((function(){i.current=null;var e=n.current;e&&a(e)})))}),[a]),d=Kt((function(e){n.current=null;var t=document.activeElement;t&&t.getAttribute(ys.draggableId)===e&&(n.current=e)}),[]);return As((function(){return r.current=!0,function(){r.current=!1;var e=i.current;e&&cancelAnimationFrame(e)}}),[]),Gt((function(){return{register:o,tryRecordFocus:d,tryRestoreFocusRecorded:c,tryShiftRecord:l}}),[o,d,c,l])}(t),b=Gt((function(){return Br({announce:d,autoScroller:_,dimensionMarshal:f,focusMarshal:y,getResponders:c,styleMarshal:m})}),[d,_,f,y,c,m]);a.current=b;var E=Kt((function(){var e=go(a);"IDLE"!==e.getState().phase&&e.dispatch({type:"FLUSH",payload:null})}),[]),w=Kt((function(){var e=go(a).getState();return e.isDragging||"DROP_ANIMATING"===e.phase}),[]);n(Gt((function(){return{isDragging:w,tryAbort:E}}),[w,E]));var S=Kt((function(e){return qr(go(a).getState(),e)}),[]),A=Kt((function(){return Oi(go(a).getState())}),[]),C=Gt((function(){return{marshal:f,focus:y,contextId:t,canLift:S,isMovementAllowed:A,dragHandleUsageInstructionsId:u,registry:v}}),[t,f,u,y,S,A,v]);return ho({contextId:t,store:b,registry:v,customSensors:i,enableDefaultSensors:!1!==e.enableDefaultSensors}),(0,s.useEffect)((function(){return E}),[E]),s.createElement(Us.Provider,{value:C},s.createElement(ct,{context:Ns,store:b},e.children))}var fo=0;function _o(e){var t=Gt((function(){return""+fo++}),[]),n=e.dragHandleUsageInstructions||bn;return s.createElement(gn,null,(function(i){return s.createElement(vo,{nonce:e.nonce,contextId:t,setCallbacks:i,dragHandleUsageInstructions:n,enableDefaultSensors:e.enableDefaultSensors,sensors:e.sensors,onBeforeCapture:e.onBeforeCapture,onBeforeDragStart:e.onBeforeDragStart,onDragStart:e.onDragStart,onDragUpdate:e.onDragUpdate,onDragEnd:e.onDragEnd},e.children)}))}var yo=function(e){return function(t){return e===t}},bo=yo("scroll"),Eo=yo("auto"),wo=(yo("visible"),function(e,t){return t(e.overflowX)||t(e.overflowY)}),So=function(e){var t=window.getComputedStyle(e),n={overflowX:t.overflowX,overflowY:t.overflowY};return wo(n,bo)||wo(n,Eo)},Ao=function e(t){return null==t||t===document.body||t===document.documentElement?null:So(t)?t:e(t.parentElement)},Co=function(e){return{x:e.scrollLeft,y:e.scrollTop}},xo=function e(t){return!!t&&("fixed"===window.getComputedStyle(t).position||e(t.parentElement))},ko=function(e){return{closestScrollable:Ao(e),isFixedOnPage:xo(e)}},Ro=function(e){var t=e.ref,n=e.descriptor,i=e.env,r=e.windowScroll,s=e.direction,o=e.isDropDisabled,a=e.isCombineEnabled,l=e.shouldClipSubject,c=i.closestScrollable,d=function(e,t){var n=rn(e);if(!t)return n;if(e!==t)return n;var i=n.paddingBox.top-t.scrollTop,r=n.paddingBox.left-t.scrollLeft,s=i+t.scrollHeight,o=r+t.scrollWidth,a=$t({top:i,right:o,bottom:s,left:r},n.border);return Xt({borderBox:a,margin:n.margin,border:n.border,padding:n.padding})}(t,c),u=tn(d,r),m=function(){if(!c)return null;var e=rn(c),t={scrollHeight:c.scrollHeight,scrollWidth:c.scrollWidth};return{client:e,page:tn(e,r),scroll:Co(c),scrollSize:t,shouldClipSubject:l}}(),p=function(e){var t=e.descriptor,n=e.isEnabled,i=e.isCombineEnabled,r=e.isFixedOnPage,s=e.direction,o=e.client,a=e.page,l=e.closest,c=function(){if(!l)return null;var e=l.scrollSize,t=l.client,n=Vr({scrollHeight:e.scrollHeight,scrollWidth:e.scrollWidth,height:t.paddingBox.height,width:t.paddingBox.width});return{pageMarginBox:l.page.marginBox,frameClient:t,scrollSize:e,shouldClipSubject:l.shouldClipSubject,scroll:{initial:l.scroll,current:l.scroll,max:n,diff:{value:An,displacement:An}}}}(),d="vertical"===s?ii:ri;return{descriptor:t,isCombineEnabled:i,isFixedOnPage:r,axis:d,isEnabled:n,client:o,page:a,frame:c,subject:Ln({page:a,withPlaceholder:null,axis:d,frame:c})}}({descriptor:n,isEnabled:!o,isCombineEnabled:a,isFixedOnPage:i.isFixedOnPage,direction:s,client:d,page:u,closest:m});return p},Io={passive:!1},To={passive:!0},Po=function(e){return e.shouldPublishImmediately?Io:To};function No(e){var t=(0,s.useContext)(e);return t||hn(!1),t}var Do=function(e){return e&&e.env.closestScrollable||null};function Mo(){}var Oo={width:0,height:0,margin:{top:0,right:0,bottom:0,left:0}},Lo=function(e){var t=e.isAnimatingOpenOnMount,n=e.placeholder,i=e.animate,r=function(e){var t=e.isAnimatingOpenOnMount,n=e.placeholder,i=e.animate;return t||"close"===i?Oo:{height:n.client.borderBox.height,width:n.client.borderBox.width,margin:n.client.margin}}({isAnimatingOpenOnMount:t,placeholder:n,animate:i});return{display:n.display,boxSizing:"border-box",width:r.width,height:r.height,marginTop:r.margin.top,marginRight:r.margin.right,marginBottom:r.margin.bottom,marginLeft:r.margin.left,flexShrink:"0",flexGrow:"0",pointerEvents:"none",transition:"none"!==i?yr.placeholder:null}};var Fo=s.memo((function(e){var t=(0,s.useRef)(null),n=Kt((function(){t.current&&(clearTimeout(t.current),t.current=null)}),[]),i=e.animate,r=e.onTransitionEnd,o=e.onClose,a=e.contextId,l=(0,s.useState)("open"===e.animate),c=l[0],d=l[1];(0,s.useEffect)((function(){return c?"open"!==i?(n(),d(!1),Mo):t.current?Mo:(t.current=setTimeout((function(){t.current=null,d(!1)})),n):Mo}),[i,c,n]);var u=Kt((function(e){"height"===e.propertyName&&(r(),"close"===i&&o())}),[i,o,r]),m=Lo({isAnimatingOpenOnMount:c,animate:e.animate,placeholder:e.placeholder});return s.createElement(e.placeholder.tagName,{style:m,"data-rbd-placeholder-context-id":a,onTransitionEnd:u,ref:e.innerRef})})),Uo=s.createContext(null);var Bo=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).state={isVisible:Boolean(t.props.on),data:t.props.on,animate:t.props.shouldAnimate&&t.props.on?"open":"none"},t.onClose=function(){"close"===t.state.animate&&t.setState({isVisible:!1})},t}return(0,Ge.A)(t,e),t.getDerivedStateFromProps=function(e,t){return e.shouldAnimate?e.on?{isVisible:!0,data:e.on,animate:"open"}:t.isVisible?{isVisible:!0,data:t.data,animate:"close"}:{isVisible:!1,animate:"close",data:null}:{isVisible:Boolean(e.on),data:e.on,animate:"none"}},t.prototype.render=function(){if(!this.state.isVisible)return null;var e={onClose:this.onClose,data:this.state.data,animate:this.state.animate};return this.props.children(e)},t}(s.PureComponent),Vo=5e3,jo=4500,zo=function(e,t){return t?yr.drop(t.duration):e?yr.snap:yr.fluid},Wo=function(e,t){return e?t?vr.drop:vr.combining:null};function Ho(e){return"DRAGGING"===e.type?function(e){var t=e.dimension.client,n=e.offset,i=e.combineWith,r=e.dropping,s=Boolean(i),o=function(e){return null!=e.forceShouldAnimate?e.forceShouldAnimate:"SNAP"===e.mode}(e),a=Boolean(r),l=a?wr(n,s):Er(n);return{position:"fixed",top:t.marginBox.top,left:t.marginBox.left,boxSizing:"border-box",width:t.borderBox.width,height:t.borderBox.height,transition:zo(o,r),transform:l,opacity:Wo(s,a),zIndex:a?jo:Vo,pointerEvents:"none"}}(e):{transform:Er((t=e).offset),transition:t.shouldAnimateDisplacement?null:"none"};var t}function Go(e){var t=Fs("draggable"),n=e.descriptor,i=e.registry,r=e.getDraggableRef,o=e.canDragInteractiveElements,a=e.shouldRespectForcePress,l=e.isEnabled,c=Gt((function(){return{canDragInteractiveElements:o,shouldRespectForcePress:a,isEnabled:l}}),[o,l,a]),d=Kt((function(e){var t=r();return t||hn(!1),function(e,t,n){void 0===n&&(n=An);var i=window.getComputedStyle(t),r=t.getBoundingClientRect(),s=nn(r,i),o=tn(s,n);return{descriptor:e,placeholder:{client:s,tagName:t.tagName.toLowerCase(),display:i.display},displaceBy:{x:s.marginBox.width,y:s.marginBox.height},client:s,page:o}}(n,t,e)}),[n,r]),u=Gt((function(){return{uniqueId:t,descriptor:n,options:c,getDimension:d}}),[n,d,c,t]),m=(0,s.useRef)(u),p=(0,s.useRef)(!0);As((function(){return i.draggable.register(m.current),function(){return i.draggable.unregister(m.current)}}),[i.draggable]),As((function(){if(p.current)p.current=!1;else{var e=m.current;m.current=u,i.draggable.update(u,e)}}),[u,i.draggable])}function Ko(e,t,n){Vs()}function Jo(e){e.preventDefault()}var qo=function(e,t){return e===t},$o=function(e){var t=e.combine,n=e.destination;return n?n.droppableId:t?t.droppableId:null};function Yo(e){return{isDragging:!1,isDropAnimating:!1,isClone:!1,dropAnimation:null,mode:null,draggingOver:null,combineTargetFor:e,combineWith:null}}var Zo={mapped:{type:"SECONDARY",offset:An,combineTargetFor:null,shouldAnimateDisplacement:!0,snapshot:Yo(null)}};var Xo=jt((function(){var e,t,n,i=(e=an((function(e,t){return{x:e,y:t}})),t=an((function(e,t,n,i,r){return{isDragging:!0,isClone:t,isDropAnimating:Boolean(r),dropAnimation:r,mode:e,draggingOver:n,combineWith:i,combineTargetFor:null}})),n=an((function(e,n,i,r,s,o,a){return{mapped:{type:"DRAGGING",dropping:null,draggingOver:s,combineWith:o,mode:n,offset:e,dimension:i,forceShouldAnimate:a,snapshot:t(n,r,s,o,null)}}})),function(i,r){if(i.isDragging){if(i.critical.draggable.id!==r.draggableId)return null;var s=i.current.client.offset,o=i.dimensions.draggables[r.draggableId],a=Di(i.impact),l=(d=i.impact).at&&"COMBINE"===d.at.type?d.at.combine.draggableId:null,c=i.forceShouldAnimate;return n(e(s.x,s.y),i.movementMode,o,r.isClone,a,l,c)}var d;if("DROP_ANIMATING"===i.phase){var u=i.completed;if(u.result.draggableId!==r.draggableId)return null;var m=r.isClone,p=i.dimensions.draggables[r.draggableId],h=u.result,g=h.mode,v=$o(h),f=function(e){return e.combine?e.combine.draggableId:null}(h),_={duration:i.dropDuration,curve:gr,moveTo:i.newHomeClientOffset,opacity:f?vr.drop:null,scale:f?fr.drop:null};return{mapped:{type:"DRAGGING",offset:i.newHomeClientOffset,dimension:p,dropping:_,draggingOver:v,combineWith:f,mode:g,forceShouldAnimate:null,snapshot:t(g,m,v,f,_)}}}return null}),r=function(){var e=an((function(e,t){return{x:e,y:t}})),t=an(Yo),n=an((function(e,n,i){return void 0===n&&(n=null),{mapped:{type:"SECONDARY",offset:e,combineTargetFor:n,shouldAnimateDisplacement:i,snapshot:t(n)}}})),i=function(e){return e?n(An,e,!0):null},r=function(t,r,s,o){var a=s.displaced.visible[t],l=Boolean(o.inVirtualList&&o.effected[t]),c=qn(s),d=c&&c.draggableId===t?r:null;if(!a){if(!l)return i(d);if(s.displaced.invisible[t])return null;var u=Rn(o.displacedBy.point),m=e(u.x,u.y);return n(m,d,!0)}if(l)return i(d);var p=s.displacedBy.point,h=e(p.x,p.y);return n(h,d,a.shouldAnimate)};return function(e,t){if(e.isDragging)return e.critical.draggable.id===t.draggableId?null:r(t.draggableId,e.critical.draggable.id,e.impact,e.afterCritical);if("DROP_ANIMATING"===e.phase){var n=e.completed;return n.result.draggableId===t.draggableId?null:r(t.draggableId,n.result.draggableId,n.impact,n.afterCritical)}return null}}();return function(e,t){return i(e,t)||r(e,t)||Zo}}),{dropAnimationFinished:hr},null,{context:Ns,pure:!0,areStatePropsEqual:qo})((function(e){var t=(0,s.useRef)(null),n=Kt((function(e){t.current=e}),[]),i=Kt((function(){return t.current}),[]),r=No(Us),o=r.contextId,a=r.dragHandleUsageInstructionsId,l=r.registry,c=No(Uo),d=c.type,u=c.droppableId,m=Gt((function(){return{id:e.draggableId,index:e.index,type:d,droppableId:u}}),[e.draggableId,e.index,d,u]),p=e.children,h=e.draggableId,g=e.isEnabled,v=e.shouldRespectForcePress,f=e.canDragInteractiveElements,_=e.isClone,y=e.mapped,b=e.dropAnimationFinished;Ko(),Bs(),_||Go(Gt((function(){return{descriptor:m,registry:l,getDraggableRef:i,canDragInteractiveElements:f,shouldRespectForcePress:v,isEnabled:g}}),[m,l,i,f,v,g]));var E=Gt((function(){return g?{tabIndex:0,role:"button","aria-describedby":a,"data-rbd-drag-handle-draggable-id":h,"data-rbd-drag-handle-context-id":o,draggable:!1,onDragStart:Jo}:null}),[o,a,h,g]),w=Kt((function(e){"DRAGGING"===y.type&&y.dropping&&"transform"===e.propertyName&&b()}),[b,y]),S=Gt((function(){var e=Ho(y),t="DRAGGING"===y.type&&y.dropping?w:null;return{innerRef:n,draggableProps:{"data-rbd-draggable-context-id":o,"data-rbd-draggable-id":h,style:e,onTransitionEnd:t},dragHandleProps:E}}),[o,E,h,y,w,n]),A=Gt((function(){return{draggableId:m.id,type:m.type,source:{index:m.index,droppableId:m.droppableId}}}),[m.droppableId,m.id,m.index,m.type]);return p(S,y.snapshot,A)}));function Qo(e){return No(Uo).isUsingCloneFor!==e.draggableId||e.isClone?s.createElement(Xo,e):null}function ea(e){var t="boolean"!=typeof e.isDragDisabled||!e.isDragDisabled,n=Boolean(e.disableInteractiveElementBlocking),i=Boolean(e.shouldRespectForcePress);return s.createElement(Qo,(0,p.A)({},e,{isClone:!1,isEnabled:t,canDragInteractiveElements:n,shouldRespectForcePress:i}))}var ta=function(e,t){return e===t.droppable.type},na=function(e,t){return t.draggables[e.draggable.id]};var ia={mode:"standard",type:"DEFAULT",direction:"vertical",isDropDisabled:!1,isCombineEnabled:!1,ignoreContainerClipping:!1,renderClone:null,getContainerForClone:function(){return document.body||hn(!1),document.body}},ra=jt((function(){var e={placeholder:null,shouldAnimatePlaceholder:!0,snapshot:{isDraggingOver:!1,draggingOverWith:null,draggingFromThisWith:null,isUsingPlaceholder:!1},useClone:null},t=(0,p.A)({},e,{shouldAnimatePlaceholder:!1}),n=an((function(e){return{draggableId:e.id,type:e.type,source:{index:e.index,droppableId:e.droppableId}}})),i=an((function(i,r,s,o,a,l){var c=a.descriptor.id;if(a.descriptor.droppableId===i){var d=l?{render:l,dragging:n(a.descriptor)}:null,u={isDraggingOver:s,draggingOverWith:s?c:null,draggingFromThisWith:c,isUsingPlaceholder:!0};return{placeholder:a.placeholder,shouldAnimatePlaceholder:!1,snapshot:u,useClone:d}}if(!r)return t;if(!o)return e;var m={isDraggingOver:s,draggingOverWith:c,draggingFromThisWith:null,isUsingPlaceholder:!0};return{placeholder:a.placeholder,shouldAnimatePlaceholder:!0,snapshot:m,useClone:null}}));return function(n,r){var s=r.droppableId,o=r.type,a=!r.isDropDisabled,l=r.renderClone;if(n.isDragging){var c=n.critical;if(!ta(o,c))return t;var d=na(c,n.dimensions),u=Di(n.impact)===s;return i(s,a,u,u,d,l)}if("DROP_ANIMATING"===n.phase){var m=n.completed;if(!ta(o,m.critical))return t;var p=na(m.critical,n.dimensions);return i(s,a,$o(m.result)===s,Di(m.impact)===s,p,l)}if("IDLE"===n.phase&&n.completed&&!n.shouldFlush){var h=n.completed;if(!ta(o,h.critical))return t;var g=Di(h.impact)===s,v=Boolean(h.impact.at&&"COMBINE"===h.impact.at.type),f=h.critical.droppable.id===s;return g?v?e:t:f?e:t}return t}}),{updateViewportMaxScroll:function(e){return{type:"UPDATE_VIEWPORT_MAX_SCROLL",payload:e}}},null,{context:Ns,pure:!0,areStatePropsEqual:qo})((function(e){var t=(0,s.useContext)(Us);t||hn(!1);var n=t.contextId,i=t.isMovementAllowed,r=(0,s.useRef)(null),o=(0,s.useRef)(null),a=e.children,l=e.droppableId,c=e.type,d=e.mode,u=e.direction,m=e.ignoreContainerClipping,p=e.isDropDisabled,h=e.isCombineEnabled,g=e.snapshot,v=e.useClone,f=e.updateViewportMaxScroll,_=e.getContainerForClone,y=Kt((function(){return r.current}),[]),b=Kt((function(e){r.current=e}),[]),E=(Kt((function(){return o.current}),[]),Kt((function(e){o.current=e}),[]));Vs();var w=Kt((function(){i()&&f({maxScroll:zr()})}),[i,f]);!function(e){var t=(0,s.useRef)(null),n=No(Us),i=Fs("droppable"),r=n.registry,o=n.marshal,a=zs(e),l=Gt((function(){return{id:e.droppableId,type:e.type,mode:e.mode}}),[e.droppableId,e.mode,e.type]),c=(0,s.useRef)(l),d=Gt((function(){return an((function(e,n){t.current||hn(!1);var i={x:e,y:n};o.updateDroppableScroll(l.id,i)}))}),[l.id,o]),u=Kt((function(){var e=t.current;return e&&e.env.closestScrollable?Co(e.env.closestScrollable):An}),[]),m=Kt((function(){var e=u();d(e.x,e.y)}),[u,d]),p=Gt((function(){return ln(m)}),[m]),h=Kt((function(){var e=t.current,n=Do(e);e&&n||hn(!1),e.scrollOptions.shouldPublishImmediately?m():p()}),[p,m]),g=Kt((function(e,i){t.current&&hn(!1);var r=a.current,s=r.getDroppableRef();s||hn(!1);var o=ko(s),c={ref:s,descriptor:l,env:o,scrollOptions:i};t.current=c;var d=Ro({ref:s,descriptor:l,env:o,windowScroll:e,direction:r.direction,isDropDisabled:r.isDropDisabled,isCombineEnabled:r.isCombineEnabled,shouldClipSubject:!r.ignoreContainerClipping}),u=o.closestScrollable;return u&&(u.setAttribute(ws.contextId,n.contextId),u.addEventListener("scroll",h,Po(c.scrollOptions))),d}),[n.contextId,l,h,a]),v=Kt((function(){var e=t.current,n=Do(e);return e&&n||hn(!1),Co(n)}),[]),f=Kt((function(){var e=t.current;e||hn(!1);var n=Do(e);t.current=null,n&&(p.cancel(),n.removeAttribute(ws.contextId),n.removeEventListener("scroll",h,Po(e.scrollOptions)))}),[h,p]),_=Kt((function(e){var n=t.current;n||hn(!1);var i=Do(n);i||hn(!1),i.scrollTop+=e.y,i.scrollLeft+=e.x}),[]),y=Gt((function(){return{getDimensionAndWatchScroll:g,getScrollWhileDragging:v,dragStopped:f,scroll:_}}),[f,g,v,_]),b=Gt((function(){return{uniqueId:i,descriptor:l,callbacks:y}}),[y,l,i]);As((function(){return c.current=b.descriptor,r.droppable.register(b),function(){t.current&&f(),r.droppable.unregister(b)}}),[y,l,f,b,o,r.droppable]),As((function(){t.current&&o.updateDroppableIsEnabled(c.current.id,!e.isDropDisabled)}),[e.isDropDisabled,o]),As((function(){t.current&&o.updateDroppableIsCombineEnabled(c.current.id,e.isCombineEnabled)}),[e.isCombineEnabled,o])}({droppableId:l,type:c,mode:d,direction:u,isDropDisabled:p,isCombineEnabled:h,ignoreContainerClipping:m,getDroppableRef:y});var S=s.createElement(Bo,{on:e.placeholder,shouldAnimate:e.shouldAnimatePlaceholder},(function(e){var t=e.onClose,i=e.data,r=e.animate;return s.createElement(Fo,{placeholder:i,onClose:t,innerRef:E,animate:r,contextId:n,onTransitionEnd:w})})),A=Gt((function(){return{innerRef:b,placeholder:S,droppableProps:{"data-rbd-droppable-id":l,"data-rbd-droppable-context-id":n}}}),[n,l,S,b]),C=v?v.dragging.draggableId:null,x=Gt((function(){return{droppableId:l,type:c,isUsingCloneFor:C}}),[l,C,c]);return s.createElement(Uo.Provider,{value:x},a(A,g),function(){if(!v)return null;var e=v.dragging,t=v.render,n=s.createElement(Qo,{draggableId:e.draggableId,index:e.source.index,isClone:!0,isEnabled:!0,shouldRespectForcePress:!1,canDragInteractiveElements:!0},(function(n,i){return t(n,i,e)}));return Wt.createPortal(n,_())}())}));ra.defaultProps=ia;var sa=n("./src/components/views/spaces/SpaceCreateMenu.tsx"),oa=n("./node_modules/matrix-js-sdk/src/types.ts"),aa=n("./src/components/views/avatars/RoomAvatar.tsx");const la=(e,t)=>{let n="";if(t)for(const e of t.entries())n+=e+"/";return`mx_space_collapsed_${n+e}`};class ca{static get instance(){return ca.internalInstance||(ca.internalInstance=new ca),ca.internalInstance}setSpaceCollapsedState(e,t,n){localStorage.setItem(la(e,t),n.toString())}getSpaceCollapsedState(e,t,n){const i=localStorage.getItem(la(e,t));return i?"true"===i:n}}(0,h.A)(ca,"internalInstance",void 0);var da=n("./src/components/views/rooms/NotificationBadge.tsx"),ua=n("./src/accessibility/context_menu/ContextMenuTooltipButton.tsx"),ma=n("./src/stores/notifications/StaticNotificationState.ts"),pa=n("./src/stores/notifications/NotificationLevel.ts"),ha=n("./src/accessibility/RovingTabIndex.tsx");const ga=["space","spaceKey","className","selected","label","contextMenuTooltip","notificationState","size","isNarrow","children","innerRef","ContextMenuComponent"],va=["space","activeSpaces","isNested","isPanelCollapsed","onExpand","parents","innerRef","dragHandleProps"],fa=["tabIndex"],_a=e=>{var t;let{space:n,spaceKey:i,className:r,selected:o,label:a,contextMenuTooltip:l,notificationState:c,size:d,isNarrow:u,children:m,innerRef:h,ContextMenuComponent:g}=e,v=(0,Ve.A)(e,ga);const[f,_,y,b]=(0,Fe.EF)(h),[E,S,A]=(0,ha.A9)(_),C=S?0:-1,x=null!=i?i:null==n?void 0:n.roomId;let k,I,T=s.createElement("div",{className:"mx_SpaceButton_avatarPlaceholder"},s.createElement("div",{className:"mx_SpaceButton_icon"}));if(n&&(T=s.createElement(aa.A,{size:d,room:n,type:"square"})),x&&c){let e=(0,P._t)("a11y_jump_first_unread_room");(null==n?void 0:n.getMyMembership())===oa.O.Invite&&(e=(0,P._t)("a11y|jump_first_invite"));const t=e=>{e.stopPropagation(),e.preventDefault(),xe.Ay.instance.setActiveRoomInSpace(x)};k=s.createElement("div",{className:"mx_SpacePanel_badgeContainer"},s.createElement(da.A,{onClick:t,notification:c,"aria-label":e,tabIndex:C,showUnsentTooltip:!0}))}f&&_.current&&g&&(I=s.createElement(g,(0,p.A)({},(0,Fe.Dq)(_.current.getBoundingClientRect(),0),{space:n,onFinished:b})));const N=null!==(t=v.onClick)&&void 0!==t?t:o&&n?()=>w.A.dispatch({action:R.r.ViewRoom,room_id:n.roomId}):()=>{x&&xe.Ay.instance.setActiveSpace(x)};return s.createElement(Ae.A,(0,p.A)({},v,{className:re()("mx_SpaceButton",r,{mx_SpaceButton_active:o,mx_SpaceButton_hasMenuOpen:f,mx_SpaceButton_narrow:u}),"aria-label":a,title:!u||f?void 0:a,onClick:N,onContextMenu:y,ref:A,tabIndex:C,onFocus:E}),m,s.createElement("div",{className:"mx_SpaceButton_selectionWrapper"},s.createElement("div",{className:"mx_SpaceButton_avatarWrapper"},T,k),!u&&s.createElement("span",{className:"mx_SpaceButton_name"},a),g&&s.createElement(ua.o,{className:"mx_SpaceButton_menuButton",onClick:y,title:l,isExpanded:f}),I))};class ya extends s.PureComponent{constructor(e){super(e),(0,h.A)(this,"buttonRef",(0,s.createRef)()),(0,h.A)(this,"onSpaceUpdate",(()=>{this.setState({childSpaces:this.childSpaces})})),(0,h.A)(this,"onRoomNameChange",(()=>{this.setState({name:this.props.space.name})})),(0,h.A)(this,"toggleCollapse",(e=>{this.props.onExpand&&this.isCollapsed&&this.props.onExpand();const t=!this.isCollapsed;ca.instance.setSpaceCollapsedState(this.props.space.roomId,this.props.parents,t),this.setState({collapsed:t}),e.stopPropagation()})),(0,h.A)(this,"onKeyDown",(e=>{var t;let n=!0;const i=(0,Re.zM)().getRoomListAction(e),r=null===(t=this.state.childSpaces)||void 0===t?void 0:t.length;switch(i){case Se.bY.CollapseRoomListSection:if(r&&!this.isCollapsed)this.toggleCollapse(e);else{var s;const e=null===(s=this.buttonRef)||void 0===s||null===(s=s.current)||void 0===s||null===(s=s.parentElement)||void 0===s?void 0:s.parentElement,t=null==e?void 0:e.previousElementSibling;null==t||t.focus()}break;case Se.bY.ExpandRoomListSection:if(r)if(this.isCollapsed)this.toggleCollapse(e);else{var o,a;const e=null===(o=this.buttonRef)||void 0===o||null===(o=o.current)||void 0===o?void 0:o.nextElementSibling,t=null==e?void 0:e.querySelector(".mx_SpaceItem");null==t||null===(a=t.querySelector(".mx_SpaceButton"))||void 0===a||a.focus()}break;default:n=!1}n&&(e.stopPropagation(),e.preventDefault())}));const t=ca.instance.getSpaceCollapsedState(e.space.roomId,this.props.parents,!e.isNested);this.state={name:this.props.space.name,collapsed:t,childSpaces:this.childSpaces}}componentDidMount(){xe.Ay.instance.on(this.props.space.roomId,this.onSpaceUpdate),this.props.space.on(i.RoomEvent.Name,this.onRoomNameChange)}componentWillUnmount(){xe.Ay.instance.off(this.props.space.roomId,this.onSpaceUpdate),this.props.space.off(i.RoomEvent.Name,this.onRoomNameChange)}get childSpaces(){return xe.Ay.instance.getChildSpaces(this.props.space.roomId).filter((e=>{var t;return!(null!==(t=this.props.parents)&&void 0!==t&&t.has(e.roomId))}))}get isCollapsed(){return this.state.collapsed||!!this.props.isPanelCollapsed}render(){var e,t;const n=this.props,{space:i,activeSpaces:r,isNested:o,isPanelCollapsed:a,onExpand:l,parents:c,innerRef:d,dragHandleProps:u}=n,m=(0,Ve.A)(n,va),h=this.isCollapsed,g=re()(this.props.className,{mx_SpaceItem:!0,mx_SpaceItem_narrow:a,collapsed:h,hasSubSpaces:null===(e=this.state.childSpaces)||void 0===e?void 0:e.length}),v=i.getMyMembership()===oa.O.Invite,f=v?ma.d.forSymbol("!",pa.S.Highlight):xe.Ay.instance.getNotificationState(i.roomId),_=null===(t=this.state.childSpaces)||void 0===t?void 0:t.length;let y;_&&!h&&(y=s.createElement(ba,{spaces:this.state.childSpaces,activeSpaces:r,isNested:!0,parents:new Set(c).add(i.roomId)}));const b=_?s.createElement(Ae.A,{className:"mx_SpaceButton_toggleCollapse",onClick:this.toggleCollapse,tabIndex:-1,"aria-label":h?(0,P._t)("action|expand"):(0,P._t)("action|collapse")}):null,E=u||{},{tabIndex:w}=E,S=(0,Ve.A)(E,fa),A=r.includes(i.roomId);return s.createElement("li",(0,p.A)({},m,{className:g,ref:d,"aria-expanded":_?!h:void 0,"aria-selected":A,role:"treeitem"}),s.createElement(_a,(0,p.A)({},S,{space:i,className:v?"mx_SpaceButton_invite":void 0,selected:A,label:this.state.name,contextMenuTooltip:(0,P._t)("space|context_menu|options"),notificationState:f,isNarrow:a,size:o?"24px":"32px",onKeyDown:this.onKeyDown,ContextMenuComponent:this.props.space.getMyMembership()===oa.O.Join?We:void 0}),b),y)}}const ba=({spaces:e,activeSpaces:t,isNested:n,parents:i})=>s.createElement("ul",{className:"mx_SpaceTreeLevel",role:"group"},e.map((e=>s.createElement(ya,{key:e.roomId,activeSpaces:t,space:e,isNested:n,parents:i}))));var Ea=n("./src/stores/notifications/RoomNotificationStateStore.ts"),wa=n("./src/components/views/dialogs/UserTab.ts"),Sa=n("./src/components/views/elements/Field.tsx"),Aa=n("./src/components/views/dialogs/BugReportDialog.tsx"),Ca=n("./src/components/views/dialogs/InfoDialog.tsx"),xa=n("./src/hooks/useStateToggle.ts"),ka=n("./src/components/views/elements/StyledCheckbox.tsx"),Ra=n("./src/components/views/elements/ExternalLink.tsx");const Ia=e=>{const t=(0,s.useRef)(null),[n,i]=(0,s.useState)(""),[r,o]=(0,xa.X)(!1);(0,s.useEffect)((()=>{var e;null===(e=t.current)||void 0===e||e.focus()}),[]);const a=()=>{e.onFinished(),A.Ay.createDialog(Aa.A,{})},l=!!u.Ay.get().bug_report_endpoint_url;let c,d;l&&(c=s.createElement("div",{className:"mx_FeedbackDialog_section mx_FeedbackDialog_rateApp"},s.createElement("h3",null,(0,P._t)("feedback|comment_label")),s.createElement("p",null,(0,P._t)("feedback|platform_username")),s.createElement(Sa.A,{id:"feedbackComment",label:(0,P._t)("common|feedback"),type:"text",autoComplete:"off",value:n,element:"textarea",onChange:e=>{i(e.target.value)},ref:t}),s.createElement(ka.A,{checked:r,onChange:o},(0,P._t)("feedback|may_contact_label")))),l&&(d=s.createElement("p",{className:"mx_FeedbackDialog_section_microcopy"},(0,P._t)("feedback|pro_type",{},{debugLogsLink:e=>s.createElement(Ae.A,{kind:"link_inline",onClick:a},e)})));const m=u.Ay.getObject("feedback").get("existing_issues_url"),p=u.Ay.getObject("feedback").get("new_issue_url");return s.createElement(q.A,{className:"mx_FeedbackDialog",hasCancelButton:l,title:(0,P._t)("common|feedback"),description:s.createElement(s.Fragment,null,s.createElement("div",{className:"mx_FeedbackDialog_section mx_FeedbackDialog_reportBug"},s.createElement("h3",null,(0,P._t)("common|report_a_bug")),s.createElement("p",null,(0,P._t)("feedback|existing_issue_link",{},{existingIssuesLink:e=>s.createElement(Ra.A,{target:"_blank",rel:"noreferrer noopener",href:m},e),newIssueLink:e=>s.createElement(Ra.A,{target:"_blank",rel:"noreferrer noopener",href:p},e)})),d),c),button:l?(0,P._t)("feedback|send_feedback_action"):(0,P._t)("action|go_back"),buttonDisabled:l&&!n,onFinished:t=>{if(l&&t){const t=e.feature?`${e.feature}-feedback`:"feedback";(0,U.Wz)(t,n,r),A.Ay.createDialog(Ca.A,{title:(0,P._t)("feedback|sent"),description:(0,P._t)("bug_reporting|thank_you")})}e.onFinished()}})};var Ta=n("./src/components/views/dialogs/security/RestoreKeyBackupDialog.tsx"),Pa=n("./src/components/views/dialogs/BaseDialog.tsx"),Na=n("./src/components/views/elements/Spinner.tsx"),Da=n("./src/components/views/elements/DialogButtons.tsx"),Ma=function(e){return e[e.LOADING=0]="LOADING",e[e.NO_CRYPTO=1]="NO_CRYPTO",e[e.BACKUP_ACTIVE=2]="BACKUP_ACTIVE",e[e.SERVER_BACKUP_BUT_DISABLED=3]="SERVER_BACKUP_BUT_DISABLED",e[e.NO_BACKUP=4]="NO_BACKUP",e[e.ERROR=5]="ERROR",e}(Ma||{});async function Oa(e){const t=null==e?void 0:e.getCrypto();if(!t)return!1;const n=e.getRooms();for(const e of n){if(await t.isEncryptionEnabledInRoom(e.roomId))return!0}return!1}class La extends s.Component{constructor(e){super(e),(0,h.A)(this,"onExportE2eKeysClicked",(()=>{A.Ay.createDialog((0,s.lazy)((()=>n.e(7692).then(n.bind(n,"./src/async-components/views/dialogs/security/ExportE2eKeysDialog.tsx")))),{matrixClient:E.J.safeGet()})})),(0,h.A)(this,"onFinished",(e=>{e&&w.A.dispatch({action:"logout"}),this.props.onFinished(!!e)})),(0,h.A)(this,"onSetRecoveryMethodClick",(()=>{this.state.backupStatus===Ma.SERVER_BACKUP_BUT_DISABLED?A.Ay.createDialog(Ta.A,void 0,void 0,!1,!0):A.Ay.createDialog((0,s.lazy)((()=>n.e(9123).then(n.bind(n,"./src/async-components/views/dialogs/security/CreateKeyBackupDialog.tsx")))),void 0,void 0,!1,!0),this.props.onFinished(!0)})),(0,h.A)(this,"onLogoutConfirm",(()=>{w.A.dispatch({action:"logout"}),this.props.onFinished(!0)})),this.state={backupStatus:Ma.LOADING}}componentDidMount(){this.startLoadBackupStatus()}startLoadBackupStatus(){this.loadBackupStatus().catch((e=>{o.v.log("Unable to fetch key backup status",e),this.setState({backupStatus:Ma.ERROR})}))}async loadBackupStatus(){const e=E.J.safeGet().getCrypto();if(!e)return void this.setState({backupStatus:Ma.NO_CRYPTO});if(null!==await e.getActiveSessionBackupVersion())return void this.setState({backupStatus:Ma.BACKUP_ACTIVE});const t=await e.getKeyBackupInfo();this.setState({backupStatus:t?Ma.SERVER_BACKUP_BUT_DISABLED:Ma.NO_BACKUP})}renderSetupBackupDialog(){const e=s.createElement("div",null,s.createElement("p",null,(0,P._t)("auth|logout_dialog|setup_secure_backup_description_1")),s.createElement("p",null,(0,P._t)("auth|logout_dialog|setup_secure_backup_description_2")),s.createElement("p",null,(0,P._t)("encryption|setup_secure_backup|explainer")));let t;t=this.state.backupStatus===Ma.SERVER_BACKUP_BUT_DISABLED?(0,P._t)("settings|security|key_backup_connect"):(0,P._t)("auth|logout_dialog|use_key_backup");const n=s.createElement("div",null,s.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},e),s.createElement(Da.A,{primaryButton:t,hasCancel:!1,onPrimaryButtonClick:this.onSetRecoveryMethodClick,focus:!0},s.createElement("button",{onClick:this.onLogoutConfirm},(0,P._t)("auth|logout_dialog|skip_key_backup"))),s.createElement("details",null,s.createElement("summary",{className:"mx_LogoutDialog_ExportKeyAdvanced"},(0,P._t)("common|advanced")),s.createElement("p",null,s.createElement("button",{onClick:this.onExportE2eKeysClicked},(0,P._t)("auth|logout_dialog|megolm_export")))));return s.createElement(Pa.A,{title:(0,P._t)("auth|logout_dialog|setup_key_backup_title"),contentId:"mx_Dialog_content",hasCancel:!0,onFinished:this.onFinished},n)}render(){switch(this.state.backupStatus){case Ma.LOADING:return s.createElement(Pa.A,{title:(0,P._t)("action|sign_out"),contentId:"mx_Dialog_content",hasCancel:!0,onFinished:this.onFinished},s.createElement(Na.A,null));case Ma.NO_CRYPTO:case Ma.BACKUP_ACTIVE:return s.createElement(q.A,{hasCancelButton:!0,title:(0,P._t)("action|sign_out"),description:(0,P._t)("auth|logout_dialog|description"),button:(0,P._t)("action|sign_out"),onFinished:this.onFinished});case Ma.NO_BACKUP:case Ma.SERVER_BACKUP_BUT_DISABLED:case Ma.ERROR:return this.renderSetupBackupDialog()}}}(0,h.A)(La,"defaultProps",{onFinished:function(){}});var Fa=n("./src/theme.ts"),Ua=n("./src/utils/WellKnownUtils.ts");function Ba(e,t){const n=new m.Q(e).get("embedded_pages");let i=n?new m.Q(n).get("home_url"):null;var r;(i||(i=e.welcomePageUrl,i&&o.v.warn("You are using a deprecated config option: `welcomePageUrl`. Please use `embedded_pages.home_url` instead, per https://github.com/vector-im/element-web/issues/21428")),i)||(i=null===(r=(0,Ua.qh)(t))||void 0===r?void 0:r.home_url);return i}var Va=n("./src/stores/OwnProfileStore.ts"),ja=n("./src/components/views/avatars/BaseAvatar.tsx"),za=n("./src/customisations/UserIdentifier.ts"),Wa=n("./src/contexts/SDKContext.ts"),Ha=n("./src/utils/Feedback.ts");class Ga extends s.Component{constructor(e,t){super(e,t),(0,h.A)(this,"dispatcherRef",void 0),(0,h.A)(this,"themeWatcherRef",void 0),(0,h.A)(this,"dndWatcherRef",void 0),(0,h.A)(this,"buttonRef",(0,s.createRef)()),(0,h.A)(this,"onProfileUpdate",(async()=>{this.forceUpdate()})),(0,h.A)(this,"onSelectedSpaceUpdate",(async()=>{this.setState({selectedSpace:xe.Ay.instance.activeSpaceRoom})})),(0,h.A)(this,"onThemeChanged",(()=>{this.setState({isDarkTheme:this.isUserOnDarkTheme(),isHighContrast:this.isUserOnHighContrastTheme()})})),(0,h.A)(this,"onAction",(e=>{if(e.action===R.r.ToggleUserMenu)this.state.contextMenuPosition?this.setState({contextMenuPosition:null}):this.buttonRef.current&&this.buttonRef.current.click()})),(0,h.A)(this,"onOpenMenuClick",(e=>{e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:e.currentTarget.getBoundingClientRect()})})),(0,h.A)(this,"onContextMenu",(e=>{e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:{left:e.clientX,top:e.clientY,width:20,height:0}})})),(0,h.A)(this,"onCloseMenu",(()=>{this.setState({contextMenuPosition:null})})),(0,h.A)(this,"onSwitchThemeClick",(e=>{e.preventDefault(),e.stopPropagation(),y.A.trackInteraction("WebUserMenuThemeToggleButton",e),V.A.setValue("use_system_theme",null,ae.p.DEVICE,!1);let t=this.state.isDarkTheme?"light":"dark";if(this.state.isHighContrast){const e=(0,Fa.TJ)(t);e&&(t=e)}V.A.setValue("theme",null,ae.p.DEVICE,t)})),(0,h.A)(this,"onSettingsOpen",((e,t,n)=>{e.preventDefault(),e.stopPropagation();const i={action:R.r.ViewUserSettings,initialTabId:t,props:n};w.A.dispatch(i),this.setState({contextMenuPosition:null})})),(0,h.A)(this,"onOpenFAQPage",(()=>{window.open("https://www.tchap.gouv.fr/faq","_blank")})),(0,h.A)(this,"onProvideFeedback",(e=>{e.preventDefault(),e.stopPropagation(),A.Ay.createDialog(Ia),this.setState({contextMenuPosition:null})})),(0,h.A)(this,"onSignOutClick",(async e=>{e.preventDefault(),e.stopPropagation(),await Oa(E.J.safeGet())?A.Ay.createDialog(La):w.A.dispatch({action:"logout"}),this.setState({contextMenuPosition:null})})),(0,h.A)(this,"onSignInClick",(()=>{w.A.dispatch({action:"start_login"}),this.setState({contextMenuPosition:null})})),(0,h.A)(this,"onRegisterClick",(()=>{w.A.dispatch({action:"start_registration"}),this.setState({contextMenuPosition:null})})),(0,h.A)(this,"onHomeClick",(e=>{e.preventDefault(),e.stopPropagation(),w.A.dispatch({action:R.r.ViewHomePage}),this.setState({contextMenuPosition:null})})),(0,h.A)(this,"renderContextMenu",(()=>{if(!this.state.contextMenuPosition)return null;let e,t,n;E.J.safeGet().isGuest()&&(e=s.createElement("div",{className:"mx_UserMenu_contextMenu_header mx_UserMenu_contextMenu_guestPrompts"},(0,P._t)("auth|sign_in_prompt",{},{a:e=>s.createElement(Ae.A,{kind:"link_inline",onClick:this.onSignInClick},e)}),V.A.getValue($.f.Registration)?(0,P._t)("auth|create_account_prompt",{},{a:e=>s.createElement(Ae.A,{kind:"link_inline",onClick:this.onRegisterClick},e)}):null)),this.hasHomePage&&(t=s.createElement(Be.R$,{iconClassName:"mx_UserMenu_iconHome",label:(0,P._t)("common|home"),onClick:this.onHomeClick})),(0,Ha.I)()&&(n=s.createElement(Be.R$,{iconClassName:"mx_UserMenu_iconMessage",label:(0,P._t)("common|feedback"),onClick:this.onProvideFeedback}));Be.R$,(0,P._t)("user_menu|link_new_device");let i=s.createElement(Be.tx,null,t,s.createElement(Be.R$,{iconClassName:"mx_UserMenu_iconBell",label:(0,P._t)("notifications|enable_prompt_toast_title"),onClick:e=>this.onSettingsOpen(e,wa.v.Notifications)}),s.createElement(Be.R$,{iconClassName:"mx_UserMenu_iconLock",label:(0,P._t)("room_settings|security|title"),onClick:e=>this.onSettingsOpen(e,wa.v.Security)}),s.createElement(Be.R$,{iconClassName:"mx_UserMenu_iconSettings",label:(0,P._t)("user_menu|settings"),onClick:e=>this.onSettingsOpen(e)}),n,s.createElement(Be.R$,{iconClassName:"mx_UserMenu_iconInfo",label:(0,P._t)("common|help"),onClick:this.onOpenFAQPage}),s.createElement(Be.R$,{className:"mx_IconizedContextMenu_option_red",iconClassName:"mx_UserMenu_iconSignOut",label:(0,P._t)("action|sign_out"),onClick:this.onSignOutClick}));E.J.safeGet().isGuest()&&(i=s.createElement(Be.tx,null,t,s.createElement(Be.R$,{iconClassName:"mx_UserMenu_iconSettings",label:(0,P._t)("common|settings"),onClick:e=>this.onSettingsOpen(e)}),n));const r=this.props.isPanelCollapsed?{left:(o=this.state.contextMenuPosition).width+o.left+8,top:o.top,chevronFace:Fe.t4.None}:(e=>({left:e.left,top:e.top+e.height,chevronFace:Fe.t4.None}))(this.state.contextMenuPosition);var o;return s.createElement(Be.Ay,(0,p.A)({},r,{onFinished:this.onCloseMenu,className:"mx_UserMenu_contextMenu"}),s.createElement("div",{className:"mx_UserMenu_contextMenu_header"},s.createElement("div",{className:"mx_UserMenu_contextMenu_name"},s.createElement("span",{className:"mx_UserMenu_contextMenu_displayName"},Va.V.instance.displayName),s.createElement("span",{className:"mx_UserMenu_contextMenu_userId"},za.A.getDisplayUserIdentifier(E.J.safeGet().getSafeUserId(),{withDisplayName:!0}))),s.createElement(ha.k,{className:"mx_UserMenu_contextMenu_themeButton",onClick:this.onSwitchThemeClick,title:this.state.isDarkTheme?(0,P._t)("user_menu|switch_theme_light"):(0,P._t)("user_menu|switch_theme_dark")},s.createElement("img",{src:"img/element-icons/roomlist/dark-light-mode.328ce0f.svg",role:"presentation",alt:"",width:16}))),e,i)})),this.state={contextMenuPosition:null,isDarkTheme:this.isUserOnDarkTheme(),isHighContrast:this.isUserOnHighContrastTheme(),selectedSpace:xe.Ay.instance.activeSpaceRoom}}get hasHomePage(){return!!Ba(u.Ay.get(),this.context.client)}componentDidMount(){Va.V.instance.on(I.H,this.onProfileUpdate),xe.Ay.instance.on(ke.tw,this.onSelectedSpaceUpdate),this.dispatcherRef=w.A.register(this.onAction),this.themeWatcherRef=V.A.watchSetting("theme",null,this.onThemeChanged)}componentWillUnmount(){V.A.unwatchSetting(this.themeWatcherRef),V.A.unwatchSetting(this.dndWatcherRef),w.A.unregister(this.dispatcherRef),Va.V.instance.off(I.H,this.onProfileUpdate),xe.Ay.instance.off(ke.tw,this.onSelectedSpaceUpdate)}isUserOnDarkTheme(){if(V.A.getValue("use_system_theme"))return window.matchMedia("(prefers-color-scheme: dark)").matches;{const e=V.A.getValue("theme");return e.startsWith("custom-")?!!(0,Fa.TP)(e.substring(7)).is_dark:"dark"===e}}isUserOnHighContrastTheme(){if(V.A.getValue("use_system_theme"))return window.matchMedia("(prefers-contrast: more)").matches;{const e=V.A.getValue("theme");return!e.startsWith("custom-")&&(0,Fa.AZ)(e)}}render(){const e=E.J.safeGet().getSafeUserId(),t=Va.V.instance.displayName||e,n=Va.V.instance.getHttpAvatarUrl(32);let i;return this.props.isPanelCollapsed||(i=s.createElement("div",{className:"mx_UserMenu_name"},t)),s.createElement("div",{className:"mx_UserMenu"},s.createElement(Fe.VJ,{className:"mx_UserMenu_contextMenuButton",onClick:this.onOpenMenuClick,ref:this.buttonRef,label:(0,P._t)("a11y|user_menu"),isExpanded:!!this.state.contextMenuPosition,onContextMenu:this.onContextMenu},s.createElement("div",{className:"mx_UserMenu_userAvatar"},s.createElement(ja.A,{idName:e,name:t,url:n,size:"32px",className:"mx_UserMenu_userAvatar_BaseAvatar"})),i,this.renderContextMenu()),this.props.children)}}(0,h.A)(Ga,"contextType",Wa.A);var Ka=n("./src/components/structures/AutoHideScrollbar.tsx");const Ja=["children","trackHorizontalOverflow","verticalScrollsHorizontally"];class qa extends s.Component{constructor(e){super(e),(0,h.A)(this,"autoHideScrollbar",(0,s.createRef)()),(0,h.A)(this,"scrollElement",void 0),(0,h.A)(this,"likelyTrackpadUser",null),(0,h.A)(this,"checkAgainForTrackpad",0),(0,h.A)(this,"collectScroller",(e=>{var t,n;null===(t=(n=this.props).wrappedRef)||void 0===t||t.call(n,e),e&&!this.scrollElement&&(this.scrollElement=e,this.scrollElement.addEventListener("scroll",this.checkOverflow,{passive:!0}),this.checkOverflow())})),(0,h.A)(this,"checkOverflow",(()=>{if(!this.scrollElement)return;const e=this.scrollElement.scrollTop>0,t=this.scrollElement.scrollHeight>this.scrollElement.scrollTop+this.scrollElement.clientHeight,n=this.scrollElement.scrollLeft>0,i=this.scrollElement.scrollWidth>this.scrollElement.scrollLeft+this.scrollElement.clientWidth;e?this.scrollElement.classList.add("mx_IndicatorScrollbar_topOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_topOverflow"),t?this.scrollElement.classList.add("mx_IndicatorScrollbar_bottomOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_bottomOverflow"),n?this.scrollElement.classList.add("mx_IndicatorScrollbar_leftOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_leftOverflow"),i?this.scrollElement.classList.add("mx_IndicatorScrollbar_rightOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_rightOverflow"),this.props.trackHorizontalOverflow&&this.setState({leftIndicatorOffset:n?`${this.scrollElement.scrollLeft}px`:"0",rightIndicatorOffset:i?`-${this.scrollElement.scrollLeft}px`:"0"})})),(0,h.A)(this,"onMouseWheel",(e=>{if(this.props.verticalScrollsHorizontally&&this.scrollElement){const t=0,n=1,i=(new Date).getTime();if(Math.abs(e.deltaX)>0?(this.likelyTrackpadUser=!0,this.checkAgainForTrackpad=i+6e4):this.likelyTrackpadUser&&i>=this.checkAgainForTrackpad&&(this.likelyTrackpadUser=!1),this.likelyTrackpadUser)return;if(Math.abs(e.deltaX)<=t){const t=e.deltaY<0?-50:50,i=Math.abs(e.deltaY)<25?e.deltaY+t:e.deltaY;this.scrollElement.scrollLeft+=i*n}}})),this.state={leftIndicatorOffset:"0",rightIndicatorOffset:"0"}}componentDidUpdate(e){s.Children.count(e.children)!==s.Children.count(this.props.children)&&this.checkOverflow()}componentDidMount(){this.checkOverflow(),Ie.A.instance.on(Ie.x.Resize,this.checkOverflow)}componentWillUnmount(){var e;null===(e=this.scrollElement)||void 0===e||e.removeEventListener("scroll",this.checkOverflow),Ie.A.instance.off(Ie.x.Resize,this.checkOverflow)}render(){const e=this.props,{children:t,trackHorizontalOverflow:n,verticalScrollsHorizontally:i}=e,r=(0,Ve.A)(e,Ja),o={left:this.state.leftIndicatorOffset},a={right:this.state.rightIndicatorOffset},l=n?s.createElement("div",{className:"mx_IndicatorScrollbar_leftOverflowIndicator",style:o}):null,c=n?s.createElement("div",{className:"mx_IndicatorScrollbar_rightOverflowIndicator",style:a}):null;return s.createElement(Ka.A,(0,p.A)({},r,{ref:this.autoHideScrollbar,wrappedRef:this.collectScroller,onWheel:this.onMouseWheel}),l,t,c)}}var $a=n("./node_modules/@vector-im/compound-web/dist/components/Menu/Menu.js"),Ya=n("./node_modules/@vector-im/compound-web/dist/components/Menu/MenuItem.js"),Za=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/threads-solid.js"),Xa=n("./node_modules/@vector-im/compound-web/dist/components/Button/IconButton/IconButton.js"),Qa=n("./node_modules/@vector-im/compound-web/dist/components/Typography/Text.js"),el=n("./src/utils/notifications.ts");const tl=["displayLabel","notificationLevel","disableTooltip"],nl=(0,s.forwardRef)((function(e,t){let{displayLabel:n,notificationLevel:i,disableTooltip:r}=e,o=(0,Ve.A)(e,tl);const a=!r&&!n&&void 0;return s.createElement(Te.m,{label:(0,P._t)("common|threads"),placement:"right",open:a},s.createElement(Xa.K,(0,p.A)({"aria-label":(0,P._t)("common|threads"),className:re()("mx_ThreadsActivityCentreButton",{expanded:n}),indicator:(0,el.W7)(i)},o,{ref:t}),s.createElement(s.Fragment,null,s.createElement(Za.A,{className:"mx_ThreadsActivityCentreButton_Icon"}),n&&s.createElement(Qa.E,{className:"mx_ThreadsActivityCentreButton_Text",as:"span",size:"md",title:(0,P._t)("common|threads")},(0,P._t)("common|threads")))))}));var il=n("./src/components/views/avatars/DecoratedRoomAvatar.tsx"),rl=n("./src/stores/right-panel/RightPanelStore.ts"),sl=n("./src/stores/right-panel/RightPanelStorePhases.ts"),ol=n("./src/Unread.ts"),al=n("./src/stores/room-list/filters/VisibilityProvider.ts");function ll(e){const t=(0,Oe.ti)("feature_dynamic_room_predecessors"),n=(0,Oe.ti)("Notifications.tac_only_notifications"),r=(0,Pe.nH)(),[o,a]=(0,s.useState)({greatestNotificationLevel:pa.S.None,rooms:[]}),l=(0,s.useCallback)((()=>{a(function(e,t,n){const i=e.getVisibleRooms(t);let r=pa.S.None;const s=[];for(const e of i)if(al.W.instance.isRoomVisible(e)&&(0,ol.Nb)(e)){const t=(0,el.gM)(e);if(n&&t<=pa.S.Activity)continue;t>r&&(r=t),s.push({room:e,notificationLevel:t})}const o=s.sort(((e,t)=>function(e,t){var n,i;const{notificationLevel:r,room:s}=e,{notificationLevel:o,room:a}=t,l=null===(n=s.getLastThread())||void 0===n||null===(n=n.events.at(-1))||void 0===n?void 0:n.getTs(),c=null===(i=a.getLastThread())||void 0===i||null===(i=i.events.at(-1))||void 0===i?void 0:i.getTs();return r>o?-1:o>r?1:l?c?c-l:-1:1}(e,t)));return{greatestNotificationLevel:r,rooms:o}}(r,t,n))}),[r,t,n]),c=(0,s.useCallback)((0,v.throttle)(l,500,{leading:!1,trailing:!0}),[l]);return(0,Me.ml)(r,i.ClientEvent.Sync,c),(0,Me.ml)(r,i.MatrixEventEvent.Decrypted,c),(0,s.useEffect)((()=>{e&&l()}),[l,e]),o}var cl=n("./src/components/views/rooms/NotificationBadge/StatelessNotificationBadge.tsx"),dl=n("./node_modules/react/jsx-runtime.js"),ul=n("./node_modules/@floating-ui/react/dist/floating-ui.react.mjs");const ml="_content_1oa1y_17",pl="_header_1oa1y_46",hl="_description_1oa1y_52",gl="_button_1oa1y_57",vl="_arrow_1oa1y_62",fl=(0,s.createContext)(null);function _l(){const e=(0,s.useContext)(fl);if(null==e)throw new Error("ReleaseAnnouncement components must be wrapped in <ReleaseAnnouncement />");return e}var yl=n("./node_modules/@floating-ui/dom/dist/floating-ui.dom.mjs"),bl=n("./node_modules/@floating-ui/react-dom/dist/floating-ui.react-dom.mjs");function El(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function wl(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?El(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):El(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Sl=n("./node_modules/@vector-im/compound-web/dist/components/Button/Button.js");const Al=["children","placement","displayArrow"],Cl=["context","arrowRef","displayArrow"];function xl(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function kl(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?xl(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):xl(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Rl(e){let{children:t,placement:n="right",displayArrow:i=!0}=e;const r=function({open:e,header:t,description:n,closeLabel:i,placement:r,onClick:o,displayArrow:a}){const l=(0,ul.Bi)(),c=(0,ul.Bi)(),d=(0,s.useRef)(null),u=(0,ul.we)({placement:r,open:e,whileElementsMounted:yl.ll,middleware:[(0,bl.cY)(16),(0,bl.BN)({limiter:(0,bl.ER)({offset:50})}),a&&(0,bl.UE)({element:d})]}),m=(0,ul.It)(u.context),p=(0,ul.bv)([m]);return(0,s.useMemo)((()=>wl(wl(wl({open:e},u),p),{},{labelId:l,descriptionId:c,header:t,description:n,closeLabel:i,onClick:o,displayArrow:a,arrowRef:d})),[e,m,p,u,l,c,t,n,i,o,a,d])}(kl({placement:n,displayArrow:i},(0,Ve.A)(e,Al)));return(0,dl.jsxs)(fl.Provider,{value:r,children:[(0,dl.jsx)(Il,{children:t}),(0,dl.jsx)(Tl,{children:(0,dl.jsx)(Pl,{})})]})}function Il({children:e}){const t=_l(),n=null==e?void 0:e.ref,i=(0,ul.SV)([t.refs.setReference,n]);if(!(0,s.isValidElement)(e))throw new Error("ReleaseAnnouncement anchor must be a single valid React element");return(0,s.cloneElement)(e,t.getReferenceProps(kl({ref:i},t.open&&{"aria-describedby":t.getFloatingProps().id})))}function Tl({children:e}){const t=_l(),{context:n,arrowRef:i,displayArrow:r}=t,s=(0,Ve.A)(t,Cl);return n.open?(0,dl.jsx)(ul.XF,{children:(0,dl.jsx)(ul.s3,{context:n,modal:!1,children:(0,dl.jsxs)("div",kl(kl({ref:s.refs.setFloating,style:s.floatingStyles,"aria-labelledby":s.labelId,"aria-describedby":s.descriptionId},s.getFloatingProps()),{},{className:ml,children:[r&&(0,dl.jsx)(ul.ie,{ref:i,context:n,width:20,height:12,className:vl}),e]}))})}):null}function Pl(){const{labelId:e,descriptionId:t,header:n,description:i,closeLabel:r,onClick:s}=_l();return(0,dl.jsxs)(dl.Fragment,{children:[(0,dl.jsx)(Qa.E,{as:"h3",id:e,className:pl,size:"lg",weight:"semibold",children:n}),(0,dl.jsx)(Qa.E,{as:"span",id:t,className:hl,size:"sm",weight:"regular",children:i}),(0,dl.jsx)(Sl.$,{size:"sm",kind:"secondary",className:gl,onClick:s,children:r})]})}var Nl=n("./src/settings/Settings.tsx");const Dl=["threadsActivityCentre","pinningMessageList"];class Ml extends i.TypedEventEmitter{static get instance(){return Ml.internalInstance||(Ml.internalInstance=new Ml),Ml.internalInstance}constructor(){super(),(0,h.A)(this,"index",0),V.A.watchSetting("releaseAnnouncementData",null,(()=>{this.emit("releaseAnnouncementChanged",this.getReleaseAnnouncement())}))}getViewedReleaseAnnouncements(){return(0,v.cloneDeep)(V.A.getValue("releaseAnnouncementData"))}isReleaseAnnouncementEnabled(){return V.A.getValue(Nl.O5.ReleaseAnnouncement)}getReleaseAnnouncement(){if(!this.isReleaseAnnouncementEnabled())return null;const e=this.getViewedReleaseAnnouncements();for(let t=this.index;t<Dl.length;t++)if(!e[Dl[t]])return this.index=t,Dl[this.index];return null}async markReleaseAnnouncementAsViewed(){if(!this.isReleaseAnnouncementEnabled())return;const e=this.getViewedReleaseAnnouncements();if(!Dl[this.index])return;e[Dl[this.index]]=!0,this.index++;if(!V.A.isLevelSupported(ae.p.ACCOUNT))return;if(V.A.canSetValue("releaseAnnouncementData",null,ae.p.ACCOUNT))try{await V.A.setValue("releaseAnnouncementData",null,ae.p.ACCOUNT,e)}catch(e){o.v.log("Failed to set release announcement settings",e)}}async nextReleaseAnnouncement(){await this.markReleaseAnnouncementAsViewed(),this.emit("releaseAnnouncementChanged",this.getReleaseAnnouncement())}}function Ol(e){const t=function(){const[e,t]=(0,s.useState)(!1);return(0,Me.YK)(A.Ay,A.XM.Opened,(()=>t(!0))),(0,Me.YK)(A.Ay,A.XM.Closed,(()=>!A.Ay.hasDialogs()&&t(!1))),e}(),n=(0,Me.DY)(Ml.instance,"releaseAnnouncementChanged",(()=>Ml.instance.getReleaseAnnouncement()===e));return!t&&n}(0,h.A)(Ml,"internalInstance",void 0);const Ll=["feature","children"];function Fl(e){let{feature:t,children:n}=e,i=(0,Ve.A)(e,Ll);const r=Ol(t);return s.createElement(Rl,(0,p.A)({open:r,onClick:()=>Ml.instance.nextReleaseAnnouncement()},i),n)}function Ul({displayButtonLabel:e}){const[t,n]=(0,s.useState)(!1),i=ll(t),r=Ol("threadsActivityCentre"),o=(0,Oe.ti)("Notifications.tac_only_notifications")?(0,P._t)("threads_activity_centre|no_rooms_with_threads_notifs"):(0,P._t)("threads_activity_centre|no_rooms_with_unread_threads");return s.createElement("div",{className:"mx_ThreadsActivityCentre_container",onKeyDown:e=>{if(!t)return;(0,Re.zM)().getNavigationAction(e)===Se.bY.FilterRooms&&e.stopPropagation()}},r?s.createElement(Fl,{feature:"threadsActivityCentre",header:(0,P._t)("threads_activity_centre|release_announcement_header"),description:(0,P._t)("threads_activity_centre|release_announcement_description"),closeLabel:(0,P._t)("action|ok")},s.createElement(nl,{disableTooltip:!0,displayLabel:e,notificationLevel:i.greatestNotificationLevel,onClick:async()=>{n(!0),await Ml.instance.nextReleaseAnnouncement()}})):s.createElement($a.W,{align:"start",side:"top",open:t,onOpenChange:e=>{e&&y.A.trackInteraction("WebThreadsActivityCentreButton"),n(e)},title:(0,P._t)("threads_activity_centre|header"),trigger:s.createElement(nl,{displayLabel:e,notificationLevel:i.greatestNotificationLevel})},s.createElement("div",{className:"mx_ThreadsActivityCentre_rows"},i.rooms.map((({room:e,notificationLevel:t})=>s.createElement(Bl,{key:e.roomId,room:e,notificationLevel:t,onClick:()=>n(!1)}))),0===i.rooms.length&&s.createElement("div",{className:"mx_ThreadsActivityCentre_emptyCaption"},o))))}function Bl({room:e,onClick:t,notificationLevel:n}){return s.createElement(Ya.D,{className:"mx_ThreadsActivityCentreRow",onSelect:n=>{t(),rl.A.instance.setCard({phase:sl.n.ThreadPanel},!0,e.roomId),y.A.trackInteraction("WebThreadsActivityCentreRoomItem",n),w.A.dispatch({action:R.r.ViewRoom,show_room_tile:!0,room_id:e.roomId,metricsTrigger:"WebThreadsActivityCentre",focusNext:"threadsPanel"})},label:e.name,Icon:s.createElement(il.A,{room:e,size:"32px"})},s.createElement(cl.V,{level:n,count:0,symbol:null,forceDot:!0}))}var Vl=n("./src/tchap/util/TchapUIFeature.ts");const jl=({isPanelCollapsed:e=!1})=>{const[t,n,i,r]=(0,Fe.EF)(),o=(0,s.useRef)(null),a=(0,s.useRef)(null),[l,c]=(0,s.useState)(!0),d="https://integration.lasuite.numerique.gouv.fr";let u;return(0,s.useEffect)((()=>{!async function(){try{const e=await fetch(`${d}/api/v1/gaufre`),t=(await e.text()).replace(/(src=|href=|url\()"\//g,`$1"${d}/`),n=(new DOMParser).parseFromString(t,"text/html"),i=document.createElement("div");i.innerHTML=n.body.innerHTML,o.current=i,c(!1)}catch(e){console.error("Error fetching gaufre list:",e),c(!1)}}()}),[]),(0,s.useEffect)((()=>{t&&a.current&&o.current&&!a.current.innerHTML&&a.current.appendChild(o.current)}),[t]),t&&n.current&&(u=s.createElement(Fe.Ay,(0,p.A)({},(0,Fe.Gi)(n.current.getBoundingClientRect(),Fe.t4.None,16),{wrapperClassName:"mx_QuickSettingsButton_ContextMenuWrapper",onFinished:r,managed:!1,focusLock:!0}),s.createElement("div",{id:"tchap-gaufre",className:"lasuite--gaufre-borderless",ref:a}))),s.createElement(s.Fragment,null,s.createElement(Ae.A,{className:re()(["mx_QuickSettingsButton",{expanded:!e},"lasuite-gaufre-tchap","lasuite-gaufre-mask"]),onClick:i,"aria-label":(0,P._t)("lasuite_numerique"),title:e?(0,P._t)("lasuite_numerique"):void 0,ref:n,"aria-expanded":!e},e?null:(0,P._t)("lasuite_numerique")),u)};var zl=n("./src/tchap/util/TchapUrls.ts");const Wl=({isPanelCollapsed:e=!1})=>{const[t,n,i,r]=(0,Fe.EF)();let o;return t&&n.current&&(o=s.createElement(Be.Ay,(0,p.A)({},(0,Fe.Gi)(n.current.getBoundingClientRect(),Fe.t4.None,16),{className:"mx_UserMenu_contextMenu",onFinished:r,compact:!0}),s.createElement(Be.tx,null,s.createElement(Be.R$,{iconClassName:"mx_UserMenu_iconInfo",label:(0,P._t)("quick_faq|faq"),onClick:e=>{window.open("https://www.tchap.gouv.fr/faq","_blank")}}),s.createElement(Be.R$,{iconClassName:"mx_UserMenu_iconMessage",label:(0,P._t)("quick_faq|contact"),onClick:e=>{window.open("mailto:support@tchap.beta.gouv.fr","_blank")}}),s.createElement(Be.R$,{iconClassName:"mx_UserMenu_iconHome",label:(0,P._t)("quick_faq|guides"),onClick:e=>{window.open(zl.A.helpUserOnboarding,"_blank")}})))),s.createElement(s.Fragment,null,s.createElement(Ae.A,{className:re()(["mx_QuickSettingsButton",{expanded:!e},"tc_sidebar_quick_faq"]),onClick:i,"aria-label":(0,P._t)("common|help"),title:e?(0,P._t)("common|help"):void 0,ref:n,"aria-expanded":!e},e?null:(0,P._t)("common|help")),o)};var Hl=n("./src/accessibility/LandmarkNavigation.ts"),Gl=n("./src/components/views/settings/KeyboardShortcut.tsx");const Kl=["onFinished","hideHeader"],Jl=["selected","isPanelCollapsed","size"],ql=["children","isPanelCollapsed","setPanelCollapsed","isDraggingOver","innerRef"],$l=e=>{let{onFinished:t,hideHeader:n}=e,i=(0,Ve.A)(e,Kl);const r=(0,Oe.ti)("Spaces.allRoomsInHome");return s.createElement(Be.Ay,(0,p.A)({},i,{onFinished:t,className:"mx_SpacePanel_contextMenu",compact:!0}),!n&&s.createElement("div",{className:"mx_SpacePanel_contextMenu_header"},(0,P._t)("common|home")),s.createElement(Be.tx,{first:!0},s.createElement(Be.LS,{iconClassName:"mx_SpacePanel_noIcon",label:(0,P._t)("settings|sidebar|metaspaces_home_all_rooms"),active:r,onClick:()=>{t(),V.A.setValue("Spaces.allRoomsInHome",null,ae.p.ACCOUNT,!r)}})))},Yl=e=>{let{selected:t,isPanelCollapsed:n,size:i="32px"}=e,r=(0,Ve.A)(e,Jl);return s.createElement("li",{className:re()("mx_SpaceItem",{collapsed:n}),role:"treeitem","aria-selected":t},s.createElement(_a,(0,p.A)({},r,{selected:t,isNarrow:n,size:i})))},Zl=()=>xe.Ay.instance.allRoomsInHome?Ea.n.instance.globalState:xe.Ay.instance.getNotificationState(ke._b.Home),Xl=({isPanelCollapsed:e,setPanelCollapsed:t})=>{const[n,i,r,o]=(0,Fe.EF)();let a;(0,s.useEffect)((()=>{!e&&n&&o()}),[e]),n&&(a=s.createElement(sa.Ay,{onFinished:o}));const l=n?o:()=>{e||t(!0),r()};return s.createElement("li",{className:re()("mx_SpaceItem mx_SpaceItem_new",{collapsed:e}),role:"treeitem","aria-selected":!1},s.createElement(_a,{className:re()("mx_SpaceButton_new",{mx_SpaceButton_newCancel:n}),label:n?(0,P._t)("action|cancel"):(0,P._t)("create_space|label"),onClick:l,isNarrow:e,innerRef:i,size:"32px"}),a)},Ql={[ke._b.Home]:({selected:e,isPanelCollapsed:t})=>{const n=(0,Me.dF)(xe.Ay.instance,ke.EC,(()=>xe.Ay.instance.allRoomsInHome)),[i,r]=(0,s.useState)(Zl()),o=(0,s.useCallback)((()=>{r(Zl())}),[]);return(0,s.useEffect)(o,[o,n]),(0,Me.ml)(Ea.n.instance,Ea.N,o),s.createElement(Yl,{spaceKey:ke._b.Home,className:"mx_SpaceButton_home",selected:e,isPanelCollapsed:t,label:(0,ke.Ff)(ke._b.Home,n),notificationState:i,ContextMenuComponent:$l,contextMenuTooltip:(0,P._t)("common|options"),size:"32px"})},[ke._b.Favourites]:({selected:e,isPanelCollapsed:t})=>s.createElement(Yl,{spaceKey:ke._b.Favourites,className:"mx_SpaceButton_favourites",selected:e,isPanelCollapsed:t,label:(0,ke.Ff)(ke._b.Favourites),notificationState:xe.Ay.instance.getNotificationState(ke._b.Favourites),size:"32px"}),[ke._b.People]:({selected:e,isPanelCollapsed:t})=>s.createElement(Yl,{spaceKey:ke._b.People,className:"mx_SpaceButton_people",selected:e,isPanelCollapsed:t,label:(0,ke.Ff)(ke._b.People),notificationState:xe.Ay.instance.getNotificationState(ke._b.People),size:"32px"}),[ke._b.Orphans]:({selected:e,isPanelCollapsed:t})=>s.createElement(Yl,{spaceKey:ke._b.Orphans,className:"mx_SpaceButton_orphans",selected:e,isPanelCollapsed:t,label:(0,ke.Ff)(ke._b.Orphans),notificationState:xe.Ay.instance.getNotificationState(ke._b.Orphans),size:"32px"}),[ke._b.VideoRooms]:({selected:e,isPanelCollapsed:t})=>s.createElement(Yl,{spaceKey:ke._b.VideoRooms,className:"mx_SpaceButton_videoRooms",selected:e,isPanelCollapsed:t,label:(0,ke.Ff)(ke._b.VideoRooms),notificationState:xe.Ay.instance.getNotificationState(ke._b.VideoRooms),size:"32px"})},ec=s.memo((e=>{let{children:t,isPanelCollapsed:n,setPanelCollapsed:i,isDraggingOver:r,innerRef:o}=e,a=(0,Ve.A)(e,ql);const[l,c,d,u]=(()=>{const e=(0,Me.dF)(xe.Ay.instance,ke.kQ,(()=>xe.Ay.instance.invitedSpaces)),[t,n]=(0,Me.dF)(xe.Ay.instance,ke.bZ,(()=>[xe.Ay.instance.enabledMetaSpaces,xe.Ay.instance.spacePanelSpaces]));return[e,t,n,(0,Me.dF)(xe.Ay.instance,ke.tw,(()=>xe.Ay.instance.activeSpace))]})(),m=u?[u]:[],h=c.filter((e=>!(e===ke._b.VideoRooms&&!V.A.getValue("feature_video_rooms")))).map((e=>{const t=Ql[e];return s.createElement(t,{key:e,selected:u===e,isPanelCollapsed:n})}));return s.createElement(qa,(0,p.A)({},a,{wrappedRef:o,className:"mx_SpaceTreeLevel",style:r?{pointerEvents:"none"}:void 0,element:"ul",role:"tree","aria-label":(0,P._t)("common|spaces")}),h,l.map((e=>s.createElement(ya,{key:e.roomId,space:e,activeSpaces:m,isPanelCollapsed:n,onExpand:()=>i(!1)}))),d.map(((e,t)=>s.createElement(ea,{key:e.roomId,draggableId:e.roomId,index:t},((t,r)=>s.createElement(ya,(0,p.A)({},t.draggableProps,{dragHandleProps:t.dragHandleProps,key:e.roomId,innerRef:t.innerRef,className:r.isDragging?"mx_SpaceItem_dragging":void 0,space:e,activeSpaces:m,isPanelCollapsed:n,onExpand:()=>i(!1)})))))),t,(0,Ne.g)($.C.CreateSpaces)&&s.createElement(Xl,{isPanelCollapsed:n,setPanelCollapsed:i}))})),tc=()=>{const[e,t]=(0,s.useState)(!1),[n,i]=(0,s.useState)(!0),r=(0,s.useRef)(null);return(0,s.useLayoutEffect)((()=>(r.current&&Ie.A.instance.trackElementDimensions("SpacePanel",r.current),()=>Ie.A.instance.stopTrackingElementDimensions("SpacePanel"))),[]),(0,De.F)(w.A,(e=>{e.action===R.r.ToggleSpacePanel&&i(!n)})),s.createElement(ha.Se,{handleHomeEnd:!0,handleUpDown:!e},(({onKeyDownHandler:e,onDragEndHandler:o})=>s.createElement(_o,{onDragStart:()=>{t(!0)},onDragEnd:e=>{t(!1),e.destination&&(xe.Ay.instance.moveRootSpace(e.source.index,e.destination.index),o())}},s.createElement("nav",{className:re()("mx_SpacePanel",{collapsed:n}),onKeyDown:t=>{const n=(0,Re.zM)().getNavigationAction(t);if(n===Se.bY.NextLandmark||n===Se.bY.PreviousLandmark)return Hl.r.findAndFocusNextLandmark(Hl.H.ACTIVE_SPACE_BUTTON,n===Se.bY.PreviousLandmark),t.stopPropagation(),void t.preventDefault();e(t)},ref:r,"aria-label":(0,P._t)("common|spaces")},s.createElement(Ga,{isPanelCollapsed:n},s.createElement(Ae.A,{className:re()("mx_SpacePanel_toggleCollapse",{expanded:!n}),onClick:()=>i(!n),title:n?(0,P._t)("action|expand"):(0,P._t)("action|collapse"),caption:s.createElement(Gl.S,{value:{ctrlOrCmdKey:!0,shiftKey:!0,key:"d"},className:"mx_SpacePanel_Tooltip_KeyboardShortcut"})})),s.createElement(ra,{droppableId:"top-level-spaces"},((e,t)=>s.createElement(ec,(0,p.A)({},e.droppableProps,{isPanelCollapsed:n,setPanelCollapsed:i,isDraggingOver:t.isDraggingOver,innerRef:e.innerRef}),e.placeholder))),Vl.A.isFeatureActiveForHomeserver("feature_thread")?s.createElement(Ul,{displayButtonLabel:!n}):null,s.createElement(Wl,{isPanelCollapsed:n}),s.createElement(jl,{isPanelCollapsed:n})))))},nc=e=>({left:e.left+window.scrollX,top:e.bottom+window.scrollY+12,chevronFace:Fe.t4.None});var ic=function(e){return e[e.JoinRoom=0]="JoinRoom",e[e.BulkRedact=1]="BulkRedact",e}(ic||{});const rc=({onVisibilityChange:e})=>{var t;const n=(0,s.useContext)(Pe.Ay),[r,o,a,l]=(0,Fe.EF)(),[c,d,u,m]=(0,Fe.EF)(),[h,g]=(0,Me.dF)(xe.Ay.instance,ke.tw,(()=>[xe.Ay.instance.activeSpace,xe.Ay.instance.activeSpaceRoom])),v=(0,Me.dF)(xe.Ay.instance,ke.EC,(()=>xe.Ay.instance.allRoomsInHome)),f=(0,Oe.ny)("feature_video_rooms"),_=(0,Oe.ny)("feature_element_call_video_rooms"),b=(()=>{const e=(0,s.useContext)(Pe.Ay),[t,n]=(0,s.useState)(new Map),r=(e,i)=>{const r=new Set(t.get(e));r.add(i),n(new Map(t).set(e,r))},o=(e,i)=>{const r=new Set(t.get(e));r.delete(i)&&n(new Map(t).set(e,r))};return(0,De.F)(w.A,(e=>{switch(e.action){case R.r.JoinRoom:r(ic.JoinRoom,e.roomId);break;case R.r.JoinRoomReady:case R.r.JoinRoomError:o(ic.JoinRoom,e.roomId);break;case R.r.BulkRedactStart:r(ic.BulkRedact,e.roomId);break;case R.r.BulkRedactEnd:o(ic.BulkRedact,e.roomId)}})),(0,Me.YK)(e,i.ClientEvent.Room,(e=>o(ic.JoinRoom,e.roomId))),t})(),E=g||h===ke._b.Home;(0,s.useEffect)((()=>{r&&!E&&l()}),[l,E,r]);const S=(0,Me.DY)(null!=g?g:void 0,i.RoomEvent.Name,(()=>null==g?void 0:g.name));(0,s.useEffect)((()=>{null==e||e()}),[e]);const A=(0,Ne.g)($.C.ExploreRooms),C=(0,Ne.g)($.C.CreateRooms),x=(0,Ne.g)($.C.CreateSpaces),k=null==g||null===(t=g.currentState)||void 0===t?void 0:t.maySendStateEvent(i.EventType.SpaceChild,n.getUserId()),I=k&&C,T=C||A||x||g;let N,D;if(r&&o.current){let e;e=g?We:$l,N=s.createElement(e,(0,p.A)({},nc(o.current.getBoundingClientRect()),{space:g,onFinished:l,hideHeader:!0}))}else if(c&&g){let e,t;(0,Le.MI)(g)&&(e=s.createElement(Be.R$,{label:(0,P._t)("action|invite"),iconClassName:"mx_RoomListHeader_iconInvite",onClick:e=>{e.preventDefault(),e.stopPropagation(),(0,Le.Lo)(g),m()}})),null!=g&&g.currentState.maySendStateEvent(i.EventType.RoomAvatar,n.getUserId())&&(t=s.createElement(s.Fragment,null,s.createElement(Be.R$,{iconClassName:"mx_RoomListHeader_iconNewRoom",label:(0,P._t)("action|new_room"),onClick:e=>{e.preventDefault(),e.stopPropagation(),(0,Le.PT)(g),y.A.trackInteraction("WebRoomListHeaderPlusMenuCreateRoomItem",e),m()}}),f&&s.createElement(Be.R$,{iconClassName:"mx_RoomListHeader_iconNewVideoRoom",label:(0,P._t)("action|new_video_room"),onClick:e=>{e.preventDefault(),e.stopPropagation(),(0,Le.PT)(g,_?i.RoomType.UnstableCall:i.RoomType.ElementVideo),m()}},s.createElement(Ue.s,null)))),N=s.createElement(Be.Ay,(0,p.A)({},nc(d.current.getBoundingClientRect()),{onFinished:m,compact:!0}),s.createElement(Be.tx,{first:!0},e,t,s.createElement(Be.R$,{label:(0,P._t)("action|explore_rooms"),iconClassName:"mx_RoomListHeader_iconExplore",onClick:e=>{e.preventDefault(),e.stopPropagation(),w.A.dispatch({action:R.r.ViewRoom,room_id:g.roomId,metricsTrigger:void 0}),m(),y.A.trackInteraction("WebRoomListHeaderPlusMenuExploreRoomsItem",e)}}),s.createElement(Be.R$,{label:(0,P._t)("action|add_existing_room"),iconClassName:"mx_RoomListHeader_iconPlus",onClick:e=>{e.preventDefault(),e.stopPropagation(),(0,Le.yV)(g),m()},disabled:!I,title:I?void 0:(0,P._t)("spaces|error_no_permission_add_room")})))}else if(c){let e,t;C&&(e=s.createElement(s.Fragment,null,s.createElement(Be.R$,{label:(0,P._t)("action|start_new_chat"),iconClassName:"mx_RoomListHeader_iconStartChat",onClick:e=>{e.preventDefault(),e.stopPropagation(),w.A.dispatch({action:"view_create_chat"}),y.A.trackInteraction("WebRoomListHeaderPlusMenuCreateChatItem",e),m()}}),s.createElement(Be.R$,{label:(0,P._t)("action|new_room"),iconClassName:"mx_RoomListHeader_iconNewRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),w.A.dispatch({action:"view_create_room"}),y.A.trackInteraction("WebRoomListHeaderPlusMenuCreateRoomItem",e),m()}}),f&&s.createElement(Be.R$,{label:(0,P._t)("action|new_video_room"),iconClassName:"mx_RoomListHeader_iconNewVideoRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),w.A.dispatch({action:"view_create_room",type:_?i.RoomType.UnstableCall:i.RoomType.ElementVideo}),m()}},s.createElement(Ue.s,null)))),A&&(t=s.createElement(Be.R$,{label:(0,P._t)("room_list|join_public_room_label"),iconClassName:"mx_RoomListHeader_iconExplore",onClick:e=>{e.preventDefault(),e.stopPropagation(),w.A.dispatch({action:R.r.ViewRoomDirectory}),y.A.trackInteraction("WebRoomListHeaderPlusMenuExploreRoomsItem",e),m()}})),N=s.createElement(Be.Ay,(0,p.A)({},nc(d.current.getBoundingClientRect()),{onFinished:m,compact:!0}),s.createElement(Be.tx,{first:!0},e,t))}D=g&&S?S:(0,ke.Ff)(h,v);const M=[...b.entries()].filter((([e,t])=>t.size>0)).map((([e,t])=>{switch(e){case ic.JoinRoom:return(0,P._t)("room_list|joining_rooms_status",{count:t.size});case ic.BulkRedact:return(0,P._t)("room_list|redacting_messages_status",{count:t.size})}})).join("\n");let O=s.createElement("div",{className:"mx_RoomListHeader_contextLessTitle"},D);if(E){const e={ref:o,onClick:a,isExpanded:r,className:"mx_RoomListHeader_contextMenuButton",children:D};O=g?s.createElement(Fe.VJ,(0,p.A)({},e,{label:(0,P._t)("room_list|space_menu_label",{spaceName:null!=S?S:g.name})})):s.createElement(Fe.oW,(0,p.A)({},e,{title:(0,P._t)("room_list|home_menu_label")}))}return s.createElement("aside",{className:"mx_RoomListHeader","aria-label":(0,P._t)("room|context_menu|title")},O,M?s.createElement(Te.m,{label:M,isTriggerInteractive:!1},s.createElement(He.A,null)):null,T&&s.createElement(Fe.oW,{ref:d,onClick:u,isExpanded:c,className:"mx_RoomListHeader_plusButton",title:(0,P._t)("action|add")}),N)};var sc=n("./src/stores/BreadcrumbsStore.ts"),oc=n("./src/stores/room-list/RoomListStore.ts"),ac=n("./node_modules/react-transition-group/esm/CSSTransition.js"),lc=n("./src/accessibility/Toolbar.tsx");const cc=({room:e,onClick:t})=>{const[n,i,r]=(0,ha.A9)();return s.createElement(Ae.A,{className:"mx_RoomBreadcrumbs_crumb",onClick:t,"aria-label":(0,P._t)("a11y|room_name",{name:e.name}),title:e.name,onFocus:n,ref:r,tabIndex:i?0:-1,placement:"right"},s.createElement(il.A,{room:e,size:"32px",displayBadge:!0,hideIfDot:!0,tooltipProps:{tabIndex:i?0:-1}}))};class dc extends s.PureComponent{constructor(e){super(e),(0,h.A)(this,"unmounted",!1),(0,h.A)(this,"toolbar",(0,s.createRef)()),(0,h.A)(this,"onBreadcrumbsUpdate",(()=>{this.unmounted||(this.setState({doAnimation:!1,skipFirst:!0}),window.setTimeout((()=>this.setState({doAnimation:!0,skipFirst:!1})),0))})),(0,h.A)(this,"viewRoom",((e,t,n=!1)=>{w.A.dispatch({action:R.r.ViewRoom,room_id:e.roomId,metricsTrigger:"WebHorizontalBreadcrumbs",metricsViaKeyboard:n})})),this.state={doAnimation:!0,skipFirst:!1}}componentDidMount(){this.unmounted=!1,sc.Y.instance.on(I.H,this.onBreadcrumbsUpdate)}componentWillUnmount(){this.unmounted=!0,sc.Y.instance.off(I.H,this.onBreadcrumbsUpdate)}render(){const e=sc.Y.instance.rooms.map(((e,t)=>s.createElement(cc,{key:e.roomId,room:e,onClick:n=>this.viewRoom(e,t,"click"!==n.type)})));return e.length>0?s.createElement(ac.A,{appear:!0,in:this.state.doAnimation,timeout:640,classNames:"mx_RoomBreadcrumbs",nodeRef:this.toolbar},s.createElement(lc.A,{className:"mx_RoomBreadcrumbs","aria-label":(0,P._t)("room_list|breadcrumbs_label"),ref:this.toolbar},e.slice(this.state.skipFirst?1:0))):s.createElement("div",{className:"mx_RoomBreadcrumbs"},s.createElement("div",{className:"mx_RoomBreadcrumbs_placeholder"},(0,P._t)("room_list|breadcrumbs_empty")))}}var uc=n("./src/components/views/typography/Heading.tsx");var mc=n("./src/utils/DMRoomMap.ts");function pc(e,t){const[n,r]=(0,s.useState)(e),a=(0,Pe.nH)(),l=function(e){const t=(0,s.useRef)(e);return t.current=e,(0,s.useCallback)(((...e)=>t.current(...e)),[])}(t);return(0,s.useEffect)((()=>{if(n)return;let e=null,t=!0;const s=async()=>{null!==e&&(clearTimeout(e),e=null),r(await l(a)),t&&(e=window.setTimeout(s,5e3))};return s().catch((e=>o.v.warn("could not update user onboarding context",e))),a.on(i.ClientEvent.AccountData,s),()=>{t=!1,a.off(i.ClientEvent.AccountData,s),null!==e&&(clearTimeout(e),e=null)}}),[a,l,n]),n}function hc(){const e=pc(!1,(async e=>{const t=await e.getProfileInfo(e.getUserId());return Boolean(null==t?void 0:t.avatar_url)})),t=pc(!1,(async e=>{const t=e.getDeviceId(),n=await e.getDevices();return Boolean(n.devices.find((e=>e.device_id!==t)))})),n=pc(!1,(async()=>{var e;const t=null!==(e=mc.A.shared().getUniqueRoomsWithIndividuals())&&void 0!==e?e:{};return Boolean(Object.keys(t).length)})),r=pc(!1,(async e=>await e.secretStorage.hasKey())),o=pc(!1,(async e=>{var t;const n=null!==(t=window.localStorage.getItem("tchap_user_guide_checked"))&&void 0!==t?t:"false";return Promise.resolve(JSON.parse(n))})),a=function(){const e=(0,Pe.nH)(),[t,n]=(0,s.useState)(!e.pushRules||S.Notifier.shouldShowPrompt()),r=(0,s.useCallback)((()=>{n(!e.pushRules||S.Notifier.shouldShowPrompt())}),[e]);(0,Me.ml)(S.Notifier,S.NotifierEvent.NotificationHiddenChange,(()=>{r()}));const o=(0,Oe.ti)("notificationsEnabled");return(0,s.useEffect)((()=>{r()}),[o,r]),(0,Me.YK)(e,i.ClientEvent.Sync,r),t}();return(0,s.useMemo)((()=>({hasAvatar:e,hasDevices:t,hasDmRooms:n,showNotificationsPrompt:a,hasSecureStorage:r,hasCheckedUserGuide:o})),[e,t,n,a,r,o])}var gc,vc,fc,_c,yc,bc,Ec,wc,Sc,Ac,Cc,xc,kc,Rc,Ic,Tc,Pc,Nc,Dc,Mc,Oc,Lc,Fc,Uc,Bc,Vc,jc;function zc(){return zc=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},zc.apply(null,arguments)}var Wc=function(e,t){return s.createElement("svg",zc({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 564 168",role:"presentation","aria-hidden":!0,ref:t},e),gc||(gc=s.createElement("defs",null,s.createElement("radialGradient",{id:"f-droid_svg__a",cx:113,cy:-12.89,r:59.662,gradientTransform:"matrix(0 1.9611 -1.9778 0 5.51 -198.6)",gradientUnits:"userSpaceOnUse"},s.createElement("stop",{offset:0,stopColor:"#fff",stopOpacity:.098}),s.createElement("stop",{offset:1,stopColor:"#fff",stopOpacity:0})))),vc||(vc=s.createElement("path",{stroke:"#a6a6a6",strokeWidth:4,d:"M22 2h520c11.08 0 20 8.92 20 20v124c0 11.08-8.92 20-20 20H22c-11.08 0-20-8.92-20-20V22C2 10.92 10.92 2 22 2z"})),fc||(fc=s.createElement("path",{fill:"#fff",d:"M199.26 45.46v-6.682h-5.499v-2.766h8.831v10.681q-1.949 1.383-4.299 2.1-2.349.7-5.015.7-5.832 0-9.131-3.4-3.283-3.415-3.283-9.497 0-6.099 3.283-9.498 3.3-3.416 9.131-3.416 2.433 0 4.616.6 2.2.6 4.049 1.766v3.583q-1.867-1.583-3.966-2.383t-4.416-.8q-4.565 0-6.865 2.55-2.283 2.549-2.283 7.598 0 5.032 2.283 7.581 2.3 2.55 6.865 2.55 1.783 0 3.183-.3 1.4-.317 2.516-.967m9.48-21.33h15.729v2.833h-12.364v7.365h11.847v2.832h-11.847v9.015h12.664v2.832H208.74zm18.12 0h21.045v2.833h-8.831v22.045h-3.383V26.963h-8.83zm35.14 0h3.366v24.877H262zm6.61 0h21.045v2.833h-8.831v22.045h-3.383V26.963h-8.83zm45.24 2.28q-3.666 0-5.832 2.733-2.15 2.732-2.15 7.448 0 4.699 2.15 7.431 2.166 2.733 5.832 2.733t5.799-2.733q2.15-2.732 2.15-7.431 0-4.716-2.15-7.448-2.133-2.733-5.799-2.733m0-2.733q5.232 0 8.365 3.516 3.132 3.5 3.132 9.398 0 5.882-3.132 9.397-3.133 3.5-8.365 3.5-5.249 0-8.398-3.5-3.132-3.499-3.132-9.397t3.132-9.398q3.15-3.516 8.398-3.516m16.76.453h4.532l11.031 20.812V24.13h3.266v24.877h-4.532l-11.031-20.812v20.812h-3.266z","aria-label":"GET IT ON"})),_c||(_c=s.createElement("path",{fill:"#fff",d:"M180.81 136v-8.118l7.19-1.391V78.017l-7.19-1.392v-8.164h53.762v18.508h-10.391l-.603-8.071h-22.034v18.6h23.657v10.438h-23.657v18.555l7.236 1.391V136zm62.16-23.66v-10.437h26.162v10.437zM277.29 136v-8.118l7.283-1.53v-48.15l-7.283-1.577v-8.164h29.641q9.045 0 15.957 4.268 6.912 4.221 10.762 11.736 3.897 7.468 3.897 17.163v1.252q0 9.602-3.85 17.117-3.804 7.468-10.67 11.736t-15.91 4.268zm20.828-10.344h8.303q5.613 0 9.51-2.922 3.896-2.97 5.937-8.118 2.087-5.149 2.087-11.736v-1.299q0-6.68-2.087-11.782-2.041-5.149-5.938-8.025-3.896-2.922-9.509-2.922h-8.303zM344.79 136v-8.118l6.494-1.391V95.366l-7.19-1.392V85.81h19.807l.51 6.216.093 1.113q1.856-4.082 4.593-6.17t6.54-2.087q1.206 0 2.644.232 1.438.186 2.551.51l-1.438 12.478-6.726-.37q-2.876-.14-4.685.974-1.763 1.113-3.154 3.2v24.585l6.494 1.392V136zm63.08.98q-7.422 0-12.756-3.247t-8.164-9q-2.83-5.797-2.83-13.312v-.974q0-7.469 2.83-13.22 2.83-5.799 8.118-9.046 5.334-3.293 12.71-3.293 7.468 0 12.756 3.293 5.288 3.247 8.117 9t2.83 13.266v.974q0 7.515-2.83 13.313-2.83 5.752-8.117 9-5.289 3.247-12.664 3.247zm0-10.391q3.525 0 5.752-1.902t3.293-5.288q1.067-3.433 1.067-7.979v-.974q0-4.453-1.067-7.839-1.066-3.433-3.34-5.335-2.226-1.948-5.798-1.948-3.479 0-5.752 1.948-2.273 1.902-3.34 5.335-1.02 3.386-1.02 7.84v.973q0 4.546 1.02 7.979 1.067 3.433 3.34 5.334 2.273 1.856 5.845 1.856M437.1 136v-8.118l6.54-1.391V95.366l-7.236-1.392V85.81h20.781v40.681l6.494 1.392V136zm6.077-60.813v-11.55h14.009v11.55zm44.293 61.793q-5.984 0-10.298-3.062-4.268-3.107-6.54-8.627-2.273-5.567-2.273-12.988v-.975q0-7.932 2.273-13.87 2.319-5.937 6.586-9.23 4.268-3.34 10.205-3.34 4.129 0 7.237 1.67 3.108 1.623 5.38 4.638V73.198l-7.236-1.391v-8.164h20.781v62.854l6.494 1.391v8.118h-18.23l-1.02-6.123q-2.366 3.479-5.66 5.288-3.246 1.81-7.7 1.81zm4.036-10.53q2.83 0 4.963-1.206t3.572-3.479v-21.292q-1.392-2.412-3.526-3.71-2.133-1.346-4.917-1.346-3.386 0-5.566 2.04-2.134 1.995-3.154 5.567-.974 3.572-.974 8.303v.975q0 6.587 2.226 10.39 2.227 3.758 7.376 3.758","aria-label":"F-Droid"})),yc||(yc=s.createElement("path",{fill:"#8ab000",stroke:"#769616",strokeLinecap:"round",strokeWidth:6.579,d:"m146.34 25.898-11.184 14.474"})),bc||(bc=s.createElement("path",{fill:"#fff",fillOpacity:.298,d:"M146.29 22.477c1.192.032 2.003.497 2.579 1.182-5.332 6.34-6.232 7.344-13.513 16.37-2.684 3.472-5.479 1.677-2.795-1.794l11.184-14.474a3.26 3.26 0 0 1 2.545-1.284",color:"#000"})),Ec||(Ec=s.createElement("path",{fill:"#263238",fillOpacity:.2,d:"M148.89 23.793a3.29 3.29 0 0 1 .058 4.095l-11.184 14.474c-2.684 3.474-3.026-1.61-3.026-1.61s9.829-11.87 14.153-16.959z",color:"#000"})),wc||(wc=s.createElement("path",{fill:"#8ab000",d:"M147 23.003c1.153 0 2.526.374 2.168 2.103-.27 1.318-12.263 15.984-12.263 15.984-2.684 3.47-6.563 1.779-3.879-1.693l11.142-14.4c.685-.763 1.603-1.957 2.832-1.994",color:"#000"})),Sc||(Sc=s.createElement("path",{fill:"#8ab000",stroke:"#769616",strokeLinecap:"round",strokeWidth:6.579,d:"m33.653 25.898 11.184 14.474"})),Ac||(Ac=s.createElement("path",{fill:"#fff",fillOpacity:.298,d:"M33.711 22.477c-1.192.032-2.003.497-2.579 1.182 5.332 6.34 6.232 7.344 13.513 16.37 2.684 3.472 5.479 1.677 2.795-1.794L36.256 23.76a3.26 3.26 0 0 0-2.545-1.284z",color:"#000"})),Cc||(Cc=s.createElement("path",{fill:"#263238",fillOpacity:.2,d:"M31.108 23.793a3.29 3.29 0 0 0-.058 4.095l11.184 14.474c2.684 3.474 3.026-1.61 3.026-1.61s-9.829-11.87-14.153-16.959z",color:"#000"})),xc||(xc=s.createElement("path",{fill:"#8ab000",d:"M32.993 23.003c-1.153 0-2.526.374-2.168 2.103.27 1.318 12.263 15.984 12.263 15.984 2.684 3.47 6.563 1.779 3.879-1.693l-11.142-14.4c-.685-.763-1.603-1.957-2.832-1.994",color:"#000"})),kc||(kc=s.createElement("path",{fill:"#aeea00",d:"M47.893 35.109h84.211a7.88 7.88 0 0 1 7.895 7.894v18.211a7.88 7.88 0 0 1-7.895 7.895H47.893a7.88 7.88 0 0 1-7.895-7.895v-18.21a7.88 7.88 0 0 1 7.895-7.895"})),Rc||(Rc=s.createElement("path",{fill:"#263238",fillOpacity:.2,d:"M47.893 42.74h84.211a7.88 7.88 0 0 1 7.895 7.895v10.526a7.88 7.88 0 0 1-7.895 7.895H47.893a7.88 7.88 0 0 1-7.895-7.895V50.635a7.88 7.88 0 0 1 7.895-7.895"})),Ic||(Ic=s.createElement("path",{fill:"#fff",fillOpacity:.298,d:"M47.893 35.109h84.211a7.88 7.88 0 0 1 7.895 7.894V53.53a7.88 7.88 0 0 1-7.895 7.895H47.893a7.88 7.88 0 0 1-7.895-7.895V43.003a7.88 7.88 0 0 1 7.895-7.894"})),Tc||(Tc=s.createElement("path",{fill:"#aeea00",d:"M47.893 38.003h84.211c4.374 0 7.895 2.883 7.895 6.462v15.079c0 3.58-3.521 6.462-7.895 6.462H47.893c-4.374 0-7.895-2.882-7.895-6.462V44.465c0-3.58 3.521-6.462 7.895-6.462"})),Pc||(Pc=s.createElement("path",{fill:"#1976d2",d:"M47.893 71.944h84.211a7.88 7.88 0 0 1 7.895 7.895v52.211a7.88 7.88 0 0 1-7.895 7.895H47.893a7.88 7.88 0 0 1-7.895-7.895V79.839a7.88 7.88 0 0 1 7.895-7.895"})),Nc||(Nc=s.createElement("path",{fill:"#263238",fillOpacity:.2,d:"M47.893 105.89h84.211a7.88 7.88 0 0 1 7.895 7.895v18.42a7.88 7.88 0 0 1-7.895 7.896H47.893a7.88 7.88 0 0 1-7.895-7.895v-18.421a7.88 7.88 0 0 1 7.895-7.895"})),Dc||(Dc=s.createElement("path",{fill:"#fff",fillOpacity:.2,d:"M47.893 71.681h84.211a7.88 7.88 0 0 1 7.895 7.895v18.421a7.88 7.88 0 0 1-7.895 7.895H47.893a7.88 7.88 0 0 1-7.895-7.895V79.576a7.88 7.88 0 0 1 7.895-7.895"})),Mc||(Mc=s.createElement("path",{fill:"#1976d2",d:"M47.893 75.102h84.211c4.374 0 7.895 3.19 7.895 7.154v47.693c0 3.963-3.521 7.153-7.895 7.153H47.893c-4.374 0-7.895-3.19-7.895-7.153V82.256c0-3.963 3.521-7.154 7.895-7.154"})),Oc||(Oc=s.createElement("path",{fill:"#0d47a1",d:"M89.998 89.714c-7.579 0-14 5.224-15.876 12.237h8.455a8.46 8.46 0 0 1 7.421-4.342 8.495 8.495 0 0 1 8.553 8.553 8.495 8.495 0 0 1-8.553 8.552 8.47 8.47 0 0 1-7.71-4.868h-8.3c1.69 7.279 8.242 12.763 16.01 12.763 9.038 0 16.449-7.41 16.449-16.448s-7.41-16.448-16.448-16.448z",color:"#000"})),Lc||(Lc=s.createElement("path",{fill:"none",stroke:"#0d47a1",strokeLinecap:"round",strokeWidth:5,d:"M115.13 106.16a25.13 25.13 0 0 1-25.132 25.132 25.13 25.13 0 0 1-25.131-25.132 25.13 25.13 0 0 1 25.131-25.132 25.13 25.13 0 0 1 25.132 25.132z"})),Fc||(Fc=s.createElement("path",{fill:"#263238",fillOpacity:.2,d:"M73.55 52.477a8.882 10.197 0 0 1-8.88 10.198 8.882 10.197 0 0 1-8.882-10.198 8.882 10.197 0 0 1 8.881-10.197 8.882 10.197 0 0 1 8.882 10.197z"})),Uc||(Uc=s.createElement("path",{fill:"#fff",d:"M73.55 53.793a8.88 8.88 0 0 1-8.88 8.882 8.88 8.88 0 0 1-8.882-8.882 8.88 8.88 0 0 1 8.881-8.882 8.88 8.88 0 0 1 8.882 8.882z"})),Bc||(Bc=s.createElement("path",{fill:"#263238",fillOpacity:.2,d:"M124.87 52.477a8.882 10.197 0 0 1-8.882 10.198 8.882 10.197 0 0 1-8.881-10.198 8.882 10.197 0 0 1 8.881-10.197 8.882 10.197 0 0 1 8.882 10.197"})),Vc||(Vc=s.createElement("path",{fill:"#fff",d:"M124.87 53.793a8.88 8.88 0 0 1-8.882 8.882 8.88 8.88 0 0 1-8.881-8.882 8.88 8.88 0 0 1 8.881-8.882 8.88 8.88 0 0 1 8.882 8.882"})),jc||(jc=s.createElement("path",{fill:"url(#f-droid_svg__a)",fillRule:"evenodd",d:"M33.71 22.47a3.29 3.29 0 0 0-2.662 5.336l9.474 12.262a7.9 7.9 0 0 0-.527 2.824v18.211a7.877 7.877 0 0 0 7.895 7.895h84.21a7.877 7.877 0 0 0 7.895-7.895v-18.21c0-1-.19-1.95-.525-2.827l9.472-12.26a3.29 3.29 0 0 0-2.433-5.334 3.29 3.29 0 0 0-2.772 1.31l-9.013 11.666a7.9 7.9 0 0 0-2.623-.45H47.89c-.922 0-1.8.163-2.621.45l-9.016-11.666a3.29 3.29 0 0 0-2.543-1.312m14.18 49.527a7.877 7.877 0 0 0-7.894 7.894v52.211a7.877 7.877 0 0 0 7.894 7.895h84.211a7.877 7.877 0 0 0 7.894-7.895v-52.21a7.877 7.877 0 0 0-7.894-7.895z",color:"#000"})))},Hc=(0,s.forwardRef)(Wc);var Gc,Kc,Jc,qc,$c,Yc,Zc,Xc,Qc,ed,td,nd,id,rd,sd,od,ad,ld,cd,dd,ud,md;function pd(){return pd=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},pd.apply(null,arguments)}var hd=function(e,t){return s.createElement("svg",pd({xmlns:"http://www.w3.org/2000/svg",xmlSpace:"preserve",viewBox:"0 0 180 53.332",role:"presentation","aria-hidden":!0,ref:t},e),Gc||(Gc=s.createElement("defs",null,s.createElement("linearGradient",{id:"google-play_svg__a",x2:1,gradientTransform:"scale(-31.64 31.64)rotate(45 -.903 -.925)",gradientUnits:"userSpaceOnUse"},s.createElement("stop",{offset:0,stopColor:"#00a0ff"}),s.createElement("stop",{offset:.007,stopColor:"#00a1ff"}),s.createElement("stop",{offset:.26,stopColor:"#00beff"}),s.createElement("stop",{offset:.512,stopColor:"#00d2ff"}),s.createElement("stop",{offset:.76,stopColor:"#00dfff"}),s.createElement("stop",{offset:1,stopColor:"#00e3ff"})),s.createElement("linearGradient",{id:"google-play_svg__b",x2:1,gradientTransform:"matrix(-32.255 0 0 32.255 45.098 26.675)",gradientUnits:"userSpaceOnUse"},s.createElement("stop",{offset:0,stopColor:"#ffe000"}),s.createElement("stop",{offset:.409,stopColor:"#ffbd00"}),s.createElement("stop",{offset:.775,stopColor:"orange"}),s.createElement("stop",{offset:1,stopColor:"#ff9c00"})),s.createElement("linearGradient",{id:"google-play_svg__c",x2:1,gradientTransform:"scale(-42.903 42.903)rotate(45 -1.222 -.585)",gradientUnits:"userSpaceOnUse"},s.createElement("stop",{offset:0,stopColor:"#ff3a44"}),s.createElement("stop",{offset:1,stopColor:"#c31162"})),s.createElement("linearGradient",{id:"google-play_svg__d",x2:1,gradientTransform:"scale(19.156 -19.156)rotate(-44.998 .238 -.62)",gradientUnits:"userSpaceOnUse"},s.createElement("stop",{offset:0,stopColor:"#32a071"}),s.createElement("stop",{offset:.069,stopColor:"#2da771"}),s.createElement("stop",{offset:.476,stopColor:"#15cf74"}),s.createElement("stop",{offset:.801,stopColor:"#06e775"}),s.createElement("stop",{offset:1,stopColor:"#00f076"})),s.createElement("linearGradient",{id:"google-play_svg__e",x2:1,gradientTransform:"matrix(-32.255 0 0 32.255 45.098 26.675)",gradientUnits:"userSpaceOnUse"},s.createElement("stop",{offset:0,stopColor:"#ccb300"}),s.createElement("stop",{offset:.409,stopColor:"#cc9700"}),s.createElement("stop",{offset:.775,stopColor:"#cc8400"}),s.createElement("stop",{offset:1,stopColor:"#cc7d00"})),s.createElement("linearGradient",{id:"google-play_svg__f",x2:1,gradientTransform:"scale(-42.903 42.903)rotate(45 -1.222 -.585)",gradientUnits:"userSpaceOnUse"},s.createElement("stop",{offset:0,stopColor:"#cc2e36"}),s.createElement("stop",{offset:1,stopColor:"#9c0e4e"})),s.createElement("linearGradient",{id:"google-play_svg__g",x2:1,gradientTransform:"scale(-31.64 31.64)rotate(45 -.903 -.925)",gradientUnits:"userSpaceOnUse"},s.createElement("stop",{offset:0,stopColor:"#008de0"}),s.createElement("stop",{offset:.007,stopColor:"#008de0"}),s.createElement("stop",{offset:.26,stopColor:"#00a7e0"}),s.createElement("stop",{offset:.512,stopColor:"#00b8e0"}),s.createElement("stop",{offset:.76,stopColor:"#00c4e0"}),s.createElement("stop",{offset:1,stopColor:"#00c7e0"})),s.createElement("linearGradient",{id:"google-play_svg__h",x2:1,gradientTransform:"scale(-42.903 42.903)rotate(45 -1.222 -.585)",gradientUnits:"userSpaceOnUse"},s.createElement("stop",{offset:0,stopColor:"#e0333c"}),s.createElement("stop",{offset:1,stopColor:"#ab0f56"})),s.createElement("linearGradient",{id:"google-play_svg__i",x2:1,gradientTransform:"matrix(-32.255 0 0 32.255 45.098 26.675)",gradientUnits:"userSpaceOnUse"},s.createElement("stop",{offset:0,stopColor:"#e0c500"}),s.createElement("stop",{offset:.409,stopColor:"#e0a600"}),s.createElement("stop",{offset:.775,stopColor:"#e09100"}),s.createElement("stop",{offset:1,stopColor:"#e08900"})),s.createElement("linearGradient",{id:"google-play_svg__j",x2:1,gradientTransform:"matrix(-32.255 0 0 32.255 45.098 26.675)",gradientUnits:"userSpaceOnUse"},s.createElement("stop",{offset:0,stopColor:"#ffe840"}),s.createElement("stop",{offset:.409,stopColor:"#ffce40"}),s.createElement("stop",{offset:.775,stopColor:"#ffbc40"}),s.createElement("stop",{offset:1,stopColor:"#ffb540"})),s.createElement("linearGradient",{id:"google-play_svg__k",x2:1,gradientTransform:"scale(-31.64 31.64)rotate(45 -.903 -.925)",gradientUnits:"userSpaceOnUse"},s.createElement("stop",{offset:0,stopColor:"#40b8ff"}),s.createElement("stop",{offset:.007,stopColor:"#40b9ff"}),s.createElement("stop",{offset:.26,stopColor:"#40ceff"}),s.createElement("stop",{offset:.512,stopColor:"#40ddff"}),s.createElement("stop",{offset:.76,stopColor:"#40e7ff"}),s.createElement("stop",{offset:1,stopColor:"#40eaff"})),s.createElement("linearGradient",{id:"google-play_svg__l",x2:1,gradientTransform:"scale(19.156 -19.156)rotate(-44.998 .238 -.62)",gradientUnits:"userSpaceOnUse"},s.createElement("stop",{offset:0,stopColor:"#65b895"}),s.createElement("stop",{offset:.069,stopColor:"#62bd95"}),s.createElement("stop",{offset:.476,stopColor:"#50db97"}),s.createElement("stop",{offset:.801,stopColor:"#44ed98"}),s.createElement("stop",{offset:1,stopColor:"#40f498"})))),Kc||(Kc=s.createElement("path",{d:"M173.33 53.332H6.67c-3.667 0-6.667-3-6.667-6.667V6.668c0-3.667 3-6.667 6.667-6.667h166.66c3.667 0 6.667 3 6.667 6.667v39.997c0 3.666-3 6.666-6.667 6.666"})),Jc||(Jc=s.createElement("path",{fill:"#fff",d:"M101.93 17.465v-5.118l-.044-1.544-.202.074 4.107 6.588h1.28V9.199h-1.295v4.816l.044 1.544.202-.074-3.927-6.286h-1.458v8.266"})),qc||(qc=s.createElement("path",{fill:"#a6a6a6",d:"M173.33 0H6.67C3.003 0 .003 3 .003 6.666v40c0 3.666 3 6.666 6.667 6.666h166.66c3.667 0 6.667-3 6.667-6.667V6.668c0-3.667-3-6.667-6.667-6.667m0 1.067c3.088 0 5.6 2.512 5.6 5.6v39.997c0 3.087-2.512 5.6-5.6 5.6H6.67a5.607 5.607 0 0 1-5.6-5.6v-40c0-3.087 2.512-5.6 5.6-5.6h166.66"})),$c||($c=s.createElement("path",{fill:"#fff",d:"M63.356 13.657q0-.303-.058-.628l-.02-.11h-4.121v1.229h3.038v-.134l-.133-.011c-.058.67-.272 1.176-.632 1.537-.573.571-1.276.853-2.14.854-.81 0-1.499-.28-2.092-.85-.587-.568-.88-1.294-.881-2.212.001-.917.294-1.643.881-2.21.593-.571 1.281-.85 2.092-.851.902.002 1.582.3 2.088.901l.094.112.806-.807.086-.087-.079-.093c-.327-.39-.764-.7-1.3-.93a4.3 4.3 0 0 0-1.695-.347c-1.185-.001-2.208.416-3.038 1.24-.833.823-1.252 1.857-1.251 3.072-.001 1.215.418 2.25 1.252 3.073.829.824 1.852 1.24 3.037 1.24 1.234 0 2.258-.41 3.036-1.226l-.003.002c.691-.69 1.034-1.622 1.033-2.764M69.502 9.2h-4.937v8.265h4.937v-1.25h-3.643v-2.27h3.286v-1.227h-3.286v-2.27h3.643m4.335 0h2.234v-1.25h-5.764v1.25h2.235v7.017h1.295m7.239 0V9.199h-1.294v8.266m5.853-7.017h2.235v-1.25h-5.764v1.25h2.234v7.017h1.295m6.652-4.132c0-.903.284-1.627.85-2.203.57-.575 1.252-.858 2.078-.86.825.002 1.509.285 2.078.86.566.576.85 1.3.85 2.203s-.284 1.627-.85 2.202c-.57.576-1.253.858-2.078.86-.826-.002-1.508-.284-2.076-.86s-.852-1.3-.852-2.202m5.957 3.058c.808-.83 1.217-1.86 1.216-3.058 0-1.193-.41-2.22-1.221-3.054-.813-.837-1.83-1.26-3.024-1.259-1.2-.001-2.221.42-3.028 1.254-.81.83-1.217 1.86-1.216 3.059-.001 1.199.406 2.228 1.214 3.06s1.83 1.253 3.03 1.251c1.2.002 2.22-.419 3.029-1.253m-7.387 12.612c-3.136 0-5.693 2.384-5.693 5.67 0 3.266 2.557 5.67 5.693 5.67s5.691-2.405 5.691-5.67c0-3.287-2.555-5.67-5.691-5.67m0 2.232c1.719 0 3.2 1.397 3.2 3.438 0 2.019-1.481 3.435-3.2 3.435-1.718 0-3.201-1.416-3.201-3.435 0-2.041 1.483-3.438 3.201-3.438m-12.422-2.232c-3.136 0-5.693 2.384-5.693 5.67 0 3.266 2.557 5.67 5.693 5.67s5.693-2.405 5.693-5.67c0-3.287-2.557-5.67-5.693-5.67m0 2.232c1.718 0 3.201 1.397 3.201 3.438 0 2.019-1.483 3.435-3.201 3.435-1.719 0-3.2-1.416-3.2-3.435 0-2.041 1.481-3.438 3.2-3.438m-14.772-.494v2.407h5.757c-.172 1.353-.623 2.34-1.31 3.028-.838.838-2.148 1.762-4.447 1.762-3.544 0-6.315-2.857-6.315-6.401s2.771-6.402 6.315-6.402c1.912 0 3.308.752 4.34 1.719l1.696-1.697c-1.439-1.375-3.35-2.427-6.036-2.427-4.854 0-8.935 3.952-8.935 8.807s4.08 8.806 8.935 8.806c2.621 0 4.597-.859 6.143-2.47 1.59-1.59 2.084-3.823 2.084-5.627 0-.56-.043-1.074-.129-1.504zm55.554-1.74c-2.921 0-5.348 2.3-5.348 5.672 0 3.179 2.405 5.67 5.627 5.67 2.6 0 4.105-1.59 4.727-2.514l-1.934-1.287c-.644.946-1.525 1.566-2.793 1.566-1.267 0-2.17-.578-2.75-1.716l7.582-3.137-.256-.645c-.472-1.268-1.912-3.609-4.855-3.609m.086 2.191c.989 0 1.826.495 2.105 1.203l-5.068 2.106c-.065-2.191 1.696-3.309 2.963-3.309m-9.126 8.807h2.493V23.332h-2.492zm-7.15-10.996c-2.835 0-5.434 2.49-5.434 5.691 0 3.18 2.599 5.65 5.434 5.65 1.353 0 2.428-.602 2.986-1.29h.086v.816c0 2.17-1.16 3.33-3.03 3.33-1.524 0-2.47-1.095-2.856-2.02l-2.17.903c.624 1.504 2.278 3.352 5.027 3.352 2.921 0 5.39-1.72 5.39-5.908v-10.18h-2.36v.921h-.087c-.558-.666-1.633-1.265-2.986-1.265m.215 2.232c1.697 0 3.03 1.461 3.03 3.46 0 1.975-1.333 3.414-3.03 3.414-1.72 0-3.158-1.439-3.158-3.415 0-1.997 1.44-3.459 3.158-3.459m26.545-7.904v16.668h2.486v-6.315h3.475c2.758 0 5.469-1.997 5.469-5.177s-2.711-5.176-5.47-5.176zm2.486 2.32h3.54c1.86 0 2.915 1.54 2.915 2.858 0 1.29-1.056 2.855-2.916 2.855h-3.539zm18.914 3.321c-1.8 0-3.667.792-4.44 2.55l2.21.923c.472-.922 1.349-1.223 2.273-1.223 1.286 0 2.594.773 2.615 2.144v.172c-.45-.257-1.414-.642-2.594-.642-2.38 0-4.804 1.308-4.804 3.752 0 2.23 1.951 3.668 4.138 3.668 1.673 0 2.596-.751 3.176-1.631h.084v1.287h2.402v-6.39c0-2.96-2.208-4.61-5.06-4.61m.385 5.938c1.095 0 1.608.236 2.273.558-.193 1.544-1.52 2.639-2.957 2.639l-.002-.002c-.815 0-1.951-.405-1.951-1.414 0-1.286 1.416-1.781 2.637-1.781m13.415-5.575-2.852 7.227h-.085l-2.96-7.227h-2.68l4.438 10.1-2.53 5.619h2.596l6.84-15.719zm-22.4 10.664h2.488V23.331h-2.488z"})),Yc||(Yc=s.createElement("path",{fill:"url(#google-play_svg__a)",d:"m14.007 43.191-.099-.095c-.388-.41-.617-1.047-.617-1.873v.194V11.93v.203c0-.894.267-1.567.714-1.97l16.516 16.515-16.515 16.515m-.71-31.48v-.004.003m0-.01"})),Zc||(Zc=s.createElement("path",{fill:"url(#google-play_svg__b)",d:"m36.025 32.378.126-.071 6.522-3.706c.622-.354 1.036-.782 1.243-1.236-.206.454-.621.883-1.243 1.236l-6.522 3.706zm.002-.195-5.506-5.507 5.505-5.506 6.647 3.776c.844.48 1.318 1.098 1.397 1.73v.002c-.08.63-.553 1.248-1.397 1.728z"})),Xc||(Xc=s.createElement("path",{fill:"url(#google-play_svg__c)",d:"M15.184 43.819a1.723 1.723 0 0 0 .002 0zm0-.195c-.46 0-.863-.15-1.177-.433l16.515-16.516 5.506 5.507L16.68 43.176c-.536.304-1.043.447-1.494.447m-1.182-.241-.086-.084z"})),Qc||(Qc=s.createElement("path",{fill:"url(#google-play_svg__d)",d:"M30.52 26.676 14.004 10.16a1.72 1.72 0 0 1 1.177-.433c.452 0 .96.145 1.496.449L36.025 21.17l-5.506 5.506m5.63-5.63L16.677 9.98c-.536-.304-1.044-.448-1.496-.448h-.005.007c.451 0 .959.144 1.494.448z"})),ed||(ed=s.createElement("path",{d:"M15.313 43.811c.42-.024.883-.168 1.371-.445l19.353-10.995-19.353 10.994c-.487.277-.952.42-1.371.445m-1.301-.43-.004-.004zm-.09-.088-.009-.008q.005.004.009.008"})),td||(td=s.createElement("path",{fill:"url(#google-play_svg__e)",d:"m36.025 32.378.126-.071z"})),nd||(nd=s.createElement("path",{fill:"url(#google-play_svg__f)",d:"M15.185 43.819c-.461 0-.864-.15-1.178-.434l-.005-.003-.086-.084-.008-.008.099-.1c.314.284.716.434 1.177.434.451 0 .958-.144 1.494-.448l19.348-10.994.124.124-.126.072L16.677 43.37c-.488.276-.952.42-1.37.444l-.123.004"})),id||(id=s.createElement("path",{d:"M13.914 43.285c-.388-.411-.617-1.049-.617-1.874 0 .825.23 1.462.617 1.873"})),rd||(rd=s.createElement("path",{fill:"url(#google-play_svg__g)",d:"M13.908 43.29c-.388-.41-.617-1.047-.617-1.873v-.194c0 .825.23 1.462.617 1.873l.099.095z"})),sd||(sd=s.createElement("path",{fill:"url(#google-play_svg__h)",d:"m13.908 43.29.099-.1v.001z"})),od||(od=s.createElement("path",{fill:"url(#google-play_svg__i)",d:"m36.151 32.307-.124-.124 6.646-3.777c.844-.48 1.318-1.098 1.397-1.728q0 .349-.154.688c-.207.453-.62.882-1.243 1.235z"})),ad||(ad=s.createElement("path",{fill:"#404040",d:"M44.083 26.667c0-.698-.467-1.395-1.398-1.924l-6.523-3.707 6.523 3.706c.932.53 1.399 1.228 1.398 1.925"})),ld||(ld=s.createElement("path",{fill:"url(#google-play_svg__j)",d:"M44.07 26.675c-.08-.632-.553-1.25-1.397-1.73l-6.647-3.775.124-.124 6.523 3.706c.93.529 1.397 1.226 1.397 1.923"})),cd||(cd=s.createElement("path",{fill:"#404040",d:"M13.297 11.917v-.002zm.006-.217v-.003zm0-.006v-.006zm0-.008c.077-1.37.822-2.16 1.876-2.165a1.72 1.72 0 0 0-1.166.433l-.004.003q-.049.045-.095.093c-.35.37-.57.925-.61 1.636"})),dd||(dd=s.createElement("path",{fill:"url(#google-play_svg__k)",d:"M13.291 12.132v-.204q0-.11.006-.215V11.7c.04-.71.261-1.265.61-1.635l.098.097c-.447.404-.714 1.077-.714 1.97m.712-2.16.003-.004z"})),ud||(ud=s.createElement("path",{fill:"#404040",d:"M15.178 9.521h.004z"})),md||(md=s.createElement("path",{fill:"url(#google-play_svg__l)",d:"M36.025 21.17 16.677 10.176c-.536-.304-1.044-.448-1.496-.448-.46 0-.863.15-1.177.432l-.097-.097a2 2 0 0 1 .095-.094l.003-.003c.312-.28.71-.43 1.166-.433h.01c.452 0 .96.144 1.496.448l19.472 11.064z"})))},gd=(0,s.forwardRef)(hd);var vd,fd,_d;function yd(){return yd=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},yd.apply(null,arguments)}var bd=function(e,t){return s.createElement("svg",yd({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 159.55 53.333",role:"presentation","aria-hidden":!0,ref:t},e),vd||(vd=s.createElement("path",{fill:"#b2b1b1",d:"M146.84.001H12.71c-.489 0-.972 0-1.46.003-.407.002-.812.01-1.224.016-.888.023-1.786.077-2.672.236a8.9 8.9 0 0 0-2.535.836A8.58 8.58 0 0 0 1.09 4.825a8.8 8.8 0 0 0-.833 2.538c-.16.883-.216 1.776-.24 2.669-.012.409-.013.82-.02 1.228v30.818c.007.414.008.815.02 1.23.024.893.08 1.786.24 2.669.155.893.418 1.73.833 2.539a8.3 8.3 0 0 0 1.571 2.152 8.4 8.4 0 0 0 2.158 1.571 9 9 0 0 0 2.535.842c.886.158 1.784.21 2.672.235.412.01.817.015 1.225.015.488.002.97.002 1.46.002h134.13c.48 0 .966 0 1.445-.002.408 0 .824-.006 1.23-.015.894-.025 1.79-.077 2.667-.235a9 9 0 0 0 2.544-.842 8.4 8.4 0 0 0 2.157-1.57 8.6 8.6 0 0 0 1.573-2.153c.41-.809.676-1.646.826-2.54.165-.882.216-1.775.249-2.669.004-.414.004-.815.004-1.229.01-.484.01-.966.01-1.458V12.715c0-.488 0-.972-.01-1.455q.001-.615-.004-1.228c-.033-.893-.084-1.786-.25-2.67a8.8 8.8 0 0 0-.825-2.537 8.6 8.6 0 0 0-1.573-2.162 8.6 8.6 0 0 0-2.157-1.57 9 9 0 0 0-2.544-.837c-.877-.159-1.773-.213-2.667-.236-.406-.006-.822-.014-1.23-.016C147.807 0 147.322 0 146.84 0"})),fd||(fd=s.createElement("path",{fill:"#040403",d:"M11.267 52.166c-.407 0-.803-.005-1.206-.014-.745-.021-1.63-.062-2.492-.217a7.9 7.9 0 0 1-2.21-.731 7.2 7.2 0 0 1-1.862-1.355 7.1 7.1 0 0 1-1.36-1.862 7.6 7.6 0 0 1-.724-2.21c-.163-.897-.205-1.807-.222-2.5-.01-.28-.02-1.217-.02-1.217v-30.8s.012-.922.02-1.193c.017-.698.059-1.607.22-2.495.143-.818.38-1.54.725-2.216.354-.7.808-1.325 1.353-1.864a7.4 7.4 0 0 1 1.87-1.363 7.8 7.8 0 0 1 2.204-.726c.898-.16 1.808-.2 2.5-.219l1.204-.016h137.02l1.217.017c.684.017 1.595.057 2.48.217.802.14 1.53.38 2.227.73.684.35 1.31.808 1.855 1.354a7.4 7.4 0 0 1 1.365 1.873c.344.681.577 1.403.715 2.198.153.841.2 1.705.23 2.517.004.377.004.783.004 1.187.012.5.012.975.012 1.455V40.62c0 .485 0 .957-.012 1.434 0 .434 0 .831-.005 1.24-.028.785-.076 1.648-.228 2.47a7.7 7.7 0 0 1-.72 2.228 7.3 7.3 0 0 1-1.353 1.847 7.3 7.3 0 0 1-1.866 1.363 7.9 7.9 0 0 1-2.225.733c-.853.155-1.737.197-2.492.218-.39.009-.8.014-1.197.014l-1.445.003-135.58-.003"})),_d||(_d=s.createElement("path",{fill:"#fff",d:"M33.032 27.068c-.034-3.668 3.002-5.452 3.141-5.536-1.72-2.507-4.385-2.85-5.321-2.877-2.239-.235-4.41 1.34-5.551 1.34-1.162 0-2.92-1.317-4.81-1.278-2.436.038-4.715 1.448-5.964 3.638-2.579 4.464-.656 11.026 1.814 14.633 1.236 1.769 2.68 3.742 4.57 3.672 1.85-.077 2.54-1.18 4.773-1.18 2.212 0 2.86 1.18 4.788 1.135 1.984-.032 3.235-1.775 4.427-3.559 1.428-2.026 2.002-4.02 2.024-4.123-.046-.016-3.854-1.469-3.891-5.865m-3.643-10.786c.994-1.244 1.675-2.936 1.486-4.654-1.44.064-3.24.995-4.276 2.213-.918 1.072-1.738 2.83-1.526 4.481 1.618.12 3.278-.816 4.316-2.04m21.362 17.839h5.002l-2.466-7.261h-.068zm5.658 2.066h-6.312l-1.515 4.475h-2.673l5.977-16.557h2.778l5.977 16.557h-2.718zm14.596-1.56c0-2.444-1.263-4.05-3.19-4.05-1.893 0-3.166 1.64-3.166 4.05 0 2.432 1.273 4.061 3.166 4.061 1.927 0 3.19-1.595 3.19-4.061m2.547 0c0 3.751-2.008 6.161-5.038 6.161-1.72 0-3.086-.77-3.798-2.112h-.057v5.98h-2.478V28.591h2.398v2.007h.046c.689-1.295 2.157-2.134 3.844-2.134 3.063 0 5.083 2.422 5.083 6.162m10.738.001c0-2.444-1.263-4.05-3.19-4.05-1.893 0-3.166 1.64-3.166 4.05 0 2.432 1.273 4.061 3.166 4.061 1.927 0 3.19-1.595 3.19-4.061m2.547 0c0 3.751-2.008 6.161-5.038 6.161-1.72 0-3.086-.77-3.798-2.112h-.057v5.98h-2.478V28.591h2.398v2.007h.046c.689-1.295 2.157-2.134 3.844-2.134 3.063 0 5.083 2.422 5.083 6.162m8.78 1.422c.184 1.642 1.78 2.72 3.96 2.72 2.088 0 3.59-1.078 3.59-2.558 0-1.285-.906-2.055-3.052-2.582l-2.146-.517c-3.04-.735-4.451-2.157-4.451-4.463 0-2.857 2.489-4.82 6.024-4.82 3.499 0 5.897 1.963 5.978 4.82h-2.501c-.15-1.653-1.516-2.65-3.512-2.65s-3.362 1.01-3.362 2.477c0 1.171.873 1.86 3.007 2.387l1.824.448c3.397.804 4.808 2.168 4.808 4.59 0 3.097-2.467 5.038-6.392 5.038-3.671 0-6.15-1.895-6.31-4.89zm15.514-10.314v2.857h2.296v1.962h-2.296v6.655c0 1.034.46 1.515 1.469 1.515.253 0 .655-.035.815-.057v1.95c-.274.07-.826.115-1.376.115-2.444 0-3.397-.918-3.397-3.26v-6.918h-1.755V28.59h1.755v-2.857h2.49m12.551 8.894c0-2.605-1.194-4.143-3.202-4.143s-3.2 1.55-3.2 4.143c0 2.616 1.193 4.142 3.2 4.142s3.202-1.526 3.202-4.142m-8.927 0c0-3.798 2.237-6.184 5.725-6.184 3.5 0 5.727 2.386 5.727 6.184 0 3.809-2.215 6.185-5.727 6.185-3.51 0-5.725-2.376-5.725-6.185m13.495-6.036h2.363v2.055h.058c.378-1.367 1.48-2.182 2.903-2.182.356 0 .653.047.85.093v2.318c-.197-.082-.633-.15-1.114-.15-1.595 0-2.582 1.079-2.582 2.777v7.16h-2.478zm9.218 4.922h6.035c-.058-1.847-1.239-3.064-2.96-3.064-1.71 0-2.948 1.24-3.075 3.064m8.376 3.603c-.333 2.192-2.467 3.696-5.197 3.696-3.512 0-5.692-2.353-5.692-6.128 0-3.786 2.192-6.242 5.588-6.242 3.34 0 5.44 2.294 5.44 5.954v.85h-8.527v.15c0 2.064 1.298 3.418 3.248 3.418 1.376 0 2.456-.654 2.788-1.698zM48.803 18.473h1.5c1.664 0 2.623-1.037 2.623-2.862 0-1.797-.975-2.845-2.623-2.845h-1.5zm1.638-6.831c2.36 0 3.744 1.45 3.744 3.953 0 2.542-1.374 4.003-3.744 4.003h-2.873v-7.956zm9.583 4.951c0-1.301-.584-2.062-1.61-2.062-1.03 0-1.61.76-1.61 2.062 0 1.312.58 2.067 1.61 2.067 1.026 0 1.61-.76 1.61-2.067m-4.443 0c0-1.936 1.08-3.115 2.833-3.115 1.748 0 2.829 1.18 2.829 3.115 0 1.946-1.076 3.12-2.83 3.12-1.758 0-2.832-1.174-2.832-3.12m13.188 3.005H67.54l-1.24-4.422h-.095l-1.235 4.422h-1.218l-1.654-6.004h1.201l1.076 4.581h.088l1.234-4.58h1.138l1.234 4.58h.094l1.07-4.58h1.185zm3.042-6.004h1.14v.954h.089c.291-.667.888-1.07 1.791-1.07 1.34 0 2.078.805 2.078 2.233v3.887h-1.184v-3.59c0-.965-.42-1.444-1.296-1.444s-1.434.585-1.434 1.522v3.512h-1.184zm6.986-2.344h1.185v8.347h-1.185zm7.276 5.343c0-1.301-.585-2.062-1.61-2.062-1.03 0-1.61.76-1.61 2.062 0 1.312.58 2.067 1.61 2.067 1.025 0 1.61-.76 1.61-2.067m-4.444 0c0-1.936 1.08-3.115 2.833-3.115 1.749 0 2.83 1.18 2.83 3.115 0 1.946-1.076 3.12-2.83 3.12-1.758 0-2.833-1.174-2.833-3.12m10.769.794v-.501l-1.466.093c-.827.056-1.202.337-1.202.866 0 .54.47.855 1.113.855.894 0 1.555-.569 1.555-1.313m-3.86.513c0-1.08.805-1.703 2.234-1.792l1.626-.094v-.518c0-.634-.42-.992-1.23-.992-.66 0-1.119.243-1.25.667h-1.147c.12-1.031 1.09-1.693 2.453-1.693 1.505 0 2.354.75 2.354 2.018v4.102h-1.14v-.844h-.095c-.357.601-1.014.943-1.803.943-1.158 0-2.001-.7-2.001-1.797m7.82-1.307c0 1.273.6 2.04 1.604 2.04 1 0 1.617-.778 1.617-2.035 0-1.251-.624-2.04-1.617-2.04-.997 0-1.604.772-1.604 2.035m-1.224 0c0-1.897.976-3.1 2.492-3.1.822 0 1.516.392 1.842 1.054h.088V11.25h1.185v8.347h-1.135v-.948h-.094c-.358.656-1.058 1.047-1.886 1.047-1.527 0-2.492-1.201-2.492-3.103m14.953 0c0-1.301-.584-2.062-1.61-2.062-1.03 0-1.61.76-1.61 2.062 0 1.312.58 2.067 1.61 2.067 1.026 0 1.61-.76 1.61-2.067m-4.443 0c0-1.936 1.08-3.115 2.833-3.115 1.748 0 2.829 1.18 2.829 3.115 0 1.946-1.076 3.12-2.83 3.12-1.757 0-2.832-1.174-2.832-3.12m7.252-2.999h1.141v.954h.089c.291-.667.888-1.07 1.791-1.07 1.34 0 2.078.805 2.078 2.233v3.887h-1.184v-3.59c0-.965-.42-1.444-1.296-1.444s-1.434.585-1.434 1.522v3.512h-1.184zm11.793-1.494v1.521h1.3v.999h-1.3v3.087c0 .629.258.904.849.904.182 0 .286-.011.451-.027v.987c-.193.032-.414.06-.644.06-1.318 0-1.843-.464-1.843-1.621v-3.39h-.953v-.999h.953V12.1zm2.919-.85h1.175v3.308h.094c.291-.673.925-1.075 1.83-1.075 1.279 0 2.068.81 2.068 2.238v3.876h-1.186v-3.583c0-.96-.447-1.445-1.284-1.445-.972 0-1.512.612-1.512 1.522v3.506h-1.185zm7.914 4.792h3.033c-.028-.943-.601-1.555-1.479-1.555-.876 0-1.488.617-1.554 1.555m4.168 1.935c-.27 1.075-1.23 1.737-2.602 1.737-1.72 0-2.773-1.18-2.773-3.1 0-1.918 1.076-3.136 2.768-3.136 1.67 0 2.679 1.142 2.679 3.026v.414h-4.24v.067c.04 1.052.652 1.72 1.598 1.72.719 0 1.21-.26 1.43-.728z"})))},Ed=(0,s.forwardRef)(bd);var wd=n("./src/components/views/elements/QRCode.tsx");const Sd=({onFinished:e})=>{const t=u.Ay.get("brand"),n=u.Ay.getObject("desktop_builds"),i=u.Ay.getObject("mobile_builds"),r=null==i?void 0:i.get("ios"),o=null==i?void 0:i.get("android"),a=null==i?void 0:i.get("fdroid"),l=null!=o?o:a;return s.createElement(Pa.A,{title:(0,P._t)("onboarding|download_brand",{brand:t}),className:"mx_AppDownloadDialog",fixedWidth:!0,onFinished:e},(null==n?void 0:n.get("available"))&&s.createElement("div",{className:"mx_AppDownloadDialog_desktop"},s.createElement(uc.A,{size:"3"},(0,P._t)("onboarding|download_brand_desktop",{brand:t})),s.createElement(Ae.A,{kind:"primary",element:"a",href:null==n?void 0:n.get("url"),target:"_blank",onClick:()=>{}},(0,P._t)("onboarding|download_brand_desktop",{brand:t}))),s.createElement("div",{className:"mx_AppDownloadDialog_mobile"},r&&s.createElement("div",{className:"mx_AppDownloadDialog_app"},s.createElement(uc.A,{size:"3"},(0,P._t)("common|ios")),s.createElement(wd.A,{data:r,margin:0,width:172}),s.createElement("div",{className:"mx_AppDownloadDialog_info"},(0,P._t)("onboarding|qr_or_app_links",{appLinks:"",qrCode:""})),s.createElement("div",{className:"mx_AppDownloadDialog_links"},s.createElement(Ae.A,{element:"a",href:r,target:"_blank","aria-label":(0,P._t)("onboarding|download_app_store"),onClick:()=>{}},s.createElement(Ed,null)))),l&&s.createElement("div",{className:"mx_AppDownloadDialog_app"},s.createElement(uc.A,{size:"3"},(0,P._t)("common|android")),s.createElement(wd.A,{data:l,margin:0,width:172}),s.createElement("div",{className:"mx_AppDownloadDialog_info"},(0,P._t)("onboarding|qr_or_app_links",{appLinks:"",qrCode:""})),s.createElement("div",{className:"mx_AppDownloadDialog_links"},o&&s.createElement(Ae.A,{element:"a",href:o,target:"_blank","aria-label":(0,P._t)("onboarding|download_google_play"),onClick:()=>{}},s.createElement(gd,null)),a&&s.createElement(Ae.A,{element:"a",href:a,target:"_blank","aria-label":(0,P._t)("onboarding|download_f_droid"),onClick:()=>{}},s.createElement(Hc,null))))),s.createElement("div",{className:"mx_AppDownloadDialog_legal"},s.createElement("p",null,(0,P._t)("onboarding|apple_trademarks")),s.createElement("p",null,(0,P._t)("onboarding|google_trademarks"))))};let Ad=function(e){return e.PersonalMessaging="PersonalMessaging",e.WorkMessaging="WorkMessaging",e.CommunityMessaging="CommunityMessaging",e.Skip="Skip",e}({});function Cd(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function xd(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Cd(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Cd(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const kd=e=>{y.A.trackInteraction("WebUserOnboardingTaskSendDm",e),w.A.dispatch({action:"view_create_chat"})},Rd=[{id:"check-user-guide",title:(0,P._t)("onboarding|check_user_guide"),description:(0,P._t)("onboarding|check_user_guide_description"),completed:e=>e.hasCheckedUserGuide,action:{label:(0,P._t)("onboarding|check_user_guide_action"),onClick:e=>{window.localStorage.setItem("tchap_user_guide_checked","true"),window.open(zl.A.helpUserOnboarding,"_blank")}}},{id:"enable-secure-backup",title:(0,P._t)("onboarding|enable_secure_backup"),description:(0,P._t)("onboarding|enable_secure_backup_description"),completed:e=>e.hasSecureStorage,action:{label:(0,P._t)("onboarding|enable_secure_backup_action"),onClick:e=>{accessSecretStorage()}}},{id:"setup-profile",title:(0,P._t)("onboarding|set_up_profile"),description:(0,P._t)("onboarding|set_up_profile_description"),completed:e=>e.hasAvatar,action:{label:(0,P._t)("onboarding|set_up_profile_action"),onClick:e=>{y.A.trackInteraction("WebUserOnboardingTaskSetupProfile",e),w.A.dispatch({action:R.r.ViewUserSettings,initialTabId:wa.v.General})}}},{id:"find-friends",title:(0,P._t)("onboarding|find_friends"),description:(0,P._t)("onboarding|find_friends_description"),completed:e=>e.hasDmRooms,relevant:[Ad.PersonalMessaging,Ad.Skip],action:{label:(0,P._t)("onboarding|find_friends_action"),onClick:kd}},{id:"find-coworkers",title:(0,P._t)("onboarding|find_coworkers"),description:(0,P._t)("onboarding|get_stuff_done"),completed:e=>e.hasDmRooms,relevant:[Ad.WorkMessaging],action:{label:(0,P._t)("onboarding|find_people"),onClick:kd}},{id:"find-community-members",title:(0,P._t)("onboarding|find_community_members"),description:(0,P._t)("onboarding|get_stuff_done"),completed:e=>e.hasDmRooms,relevant:[Ad.CommunityMessaging],action:{label:(0,P._t)("onboarding|find_people"),onClick:kd}},{id:"download-apps",title:()=>(0,P._t)("onboarding|download_app",{brand:u.Ay.get("brand")}),description:()=>(0,P._t)("onboarding|download_app_description",{brand:u.Ay.get("brand")}),completed:e=>e.hasDevices,action:{label:(0,P._t)("onboarding|download_app_action"),onClick:e=>{y.A.trackInteraction("WebUserOnboardingTaskDownloadApps",e),A.Ay.createDialog(Sd,{},"mx_AppDownloadDialog_wrapper",!1,!0)}},disabled:()=>!(()=>{const e=u.Ay.getObject("desktop_builds"),t=u.Ay.getObject("mobile_builds");return!!(null!=e&&e.get("available")||null!=t&&t.get("ios")||null!=t&&t.get("android")||null!=t&&t.get("fdroid"))})()}];function Id(e){var t;const n=null!==(t=(0,Oe.ti)("FTUE.useCaseSelection"))&&void 0!==t?t:Ad.Skip;return(0,s.useMemo)((()=>Rd.filter((e=>{var t;return(null===(t=e.disabled)||void 0===t||!t.call(e))&&(!e.relevant||e.relevant.includes(n))})).map((t=>xd(xd({},t),{},{completed:t.completed(e)})))),[e,n])}var Td=n("./node_modules/sanitize-html/index.js"),Pd=n.n(Td);class Nd extends s.PureComponent{constructor(e,t){super(e,t),(0,h.A)(this,"unmounted",!1),(0,h.A)(this,"dispatcherRef",void 0),(0,h.A)(this,"onAction",(e=>{"client_started"===e.action&&this.forceUpdate()})),this.state={page:""}}translate(e){return Pd()((0,P._t)(e))}async fetchEmbed(){let e;try{e=await fetch(this.props.url,{method:"GET"})}catch(e){if(this.unmounted)return;return o.v.warn(`Error loading page: ${e}`),void this.setState({page:(0,P._t)("cant_load_page")})}if(this.unmounted)return;if(!e.ok)return o.v.warn(`Error loading page: ${e.status}`),void this.setState({page:(0,P._t)("cant_load_page")});let t=(await e.text()).replace(/_t\(['"]([\s\S]*?)['"]\)/gm,((e,t)=>this.translate(t)));this.props.replaceMap&&Object.keys(this.props.replaceMap).forEach((e=>{t=t.split(e).join(this.props.replaceMap[e])})),this.setState({page:t})}componentDidMount(){this.unmounted=!1,this.props.url&&(this.fetchEmbed(),this.dispatcherRef=w.A.register(this.onAction))}componentWillUnmount(){this.unmounted=!0,w.A.unregister(this.dispatcherRef)}render(){const e=this.context||E.J.get(),t=!e||e.isGuest(),n=this.props.className,i=re()(n,{[`${n}_guest`]:t,[`${n}_loggedIn`]:!!e}),r=s.createElement("div",{className:`${n}_body`,dangerouslySetInnerHTML:{__html:this.state.page}});return this.props.scrollbar?s.createElement(Ka.A,{className:i},r):s.createElement("div",{className:i},r)}}(0,h.A)(Nd,"contextType",Pe.Ay);var Dd=n("./src/hooks/useTimeout.ts"),Md=n("./src/utils/BrowserWorkarounds.ts"),Od=n("./src/components/views/settings/AvatarSetting.tsx"),Ld=n("./src/contexts/ScopedRoomContext.tsx");const Fd="52px",Ud=({hasAvatar:e,hasAvatarLabel:t,noAvatarLabel:n,setAvatarUrl:r,isUserAvatar:o,children:a,onClick:l})=>{var c;const d=(0,s.useContext)(Pe.Ay),[u,m]=(0,s.useState)(!1),[p,h]=(0,s.useState)(!1),[g,v]=(0,s.useState)(!1);(0,Dd.Z3)((()=>{v(!0)}),3e3),(0,Dd.Z3)((()=>{v(!1)}),13e3);const f=(0,s.useRef)(null),_=e||u?t:n,{room:y}=(0,Ld.ME)("room");if(!(o||(null==y||null===(c=y.currentState)||void 0===c?void 0:c.maySendStateEvent(i.EventType.RoomAvatar,d.getSafeUserId()))))return s.createElement(s.Fragment,null,a);const b=!!_&&(p||g);return s.createElement(s.Fragment,null,s.createElement("input",{type:"file",ref:f,className:"mx_MiniAvatarUploader_input",onClick:e=>{(0,Md.e)(e),null==l||l(e)},onChange:async e=>{m(!0);const t=(0,Od.B)(e);if(t){const{content_uri:e}=await d.uploadContent(t);await r(e)}m(!1)},accept:"image/*"}),s.createElement(Te.m,{label:_,open:b,onOpenChange:h},s.createElement(Ae.A,{className:re()("mx_MiniAvatarUploader",{mx_MiniAvatarUploader_busy:u,mx_MiniAvatarUploader_hasAvatar:e}),disabled:u,onClick:()=>{var e;null===(e=f.current)||void 0===e||e.click()}},a,s.createElement("div",{className:"mx_MiniAvatarUploader_indicator"},u?s.createElement(Na.A,{w:20,h:20}):s.createElement("div",{className:"mx_MiniAvatarUploader_cameraIcon"})))))},Bd=e=>{y.A.trackInteraction("WebHomeCreateChatButton",e),w.A.dispatch({action:"view_create_chat"})},Vd=e=>{y.A.trackInteraction("WebHomeExploreRoomsButton",e),w.A.fire(R.r.ViewRoomDirectory)},jd=e=>{y.A.trackInteraction("WebHomeCreateRoomButton",e),w.A.dispatch({action:"view_create_room"})},zd=e=>{var t;return{displayName:Va.V.instance.displayName||e,avatarUrl:null!==(t=Va.V.instance.getHttpAvatarUrl(parseInt(Fd,10)))&&void 0!==t?t:void 0}},Wd=()=>{const e=(0,s.useContext)(Pe.Ay),t=e.getUserId(),[n,i]=(0,s.useState)(zd(t));return(0,Me.ml)(Va.V.instance,I.H,(()=>{i(zd(t))})),s.createElement("div",null,s.createElement(Ud,{hasAvatar:!!n.avatarUrl,hasAvatarLabel:(0,P._t)("onboarding|has_avatar_label"),noAvatarLabel:(0,P._t)("onboarding|no_avatar_label"),setAvatarUrl:t=>e.setAvatarUrl(t),isUserAvatar:!0,onClick:e=>y.A.trackInteraction("WebHomeMiniAvatarUploadButton",e)},s.createElement(ja.A,{idName:t,name:n.displayName,url:n.avatarUrl,size:Fd})),s.createElement("h1",null,(0,P._3)("onboarding|welcome_user",{name:n.displayName})),s.createElement("h2",null,(0,P._3)("onboarding|welcome_detail")))},Hd=({justRegistered:e=!1})=>{const t=(0,Pe.nH)(),n=u.Ay.get(),i=Ba(n,t);if(i)return s.createElement(Nd,{className:"mx_HomePage",url:i,scrollbar:!0});let r;if(e||!Va.V.instance.getHttpAvatarUrl(parseInt(Fd,10)))r=s.createElement(Wd,null);else{var o;const e=u.Ay.getObject("branding"),t=null!==(o=null==e?void 0:e.get("auth_header_logo_url"))&&void 0!==o?o:"themes/element/img/logos/element-logo.svg";r=s.createElement(s.Fragment,null,s.createElement("img",{src:t,alt:n.brand}),s.createElement("h1",null,(0,P._3)("onboarding|intro_welcome",{appName:n.brand})),s.createElement("h2",null,(0,P._3)("onboarding|intro_byline")))}return s.createElement(Ka.A,{className:"mx_HomePage mx_HomePage_default",element:"main"},s.createElement("div",{className:"mx_HomePage_default_wrapper"},r,s.createElement("div",{className:"mx_HomePage_default_buttons"},s.createElement(Ae.A,{onClick:Bd,className:"mx_HomePage_button_sendDm"},(0,P._3)("onboarding|send_dm")),s.createElement(Ae.A,{onClick:Vd,className:"mx_HomePage_button_explore"},(0,P._3)("onboarding|explore_rooms")),s.createElement(Ae.A,{onClick:jd,className:"mx_HomePage_button_createGroup"},(0,P._3)("onboarding|create_room")))))},Gd=e=>{y.A.trackInteraction("WebUserOnboardingHeaderSendDm",e),w.A.dispatch({action:"view_create_chat"})};function Kd({useCase:e}){let t,i,r,o=(0,P._t)("onboarding|free_e2ee_messaging_unlimited_voip",{brand:u.Ay.get("brand")});switch(e){case Ad.PersonalMessaging:t=(0,P._t)("onboarding|personal_messaging_title"),i=n("./res/img/user-onboarding/PersonalMessaging.png"),r=(0,P._t)("onboarding|personal_messaging_action");break;case Ad.WorkMessaging:t=(0,P._t)("onboarding|work_messaging_title"),o=(0,P._t)("onboarding|free_e2ee_messaging_unlimited_voip",{brand:u.Ay.get("brand")}),i=n("./res/img/tchap/multi-device-messaging.png"),r=(0,P._t)("onboarding|work_messaging_action");break;case Ad.CommunityMessaging:t=(0,P._t)("onboarding|community_messaging_title"),o=(0,P._t)("onboarding|community_messaging_description"),i=n("./res/img/user-onboarding/CommunityMessaging.png"),r=(0,P._t)("onboarding|community_messaging_action");break;default:t=(0,P._t)("onboarding|welcome_to_brand",{brand:u.Ay.get("brand")}),i=n("./res/img/user-onboarding/PersonalMessaging.png"),r=(0,P._t)("onboarding|personal_messaging_action")}return s.createElement("div",{className:"mx_UserOnboardingHeader"},s.createElement("div",{className:"mx_UserOnboardingHeader_content"},s.createElement(uc.A,{size:"1"},t,s.createElement("span",{className:"mx_UserOnboardingHeader_dot"},".")),s.createElement("p",null,o),s.createElement(Ae.A,{onClick:Gd,kind:"primary"},r)),s.createElement("img",{className:"mx_UserOnboardingHeader_image",src:i,alt:""}))}var Jd=n("./src/components/views/elements/ProgressBar.tsx");function qd({task:e,completed:t=!1}){var n;const i="function"==typeof e.title?e.title():e.title,r="function"==typeof e.description?e.description():e.description;return s.createElement("li",{className:re()("mx_UserOnboardingTask",{mx_UserOnboardingTask_completed:t})},s.createElement("div",{className:"mx_UserOnboardingTask_number",role:"checkbox","aria-disabled":"true","aria-checked":t,"aria-labelledby":`mx_UserOnboardingTask_${e.id}`}),s.createElement("div",{id:`mx_UserOnboardingTask_${e.id}`,className:"mx_UserOnboardingTask_content"},s.createElement(uc.A,{size:"4",className:"mx_UserOnboardingTask_title"},i),s.createElement("div",{className:"mx_UserOnboardingTask_description"},r)),e.action&&(!e.action.hideOnComplete||!t)&&s.createElement(Ae.A,{element:"a",className:"mx_UserOnboardingTask_action",kind:"primary_outline",href:e.action.href,target:"_blank",onClick:null!==(n=e.action.onClick)&&void 0!==n?n:null},e.action.label))}function $d({tasks:e}){const{completed:t,waiting:n,total:i}=(e=>{const t=e.filter((e=>!0===e.completed)).length,n=e.filter((e=>!1===e.completed)).length;return{completed:t,waiting:n,total:t+n}})(e);return s.createElement("div",{className:"mx_UserOnboardingList"},s.createElement("div",{className:"mx_UserOnboardingList_header"},s.createElement(uc.A,{size:"3",className:"mx_UserOnboardingList_title"},n>0?(0,P._t)("onboarding|only_n_steps_to_go",{count:n}):(0,P._t)("onboarding|you_did_it")),s.createElement("div",{className:"mx_UserOnboardingList_hint"},(0,P._t)("onboarding|complete_these",{brand:u.Ay.get("brand")}))),s.createElement("div",{className:"mx_UserOnboardingList_progress"},s.createElement(Jd.A,{value:t,max:i,animated:!0})),s.createElement("ol",{className:"mx_UserOnboardingList_list"},e.map((e=>s.createElement(qd,{key:e.id,completed:e.completed,task:e})))))}const Yd=new Date(1656633600);function Zd(e){return null!==e||E.J.userRegisteredAfter(Yd)}function Xd({justRegistered:e=!1}){const t=(0,Pe.nH)(),n=Ba(u.Ay.get(),t),r=(0,Oe.ti)("FTUE.useCaseSelection"),o=Id(hc()),a=function(){const e=(0,Pe.nH)();return(0,Me.dF)(e,i.ClientEvent.Sync,(()=>e.isInitialSyncComplete()))}(),[l,c]=(0,s.useState)(!1);return(0,s.useEffect)((()=>{if(a){const e=window.setTimeout((()=>{c(!0)}),2800);return()=>{clearTimeout(e)}}c(!1)}),[a,c]),Zd(r)?n?s.createElement(Nd,{className:"mx_HomePage",url:n,scrollbar:!0}):s.createElement(Ka.A,{className:"mx_UserOnboardingPage"},s.createElement(Kd,{useCase:r}),l&&s.createElement($d,{tasks:o})):s.createElement(Hd,{justRegistered:e})}function Qd({selected:e,minimized:t}){const n=(0,Oe.ti)("FTUE.useCaseSelection");return(0,Oe.ti)("FTUE.userOnboardingButton")&&!t&&Zd(n)?s.createElement(eu,{selected:e,minimized:t}):s.createElement(s.Fragment,null)}function eu({selected:e,minimized:t}){const n=(0,s.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),y.A.trackInteraction("WebRoomListUserOnboardingIgnoreButton",e),V.A.setValue("FTUE.userOnboardingButton",null,ae.p.ACCOUNT,!1)}),[]),i=(0,s.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),y.A.trackInteraction("WebRoomListUserOnboardingButton",e),w.A.fire(R.r.ViewHomePage)}),[]);return s.createElement(Ae.A,{className:re()("mx_UserOnboardingButton",{mx_UserOnboardingButton_selected:e,mx_UserOnboardingButton_minimized:t}),onClick:i},!t&&s.createElement(s.Fragment,null,s.createElement("div",{className:"mx_UserOnboardingButton_content"},s.createElement(uc.A,{size:"4",className:"mx_Heading_h4"},(0,P._t)("common|welcome")),s.createElement(Ae.A,{className:"mx_UserOnboardingButton_close",onClick:n,"aria-label":(0,P._t)("action|dismiss")}))))}var tu=function(e){return e[e.Disabled=0]="Disabled",e[e.Legacy=1]="Legacy",e}(tu||{});class nu extends s.Component{constructor(e){super(e),(0,h.A)(this,"listContainerRef",(0,s.createRef)()),(0,h.A)(this,"roomListRef",(0,s.createRef)()),(0,h.A)(this,"focusedElement",null),(0,h.A)(this,"isDoingStickyHeaders",!1),(0,h.A)(this,"updateActiveSpace",(e=>{this.setState({activeSpace:e})})),(0,h.A)(this,"onDialPad",(()=>{w.A.fire(R.r.OpenDialPad)})),(0,h.A)(this,"onExplore",(e=>{w.A.fire(R.r.ViewRoomDirectory),y.A.trackInteraction("WebLeftPanelExploreRoomsButton",e)})),(0,h.A)(this,"refreshStickyHeaders",(()=>{this.listContainerRef.current&&this.handleStickyHeaders(this.listContainerRef.current)})),(0,h.A)(this,"onBreadcrumbsUpdate",(()=>{const e=nu.breadcrumbsMode;if(e!==this.state.showBreadcrumbs){if(this.setState({showBreadcrumbs:e}),!this.listContainerRef.current)return;this.handleStickyHeaders(this.listContainerRef.current)}})),(0,h.A)(this,"onScroll",(e=>{const t=e.target;this.handleStickyHeaders(t)})),(0,h.A)(this,"onFocus",(e=>{this.focusedElement=e.target})),(0,h.A)(this,"onBlur",(()=>{this.focusedElement=null})),(0,h.A)(this,"onKeyDown",((e,t)=>{if(!this.focusedElement)return;var n;(0,Re.zM)().getRoomListAction(e)===Se.bY.NextRoom&&(t||(e.stopPropagation(),e.preventDefault(),null===(n=this.roomListRef.current)||void 0===n||n.focus()));const i=(0,Re.zM)().getNavigationAction(e);i!==Se.bY.PreviousLandmark&&i!==Se.bY.NextLandmark||(e.stopPropagation(),e.preventDefault(),Hl.r.findAndFocusNextLandmark(Hl.H.ROOM_SEARCH,i===Se.bY.PreviousLandmark))})),this.state={activeSpace:xe.Ay.instance.activeSpace,showBreadcrumbs:nu.breadcrumbsMode}}static get breadcrumbsMode(){return sc.Y.instance.visible?tu.Legacy:tu.Disabled}componentDidMount(){sc.Y.instance.on(I.H,this.onBreadcrumbsUpdate),oc.Ay.instance.on(oc.lA,this.onBreadcrumbsUpdate),xe.Ay.instance.on(ke.tw,this.updateActiveSpace),this.listContainerRef.current&&(Ie.A.instance.trackElementDimensions("ListContainer",this.listContainerRef.current),this.listContainerRef.current.addEventListener("scroll",this.onScroll,{passive:!0})),Ie.A.instance.on("ListContainer",this.refreshStickyHeaders)}componentWillUnmount(){var e;sc.Y.instance.off(I.H,this.onBreadcrumbsUpdate),oc.Ay.instance.off(oc.lA,this.onBreadcrumbsUpdate),xe.Ay.instance.off(ke.tw,this.updateActiveSpace),Ie.A.instance.stopTrackingElementDimensions("ListContainer"),Ie.A.instance.removeListener("ListContainer",this.refreshStickyHeaders),null===(e=this.listContainerRef.current)||void 0===e||e.removeEventListener("scroll",this.onScroll)}componentDidUpdate(e,t){t.activeSpace!==this.state.activeSpace&&this.refreshStickyHeaders()}handleStickyHeaders(e){this.isDoingStickyHeaders||(this.isDoingStickyHeaders=!0,window.requestAnimationFrame((()=>{this.doStickyHeaders(e),this.isDoingStickyHeaders=!1})))}doStickyHeaders(e){if(!e.parentElement)return;const t=e.scrollTop,n=e.offsetHeight+e.scrollTop,i=e.querySelectorAll(".mx_RoomSublist:not(.mx_RoomSublist_hidden)"),r=new Map;let s,o;for(const e of i){const a=e.querySelector(".mx_RoomSublist_stickable");if(!a)continue;a.style.removeProperty("display");const l=.4,c=e.offsetTop+l*we.u<=t,d=e.offsetTop+l*we.u>=n;c||e===i[0]?(r.set(a,{stickyTop:!0}),s&&(s.style.display="none",r.set(s,{makeInvisible:!0})),s=a):d&&!o?(r.set(a,{stickyBottom:!0}),o=a):r.set(a,{})}for(const t of r.keys()){const n=r.get(t);if(n.makeInvisible)t.style.display="none";else{if(n.stickyTop){t.classList.contains("mx_RoomSublist_headerContainer_stickyTop")||t.classList.add("mx_RoomSublist_headerContainer_stickyTop");const n=`${e.parentElement.offsetTop}px`;t.style.top!==n&&(t.style.top=n)}else t.classList.contains("mx_RoomSublist_headerContainer_stickyTop")&&t.classList.remove("mx_RoomSublist_headerContainer_stickyTop"),t.style.top&&t.style.removeProperty("top");if(n.stickyBottom){t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom")||t.classList.add("mx_RoomSublist_headerContainer_stickyBottom");const n=`${Ie.A.instance.windowHeight-(e.parentElement.offsetTop+e.parentElement.offsetHeight)}px`;t.style.bottom!==n&&(t.style.bottom=n)}else t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom")&&t.classList.remove("mx_RoomSublist_headerContainer_stickyBottom"),t.style.bottom&&t.style.removeProperty("bottom");if(n.stickyTop||n.stickyBottom){t.classList.contains("mx_RoomSublist_headerContainer_sticky")||t.classList.add("mx_RoomSublist_headerContainer_sticky");const e=Ie.A.instance.getElementDimensions("ListContainer");if(e){const n=15,i=`${e.width-n}px`;t.style.width!==i&&(t.style.width=i)}}else n.stickyTop||n.stickyBottom||(t.classList.contains("mx_RoomSublist_headerContainer_sticky")&&t.classList.remove("mx_RoomSublist_headerContainer_sticky"),t.style.width&&t.style.removeProperty("width"))}}const a=e.parentElement;a&&(s?a.classList.add("mx_LeftPanel_roomListWrapper_stickyTop"):a.classList.remove("mx_LeftPanel_roomListWrapper_stickyTop"),o?a.classList.add("mx_LeftPanel_roomListWrapper_stickyBottom"):a.classList.remove("mx_LeftPanel_roomListWrapper_stickyBottom"))}renderBreadcrumbs(){if(this.state.showBreadcrumbs===tu.Legacy&&!this.props.isMinimized)return s.createElement(qa,{role:"navigation","aria-label":(0,P._t)("a11y|recent_rooms"),className:"mx_LeftPanel_breadcrumbsContainer mx_AutoHideScrollbar",verticalScrollsHorizontally:!0},s.createElement(dc,null))}renderSearchDialExplore(){let e,t;return Ee.Ay.instance.getSupportsPstnProtocol()&&(e=s.createElement(Ae.A,{className:re()("mx_LeftPanel_dialPadButton",{}),onClick:this.onDialPad,title:(0,P._t)("left_panel|open_dial_pad")})),this.state.activeSpace===ke._b.Home&&(0,Ne.g)($.C.ExploreRooms)&&(t=s.createElement(Ae.A,{className:"mx_LeftPanel_exploreButton",onClick:this.onExplore,title:(0,P._t)("action|explore_rooms")})),s.createElement("div",{className:"mx_LeftPanel_filterContainer",onFocus:this.onFocus,onBlur:this.onBlur,onKeyDown:this.onKeyDown,role:"search"},s.createElement(Ce,{isMinimized:this.props.isMinimized}),e,t)}render(){const e=s.createElement(be.A,{onKeyDown:this.onKeyDown,resizeNotifier:this.props.resizeNotifier,onFocus:this.onFocus,onBlur:this.onBlur,isMinimized:this.props.isMinimized,activeSpace:this.state.activeSpace,onResize:this.refreshStickyHeaders,onListCollapse:this.refreshStickyHeaders,ref:this.roomListRef}),t=re()({mx_LeftPanel:!0,mx_LeftPanel_minimized:this.props.isMinimized}),n=re()("mx_LeftPanel_actualRoomListContainer","mx_AutoHideScrollbar");return s.createElement("div",{className:t},s.createElement("div",{className:"mx_LeftPanel_roomListContainer"},(0,Ne.g)($.C.FilterContainer)&&this.renderSearchDialExplore(),this.renderBreadcrumbs(),!this.props.isMinimized&&s.createElement(rc,{onVisibilityChange:this.refreshStickyHeaders}),s.createElement(Qd,{selected:this.props.pageType===G.A.HomePage,minimized:this.props.isMinimized}),s.createElement("nav",{className:"mx_LeftPanel_roomListWrapper","aria-label":(0,P._t)("common|rooms")},s.createElement("div",{className:n,ref:this.listContainerRef,tabIndex:-1},e))))}}var iu=n("./src/stores/NonUrgentToastStore.ts");class ru extends s.PureComponent{constructor(e){super(e),(0,h.A)(this,"onUpdateToasts",(()=>{this.setState({toasts:iu.A.instance.components})})),this.state={toasts:iu.A.instance.components}}componentDidMount(){iu.A.instance.on(I.H,this.onUpdateToasts)}componentWillUnmount(){iu.A.instance.off(I.H,this.onUpdateToasts)}render(){const e=this.state.toasts.map(((e,t)=>s.createElement("div",{className:"mx_NonUrgentToastContainer_toast",key:`toast-${t}`},s.createElement(e,{}))));return s.createElement("div",{className:"mx_NonUrgentToastContainer",role:"alert"},e)}}var su=n("./node_modules/matrix-js-sdk/src/webrtc/call.ts"),ou=n("./node_modules/matrix-js-sdk/src/webrtc/callFeed.ts");class au extends s.Component{constructor(e){super(e),(0,h.A)(this,"element",(0,s.createRef)()),(0,h.A)(this,"onAudioOutputChanged",(e=>{const t=this.element.current;if(e)try{t.setSinkId(e)}catch(e){o.v.error("Couldn't set requested audio output device: using default",e),o.v.warn("Couldn't set requested audio output device: using default",e)}})),(0,h.A)(this,"onNewStream",(()=>{this.setState({audioMuted:this.props.feed.isAudioMuted()}),this.playMedia()})),this.state={audioMuted:this.props.feed.isAudioMuted()}}componentDidMount(){oe.Ay.instance.addListener(oe.hW.AudioOutputChanged,this.onAudioOutputChanged),this.props.feed.addListener(ou.BL.NewStream,this.onNewStream),this.playMedia()}componentWillUnmount(){oe.Ay.instance.removeListener(oe.hW.AudioOutputChanged,this.onAudioOutputChanged),this.props.feed.removeListener(ou.BL.NewStream,this.onNewStream),this.stopMedia()}async playMedia(){const e=this.element.current;if(e){this.onAudioOutputChanged(oe.Ay.getAudioOutput()),e.muted=!1,e.srcObject=this.props.feed.stream,e.autoplay=!0;try{await e.load()}catch(e){o.v.info(`Failed to play media element with feed for userId ${this.props.feed.userId} with purpose ${this.props.feed.purpose}`,e)}}}stopMedia(){const e=this.element.current;e&&(e.pause(),e.removeAttribute("src"))}render(){return this.state.audioMuted?null:s.createElement("audio",{ref:this.element})}}class lu extends s.Component{constructor(e){super(e),(0,h.A)(this,"onFeedsChanged",(()=>{this.setState({feeds:this.props.call.getRemoteFeeds()})})),this.state={feeds:this.props.call.getRemoteFeeds()}}componentDidMount(){this.props.call.addListener(su.$E.FeedsChanged,this.onFeedsChanged)}componentWillUnmount(){this.props.call.removeListener(su.$E.FeedsChanged,this.onFeedsChanged)}render(){return this.state.feeds.map(((e,t)=>s.createElement(au,{feed:e,key:t})))}}var cu=n("./src/shouldHideEvent.ts"),du=n("./src/TimezoneHandler.ts"),uu=n("./src/utils/permalinks/Permalinks.ts"),mu=n("./src/ContentMessages.ts"),pu=n("./node_modules/re-resizable/lib/index.js"),hu=n("./src/PosthogAnalytics.ts");class gu extends s.Component{constructor(...e){super(...e),(0,h.A)(this,"onResizeStart",(()=>{this.props.resizeNotifier.startResizing()})),(0,h.A)(this,"onResize",(()=>{this.props.resizeNotifier.notifyRightHandleResized()})),(0,h.A)(this,"onResizeStop",((e,t,n,i)=>{const r=this.loadSidePanelSize().width+i.width;this.props.resizeNotifier.stopResizing(),window.localStorage.setItem(this.sizeSettingStorageKey,r.toString()),hu.Vo.instance.trackEvent({eventName:"WebPanelResize",panel:"right",roomType:this.props.analyticsRoomType,size:r})}))}get sizeSettingStorageKey(){let e="mx_rhs_size";return this.props.sizeKey&&(e+=`_${this.props.sizeKey}`),e}loadSidePanelSize(){let e=parseInt(window.localStorage.getItem(this.sizeSettingStorageKey),10);return isNaN(e)&&(e=this.props.defaultSize),{height:"100%",width:e}}render(){const e=s.Children.only(this.props.children),t=this.props.panel;let n;return!this.props.collapsedRhs&&t&&(n=s.createElement(pu.c,{key:this.props.sizeKey,defaultSize:this.loadSidePanelSize(),minWidth:264,maxWidth:"50%",enable:{top:!1,right:!1,bottom:!1,left:!0,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},onResizeStart:this.onResizeStart,onResize:this.onResize,onResizeStop:this.onResizeStop,className:"mx_RightPanel_ResizeWrapper",handleClasses:{left:"mx_ResizeHandle--horizontal"}},t)),s.createElement("div",{className:"mx_MainSplit"},e,n)}}(0,h.A)(gu,"defaultProps",{defaultSize:320});const vu="_link_ue21z_17",fu=["children","className","kind","size"];function _u(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function yu(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?_u(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):_u(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const bu=(0,s.forwardRef)((function(e,t){let{children:n,className:i,kind:r="primary",size:s="medium"}=e,o=(0,Ve.A)(e,fu);return(0,dl.jsx)("a",yu(yu({ref:t},o),{},{rel:"noreferrer noopener",className:ie(vu,i),"data-kind":r,"data-size":s,children:n}))}));var Eu=n("./node_modules/@vector-im/compound-web/dist/components/Typography/Heading.js"),wu=n("./node_modules/@radix-ui/primitive/dist/index.mjs"),Su=n("./node_modules/@radix-ui/react-compose-refs/dist/index.mjs"),Au=n("./node_modules/@radix-ui/react-context/dist/index.mjs"),Cu=n("./node_modules/@radix-ui/react-id/dist/index.mjs"),xu=n("./node_modules/@radix-ui/react-primitive/dist/index.mjs"),ku=s.forwardRef(((e,t)=>(0,dl.jsx)(xu.sG.label,{...e,ref:t,onMouseDown:t=>{t.target.closest("button, input, select, textarea")||(e.onMouseDown?.(t),!t.defaultPrevented&&t.detail>1&&t.preventDefault())}})));ku.displayName="Label";var[Ru,Iu]=(0,Au.A)("Form"),Tu="Form",[Pu,Nu]=Ru(Tu),[Du,Mu]=Ru(Tu),Ou=s.forwardRef(((e,t)=>{const{__scopeForm:n,onClearServerErrors:i=()=>{},...r}=e,o=s.useRef(null),a=(0,Su.s)(t,o),[l,c]=s.useState({}),d=s.useCallback((e=>l[e]),[l]),u=s.useCallback(((e,t)=>c((n=>({...n,[e]:{...n[e]??{},...t}})))),[]),m=s.useCallback((e=>{c((t=>({...t,[e]:void 0}))),y((t=>({...t,[e]:{}})))}),[]),[p,h]=s.useState({}),g=s.useCallback((e=>p[e]??[]),[p]),v=s.useCallback(((e,t)=>{h((n=>({...n,[e]:[...n[e]??[],t]})))}),[]),f=s.useCallback(((e,t)=>{h((n=>({...n,[e]:(n[e]??[]).filter((e=>e.id!==t))})))}),[]),[_,y]=s.useState({}),b=s.useCallback((e=>_[e]??{}),[_]),E=s.useCallback(((e,t)=>{y((n=>({...n,[e]:{...n[e]??{},...t}})))}),[]),[w,S]=s.useState({}),A=s.useCallback(((e,t)=>{S((n=>{const i=new Set(n[e]).add(t);return{...n,[e]:i}}))}),[]),C=s.useCallback(((e,t)=>{S((n=>{const i=new Set(n[e]);return i.delete(t),{...n,[e]:i}}))}),[]),x=s.useCallback((e=>Array.from(w[e]??[]).join(" ")||void 0),[w]);return(0,dl.jsx)(Pu,{scope:n,getFieldValidity:d,onFieldValidityChange:u,getFieldCustomMatcherEntries:g,onFieldCustomMatcherEntryAdd:v,onFieldCustomMatcherEntryRemove:f,getFieldCustomErrors:b,onFieldCustomErrorsChange:E,onFieldValiditionClear:m,children:(0,dl.jsx)(Du,{scope:n,onFieldMessageIdAdd:A,onFieldMessageIdRemove:C,getFieldDescription:x,children:(0,dl.jsx)(xu.sG.form,{...r,ref:a,onInvalid:(0,wu.m)(e.onInvalid,(e=>{const t=im(e.currentTarget);t===e.target&&t.focus(),e.preventDefault()})),onSubmit:(0,wu.m)(e.onSubmit,i,{checkForDefaultPrevented:!1}),onReset:(0,wu.m)(e.onReset,i)})})})}));Ou.displayName=Tu;var Lu="FormField",[Fu,Uu]=Ru(Lu),Bu=s.forwardRef(((e,t)=>{const{__scopeForm:n,name:i,serverInvalid:r=!1,...s}=e,o=Nu(Lu,n).getFieldValidity(i),a=(0,Cu.B)();return(0,dl.jsx)(Fu,{scope:n,id:a,name:i,serverInvalid:r,children:(0,dl.jsx)(xu.sG.div,{"data-valid":sm(o,r),"data-invalid":om(o,r),...s,ref:t})})}));Bu.displayName=Lu;var Vu="FormLabel",ju=s.forwardRef(((e,t)=>{const{__scopeForm:n,...i}=e,r=Nu(Vu,n),s=Uu(Vu,n),o=i.htmlFor||s.id,a=r.getFieldValidity(s.name);return(0,dl.jsx)(ku,{"data-valid":sm(a,s.serverInvalid),"data-invalid":om(a,s.serverInvalid),...i,ref:t,htmlFor:o})}));ju.displayName=Vu;var zu="FormControl",Wu=s.forwardRef(((e,t)=>{const{__scopeForm:n,...i}=e,r=Nu(zu,n),o=Uu(zu,n),a=Mu(zu,n),l=s.useRef(null),c=(0,Su.s)(t,l),d=i.name||o.name,u=i.id||o.id,m=r.getFieldCustomMatcherEntries(d),{onFieldValidityChange:p,onFieldCustomErrorsChange:h,onFieldValiditionClear:g}=r,v=s.useCallback((async e=>{if(rm(e.validity)){const t=em(e.validity);return void p(d,t)}const t=e.form?new FormData(e.form):new FormData,n=[e.value,t],i=[],r=[];m.forEach((e=>{var t,s;s=n,"AsyncFunction"===(t=e).match.constructor.name||function(e,t){return e(...t)instanceof Promise}(t.match,s)?r.push(e):function(e){return"Function"===e.match.constructor.name}(e)&&i.push(e)}));const s=i.map((({id:e,match:t})=>[e,t(...n)])),o=Object.fromEntries(s),a=Object.values(o).some(Boolean),l=a;e.setCustomValidity(l?Hu:"");const c=em(e.validity);if(p(d,c),h(d,o),!a&&r.length>0){const t=r.map((({id:e,match:t})=>t(...n).then((t=>[e,t])))),i=await Promise.all(t),s=Object.fromEntries(i),o=Object.values(s).some(Boolean);e.setCustomValidity(o?Hu:"");const a=em(e.validity);p(d,a),h(d,s)}}),[m,d,h,p]);s.useEffect((()=>{const e=l.current;if(e){const t=()=>v(e);return e.addEventListener("change",t),()=>e.removeEventListener("change",t)}}),[v]);const f=s.useCallback((()=>{const e=l.current;e&&(e.setCustomValidity(""),g(d))}),[d,g]);s.useEffect((()=>{const e=l.current?.form;if(e)return e.addEventListener("reset",f),()=>e.removeEventListener("reset",f)}),[f]),s.useEffect((()=>{const e=l.current,t=e?.closest("form");if(t&&o.serverInvalid){const n=im(t);n===e&&n.focus()}}),[o.serverInvalid]);const _=r.getFieldValidity(d);return(0,dl.jsx)(xu.sG.input,{"data-valid":sm(_,o.serverInvalid),"data-invalid":om(_,o.serverInvalid),"aria-invalid":!!o.serverInvalid||void 0,"aria-describedby":a.getFieldDescription(d),title:"",...i,ref:c,id:u,name:d,onInvalid:(0,wu.m)(e.onInvalid,(e=>{const t=e.currentTarget;v(t)})),onChange:(0,wu.m)(e.onChange,(e=>{f()}))})}));Wu.displayName=zu;var Hu="This value is not valid",Gu={badInput:Hu,patternMismatch:"This value does not match the required pattern",rangeOverflow:"This value is too large",rangeUnderflow:"This value is too small",stepMismatch:"This value does not match the required step",tooLong:"This value is too long",tooShort:"This value is too short",typeMismatch:"This value does not match the required type",valid:void 0,valueMissing:"This value is missing"},Ku="FormMessage",Ju=s.forwardRef(((e,t)=>{const{match:n,name:i,...r}=e,s=Uu(Ku,e.__scopeForm),o=i??s.name;return void 0===n?(0,dl.jsx)(Yu,{...r,ref:t,name:o,children:e.children||Hu}):"function"==typeof n?(0,dl.jsx)($u,{match:n,...r,ref:t,name:o}):(0,dl.jsx)(qu,{match:n,...r,ref:t,name:o})}));Ju.displayName=Ku;var qu=s.forwardRef(((e,t)=>{const{match:n,forceMatch:i=!1,name:r,children:s,...o}=e,a=Nu(Ku,o.__scopeForm).getFieldValidity(r);return i||a?.[n]?(0,dl.jsx)(Yu,{ref:t,...o,name:r,children:s??Gu[n]}):null})),$u=s.forwardRef(((e,t)=>{const{match:n,forceMatch:i=!1,name:r,id:o,children:a,...l}=e,c=Nu(Ku,l.__scopeForm),d=s.useRef(null),u=(0,Su.s)(t,d),m=(0,Cu.B)(),p=o??m,h=s.useMemo((()=>({id:p,match:n})),[p,n]),{onFieldCustomMatcherEntryAdd:g,onFieldCustomMatcherEntryRemove:v}=c;s.useEffect((()=>(g(r,h),()=>v(r,h.id))),[h,r,g,v]);const f=c.getFieldValidity(r),_=c.getFieldCustomErrors(r)[p];return i||f&&!rm(f)&&_?(0,dl.jsx)(Yu,{id:p,ref:u,...l,name:r,children:a??Hu}):null})),Yu=s.forwardRef(((e,t)=>{const{__scopeForm:n,id:i,name:r,...o}=e,a=Mu(Ku,n),l=(0,Cu.B)(),c=i??l,{onFieldMessageIdAdd:d,onFieldMessageIdRemove:u}=a;return s.useEffect((()=>(d(r,c),()=>u(r,c))),[r,c,d,u]),(0,dl.jsx)(xu.sG.span,{id:c,...o,ref:t})})),Zu="FormValidityState",Xu=e=>{const{__scopeForm:t,name:n,children:i}=e,r=Nu(Zu,t),s=Uu(Zu,t),o=n??s.name,a=r.getFieldValidity(o);return(0,dl.jsx)(dl.Fragment,{children:i(a)})};Xu.displayName=Zu;var Qu=s.forwardRef(((e,t)=>{const{__scopeForm:n,...i}=e;return(0,dl.jsx)(xu.sG.button,{type:"submit",...i,ref:t})}));function em(e){const t={};for(const n in e)t[n]=e[n];return t}function tm(e){return e instanceof HTMLElement}function nm(e){return"validity"in e&&(!1===e.validity.valid||"true"===e.getAttribute("aria-invalid"))}function im(e){const t=e.elements,[n]=Array.from(t).filter(tm).filter(nm);return n}function rm(e){let t=!1;for(const n in e){if("valid"!==n&&"customError"!==n&&e[n]){t=!0;break}}return t}function sm(e,t){if(!0===e?.valid&&!t)return!0}function om(e,t){if(!1===e?.valid||t)return!0}Qu.displayName="FormSubmit";var am=Ou,lm=Bu,cm=ju,dm=Wu,um=Ju,mm=Xu,pm=Qu;const hm="_root_ssths_24",gm="_field_ssths_34",vm="_inline-field_ssths_40",fm="_inline-field-body_ssths_46",_m="_inline-field-control_ssths_52",ym="_label_ssths_67",bm="_message_ssths_93",Em="_help-message_ssths_99",wm="_error-message_ssths_103",Sm="_success-message_ssths_107",Am=["children"];function Cm(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function xm(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Cm(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Cm(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const km=(0,s.forwardRef)((function(e,t){let{children:n}=e,i=(0,Ve.A)(e,Am);const r=ie(hm,i.className);return(0,dl.jsx)(am,xm(xm({ref:t},i),{},{className:r,children:n}))})),Rm="_search_1ki2c_17",Im="_icon_1ki2c_46",Tm="_input_1ki2c_61";var Pm=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/search.js");const Nm=["children"];function Dm(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Mm(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Dm(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Dm(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const Om=(0,s.forwardRef)((function(e,t){let{children:n}=e,i=(0,Ve.A)(e,Nm);const r=ie(gm,i.className);return(0,dl.jsx)(lm,Mm(Mm({ref:t},i),{},{className:r,children:n}))})),Lm=["children"];function Fm(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Um(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Fm(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Fm(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const Bm=(0,s.forwardRef)((function(e,t){let{children:n}=e,i=(0,Ve.A)(e,Lm);const r=ie(ym,i.className);return(0,dl.jsx)(cm,Um(Um({ref:t},i),{},{className:r,children:n}))})),Vm=["className","onChange","placeholder","name"];function jm(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function zm(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?jm(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):jm(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const Wm=(0,s.forwardRef)((function(e,t){let{className:n,onChange:i,placeholder:r="Searchâ€¦",name:o}=e,a=(0,Ve.A)(e,Vm);const l=ie(Rm,n),c=(0,s.useId)();return(0,dl.jsx)(Om,{name:o,asChild:!0,children:(0,dl.jsxs)(Bm,{className:l,htmlFor:c,children:[(0,dl.jsx)(Pm.A,{className:Im,width:20,height:20}),(0,dl.jsx)("input",zm(zm({ref:t},a),{},{id:c,name:o,type:"search",placeholder:r,onChange:i,className:Tm}))]})})}));var Hm=n("./node_modules/@vector-im/compound-web/dist/components/Separator/Separator.js");const Gm="_container_qnvru_18",Km="_input_qnvru_32",Jm="_ui_qnvru_42",qm=["className"];function $m(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Ym(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?$m(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):$m(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const Zm=(0,s.forwardRef)((function(e,t){let{className:n}=e,i=(0,Ve.A)(e,qm);const r=ie(Gm,n);return(0,dl.jsxs)("div",{className:r,children:[(0,dl.jsx)("input",Ym(Ym({ref:t,className:Km},i),{},{type:"checkbox"})),(0,dl.jsx)("div",{className:Jm})]})})),Xm=(0,s.forwardRef)((function(e,t){return(0,dl.jsx)(dm,{asChild:!0,children:(0,dl.jsx)(Zm,Ym({ref:t},e))})})),Qm=(0,s.forwardRef)((function({className:e,Icon:t,label:n,onSelect:i,checked:r,disabled:o},a){const l=(0,s.useId)(),c=(0,s.useCallback)((()=>{}),[]);return(0,dl.jsx)(Ya.D,{as:"div",role:"menuitemcheckbox","aria-checked":r,className:e,Icon:t,label:n,onSelect:i,disabled:o,children:(0,dl.jsx)(Zm,{id:l,ref:a,"aria-hidden":!0,checked:r,disabled:o,onChange:c})})}));function ep(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{d:"M13.905 9.378 12 5.52l-1.905 3.86-4.259.618 3.082 3.004-.727 4.242L12 15.24l3.81 2.003-.728-4.242 3.082-3.004-4.26-.619ZM8.767 7.55l2.336-4.733a1 1 0 0 1 1.794 0l2.336 4.733 5.223.76a1 1 0 0 1 .555 1.705L17.23 13.7l.892 5.202a1 1 0 0 1-1.45 1.054L12 17.5l-4.672 2.456a1 1 0 0 1-1.451-1.054l.892-5.202-3.78-3.685a1 1 0 0 1 .555-1.706l5.223-.759Z"})})}ep.displayName="FavouriteIcon";const tp=(0,s.forwardRef)(ep);var np=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/user-add.js"),ip=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/link.js");function rp(e,t){return(0,dl.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:[(0,dl.jsx)("path",{d:"M16 12a4 4 0 1 1-8 0 4 4 0 0 1 8 0Zm-2 0a2 2 0 1 0-4 0 2 2 0 0 0 4 0Z"}),(0,dl.jsx)("path",{d:"M11.312 2h1.376A2.312 2.312 0 0 1 15 4.312v.247l.002.003c.01.014.031.033.064.047.03.013.056.013.07.01h.002l.177-.177a2.312 2.312 0 0 1 3.27 0l.973.974a2.312 2.312 0 0 1 0 3.269l-.177.177v.003a.134.134 0 0 0 .01.07.153.153 0 0 0 .047.063l.003.002h.247A2.312 2.312 0 0 1 22 11.312v1.376A2.312 2.312 0 0 1 19.688 15h-.247l-.003.002a.152.152 0 0 0-.047.064.134.134 0 0 0-.01.07v.002l.177.177a2.312 2.312 0 0 1 0 3.27l-.974.973a2.312 2.312 0 0 1-3.269 0l-.177-.177h-.003a.134.134 0 0 0-.07.01.152.152 0 0 0-.063.047l-.002.003v.247A2.312 2.312 0 0 1 12.688 22h-1.376A2.312 2.312 0 0 1 9 19.688v-.247l-.002-.003a.153.153 0 0 0-.064-.047.134.134 0 0 0-.07-.01h-.002l-.177.177a2.312 2.312 0 0 1-3.27 0l-.973-.974a2.312 2.312 0 0 1 0-3.269l.177-.177v-.003a.135.135 0 0 0-.01-.07.152.152 0 0 0-.047-.063L4.559 15h-.247A2.312 2.312 0 0 1 2 12.688v-1.376A2.312 2.312 0 0 1 4.312 9h.247l.003-.002a.153.153 0 0 0 .047-.064.135.135 0 0 0 .01-.07v-.002l-.177-.177a2.312 2.312 0 0 1 0-3.27l.974-.973a2.312 2.312 0 0 1 3.269 0l.177.177h.003a.135.135 0 0 0 .07-.01.153.153 0 0 0 .063-.047L9 4.559v-.247A2.312 2.312 0 0 1 11.312 2ZM11 4.312v.257c0 .893-.59 1.593-1.299 1.887-.716.297-1.622.21-2.248-.418l-.182-.182a.312.312 0 0 0-.441 0l-.974.974a.312.312 0 0 0 0 .44l.182.183c.627.626.715 1.531.418 2.248C6.162 10.41 5.462 11 4.569 11h-.257a.312.312 0 0 0-.312.312v1.376c0 .172.14.312.312.312h.257c.893 0 1.593.59 1.887 1.299.297.716.21 1.622-.418 2.248l-.182.182a.312.312 0 0 0 0 .441l.974.973a.31.31 0 0 0 .44 0l.183-.181c.626-.627 1.532-.715 2.248-.418.709.294 1.299.994 1.299 1.887v.257c0 .172.14.312.312.312h1.376c.172 0 .312-.14.312-.312v-.257c0-.893.59-1.593 1.299-1.887.716-.297 1.622-.21 2.248.418l.182.181c.122.122.32.122.441 0l.973-.973a.312.312 0 0 0 0-.44l-.181-.183c-.627-.627-.715-1.532-.418-2.248.294-.709.994-1.299 1.887-1.299h.257c.172 0 .312-.14.312-.312v-1.376a.312.312 0 0 0-.312-.312h-.257c-.893 0-1.593-.59-1.887-1.299-.297-.717-.21-1.622.418-2.248l.181-.182a.312.312 0 0 0 0-.441l-.973-.974a.312.312 0 0 0-.44 0l-.183.182c-.627.627-1.532.715-2.248.418C13.59 6.162 13 5.462 13 4.569v-.257A.312.312 0 0 0 12.688 4h-1.376a.312.312 0 0 0-.312.312Z"})]})}rp.displayName="SettingsIcon";const sp=(0,s.forwardRef)(rp);function op(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{d:"M5 21c-.55 0-1.02-.196-1.413-.587A1.926 1.926 0 0 1 3 19V6.5c0-.25.042-.475.125-.675.083-.2.192-.392.325-.575l1.4-1.7c.133-.183.3-.32.5-.412C5.55 3.046 5.767 3 6 3h12c.233 0 .45.046.65.138.2.091.367.229.5.412l1.4 1.7c.133.183.242.375.325.575.083.2.125.425.125.675V19c0 .55-.196 1.02-.587 1.413A1.926 1.926 0 0 1 19 21H5Zm.4-15h13.2l-.85-1H6.25L5.4 6ZM5 19h14V8H5v11Zm7-1.425c.133 0 .258-.02.375-.063a.877.877 0 0 0 .325-.212l2.6-2.6a.948.948 0 0 0 .275-.7.948.948 0 0 0-.275-.7.948.948 0 0 0-.7-.275.948.948 0 0 0-.7.275l-.9.9V11a.968.968 0 0 0-.287-.713A.968.968 0 0 0 12 10a.968.968 0 0 0-.713.287A.968.968 0 0 0 11 11v3.2l-.9-.9a.948.948 0 0 0-.7-.275.948.948 0 0 0-.7.275.948.948 0 0 0-.275.7.95.95 0 0 0 .275.7l2.6 2.6c.1.1.208.17.325.212.117.042.242.063.375.063Z"})})}op.displayName="ExportArchiveIcon";const ap=(0,s.forwardRef)(op);var lp=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/leave.js"),cp=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/files.js");function dp(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{d:"M17.25 11.672a.907.907 0 0 1-.663-.282L12.61 7.413a.907.907 0 0 1-.282-.663c0-.254.094-.475.282-.663l3.977-3.977a.907.907 0 0 1 .663-.282c.254 0 .475.094.663.282l3.977 3.977a.907.907 0 0 1 .282.663.907.907 0 0 1-.282.663l-3.977 3.977a.907.907 0 0 1-.663.282Zm2.475-4.922L17.25 4.275 14.775 6.75l2.475 2.475 2.475-2.475ZM4 11a.967.967 0 0 1-.712-.287A.968.968 0 0 1 3 10V4c0-.283.096-.52.288-.712A.968.968 0 0 1 4 3h6a.97.97 0 0 1 .713.288A.968.968 0 0 1 11 4v6c0 .283-.096.52-.287.713A.968.968 0 0 1 10 11H4Zm5-2V5H5v4h4Zm5 12a.968.968 0 0 1-.713-.288A.968.968 0 0 1 13 20v-6c0-.283.096-.52.287-.713A.968.968 0 0 1 14 13h6a.97.97 0 0 1 .712.287c.192.192.288.43.288.713v6c0 .283-.096.52-.288.712A.968.968 0 0 1 20 21h-6Zm5-2v-4h-4v4h4ZM4 21a.967.967 0 0 1-.712-.288A.968.968 0 0 1 3 20v-6a.97.97 0 0 1 .288-.713A.967.967 0 0 1 4 13h6c.283 0 .52.096.713.287.191.192.287.43.287.713v6a.97.97 0 0 1-.287.712A.968.968 0 0 1 10 21H4Zm5-2v-4H5v4h4Z"})})}dp.displayName="ExtensionsIcon";const up=(0,s.forwardRef)(dp);function mp(e,t){return(0,dl.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:[(0,dl.jsx)("path",{d:"M9.175 13.825C9.958 14.608 10.9 15 12 15s2.042-.392 2.825-1.175C15.608 13.042 16 12.1 16 11s-.392-2.042-1.175-2.825C14.042 7.392 13.1 7 12 7s-2.042.392-2.825 1.175C8.392 8.958 8 9.9 8 11s.392 2.042 1.175 2.825Zm4.237-1.412A1.926 1.926 0 0 1 12 13c-.55 0-1.02-.196-1.412-.588A1.926 1.926 0 0 1 10 11c0-.55.196-1.02.588-1.412A1.926 1.926 0 0 1 12 9c.55 0 1.02.196 1.412.588.392.391.588.862.588 1.412 0 .55-.196 1.02-.588 1.412Z"}),(0,dl.jsx)("path",{d:"M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2s10 4.477 10 10Zm-2 0a8 8 0 1 0-16 0 8 8 0 0 0 16 0Z"}),(0,dl.jsx)("path",{d:"M16.23 18.792a12.47 12.47 0 0 0-1.455-.455 11.6 11.6 0 0 0-5.55 0c-.487.12-.972.271-1.455.455a8.04 8.04 0 0 1-1.729-1.454c.89-.412 1.794-.729 2.709-.95A13.76 13.76 0 0 1 12 16c1.1 0 2.183.13 3.25.387a14.78 14.78 0 0 1 2.709.95 8.042 8.042 0 0 1-1.73 1.455Z"})]})}mp.displayName="UserProfileIcon";const pp=(0,s.forwardRef)(mp);var hp=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/threads.js");function gp(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{d:"M16 10a.97.97 0 0 0 .712-.287A.967.967 0 0 0 17 9a.967.967 0 0 0-.288-.713A.968.968 0 0 0 16 8h-3a.968.968 0 0 0-.713.287A.967.967 0 0 0 12 9c0 .283.096.52.287.713.192.191.43.287.713.287h3Zm0 6a.97.97 0 0 0 .712-.287A.968.968 0 0 0 17 15a.968.968 0 0 0-.288-.713A.968.968 0 0 0 16 14h-3a.968.968 0 0 0-.713.287A.968.968 0 0 0 12 15c0 .283.096.52.287.713.192.191.43.287.713.287h3Zm-7-5c.55 0 1.02-.196 1.412-.588C10.804 10.021 11 9.55 11 9c0-.55-.196-1.02-.588-1.412A1.926 1.926 0 0 0 9 7c-.55 0-1.02.196-1.412.588A1.926 1.926 0 0 0 7 9c0 .55.196 1.02.588 1.412.391.392.862.588 1.412.588Zm0 6c.55 0 1.02-.196 1.412-.587.392-.392.588-.863.588-1.413s-.196-1.02-.588-1.412A1.926 1.926 0 0 0 9 13c-.55 0-1.02.196-1.412.588A1.926 1.926 0 0 0 7 15c0 .55.196 1.02.588 1.413.391.391.862.587 1.412.587Zm-4 4c-.55 0-1.02-.196-1.413-.587A1.926 1.926 0 0 1 3 19V5c0-.55.196-1.02.587-1.413A1.926 1.926 0 0 1 5 3h14c.55 0 1.02.196 1.413.587.39.393.587.863.587 1.413v14c0 .55-.196 1.02-.587 1.413A1.926 1.926 0 0 1 19 21H5Zm0-2h14V5H5v14Z"})})}gp.displayName="PollsIcon";const vp=(0,s.forwardRef)(gp);var fp=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/pin.js");function _p(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{d:"M12 14.95c-.133 0-.258-.02-.375-.063a.876.876 0 0 1-.325-.212l-4.6-4.6a.948.948 0 0 1-.275-.7.95.95 0 0 1 .275-.7.948.948 0 0 1 .7-.275.95.95 0 0 1 .7.275l3.9 3.9 3.9-3.9a.948.948 0 0 1 .7-.275.95.95 0 0 1 .7.275.948.948 0 0 1 .275.7.948.948 0 0 1-.275.7l-4.6 4.6c-.1.1-.208.17-.325.212a1.106 1.106 0 0 1-.375.063Z"})})}_p.displayName="ChevronDownIcon";const yp=(0,s.forwardRef)(_p);var bp=n("./src/hooks/useIsEncrypted.ts"),Ep=n("./src/components/views/right_panel/BaseCard.tsx"),wp=n("./src/components/views/dialogs/ShareDialog.tsx"),Sp=n("./src/contexts/RoomContext.ts"),Ap=n("./src/components/views/elements/RoomName.tsx"),Cp=n("./src/components/views/elements/StyledRadioGroup.tsx");let xp=function(e){return e.Html="Html",e.PlainText="PlainText",e.Json="Json",e}({}),kp=function(e){return e.Timeline="Timeline",e.Beginning="Beginning",e.LastNMessages="LastNMessages",e}({});const Rp=e=>{switch(e){case xp.Html:return(0,P._t)("export_chat|html");case xp.Json:return(0,P._t)("export_chat|json");case xp.PlainText:return(0,P._t)("export_chat|text");default:throw new Error("Unknown format")}};var Ip=n("./src/components/views/elements/Validation.tsx"),Tp=n("./node_modules/react-dom/client.js"),Pp=n("./node_modules/react-dom/server.browser.js"),Np=n("./node_modules/escape-html/index.js"),Dp=n.n(Np),Mp=n("./node_modules/file-saver/dist/FileSaver.min.js"),Op=n("./node_modules/sanitize-filename/index.js"),Lp=n.n(Op),Fp=n("./src/utils/DecryptFile.ts"),Up=n("./src/customisations/Media.ts"),Bp=n("./src/DateUtils.ts"),Vp=n("./src/utils/EventUtils.ts");class jp{constructor(e,t,n,i){if((0,h.A)(this,"files",[]),(0,h.A)(this,"cancelled",!1),(0,h.A)(this,"getRelationsForEvent",((e,t,n)=>this.room.getUnfilteredTimelineSet().relations.getChildEventsForEvent(e,t,n))),this.room=e,this.exportType=t,this.exportOptions=n,this.setProgressText=i,n.maxSize<1048576||n.maxSize>8388608e3||n.numberOfMessages&&n.numberOfMessages>10**8||t===kp.LastNMessages&&!n.numberOfMessages)throw new Error("Invalid export options");window.addEventListener("beforeunload",this.onBeforeUnload)}get destinationFileName(){return this.makeFileNameNoExtension(u.Ay.get().brand)+".zip"}onBeforeUnload(e){return e.preventDefault(),e.returnValue=(0,P._t)("export_chat|unload_confirm")}updateProgress(e,t=!0,n=!0){t&&o.v.log(e),n&&this.setProgressText(e)}addFile(e,t){const n={name:e,blob:t};this.files.push(n)}makeFileNameNoExtension(e="matrix"){var t;const n=Lp()(null!==(t=this.room.name)&&void 0!==t?t:(0,P._t)("common|unnamed_room")).trim()||"Unnamed Room",i=(0,Bp.td)(new Date).replace(/:/g,"-");return`${Lp()(e)} - ${n} - Chat Export - ${i}`}async downloadZIP(){const e=this.destinationFileName,t=e.substring(0,e.lastIndexOf(".")),{default:i}=await n.e(3260).then(n.t.bind(n,"./node_modules/jszip/dist/jszip.min.js",23)),r=new i;if(this.cancelled)return this.cleanUp();this.updateProgress((0,P._t)("export_chat|generating_zip"));for(const e of this.files)r.file(t+"/"+e.name,e.blob);const s=await r.generateAsync({type:"blob"});(0,Mp.saveAs)(s,t+".zip")}cleanUp(){return o.v.log("Cleaning up..."),window.removeEventListener("beforeunload",this.onBeforeUnload),""}async cancelExport(){o.v.log("Cancelling export..."),this.cancelled=!0}downloadPlainText(e,t){const n=new Blob([t],{type:"text/plain"});(0,Mp.saveAs)(n,e)}setEventMetadata(e){const t=this.room.currentState,n=e.getSender();var i;(e.sender=!!n&&(null==t?void 0:t.getSentinelMember(n))||null,"m.room.member"===e.getType())&&(e.target=null!==(i=null==t?void 0:t.getSentinelMember(e.getStateKey()))&&void 0!==i?i:null);return e}getLimit(){let e;if(this.exportType===kp.LastNMessages)e=this.exportOptions.numberOfMessages;else e=10**8;return e}async getRequiredEvents(){const e=this.room.client.getEventMapper();let t=null,n=[];if(this.exportType===kp.Timeline)n=this.room.getLiveTimeline().getEvents();else{let s=this.getLimit();for(;s;){var r;const o=Math.min(s,1e3),a=await this.room.client.createMessagesRequest(this.room.roomId,t,o,i.Direction.Backward);if(this.cancelled)return this.cleanUp(),[];if(0===a.chunk.length)break;s-=a.chunk.length;const l=a.chunk.map(e);for(const e of l)n.push(e);this.exportType===kp.LastNMessages?this.updateProgress((0,P._t)("export_chat|fetched_n_events_with_total",{count:n.length,total:this.exportOptions.numberOfMessages})):this.updateProgress((0,P._t)("export_chat|fetched_n_events",{count:n.length})),t=null!==(r=a.end)&&void 0!==r?r:null}n.reverse()}const s=n.filter((e=>e.isEncrypted())).map((e=>this.room.client.decryptEventIfNeeded(e,{emit:!1})));await Promise.all(s);for(let e=0;e<n.length;e++)this.setEventMetadata(n[e]);return n}async getMediaBlob(e){let t;try{const n=e.isEncrypted(),i=e.getContent();if(n&&i.hasOwnProperty("file")&&"m.sticker"!==e.getType())t=await(0,Fp.It)(i.file);else{const e=(0,Up.mA)(i);if(!e.srcHttp)throw new Error("Cannot fetch without srcHttp");const n=await fetch(e.srcHttp);t=await n.blob()}}catch{o.v.log("Error decrypting media")}if(!t)throw new Error("Unable to fetch file");return t}splitFileName(e){const t=e.lastIndexOf(".");if(-1===t)return[e,""];return[e.slice(0,t),"."+e.slice(t+1)]}getFilePath(e){let t;switch(e.getContent().msgtype){case"m.image":t="images";break;case"m.video":t="videos";break;case"m.audio":t="audio";break;default:t="m.sticker"===e.getType()?"stickers":"files"}const n=(0,Bp.ej)(new Date(e.getTs()));let[i,r]=this.splitFileName(e.getContent().body);return"m.sticker"===e.getType()&&(r=".png"),(0,Vp.Mp)(e)&&(r=".ogg"),t+"/"+i+"-"+n+r}isReply(e){const t=(e.isEncrypted()?e.event.content:e.getContent())["m.relates_to"];return!(!t||!t["m.in_reply_to"])}isAttachment(e){const t=["m.sticker","m.image","m.file","m.video","m.audio"];return e.getType()===t[0]||t.includes(e.getContent().msgtype)}}var zp=n("./src/settings/enums/Layout.ts"),Wp=n("./src/components/views/rooms/EventTile.tsx");class Hp extends s.Component{constructor(e){super(e),(0,h.A)(this,"onMouseDown",(e=>{this.setState({location:{currentX:e.clientX,currentY:e.clientY}}),document.addEventListener("mousemove",this.state.onMouseMove),document.addEventListener("mouseup",this.state.onMouseUp)})),(0,h.A)(this,"onMouseUp",(e=>{document.removeEventListener("mousemove",this.state.onMouseMove),document.removeEventListener("mouseup",this.state.onMouseUp),this.props.onMouseUp(e)})),this.state={onMouseMove:this.onMouseMove.bind(this),onMouseUp:this.onMouseUp.bind(this),location:{currentX:0,currentY:0}}}onMouseMove(e){const t=this.props.dragFunc(this.state.location,e);this.setState({location:t})}render(){return s.createElement("div",{className:this.props.className,onMouseDown:this.onMouseDown})}}class Gp extends s.Component{constructor(e){super(e),(0,h.A)(this,"dragFunc",((e,t)=>{const n=t.clientX-e.currentX,i=this.state.width+n;return i<this.props.minWidth||i>this.props.maxWidth?e:(this.setState({width:i}),this.updateCSSWidth.bind(this)(i),{currentX:t.clientX,currentY:e.currentY})})),(0,h.A)(this,"onMoueUp",(()=>{this.props.roomId&&V.A.setValue("ircDisplayNameWidth",this.props.roomId,ae.p.ROOM_DEVICE,this.state.width)})),this.state={width:V.A.getValue("ircDisplayNameWidth",this.props.roomId),IRCLayoutRoot:null}}componentDidMount(){this.setState({IRCLayoutRoot:document.querySelector(".mx_IRCLayout")},(()=>this.updateCSSWidth(this.state.width)))}updateCSSWidth(e){var t;null===(t=this.state.IRCLayoutRoot)||void 0===t||t.style.setProperty("--name-width",e+"px")}render(){return s.createElement(Hp,{className:"mx_ProfileResizer",dragFunc:this.dragFunc,onMouseUp:this.onMoueUp})}}function Kp(e){return Jp(e,[e.client.getSafeUserId()].concat(e.client.getIgnoredUsers()))}function Jp(e,t=[]){const n=[],i=Object.keys(e.currentState.members);for(const r of i)e.currentState.members[r].typing&&-1===t.indexOf(r)&&n.push(e.currentState.members[r]);return n}var qp=n("./src/utils/Timer.ts"),$p=n("./src/components/views/avatars/MemberAvatar.tsx");class Yp extends s.Component{constructor(...e){var t;super(...e),(0,h.A)(this,"state",{usersTyping:(t=this.props.room,Jp(t,[t.client.getSafeUserId()])),delayedStopTypingTimers:{}}),(0,h.A)(this,"isVisible",(()=>Yp.isVisible(this.state))),(0,h.A)(this,"onRoomTimeline",((e,t)=>{if((null==t?void 0:t.roomId)===this.props.room.roomId){const t=e.getSender(),n=this.state.usersTyping.filter((e=>e.userId!==t));n.length!==this.state.usersTyping.length&&this.setState({usersTyping:n}),this.abortUserTimer(t)}})),(0,h.A)(this,"onRoomMemberTyping",(()=>{const e=Kp(this.props.room);this.setState({delayedStopTypingTimers:this.updateDelayedStopTypingTimers(e),usersTyping:e})}))}componentDidMount(){E.J.safeGet().on(i.RoomMemberEvent.Typing,this.onRoomMemberTyping),E.J.safeGet().on(i.RoomEvent.Timeline,this.onRoomTimeline)}componentDidUpdate(e,t){const n=Yp.isVisible(t),i=Yp.isVisible(this.state);this.props.onShown&&!n&&i?this.props.onShown():this.props.onHidden&&n&&!i&&this.props.onHidden()}componentWillUnmount(){const e=E.J.get();e&&(e.removeListener(i.RoomMemberEvent.Typing,this.onRoomMemberTyping),e.removeListener(i.RoomEvent.Timeline,this.onRoomTimeline)),Object.values(this.state.delayedStopTypingTimers).forEach((e=>e.abort()))}static isVisible(e){return 0!==e.usersTyping.length||0!==Object.keys(e.delayedStopTypingTimers).length}updateDelayedStopTypingTimers(e){const t=this.state.usersTyping.filter((t=>!e.some((e=>t.userId===e.userId)))),n=e.filter((e=>!this.state.usersTyping.some((t=>e.userId===t.userId))));n.forEach((e=>{const t=this.state.delayedStopTypingTimers[e.userId];t&&t.abort()}));let i=Object.assign({},this.state.delayedStopTypingTimers);return i=n.reduce(((e,t)=>(delete e[t.userId],e)),i),i=t.reduce(((e,t)=>{if(!e[t.userId]){const n=new qp.A(5e3);e[t.userId]=n,n.start(),n.finished().then((()=>this.removeUserTimer(t.userId)),(()=>{}))}return e}),i),i}abortUserTimer(e){const t=this.state.delayedStopTypingTimers[e];t&&(t.abort(),this.removeUserTimer(e))}removeUserTimer(e){if(this.state.delayedStopTypingTimers[e]){const t=Object.assign({},this.state.delayedStopTypingTimers);delete t[e],this.setState({delayedStopTypingTimers:t})}}renderTypingIndicatorAvatars(e,t){let n=0;e.length>t&&(n=e.length-t+1,e=e.slice(0,t-1));const i=e.map((e=>s.createElement($p.A,{key:e.userId,member:e,size:"24px",resizeMethod:"crop",viewUserOnClick:!0,"aria-live":"off"})));return n>0&&i.push(s.createElement("span",{className:"mx_WhoIsTypingTile_remainingAvatarPlaceholder",key:"others"},"+",n)),i}render(){const e=[...this.state.usersTyping];for(const t in this.state.delayedStopTypingTimers){const n=this.props.room.getMember(t);n&&e.push(n)}const t=new Intl.Collator;e.sort(((e,n)=>t.compare(e.name,n.name)));const n=function(e,t){let n=0;if(e.length>t&&(n=e.length-t+1),0===e.length)return"";if(1===e.length)return(0,P._t)("timeline|typing_indicator|one_user",{displayName:e[0].name});const i=e.map((e=>e.name));if(n>=1)return(0,P._t)("timeline|typing_indicator|more_users",{names:i.slice(0,t-1).join(", "),count:n});{const e=i.pop();return(0,P._t)("timeline|typing_indicator|two_users",{names:i.join(", "),lastPerson:e})}}(e,this.props.whoIsTypingLimit);return n?s.createElement("li",{className:"mx_WhoIsTypingTile","aria-atomic":"true"},s.createElement("div",{className:"mx_WhoIsTypingTile_avatars"},this.renderTypingIndicatorAvatars(e,this.props.whoIsTypingLimit)),s.createElement("div",{className:"mx_WhoIsTypingTile_label"},n)):null}}(0,h.A)(Yp,"defaultProps",{whoIsTypingLimit:3});var Zp=n("./src/components/structures/ScrollPanel.tsx"),Xp=n("./src/components/views/messages/DateSeparator.tsx"),Qp=n("./src/components/views/messages/TimelineSeparator.tsx"),eh=n("./src/components/views/elements/ErrorBoundary.tsx"),th=n("./src/utils/EventRenderingUtils.ts"),nh=n("./src/events/EventTileFactory.tsx"),ih=n("./src/Editing.ts");class rh{constructor(e,t,n,i,r,s){(0,h.A)(this,"events",[]),(0,h.A)(this,"ejectedEvents",[]),(0,h.A)(this,"readMarker",void 0),this.panel=e,this.firstEventAndShouldShow=t,this.prevEvent=n,this.lastShownEvent=i,this.nextEvent=r,this.nextEventTile=s,this.readMarker=e.readMarkerForEvent(t.event.getId(),t.event===i)}}(0,h.A)(rh,"canStartGroup",((e,t)=>!0));var sh=n("./src/TextForEvent.tsx"),oh=n("./src/components/views/messages/EventTileBubble.tsx");const ah=()=>{var e;const{room:t}=(0,Ld.ME)("room"),n=null==t?void 0:t.getLiveTimeline().getState(i.EventTimeline.BACKWARDS),r=null==n||null===(e=n.getStateEvents("m.room.history_visibility")[0])||void 0===e?void 0:e.getContent().history_visibility;let o;return"invited"==r?o=(0,P._t)("timeline|no_permission_messages_before_invite"):"joined"==r&&(o=(0,P._t)("timeline|no_permission_messages_before_join")),s.createElement(oh.A,{className:"mx_HistoryTile",title:(0,P._t)("timeline|historical_messages_unavailable"),subtitle:o})};var lh=n("./src/utils/FormattingUtils.ts");const ch=({events:e,children:t,threshold:n=3,onToggle:i,startExpanded:r=!1,summaryMembers:a=[],summaryText:l,layout:c=zp.P.Group})=>{const[d,u]=(0,xa.X)(r);(0,s.useEffect)((()=>{i&&i()}),[d]);const m=e.map((e=>e.getId())).join(",");if(e.length<n)return s.createElement("li",{className:"mx_GenericEventListSummary","data-scroll-tokens":m,"data-expanded":!0,"data-layout":c},s.createElement("ol",{className:"mx_GenericEventListSummary_unstyledList"},t));let p;if(d)p=s.createElement(s.Fragment,null,s.createElement("div",{className:"mx_GenericEventListSummary_spacer"},"Â "),s.createElement("ol",{className:"mx_GenericEventListSummary_unstyledList"},t));else{const e=(0,v.uniqBy)(a.filter((e=>!(null==e||!e.getMxcAvatarUrl)||(o.v.error("EventListSummary given null summaryMember, termites may be afoot eating event senders",a),!1))),(e=>e.getMxcAvatarUrl())).map((e=>s.createElement($p.A,{key:e.userId,member:e,size:"14px"})));p=s.createElement("div",{className:"mx_EventTile_line"},s.createElement("div",{className:"mx_EventTile_info"},s.createElement("span",{className:"mx_GenericEventListSummary_avatars",onClick:u},e),s.createElement("span",{className:"mx_TextualEvent mx_GenericEventListSummary_summary"},l)))}return s.createElement("li",{className:"mx_GenericEventListSummary","data-scroll-tokens":m,"data-expanded":d+"","data-layout":c},s.createElement(Ae.A,{kind:"link_inline",className:"mx_GenericEventListSummary_toggle",onClick:u,"aria-expanded":d},d?(0,P._t)("action|collapse"):(0,P._t)("action|expand")),p)};var dh=n("./src/utils/ReactUtils.tsx");const uh=()=>{rl.A.instance.setCard({phase:sl.n.PinnedMessages},!1)},mh=[i.EventType.RoomMember];var ph=function(e){return e.Joined="joined",e.Left="left",e.JoinedAndLeft="joined_and_left",e.LeftAndJoined="left_and_joined",e.InviteReject="invite_reject",e.InviteWithdrawal="invite_withdrawal",e.Invited="invited",e.Banned="banned",e.Unbanned="unbanned",e.Kicked="kicked",e.ChangedName="changed_name",e.ChangedAvatar="changed_avatar",e.NoChange="no_change",e.ServerAcl="server_acl",e.ChangedPins="pinned_messages",e.MessageRemoved="message_removed",e.HiddenEvent="hidden_event",e}(ph||{});class hh extends s.Component{shouldComponentUpdate(e){return e.events.length!==this.props.events.length||e.events.length<this.props.threshold||e.layout!==this.props.layout}generateSummary(e,t){const n=t.map((t=>{const n=e[t],i=this.renderNameList(n),r=t.split(","),s=hh.getCanonicalTransitions(r),o=hh.coalesceRepeatedTransitions(s).map((e=>hh.getDescriptionForTransition(e.transitionType,n.length,e.repeats))),a=(0,lh.ki)(o);return(0,P._t)("timeline|summary|format",{nameList:i,transitionList:a})}));return n?(0,dh.i)(n,", "):null}renderNameList(e){return(0,lh.ki)(e,this.props.summaryLength)}static getCanonicalTransitions(e){const t={[ph.Joined]:{after:ph.Left,newTransition:ph.JoinedAndLeft},[ph.Left]:{after:ph.Joined,newTransition:ph.LeftAndJoined}},n=[];for(let i=0;i<e.length;i++){const r=e[i],s=e[i+1];let o=r;i<e.length-1&&t[r]&&t[r].after===s&&(o=t[r].newTransition,i++),n.push(o)}return n}static coalesceRepeatedTransitions(e){const t=[];for(const n of e)t.length>0&&t[t.length-1].transitionType===n?t[t.length-1].repeats+=1:t.push({transitionType:n,repeats:1});return t}static getDescriptionForTransition(e,t,n){let i;switch(e){case ph.Joined:i=t>1?(0,P._t)("timeline|summary|joined_multiple",{severalUsers:"",count:n}):(0,P._t)("timeline|summary|joined",{oneUser:"",count:n});break;case ph.Left:i=t>1?(0,P._t)("timeline|summary|left_multiple",{severalUsers:"",count:n}):(0,P._t)("timeline|summary|left",{oneUser:"",count:n});break;case ph.JoinedAndLeft:i=t>1?(0,P._t)("timeline|summary|joined_and_left_multiple",{severalUsers:"",count:n}):(0,P._t)("timeline|summary|joined_and_left",{oneUser:"",count:n});break;case ph.LeftAndJoined:i=t>1?(0,P._t)("timeline|summary|rejoined_multiple",{severalUsers:"",count:n}):(0,P._t)("timeline|summary|rejoined",{oneUser:"",count:n});break;case ph.InviteReject:i=t>1?(0,P._t)("timeline|summary|rejected_invite_multiple",{severalUsers:"",count:n}):(0,P._t)("timeline|summary|rejected_invite",{oneUser:"",count:n});break;case ph.InviteWithdrawal:i=t>1?(0,P._t)("timeline|summary|invite_withdrawn_multiple",{severalUsers:"",count:n}):(0,P._t)("timeline|summary|invite_withdrawn",{oneUser:"",count:n});break;case ph.Invited:i=t>1?(0,P._t)("timeline|summary|invited_multiple",{count:n}):(0,P._t)("timeline|summary|invited",{count:n});break;case ph.Banned:i=t>1?(0,P._t)("timeline|summary|banned_multiple",{count:n}):(0,P._t)("timeline|summary|banned",{count:n});break;case ph.Unbanned:i=t>1?(0,P._t)("timeline|summary|unbanned_multiple",{count:n}):(0,P._t)("timeline|summary|unbanned",{count:n});break;case ph.Kicked:i=t>1?(0,P._t)("timeline|summary|kicked_multiple",{count:n}):(0,P._t)("timeline|summary|kicked",{count:n});break;case ph.ChangedName:i=t>1?(0,P._t)("timeline|summary|changed_name_multiple",{severalUsers:"",count:n}):(0,P._t)("timeline|summary|changed_name",{oneUser:"",count:n});break;case ph.ChangedAvatar:i=t>1?(0,P._t)("timeline|summary|changed_avatar_multiple",{severalUsers:"",count:n}):(0,P._t)("timeline|summary|changed_avatar",{oneUser:"",count:n});break;case ph.NoChange:i=t>1?(0,P._t)("timeline|summary|no_change_multiple",{severalUsers:"",count:n}):(0,P._t)("timeline|summary|no_change",{oneUser:"",count:n});break;case ph.ServerAcl:i=t>1?(0,P._t)("timeline|summary|server_acls_multiple",{severalUsers:"",count:n}):(0,P._t)("timeline|summary|server_acls",{oneUser:"",count:n});break;case ph.ChangedPins:i=t>1?(0,P._t)("timeline|summary|pinned_events_multiple",{severalUsers:"",count:n},{a:e=>s.createElement(Ae.A,{kind:"link_inline",onClick:uh},e)}):(0,P._t)("timeline|summary|pinned_events",{oneUser:"",count:n},{a:e=>s.createElement(Ae.A,{kind:"link_inline",onClick:uh},e)});break;case ph.MessageRemoved:i=t>1?(0,P._t)("timeline|summary|redacted_multiple",{severalUsers:"",count:n}):(0,P._t)("timeline|summary|redacted",{oneUser:"",count:n});break;case ph.HiddenEvent:i=t>1?(0,P._t)("timeline|summary|hidden_event_multiple",{severalUsers:"",count:n}):(0,P._t)("timeline|summary|hidden_event",{oneUser:"",count:n})}return null!=i?i:null}static getTransitionSequence(e){return e.map(hh.getTransition)}static getTransition(e){if(e.mxEvent.isRedacted())return ph.MessageRemoved;switch(e.mxEvent.getType()){case i.EventType.RoomThirdPartyInvite:return(0,C.Qo)(e.mxEvent)?ph.Invited:ph.InviteWithdrawal;case i.EventType.RoomServerAcl:return ph.ServerAcl;case i.EventType.RoomPinnedEvents:return ph.ChangedPins;case i.EventType.RoomMember:switch(e.mxEvent.getContent().membership){case oa.O.Invite:return ph.Invited;case oa.O.Ban:return ph.Banned;case oa.O.Join:return e.mxEvent.getPrevContent().membership===oa.O.Join?e.mxEvent.getContent().displayname!==e.mxEvent.getPrevContent().displayname?ph.ChangedName:e.mxEvent.getContent().avatar_url!==e.mxEvent.getPrevContent().avatar_url?ph.ChangedAvatar:ph.NoChange:ph.Joined;case oa.O.Leave:if(e.mxEvent.getSender()===e.mxEvent.getStateKey())return e.mxEvent.getPrevContent().membership===oa.O.Invite?ph.InviteReject:ph.Left;switch(e.mxEvent.getPrevContent().membership){case oa.O.Invite:return ph.InviteWithdrawal;case oa.O.Ban:return ph.Unbanned;default:return ph.Kicked}default:return null}default:return ph.HiddenEvent}}getAggregate(e){const t={},n={};return Object.keys(e).forEach((i=>{const r=e[i][0],s=r.displayName,o=hh.getTransitionSequence(e[i]).join(",");t[o]||(t[o]=[],n[o]=-1),t[o].push(s),(-1===n[o]||r.index<n[o])&&(n[o]=r.index)})),{names:t,indices:n}}render(){const e=this.props.events,t=new Map,n={};e.forEach(((e,r)=>{var s;const o=e.getType();let a=e.getSender();e.isState()&&o===i.EventType.RoomThirdPartyInvite?a=e.getContent().display_name:e.isState()&&o===i.EventType.RoomMember?a=e.getStateKey():e.isRedacted()&&null!==(s=e.getUnsigned())&&void 0!==s&&s.redacted_because&&(a=e.getUnsigned().redacted_because.sender),n[a]||(n[a]=[]);let l=a;if(e.isRedacted()){var c;const e=null===(c=this.context)||void 0===c||null===(c=c.room)||void 0===c?void 0:c.getMember(a);e&&(l=e.name,t.set(a,e))}else e.target&&mh.includes(o)?(l=e.target.name,t.set(a,e.target)):e.sender&&o!==i.EventType.RoomThirdPartyInvite&&(l=e.sender.name,t.set(a,e.sender));n[a].push({mxEvent:e,displayName:l,index:r})}));const r=this.getAggregate(n),o=Object.keys(r.names).sort(((e,t)=>r.indices[e]-r.indices[t]));return s.createElement(ch,{events:this.props.events,threshold:this.props.threshold,onToggle:this.props.onToggle,startExpanded:this.props.startExpanded,children:this.props.children,summaryMembers:[...t.values()],layout:this.props.layout,summaryText:this.generateSummary(r.names,o)})}}(0,h.A)(hh,"contextType",Sp.Ay),(0,h.A)(hh,"defaultProps",{summaryLength:1,threshold:3,avatarsMaxLength:5,layout:zp.P.Group});const gh=[i.EventType.RoomMember,i.EventType.RoomThirdPartyInvite,i.EventType.RoomServerAcl,i.EventType.RoomPinnedEvents];class vh extends rh{constructor(e,t,n,i,r,s){super(e,t,n,i,r,s),this.panel=e,this.firstEventAndShouldShow=t,this.prevEvent=n,this.lastShownEvent=i,this.events=[t]}shouldGroup({event:e,shouldShow:t}){return!t||this.panel.wantsSeparator(this.events[0].event,e)!==Qp.W.Date&&(!(!e.isState()||!gh.includes(e.getType()))||(!!e.isRedacted()||!(!this.panel.showHiddenEvents||this.panel.shouldShowEvent(e,!0))))}add(e){const{event:t,shouldShow:n}=e;(t.getType()!==i.EventType.RoomMember||(0,sh.I3)(t,E.J.safeGet(),this.panel.showHiddenEvents))&&(this.readMarker=this.readMarker||this.panel.readMarkerForEvent(t.getId(),t===this.lastShownEvent),(this.panel.showHiddenEvents||n)&&t.getType()!==i.EventType.RoomPinnedEvents&&this.events.push(e))}generateKey(){return"eventlistsummary-"+this.events[0].event.getId()}getTiles(){var e;if(null===(e=this.events)||void 0===e||!e.length)return[];const t=this.panel,n=this.lastShownEvent,i=[];if(t.wantsSeparator(this.prevEvent,this.events[0].event)===Qp.W.Date){const e=this.events[0].event.getTs();i.push(s.createElement("li",{key:e+"~"},s.createElement(Xp.A,{roomId:this.events[0].event.getRoomId(),ts:e})))}const r=this.events.find((e=>this.panel.grouperKeyMap.get(e.event))),o=r&&this.panel.grouperKeyMap.has(r.event)?this.panel.grouperKeyMap.get(r.event):this.generateKey();r||this.panel.grouperKeyMap.set(this.events[0].event,o);let a=!1,l=this.events.map(((e,i)=>(e.event.getId()===t.props.highlightedEventId&&(a=!0),t.getTilesForEvent(0===i?this.prevEvent:this.events[i-1].event,e,e.event===n,true,this.nextEvent,this.nextEventTile)))).reduce(((e,t)=>e.concat(t)),[]);return 0===l.length&&(l=null),this.panel.props.canBackPaginate||this.prevEvent||i.push(s.createElement(ah,{key:"historytile"})),i.push(s.createElement(hh,{key:o,events:this.events.map((e=>e.event)),onToggle:t.onHeightChanged,startExpanded:a,layout:this.panel.props.layout},l)),this.readMarker&&i.push(this.readMarker),i}getNewPrevEvent(){return this.events[this.events.length-1].event}}(0,h.A)(vh,"canStartGroup",(function(e,{event:t,shouldShow:n}){return!!n&&(!(!t.isState()||!gh.includes(t.getType()))||(!!t.isRedacted()||!(!e.showHiddenEvents||e.shouldShowEvent(t,!0))))}));var fh=n("./src/components/views/dialogs/RoomSettingsDialog.tsx"),_h=n("./src/utils/rooms.ts"),yh=n("./src/models/LocalRoom.ts");const bh=e=>{if(!(0,_h.u)(e.client))return{shouldEncrypt:!1};if(!mc.A.shared().getRoomIds().has(e.roomId))return{shouldEncrypt:!1};if(1!==e.getInvitedAndJoinedMemberCount())return{shouldEncrypt:!1};const t=e.currentState.getStateEvents("m.room.third_party_invite")||[];return 1===t.length?{shouldEncrypt:!0,inviteEvent:t[0]}:{shouldEncrypt:!1}};const Eh=()=>{var e;const t=(0,s.useContext)(Pe.Ay),{room:n,roomId:r}=(0,Ld.ME)("room","roomId");if(!n||!r)throw new Error("Unable to create a NewRoomIntro without room and roomId");const o=n instanceof yh.Np,a=o?null===(e=n.targets[0])||void 0===e?void 0:e.userId:mc.A.shared().getUserIdForRoomId(r);let l;if(a){const{shouldEncrypt:e}=bh(n),t=((e,t)=>e instanceof yh.Np?(0,P.AO)("room|intro|send_message_start_dm"):t?(0,P.AO)("room|intro|encrypted_3pid_dm_pending_join"):(0,P.AO)("room|intro|start_of_dm_history"))(n,e);let i;n instanceof yh.Np||e||n.getJoinedMemberCount()+n.getInvitedMemberCount()!==2||(i=(0,P._t)("room|intro|dm_caption"));const r=null==n?void 0:n.getMember(a),o=(null==n?void 0:n.name)||(null==r?void 0:r.rawDisplayName)||a;l=s.createElement(s.Fragment,null,s.createElement(aa.A,{room:n,size:Fd,onClick:()=>{w.A.dispatch({action:R.r.ViewUser,member:r||{userId:a}})}}),s.createElement("h2",null,n.name),s.createElement("p",null,(0,P._t)(t,{},{displayName:()=>s.createElement("strong",null,o)})),i&&s.createElement("p",null,i))}else{var c,d,u,m,p;const e=n&&n.getMyMembership()===oa.O.Join,o=null===(c=n.currentState.getStateEvents(i.EventType.RoomTopic,""))||void 0===c||null===(c=c.getContent())||void 0===c?void 0:c.topic,a=e&&n.currentState.maySendStateEvent(i.EventType.RoomTopic,t.getSafeUserId()),h=()=>{w.A.dispatch({action:"open_room_settings",room_id:r},!0),setTimeout((()=>{var e;null===(e=window.document.getElementById("profileTopic"))||void 0===e||e.focus()}))};let g;a&&o?g=(0,P._t)("room|intro|topic_edit",{topic:o},{a:e=>s.createElement(Ae.A,{element:"a",kind:"link_inline",onClick:h},e)}):o?g=(0,P._t)("room|intro|topic",{topic:o}):a&&(g=(0,P._t)("room|intro|no_topic",{},{a:e=>s.createElement(Ae.A,{element:"a",kind:"link_inline",onClick:h},e)}));const v=null===(d=n.currentState.getStateEvents(i.EventType.RoomCreate,""))||void 0===d?void 0:d.getSender(),f=v&&(null==n||null===(u=n.getMember(v))||void 0===u?void 0:u.rawDisplayName)||v;let _,y,b;_=v===t.getUserId()?(0,P._t)("room|intro|you_created"):(0,P._t)("room|intro|user_created",{displayName:f}),null!==(m=xe.Ay.instance.activeSpaceRoom)&&void 0!==m&&m.canInvite(t.getSafeUserId())&&xe.Ay.instance.isRoomInSpace(xe.Ay.instance.activeSpace,n.roomId)&&(y=xe.Ay.instance.activeSpaceRoom),y&&(0,Ne.g)($.C.InviteUsers)?b=s.createElement("div",{className:"mx_NewRoomIntro_buttons"},s.createElement(Ae.A,{className:"mx_NewRoomIntro_inviteButton",kind:"primary",onClick:()=>{(0,Le.Lo)(y)}},(0,P._t)("invite|to_space",{spaceName:y.name})),n.canInvite(t.getSafeUserId())&&s.createElement(Ae.A,{className:"mx_NewRoomIntro_inviteButton",kind:"primary_outline",onClick:()=>{w.A.dispatch({action:"view_invite",roomId:r})}},(0,P._t)("room|intro|room_invite"))):n.canInvite(t.getSafeUserId())&&(0,Ne.g)($.C.InviteUsers)&&(b=s.createElement("div",{className:"mx_NewRoomIntro_buttons"},s.createElement(Ae.A,{className:"mx_NewRoomIntro_inviteButton",kind:"primary",onClick:()=>{w.A.dispatch({action:"view_invite",roomId:r})}},(0,P._t)("room|invite_this_room"))));const E=null===(p=n.currentState.getStateEvents(i.EventType.RoomAvatar,""))||void 0===p||null===(p=p.getContent())||void 0===p?void 0:p.url;let S=s.createElement(aa.A,{room:n,size:Fd,viewAvatarOnClick:!!E});E||(S=s.createElement(Ud,{hasAvatar:!1,noAvatarLabel:(0,P._t)("room|intro|no_avatar_label"),setAvatarUrl:e=>t.sendStateEvent(r,i.EventType.RoomAvatar,{url:e},"")},S)),l=s.createElement(s.Fragment,null,S,s.createElement("h2",null,n.name),s.createElement("p",null,_," ",(0,P._t)("room|intro|start_of_room",{},{roomName:()=>s.createElement("strong",null,n.name)})),s.createElement("p",null,g),b)}const h=(0,P._t)("room|intro|private_unencrypted_warning");let g;n.currentState.mayClientSendStateEvent(i.EventType.RoomEncryption,E.J.safeGet())&&!o&&(g=s.createElement(Ae.A,{kind:"link_inline",onClick:function(e){e.preventDefault(),w.A.dispatch({action:"open_room_settings",initial_tab_id:fh.e.Security})}},(0,P._t)("room|intro|enable_encryption_prompt")));const v=s.createElement("span",null," ",h," ",g," ");return s.createElement("li",{className:"mx_NewRoomIntro"},!function(e,t){const n=e.isRoomEncrypted(t.roomId);return"public"===t.getJoinRule()||!(0,_h.u)(e)||n}(t,n)&&s.createElement(oh.A,{className:"mx_cryptoEvent mx_cryptoEvent_icon_warning",title:(0,P._t)("room|intro|unencrypted_warning"),subtitle:v}),l)};class wh extends rh{shouldGroup({event:e,shouldShow:t}){const n=this.panel,r=this.firstEventAndShouldShow.event;if(!t)return!0;if(n.wantsSeparator(this.firstEventAndShouldShow.event,e)===Qp.W.Date)return!1;const s=e.getType();return(s!==i.EventType.RoomMember||e.getStateKey()===r.getSender()&&e.getContent().membership===oa.O.Join)&&(!i.M_BEACON_INFO.matches(s)&&!(!e.isState()||e.getSender()!==r.getSender()))}add(e){const{event:t,shouldShow:n}=e,r=this.panel;this.readMarker=this.readMarker||r.readMarkerForEvent(t.getId(),t===this.lastShownEvent),n&&(t.getType()===i.EventType.RoomEncryption?this.ejectedEvents.push(e):this.events.push(e))}getTiles(){var e,t;if(!this.events||!this.events.length)return[];const n=this.panel,i=[],r=!0,o=this.firstEventAndShouldShow,a=this.lastShownEvent;if(n.wantsSeparator(this.prevEvent,o.event)===Qp.W.Date){const e=o.event.getTs();i.push(s.createElement("li",{key:e+"~"},s.createElement(Xp.A,{roomId:o.event.getRoomId(),ts:e})))}o.shouldShow&&i.push(...n.getTilesForEvent(o.event,o));for(const e of this.ejectedEvents)i.push(...n.getTilesForEvent(o.event,e,o.event===a,r));const l=this.events.map((e=>n.getTilesForEvent(e.event,e,e.event===a,r))).reduce(((e,t)=>e.concat(t)),[]),c=this.events[this.events.length-1].event;let d;const u=c.getRoomId(),m=null!==(e=null===(t=c.sender)||void 0===t?void 0:t.name)&&void 0!==e?e:c.getSender();return d=u&&mc.A.shared().getUserIdForRoomId(u)?(0,P._t)("timeline|creation_summary_dm",{creator:m}):(0,P._t)("timeline|creation_summary_room",{creator:m}),i.push(s.createElement(Eh,{key:"newroomintro"})),i.push(s.createElement(ch,{key:"roomcreationsummary",events:this.events.map((e=>e.event)),onToggle:n.onHeightChanged,summaryMembers:c.sender?[c.sender]:void 0,summaryText:d,layout:this.panel.props.layout},l)),this.readMarker&&i.push(this.readMarker),i}getNewPrevEvent(){return this.firstEventAndShouldShow.event}}(0,h.A)(wh,"canStartGroup",(function(e,{event:t}){return t.getType()===i.EventType.RoomCreate}));var Sh=n("./src/components/structures/grouper/LateEventGrouper.ts");const Ah=[i.EventType.Sticker,i.EventType.RoomMessage];function Ch(e,t,n,i,r){return r!==Sp.Ae.ThreadsList&&(!(null==e||!e.sender||!t.sender)&&(!(t.getTs()-e.getTs()>3e5)&&(t.isRedacted()===e.isRedacted()&&(!!(t.getType()===e.getType()||Ah.includes(t.getType())&&Ah.includes(e.getType()))&&(t.sender.userId===e.sender.userId&&t.sender.name===e.sender.name&&t.sender.getMxcAvatarUrl()===e.sender.getMxcAvatarUrl()&&((!(0,Vp.zr)(t)&&!(0,Vp.zr)(e)||r===Sp.Ae.Thread)&&!!(0,nh.bN)(e,n,i)))))))}class xh extends s.Component{constructor(e,t){super(e,t),(0,h.A)(this,"readReceiptMap",{}),(0,h.A)(this,"readReceiptsByEvent",new Map),(0,h.A)(this,"readReceiptsByUserId",new Map),(0,h.A)(this,"_showHiddenEvents",void 0),(0,h.A)(this,"unmounted",!1),(0,h.A)(this,"readMarkerNode",(0,s.createRef)()),(0,h.A)(this,"whoIsTyping",(0,s.createRef)()),(0,h.A)(this,"scrollPanel",(0,s.createRef)()),(0,h.A)(this,"showTypingNotificationsWatcherRef",void 0),(0,h.A)(this,"eventTiles",{}),(0,h.A)(this,"grouperKeyMap",new WeakMap),(0,h.A)(this,"calculateRoomMembersCount",(()=>{this.setState({hideSender:this.shouldHideSender()})})),(0,h.A)(this,"onShowTypingNotificationsChange",(()=>{this.setState({showTypingNotifications:V.A.getValue("showTypingNotifications")})})),(0,h.A)(this,"isUnmounting",(()=>this.unmounted)),(0,h.A)(this,"collectGhostReadMarker",(e=>{e&&requestAnimationFrame((()=>{e.style.width="10%",e.style.opacity="0"}))})),(0,h.A)(this,"onGhostTransitionEnd",(e=>{const t=e.target.dataset.eventid;this.setState({ghostReadMarkers:this.state.ghostReadMarkers.filter((e=>e!==t))})})),(0,h.A)(this,"collectEventTile",((e,t)=>{this.eventTiles[e]=t})),(0,h.A)(this,"onHeightChanged",(()=>{const e=this.scrollPanel.current;e&&e.checkScroll()})),(0,h.A)(this,"onTypingShown",(()=>{const e=this.scrollPanel.current;null==e||e.checkScroll(),e&&e.getScrollState().stuckAtBottom&&e.preventShrinking()})),(0,h.A)(this,"onTypingHidden",(()=>{const e=this.scrollPanel.current;e&&(e.updatePreventShrinking(),e.checkScroll())})),this.state={ghostReadMarkers:[],showTypingNotifications:V.A.getValue("showTypingNotifications"),hideSender:this.shouldHideSender()},this._showHiddenEvents=V.A.getValue("showHiddenEventsInTimeline")}componentDidMount(){var e;this.unmounted=!1,this.showTypingNotificationsWatcherRef=V.A.watchSetting("showTypingNotifications",null,this.onShowTypingNotificationsChange),this.calculateRoomMembersCount(),null===(e=this.props.room)||void 0===e||e.currentState.on(i.RoomStateEvent.Update,this.calculateRoomMembersCount)}componentWillUnmount(){var e;this.unmounted=!0,null===(e=this.props.room)||void 0===e||e.currentState.off(i.RoomStateEvent.Update,this.calculateRoomMembersCount),V.A.unwatchSetting(this.showTypingNotificationsWatcherRef),this.readReceiptMap={}}componentDidUpdate(e,t){if(e.layout!==this.props.layout&&this.calculateRoomMembersCount(),e.readMarkerVisible&&e.readMarkerEventId&&this.props.readMarkerEventId!==e.readMarkerEventId){const t=this.state.ghostReadMarkers;t.push(e.readMarkerEventId),this.setState({ghostReadMarkers:t})}const n=this.pendingEditItem;if(!this.props.editState&&this.props.room&&n){const e=this.props.room.findEventById(n);w.A.dispatch({action:R.r.EditEvent,event:null!=e&&e.isRedacted()?null:e,timelineRenderingType:this.context.timelineRenderingType})}}shouldHideSender(){return!!this.props.room&&this.props.room.getInvitedAndJoinedMemberCount()<=2&&this.props.layout===zp.P.Bubble}getNodeForEventId(e){var t,n;if(this.eventTiles)return null!==(t=null===(n=this.eventTiles[e])||void 0===n||null===(n=n.ref)||void 0===n?void 0:n.current)&&void 0!==t?t:void 0}getTileForEventId(e){if(this.eventTiles&&e)return this.eventTiles[e]}isAtBottom(){var e;return null===(e=this.scrollPanel.current)||void 0===e?void 0:e.isAtBottom()}getScrollState(){var e,t;return null!==(e=null===(t=this.scrollPanel.current)||void 0===t?void 0:t.getScrollState())&&void 0!==e?e:null}getReadMarkerPosition(){var e;const t=this.readMarkerNode.current,n=null===(e=this.scrollPanel.current)||void 0===e?void 0:e.divScroll;if(!t||!n)return null;const i=n.getBoundingClientRect(),r=t.getBoundingClientRect();return r.bottom+2<i.top?-1:r.top<i.bottom?0:1}scrollToTop(){var e;null===(e=this.scrollPanel.current)||void 0===e||e.scrollToTop()}scrollToBottom(){var e;null===(e=this.scrollPanel.current)||void 0===e||e.scrollToBottom()}handleScrollKey(e){var t;null===(t=this.scrollPanel.current)||void 0===t||t.handleScrollKey(e)}scrollToEvent(e,t,n){var i;null===(i=this.scrollPanel.current)||void 0===i||i.scrollToToken(e,t,n)}scrollToEventIfNeeded(e){const t=this.getNodeForEventId(e);t&&t.scrollIntoView({block:"nearest",behavior:"instant"})}get showHiddenEvents(){var e,t;return null!==(e=null===(t=this.context)||void 0===t?void 0:t.showHiddenEvents)&&void 0!==e?e:this._showHiddenEvents}shouldShowEvent(e,t=!1){if(this.props.hideThreadedMessages&&this.props.room){const{shouldLiveInRoom:t}=this.props.room.eventShouldLiveIn(e,this.props.events);if(!t)return!1}return!E.J.safeGet().isUserIgnored(e.getSender())&&(!(!this.showHiddenEvents||t)||!!(0,nh.bN)(e,E.J.safeGet(),this.showHiddenEvents)&&(this.props.highlightedEventId===e.getId()||!(0,cu.A)(e,this.context)))}readMarkerForEvent(e,t){if(this.context.timelineRenderingType===Sp.Ae.File)return null;const n=!t&&this.props.readMarkerVisible;if(this.props.readMarkerEventId===e){let t;return n&&(t=s.createElement("hr",{style:{opacity:1,width:"99%"}})),s.createElement("li",{key:"readMarker_"+e,ref:this.readMarkerNode,className:"mx_MessagePanel_myReadMarker","data-scroll-tokens":e},t)}if(this.state.ghostReadMarkers.includes(e)){const t=s.createElement("hr",{ref:this.collectGhostReadMarker,onTransitionEnd:this.onGhostTransitionEnd,"data-eventid":e});return s.createElement("li",{key:"_readuptoghost_"+e,className:"mx_MessagePanel_myReadMarker"},t)}return null}getNextEventInfo(e,t){const n=t<e.length-1?e[t+1]:null,i=function(e,t){for(let n=e+1;n<t.length;n++){const{event:e,shouldShow:i}=t[n];if(i)return e}return null}(t,e);return{nextEventAndShouldShow:n,nextTile:i}}get pendingEditItem(){if(!this.props.room)return null;try{return localStorage.getItem((0,ih.O)(this.props.room.roomId,this.context.timelineRenderingType))}catch(e){return o.v.error(e),null}}isSentState(e){const t=e.getAssociatedStatus();return!t||t===i.EventStatus.SENT}getEventTiles(){let e;const t=this.props.events.map((e=>({event:e,shouldShow:this.shouldShowEvent(e)}))),n=E.J.safeGet().getSafeUserId();let i=!1,r=-1;for(let s=t.length-1;s>=0;s--){const{event:o,shouldShow:a}=t[s];if(a&&(void 0===e&&(e=o),!i&&this.isSentState(o)&&(0,Wp.CH)(o)&&(i=!0,o.getSender()===n&&(t[s].lastSuccessfulWeSent=!0)),r<0&&!o.status&&(r=s),r>=0&&i))break}const s=[];let o=null;this.readReceiptsByEvent=new Map,this.props.showReadReceipts&&(this.readReceiptsByEvent=this.getReadReceiptsByShownEvent(t));let a=null;for(let n=0;n<t.length;n++){const i=t[n],{event:l,shouldShow:c}=i,d=l.getId(),u=l===e,{nextEventAndShouldShow:m,nextTile:p}=this.getNextEventInfo(t,n);if(a){if(a.shouldGroup(i)){a.add(i);continue}s.push(...a.getTiles()),o=a.getNewPrevEvent(),a=null}for(const t of kh)if(t.canStartGroup(this,i)&&!this.props.disableGrouping){a=new t(this,i,o,e,m,p);break}if(!a){c&&(s.push(...this.getTilesForEvent(o,i,u,!1,m,p)),o=l);const e=this.readMarkerForEvent(d,n>=r);e&&s.push(e)}}return a&&s.push(...a.getTiles()),s}getTilesForEvent(e,t,n=!1,i=!1,r=null,o=null){var a,l,c;const d=t.event,u=[],m=(null===(a=this.props.editState)||void 0===a?void 0:a.getEvent().getId())===d.getId(),p=null!==(l=d.getTs())&&void 0!==l?l:Date.now(),h=this.wantsSeparator(e,d);if(!i&&this.props.room)if(h===Qp.W.Date)u.push(s.createElement("li",{key:p},s.createElement(Xp.A,{key:p,roomId:this.props.room.roomId,ts:p})));else if(h===Qp.W.LateEvent){var g;const e=(0,P._t)("timeline|late_event_separator",{dateTime:(0,Bp.Yq)(null!==(g=d.getDate())&&void 0!==g?g:new Date)});u.push(s.createElement("li",{key:p},s.createElement(Qp.A,{key:p,label:e},e)))}const v=E.J.safeGet();let f=!0;if(o){const e=o;f=this.wantsSeparator(d,e)===Qp.W.Date||d.getSender()!==e.getSender()||(0,th.v)(v,e,this.showHiddenEvents).isInfoMessage||!Ch(d,e,v,this.showHiddenEvents,this.context.timelineRenderingType)}const _=h===Qp.W.None&&Ch(e,d,v,this.showHiddenEvents,this.context.timelineRenderingType),y=d.getId(),b=y===this.props.highlightedEventId,w=this.readReceiptsByEvent.get(y),S=this.props.callEventGroupers.get(d.getContent().call_id);return u.push(s.createElement(Wp.Ay,{key:d.getTxnId()||y,as:"li",ref:this.collectEventTile.bind(this,y),alwaysShowTimestamps:this.props.alwaysShowTimestamps,mxEvent:d,continuation:_,isRedacted:d.isRedacted(),replacingEventId:d.replacingEventId(),editState:m?this.props.editState:void 0,onHeightChanged:this.onHeightChanged,readReceipts:w,readReceiptMap:this.readReceiptMap,showUrlPreview:this.props.showUrlPreview,checkUnmounting:this.isUnmounting,eventSendStatus:null!==(c=d.getAssociatedStatus())&&void 0!==c?c:void 0,isTwelveHour:this.props.isTwelveHour,permalinkCreator:this.props.permalinkCreator,last:n,lastInSection:f,lastSuccessful:t.lastSuccessfulWeSent,isSelectedEvent:b,getRelationsForEvent:this.props.getRelationsForEvent,showReactions:this.props.showReactions,layout:this.props.layout,showReadReceipts:this.props.showReadReceipts,callEventGrouper:S,hideSender:this.state.hideSender})),u}wantsSeparator(e,t){var n;if(this.context.timelineRenderingType===Sp.Ae.ThreadsList)return Qp.W.None;if(null!==e){var i;const n=(0,Sh.R)(t);if((null==n?void 0:n.group_id)!==(null===(i=(0,Sh.R)(e))||void 0===i?void 0:i.group_id))return void 0!==n?Qp.W.LateEvent:Qp.W.Date}if(null===e&&!this.props.canBackPaginate)return Qp.W.Date;const r=null!==(n=t.getDate())&&void 0!==n?n:new Date;return null!==e&&(0,Bp.fq)(e.getDate()||void 0,r)?Qp.W.Date:Qp.W.None}getReadReceiptsForEvent(e){const t=E.J.safeGet().credentials.userId,{room:n}=this.props;if(!n)return null;const i=this.context.threadId?n.getThread(this.context.threadId):n,r=[];return i?(i.getReceiptsForEvent(e).forEach((e=>{if(!e.userId||!(0,g.ll)(e.type)||e.userId===t)return;if(E.J.safeGet().isUserIgnored(e.userId))return;const i=n.getMember(e.userId);r.push({userId:e.userId,roomMember:i,ts:e.data?e.data.ts:0})})),r):(o.v.debug("Discarding request, could not find the receiptDestination for event: "+this.context.threadId),r)}getReadReceiptsByShownEvent(e){const t=new Map,n=new Map;let i;for(const e of this.props.events){if(this.shouldShowEvent(e)&&(i=e.getId()),!i)continue;const r=t.get(i)||[],s=this.getReadReceiptsForEvent(e);if(s){t.set(i,r.concat(s));for(const e of s)n.set(e.userId,{lastShownEventId:i,receipt:e})}}for(const e of this.readReceiptsByUserId.keys()){if(n.get(e))continue;const{lastShownEventId:i,receipt:r}=this.readReceiptsByUserId.get(e),s=t.get(i)||[];t.set(i,s.concat(r)),n.set(e,{lastShownEventId:i,receipt:r})}this.readReceiptsByUserId=n;for(const e of t.values())e.sort(((e,t)=>t.ts-e.ts));return t}updateTimelineMinHeight(){const e=this.scrollPanel.current;if(e){const t=e.isAtBottom(),n=this.whoIsTyping.current,i=n&&n.isVisible();t&&i&&e.preventShrinking()}}onTimelineReset(){const e=this.scrollPanel.current;e&&e.clearPreventShrinking()}render(){let e,t;this.props.backPaginating&&(e=s.createElement("li",{key:"_topSpinner"},s.createElement(Na.A,null))),this.props.forwardPaginating&&(t=s.createElement("li",{key:"_bottomSpinner"},s.createElement(Na.A,null)));const n=this.props.hidden?{display:"none"}:{};let i,r;var o,a;(this.props.room&&this.state.showTypingNotifications&&this.context.timelineRenderingType===Sp.Ae.Room&&(i=s.createElement(Yp,{room:this.props.room,onShown:this.onTypingShown,onHidden:this.onTypingHidden,ref:this.whoIsTyping})),this.props.layout==zp.P.IRC)&&(r=s.createElement(Gp,{minWidth:20,maxWidth:600,roomId:null!==(o=null===(a=this.props.room)||void 0===a?void 0:a.roomId)&&void 0!==o?o:null}));const l=re()(this.props.className,{mx_MessagePanel_narrow:this.context.narrow});return s.createElement(eh.A,null,s.createElement(Zp.A,{ref:this.scrollPanel,className:l,onScroll:this.props.onScroll,onFillRequest:this.props.onFillRequest,onUnfillRequest:this.props.onUnfillRequest,style:n,stickyBottom:this.props.stickyBottom,resizeNotifier:this.props.resizeNotifier,fixedChildren:r},e,this.getEventTiles(),i,t))}}(0,h.A)(xh,"contextType",Sp.Ay),(0,h.A)(xh,"defaultProps",{disableGrouping:!1});const kh=[wh,vh];var Rh=n("./src/Avatar.ts"),Ih=n("./node_modules/raw-loader/dist/cjs.js!./src/utils/exportUtils/exportCustomCSS.css");const Th=/\.[\w-]+/g;function Ph(e){const t="-apple-system, BlinkMacSystemFont, avenir next,\n            avenir, segoe ui, helvetica neue, helvetica, Ubuntu, roboto, noto, arial, sans-serif";return e.replace(/font-family: ?(Inter|'Inter'|"Inter")/g,`font-family: ${t}`).replace(/--cpd-font-family-sans: ?(Inter|'Inter'|"Inter")/g,`--cpd-font-family-sans: ${t}`).replace(/font-family: ?Inconsolata/g,"font-family: Menlo, Consolas, Monaco, Liberation Mono, Lucida Console, monospace")}function Nh(e,t){return"Raw"!==e.prelude.type||!e.block.children.isEmpty&&e.prelude.value.split(",").some((e=>{const n=e.trim().match(Th);return!(n&&!n.every((e=>t.has(e.substring(1)))))}))}const Dh=async e=>{const t=await n.e(5914).then(n.bind(n,"./node_modules/css-tree/lib/index.js")),i=["bundle.css","theme-light.css"].map((e=>{var t;return null===(t=document.querySelector(`link[rel="stylesheet"][href$="${e}"]`))||void 0===t?void 0:t.href}));let r="";for(const n of i){if(!n)continue;const i=await fetch(n),s=await i.text(),o=t.parse(s,{context:"stylesheet",parseAtrulePrelude:!1,parseRulePrelude:!1,parseValue:!1,parseCustomProperty:!1});for(const n of o.children)"Atrule"===n.type&&"font-face"===n.name||("Rule"!==n.type||Nh(n,e))&&(r+=Ph(t.generate(n)))}return r+Ih.A};class Mh extends jp{constructor(e,t,n,i){super(e,t,n,i),(0,h.A)(this,"avatars",void 0),(0,h.A)(this,"permalinkCreator",void 0),(0,h.A)(this,"totalSize",void 0),(0,h.A)(this,"mediaOmitText",void 0),this.avatars=new Map,this.permalinkCreator=new uu.pE(this.room),this.totalSize=0,this.mediaOmitText=this.exportOptions.attachmentsIncluded?(0,P._t)("export_chat|media_omitted_file_size"):(0,P._t)("export_chat|media_omitted")}async getRoomAvatar(){let e;const t=Rh.ze(this.room,32,32,"crop"),n="room.png";if(t)try{const i=await fetch(t);e=await i.blob(),this.totalSize+=e.size,this.addFile(n,e)}catch(e){o.v.log("Failed to fetch room's avatar"+e)}const i=s.createElement(ja.A,{size:"32px",name:this.room.name,title:this.room.name,url:e?n:""});return(0,Pp.qV)(i)}async wrapHTML(e,t,n){var r,o,a,l;const c=await this.getRoomAvatar(),d=(0,Bp.Ah)(new Date),u=null===(r=this.room.currentState.getStateEvents(i.EventType.RoomCreate,""))||void 0===r?void 0:r.getSender(),m=(u?null===(o=this.room.getMember(u))||void 0===o?void 0:o.rawDisplayName:u)||u,p=this.room.client.getSafeUserId(),h=null===(a=this.room.getMember(p))||void 0===a?void 0:a.rawDisplayName,g=(null===(l=this.room.currentState.getStateEvents(i.EventType.RoomTopic,""))||void 0===l||null===(l=l.getContent())||void 0===l?void 0:l.topic)||"",v=Dp()((0,P._t)("export_chat|creator_summary",{creatorName:m})),f=Dp()(p),_=Dp()(this.room.name),y=Dp()(g),b=(0,Pp.qV)(s.createElement("p",null,(0,P._t)("export_chat|export_info",{exportDate:d},{roomName:()=>s.createElement("strong",null,_),exporterDetails:()=>s.createElement("a",{href:`https://matrix.to/#/${encodeURIComponent(p)}`,target:"_blank",rel:"noopener noreferrer"},h?s.createElement(s.Fragment,null,s.createElement("strong",null,Dp()(h)),"I "," ("+f+")"):s.createElement("strong",null,f))}))),E=g?(0,P._t)("export_chat|topic",{topic:y}):"",w=(0,Pp.qV)(0!==t?s.createElement("div",{style:{textAlign:"center"}},s.createElement("a",{href:`./messages${1===t?"":t}.html`,style:{fontWeight:"bold"}},(0,P._t)("export_chat|previous_page"))):s.createElement(s.Fragment,null)),S=(0,Pp.qV)(t<n-1?s.createElement("div",{style:{textAlign:"center",margin:"10px"}},s.createElement("a",{href:"./messages"+(t+2)+".html",style:{fontWeight:"bold"}},(0,P._t)("export_chat|next_page"))):s.createElement(s.Fragment,null));return`\n          <!DOCTYPE html>\n            <html lang="en">\n            <head>\n                <meta charset="UTF-8" />\n                <meta http-equiv="X-UA-Compatible" content="IE=edge" />\n                <meta name="viewport" content="width=device-width, initial-scale=1.0" />\n                <link href="css/style.css" rel="stylesheet" />\n                <script src="js/script.js"><\/script>\n                <title>${(0,P._t)("export_chat|html_title")}</title>\n            </head>\n            <body style="height: 100vh;" class="cpd-theme-light">\n                <div id="matrixchat" style="height: 100%; overflow: auto">\n                    <div class="mx_MatrixChat_wrapper" aria-hidden="false">\n                        <div class="mx_MatrixChat">\n                        <main class="mx_RoomView">\n                            <div class="mx_Flex mx_RoomHeader light-panel">\n                                ${c}\n                                <div class="mx_RoomHeader_infoWrapper">\n                                    <div\n                                        dir="auto"\n                                        class="mx_RoomHeader_info"\n                                        title="${_}"\n                                    >\n                                        <span class="mx_RoomHeader_truncated mx_lineClamp">\n                                            ${_}\n                                        </span>\n                                    </div>\n                                </div>\n                            </div>\n                            ${w}\n                            <div class="mx_MainSplit">\n                            <div class="mx_RoomView_body">\n                                <div\n                                class="mx_RoomView_timeline mx_RoomView_timeline_rr_enabled"\n                                >\n                                <div\n                                    class="\n                                    mx_AutoHideScrollbar\n                                    mx_ScrollPanel\n                                    mx_RoomView_messagePanel\n                                    "\n                                >\n                                    <div class="mx_RoomView_messageListWrapper">\n                                    <ol\n                                        class="mx_RoomView_MessageList"\n                                        aria-live="polite"\n                                        role="list"\n                                    >\n                                    ${0==t?`<div class="mx_NewRoomIntro">\n                                            ${c}\n                                            <h2> ${_} </h2>\n                                            <p> ${v} <br/><br/> ${b} </p>\n                                            <br/>\n                                            <p> ${E} </p>\n                                        </div>`:""}\n                                    ${e}\n                                    </ol>\n                                    </div>\n                                </div>\n                                </div>\n                                <div class="mx_RoomView_statusArea">\n                                <div class="mx_RoomView_statusAreaBox">\n                                    <div class="mx_RoomView_statusAreaBox_line"></div>\n                                </div>\n                                </div>\n                            </div>\n                            </div>\n                            ${S}\n                        </main>\n                        </div>\n                    </div>\n                </div>\n                <div id="snackbar"/>\n            </body>\n        </html>`}getAvatarURL(e){const t=e.sender,n=null==t?void 0:t.getMxcAvatarUrl();return n?(0,Up.lH)(n).getThumbnailOfSourceHttp(30,30,"crop"):null}async saveAvatarIfNeeded(e){const t=e.sender;if(!this.avatars.has(t.userId))try{const n=this.getAvatarURL(e);this.avatars.set(t.userId,!0);const i=await fetch(n),r=await i.blob();this.addFile(`users/${t.userId.replace(/:/g,"-")}.png`,r)}catch(e){o.v.log("Failed to fetch user's avatar"+e)}}getDateSeparator(e){const t=e.getTs(),n=s.createElement("li",{key:t},s.createElement(Xp.A,{forExport:!0,key:t,roomId:e.getRoomId(),ts:t}));return(0,Pp.qV)(n)}needsDateSeparator(e,t){return!t||(0,Bp.fq)(t.getDate()||void 0,e.getDate()||void 0)}getEventTile(e,t,n){return s.createElement("div",{className:"mx_Export_EventWrapper",id:e.getId()},s.createElement(Pe.Ay.Provider,{value:this.room.client},s.createElement(_.B,null,s.createElement(Wp.Ay,{mxEvent:e,continuation:t,isRedacted:e.isRedacted(),replacingEventId:e.replacingEventId(),forExport:!0,alwaysShowTimestamps:!0,showUrlPreview:!1,checkUnmounting:()=>!1,isTwelveHour:!1,last:!1,lastInSection:!1,permalinkCreator:this.permalinkCreator,lastSuccessful:!1,isSelectedEvent:!1,showReactions:!0,layout:zp.P.Group,showReadReceipts:!1,getRelationsForEvent:this.getRelationsForEvent,ref:n}))))}async getEventTileMarkup(e,t,n){const r=this.getAvatarURL(e),s=!!r;s&&await this.saveAvatarIfNeeded(e);const o=(0,g.v6)(),a=this.getEventTile(e,t,o.resolve);let l;if(e.getContent().msgtype==i.MsgType.Emote||e.getContent().msgtype==i.MsgType.Notice||e.getContent().msgtype===i.MsgType.Text){const e=document.createElement("div"),t=(0,Tp.H)(e);t.render(a),await o.promise,l=e.innerHTML,t.unmount()}else l=(0,Pp.qV)(a);if(n){var c,d;const t=null!==(c=e.getContent().url)&&void 0!==c?c:null===(d=e.getContent().file)||void 0===d?void 0:d.url;l=l.split(t).join(n)}return l=l.replace(/<span class="mx_MFileBody_info_icon".*?>.*?<\/span>/,""),s&&(l=l.replace(encodeURI(r).replace(/&/g,"&amp;"),`users/${e.sender.userId.replace(/:/g,"-")}.png`)),l}createModifiedEvent(e,t,n=!0){const r={msgtype:i.MsgType.Text,body:`${e}`,format:"org.matrix.custom.html",formatted_body:`${e}`};n&&(r.formatted_body="<em>"+r.formatted_body+"</em>",r.body="*"+r.body+"*");const s=new i.MatrixEvent;return s.event=t.event,s.sender=t.sender,s.event.type="m.room.message",s.event.content=r,s}async createMessageBody(e,t=!1){let n;try{if(this.isAttachment(e))if(this.exportOptions.attachmentsIncluded)try{const i=await this.getMediaBlob(e);if(this.totalSize+i.size>this.exportOptions.maxSize)n=await this.getEventTileMarkup(this.createModifiedEvent(this.mediaOmitText,e),t);else{this.totalSize+=i.size;const r=this.getFilePath(e);n=await this.getEventTileMarkup(e,t,r),this.totalSize==this.exportOptions.maxSize&&(this.exportOptions.attachmentsIncluded=!1),this.addFile(r,i)}}catch(i){o.v.log("Error while fetching file"+i),n=await this.getEventTileMarkup(this.createModifiedEvent((0,P._t)("export_chat|error_fetching_file"),e),t)}else n=await this.getEventTileMarkup(this.createModifiedEvent(this.mediaOmitText,e),t);else n=await this.getEventTileMarkup(e,t)}catch(i){o.v.error(i),n=await this.getEventTileMarkup(this.createModifiedEvent((0,sh.Rd)(e,this.room.client),e,!1),t)}return n}async createHTML(e,t,n,i){let r="",s=null;for(let n=t;n<Math.min(t+1e3,e.length);n++){const t=e[n];if(this.updateProgress((0,P._t)("export_chat|processing_event_n",{number:n+1,total:e.length}),!1,!0),this.cancelled)return this.cleanUp();if(!(0,nh.bN)(t,this.room.client,!1))continue;r+=this.needsDateSeparator(t,s)?this.getDateSeparator(t):"";const i=!this.needsDateSeparator(t,s)&&Ch(s,t,this.room.client,!1),o=await this.createMessageBody(t,i);this.totalSize+=(new TextEncoder).encode(o).byteLength,r+=o,s=t}return this.wrapHTML(r,n,i)}async export(){this.updateProgress((0,P._t)("export_chat|starting_export"));const e=performance.now(),t=await this.getRequiredEvents(),n=performance.now();this.updateProgress((0,P._t)("export_chat|fetched_n_events_in_time",{count:t.length,seconds:(n-e)/1e3}),!0,!1),this.updateProgress((0,P._t)("export_chat|creating_html"));const i=new Set;for(let e=0;e<t.length/1e3;e++){const n=await this.createHTML(t,1e3*e,e,t.length/1e3);(new DOMParser).parseFromString(n,"text/html").querySelectorAll("*").forEach((e=>{e.classList.forEach((e=>i.add(e)))})),this.addFile(`messages${e?e+1:""}.html`,new Blob([n]))}const r=await Dh(i);this.addFile("css/style.css",new Blob([r])),this.addFile("js/script.js",new Blob(['/*\nCopyright 2024 New Vector Ltd.\nCopyright 2021 The Matrix.org Foundation C.I.C.\n\nSPDX-License-Identifier: AGPL-3.0-only OR GPL-3.0-only\nPlease see LICENSE files in the repository root for full details.\n*/\n\n// This file is raw-imported (imported as plain text) for the export bundle, which is why this is in JS\nfunction showToastIfNeeded(replyId) {\n    const el = document.getElementById(replyId);\n    if (!el) {\n        showToast("The message you\'re looking for wasn\'t exported");\n        return;\n    }\n}\n\nfunction showToast(text) {\n    const el = document.getElementById("snackbar");\n    el.innerHTML = text;\n    el.className = "mx_show";\n    window.setTimeout(() => {\n        el.className = el.className.replace("mx_show", "");\n    }, 2000);\n}\n\nwindow.onload = () => {\n    document.querySelectorAll(".mx_reply_anchor").forEach((element) => {\n        element.addEventListener("click", (event) => {\n            showToastIfNeeded(event.target.dataset.scrollTo);\n        });\n    });\n};\n'])),await this.downloadZIP();const s=performance.now();this.cancelled?o.v.info("Export cancelled successfully"):(this.updateProgress((0,P._t)("export_chat|export_successful")),this.updateProgress((0,P._t)("export_chat|exported_n_events_in_time",{count:t.length,seconds:(s-e)/1e3}))),this.cleanUp()}}class Oh extends jp{constructor(e,t,n,i){super(e,t,n,i),(0,h.A)(this,"totalSize",0),(0,h.A)(this,"messages",[])}get destinationFileName(){return this.makeFileNameNoExtension()+".json"}createJSONString(){var e,t,n,r;const s=(0,Bp.Ah)(new Date),o=null===(e=this.room.currentState.getStateEvents(i.EventType.RoomCreate,""))||void 0===e?void 0:e.getSender(),a=o&&(null===(t=this.room)||void 0===t||null===(t=t.getMember(o))||void 0===t?void 0:t.rawDisplayName)||o,l=(null===(n=this.room.currentState.getStateEvents(i.EventType.RoomTopic,""))||void 0===n||null===(n=n.getContent())||void 0===n?void 0:n.topic)||"",c=this.room.client.getUserId(),d=(null===(r=this.room)||void 0===r||null===(r=r.getMember(c))||void 0===r?void 0:r.rawDisplayName)||c,u={room_name:this.room.name,room_creator:a,topic:l,export_date:s,exported_by:d,messages:this.messages};return JSON.stringify(u,null,2)}async getJSONString(e){if(this.exportOptions.attachmentsIncluded&&this.isAttachment(e))try{const t=await this.getMediaBlob(e);if(this.totalSize+t.size<this.exportOptions.maxSize){this.totalSize+=t.size;const n=this.getFilePath(e);this.totalSize==this.exportOptions.maxSize&&(this.exportOptions.attachmentsIncluded=!1),this.addFile(n,t)}}catch(e){o.v.log("Error fetching file: "+e)}return e.getEffectiveEvent()}async createOutput(e){for(let t=0;t<e.length;t++){const n=e[t];if(this.updateProgress((0,P._t)("export_chat|processing_event_n",{number:t+1,total:e.length}),!1,!0),this.cancelled)return this.cleanUp();(0,nh.bN)(n,this.room.client,!1)&&this.messages.push(await this.getJSONString(n))}return this.createJSONString()}async export(){o.v.info("Starting export process..."),o.v.info("Fetching events...");const e=performance.now(),t=await this.getRequiredEvents(),n=performance.now();o.v.log(`Fetched ${t.length} events in ${(n-e)/1e3}s`),o.v.info("Creating output...");const i=await this.createOutput(t);if(this.files.length)this.addFile("export.json",new Blob([i])),await this.downloadZIP();else{const e=this.destinationFileName;this.downloadPlainText(e,i)}const r=performance.now();this.cancelled?o.v.info("Export cancelled successfully"):(o.v.info("Export successful!"),o.v.log(`Exported ${t.length} events in ${(r-e)/1e3} seconds`)),this.cleanUp()}}class Lh extends jp{constructor(e,t,n,i){super(e,t,n,i),(0,h.A)(this,"totalSize",void 0),(0,h.A)(this,"mediaOmitText",void 0),(0,h.A)(this,"textForReplyEvent",(e=>{const t=/> <(.*?)>(.*?)\n\n(.*)/s.exec(e.body);if(!t)return e.body;let n;const i=t[1],r=t[3];n=t[2].substring(1);const s=n.split("\n").filter((e=>!/^\s*$/.test(e)));return s.length>0?(n=s[0].substring(0,32),s[0].length>32&&(n+="..."),n=` "${n}"`):n="",`<${i}${n}> ${r}`})),(0,h.A)(this,"plainTextForEvent",(async e=>{const t=e.sender&&e.sender.name?e.sender.name:e.getSender();let n="";if(this.isAttachment(e))if(this.exportOptions.attachmentsIncluded)try{const t=await this.getMediaBlob(e);if(this.totalSize+t.size>this.exportOptions.maxSize)n=` (${this.mediaOmitText})`;else{this.totalSize+=t.size;const i=this.getFilePath(e);n=" ("+(0,P._t)("export_chat|file_attached")+")",this.addFile(i,t),this.totalSize==this.exportOptions.maxSize&&(this.exportOptions.attachmentsIncluded=!1)}}catch(e){n=" ("+(0,P._t)("export_chat|error_fetching_file")+")",o.v.log("Error fetching file "+e)}else n=` (${this.mediaOmitText})`;return this.isReply(e)?t+": "+this.textForReplyEvent(e.getContent())+n:(0,sh.Rd)(e,this.room.client)+n})),this.totalSize=0,this.mediaOmitText=this.exportOptions.attachmentsIncluded?(0,P._t)("export_chat|media_omitted_file_size"):(0,P._t)("export_chat|media_omitted")}get destinationFileName(){return this.makeFileNameNoExtension()+".txt"}async createOutput(e){let t="";for(let n=0;n<e.length;n++){const i=e[n];if(this.updateProgress((0,P._t)("export_chat|processing_event_n",{number:n+1,total:e.length}),!1,!0),this.cancelled)return this.cleanUp();if(!(0,nh.bN)(i,this.room.client,!1))continue;const r=await this.plainTextForEvent(i);t+=r&&`${(0,Bp.Lu)(new Date(i.getTs()),V.A.getValue("showTwelveHourTimestamps"))} - ${r}\n`}return t}async export(){this.updateProgress((0,P._t)("export_chat|starting_export")),this.updateProgress((0,P._t)("export_chat|fetching_events"));const e=performance.now(),t=await this.getRequiredEvents(),n=performance.now();o.v.log(`Fetched ${t.length} events in ${(n-e)/1e3}s`),this.updateProgress((0,P._t)("export_chat|creating_output"));const i=await this.createOutput(t);if(this.files.length)this.addFile("export.txt",new Blob([i])),await this.downloadZIP();else{const e=this.destinationFileName;this.downloadPlainText(e,i)}const r=performance.now();this.cancelled?o.v.info("Export cancelled successfully"):(o.v.info("Export successful!"),o.v.log(`Exported ${t.length} events in ${(r-e)/1e3} seconds`)),this.cleanUp()}}const Fh=()=>({}),Uh=(e,t)=>n=>"number"==typeof n&&!(isNaN(n)||e>n||n>t),Bh=({room:e,onFinished:t})=>{const{exportFormat:n,exportType:i,includeAttachments:r,numberOfMessages:a,sizeLimit:l,setExportFormat:c,setExportType:d,setNumberOfMessages:u,setSizeLimit:m,setAttachments:p}=(()=>{var e,t,n,i,r;const o=Fh(),[a,l]=(0,s.useState)(null!==(e=o.format)&&void 0!==e?e:xp.Html),[c,d]=(0,s.useState)(null!==(t=o.range)&&void 0!==t?t:kp.Timeline),[u,m]=(0,s.useState)(null!==(n=o.includeAttachments)&&void 0!==n&&n),[p,h]=(0,s.useState)(null!==(i=o.numberOfMessages)&&void 0!==i?i:100),[g,v]=(0,s.useState)(null!==(r=o.sizeMb)&&void 0!==r?r:8);return{exportFormat:a,exportType:c,includeAttachments:u,numberOfMessages:p,sizeLimit:g,setExportFormat:o.format?void 0:l,setExportType:o.range?void 0:d,setNumberOfMessages:o.numberOfMessages?void 0:h,setSizeLimit:o.sizeMb?void 0:v,setAttachments:void 0===o.includeAttachments?m:void 0}})(),[h,g]=(0,s.useState)(!1),v=(0,s.useRef)(null),f=(0,s.useRef)(null),[_,y]=(0,s.useState)((0,P._t)("export_chat|processing")),[b,E]=(0,s.useState)(!1),[w,S]=(0,s.useState)(!1),[A,C]=(0,s.useState)(!1),[x,k]=((e,t)=>{const[n,i]=(0,s.useState)(e);return[n,e=>{i(e),t(e)}]})(null,(async e=>{await(null==e?void 0:e.export().then((()=>{w||C(!0)})))})),R=async()=>{var t;if(!m||await(null===(t=v.current)||void 0===t?void 0:t.validate({focused:!1}))){if(i===kp.LastNMessages){var s;var c;if(!await(null===(s=f.current)||void 0===s?void 0:s.validate({focused:!1})))return void(null===(c=f.current)||void 0===c||c.validate({focused:!0}))}g(!0),await(async()=>{const t={numberOfMessages:a,attachmentsIncluded:r,maxSize:1024*l*1024};switch(n){case xp.Html:k(new Mh(e,kp[i],t,y));break;case xp.Json:k(new Oh(e,kp[i],t,y));break;case xp.PlainText:k(new Lh(e,kp[i],t,y));break;default:return void o.v.error("Unknown export format")}})()}else{var d;null===(d=v.current)||void 0===d||d.validate({focused:!0})}},I=(0,Ip.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,P._t)("export_chat|enter_number_between_min_max",{min:1,max:2e3})},{key:"number",test:({value:e})=>{const t=parseInt(e,10);return Uh(1,2e3)(t)},invalid:()=>(0,P._t)("export_chat|size_limit_min_max",{min:1,max:2e3})}]}),T=async e=>await I(e),N=(0,Ip.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,P._t)("export_chat|enter_number_between_min_max",{min:1,max:10**8})},{key:"number",test:({value:e})=>{const t=parseInt(e,10);return Uh(1,10**8)(t)},invalid:()=>(0,P._t)("export_chat|num_messages_min_max",{min:1,max:10**8})}]}),D=async e=>await N(e),M=async()=>{h?E(!0):t(!1)},O=async()=>{await(null==x?void 0:x.cancelExport()),S(!0),g(!1),k(null)},L=Object.values(xp).map((e=>({value:e,label:Rp(e)}))),F=Object.values(kp).map((e=>s.createElement("option",{key:kp[e],value:e},(e=>{switch(e){case kp.Beginning:return(0,P._t)("export_chat|from_the_beginning");case kp.LastNMessages:return(0,P._t)("export_chat|number_of_messages");case kp.Timeline:return(0,P._t)("export_chat|current_timeline");default:throw new Error("Unknown type: "+e)}})(e))));let U;i===kp.LastNMessages&&u&&(U=s.createElement(Sa.A,{id:"message-count",element:"input",type:"number",value:a.toString(),ref:f,onValidate:D,label:(0,P._t)("export_chat|num_messages"),onChange:e=>{u(parseInt(e.target.value))}}));const B=s.createElement("span",null,(0,P._t)("export_chat|size_limit_postfix"));return w?s.createElement(Ca.A,{title:(0,P._t)("export_chat|cancelled"),description:(0,P._t)("export_chat|cancelled_detail"),hasCloseButton:!0,onFinished:t}):A?s.createElement(Ca.A,{title:(0,P._t)("export_chat|successful"),description:(0,P._t)("export_chat|successful_detail"),hasCloseButton:!0,onFinished:t}):b?s.createElement(Pa.A,{title:(0,P._t)("common|warning"),className:"mx_ExportDialog",contentId:"mx_Dialog_content",onFinished:t,fixedWidth:!0},s.createElement("p",null,(0,P._t)("export_chat|confirm_stop")),s.createElement(Da.A,{primaryButton:(0,P._t)("action|stop"),primaryButtonClass:"danger",hasCancel:!0,cancelButton:(0,P._t)("action|continue"),onCancel:()=>E(!1),onPrimaryButtonClick:O})):s.createElement(Pa.A,{title:h?(0,P._t)("export_chat|exporting_your_data"):(0,P._t)("export_chat|title"),className:`mx_ExportDialog ${h&&"mx_ExportDialog_Exporting"}`,contentId:"mx_Dialog_content",hasCancel:!0,onFinished:t,fixedWidth:!0},h?null:s.createElement("p",null,(0,P._t)("export_chat|select_option")),s.createElement("div",{className:"mx_ExportDialog_options"},!!c&&s.createElement(s.Fragment,null,s.createElement("span",{className:"mx_ExportDialog_subheading"},(0,P._t)("export_chat|format")),s.createElement(Cp.A,{name:"exportFormat",value:n,onChange:e=>c(xp[e]),definitions:L})),!!d&&s.createElement(s.Fragment,null,s.createElement("span",{className:"mx_ExportDialog_subheading"},(0,P._t)("export_chat|messages")),s.createElement(Sa.A,{id:"export-type",element:"select",value:i,onChange:e=>{d(kp[e.target.value])}},F),U),m&&s.createElement(s.Fragment,null,s.createElement("span",{className:"mx_ExportDialog_subheading"},(0,P._t)("export_chat|size_limit")),s.createElement(Sa.A,{id:"size-limit",type:"number",autoComplete:"off",onValidate:T,element:"input",ref:v,value:l.toString(),postfixComponent:B,onChange:e=>m(parseInt(e.target.value))})),p&&s.createElement(s.Fragment,null,s.createElement(ka.A,{className:"mx_ExportDialog_attachments-checkbox",id:"include-attachments",checked:r,onChange:e=>p(e.target.checked)},(0,P._t)("export_chat|include_attachments")))),h?s.createElement("div",{className:"mx_ExportDialog_progress"},s.createElement(Na.A,{w:24,h:24}),s.createElement("p",null,_),s.createElement(Da.A,{primaryButton:(0,P._t)("action|cancel"),primaryButtonClass:"danger",hasCancel:!1,onPrimaryButtonClick:M})):s.createElement(Da.A,{primaryButton:(0,P._t)("action|export"),onPrimaryButtonClick:R,onCancel:()=>t(!1)}))};var Vh=n("./src/components/views/polls/pollHistory/PollHistory.tsx");const jh=({room:e,matrixClient:t,permalinkCreator:n,onFinished:i})=>s.createElement(Pa.A,{onFinished:i},s.createElement(Vh.a,{room:e,matrixClient:t,permalinkCreator:n,onFinished:i}));var zh=n("./src/components/utils/Flex.tsx"),Wh=n("./src/actions/RoomListActions.ts");function Hh(e){const t=e.client;return(!!e.canInvite(t.getSafeUserId())||!(!e.isSpaceRoom()||e.getJoinRule()!==i.JoinRule.Public))&&e.getMyMembership()===oa.O.Join&&(0,Ne.g)($.C.InviteUsers)}function Gh(e){e.client.isGuest()?w.A.dispatch({action:"require_registration"}):w.A.dispatch({action:"view_invite",roomId:e.roomId})}var Kh=n("./src/hooks/useRoomState.ts"),Jh=n("./src/hooks/room/useTopic.ts"),qh=n("./src/HtmlUtils.tsx");const $h=["as","flex","shrink","grow","className","children"];function Yh(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Zh(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Yh(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Yh(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Xh(e,t,n){const i=e.current.style;n?i.setProperty(t,n):i.removeProperty(t)}function Qh(e){let{as:t="div",flex:n=null,shrink:i=null,grow:r=null,className:o,children:a}=e,l=(0,Ve.A)(e,$h);const c=(0,s.useRef)();return(0,s.useEffect)((()=>{Xh(c,"--mx-box-flex",n),Xh(c,"--mx-box-shrink",i),Xh(c,"--mx-box-grow",r)}),[n,r,i]),s.createElement(t,Zh(Zh({},l),{},{className:re()("mx_Box",o,{"mx_Box--flex":!!n,"mx_Box--shrink":!!i,"mx_Box--grow":!!r}),ref:c}),a)}const eg=["room","className"];function tg(e){const t=e.target,n=(0,uu.uK)(t.href);n!==t.href&&(e.preventDefault(),window.location.hash=n)}function ng(e){let{room:t,className:n}=e,r=(0,Ve.A)(e,eg);const o=(0,s.useContext)(Pe.Ay),[a,l]=(0,s.useState)(!1),c=(0,Jh.B)(t),d=(0,qh.sH)(null==c?void 0:c.text,null==c?void 0:c.html),u=(0,s.useCallback)((e=>{var t;null===(t=r.onClick)||void 0===t||t.call(r,e);"A"===e.target.tagName.toUpperCase()?tg(e):w.A.fire(R.r.ShowRoomTopic)}),[r]),m=e=>{l("A"===e.target.tagName.toUpperCase())};return(0,De.F)(w.A,(e=>{if(e.action===R.r.ShowRoomTopic){const e=t.currentState.maySendStateEvent(i.EventType.RoomTopic,o.getSafeUserId()),n=(0,qh.sH)(null==c?void 0:c.text,null==c?void 0:c.html,void 0,!0),r=A.Ay.createDialog(Ca.A,{title:t.name,description:s.createElement("div",null,s.createElement(qh.XZ,{options:{attributes:{onClick(e){u(e),r.close()}}},as:"p"},n),e&&s.createElement(Ae.A,{kind:"primary_outline",onClick:()=>{r.close(),w.A.dispatch({action:"open_room_settings"})}},(0,P._t)("room|edit_topic"))),hasCloseButton:!0,button:!1})}})),d?s.createElement(Te.m,{description:(0,P._t)("room|read_topic"),disabled:a},s.createElement("div",(0,p.A)({},r,{tabIndex:0,role:"button",onClick:u,className:re()(n,"mx_RoomTopic"),onMouseOver:m,onFocus:m,"aria-label":(0,P._t)("room|read_topic")}),s.createElement(qh.XZ,null,d))):s.createElement("div",{className:re()(n,"mx_RoomTopic")})}var ig=n("./src/utils/video-rooms.ts"),rg=n("./src/components/views/right_panel/types.ts"),sg=n("./src/hooks/useAsyncMemo.ts"),og=n("./src/utils/PinningUtils.ts"),ag=n("./src/utils/promise.ts");function lg(e){var t,n;return(null!==(t=null==e||null===(n=e.getLiveTimeline().getState(i.EventTimeline.FORWARDS))||void 0===n||null===(n=n.getStateEvents(i.EventType.RoomPinnedEvents,""))||void 0===n||null===(n=n.getContent())||void 0===n?void 0:n.pinned)&&void 0!==t?t:[]).slice(0,100)}const cg=e=>{const[t,n]=(0,s.useState)(lg(e)),r=(0,s.useCallback)((t=>{t&&t.getType()!==i.EventType.RoomPinnedEvents||n(lg(e))}),[e]);return(0,Me.YK)(null==e?void 0:e.getLiveTimeline().getState(i.EventTimeline.FORWARDS),i.RoomStateEvent.Events,r),(0,s.useEffect)((()=>(n(lg(e)),()=>{n([])})),[e]),t};function dg(e){var t,n;return new Set(null!==(t=null==e||null===(n=e.getAccountData(rg.M))||void 0===n||null===(n=n.getContent())||void 0===n?void 0:n.event_ids)&&void 0!==t?t:[])}function ug(e,t){const n=(0,Pe.nH)();return(0,sg.e)((()=>{const r=t.map((t=>()=>async function(e,t,n){var r;const s=e.getUnfilteredTimelineSet(),a=null==s||null===(r=s.getTimelineForEvent(t))||void 0===r?void 0:r.getEvents().find((e=>e.getId()===t));if(null!=a&&a.isEncrypted()&&await n.decryptEventIfNeeded(a,{emit:!1}),a)return og.A.isUnpinnable(a)?a:null;try{const[r,{events:[s]}]=await Promise.all([n.fetchRoomEvent(e.roomId,t),n.relations(e.roomId,t,i.RelationType.Replace,null,{limit:1})]),o=new i.MatrixEvent(r);o.isEncrypted()&&await n.decryptEventIfNeeded(o,{emit:!1}),await e.processPollEvents([o]);const a=o.getSender();if(a&&og.A.isUnpinnable(o))return o.sender=e.getMember(a),s&&o.makeReplaced(s),o}catch(n){o.v.error(`Error looking up pinned event ${t} in room ${e.roomId}`),o.v.error(n)}return null}(e,t,n)));return(0,ag.vA)(r,10)}),[n,e,t],null)}function mg(e,t){const n=ug(e,t);return(0,s.useMemo)((()=>n?n.sort(((e,t)=>e?t?e.getTs()-t.getTs():1:-1)):[]),[n])}var pg=n("./src/tchap/util/TchapRoomUtils.ts");const hg=()=>{rl.A.instance.pushCard({phase:sl.n.MemberList},!0)},gg=()=>{rl.A.instance.pushCard({phase:sl.n.ThreadPanel},!0)},vg=()=>{rl.A.instance.pushCard({phase:sl.n.FilePanel},!0)},fg=()=>{rl.A.instance.pushCard({phase:sl.n.Extensions},!0)},_g=()=>{y.A.trackInteraction("PinnedMessageRoomInfoButton"),rl.A.instance.pushCard({phase:sl.n.PinnedMessages},!0)},yg=e=>{w.A.dispatch({action:"open_room_settings"}),y.A.trackInteraction("WebRightPanelRoomInfoSettingsButton",e)},bg=({room:e})=>{const[t,n]=(0,s.useState)(!0),r=(0,Jh.B)(e),o=(0,qh.sH)(null==r?void 0:r.text,null==r?void 0:r.html),a=(0,Kh.U)(e,(t=>t.maySendStateEvent(i.EventType.RoomTopic,e.client.getSafeUserId()))),l=e=>{e.preventDefault(),e.stopPropagation(),w.A.dispatch({action:"open_room_settings"})};if(!o&&!a)return null;if(!o)return s.createElement(zh.s,{as:"section",direction:"column",justify:"center",gap:"var(--cpd-space-2x)",className:"mx_RoomSummaryCard_topic"},s.createElement(Qh,{flex:"1"},s.createElement(bu,{kind:"primary",onClick:l},s.createElement(Qa.E,{size:"sm",weight:"regular"},(0,P._t)("right_panel|add_topic")))));const c=t?s.createElement(qh.XZ,null,o):o;return s.createElement(zh.s,{as:"section",direction:"column",justify:"center",gap:"var(--cpd-space-2x)",className:re()("mx_RoomSummaryCard_topic",{mx_RoomSummaryCard_topic_collapsed:!t})},s.createElement(Qh,{flex:"1",className:"mx_RoomSummaryCard_topic_container"},s.createElement(Qa.E,{size:"sm",weight:"regular",onClick:e=>{e.target instanceof HTMLAnchorElement&&tg(e)}},c),s.createElement(Xa.K,{className:"mx_RoomSummaryCard_topic_chevron",size:"24px",onClick:()=>n(!t)},s.createElement(yp,null))),t&&a&&s.createElement(Qh,{flex:"1",className:"mx_RoomSummaryCard_topic_edit"},s.createElement(bu,{kind:"primary",onClick:l},s.createElement(Qa.E,{size:"sm",weight:"regular"},(0,P._t)("action|edit")))))},Eg=({room:e,permalinkCreator:t,onSearchChange:n,onSearchCancel:r,focusRoomSearch:a})=>{const l=(0,s.useContext)(Pe.Ay),c=((0,bp.g)(l,e),(0,Ld.ME)("e2eStatus","timelineRenderingType")),d=(c.e2eStatus,(0,ig.j)(e)),u=((0,Kh.U)(e),((e,t)=>{const[n,r]=(0,s.useState)((()=>{return null==(n=e.getAccountData(t))?void 0:n.getContent();var n})),o=(0,s.useCallback)((e=>{e.getType()===t&&r(e.getContent())}),[t]);return(0,Me.YK)(e,i.ClientEvent.AccountData,o),n||{}})(e.client,i.EventType.Direct)),[m,p]=(0,s.useState)(!1);(0,s.useEffect)((()=>{for(const[,n]of Object.entries(u)){var t;if(n.includes(null!==(t=null==e?void 0:e.roomId)&&void 0!==t?t:"")){p(!0);break}}}),[e,u]);const h=(0,s.useRef)(null);(0,De.F)(w.A,(e=>{var t;e.action===R.r.FocusMessageSearch&&(null===(t=h.current)||void 0===t||t.focus())})),((e,t)=>{const n=(0,s.useRef)(e);(0,s.useEffect)((()=>{n.current=e}),[e]);const i=(0,s.useRef)(null);(0,s.useEffect)((()=>{null!==i.current&&n.current(...i.current),i.current=t}),t)})((e=>{e===Sp.Ae.Search&&c.timelineRenderingType!==Sp.Ae.Search&&h.current&&(h.current.value="")}),[c.timelineRenderingType]);const g=e.getCanonicalAlias()||e.getAltAliases()[0]||"",v=s.createElement("header",{className:"mx_RoomSummaryCard_container"},s.createElement(il.A,{room:e,size:"80px",viewAvatarOnClick:!0}),s.createElement(Ap.A,{room:e},(e=>s.createElement(Eu.D,{as:"h1",size:"md",weight:"semibold",className:"mx_RoomSummaryCard_roomName text-primary",title:e},e))),s.createElement(Qa.E,{as:"div",size:"sm",weight:"semibold",className:"mx_RoomSummaryCard_alias text-secondary",title:g},g),s.createElement(bg,{room:e})),f=cg(e).length,_=(0,Me.dF)(oc.Ay.instance,oc.lA,(()=>oc.Ay.instance.getTagsForRoom(e))),y=(0,Me.dF)(e,i.RoomStateEvent.Update,(()=>Hh(e))),b=_.includes(ve.zO.Favourite),E=n&&s.createElement(km,{className:"mx_RoomSummaryCard_search",onSubmit:e=>e.preventDefault()},s.createElement(Wm,{placeholder:(0,P._t)("room|search|placeholder"),name:"room_message_search",onChange:n,className:"mx_no_textinput",ref:h,autoFocus:a,onKeyDown:e=>{h.current&&e.key===se.Uz.ESCAPE&&(h.current.value="",null==r||r())}}));return s.createElement(Ep.A,{id:"room-summary-panel",className:"mx_RoomSummaryCard",ariaLabelledBy:"room-summary-panel-tab",role:"tabpanel",header:E},v,s.createElement(Hm.w,null),s.createElement("div",{role:"menubar","aria-orientation":"vertical"},s.createElement(Qm,{Icon:tp,label:(0,P._t)("room|context_menu|favourite"),checked:b,onSelect:()=>function(e,t){if(t===ve.zO.Favourite||t===ve.zO.LowPriority){const n=t===ve.zO.Favourite?ve.zO.LowPriority:ve.zO.Favourite,i=oc.Ay.instance.getTagsForRoom(e).includes(t),r=i?t:n,s=i?null:t;w.A.dispatch(Wh.A.tagRoom(e.client,e,r,s,0))}else o.v.warn(`Unexpected tag ${t} applied to ${e.roomId}`)}(e,ve.zO.Favourite)}),s.createElement(Ya.D,{Icon:np.A,label:(0,P._t)("action|invite"),disabled:!y,onSelect:()=>Gh(e)}),s.createElement(Hm.w,null),s.createElement(Ya.D,{Icon:pp,label:(0,P._t)("common|people"),onSelect:hg}),s.createElement(Ya.D,{Icon:hp.A,label:(0,P._t)("common|threads"),onSelect:gg}),!d&&s.createElement(s.Fragment,null,s.createElement(Fl,{feature:"pinningMessageList",header:(0,P._t)("right_panel|pinned_messages|release_announcement|title"),description:(0,P._t)("right_panel|pinned_messages|release_announcement|description"),closeLabel:(0,P._t)("right_panel|pinned_messages|release_announcement|close"),placement:"top"},s.createElement("div",null,s.createElement(Ya.D,{Icon:fp.A,label:(0,P._t)("right_panel|pinned_messages_button"),onSelect:_g},s.createElement(Qa.E,{as:"span",size:"sm"},f)))),s.createElement(Ya.D,{Icon:cp.A,label:(0,P._t)("right_panel|files_button"),onSelect:vg}),s.createElement(Ya.D,{Icon:up,label:(0,P._t)("right_panel|extensions_button"),onSelect:fg})),s.createElement(Hm.w,null),s.createElement(Ya.D,{Icon:ip.A,label:(0,P._t)("action|copy_link"),onSelect:()=>{A.Ay.createDialog(wp.G,{target:e})},disabled:pg.A.getRoomJoinRule(e)===i.JoinRule.Invite}),!d&&s.createElement(s.Fragment,null,s.createElement(Ya.D,{Icon:vp,label:(0,P._t)("right_panel|polls_button"),onSelect:()=>{A.Ay.createDialog(jh,{room:e,matrixClient:l,permalinkCreator:t})}}),s.createElement(Ya.D,{Icon:ap,label:(0,P._t)("export_chat|title"),onSelect:async()=>{A.Ay.createDialog(Bh,{room:e})}})),s.createElement(Ya.D,{Icon:sp,label:(0,P._t)("common|settings"),onSelect:yg}),s.createElement(Hm.w,null),s.createElement(Ya.D,{Icon:lp.A,kind:"critical",label:(0,P._t)("action|leave_room"),onSelect:()=>{w.A.dispatch({action:"leave_room",room_id:e.roomId})}})))};var wg=n("./src/utils/WidgetUtils.ts"),Sg=n("./node_modules/matrix-widget-api/lib/index.js"),Ag=n("./node_modules/@matrix-org/react-sdk-module-api/lib/lifecycles/WidgetLifecycle.js"),Cg=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/collapse.js"),xg=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/expand.js"),kg=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/minus.js"),Rg=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/overflow-horizontal.js");function Ig(e,t){return(0,dl.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:[(0,dl.jsx)("path",{d:"M12 8a1.5 1.5 0 0 0-1.5 1.5 1 1 0 1 1-2 0 3.5 3.5 0 1 1 6.01 2.439c-.122.126-.24.243-.352.355-.287.288-.54.54-.76.824-.293.375-.398.651-.398.882a1 1 0 1 1-2 0c0-.874.407-1.58.819-2.11.305-.392.688-.775 1-1.085l.257-.26A1.5 1.5 0 0 0 12 8Zm1 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"}),(0,dl.jsx)("path",{d:"M8.1 21.212A9.738 9.738 0 0 0 12 22a9.738 9.738 0 0 0 3.9-.788 10.098 10.098 0 0 0 3.175-2.137c.9-.9 1.613-1.958 2.137-3.175A9.738 9.738 0 0 0 22 12a9.738 9.738 0 0 0-.788-3.9 10.099 10.099 0 0 0-2.137-3.175c-.9-.9-1.958-1.612-3.175-2.137A9.738 9.738 0 0 0 12 2a9.738 9.738 0 0 0-3.9.788 10.099 10.099 0 0 0-3.175 2.137c-.9.9-1.612 1.958-2.137 3.175A9.738 9.738 0 0 0 2 12a9.74 9.74 0 0 0 .788 3.9 10.098 10.098 0 0 0 2.137 3.175c.9.9 1.958 1.613 3.175 2.137Zm9.575-3.537C16.125 19.225 14.233 20 12 20c-2.233 0-4.125-.775-5.675-2.325C4.775 16.125 4 14.233 4 12c0-2.233.775-4.125 2.325-5.675C7.875 4.775 9.767 4 12 4c2.233 0 4.125.775 5.675 2.325C19.225 7.875 20 9.767 20 12c0 2.233-.775 4.125-2.325 5.675Z"})]})}Ig.displayName="HelpIcon";const Tg=(0,s.forwardRef)(Ig);var Pg=n("./src/utils/UrlUtils.ts");function Ng(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}class Dg extends s.Component{constructor(e){super(e);const t=this.parseWidgetUrl(),n=E.J.safeGet().getRoom(this.props.roomId);let i=null;n&&(i=n.getMember(this.props.creatorUserId)),this.state=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ng(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ng(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({roomMember:i},t)}parseWidgetUrl(){const e=(0,Pg.Dl)(this.props.url);if(wg.A.isScalarUrl(this.props.url)&&e.searchParams.has("url")){const t=(0,Pg.Dl)(e.searchParams.get("url"));return{widgetDomain:t.host||t.hostname,isWrapped:!0}}return{widgetDomain:e.host||e.hostname,isWrapped:!1}}render(){const e=u.Ay.get().brand,t=this.state.roomMember?this.state.roomMember.name:this.props.creatorUserId,n=t===this.props.creatorUserId?null:this.props.creatorUserId,i=this.state.roomMember?s.createElement($p.A,{member:this.state.roomMember,size:"38px"}):s.createElement(ja.A,{name:this.props.creatorUserId,size:"38px"}),r=s.createElement(Te.m,{label:(0,P._t)("analytics|shared_data_heading"),caption:s.createElement("ul",null,s.createElement("li",null,(0,P._t)("widget|shared_data_name")),s.createElement("li",null,(0,P._t)("widget|shared_data_avatar")),s.createElement("li",null,(0,P._t)("widget|shared_data_mxid")),s.createElement("li",null,(0,P._t)("widget|shared_data_device_id")),s.createElement("li",null,(0,P._t)("widget|shared_data_theme")),s.createElement("li",null,(0,P._t)("widget|shared_data_lang")),s.createElement("li",null,(0,P._t)("widget|shared_data_url",{brand:e})),s.createElement("li",null,(0,P._t)("widget|shared_data_room_id")),s.createElement("li",null,(0,P._t)("widget|shared_data_widget_id")))},s.createElement("div",{className:"mx_TextWithTooltip_target mx_TextWithTooltip_target--helpIcon"},s.createElement(Tg,{className:"mx_Icon mx_Icon_12"}))),o=this.state.isWrapped?(0,P._t)("widget|shared_data_warning_im",{widgetDomain:this.state.widgetDomain},{helpIcon:()=>r}):(0,P._t)("widget|shared_data_warning",{widgetDomain:this.state.widgetDomain},{helpIcon:()=>r}),a=this.props.isRoomEncrypted?(0,P._t)("widget|unencrypted_warning"):null;return s.createElement("div",{className:"mx_AppPermission"},s.createElement("div",{className:"mx_AppPermission_content"},s.createElement("div",{className:"mx_AppPermission_content_bolder"},(0,P._t)("widget|added_by")),s.createElement("div",null,i,s.createElement(uc.A,{size:"4"},t),s.createElement("div",null,n)),s.createElement("div",null,o),s.createElement("div",null,(0,P._t)("widget|cookie_warning"),"Â ",a),s.createElement("div",null,s.createElement(Ae.A,{kind:"primary_sm",onClick:this.props.onPermissionGranted},(0,P._t)("action|continue")))))}}(0,h.A)(Dg,"defaultProps",{onPermissionGranted:()=>{}});var Mg=n("./res/img/warning.svg");const Og=e=>s.createElement("div",{className:"mx_AppWarning"},s.createElement("div",null,s.createElement("img",{src:Mg.A,alt:""})),s.createElement("div",null,s.createElement("span",null,e.errorMsg||"Error")));var Lg=n("./src/stores/ActiveWidgetStore.ts");function Fg(e){const t=document.createElement("div");return t.id=e,function(){let e=document.getElementById("mx_PersistedElement_container");return e||(e=document.createElement("div"),e.id="mx_PersistedElement_container",document.body.appendChild(e)),e}().appendChild(t),t}class Ug extends s.Component{constructor(e){super(e),(0,h.A)(this,"resizeObserver",void 0),(0,h.A)(this,"dispatcherRef",void 0),(0,h.A)(this,"childContainer",void 0),(0,h.A)(this,"child",void 0),(0,h.A)(this,"collectChildContainer",(e=>{this.childContainer&&this.resizeObserver.unobserve(this.childContainer),this.childContainer=e,e&&this.resizeObserver.observe(e)})),(0,h.A)(this,"collectChild",(e=>{this.child=e,this.updateChild()})),(0,h.A)(this,"onAction",(e=>{"timeline_resize"===e.action?this.repositionChild():"logout"===e.action&&Ug.destroyElement(this.props.persistKey)})),(0,h.A)(this,"repositionChild",(()=>{this.updateChildPosition(this.child,this.childContainer)})),this.resizeObserver=new ResizeObserver(this.repositionChild),this.props.moveRef&&(this.props.moveRef.current=this.repositionChild)}static destroyElement(e){const t=Ug.rootMap[e];t&&(t[0].unmount(),t[1].remove()),delete Ug.rootMap[e]}static isMounted(e){return Boolean(Ug.rootMap[e])}componentDidMount(){window.addEventListener("resize",this.repositionChild),this.dispatcherRef=w.A.register(this.onAction),this.updateChild(),this.renderApp()}componentDidUpdate(){this.updateChild(),this.renderApp()}componentWillUnmount(){this.updateChildVisibility(this.child,!1),this.resizeObserver.disconnect(),window.removeEventListener("resize",this.repositionChild),w.A.unregister(this.dispatcherRef)}updateChild(){this.updateChildPosition(this.child,this.childContainer),this.updateChildVisibility(this.child,!0)}renderApp(){const e=s.createElement(s.StrictMode,null,s.createElement(Pe.Ay.Provider,{value:E.J.safeGet()},s.createElement(_.B,null,s.createElement("div",{ref:this.collectChild,style:this.props.style},this.props.children))));let t=Ug.rootMap[this.props.persistKey];if(!t){const e=Fg("mx_persistedElement_"+this.props.persistKey);t=[(0,Tp.H)(e),e],Ug.rootMap[this.props.persistKey]=t}t[0].render(e)}updateChildVisibility(e,t=!1){e&&(e.style.display=t?"block":"none")}updateChildPosition(e,t){if(!e||!t)return;const n=t.getBoundingClientRect();Object.assign(e.style,{zIndex:(0,g.hX)(this.props.zIndex)?9:this.props.zIndex,position:"absolute",top:"0",left:"0",transform:`translateX(${n.left}px) translateY(${n.top}px)`,width:n.width+"px",height:n.height+"px"})}render(){return s.createElement("div",{ref:this.collectChildContainer})}}(0,h.A)(Ug,"rootMap",{});var Bg=n("./src/widgets/WidgetType.ts"),Vg=n("./src/utils/arrays.ts");var jg=n("./src/components/views/elements/LabelledToggleSwitch.tsx"),zg=n("./src/stores/widgets/WidgetPermissionStore.ts");class Wg extends s.PureComponent{constructor(e){super(e),(0,h.A)(this,"onAllow",(()=>{this.onPermissionSelection(!0)})),(0,h.A)(this,"onDeny",(()=>{this.onPermissionSelection(!1)})),(0,h.A)(this,"onRememberSelectionChange",(e=>{this.setState({rememberSelection:e})})),this.state={rememberSelection:!1}}onPermissionSelection(e){this.state.rememberSelection&&(o.v.log(`Remembering ${this.props.widget.id} as allowed=${e} for OpenID`),Wa.M.instance.widgetPermissionStore.setOIDCState(this.props.widget,this.props.widgetKind,this.props.inRoomId,e?zg.R.Allowed:zg.R.Denied)),this.props.onFinished(e)}render(){return s.createElement(Pa.A,{className:"mx_WidgetOpenIDPermissionsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:(0,P._t)("widget|open_id_permissions_dialog|title")},s.createElement("div",{className:"mx_WidgetOpenIDPermissionsDialog_content"},s.createElement("p",null,(0,P._t)("widget|open_id_permissions_dialog|starting_text")),s.createElement("p",{className:"text-muted"},this.props.widget.templateUrl.split("?")[0].split("#")[0])),s.createElement(Da.A,{primaryButton:(0,P._t)("action|continue"),onPrimaryButtonClick:this.onAllow,onCancel:this.onDeny,additive:s.createElement(jg.A,{value:this.state.rememberSelection,toggleInFront:!0,onChange:this.onRememberSelectionChange,label:(0,P._t)("widget|open_id_permissions_dialog|remember_selection")})}))}}var Hg=n("./src/utils/objects.ts");let Gg=function(e){return e.CanChangeViewedRoom="io.element.view_room",e.RequiresClient="io.element.requires_client",e}({});var Kg=n("./src/components/views/elements/TextWithTooltip.tsx");const Jg="generic";class qg{static bylineFor(e){return e.kind===Sg.EventKind.State?e.keyStr?(0,P._t)("widget|capability|byline_state_key",{stateKey:e.keyStr}):(0,P._t)("widget|capability|byline_empty_state_key"):null}static for(e,t){if(qg.simpleCaps[e]){const n=qg.simpleCaps[e];if(n[t])return{primary:(0,P._t)(n[t])};if(n[Jg])return{primary:(0,P._t)(n[Jg])}}if((0,Sg.isTimelineCapability)(e)){if((0,Sg.isTimelineCapabilityFor)(e,Sg.Symbols.AnyRoom))return{primary:(0,P._t)("widget|capability|any_room")};{const t=(0,Sg.getTimelineRoomIDFromCapability)(e),n=E.J.safeGet().getRoom(t);return{primary:(0,P._t)("widget|capability|specific_room",{},{Room:()=>{var e;return n?s.createElement(Kg.A,{tooltip:null!==(e=n.getCanonicalAlias())&&void 0!==e?e:t},s.createElement("strong",null,n.name)):s.createElement("strong",null,s.createElement("code",null,t))}})}}}const[n]=Sg.WidgetEventCapability.findEventCapabilities([e]);if(n){if(n.kind===Sg.EventKind.Event&&n.eventType===i.EventType.RoomMessage)return qg.forRoomMessageCap(n,t);const e=n.kind===Sg.EventKind.State?qg.stateSendRecvCaps:qg.nonStateSendRecvCaps;if(e[n.eventType]){const i=e[n.eventType],r=(null==i?void 0:i[t])||(null==i?void 0:i[Jg]);if(null!=r&&r[n.direction])return{primary:(0,P._t)(r[n.direction])}}return t===Sg.WidgetKind.Room?n.direction===Sg.EventDirection.Send?{primary:(0,P._t)("widget|capability|send_event_type_this_room",{eventType:n.eventType},{b:e=>s.createElement("strong",null,e)}),byline:qg.bylineFor(n)}:{primary:(0,P._t)("widget|capability|see_event_type_sent_this_room",{eventType:n.eventType},{b:e=>s.createElement("strong",null,e)}),byline:qg.bylineFor(n)}:n.direction===Sg.EventDirection.Send?{primary:(0,P._t)("widget|capability|send_event_type_active_room",{eventType:n.eventType},{b:e=>s.createElement("strong",null,e)}),byline:qg.bylineFor(n)}:{primary:(0,P._t)("widget|capability|see_event_type_sent_active_room",{eventType:n.eventType},{b:e=>s.createElement("strong",null,e)}),byline:qg.bylineFor(n)}}return{primary:(0,P._t)("widget|capability|capability",{capability:e},{b:e=>s.createElement("strong",null,e)})}}static forRoomMessageCap(e,t){if(!e.keyStr)return e.direction===Sg.EventDirection.Send?{primary:t===Sg.WidgetKind.Room?(0,P._t)("widget|capability|send_messages_this_room"):(0,P._t)("widget|capability|send_messages_active_room")}:{primary:t===Sg.WidgetKind.Room?(0,P._t)("widget|capability|see_messages_sent_this_room"):(0,P._t)("widget|capability|see_messages_sent_active_room")};switch(e.keyStr){case i.MsgType.Text:return e.direction===Sg.EventDirection.Send?{primary:t===Sg.WidgetKind.Room?(0,P._t)("widget|capability|send_text_messages_this_room"):(0,P._t)("widget|capability|send_text_messages_active_room")}:{primary:t===Sg.WidgetKind.Room?(0,P._t)("widget|capability|see_text_messages_sent_this_room"):(0,P._t)("widget|capability|see_text_messages_sent_active_room")};case i.MsgType.Emote:return e.direction===Sg.EventDirection.Send?{primary:t===Sg.WidgetKind.Room?(0,P._t)("widget|capability|send_emotes_this_room"):(0,P._t)("widget|capability|send_emotes_active_room")}:{primary:t===Sg.WidgetKind.Room?(0,P._t)("widget|capability|see_sent_emotes_this_room"):(0,P._t)("widget|capability|see_sent_emotes_active_room")};case i.MsgType.Image:return e.direction===Sg.EventDirection.Send?{primary:t===Sg.WidgetKind.Room?(0,P._t)("widget|capability|send_images_this_room"):(0,P._t)("widget|capability|send_images_active_room")}:{primary:t===Sg.WidgetKind.Room?(0,P._t)("widget|capability|see_images_sent_this_room"):(0,P._t)("widget|capability|see_images_sent_active_room")};case i.MsgType.Video:return e.direction===Sg.EventDirection.Send?{primary:t===Sg.WidgetKind.Room?(0,P._t)("widget|capability|send_videos_this_room"):(0,P._t)("widget|capability|send_videos_active_room")}:{primary:t===Sg.WidgetKind.Room?(0,P._t)("widget|capability|see_videos_sent_this_room"):(0,P._t)("widget|capability|see_videos_sent_active_room")};case i.MsgType.File:return e.direction===Sg.EventDirection.Send?{primary:t===Sg.WidgetKind.Room?(0,P._t)("widget|capability|send_files_this_room"):(0,P._t)("widget|capability|send_files_active_room")}:{primary:t===Sg.WidgetKind.Room?(0,P._t)("widget|capability|see_sent_files_this_room"):(0,P._t)("widget|capability|see_sent_files_active_room")};default:{let n;return n=e.direction===Sg.EventDirection.Send?t===Sg.WidgetKind.Room?(0,P._t)("widget|capability|send_msgtype_this_room",{msgtype:e.keyStr},{b:e=>s.createElement("strong",null,e)}):(0,P._t)("widget|capability|send_msgtype_active_room",{msgtype:e.keyStr},{b:e=>s.createElement("strong",null,e)}):t===Sg.WidgetKind.Room?(0,P._t)("widget|capability|see_msgtype_sent_this_room",{msgtype:e.keyStr},{b:e=>s.createElement("strong",null,e)}):(0,P._t)("widget|capability|see_msgtype_sent_active_room",{msgtype:e.keyStr},{b:e=>s.createElement("strong",null,e)}),{primary:n}}}}}(0,h.A)(qg,"simpleCaps",{[Sg.MatrixCapabilities.AlwaysOnScreen]:{[Sg.WidgetKind.Room]:(0,P.AO)("widget|capability|always_on_screen_viewing_another_room"),[Jg]:(0,P.AO)("widget|capability|always_on_screen_generic")},[Sg.MatrixCapabilities.StickerSending]:{[Sg.WidgetKind.Room]:(0,P.AO)("widget|capability|send_stickers_this_room"),[Jg]:(0,P.AO)("widget|capability|send_stickers_active_room")},[Gg.CanChangeViewedRoom]:{[Jg]:(0,P.AO)("widget|capability|switch_room")},[Sg.MatrixCapabilities.MSC2931Navigate]:{[Jg]:(0,P.AO)("widget|capability|switch_room_message_user")}}),(0,h.A)(qg,"stateSendRecvCaps",{[i.EventType.RoomTopic]:{[Sg.WidgetKind.Room]:{[Sg.EventDirection.Send]:(0,P.AO)("widget|capability|change_topic_this_room"),[Sg.EventDirection.Receive]:(0,P.AO)("widget|capability|see_topic_change_this_room")},[Jg]:{[Sg.EventDirection.Send]:(0,P.AO)("widget|capability|change_topic_active_room"),[Sg.EventDirection.Receive]:(0,P.AO)("widget|capability|see_topic_change_active_room")}},[i.EventType.RoomName]:{[Sg.WidgetKind.Room]:{[Sg.EventDirection.Send]:(0,P.AO)("widget|capability|change_name_this_room"),[Sg.EventDirection.Receive]:(0,P.AO)("widget|capability|see_name_change_this_room")},[Jg]:{[Sg.EventDirection.Send]:(0,P.AO)("widget|capability|change_name_active_room"),[Sg.EventDirection.Receive]:(0,P.AO)("widget|capability|see_name_change_active_room")}},[i.EventType.RoomAvatar]:{[Sg.WidgetKind.Room]:{[Sg.EventDirection.Send]:(0,P.AO)("widget|capability|change_avatar_this_room"),[Sg.EventDirection.Receive]:(0,P.AO)("widget|capability|see_avatar_change_this_room")},[Jg]:{[Sg.EventDirection.Send]:(0,P.AO)("widget|capability|change_avatar_active_room"),[Sg.EventDirection.Receive]:(0,P.AO)("widget|capability|see_avatar_change_active_room")}},[i.EventType.RoomMember]:{[Sg.WidgetKind.Room]:{[Sg.EventDirection.Send]:(0,P.AO)("widget|capability|remove_ban_invite_leave_this_room"),[Sg.EventDirection.Receive]:(0,P.AO)("widget|capability|receive_membership_this_room")},[Jg]:{[Sg.EventDirection.Send]:(0,P.AO)("widget|capability|remove_ban_invite_leave_active_room"),[Sg.EventDirection.Receive]:(0,P.AO)("widget|capability|receive_membership_active_room")}}}),(0,h.A)(qg,"nonStateSendRecvCaps",{[i.EventType.Sticker]:{[Sg.WidgetKind.Room]:{[Sg.EventDirection.Send]:(0,P.AO)("widget|capability|send_stickers_this_room_as_you"),[Sg.EventDirection.Receive]:(0,P.AO)("widget|capability|see_sticker_posted_this_room")},[Jg]:{[Sg.EventDirection.Send]:(0,P.AO)("widget|capability|send_stickers_active_room_as_you"),[Sg.EventDirection.Receive]:(0,P.AO)("widget|capability|see_sticker_posted_active_room")}}});class $g extends s.PureComponent{constructor(e){super(e),(0,h.A)(this,"eventPermissionsMap",new Map),(0,h.A)(this,"onToggle",(e=>{const t=(0,Hg.tn)(this.state.booleanStates);t[e]=!t[e],this.setState({booleanStates:t})})),(0,h.A)(this,"onRememberSelectionChange",(e=>{this.setState({rememberSelection:e})})),(0,h.A)(this,"onSubmit",(async()=>{this.closeAndTryRemember(Object.entries(this.state.booleanStates).filter((([e,t])=>t)).map((([e])=>e)))})),(0,h.A)(this,"onReject",(async()=>{this.closeAndTryRemember([])}));Sg.WidgetEventCapability.findEventCapabilities(this.props.requestedCapabilities).forEach((e=>this.eventPermissionsMap.set(e.raw,e)));const t={};this.props.requestedCapabilities.forEach((e=>t[e]=!0)),this.state={booleanStates:t,rememberSelection:!0}}closeAndTryRemember(e){this.props.onFinished({approved:e,remember:this.state.rememberSelection})}render(){const e=Object.entries(this.state.booleanStates).sort((([e],[t])=>{const n=(0,Sg.isTimelineCapability)(e),i=(0,Sg.isTimelineCapability)(t);return n||i?n&&!i?1:!n&&i?-1:n&&i?(0,g.aw)(e,t):0:(0,g.aw)(e,t)})).map((([e,t],n)=>{const i=qg.for(e,this.props.widgetKind),r=i.byline?s.createElement("span",{className:"mx_WidgetCapabilitiesPromptDialog_byline"},i.byline):null;return s.createElement("div",{className:"mx_WidgetCapabilitiesPromptDialog_cap",key:e+n},s.createElement(ka.A,{checked:t,onChange:()=>this.onToggle(e)},i.primary),r)}));return s.createElement(Pa.A,{className:"mx_WidgetCapabilitiesPromptDialog",onFinished:this.props.onFinished,title:(0,P._t)("widget|capabilities_dialog|title")},s.createElement("form",{onSubmit:this.onSubmit},s.createElement("div",{className:"mx_Dialog_content"},s.createElement("div",{className:"text-muted"},(0,P._t)("widget|capabilities_dialog|content_starting_text")),e,s.createElement(Da.A,{primaryButton:(0,P._t)("action|approve"),cancelButton:(0,P._t)("widget|capabilities_dialog|decline_all_permission"),onPrimaryButtonClick:this.onSubmit,onCancel:this.onReject,additive:s.createElement(jg.A,{value:this.state.rememberSelection,toggleInFront:!0,onChange:this.onRememberSelectionChange,label:(0,P._t)("widget|capabilities_dialog|remember_Selection")})}))))}}const Yg={};var Zg=n("./src/effects/index.ts"),Xg=n("./src/effects/utils.ts"),Qg=n("./src/utils/permalinks/navigator.ts"),ev=n("./src/modules/ModuleRunner.ts");function tv(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}const nv=({urls:e,username:t,credential:n})=>({uris:e,username:t,password:n});class iv extends Sg.WidgetDriver{constructor(e,t,n,r,s){var o;if(super(),(0,h.A)(this,"allowedCapabilities",void 0),this.forWidget=t,this.forWidgetKind=n,this.inRoomId=s,this.allowedCapabilities=new Set([...e,Sg.MatrixCapabilities.Screenshots,Gg.RequiresClient]),Bg.x.JITSI.matches(this.forWidget.type)&&n===Sg.WidgetKind.Room)this.allowedCapabilities.add(Sg.MatrixCapabilities.AlwaysOnScreen);else if(Bg.x.STICKERPICKER.matches(this.forWidget.type)&&n===Sg.WidgetKind.Account){const e=Sg.WidgetEventCapability.forRoomEvent(Sg.EventDirection.Send,i.EventType.Sticker).raw;this.allowedCapabilities.add(Sg.MatrixCapabilities.StickerSending),this.allowedCapabilities.add(e),this.allowedCapabilities.add("visibility")}else if(r&&new URL(null!==(o=u.Ay.get("element_call").url)&&void 0!==o?o:u.zY.element_call.url).origin===this.forWidget.origin){this.allowedCapabilities.add(Sg.MatrixCapabilities.AlwaysOnScreen),this.allowedCapabilities.add(Sg.MatrixCapabilities.MSC3846TurnServers),this.allowedCapabilities.add(`org.matrix.msc2762.timeline:${s}`),this.allowedCapabilities.add(Sg.MatrixCapabilities.MSC4157SendDelayedEvent),this.allowedCapabilities.add(Sg.MatrixCapabilities.MSC4157UpdateDelayedEvent),this.allowedCapabilities.add(Sg.WidgetEventCapability.forStateEvent(Sg.EventDirection.Receive,i.EventType.RoomMember).raw),this.allowedCapabilities.add(Sg.WidgetEventCapability.forStateEvent(Sg.EventDirection.Receive,"org.matrix.msc3401.call").raw),this.allowedCapabilities.add(Sg.WidgetEventCapability.forStateEvent(Sg.EventDirection.Receive,i.EventType.RoomEncryption).raw);const e=E.J.safeGet().getSafeUserId();this.allowedCapabilities.add(Sg.WidgetEventCapability.forStateEvent(Sg.EventDirection.Send,"org.matrix.msc3401.call.member",e).raw);const r=E.J.safeGet().getDeviceId();null!==r&&(this.allowedCapabilities.add(Sg.WidgetEventCapability.forStateEvent(Sg.EventDirection.Send,"org.matrix.msc3401.call.member",`_${e}_${r}`).raw),this.allowedCapabilities.add(Sg.WidgetEventCapability.forStateEvent(Sg.EventDirection.Send,"org.matrix.msc3401.call.member",`${e}_${r}`).raw)),this.allowedCapabilities.add(Sg.WidgetEventCapability.forStateEvent(Sg.EventDirection.Receive,"org.matrix.msc3401.call.member").raw),this.allowedCapabilities.add(Sg.WidgetEventCapability.forStateEvent(Sg.EventDirection.Receive,i.EventType.RoomCreate).raw);const o=["io.element.call.encryption_keys","org.matrix.rageshake_request",i.EventType.Reaction,i.EventType.RoomRedaction,"io.element.call.reaction"];for(const e of o)this.allowedCapabilities.add(Sg.WidgetEventCapability.forRoomEvent(Sg.EventDirection.Send,e).raw),this.allowedCapabilities.add(Sg.WidgetEventCapability.forRoomEvent(Sg.EventDirection.Receive,e).raw);const a=[i.EventType.CallInvite,i.EventType.CallCandidates,i.EventType.CallAnswer,i.EventType.CallHangup,i.EventType.CallReject,i.EventType.CallSelectAnswer,i.EventType.CallNegotiate,i.EventType.CallSDPStreamMetadataChanged,i.EventType.CallSDPStreamMetadataChangedPrefix,i.EventType.CallReplaces,i.EventType.CallEncryptionKeysPrefix];for(const e of a)this.allowedCapabilities.add(Sg.WidgetEventCapability.forToDeviceEvent(Sg.EventDirection.Send,e).raw),this.allowedCapabilities.add(Sg.WidgetEventCapability.forToDeviceEvent(Sg.EventDirection.Receive,e).raw);Wa.M.instance.widgetPermissionStore.setOIDCState(t,n,s,zg.R.Allowed)}}async validateCapabilities(e){const t=(n=e,i=this.allowedCapabilities,(0,Vg.ZQ)(Array.from(n),Array.from(i)));var n,i;const r=new Set(t.removed),s=new Set(this.allowedCapabilities);var a;let l;if((a=this.forWidget,JSON.parse(localStorage.getItem(`widget_${a.id}_approved_caps`)||"[]")).forEach((e=>{s.add(e),r.delete(e)})),Yg.preapproveCapabilities)l=await Yg.preapproveCapabilities(this.forWidget,e);else{const t={approvedCapabilities:void 0};ev.r.instance.invoke(Ag.Z.CapabilitiesRequest,t,this.forWidget,e),l=t.approvedCapabilities}l&&l.forEach((e=>{s.add(e),r.delete(e)}));let c=!1;if(r.size>0)try{var d;const[e]=await A.Ay.createDialog($g,{requestedCapabilities:r,widget:this.forWidget,widgetKind:this.forWidgetKind}).finished;null==e||null===(d=e.approved)||void 0===d||d.forEach((e=>s.add(e))),c=!(null==e||!e.remember)}catch(e){o.v.error("Non-fatal error getting capabilities: ",e)}const u=new Set(function(e,t){return(0,Vg.LY)(Array.from(e),Array.from(t))}(s,e));return c&&function(e,t){localStorage.setItem(`widget_${e.id}_approved_caps`,JSON.stringify(t))}(this.forWidget,Array.from(u)),u}async sendEvent(e,t,n=null,r=null){const s=E.J.get(),o=r||Wa.M.instance.roomViewStore.getRoomId();if(!s||!o)throw new Error("Not in a room or not attached to a client");let a;return null!==n?a=await s.sendStateEvent(o,e,t,n):e===i.EventType.RoomRedaction?a=await s.redactEvent(o,t.redacts):(a=await s.sendEvent(o,e,t),e===i.EventType.RoomMessage&&Zg.y.forEach((e=>{if((0,Xg._)(t,e.emojis)){var n;(null===(n=t["m.relates_to"])||void 0===n?void 0:n.rel_type)!==i.THREAD_RELATION_TYPE.name&&w.A.dispatch({action:`effects.${e.command}`})}}))),{roomId:o,eventId:a.event_id}}async sendDelayedEvent(e,t,n,i,r=null,s=null){const o=E.J.get(),a=s||Wa.M.instance.roomViewStore.getRoomId();if(!o||!a)throw new Error("Not in a room or not attached to a client");let l,c;if(null!==e)l=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?tv(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):tv(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({delay:e},null!==t&&{parent_delay_id:t});else{if(null===t)throw new Error("Must provide at least one of delay or parentDelayId");l={parent_delay_id:t}}return c=null!==r?await o._unstable_sendDelayedStateEvent(a,l,n,i,r):await o._unstable_sendDelayedEvent(a,l,null,n,i),{roomId:a,delayId:c.delay_id}}async updateDelayedEvent(e,t){const n=E.J.get();if(!n)throw new Error("Not in a room or not attached to a client");await n._unstable_updateDelayedEvent(e,t)}async sendToDevice(e,t,n){const i=E.J.safeGet();if(t){const t=i.getCrypto();if(!t)throw new Error("E2EE not enabled");const r={};for(const e of Object.keys(n)){const t=n[e];for(const n of Object.keys(t)){const i=t[n],s=JSON.stringify(i);r[s]=r[s]||[],r[s].push({userId:e,deviceId:n})}}await Promise.all(Object.entries(r).map((async([n,r])=>{const s=await t.encryptToDeviceMessages(e,r,JSON.parse(n));await i.queueToDevice(s)})))}else await i.queueToDevice({eventType:e,batch:Object.entries(n).flatMap((([e,t])=>Object.entries(t).map((([t,n])=>({userId:e,deviceId:t,payload:n})))))})}pickRooms(e){const t=E.J.get();if(!t)throw new Error("Not attached to a client");return(e?e.includes(Sg.Symbols.AnyRoom)?t.getVisibleRooms(V.A.getValue("feature_dynamic_room_predecessors")):e.map((e=>t.getRoom(e))):[t.getRoom(Wa.M.instance.roomViewStore.getRoomId())]).filter((e=>!!e))}async readRoomEvents(e,t,n,r){n=n>0?Math.min(n,Number.MAX_SAFE_INTEGER):Number.MAX_SAFE_INTEGER;const s=this.pickRooms(r),o=[];for(const r of s){const s=[],a=r.getLiveTimeline().getEvents();for(let r=a.length-1;r>0&&!(s.length>=n);r--){const n=a[r];n.getType()!==e||n.isState()||e===i.EventType.RoomMessage&&t&&t!==n.getContent().msgtype||s.push(n)}s.forEach((e=>o.push(e.getEffectiveEvent())))}return o}async readStateEvents(e,t,n,i){n=n>0?Math.min(n,Number.MAX_SAFE_INTEGER):Number.MAX_SAFE_INTEGER;const r=this.pickRooms(i),s=[];for(const i of r){const r=[],o=i.currentState.events.get(e);if(o)if(""===t||t){const e=o.get(t);e&&r.push(e)}else r.push(...Array.from(o.values()));r.slice(0,n).forEach((e=>s.push(e.getEffectiveEvent())))}return s}async askOpenID(e){const t={approved:void 0};if(ev.r.instance.invoke(Ag.Z.IdentityRequest,t,this.forWidget),t.approved)return e.update({state:Sg.OpenIDRequestState.Allowed,token:await E.J.safeGet().getOpenIdToken()});const n=Wa.M.instance.widgetPermissionStore.getOIDCState(this.forWidget,this.forWidgetKind,this.inRoomId),i=()=>E.J.safeGet().getOpenIdToken();return n===zg.R.Denied?e.update({state:Sg.OpenIDRequestState.Blocked}):n===zg.R.Allowed?e.update({state:Sg.OpenIDRequestState.Allowed,token:await i()}):(e.update({state:Sg.OpenIDRequestState.PendingUserConfirmation}),void A.Ay.createDialog(Wg,{widget:this.forWidget,widgetKind:this.forWidgetKind,inRoomId:this.inRoomId,onFinished:async t=>t?e.update({state:Sg.OpenIDRequestState.Allowed,token:await i()}):e.update({state:Sg.OpenIDRequestState.Blocked})}))}async navigate(e){(0,Qg.O)(e)}async*getTurnServers(){const e=E.J.safeGet();if(!e.pollingTurnServers||!e.getTurnServers().length)return;let t,n;const r=([e])=>t(nv(e)),s=(e,t)=>{t&&n(e)};e.on(i.ClientEvent.TurnServers,r),e.on(i.ClientEvent.TurnServersError,s);try{const i=e.getTurnServers()[0];for(yield nv(i);;)yield await new Promise(((e,i)=>{t=e,n=i}))}finally{e.off(i.ClientEvent.TurnServers,r),e.off(i.ClientEvent.TurnServersError,s)}}async readEventRelations(e,t,n,i,r,s,o,a){var l;const c=E.J.safeGet(),d=a;if("string"!=typeof(t=null!==(l=null!=t?t:Wa.M.instance.roomViewStore.getRoomId())&&void 0!==l?l:void 0))throw new Error("Error while reading the current room");const{events:u,nextBatch:m,prevBatch:p}=await c.relations(t,e,null!=n?n:null,null!=i?i:null,{from:r,to:s,limit:o,dir:d});return{chunk:u.map((e=>e.getEffectiveEvent())),nextBatch:null!=m?m:void 0,prevBatch:null!=p?p:void 0}}async searchUserDirectory(e,t){const n=E.J.safeGet(),{limited:i,results:r}=await n.searchUserDirectory({term:e,limit:t});return{limited:i,results:r.map((e=>({userId:e.user_id,displayName:e.display_name,avatarUrl:e.avatar_url})))}}async getMediaConfig(){const e=E.J.safeGet();return await e.getMediaConfig()}async uploadFile(e){const t=E.J.safeGet();return{contentUri:(await t.uploadContent(e)).content_uri}}async downloadFile(e){const t=E.J.safeGet(),n=new Up.$U({mxc:e},t),i=await n.downloadSource();return{file:await i.blob()}}processError(e){return e instanceof i.MatrixError?{matrix_api_error:e.asWidgetApiErrorData()}:void 0}}var rv=n("./src/stores/widgets/WidgetMessagingStore.ts"),sv=n("./src/integrations/IntegrationManagers.ts"),ov=n("./src/stores/widgets/ElementWidgetActions.ts"),av=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/error.js");const lv="io.element.web";function cv(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function dv(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?cv(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):cv(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class uv extends s.PureComponent{constructor(e){super(e),(0,h.A)(this,"widget",void 0),(0,h.A)(this,"possibleButtons",void 0),(0,h.A)(this,"appFrame",s.createRef()),(0,h.A)(this,"state",{disabledButtonIds:(this.props.widgetDefinition.buttons||[]).filter((e=>e.disabled)).map((e=>e.id))}),(0,h.A)(this,"onReady",(()=>{var e;null===(e=this.state.messaging)||void 0===e||e.sendWidgetConfig(this.props.widgetDefinition)})),(0,h.A)(this,"onLoad",(()=>{this.state.messaging&&(this.state.messaging.once("ready",this.onReady),this.state.messaging.on(`action:${Sg.WidgetApiFromWidgetAction.CloseModalWidget}`,this.onWidgetClose),this.state.messaging.on(`action:${Sg.WidgetApiFromWidgetAction.SetModalButtonEnabled}`,this.onButtonEnableToggle))})),(0,h.A)(this,"onWidgetClose",(e=>{this.props.onFinished(!0,e.detail.data)})),(0,h.A)(this,"onButtonEnableToggle",(e=>{var t;e.preventDefault();var n;if(e.detail.data.button===Sg.BuiltInModalButtonID.Close||!this.possibleButtons.includes(e.detail.data.button))return null===(n=this.state.messaging)||void 0===n?void 0:n.transport.reply(e.detail,{error:{message:"Invalid button"}});let i;if(e.detail.data.enabled)i=(0,Vg.PF)(this.state.disabledButtonIds).filter((t=>t!==e.detail.data.button));else{const t=new Set(this.state.disabledButtonIds);t.add(e.detail.data.button),i=Array.from(t)}this.setState({disabledButtonIds:i}),null===(t=this.state.messaging)||void 0===t||t.transport.reply(e.detail,{})})),this.widget=new Ev(dv(dv({},this.props.widgetDefinition),{},{creatorUserId:E.J.safeGet().getSafeUserId(),id:`modal_${this.props.sourceWidgetId}`})),this.possibleButtons=(this.props.widgetDefinition.buttons||[]).map((e=>e.id))}componentDidMount(){const e=new iv([],this.widget,Sg.WidgetKind.Modal,!1),t=new Sg.ClientWidgetApi(this.widget,this.appFrame.current,e);this.setState({messaging:t})}componentWillUnmount(){this.state.messaging&&(this.state.messaging.off("ready",this.onReady),this.state.messaging.off(`action:${Sg.WidgetApiFromWidgetAction.CloseModalWidget}`,this.onWidgetClose),this.state.messaging.stop())}render(){var e,t,n;const i=this.widget.getCompleteUrl({widgetRoomId:this.props.widgetRoomId,currentUserId:E.J.safeGet().getSafeUserId(),userDisplayName:null!==(e=Va.V.instance.displayName)&&void 0!==e?e:void 0,userHttpAvatarUrl:null!==(t=Va.V.instance.getHttpAvatarUrl())&&void 0!==t?t:void 0,clientId:lv,clientTheme:V.A.getValue("theme"),clientLanguage:(0,P.mf)(),baseUrl:E.J.safeGet().baseUrl}),r=new URL(i);r.searchParams.set("widgetId",this.widget.id),r.searchParams.set("parentUrl",window.location.href.split("#",2)[0]);const o=r.toString().replace(/%24/g,"$");let a;return this.props.widgetDefinition.buttons&&(a=this.props.widgetDefinition.buttons.slice(0,3).reverse().map((e=>{let t="secondary";switch(e.kind){case Sg.ModalButtonKind.Primary:t="primary";break;case Sg.ModalButtonKind.Secondary:t="primary_outline";break;case Sg.ModalButtonKind.Danger:t="danger"}const n=this.state.disabledButtonIds.includes(e.id);return s.createElement(Ae.A,{key:e.id,kind:t,onClick:()=>{var t;null===(t=this.state.messaging)||void 0===t||t.notifyModalWidgetButtonClicked(e.id)},disabled:n},e.label)}))),s.createElement(Pa.A,{title:this.props.widgetDefinition.name||(0,P._t)("widget|modal_title_default"),className:"mx_ModalWidgetDialog",contentId:"mx_Dialog_content",onFinished:this.props.onFinished},s.createElement("div",{className:"mx_ModalWidgetDialog_warning"},s.createElement(av.A,{width:"16px",height:"16px"}),(0,P._t)("widget|modal_data_warning",{widgetDomain:r.hostname})),s.createElement("div",null,s.createElement("iframe",{title:null!==(n=this.widget.name)&&void 0!==n?n:void 0,ref:this.appFrame,sandbox:"allow-forms allow-scripts allow-same-origin",src:o,onLoad:this.onLoad})),s.createElement("div",{className:"mx_ModalWidgetDialog_buttons"},a))}}var mv;function pv(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function hv(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?pv(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):pv(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class gv extends B.r{constructor(){super(w.A,{}),(0,h.A)(this,"modalInstance",null),(0,h.A)(this,"openSourceWidgetId",null),(0,h.A)(this,"openSourceWidgetRoomId",null),(0,h.A)(this,"canOpenModalWidget",(()=>!this.modalInstance)),(0,h.A)(this,"openModalWidget",((e,t,n)=>{this.modalInstance||(this.openSourceWidgetId=t.id,this.openSourceWidgetRoomId=null!=n?n:null,this.modalInstance=A.Ay.createDialog(uv,{widgetDefinition:hv({},e),widgetRoomId:n,sourceWidgetId:t.id,onFinished:(e,i)=>{this.closeModalWidget(t,n,e&&i?i:{"m.exited":!0}),this.openSourceWidgetId=null,this.openSourceWidgetRoomId=null,this.modalInstance=null}},void 0,!1,!0))})),(0,h.A)(this,"closeModalWidget",((e,t,n)=>{if(this.modalInstance&&this.openSourceWidgetId===e.id&&this.openSourceWidgetRoomId===t){this.openSourceWidgetId=null,this.openSourceWidgetRoomId=null,this.modalInstance.close(),this.modalInstance=null;const i=rv.c.instance.getMessaging(e,t);if(!i)return void o.v.error("No source widget messaging for modal widget");i.notifyModalWidgetClose(n)}}))}static get instance(){return gv.internalInstance}async onAction(e){}}mv=gv,(0,h.A)(gv,"internalInstance",(()=>{const e=new mv;return e.start(),e})()),window.mxModalWidgetStore=gv.instance;var vv=n("./src/stores/WidgetStore.ts");const fv={};var _v=n("./src/components/views/dialogs/ErrorDialog.tsx");function yv(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function bv(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?yv(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):yv(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class Ev extends Sg.Widget{constructor(e){super(e),this.rawDefinition=e}get templateUrl(){var e;return Bg.x.JITSI.matches(this.type)?wg.A.getLocalJitsiWrapperUrl({forLocalRender:!0,auth:null===(e=super.rawData)||void 0===e?void 0:e.auth}):super.templateUrl}get popoutTemplateUrl(){var e;return Bg.x.JITSI.matches(this.type)?wg.A.getLocalJitsiWrapperUrl({forLocalRender:!1,auth:null===(e=super.rawData)||void 0===e?void 0:e.auth}):this.templateUrl}get rawData(){let e=super.rawData.conferenceId;if(void 0===e){e=new URL(super.templateUrl).searchParams.get("confId")}let t=super.rawData.domain;void 0===t&&(t="meet.element.io");let n=(new Q.A).getEffectiveTheme();if(n.startsWith("custom-")){const e=(0,Fa.TP)(n.slice(7));n=e.is_dark?"dark":"light"}return n=n.includes("light")?"light":"dark",bv(bv({},super.rawData),{},{theme:n,conferenceId:e,domain:t})}getCompleteUrl(e,t=!1){return(0,Sg.runTemplate)(t?this.popoutTemplateUrl:this.templateUrl,bv(bv({},this.rawDefinition),{},{data:this.rawData}),e)}}class wv extends Z.EventEmitter{constructor(e){var t;super(),(0,h.A)(this,"client",void 0),(0,h.A)(this,"messaging",null),(0,h.A)(this,"mockWidget",void 0),(0,h.A)(this,"scalarToken",void 0),(0,h.A)(this,"roomId",void 0),(0,h.A)(this,"kind",void 0),(0,h.A)(this,"virtual",void 0),(0,h.A)(this,"readUpToMap",{}),(0,h.A)(this,"stickyPromise",void 0),(0,h.A)(this,"eventsToFeed",new WeakSet),(0,h.A)(this,"onOpenModal",(async e=>{var t,n;(e.preventDefault(),gv.instance.canOpenModalWidget())?(gv.instance.openModalWidget(e.detail.data,this.mockWidget,this.roomId),null===(t=this.messaging)||void 0===t||t.transport.reply(e.detail,{})):null===(n=this.messaging)||void 0===n||n.transport.reply(e.detail,{error:{message:"Unable to open modal at this time"}})})),(0,h.A)(this,"onEvent",(e=>{this.client.decryptEventIfNeeded(e),this.feedEvent(e)})),(0,h.A)(this,"onEventDecrypted",(e=>{this.feedEvent(e)})),(0,h.A)(this,"onToDeviceEvent",(async e=>{var t;await this.client.decryptEventIfNeeded(e),e.isDecryptionFailure()||await(null===(t=this.messaging)||void 0===t?void 0:t.feedToDevice(e.getEffectiveEvent(),e.isEncrypted()))})),this.appTileProps=e,this.client=E.J.safeGet();let n=e.app;n.creatorUserId||(n=(0,Hg.tn)(n),n.creatorUserId=this.client.getUserId()),this.mockWidget=new Ev(n),this.roomId=null===(t=e.room)||void 0===t?void 0:t.roomId,this.kind=e.userWidget?Sg.WidgetKind.Account:Sg.WidgetKind.Room,this.virtual=(0,vv.Sw)(n)&&void 0===n.eventId,this.stickyPromise=e.stickyPromise}get eventListenerRoomId(){return this.roomId?this.roomId:Wa.M.instance.roomViewStore.getRoomId()}get widgetApi(){return this.messaging}get embedUrl(){return this.runUrlTemplate({asPopout:!1})}get popoutUrl(){return this.runUrlTemplate({asPopout:!0})}runUrlTemplate(e={asPopout:!1}){var t,n,i,r,s;const o=null!==(t=null==fv||null===(n=fv.provideVariables)||void 0===n?void 0:n.call(fv))&&void 0!==t?t:{},a={widgetRoomId:this.roomId,currentUserId:this.client.getUserId(),userDisplayName:null!==(i=Va.V.instance.displayName)&&void 0!==i?i:void 0,userHttpAvatarUrl:null!==(r=Va.V.instance.getHttpAvatarUrl())&&void 0!==r?r:void 0,clientId:lv,clientTheme:V.A.getValue("theme"),clientLanguage:(0,P.mf)(),deviceId:null!==(s=this.client.getDeviceId())&&void 0!==s?s:void 0,baseUrl:this.client.baseUrl},l=this.mockWidget.getCompleteUrl(Object.assign(a,o),null==e?void 0:e.asPopout),c=new URL(l);return null!=e&&e.asPopout||(c.searchParams.set("widgetId",this.mockWidget.id),c.searchParams.set("parentUrl",window.location.href.split("#",2)[0]),this.scalarToken&&c.searchParams.set("scalar_token",this.scalarToken)),c.toString().replace(/%24/g,"$")}get started(){return!!this.messaging}startMessaging(e){if(this.started)return;const t=this.appTileProps.whitelistCapabilities||[],n=new iv(t,this.mockWidget,this.kind,this.virtual,this.roomId);this.messaging=new Sg.ClientWidgetApi(this.mockWidget,e,n),this.messaging.on("preparing",(()=>this.emit("preparing"))),this.messaging.on("error:preparing",(e=>this.emit("error:preparing",e))),this.messaging.on("ready",(()=>{rv.c.instance.storeMessaging(this.mockWidget,this.roomId,this.messaging),this.emit("ready")})),this.messaging.on("capabilitiesNotified",(()=>this.emit("capabilitiesNotified"))),this.messaging.on(`action:${Sg.WidgetApiFromWidgetAction.OpenModalWidget}`,this.onOpenModal),this.messaging.on(`action:${ov.k.ViewRoom}`,(e=>{var t;e.preventDefault();const n=(e.detail.data||{}).room_id;var i,r;return n?null!==(t=this.messaging)&&void 0!==t&&t.hasCapability(Gg.CanChangeViewedRoom)?(w.A.dispatch({action:R.r.ViewRoom,room_id:n,metricsTrigger:"Widget"}),void this.messaging.transport.reply(e.detail,{})):null===(r=this.messaging)||void 0===r?void 0:r.transport.reply(e.detail,{error:{message:"This widget does not have permission for this action (denied)."}}):null===(i=this.messaging)||void 0===i?void 0:i.transport.reply(e.detail,{error:{message:"Room ID not supplied."}})}));for(const e of this.client.getRooms()){var r;const t=(null===(r=e.getLiveTimeline())||void 0===r?void 0:r.getEvents())||[],n=t[t.length-1];n&&(this.readUpToMap[e.roomId]=n.getId())}this.client.on(i.ClientEvent.Event,this.onEvent),this.client.on(i.MatrixEventEvent.Decrypted,this.onEventDecrypted),this.client.on(i.ClientEvent.ToDeviceEvent,this.onToDeviceEvent),this.messaging.on(`action:${Sg.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen}`,(async e=>{var t,n;null!==(t=this.messaging)&&void 0!==t&&t.hasCapability(Sg.MatrixCapabilities.AlwaysOnScreen)&&(e.preventDefault(),e.detail.data.value&&this.stickyPromise&&await this.stickyPromise(),Lg.A.instance.setWidgetPersistence(this.mockWidget.id,null!==(n=this.roomId)&&void 0!==n?n:null,e.detail.data.value),this.messaging.transport.reply(e.detail,{}))})),this.messaging.on(`action:${Sg.WidgetApiFromWidgetAction.SendSticker}`,(e=>{var t;null!==(t=this.messaging)&&void 0!==t&&t.hasCapability(Sg.MatrixCapabilities.StickerSending)&&(e.preventDefault(),this.messaging.transport.reply(e.detail,{}),w.A.dispatch({action:"m.sticker",data:e.detail.data,widgetId:this.mockWidget.id}))})),Bg.x.STICKERPICKER.matches(this.mockWidget.type)&&this.messaging.on(`action:${ov.k.OpenIntegrationManager}`,(e=>{var t,n;e.preventDefault(),null===(t=this.messaging)||void 0===t||t.transport.reply(e.detail,{}),w.A.dispatch({action:"stickerpicker_close"});const i=e.detail.data,r=null==i?void 0:i.integType,s=null==i?void 0:i.integId,o=Wa.M.instance.roomViewStore.getRoomId(),a=o?this.client.getRoom(o):void 0;a&&(null===(n=sv.J.sharedInstance())||void 0===n||null===(n=n.getPrimaryManager())||void 0===n||n.open(a,`type_${r}`,s))})),Bg.x.JITSI.matches(this.mockWidget.type)&&this.messaging.on(`action:${ov.k.HangupCall}`,(e=>{var t,n;e.preventDefault(),null!==(t=e.detail.data)&&void 0!==t&&t.errorMessage&&A.Ay.createDialog(_v.A,{title:(0,P._t)("widget|error_hangup_title"),description:(0,P._t)("widget|error_hangup_description",{message:e.detail.data.errorMessage})}),null===(n=this.messaging)||void 0===n||n.transport.reply(e.detail,{})}))}async prepare(){var e,t;if(await(null!==(e=null==fv||null===(t=fv.isReady)||void 0===t?void 0:t.call(fv))&&void 0!==e?e:Promise.resolve()),this.scalarToken)return;const n=rv.c.instance.getMessaging(this.mockWidget,this.roomId);n&&(this.messaging=n);try{if(wg.A.isScalarUrl(this.mockWidget.templateUrl)){const e=sv.J.sharedInstance();if(e.hasManager()){const t=e.getPrimaryManager();if(t&&wg.A.isScalarUrl(t.apiUrl)){const e=t.getScalarClient();this.scalarToken=await e.getScalarToken()}}}}catch(e){o.v.error("Error preparing widget communications: ",e)}}stopMessaging(e={forceDestroy:!1}){var t;null!=e&&e.forceDestroy||!Lg.A.instance.getWidgetPersistence(this.mockWidget.id,null!==(t=this.roomId)&&void 0!==t?t:null)?this.started&&(rv.c.instance.stopMessaging(this.mockWidget,this.roomId),this.messaging=null,this.client.off(i.ClientEvent.Event,this.onEvent),this.client.off(i.MatrixEventEvent.Decrypted,this.onEventDecrypted),this.client.off(i.ClientEvent.ToDeviceEvent,this.onToDeviceEvent)):o.v.log("Skipping destroy - persistent widget")}relatesToUnknown(e){if(!e.relationEventId||e.replyEventId)return!1;const t=this.client.getRoom(e.getRoomId());return null===t||!t.findEventById(e.relationEventId)}isFromInvite(e){const t=this.client.getRoom(e.getRoomId());return(null==t?void 0:t.getMyMembership())===oa.O.Invite}advanceReadUpToMarker(e){const t=e.getId();if(void 0===t)return!1;const n=e.getRoomId();if(void 0===n)return!1;const i=this.client.getRoom(n);if(null===i)return!1;const r=this.readUpToMap[e.getRoomId()];if(!r)return this.readUpToMap[n]=t,!0;if(r===t)return!1;const s=i.getLiveTimeline(),o=(0,Vg.PF)(s.getEvents()).reverse().slice(0,100);for(const i of o){if(i.getId()===r)return!1;if(i.getId()===e.getId())return this.readUpToMap[n]=t,!0}return!1}feedEvent(e){if(null!==this.messaging&&(this.eventsToFeed.delete(e)||this.relatesToUnknown(e)||this.isFromInvite(e)||this.advanceReadUpToMarker(e)))if(e.isBeingDecrypted()||e.isDecryptionFailure())this.eventsToFeed.add(e);else{const t=e.getEffectiveEvent();this.messaging.feedEvent(t,this.eventListenerRoomId).catch((e=>{o.v.error("Error sending event to widget: ",e)}))}}}var Sv=n("./src/stores/widgets/WidgetLayoutStore.ts");function Av(){return u.Ay.get("audio_stream_url")}async function Cv(e,t,n){const i=await async function(e,t){const n=await e.getOpenIdToken(),i=Av()+"/createStream",r=await window.fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({room_id:t,openid_token:n})});return(await r.json()).stream_id}(e,n);await t.transport.send(ov.k.StartLiveStream,{rtmpStreamKey:"rtmp://audiostream.dummy/"+i})}const xv=["onFinished","app","userWidget","onDeleteClick","onEditClick","showUnpin"],kv=e=>!!Av()&&Bg.x.JITSI.matches(e.type),Rv=(e,t)=>t&&wg.A.isManagedByManager(e),Iv=(e,t,n,i)=>{var r;const s=(0,vv.Sw)(n)&&void 0!==n.eventId&&null!==(r=V.A.getValue("allowedWidgets",t)[n.eventId])&&void 0!==r&&r||n.creatorUserId===(null==e?void 0:e.getUserId()),o=Bg.x.JITSI.matches(n.type);return!i&&!o&&s},Tv=(e,t)=>!!t||e,Pv=e=>V.A.getValue("enableWidgetScreenshots")&&!(null==e||!e.hasCapability(Sg.MatrixCapabilities.Screenshots)),Nv=(e,t,n)=>{if(!n)return[!1,!1];const i=t?Sv.aK.instance.getContainerWidgets(t,Sv.mc.Top):[],r=i.findIndex((t=>t.id===e.id));return[r>0,r<i.length-1]},Dv=(e,t,n,i,r,s)=>{const o=i||wg.A.canUserModifyWidgets(e,null==t?void 0:t.roomId),a=rv.c.instance.getMessagingForUid(wg.A.getWidgetUid(n));return kv(n)||Rv(n,o)||Iv(e,null==t?void 0:t.roomId,n,i)||Tv(o,s)||Pv(a)||Nv(n,t,r).some(Boolean)},Mv=e=>{let{onFinished:t,app:n,userWidget:i,onDeleteClick:r,onEditClick:a,showUnpin:l}=e,c=(0,Ve.A)(e,xv);const d=(0,s.useContext)(Pe.Ay),{room:u,roomId:m}=(0,Ld.ME)("room","roomId"),h=rv.c.instance.getMessagingForUid(wg.A.getWidgetUid(n)),g=i||wg.A.canUserModifyWidgets(d,m);let v,f,_,y,b;if(m&&kv(n)){const e=async()=>{try{await Cv(d,h,m)}catch(e){o.v.error("Failed to start livestream",e);const t=e instanceof Error?e.message:(0,P._t)("widget|error_unable_start_audio_stream_description");A.Ay.createDialog(_v.A,{title:(0,P._t)("widget|error_unable_start_audio_stream_title"),description:t})}t()};v=s.createElement(Be.R$,{onClick:e,label:(0,P._t)("widget|context_menu|start_audio_stream")})}if(Rv(n,g)){const e=()=>{a?a():u&&wg.A.editWidget(u,n),t()};f=s.createElement(Be.R$,{onClick:e,label:(0,P._t)("action|edit")})}if(Pv(h)){const e=()=>{null==h||h.takeScreenshot().then((e=>{w.A.dispatch({action:"picture_snapshot",file:e.screenshot})})).catch((e=>{o.v.error("Failed to take screenshot: ",e)})),t()};_=s.createElement(Be.R$,{onClick:e,label:(0,P._t)("widget|context_menu|screenshot")})}if(Tv(g,r)){const e=()=>{r?r():m&&A.Ay.createDialog(q.A,{title:(0,P._t)("widget|context_menu|delete"),description:(0,P._t)("widget|context_menu|delete_warning"),button:(0,P._t)("widget|context_menu|delete"),onFinished:e=>{e&&wg.A.setRoomWidget(d,m,n.id)}}),t()};y=s.createElement(Be.R$,{onClick:e,label:i?(0,P._t)("action|remove"):(0,P._t)("widget|context_menu|remove")})}if(Iv(d,m,n,i)){const e={approved:void 0};if(ev.r.instance.invoke(Ag.Z.PreLoadRequest,e,new Ev(n)),!e.approved){const e=()=>{const e=(0,vv.Sw)(n)?n.eventId:void 0;o.v.info("Revoking permission for widget to load: "+e);const i=V.A.getValue("allowedWidgets",m);void 0!==e&&(i[e]=!1);const r=V.A.firstSupportedLevel("allowedWidgets");if(!r)throw new Error("level must be defined");V.A.setValue("allowedWidgets",null!=m?m:null,r,i).catch((e=>{o.v.error(e)})),t()};b=s.createElement(Be.R$,{onClick:e,label:(0,P._t)("widget|context_menu|revoke")})}}const[E,S]=Nv(n,u,l);let C,x;if(E){const e=()=>{if(!u)throw new Error("room must be defined");Sv.aK.instance.moveWithinContainer(u,Sv.mc.Top,n,-1),t()};C=s.createElement(Be.R$,{onClick:e,label:(0,P._t)("widget|context_menu|move_left")})}if(S){const e=()=>{if(!u)throw new Error("room must be defined");Sv.aK.instance.moveWithinContainer(u,Sv.mc.Top,n,1),t()};x=s.createElement(Be.R$,{onClick:e,label:(0,P._t)("widget|context_menu|move_right")})}return s.createElement(Be.Ay,(0,p.A)({},c,{chevronFace:Fe.t4.None,onFinished:t}),s.createElement(Be.tx,null,v,f,b,y,_,C,x))},Ov=["app","className","size"],Lv=e=>{let{app:t,className:i,size:r="20px"}=e,o=(0,Ve.A)(e,Ov),a=[n("./res/img/element-icons/room/default_app.svg").A];return t.type.includes("jitsi")?a=[n("./res/img/element-icons/room/default_video.svg").A]:t.type.includes("meeting")||t.type.includes("calendar")?a=[n("./res/img/element-icons/room/default_cal.svg").A]:t.type.includes("pad")||t.type.includes("doc")||t.type.includes("calc")?a=[n("./res/img/element-icons/room/default_doc.svg").A]:t.type.includes("clock")&&(a=[n("./res/img/element-icons/room/default_clock.svg").A]),s.createElement(ja.A,(0,p.A)({},o,{name:t.id,className:re()("mx_WidgetAvatar",i),url:(0,vv.Sw)(t)&&t.avatar_url?(0,Up.lH)(t.avatar_url).getSquareThumbnailHttp(20):null,urls:a,size:r}))};var Fv=n("./res/img/external-link.svg");function Uv(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Bv(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Uv(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Uv(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class Vv extends s.Component{constructor(e,t){super(e,t),(0,h.A)(this,"contextMenuButton",(0,s.createRef)()),(0,h.A)(this,"iframe",void 0),(0,h.A)(this,"allowedWidgetsWatchRef",void 0),(0,h.A)(this,"persistKey",void 0),(0,h.A)(this,"sgWidget",void 0),(0,h.A)(this,"dispatcherRef",void 0),(0,h.A)(this,"unmounted",!1),(0,h.A)(this,"watchUserReady",(()=>{Va.V.instance.isProfileInfoFetched||Va.V.instance.once(I.H,this.onUserReady)})),(0,h.A)(this,"onUserReady",(()=>{this.setState({isUserProfileReady:!0})})),(0,h.A)(this,"hasPermissionToLoad",(e=>{var t;if(this.usingLocalWidget())return!0;if(!e.room)return!0;const n={approved:void 0};if(ev.r.instance.invoke(Ag.Z.PreLoadRequest,n,new Ev(this.props.app)),n.approved)return!0;const i=V.A.getValue("allowedWidgets",e.room.roomId);return(0,vv.Sw)(e.app)&&void 0!==e.app.eventId&&null!==(t=i[e.app.eventId])&&void 0!==t&&t||e.userId===e.creatorUserId})),(0,h.A)(this,"onMyMembership",((e,t)=>{var n;t!==oa.O.Leave&&t!==oa.O.Ban||e.roomId!==(null===(n=this.props.room)||void 0===n?void 0:n.roomId)||this.onUserLeftRoom()})),(0,h.A)(this,"onAllowedWidgetsChange",(()=>{const e=this.hasPermissionToLoad(this.props);var t;this.state.hasPermissionToLoad&&!e&&(Lg.A.instance.destroyPersistentWidget(this.props.app.id,(0,vv.Sw)(this.props.app)?this.props.app.roomId:null),Ug.destroyElement(this.persistKey),null===(t=this.sgWidget)||void 0===t||t.stopMessaging());this.setState({hasPermissionToLoad:e})})),(0,h.A)(this,"iframeRefChange",(e=>{this.iframe=e,this.unmounted||(e?this.startMessaging():this.resetWidget(this.props))})),(0,h.A)(this,"onWidgetReady",(()=>{this.setState({loading:!1})})),(0,h.A)(this,"updateRequiresClient",(()=>{var e;this.setState({requiresClient:!(null===(e=this.sgWidget)||void 0===e||null===(e=e.widgetApi)||void 0===e||!e.hasCapability(Gg.RequiresClient))})})),(0,h.A)(this,"onAction",(e=>{var t,n;switch(e.action){case"m.sticker":e.widgetId===this.props.app.id&&null!==(t=this.sgWidget)&&void 0!==t&&null!==(t=t.widgetApi)&&void 0!==t&&t.hasCapability(Sg.MatrixCapabilities.StickerSending)?(w.A.dispatch({action:"post_sticker_message",data:Bv(Bv({},e.data),{},{threadId:this.props.threadId})}),w.A.dispatch({action:"stickerpicker_close"})):o.v.warn("Ignoring sticker message. Invalid capability");break;case R.r.AfterLeaveRoom:e.room_id===(null===(n=this.props.room)||void 0===n?void 0:n.roomId)&&this.onUserLeftRoom()}})),(0,h.A)(this,"grantWidgetPermission",(()=>{var e;const t=null===(e=this.props.room)||void 0===e?void 0:e.roomId,n=(0,vv.Sw)(this.props.app)?this.props.app.eventId:void 0;o.v.info("Granting permission for widget to load: "+n);const i=V.A.getValue("allowedWidgets",t);void 0!==n&&(i[n]=!0);const r=V.A.firstSupportedLevel("allowedWidgets");V.A.setValue("allowedWidgets",null!=t?t:null,r,i).then((()=>{this.setState({hasPermissionToLoad:!0}),this.startWidget()})).catch((e=>{o.v.error(e)}))})),(0,h.A)(this,"onPopoutWidgetClick",(()=>{var e;Bg.x.JITSI.matches(this.props.app.type)&&this.reload(),Object.assign(document.createElement("a"),{target:"_blank",href:null===(e=this.sgWidget)||void 0===e?void 0:e.popoutUrl,rel:"noreferrer noopener"}).click()})),(0,h.A)(this,"onToggleMaximisedClick",(()=>{if(!this.props.room)return;const e=Sv.aK.instance.isInContainer(this.props.room,this.props.app,Sv.mc.Center)?Sv.mc.Top:Sv.mc.Center;Sv.aK.instance.moveToContainer(this.props.room,this.props.app,e),e===Sv.mc.Top&&this.closeChatCardIfNeeded()})),(0,h.A)(this,"onMinimiseClicked",(()=>{this.props.room&&(Sv.aK.instance.moveToContainer(this.props.room,this.props.app,Sv.mc.Right),this.closeChatCardIfNeeded())})),(0,h.A)(this,"closeChatCardIfNeeded",(()=>{this.props.room&&rl.A.instance.currentCardForRoom(this.props.room.roomId).phase===sl.n.Timeline&&rl.A.instance.popCard(this.props.room.roomId)})),(0,h.A)(this,"onContextMenuClick",(()=>{this.setState({menuDisplayed:!0})})),(0,h.A)(this,"closeContextMenu",(()=>{this.setState({menuDisplayed:!1})})),this.persistKey="widget_"+wg.A.getWidgetUid(this.props.app);try{this.sgWidget=new wv(this.props)}catch(e){o.v.log("Failed to construct widget",e),this.sgWidget=void 0}this.state=this.getNewState(e)}onUserLeftRoom(){Lg.A.instance.getWidgetPersistence(this.props.app.id,(0,vv.Sw)(this.props.app)?this.props.app.roomId:null)&&(this.props.room&&Wa.M.instance.roomViewStore.getRoomId()!==this.props.room.roomId?this.endWidgetActions():Bg.x.JITSI.matches(this.props.app.type)?this.reload():Lg.A.instance.destroyPersistentWidget(this.props.app.id,(0,vv.Sw)(this.props.app)?this.props.app.roomId:null))}determineInitialRequiresClientState(){try{var e;const t=new Ev(this.props.app),n=rv.c.instance.getMessaging(t,null===(e=this.props.room)||void 0===e?void 0:e.roomId);if(n)return n.hasCapability(Gg.RequiresClient)}catch{}return!0}getNewState(e){return{initialising:!0,loading:!this.props.waitForIframeLoad&&!Ug.isMounted(this.persistKey),hasPermissionToLoad:this.hasPermissionToLoad(e),isUserProfileReady:Va.V.instance.isProfileInfoFetched,error:null,menuDisplayed:!1,requiresClient:this.determineInitialRequiresClientState(),hasContextMenuOptions:Dv(this.context,this.props.room,e.app,e.userWidget,!e.userWidget,e.onDeleteClick)}}isMixedContent(){const e=window.location.protocol,t=(0,Pg.Dl)(this.props.app.url).protocol;return"https:"===e&&"https:"!==t&&(o.v.warn("Refusing to load mixed-content app:",e,t,window.location,this.props.app.url),!0)}componentDidMount(){this.unmounted=!1,this.props.miniMode||Lg.A.instance.dockWidget(this.props.app.id,(0,vv.Sw)(this.props.app)?this.props.app.roomId:null),this.sgWidget&&this.setupSgListeners(),this.sgWidget&&this.state.hasPermissionToLoad&&this.startWidget(),this.watchUserReady(),this.props.room&&this.context.on(i.RoomEvent.MyMembership,this.onMyMembership),this.allowedWidgetsWatchRef=V.A.watchSetting("allowedWidgets",null,this.onAllowedWidgetsChange),this.dispatcherRef=w.A.register(this.onAction)}componentWillUnmount(){this.unmounted=!0,this.props.miniMode||Lg.A.instance.undockWidget(this.props.app.id,(0,vv.Sw)(this.props.app)?this.props.app.roomId:null),Lg.A.instance.isLive(this.props.app.id,(0,vv.Sw)(this.props.app)?this.props.app.roomId:null)||this.endWidgetActions(),w.A.unregister(this.dispatcherRef),this.props.room&&this.context.off(i.RoomEvent.MyMembership,this.onMyMembership),V.A.unwatchSetting(this.allowedWidgetsWatchRef),Va.V.instance.removeListener(I.H,this.onUserReady)}setupSgListeners(){var e,t,n;null===(e=this.sgWidget)||void 0===e||e.on("ready",this.onWidgetReady),null===(t=this.sgWidget)||void 0===t||t.on("error:preparing",this.updateRequiresClient),null===(n=this.sgWidget)||void 0===n||n.on("capabilitiesNotified",this.updateRequiresClient)}stopSgListeners(){var e;this.sgWidget&&(null===(e=this.sgWidget)||void 0===e||e.off("ready",this.onWidgetReady),this.sgWidget.off("error:preparing",this.updateRequiresClient),this.sgWidget.off("capabilitiesNotified",this.updateRequiresClient))}resetWidget(e){var t;null===(t=this.sgWidget)||void 0===t||t.stopMessaging(),this.stopSgListeners();try{this.sgWidget=new wv(e),this.setupSgListeners(),this.startWidget()}catch(e){o.v.error("Failed to construct widget",e),this.sgWidget=void 0}}startWidget(){var e;null===(e=this.sgWidget)||void 0===e||e.prepare().then((()=>{this.unmounted||this.setState({initialising:!1})}))}startMessaging(){try{var e;null===(e=this.sgWidget)||void 0===e||e.startMessaging(this.iframe)}catch(e){o.v.error("Failed to start widget",e)}}componentDidUpdate(e){e.app.url!==this.props.app.url&&(this.getNewState(this.props),this.state.hasPermissionToLoad&&this.resetWidget(this.props))}async endWidgetActions(){var e;this.iframe&&(this.iframe.src="about:blank"),Bg.x.JITSI.matches(this.props.app.type)&&this.props.room&&Ee.Ay.instance.hangupCallApp(this.props.room.roomId),Ug.destroyElement(this.persistKey),Lg.A.instance.destroyPersistentWidget(this.props.app.id,(0,vv.Sw)(this.props.app)?this.props.app.roomId:null),null===(e=this.sgWidget)||void 0===e||e.stopMessaging({forceDestroy:!0})}formatAppTileName(){let e="No name";return this.props.app.name&&this.props.app.name.trim()&&(e=this.props.app.name.trim()),e}usingLocalWidget(){return Bg.x.JITSI.matches(this.props.app.type)}getTileTitle(){const e=this.formatAppTileName(),t=s.createElement("span",null,"Â -Â ");let n="";return this.props.widgetPageTitle&&this.props.widgetPageTitle!==this.formatAppTileName()&&(n=this.props.widgetPageTitle),s.createElement("span",null,s.createElement(Lv,{app:this.props.app,size:"20px"}),s.createElement("h3",null,e),s.createElement("span",null,n?t:"",n))}reload(){this.endWidgetActions().then((()=>{this.resetWidget(this.props),this.startMessaging(),this.iframe&&this.sgWidget&&(this.iframe.src=this.sgWidget.embedUrl)}))}render(){let e;const t=re()({mx_AppTileBody:!0,"mx_AppTileBody--large":!this.props.miniMode,"mx_AppTileBody--mini":this.props.miniMode,"mx_AppTileBody--loading":this.state.loading,"mx_AppTileBody--call":this.props.app.type===Bg.x.CALL.preferred}),n={};this.props.pointerEvents&&(n.pointerEvents=this.props.pointerEvents);const i=s.createElement("div",{className:"mx_AppTileBody_fadeInSpinner"},s.createElement(Na.A,{message:(0,P._t)("common|loading")})),r=wg.A.getWidgetName(this.props.app);if(null===this.sgWidget)e=s.createElement("div",{className:t,style:n},s.createElement(Og,{errorMsg:(0,P._t)("widget|error_loading")}));else if(!this.state.hasPermissionToLoad&&this.props.room&&this.sgWidget){const i=this.context.isRoomEncrypted(this.props.room.roomId);e=s.createElement("div",{className:t,style:n},s.createElement(Dg,{roomId:this.props.room.roomId,creatorUserId:this.props.creatorUserId,url:this.sgWidget.embedUrl,isRoomEncrypted:i,onPermissionGranted:this.grantWidgetPermission}))}else if(this.state.initialising||!this.state.isUserProfileReady)e=s.createElement("div",{className:t,style:n},i);else if(this.isMixedContent())e=s.createElement("div",{className:t,style:n},s.createElement(Og,{errorMsg:(0,P._t)("widget|error_mixed_content")}));else if(this.sgWidget&&(e=s.createElement(s.Fragment,null,s.createElement("div",{className:t,style:n},this.state.loading&&i,s.createElement("iframe",{title:r,allow:"microphone; camera; encrypted-media; autoplay; display-capture; clipboard-write; clipboard-read;",ref:this.iframeRefChange,src:this.sgWidget.embedUrl,allowFullScreen:!0,sandbox:"allow-forms allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-presentation allow-downloads"})),this.props.overlay),!this.props.userWidget)){const t=101;e=s.createElement("div",{className:"mx_AppTile_persistedWrapper"},s.createElement(Ug,{zIndex:this.props.miniMode?t:9,persistKey:this.persistKey,moveRef:this.props.movePersistedElement},e))}let o,a;o=this.props.miniMode?{mx_AppTile_mini:!0}:this.props.fullWidth?{mx_AppTileFullWidth:!0}:{mx_AppTile:!0},o=re()(o),this.state.menuDisplayed&&(a=s.createElement(Mv,(0,p.A)({},(0,Fe.qv)(this.contextMenuButton.current.getBoundingClientRect()),{app:this.props.app,onFinished:this.closeContextMenu,showUnpin:!this.props.userWidget,userWidget:this.props.userWidget,onEditClick:this.props.onEditClick,onDeleteClick:this.props.onDeleteClick})));const l=[];if(this.props.showLayoutButtons){const e=this.props.room&&Sv.aK.instance.isInContainer(this.props.room,this.props.app,Sv.mc.Center);l.push(s.createElement(Ae.A,{key:"toggleMaximised",className:"mx_AppTileMenuBar_widgets_button",title:e?(0,P._t)("widget|unmaximise"):(0,P._t)("action|maximise"),onClick:this.onToggleMaximisedClick},e?s.createElement(Cg.A,{className:"mx_Icon mx_Icon_12"}):s.createElement(xg.A,{className:"mx_Icon mx_Icon_12"}))),l.push(s.createElement(Ae.A,{key:"minimise",className:"mx_AppTileMenuBar_widgets_button",title:(0,P._t)("action|minimise"),onClick:this.onMinimiseClicked},s.createElement(kg.A,{className:"mx_Icon mx_Icon_16"})))}return s.createElement(s.Fragment,null,s.createElement("div",{className:o,id:this.props.app.id},this.props.showMenubar&&s.createElement("div",{className:"mx_AppTileMenuBar"},s.createElement("span",{className:"mx_AppTileMenuBar_title",style:{pointerEvents:this.props.handleMinimisePointerEvents?"all":"none"}},this.props.showTitle&&this.getTileTitle()),s.createElement("span",{className:"mx_AppTileMenuBar_widgets"},l,this.props.showPopout&&!this.state.requiresClient&&s.createElement(Ae.A,{className:"mx_AppTileMenuBar_widgets_button",title:(0,P._t)("widget|popout"),onClick:this.onPopoutWidgetClick},s.createElement(Fv.I,{className:"mx_Icon mx_Icon_12 mx_Icon--stroke"})),this.state.hasContextMenuOptions&&s.createElement(Fe.VJ,{className:"mx_AppTileMenuBar_widgets_button",label:(0,P._t)("common|options"),isExpanded:this.state.menuDisplayed,ref:this.contextMenuButton,onClick:this.onContextMenuClick},s.createElement(Rg.A,{className:"mx_Icon mx_Icon_12"})))),e),a)}}(0,h.A)(Vv,"contextType",Pe.Ay),(0,h.A)(Vv,"defaultProps",{waitForIframeLoad:!0,showMenubar:!0,showTitle:!0,showPopout:!0,handleMinimisePointerEvents:!1,userWidget:!1,miniMode:!1,threadId:null,showLayoutButtons:!0});const jv=({room:e,widgetId:t,onClose:n})=>{const i=(0,s.useContext)(Pe.Ay),r=(0,wg.X)(e).find((e=>e.id===t)),o=r&&Sv.aK.instance.isInContainer(e,r,Sv.mc.Right),[a,l,c,d]=(0,Fe.EF)();if((0,s.useEffect)((()=>{r&&o||rl.A.instance.popCard()}),[r,o]),!r||!o)return null;let u;if(a){var m;const e=null===(m=l.current)||void 0===m?void 0:m.getBoundingClientRect(),t=e?e.right:0,n=e?e.bottom:0;u=s.createElement(Mv,{chevronFace:Fe.t4.None,right:Ie.A.instance.windowWidth-t-12,top:n+12,onFinished:d,app:r})}const p=s.createElement("div",{className:"mx_BaseCard_header_title"},s.createElement(uc.A,{size:"4",className:"mx_BaseCard_header_title_heading"},wg.A.getWidgetName(r)),s.createElement(Fe.VJ,{className:"mx_BaseCard_header_title_button--option",ref:l,onClick:c,isExpanded:a,label:(0,P._t)("common|options")}),u);return s.createElement(Ep.A,{header:p,className:"mx_WidgetCard",onClose:n,withoutScrollContainer:!0},s.createElement(Vv,{app:r,fullWidth:!0,showMenubar:!1,room:e,userId:i.getSafeUserId(),creatorUserId:r.creatorUserId,widgetPageTitle:wg.A.getWidgetDataTitle(r),waitForIframeLoad:r.waitForIframeLoad}))};function zv(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{d:"M10 12c-1.1 0-2.042-.392-2.825-1.175C6.392 10.042 6 9.1 6 8s.392-2.042 1.175-2.825C7.958 4.392 8.9 4 10 4s2.042.392 2.825 1.175C13.608 5.958 14 6.9 14 8s-.392 2.042-1.175 2.825C12.042 11.608 11.1 12 10 12Zm-8 6v-.8c0-.567.146-1.087.438-1.563A2.911 2.911 0 0 1 3.6 14.55a14.843 14.843 0 0 1 3.15-1.163A13.76 13.76 0 0 1 10 13c1.1 0 2.183.13 3.25.387 1.067.259 2.117.646 3.15 1.163.483.25.87.612 1.163 1.087.291.476.437.996.437 1.563v.8c0 .55-.196 1.02-.587 1.413A1.926 1.926 0 0 1 16 20H4c-.55 0-1.02-.196-1.413-.587A1.926 1.926 0 0 1 2 18Zm15-7h2v2c0 .283.096.52.288.713.191.191.429.287.712.287s.52-.096.712-.287A.968.968 0 0 0 21 13v-2h2a.97.97 0 0 0 .712-.287A.968.968 0 0 0 24 10a.967.967 0 0 0-.288-.713A.968.968 0 0 0 23 9h-2V7a.967.967 0 0 0-.288-.713A.968.968 0 0 0 20 6a.968.968 0 0 0-.712.287A.967.967 0 0 0 19 7v2h-2a.968.968 0 0 0-.712.287A.967.967 0 0 0 16 10c0 .283.096.52.288.713A.968.968 0 0 0 17 11Z"})})}zv.displayName="UserAddSolidIcon";const Wv=(0,s.forwardRef)(zv);var Hv=n("./node_modules/@vector-im/compound-design-tokens/icons/overflow-horizontal.svg"),Gv=n("./src/components/views/elements/TruncatedList.tsx"),Kv=n("./src/components/structures/SearchBox.tsx"),Jv=n("./src/components/views/rooms/EntityTile.tsx"),qv=n("./src/components/views/messages/DisambiguatedProfile.tsx"),$v=n("./src/components/views/rooms/E2EIcon.tsx"),Yv=n("./src/utils/crypto/deviceInfo.ts");class Zv extends s.Component{constructor(e){super(e),(0,h.A)(this,"userLastModifiedTime",void 0),(0,h.A)(this,"memberLastModifiedTime",void 0),(0,h.A)(this,"onRoomStateEvents",(e=>{if(e.getType()!==i.EventType.RoomEncryption)return;const{roomId:t}=this.props.member;if(e.getRoomId()!==t)return;E.J.safeGet().removeListener(i.RoomStateEvent.Events,this.onRoomStateEvents),this.setState({isRoomEncrypted:!0}),this.updateE2EStatus()})),(0,h.A)(this,"onUserTrustStatusChanged",((e,t)=>{e===this.props.member.userId&&this.updateE2EStatus()})),(0,h.A)(this,"onClick",(()=>{w.A.dispatch({action:R.r.ViewUser,member:this.props.member,push:!0})})),this.state={isRoomEncrypted:!1}}componentDidMount(){const e=E.J.safeGet(),{roomId:t}=this.props.member;if(t){const n=e.isRoomEncrypted(t);this.setState({isRoomEncrypted:n}),n?(e.on(f.CryptoEvent.UserTrustStatusChanged,this.onUserTrustStatusChanged),this.updateE2EStatus()):e.on(i.RoomStateEvent.Events,this.onRoomStateEvents)}}componentWillUnmount(){const e=E.J.get();e&&(e.removeListener(i.RoomStateEvent.Events,this.onRoomStateEvents),e.removeListener(f.CryptoEvent.UserTrustStatusChanged,this.onUserTrustStatusChanged))}async updateE2EStatus(){var e;const t=E.J.safeGet(),{userId:n}=this.props.member,i=n===t.getUserId(),r=await(null===(e=t.getCrypto())||void 0===e?void 0:e.getUserVerificationStatus(n));if(null==r||!r.isCrossSigningVerified())return void this.setState({e2eStatus:null!=r&&r.wasCrossSigningVerified()?$v.a.Warning:$v.a.Normal});const s=await(0,Yv.a)(t,n),o=await(0,Vg.rm)(s,(async e=>{var r;const s=await(null===(r=t.getCrypto())||void 0===r?void 0:r.getDeviceVerificationStatus(n,e));return!s||(i?!s.crossSigningVerified:!s.isVerified())}));this.setState({e2eStatus:o?$v.a.Warning:$v.a.Verified})}shouldComponentUpdate(e,t){return void 0===this.memberLastModifiedTime||this.memberLastModifiedTime<e.member.getLastModifiedTime()||(!(!e.member.user||!(void 0===this.userLastModifiedTime||this.userLastModifiedTime<e.member.user.getLastModifiedTime()))||(t.isRoomEncrypted!==this.state.isRoomEncrypted||t.e2eStatus!==this.state.e2eStatus))}getDisplayName(){return this.props.member.name}getPowerLabel(){return(0,P._t)("member_list|power_label",{userName:za.A.getDisplayUserIdentifier(this.props.member.userId,{roomId:this.props.member.roomId}),powerLevelNumber:this.props.member.powerLevel}).trim()}render(){var e;const t=this.props.member,n=this.getDisplayName(),i=null===(e=t.user)||void 0===e?void 0:e.presence,r=s.createElement($p.A,{member:t,size:"36px","aria-hidden":"true"});t.user&&(this.userLastModifiedTime=t.user.getLastModifiedTime()),this.memberLastModifiedTime=t.getLastModifiedTime();const o=new Map([[100,Jv.C.Admin],[50,Jv.C.Moderator]]);let a=this.props.member.powerLevel;for(const[e]of o)if(this.props.member.powerLevel>=e){a=e;break}const l=o.get(a);let c;this.state.isRoomEncrypted&&(c=this.state.e2eStatus);const d=s.createElement(qv.A,{member:t,fallbackName:n||""});return s.createElement(Jv.A,(0,p.A)({},this.props,{presenceState:i,presenceLastActiveAgo:t.user?t.user.lastActiveAgo:0,presenceLastTs:t.user?t.user.lastPresenceTs:0,presenceCurrentlyActive:!!t.user&&t.user.currentlyActive,avatarJsx:r,title:this.getPowerLabel(),name:n,nameJSX:d,powerStatus:l,showPresence:this.props.showPresence,e2eStatus:c,onClick:this.onClick}))}}(0,h.A)(Zv,"defaultProps",{showPresence:!0});var Xv,Qv,ef=n("./src/utils/FileDownloader.ts");function tf(){return tf=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},tf.apply(null,arguments)}var nf=function(e,t){return s.createElement("svg",tf({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0,ref:t},e),Xv||(Xv=s.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M19.5 11.51q.593 0 1.156-.105.143.827.144 1.695c0 5.468-4.432 9.9-9.9 9.9S1 18.568 1 13.1s4.432-9.9 9.9-9.9c.897 0 1.767.12 2.593.343a6 6 0 0 0-.27 1.795c0 3.409 2.81 6.171 6.277 6.171m-8.37 9.955a8.08 8.08 0 0 0 5.57-2.205 6.027 6.027 0 0 0-11.138 0 8.08 8.08 0 0 0 5.569 2.205m.15-13.647c-1.491.133-2.66 1.366-2.66 2.867 0 1.59 1.312 2.88 2.93 2.88 1.078 0 2.02-.572 2.528-1.425a7.2 7.2 0 0 1-2.798-4.322",clipRule:"evenodd"})),Qv||(Qv=s.createElement("path",{fill:"currentColor",d:"M18.503 1a.76.76 0 0 0-.753.745v4.05l.06 1.216-.498-.6-1.142-1.225a.66.66 0 0 0-.5-.222.654.654 0 0 0-.67.655c0 .196.079.342.215.48l2.72 2.64c.192.194.368.261.568.261.195 0 .369-.067.568-.26l2.72-2.642a.65.65 0 0 0 .209-.48.644.644 0 0 0-.663-.654.7.7 0 0 0-.507.222l-1.135 1.225-.506.6.06-1.216v-4.05c0-.4-.335-.745-.746-.745"})))},rf=(0,s.forwardRef)(nf);class sf extends s.Component{constructor(e){super(e),(0,h.A)(this,"downloader",new ef.s),(0,h.A)(this,"onExportButtonClick",(e=>{const t=new Blob([this.props.roomMembersIds.join()],{type:"plain/text"}),n=(0,P._t)("members_of_%(roomName)s.txt",{roomName:this.props.room.normalizedName});this.downloader.download({blob:t,name:n})}))}render(){var e;return"join"===(null===(e=this.props.room)||void 0===e?void 0:e.getMyMembership())&&!this.props.room.isSpaceRoom()&&this.props.roomMembersIds.length>0?s.createElement(Ae.A,{className:"tc_MemberList_export mx_AccessibleButton mx_AccessibleButton_hasKind mx_AccessibleButton_kind_primary_outline",onClick:this.onExportButtonClick,title:(0,P._t)("Download the list of all this room's members, in a text file. Useful for adding them all to another room.")},s.createElement(rf,{width:"1em",height:"1em"}),s.createElement("span",null,(0,P._t)("Export room members"))):null}}class of extends s.Component{constructor(e,t){var n;super(e,t),(0,h.A)(this,"showPresence",void 0),(0,h.A)(this,"unmounted",!1),(0,h.A)(this,"tiles",new Map),(0,h.A)(this,"onUserPresenceChange",((e,t)=>{this.tiles.get(t.userId)&&this.updateList()})),(0,h.A)(this,"onRoom",(e=>{e.roomId===this.props.roomId&&this.updateListNow(!0)})),(0,h.A)(this,"onMyMembership",((e,t,n)=>{e.roomId===this.props.roomId&&t===oa.O.Join&&n!==oa.O.Join&&this.updateListNow(!0)})),(0,h.A)(this,"onRoomStateUpdate",(e=>{e.roomId===this.props.roomId&&this.updateList()})),(0,h.A)(this,"onRoomMemberName",((e,t)=>{t.roomId===this.props.roomId&&this.updateList()})),(0,h.A)(this,"onRoomStateEvent",(e=>{e.getRoomId()===this.props.roomId&&e.getType()===i.EventType.RoomThirdPartyInvite&&this.updateList(),this.canInvite!==this.state.canInvite&&this.setState({canInvite:this.canInvite})})),(0,h.A)(this,"updateList",(0,v.throttle)((()=>{this.updateListNow(!1)}),500,{leading:!0,trailing:!0})),(0,h.A)(this,"createOverflowTileJoined",((e,t)=>this.createOverflowTile(e,t,this.showMoreJoinedMemberList))),(0,h.A)(this,"createOverflowTileInvited",((e,t)=>this.createOverflowTile(e,t,this.showMoreInvitedMemberList))),(0,h.A)(this,"createOverflowTile",((e,t,n)=>{const i=(0,P._t)("common|and_n_others",{count:e});return s.createElement(Jv.A,{className:"mx_EntityTile_ellipsis",avatarJsx:s.createElement(ja.A,{url:Hv.A,name:"...",size:"36px"}),name:i,showPresence:!1,onClick:n})})),(0,h.A)(this,"showMoreJoinedMemberList",(()=>{this.setState({truncateAtJoined:this.state.truncateAtJoined+100})})),(0,h.A)(this,"showMoreInvitedMemberList",(()=>{this.setState({truncateAtInvited:this.state.truncateAtInvited+100})})),(0,h.A)(this,"onSearchQueryChanged",(e=>{this.props.onSearchQueryChanged(e)})),(0,h.A)(this,"onPending3pidInviteClick",(e=>{w.A.dispatch({action:R.r.View3pidInvite,event:e})})),(0,h.A)(this,"getChildrenJoined",((e,t)=>this.makeMemberTiles(this.state.filteredJoinedMembers.slice(e,t)))),(0,h.A)(this,"getChildCountJoined",(()=>this.state.filteredJoinedMembers.length)),(0,h.A)(this,"getChildrenInvited",((e,t)=>{let n=this.state.filteredInvitedMembers;return t>this.state.filteredInvitedMembers.length&&(n=n.concat(this.getPending3PidInvites())),this.makeMemberTiles(n.slice(e,t))})),(0,h.A)(this,"getChildCountInvited",(()=>this.state.filteredInvitedMembers.length+(this.getPending3PidInvites()||[]).length)),(0,h.A)(this,"onInviteButtonClick",(e=>{y.A.trackInteraction("WebRightPanelMemberListInviteButton",e);Gh(E.J.safeGet().getRoom(this.props.roomId))})),this.state=this.getMembersState([],[]),this.showPresence=null===(n=null==t?void 0:t.memberListStore.isPresenceEnabled())||void 0===n||n}listenForMembersChanges(){const e=E.J.safeGet();e.on(i.RoomStateEvent.Update,this.onRoomStateUpdate),e.on(i.RoomMemberEvent.Name,this.onRoomMemberName),e.on(i.RoomStateEvent.Events,this.onRoomStateEvent),e.on(i.UserEvent.LastPresenceTs,this.onUserPresenceChange),e.on(i.UserEvent.Presence,this.onUserPresenceChange),e.on(i.UserEvent.CurrentlyActive,this.onUserPresenceChange),e.on(i.ClientEvent.Room,this.onRoom),e.on(i.RoomEvent.MyMembership,this.onMyMembership)}componentDidMount(){this.unmounted=!1,this.listenForMembersChanges(),this.updateListNow(!0)}componentWillUnmount(){this.unmounted=!0;const e=E.J.get();e&&(e.removeListener(i.RoomStateEvent.Update,this.onRoomStateUpdate),e.removeListener(i.RoomMemberEvent.Name,this.onRoomMemberName),e.removeListener(i.RoomEvent.MyMembership,this.onMyMembership),e.removeListener(i.RoomStateEvent.Events,this.onRoomStateEvent),e.removeListener(i.ClientEvent.Room,this.onRoom),e.removeListener(i.UserEvent.LastPresenceTs,this.onUserPresenceChange),e.removeListener(i.UserEvent.Presence,this.onUserPresenceChange),e.removeListener(i.UserEvent.CurrentlyActive,this.onUserPresenceChange)),this.updateList.cancel()}get canInvite(){const e=E.J.safeGet().getRoom(this.props.roomId);return!!e&&Hh(e)}getMembersState(e,t){return{loading:!1,filteredJoinedMembers:t,filteredInvitedMembers:e,canInvite:this.canInvite,truncateAtJoined:30,truncateAtInvited:5}}async updateListNow(e){if(this.unmounted)return;e&&this.setState({loading:!0});const{joined:t,invited:n}=await this.context.memberListStore.loadMemberList(this.props.roomId,this.props.searchQuery);this.unmounted||this.setState({loading:!1,filteredJoinedMembers:t,filteredInvitedMembers:n})}componentDidUpdate(e,t,n){e.searchQuery!==this.props.searchQuery&&this.updateListNow(!1)}getPending3PidInvites(){const e=E.J.safeGet().getRoom(this.props.roomId);return e?e.currentState.getStateEvents("m.room.third_party_invite").filter((function(t){if(!(0,C.Qo)(t))return!1;return!e.currentState.getInviteForThreePidToken(t.getStateKey())})):[]}makeMemberTiles(e){return e.map((e=>e instanceof i.RoomMember?s.createElement(Zv,{key:e.userId,member:e,ref:t=>{t?this.tiles.set(e.userId,t):this.tiles.delete(e.userId)},showPresence:this.showPresence}):s.createElement(Jv.A,{key:e.getStateKey(),name:e.getContent().display_name,showPresence:!1,onClick:()=>this.onPending3pidInviteClick(e)})))}render(){if(this.state.loading)return s.createElement(Ep.A,{id:"memberlist-panel",className:"mx_MemberList",ariaLabelledBy:"memberlist-panel-tab",role:"tabpanel",header:(0,P._t)("common|people"),onClose:this.props.onClose},s.createElement(Na.A,null));const e=E.J.safeGet().getRoom(this.props.roomId);let t,n,i;if((null==e?void 0:e.getMyMembership())===oa.O.Join&&(0,Ne.g)($.C.InviteUsers)){const n=e.isSpaceRoom()?(0,P._t)("space|invite_this_space"):(0,P._t)("room|invite_this_room"),i=s.createElement(Sl.$,{size:"sm",kind:"secondary",className:"mx_MemberList_invite",onClick:this.onInviteButtonClick,disabled:!this.state.canInvite},s.createElement(Wv,{width:"1em",height:"1em"}),n);t=this.state.canInvite?i:s.createElement(Te.m,{label:(0,P._t)("member_list|invite_button_no_perms_tooltip")},i)}this.getChildCountInvited()>0&&(n=s.createElement("h2",null,(0,P._t)("member_list|invited_list_heading")),i=s.createElement(Gv.A,{className:"mx_MemberList_section mx_MemberList_invited",truncateAt:this.state.truncateAtInvited,createOverflowElement:this.createOverflowTileInvited,getChildren:this.getChildrenInvited,getChildCount:this.getChildCountInvited}));const r=s.createElement(Kv.A,{className:"mx_MemberList_query mx_textinput_icon mx_textinput_search",placeholder:(0,P._t)("member_list|filter_placeholder"),onSearch:this.onSearchQueryChanged,initialValue:this.props.searchQuery});return s.createElement(Ep.A,{id:"memberlist-panel",className:"mx_MemberList",ariaLabelledBy:"memberlist-panel-tab",role:"tabpanel",header:(0,P._t)("common|people"),footer:r,onClose:this.props.onClose},t,s.createElement(sf,{room:e,roomMembersIds:this.state.filteredJoinedMembers.map((e=>e.userId))}),s.createElement("div",{className:"mx_MemberList_wrapper"},s.createElement(Gv.A,{className:"mx_MemberList_section mx_MemberList_joined",truncateAt:this.state.truncateAtJoined,createOverflowElement:this.createOverflowTileJoined,getChildren:this.getChildrenJoined,getChildCount:this.getChildCountJoined}),n,i))}}(0,h.A)(of,"contextType",Wa.A);var af=n("./src/components/views/right_panel/UserInfo.tsx");class lf extends s.Component{constructor(e){var t,n,r,s;super(e),(0,h.A)(this,"room",void 0),(0,h.A)(this,"onRoomStateEvents",(e=>{if(e.getType()===i.EventType.RoomThirdPartyInvite&&e.getStateKey()===this.state.stateKey){const t=e.getContent().display_name,n={invited:(0,C.Qo)(e)};t&&(n.displayName=t),this.setState(n)}})),(0,h.A)(this,"onCancel",(()=>{w.A.dispatch({action:R.r.View3pidInvite,event:null})})),(0,h.A)(this,"onKickClick",(()=>{E.J.safeGet().sendStateEvent(this.state.roomId,i.EventType.RoomThirdPartyInvite,{},this.state.stateKey).catch((e=>{o.v.error(e),this.setState({invited:!0}),A.Ay.createDialog(_v.A,{title:(0,P._t)("user_info|error_revoke_3pid_invite_title"),description:(0,P._t)("user_info|error_revoke_3pid_invite_description")})})),this.setState({invited:!1})})),this.room=E.J.safeGet().getRoom(this.props.event.getRoomId());const a=null===(t=this.room)||void 0===t?void 0:t.getMember(E.J.safeGet().getSafeUserId()),l=null===(n=this.room)||void 0===n?void 0:n.currentState.getStateEvents("m.room.power_levels",""),c=this.props.event.getSender();let d=l?l.getContent().kick:50;"number"!=typeof d&&(d=50);const u=null===(r=this.room)||void 0===r?void 0:r.getMember(c);this.state={stateKey:this.props.event.getStateKey(),roomId:this.props.event.getRoomId(),displayName:this.props.event.getContent().display_name,invited:!0,canKick:!!a&&a.powerLevel>d,senderName:null!==(s=null==u?void 0:u.name)&&void 0!==s?s:c}}componentDidMount(){E.J.safeGet().on(i.RoomStateEvent.Events,this.onRoomStateEvents)}componentWillUnmount(){const e=E.J.get();e&&e.removeListener(i.RoomStateEvent.Events,this.onRoomStateEvents)}render(){let e;return this.state.canKick&&this.state.invited&&(e=s.createElement(zh.s,{direction:"column",as:"section",justify:"start",gap:"var(--cpd-space-2x)"},s.createElement(Qa.E,{as:"span",role:"heading",size:"lg",weight:"semibold"},(0,P._t)("user_info|admin_tools_section")),s.createElement(Sl.$,{size:"sm",kind:"destructive",className:"mx_MemberInfo_field",onClick:this.onKickClick},(0,P._t)("user_info|revoke_invite")))),s.createElement(Ep.A,{onClose:this.props.onClose,header:(0,P._t)("common|profile")},s.createElement(zh.s,{className:"mx_ThirdPartyMemberInfo",direction:"column",gap:"var(--cpd-space-4x)"},s.createElement(zh.s,{direction:"column",as:"section",justify:"start",gap:"var(--cpd-space-2x)"},s.createElement(Qa.E,{as:"span",role:"heading",size:"lg",weight:"semibold"},this.state.displayName),s.createElement(Qa.E,{as:"span"},(0,P._t)("user_info|invited_by",{sender:this.state.senderName}))),e))}}var cf=n("./src/indexing/EventIndexPeg.ts");let df=function(e){return e[e.Files=0]="Files",e[e.Search=1]="Search",e}({});function uf({isRoomEncrypted:e,kind:t,showLogo:n=!0}){if(!e)return s.createElement(s.Fragment,null);if(cf.A.get())return s.createElement(s.Fragment,null);if(cf.A.error)return s.createElement("div",{className:"mx_SearchWarning"},(0,P._t)("seshat|error_initialising",{},{a:e=>s.createElement(Ae.A,{kind:"link_inline",onClick:e=>{e.preventDefault(),w.A.dispatch({action:R.r.ViewUserSettings,initialTabId:wa.v.Security})}},e)}));const i=u.Ay.get("brand"),r=u.Ay.getObject("desktop_builds");let a,l;if(null!=r&&r.get("available")){l=s.createElement("img",{alt:"",src:r.get("logo"),width:"32px"});const e=r.get("url");switch(t){case df.Files:a=(0,P._t)("seshat|warning_kind_files_app",{},{a:t=>s.createElement("a",{href:e,target:"_blank",rel:"noreferrer noopener"},t)});break;case df.Search:a=(0,P._t)("seshat|warning_kind_search_app",{},{a:t=>s.createElement("a",{href:e,target:"_blank",rel:"noreferrer noopener"},t)})}}else switch(t){case df.Files:a=(0,P._t)("seshat|warning_kind_files",{brand:i});break;case df.Search:a=(0,P._t)("seshat|warning_kind_search",{brand:i})}return a?s.createElement("div",{className:"mx_SearchWarning"},n?l:null,s.createElement("span",null,a)):(o.v.warn("Unknown desktop builds warning kind: ",t),s.createElement(s.Fragment,null))}var mf=n("./src/UserActivity.ts"),pf=n("./src/components/structures/LegacyCallEventGrouper.ts");const hf=(...e)=>{V.A.getValue("debug_timeline_panel")&&o.v.log.call(console,"TimelinePanel debuglog:",...e)},gf=(e,t)=>e.localTimestamp<t.localTimestamp,vf=(e,t)=>e.localTimestamp>=t.localTimestamp;class ff extends s.Component{constructor(e,t){if(super(e,t),(0,h.A)(this,"lastRRSentEventId",void 0),(0,h.A)(this,"lastRMSentEventId",void 0),(0,h.A)(this,"messagePanel",(0,s.createRef)()),(0,h.A)(this,"dispatcherRef",void 0),(0,h.A)(this,"timelineWindow",void 0),(0,h.A)(this,"overlayTimelineWindow",void 0),(0,h.A)(this,"unmounted",!1),(0,h.A)(this,"readReceiptActivityTimer",null),(0,h.A)(this,"readMarkerActivityTimer",null),(0,h.A)(this,"callEventGroupers",new Map),(0,h.A)(this,"initialReadMarkerId",null),(0,h.A)(this,"onDumpDebugLogs",(()=>{var e,t,n,r,s,a;const l=null===(e=this.props.timelineSet)||void 0===e?void 0:e.room,c=null===(t=this.state)||void 0===t||null===(t=t.events)||void 0===t?void 0:t.map((e=>e.getId()));let d,u,m;try{const e=this.messagePanelDiv;if(e){d=[...e.querySelectorAll("[data-event-id]")].map((e=>e.getAttribute("data-event-id")))}}catch(e){o.v.error("onDumpDebugLogs: Failed to get the actual event ID's in the DOM",e)}const p={};if(l){const e=l.getTimelineSets(),t=l.threadsTimelineSets;try{u=_f(e),m=_f(t)}catch(e){o.v.error("onDumpDebugLogs: Failed to serialize event IDs from timelinesets",e)}try{l.getThreads().forEach((e=>{var t,n;p[e.id]={events:e.events.map((e=>e.getId())),numTimelines:e.timelineSet.getTimelines().length,liveTimeline:e.timelineSet.getLiveTimeline().getEvents().length,prevTimeline:null===(t=e.timelineSet.getLiveTimeline().getNeighbouringTimeline(i.Direction.Backward))||void 0===t?void 0:t.getEvents().length,nextTimeline:null===(n=e.timelineSet.getLiveTimeline().getNeighbouringTimeline(i.Direction.Forward))||void 0===n?void 0:n.getEvents().length}}))}catch(e){o.v.error("onDumpDebugLogs: Failed to serialize event IDs from the threads",e)}}let h,g;try{var v;h=null===(v=this.timelineWindow)||void 0===v?void 0:v.getEvents().map((e=>e.getId()))}catch(e){o.v.error("onDumpDebugLogs: Failed to get event IDs from the timelineWindow",e)}try{g=this.props.timelineSet.getPendingEvents().map((e=>e.getId()))}catch(e){o.v.error("onDumpDebugLogs: Failed to get pending event IDs",e)}o.v.debug(`TimelinePanel(${this.context.timelineRenderingType}): Debugging info for ${null==l?void 0:l.roomId}\n\tevents(${c.length})=${JSON.stringify(c)}\n\trenderedEventIds(${null!==(n=null===(r=d)||void 0===r?void 0:r.length)&&void 0!==n?n:0})=${JSON.stringify(d)}\n\tserializedEventIdsFromTimelineSets=${JSON.stringify(u)}\n\tserializedEventIdsFromThreadsTimelineSets=${JSON.stringify(m)}\n\tserializedThreadsMap=${JSON.stringify(p)}\n\ttimelineWindowEventIds(${null===(s=h)||void 0===s?void 0:s.length})=${JSON.stringify(h)}\n\tpendingEventIds(${null===(a=g)||void 0===a?void 0:a.length})=${JSON.stringify(g)}`)})),(0,h.A)(this,"onMessageListUnfillRequest",((e,t)=>{var n,r;const s=e?i.EventTimeline.BACKWARDS:i.EventTimeline.FORWARDS;hf("unpaginating events in direction",s);const o=t,a=this.timelineWindow.getEvents(),l=null!==(n=null===(r=this.overlayTimelineWindow)||void 0===r?void 0:r.getEvents())&&void 0!==n?n:[];let c,d,u,m=a.findIndex((e=>e.getId()===o));-1===m?(c=l.findIndex((e=>e.getId()===o)),m=e?(0,v.findLastIndex)(a,(e=>vf(l[c],e))):a.findIndex((e=>gf(l[c],e)))):c=e?(0,v.findLastIndex)(l,(e=>gf(e,a[m]))):l.findIndex((e=>vf(e,a[m]))),d=-1===m?0:e?m+1:a.length-m,u=-1===c?0:e?c+1:l.length-c,d>0&&(hf("Unpaginating",d,"in direction",s),this.timelineWindow.unpaginate(d,e)),u>0&&(hf("Unpaginating",d,"from overlay timeline in direction",s),this.overlayTimelineWindow.unpaginate(u,e));const{events:p,liveEvents:h}=this.getEvents();this.buildLegacyCallEventGroupers(p),this.setState({events:p,liveEvents:h}),e?this.setState({canBackPaginate:!0}):this.setState({canForwardPaginate:!0})})),(0,h.A)(this,"onPaginationRequest",((e,t,n)=>this.props.onPaginationRequest?this.props.onPaginationRequest(e,t,n):e.paginate(t,n))),(0,h.A)(this,"onMessageListFillRequest",(e=>{var t;if(!this.shouldPaginate())return Promise.resolve(!1);const n=e?i.EventTimeline.BACKWARDS:i.EventTimeline.FORWARDS,r=e?"canBackPaginate":"canForwardPaginate",s=e?"backPaginating":"forwardPaginating";return this.state[r]?null!==(t=this.timelineWindow)&&void 0!==t&&t.canPaginate(n)?(hf("Initiating paginate; backwards:"+e),this.setState({[s]:!0}),this.onPaginationRequest(this.timelineWindow,n,50).then((async t=>{var n;if(this.unmounted)return!1;this.overlayTimelineWindow&&await this.extendOverlayWindowToCoverMainWindow(),hf("paginate complete backwards:"+e+"; success:"+t);const{events:o,liveEvents:a}=this.getEvents();this.buildLegacyCallEventGroupers(o);const l={[s]:!1,[r]:t,events:o,liveEvents:a},c=e?i.EventTimeline.FORWARDS:i.EventTimeline.BACKWARDS,d=e?"canForwardPaginate":"canBackPaginate";return!this.state[d]&&null!==(n=this.timelineWindow)&&void 0!==n&&n.canPaginate(c)&&(hf("can now",c,"paginate again"),l[d]=!0),new Promise((e=>{this.setState(l,(()=>{e(t)}))}))}))):(hf("can't",n,"paginate any further"),this.setState({[r]:!1}),Promise.resolve(!1)):(hf("have given up",n,"paginating this timeline"),Promise.resolve(!1))})),(0,h.A)(this,"onMessageListScroll",(e=>{var t,n;null===(t=(n=this.props).onScroll)||void 0===t||t.call(n,e),this.props.manageReadMarkers&&this.doManageReadMarkers()})),(0,h.A)(this,"doManageReadMarkers",(0,v.debounce)((()=>{var e;const t=this.getReadMarkerPosition();if(null===t)return;t<0&&this.setState({readMarkerVisible:!0});const n=this.readMarkerTimeout(t);null===(e=this.readMarkerActivityTimer)||void 0===e||e.changeTimeout(n)}),100,{leading:!1,trailing:!0})),(0,h.A)(this,"onAction",(e=>{switch(e.action){case"ignore_state_changed":this.forceUpdate();break;case R.r.DumpDebugLogs:this.onDumpDebugLogs()}})),(0,h.A)(this,"onRoomTimeline",((e,t,n,r,s)=>{var o,a;s.timeline.getTimelineSet()!==this.props.timelineSet&&s.timeline.getTimelineSet()!==this.props.overlayTimelineSet||(i.Thread.hasServerSideSupport||this.context.timelineRenderingType!==Sp.Ae.Thread||(n&&!this.state.canBackPaginate&&this.setState({canBackPaginate:!0}),n||this.state.canForwardPaginate||this.setState({canForwardPaginate:!0})),!n&&s&&s.liveEvent&&null!==(o=this.messagePanel.current)&&void 0!==o&&o.getScrollState()&&(null!==(a=this.messagePanel.current.getScrollState())&&void 0!==a&&a.stuckAtBottom?this.timelineWindow.paginate(i.EventTimeline.FORWARDS,1,!1).then((()=>{if(this.overlayTimelineWindow)return this.overlayTimelineWindow.paginate(i.EventTimeline.FORWARDS,1,!1)})).then((()=>{if(this.unmounted)return;const{events:t,liveEvents:n}=this.getEvents();this.buildLegacyCallEventGroupers(t);const i=n[n.length-1],r={events:t,liveEvents:n};let s=!1;if(this.props.manageReadMarkers){const t=E.J.safeGet().credentials.userId;if(s=!1,e.getSender()===t||mf.A.sharedInstance().userActiveRecently()){if(i&&0===this.getReadMarkerPosition()){var o;this.setReadMarker(null!==(o=i.getId())&&void 0!==o?o:null,i.getTs(),!0),r.readMarkerVisible=!1,r.readMarkerEventId=i.getId(),s=!0}}else r.readMarkerVisible=!0}this.setState(r,(()=>{var e,t,n;(null===(e=this.messagePanel.current)||void 0===e||e.updateTimelineMinHeight(),s)&&(null===(t=(n=this.props).onReadMarkerUpdated)||void 0===t||t.call(n))}))})):this.setState({canForwardPaginate:!0})))})),(0,h.A)(this,"onRoomTimelineReset",((e,t)=>{t!==this.props.timelineSet&&t!==this.props.overlayTimelineSet||this.canResetTimeline()&&this.loadTimeline()})),(0,h.A)(this,"canResetTimeline",(()=>{var e;return!0===(null===(e=this.messagePanel)||void 0===e||null===(e=e.current)||void 0===e?void 0:e.isAtBottom())})),(0,h.A)(this,"onRoomRedaction",((e,t)=>{this.unmounted||this.hasTimelineSetFor(t.roomId)&&this.forceUpdate()})),(0,h.A)(this,"onThreadUpdate",(e=>{var t;if(this.unmounted)return;if(!this.hasTimelineSetFor(e.roomId))return;const n=null===(t=this.messagePanel.current)||void 0===t?void 0:t.getTileForEventId(e.id);n&&n.forceUpdate()})),(0,h.A)(this,"onEventVisibilityChange",(e=>{var t;if(this.unmounted)return;if(!this.hasTimelineSetFor(e.getRoomId()))return;const n=null===(t=this.messagePanel.current)||void 0===t?void 0:t.getTileForEventId(e.getId());n&&n.forceUpdate()})),(0,h.A)(this,"onVisibilityPowerLevelChange",((e,t)=>{var n;if(!this.unmounted&&this.hasTimelineSetFor(t.roomId)&&t.userId==(null===(n=E.J.safeGet().credentials)||void 0===n?void 0:n.userId)){for(const e of this.state.events){var i;const t=null===(i=this.messagePanel.current)||void 0===i?void 0:i.getTileForEventId(e.getId());t&&t.forceUpdate()}this.forceUpdate()}})),(0,h.A)(this,"onEventReplaced",(e=>{this.unmounted||this.hasTimelineSetFor(e.getRoomId())&&this.forceUpdate()})),(0,h.A)(this,"onRoomReceipt",((e,t)=>{this.unmounted||t===this.props.timelineSet.room&&this.forceUpdate()})),(0,h.A)(this,"onLocalEchoUpdated",((e,t,n)=>{this.unmounted||this.hasTimelineSetFor(t.roomId)&&this.reloadEvents()})),(0,h.A)(this,"onAccountData",((e,t)=>{this.unmounted||t===this.props.timelineSet.room&&e.getType()===i.EventType.FullyRead&&this.setState({readMarkerEventId:e.getContent().event_id},this.props.onReadMarkerUpdated)})),(0,h.A)(this,"onEventDecrypted",(e=>{this.props.timelineSet.room&&this.hasTimelineSetFor(e.getRoomId())&&this.state.events.includes(e)&&(this.buildLegacyCallEventGroupers(this.state.events),this.forceUpdate())})),(0,h.A)(this,"onSync",((e,t,n)=>{this.unmounted||this.setState({clientSyncState:e})})),(0,h.A)(this,"sendReadReceipts",(async()=>{var e,t;if(V.A.getValue("lowBandwidth"))return;if(!this.messagePanel.current)return;if(!this.props.manageReadReceipts)return;const n=E.J.get();if(!n||n.isGuest())return;const i=this.getCurrentReadReceipt(!0),r=this.indexForEventId(i),s=this.getLastDisplayedEventIndex({ignoreOwn:!0}),o=null!==(e=this.state.events[null!=s?s:this.state.events.length-1])&&void 0!==e?e:null,a=this.shouldSendReadReceipt(i,r,o,s),l=this.state.readMarkerEventId,c=this.shouldSendFullyReadMarker(l),d=null===(t=this.props.timelineSet.room)||void 0===t?void 0:t.roomId;hf(`Sending Read Markers for ${d}: `,{shouldSendReadReceipt:a,shouldSendFullyReadMarker:c,currentReadReceiptEventId:i,currentReadReceiptEventIndex:r,lastReadEventId:null==o?void 0:o.getId(),lastReadEventIndex:s,readMarkerEventId:this.state.readMarkerEventId});const u=[];if(a&&u.push(this.sendReadReceipt(n,o)),c){this.props.timelineSet.findEventById(l)&&u.push(this.sendFullyReadMarker(n,null!=d?d:"",l))}await Promise.all(u)})),(0,h.A)(this,"updateReadMarker",(async()=>{if(!this.props.manageReadMarkers)return;if(1===this.getReadMarkerPosition())return;const e=this.getLastDisplayedEventIndex({allowPartial:!0});if(null===e)return;const t=this.state.events[e];await this.setReadMarker(t.getId(),t.getTs()),this.state.readMarkerVisible&&this.setState({readMarkerVisible:!1}),await this.sendReadReceipts()})),(0,h.A)(this,"jumpToLiveTimeline",(()=>{var e,t;null!==(e=this.timelineWindow)&&void 0!==e&&e.canPaginate(i.EventTimeline.FORWARDS)?this.loadTimeline():null===(t=this.messagePanel.current)||void 0===t||t.scrollToBottom()})),(0,h.A)(this,"scrollToEventIfNeeded",(e=>{var t;null===(t=this.messagePanel.current)||void 0===t||t.scrollToEventIfNeeded(e)})),(0,h.A)(this,"jumpToReadMarker",(()=>{if(!this.props.manageReadMarkers)return;if(!this.messagePanel.current)return;if(!this.state.readMarkerEventId)return;null===this.messagePanel.current.getReadMarkerPosition()?this.loadTimeline(this.state.readMarkerEventId,0,1/3):this.messagePanel.current.scrollToEvent(this.state.readMarkerEventId,0,1/3)})),(0,h.A)(this,"forgetReadMarker",(async()=>{if(!this.props.manageReadMarkers)return;const e=this.getCurrentReadReceipt(),t=this.props.timelineSet.getTimelineForEvent(null!=e?e:"");let n;if(t){const i=t.getEvents().find((t=>t.getId()==e));i&&(n=i.getTs())}await this.setReadMarker(e,n),await this.sendReadReceipts()})),(0,h.A)(this,"isAtEndOfLiveTimeline",(()=>{var e;return(null===(e=this.messagePanel.current)||void 0===e?void 0:e.isAtBottom())&&this.timelineWindow&&!this.timelineWindow.canPaginate(i.EventTimeline.FORWARDS)})),(0,h.A)(this,"getScrollState",(()=>this.messagePanel.current?this.messagePanel.current.getScrollState():null)),(0,h.A)(this,"getReadMarkerPosition",(()=>{if(!this.props.manageReadMarkers)return null;if(!this.messagePanel.current)return null;if(!this.props.timelineSet.room)return null;const e=this.messagePanel.current.getReadMarkerPosition();if(null!==e)return e;const t=ff.roomReadMarkerTsMap[this.props.timelineSet.room.roomId];return t&&this.state.events.length>0?t<this.state.events[0].getTs()?-1:1:null})),(0,h.A)(this,"canJumpToReadMarker",(()=>{const e=this.getReadMarkerPosition();return null!==this.state.readMarkerEventId&&(null===e||e<0)})),(0,h.A)(this,"handleScrollKey",(e=>{if(!this.messagePanel.current)return;(0,Re.zM)().getRoomAction(e)===Se.bY.JumpToLatestMessage?this.jumpToLiveTimeline():this.messagePanel.current.handleScrollKey(e)})),(0,h.A)(this,"getRelationsForEvent",((e,t,n)=>{var i;return null===(i=this.props.timelineSet.relations)||void 0===i?void 0:i.getChildEventsForEvent(e,t,n)})),hf("mounting"),this.props.manageReadMarkers){var n;const e=null===(n=this.props.timelineSet.room)||void 0===n?void 0:n.getAccountData("m.fully_read");this.initialReadMarkerId=e?e.getContent().event_id:this.getCurrentReadReceipt()}this.state={events:[],liveEvents:[],timelineLoading:!0,canBackPaginate:!1,canForwardPaginate:!1,readMarkerVisible:!0,readMarkerEventId:this.initialReadMarkerId,backPaginating:!1,forwardPaginating:!1,clientSyncState:E.J.safeGet().getSyncState(),isTwelveHour:V.A.getValue("showTwelveHourTimestamps"),alwaysShowTimestamps:V.A.getValue("alwaysShowTimestamps"),readMarkerInViewThresholdMs:V.A.getValue("readMarkerInViewThresholdMs"),readMarkerOutOfViewThresholdMs:V.A.getValue("readMarkerOutOfViewThresholdMs")}}componentDidMount(){var e;this.unmounted=!1,this.dispatcherRef=w.A.register(this.onAction);const t=E.J.safeGet();t.on(i.RoomEvent.Timeline,this.onRoomTimeline),t.on(i.RoomEvent.TimelineReset,this.onRoomTimelineReset),t.on(i.RoomEvent.Redaction,this.onRoomRedaction),V.A.getValue("feature_msc3531_hide_messages_pending_moderation")&&(t.on(i.MatrixEventEvent.VisibilityChange,this.onEventVisibilityChange),t.on(i.RoomMemberEvent.PowerLevel,this.onVisibilityPowerLevelChange)),t.on(i.RoomEvent.RedactionCancelled,this.onRoomRedaction),t.on(i.RoomEvent.Receipt,this.onRoomReceipt),t.on(i.RoomEvent.LocalEchoUpdated,this.onLocalEchoUpdated),t.on(i.RoomEvent.AccountData,this.onAccountData),t.on(i.MatrixEventEvent.Decrypted,this.onEventDecrypted),t.on(i.MatrixEventEvent.Replaced,this.onEventReplaced),t.on(i.ClientEvent.Sync,this.onSync),null===(e=this.props.timelineSet.room)||void 0===e||e.on(i.ThreadEvent.Update,this.onThreadUpdate),this.props.manageReadReceipts&&this.updateReadReceiptOnUserActivity(),this.props.manageReadMarkers&&this.updateReadMarkerOnUserActivity(),this.initTimeline(this.props)}componentDidUpdate(e){var t,n;e.timelineSet!==this.props.timelineSet&&o.v.warn("Replacing timelineSet on a TimelinePanel - confusion may ensue"),null===(t=this.props.timelineSet.room)||void 0===t||t.off(i.ThreadEvent.Update,this.onThreadUpdate),null===(n=this.props.timelineSet.room)||void 0===n||n.on(i.ThreadEvent.Update,this.onThreadUpdate);const r=e.eventId!=this.props.eventId,s=e.highlightedEventId!=this.props.highlightedEventId,a=e.eventScrollIntoView&&!this.props.eventScrollIntoView,l=e.overlayTimelineSet!==this.props.overlayTimelineSet;r||s||a?(o.v.log(`TimelinePanel switching to eventId ${this.props.eventId} (was ${e.eventId}), scrollIntoView: ${this.props.eventScrollIntoView} (was ${e.eventScrollIntoView})`),this.initTimeline(this.props)):l&&(o.v.log("TimelinePanel updating overlay timeline."),this.initTimeline(this.props))}componentWillUnmount(){this.unmounted=!0,this.readReceiptActivityTimer&&(this.readReceiptActivityTimer.abort(),this.readReceiptActivityTimer=null),this.readMarkerActivityTimer&&(this.readMarkerActivityTimer.abort(),this.readMarkerActivityTimer=null),w.A.unregister(this.dispatcherRef);const e=E.J.get();var t;e&&(e.removeListener(i.RoomEvent.Timeline,this.onRoomTimeline),e.removeListener(i.RoomEvent.TimelineReset,this.onRoomTimelineReset),e.removeListener(i.RoomEvent.Redaction,this.onRoomRedaction),e.removeListener(i.RoomEvent.RedactionCancelled,this.onRoomRedaction),e.removeListener(i.RoomEvent.Receipt,this.onRoomReceipt),e.removeListener(i.RoomEvent.LocalEchoUpdated,this.onLocalEchoUpdated),e.removeListener(i.RoomEvent.AccountData,this.onAccountData),e.removeListener(i.RoomMemberEvent.PowerLevel,this.onVisibilityPowerLevelChange),e.removeListener(i.MatrixEventEvent.Decrypted,this.onEventDecrypted),e.removeListener(i.MatrixEventEvent.Replaced,this.onEventReplaced),e.removeListener(i.MatrixEventEvent.VisibilityChange,this.onEventVisibilityChange),e.removeListener(i.ClientEvent.Sync,this.onSync),null===(t=this.props.timelineSet.room)||void 0===t||t.removeListener(i.ThreadEvent.Update,this.onThreadUpdate))}get messagePanelDiv(){var e,t;return null!==(e=null===(t=this.messagePanel.current)||void 0===t||null===(t=t.scrollPanel.current)||void 0===t?void 0:t.divScroll)&&void 0!==e?e:null}hasTimelineSetFor(e){var t,n;return void 0!==e&&e===(null===(t=this.props.timelineSet.room)||void 0===t?void 0:t.roomId)||e===(null===(n=this.props.overlayTimelineSet)||void 0===n||null===(n=n.room)||void 0===n?void 0:n.roomId)}readMarkerTimeout(e){var t,n,i,r;return 0===e?null!==(t=null===(n=this.context)||void 0===n?void 0:n.readMarkerInViewThresholdMs)&&void 0!==t?t:this.state.readMarkerInViewThresholdMs:null!==(i=null===(r=this.context)||void 0===r?void 0:r.readMarkerOutOfViewThresholdMs)&&void 0!==i?i:this.state.readMarkerOutOfViewThresholdMs}async updateReadMarkerOnUserActivity(){const e=this.readMarkerTimeout(this.getReadMarkerPosition());for(this.readMarkerActivityTimer=new qp.A(e);this.readMarkerActivityTimer;){mf.A.sharedInstance().timeWhileActiveRecently(this.readMarkerActivityTimer);try{await this.readMarkerActivityTimer.finished()}catch{continue}await this.updateReadMarker()}}async updateReadReceiptOnUserActivity(){for(this.readReceiptActivityTimer=new qp.A(500);this.readReceiptActivityTimer;){mf.A.sharedInstance().timeWhileActiveNow(this.readReceiptActivityTimer);try{await this.readReceiptActivityTimer.finished()}catch{continue}await this.sendReadReceipts()}}async determineReceiptType(e){var t,n;const r=null!==(t=null===(n=this.props.timelineSet.room)||void 0===n?void 0:n.roomId)&&void 0!==t?t:null;return V.A.getValue("sendReadReceipts",r)?i.ReceiptType.Read:await e.doesServerSupportUnstableFeature("org.matrix.msc2285.stable")||await e.isVersionSupported("v1.4")?i.ReceiptType.ReadPrivate:(o.v.warn("Falling back to public instead of private receipts because the homeserver does not support them"),i.ReceiptType.Read)}shouldSendFullyReadMarker(e){return!!this.state.readMarkerEventId&&((!this.lastRMSentEventId||this.lastRMSentEventId!==this.state.readMarkerEventId)&&((!this.state.readMarkerEventId||this.state.readMarkerEventId!==this.initialReadMarkerId)&&!this.props.timelineSet.thread))}shouldSendReadReceipt(e,t,n,r){var s;return!!n&&((!e||null!==t||null===(s=this.timelineWindow)||void 0===s||!s.canPaginate(i.EventTimeline.FORWARDS))&&((null===r||null===t||r>t)&&(!this.lastRRSentEventId||this.lastRRSentEventId!==(null==n?void 0:n.getId()))))}async sendReadReceipt(e,t){this.lastRRSentEventId=t.getId();const n=await this.determineReceiptType(e);try{await e.sendReadReceipt(t,n)}catch(e){var i;this.lastRRSentEventId=void 0,o.v.error("Error sending receipt",{room:null===(i=this.props.timelineSet.room)||void 0===i?void 0:i.roomId,error:e})}}async sendFullyReadMarker(e,t,n){this.lastRMSentEventId=this.state.readMarkerEventId;try{await e.setRoomReadMarkers(t,n)}catch(e){this.lastRMSentEventId=void 0,o.v.error("Error sending fully_read",{roomId:t,error:e})}}advanceReadMarkerPastMyEvents(){if(!this.props.manageReadMarkers||!this.timelineWindow)return;const e=this.timelineWindow.getEvents();let t;for(t=0;t<e.length&&e[t].getId()!=this.state.readMarkerEventId;t++);if(t>=e.length)return;const n=E.J.safeGet().credentials.userId;for(t++;t<e.length;t++){if(e[t].getSender()!==n)break}t--;const i=e[t];this.setReadMarker(i.getId(),i.getTs())}initTimeline(e){const t=e.eventId,n=e.eventPixelOffset;let i=1;return null==n&&(i=.5),this.loadTimeline(t,n,i,e.eventScrollIntoView)}scrollIntoView(e,t,n){var i,r;const s=()=>{this.messagePanel.current&&(e?(hf("TimelinePanel scrolling to eventId "+e+" at position "+100*n+"% + "+t),this.messagePanel.current.scrollToEvent(e,t,n)):(hf("TimelinePanel scrolling to bottom"),this.messagePanel.current.scrollToBottom()))};hf("TimelinePanel scheduling scroll to event"),null===(i=(r=this.props).onEventScrolledIntoView)||void 0===i||i.call(r,e),s(),window.requestAnimationFrame((()=>{s()}))}async extendOverlayWindowToCoverMainWindow(){const e=this.timelineWindow,t=this.overlayTimelineWindow,n=e.getEvents();if(n.length>0){let r;do{r=[];const s=t.getEvents();!t.canPaginate(i.EventTimeline.BACKWARDS)||0!==s.length&&!vf(s[0],n[0])&&e.canPaginate(i.EventTimeline.BACKWARDS)||r.push(this.onPaginationRequest(t,i.EventTimeline.BACKWARDS,50)),!t.canPaginate(i.EventTimeline.FORWARDS)||0!==s.length&&!gf(s.at(-1),n.at(-1))&&e.canPaginate(i.EventTimeline.FORWARDS)||r.push(this.onPaginationRequest(t,i.EventTimeline.FORWARDS,50)),await Promise.all(r)}while(r.length>0)}}loadTimeline(e,t,n,r=!0){const s=E.J.safeGet();this.timelineWindow=new i.TimelineWindow(s,this.props.timelineSet,{windowLimit:this.props.timelineCap}),this.overlayTimelineWindow=this.props.overlayTimelineSet?new i.TimelineWindow(s,this.props.overlayTimelineSet,{windowLimit:this.props.timelineCap}):void 0;const a=()=>{var s,a,l,c,d,u,m;this.unmounted||(null===(s=this.messagePanel.current)||void 0===s||s.onTimelineReset(),this.reloadEvents(),this.advanceReadMarkerPastMyEvents(),this.setState({canBackPaginate:null!==(a=(null===(l=this.timelineWindow)||void 0===l?void 0:l.canPaginate(i.EventTimeline.BACKWARDS))||(null===(c=this.overlayTimelineWindow)||void 0===c?void 0:c.canPaginate(i.EventTimeline.BACKWARDS)))&&void 0!==a&&a,canForwardPaginate:null!==(d=(null===(u=this.timelineWindow)||void 0===u?void 0:u.canPaginate(i.EventTimeline.FORWARDS))||(null===(m=this.overlayTimelineWindow)||void 0===m?void 0:m.canPaginate(i.EventTimeline.FORWARDS)))&&void 0!==d&&d,timelineLoading:!1},(()=>{this.messagePanel.current?(r&&this.scrollIntoView(e,t,n),this.props.sendReadReceiptOnLoad&&this.sendReadReceipts().catch((e=>{o.v.warn("Error sending receipts on load",e)}))):o.v.log("can't initialise scroll state because messagePanel didn't load")})))};if(this.props.timelineSet.getTimelineForEvent(e)&&!this.overlayTimelineWindow)return this.timelineWindow.load(e,30),void a();const l=this.timelineWindow.load(e,30).then((async()=>{this.overlayTimelineWindow&&(await this.overlayTimelineWindow.load(void 0,30),await this.extendOverlayWindowToCoverMainWindow())}));this.buildLegacyCallEventGroupers(),this.setState({events:[],liveEvents:[],canBackPaginate:!1,canForwardPaginate:!1,timelineLoading:!0}),l.then(a,(t=>{var n;if(this.unmounted)return;let i,r;this.setState({timelineLoading:!1}),o.v.error(`Error loading timeline panel at ${null===(n=this.props.timelineSet.room)||void 0===n?void 0:n.roomId}/${e}`,t),e&&this.props.timelineSet.room&&(i=()=>{w.A.dispatch({action:R.r.ViewRoom,room_id:this.props.timelineSet.room.roomId,metricsTrigger:void 0})}),r="M_FORBIDDEN"==t.errcode?(0,P._t)("timeline|load_error|no_permission"):(0,P._t)("timeline|load_error|unable_to_find"),A.Ay.createDialog(_v.A,{title:(0,P._t)("timeline|load_error|title"),description:r,onFinished:i})}))}reloadEvents(){if(this.unmounted)return;const e=this.getEvents();this.buildLegacyCallEventGroupers(e.events),this.setState(e)}refreshTimeline(e){this.loadTimeline(e,void 0,void 0,!1),this.reloadEvents()}getEvents(){var e,t;const n=this.timelineWindow.getEvents();let r=null!==(e=null===(t=this.overlayTimelineWindow)||void 0===t?void 0:t.getEvents())&&void 0!==e?e:[];void 0!==this.props.overlayTimelineSetFilter&&(r=r.filter(this.props.overlayTimelineSetFilter));const s=r.reduce(((e,t)=>{const n=e.findIndex((e=>gf(t,e)));return-1===n?this.timelineWindow.canPaginate(i.EventTimeline.FORWARDS)||e.push(t):0===n?this.timelineWindow.canPaginate(i.EventTimeline.BACKWARDS)||e.unshift(t):e.splice(n,0,t),e}),[...n]),o=E.J.safeGet();for(let e=s.length-1;e>=0;--e)o.decryptEventIfNeeded(s[e]);const a=[...s];if(!this.timelineWindow.canPaginate(i.EventTimeline.FORWARDS)){const e=this.props.timelineSet.getPendingEvents();s.push(...e.filter((t=>{const{shouldLiveInRoom:n,threadId:i}=this.props.timelineSet.room.eventShouldLiveIn(t,e);return this.context.timelineRenderingType===Sp.Ae.Thread?i===this.context.threadId:n})))}return{events:s,liveEvents:a}}indexForEventId(e){if(null===e)return null;if(this.context.timelineRenderingType===Sp.Ae.Thread)return 0;const t=this.state.events.findIndex((t=>t.getId()===e));return t>-1?t:null}getLastDisplayedEventIndex(e={}){const t=e.ignoreOwn||!1,n=e.allowPartial||!1,i=this.messagePanel.current;if(!i)return null;const r=this.messagePanelDiv;if(!r)return null;const s=r.getBoundingClientRect(),o=E.J.safeGet().credentials.userId,a=e=>{if(e){const t=e.getBoundingClientRect();if(n&&t.top<=s.bottom||!n&&t.bottom<=s.bottom)return!0}return!1};let l=0;for(let e=this.state.liveEvents.length-1;e>=0;--e){var c;const n=this.state.liveEvents[e],r=i.getNodeForEventId(n.getId()),s=a(r);if(s&&0!==l)return e+l;r&&!s&&(l=0);const d=!!n.status||t&&n.getSender()===o;if(!(!(0,nh.bN)(n,E.J.safeGet(),null===(c=this.context)||void 0===c?void 0:c.showHiddenEvents)||(0,cu.A)(n,this.context))&&r){if(!d&&s)return e}else(!d||d&&0!==l)&&++l}return null}getCurrentReadReceipt(e=!1){var t,n;const i=E.J.get();if(null==i)return null;const r=i.getSafeUserId(),s=null!==(t=this.props.timelineSet.thread)&&void 0!==t?t:this.props.timelineSet.room;return null!==(n=null==s?void 0:s.getEventReadUpTo(r,e))&&void 0!==n?n:null}async setReadMarker(e,t,n=!1){var i;const r=null===(i=this.props.timelineSet.room)||void 0===i?void 0:i.roomId;e!==this.state.readMarkerEventId&&null!==e&&(void 0!==t?ff.roomReadMarkerTsMap[null!=r?r:""]=t:delete ff.roomReadMarkerTsMap[null!=r?r:""],n||await new Promise((t=>{this.setState({readMarkerEventId:e},(()=>{var e,n;null===(e=(n=this.props).onReadMarkerUpdated)||void 0===e||e.call(n),t()}))})))}shouldPaginate(){return!this.state.events.some((e=>e.isBeingDecrypted()))}buildLegacyCallEventGroupers(e){this.callEventGroupers=(0,pf.fN)(this.callEventGroupers,e)}render(){var e,t,n,r,o,a;if(this.state.timelineLoading)return s.createElement("div",{className:"mx_RoomView_messagePanelSpinner"},s.createElement(Na.A,null));if(0==this.state.events.length&&!this.state.canBackPaginate&&this.props.empty)return s.createElement("div",{className:this.props.className+" mx_RoomView_messageListWrapper"},s.createElement("div",{className:"mx_RoomView_empty"},this.props.empty));const l=!(null!==(e=this.timelineWindow)&&void 0!==e&&e.canPaginate(i.EventTimeline.FORWARDS)),c=this.state.forwardPaginating||["PREPARED","CATCHUP"].includes(this.state.clientSyncState),d=this.state.events;return s.createElement(xh,{ref:this.messagePanel,room:this.props.timelineSet.room,permalinkCreator:this.props.permalinkCreator,hidden:this.props.hidden,backPaginating:this.state.backPaginating,forwardPaginating:c,events:d,highlightedEventId:this.props.highlightedEventId,readMarkerEventId:this.state.readMarkerEventId,readMarkerVisible:this.state.readMarkerVisible,canBackPaginate:this.state.canBackPaginate,showUrlPreview:this.props.showUrlPreview,showReadReceipts:this.props.showReadReceipts,ourUserId:E.J.safeGet().getSafeUserId(),stickyBottom:l,onScroll:this.onMessageListScroll,onFillRequest:this.onMessageListFillRequest,onUnfillRequest:this.onMessageListUnfillRequest,isTwelveHour:null!==(t=null===(n=this.context)||void 0===n?void 0:n.showTwelveHourTimestamps)&&void 0!==t?t:this.state.isTwelveHour,alwaysShowTimestamps:null!==(r=null!==(o=this.props.alwaysShowTimestamps)&&void 0!==o?o:null===(a=this.context)||void 0===a?void 0:a.alwaysShowTimestamps)&&void 0!==r?r:this.state.alwaysShowTimestamps,className:this.props.className,resizeNotifier:this.props.resizeNotifier,getRelationsForEvent:this.getRelationsForEvent,editState:this.props.editState,showReactions:this.props.showReactions,layout:this.props.layout,hideThreadedMessages:this.props.hideThreadedMessages,disableGrouping:this.props.disableGrouping,callEventGroupers:this.callEventGroupers})}}function _f(e){return e.map((e=>{const t={},n=e.getTimelines(),i=e.getLiveTimeline();return n.forEach(((e,n)=>{t[e===i?"liveTimeline":`${n}`]=e.getEvents().map((e=>e.getId()))})),t}))}(0,h.A)(ff,"contextType",Sp.Ay),(0,h.A)(ff,"roomReadMarkerTsMap",{}),(0,h.A)(ff,"defaultProps",{timelineCap:Number.MAX_VALUE,className:"mx_RoomView_messagePanel",sendReadReceiptOnLoad:!0,hideThreadedMessages:!0,disableGrouping:!1});const yf=ff;class bf extends s.PureComponent{constructor(e){super(e),(0,h.A)(this,"instanceId",void 0),(0,h.A)(this,"onResize",((e,t)=>{e===Ie.x.Resize&&this.props.onMeasurement(t.contentRect.width<=this.props.breakpoint)})),this.instanceId=bf.instanceCount++}componentDidMount(){Ie.A.instance.on(`Measured${this.instanceId}`,this.onResize)}componentDidUpdate(e){const t=e.sensor,n=this.props.sensor;t!==n&&(t&&Ie.A.instance.stopTrackingElementDimensions(`Measured${this.instanceId}`),n&&Ie.A.instance.trackElementDimensions(`Measured${this.instanceId}`,this.props.sensor))}componentWillUnmount(){Ie.A.instance.off(`Measured${this.instanceId}`,this.onResize),Ie.A.instance.stopTrackingElementDimensions(`Measured${this.instanceId}`)}render(){return null}}(0,h.A)(bf,"instanceCount",0),(0,h.A)(bf,"defaultProps",{breakpoint:500});const Ef=({Icon:e,title:t,description:n})=>s.createElement(zh.s,{className:"mx_EmptyState",direction:"column",gap:"var(--cpd-space-4x)",align:"center",justify:"center"},s.createElement(e,{width:"32px",height:"32px"}),s.createElement(Qa.E,{size:"lg",weight:"semibold"},t),s.createElement(Qa.E,{size:"md",weight:"regular"},n));class wf extends s.Component{constructor(...e){super(...e),(0,h.A)(this,"decryptingEvents",new Set),(0,h.A)(this,"noRoom",!1),(0,h.A)(this,"card",(0,s.createRef)()),(0,h.A)(this,"state",{timelineSet:null,narrow:!1}),(0,h.A)(this,"onRoomTimeline",((e,t,n,i,r)=>{if((null==t?void 0:t.roomId)!==this.props.roomId)return;if(n||!r||!r.liveEvent||e.isRedacted())return;E.J.safeGet().decryptEventIfNeeded(e),e.isBeingDecrypted()?this.decryptingEvents.add(e.getId()):this.addEncryptedLiveEvent(e)})),(0,h.A)(this,"onEventDecrypted",((e,t)=>{if(e.getRoomId()!==this.props.roomId)return;const n=e.getId();this.decryptingEvents.delete(n)&&(t||this.addEncryptedLiveEvent(e))})),(0,h.A)(this,"onPaginationRequest",((e,t,n)=>{const i=E.J.safeGet(),r=cf.A.get(),s=this.props.roomId,o=i.getRoom(s);return o&&i.isRoomEncrypted(s)&&null!==r?r.paginateTimelineWindow(o,e,t,n):e.paginate(t,n)})),(0,h.A)(this,"onMeasurement",(e=>{this.setState({narrow:e})}))}addEncryptedLiveEvent(e){if(!this.state.timelineSet)return;const t=this.state.timelineSet.getLiveTimeline();"m.room.message"===e.getType()&&["m.file","m.image","m.video","m.audio"].includes(e.getContent().msgtype)&&(this.state.timelineSet.eventIdToTimeline(e.getId())||this.state.timelineSet.addEventToTimeline(e,t,{fromCache:!1,addToState:!1,toStartOfTimeline:!1}))}async componentDidMount(){const e=E.J.safeGet();await this.updateTimelineSet(this.props.roomId),e.isRoomEncrypted(this.props.roomId)&&null!==cf.A.get()&&(e.on(i.RoomEvent.Timeline,this.onRoomTimeline),e.on(i.MatrixEventEvent.Decrypted,this.onEventDecrypted))}componentWillUnmount(){const e=E.J.get();null!==e&&e.isRoomEncrypted(this.props.roomId)&&null!==cf.A.get()&&(e.removeListener(i.RoomEvent.Timeline,this.onRoomTimeline),e.removeListener(i.MatrixEventEvent.Decrypted,this.onEventDecrypted))}async fetchFileEventsServer(e){const t=E.J.safeGet(),n=new i.Filter(t.getSafeUserId());return n.setDefinition({room:{timeline:{contains_url:!0,types:["m.room.message"]}}}),n.filterId=await t.getOrCreateFilter("FILTER_FILES_"+t.credentials.userId,n),e.getOrCreateFilteredTimelineSet(n)}async updateTimelineSet(e){const t=E.J.safeGet(),n=t.getRoom(e),i=cf.A.get();if(this.noRoom=!n,n){let r;try{if(r=await this.fetchFileEventsServer(n),t.isRoomEncrypted(e)&&null!==i){const e=r.getLiveTimeline();await i.populateFileTimeline(r,e,n,10)}this.setState({timelineSet:r})}catch(e){o.v.error("Failed to get or create file panel filter",e)}}else o.v.error("Failed to add filtered timelineSet for FilePanel as no room!")}render(){if(E.J.safeGet().isGuest())return s.createElement(Ep.A,{className:"mx_FilePanel mx_RoomView_messageListWrapper",onClose:this.props.onClose,header:(0,P._t)("right_panel|files_button")},s.createElement("div",{className:"mx_RoomView_empty"},(0,P._t)("file_panel|guest_note",{},{a:e=>s.createElement("a",{href:"#/register",key:"sub"},e)})));if(this.noRoom)return s.createElement(Ep.A,{className:"mx_FilePanel mx_RoomView_messageListWrapper",onClose:this.props.onClose,header:(0,P._t)("right_panel|files_button")},s.createElement("div",{className:"mx_RoomView_empty"},(0,P._t)("file_panel|peek_note")));const e=s.createElement(Ef,{Icon:cp.A,title:(0,P._t)("file_panel|empty_heading"),description:(0,P._t)("file_panel|empty_description")}),t=!this.noRoom&&E.J.safeGet().isRoomEncrypted(this.props.roomId);return this.state.timelineSet?s.createElement(Ld.yw,(0,p.A)({},this.context,{timelineRenderingType:Sp.Ae.File,narrow:this.state.narrow}),s.createElement(Ep.A,{className:"mx_FilePanel",onClose:this.props.onClose,withoutScrollContainer:!0,ref:this.card,header:(0,P._t)("right_panel|files_button")},this.card.current&&s.createElement(bf,{sensor:this.card.current,onMeasurement:this.onMeasurement}),s.createElement(uf,{isRoomEncrypted:t,kind:df.Files}),s.createElement(yf,{manageReadReceipts:!1,manageReadMarkers:!1,timelineSet:this.state.timelineSet,showUrlPreview:!1,onPaginationRequest:this.onPaginationRequest,resizeNotifier:this.props.resizeNotifier,empty:e,layout:zp.P.Group}))):s.createElement(Ld.yw,(0,p.A)({},this.context,{timelineRenderingType:Sp.Ae.File}),s.createElement(Ep.A,{className:"mx_FilePanel",onClose:this.props.onClose,header:(0,P._t)("right_panel|files_button")},s.createElement(Na.A,null)))}}(0,h.A)(wf,"contextType",Sp.Ay);const Sf=wf;class Af extends s.Component{constructor(...e){super(...e),(0,h.A)(this,"resize",(()=>{this.props.onResize&&this.props.onResize()}))}componentDidMount(){window.addEventListener("resize",this.resize)}componentWillUnmount(){window.removeEventListener("resize",this.resize)}render(){return s.createElement("div",null,this.props.element)}}const Cf="stickerPicker";class xf extends s.PureComponent{constructor(e){super(e),(0,h.A)(this,"dispatcherRef",void 0),(0,h.A)(this,"prevSentVisibility",void 0),(0,h.A)(this,"popoverWidth",300),(0,h.A)(this,"popoverHeight",300),(0,h.A)(this,"scalarClient",null),(0,h.A)(this,"removeStickerpickerWidgets",(async()=>{const e=await this.acquireScalarClient();o.v.log("Removing Stickerpicker widgets"),this.state.widgetId?e?e.disableWidgetAssets(Bg.x.STICKERPICKER,this.state.widgetId).then((()=>{o.v.log("Assets disabled")})).catch((()=>{o.v.error("Failed to disable assets")})):o.v.error("Cannot disable assets: no scalar client"):o.v.warn("No widget ID specified, not disabling assets"),this.props.setStickerPickerOpen(!1),wg.A.removeStickerpickerWidgets(this.props.room.client).then((()=>{this.forceUpdate()})).catch((e=>{o.v.error("Failed to remove sticker picker widget",e)}))})),(0,h.A)(this,"updateWidget",(()=>{var e,t,n,i;const r=wg.A.getStickerpickerWidgets(this.props.room.client)[0];if(!r)return xf.currentWidget=void 0,void this.setState({stickerpickerWidget:null,widgetId:null});const s=xf.currentWidget,o=null!==(e=null==s||null===(t=s.content)||void 0===t?void 0:t.url)&&void 0!==e?e:null;(null!==(n=null==r||null===(i=r.content)||void 0===i?void 0:i.url)&&void 0!==n?n:null)!==o&&Ug.destroyElement(Cf),xf.currentWidget=r,this.setState({stickerpickerWidget:r,widgetId:r?r.id:null})})),(0,h.A)(this,"onAction",(e=>{switch(e.action){case"user_widget_updated":this.forceUpdate();break;case"stickerpicker_close":case"show_left_panel":case"hide_left_panel":this.props.setStickerPickerOpen(!1)}})),(0,h.A)(this,"onRightPanelStoreUpdate",(()=>{this.props.setStickerPickerOpen(!1)})),(0,h.A)(this,"onResize",(()=>{this.props.isStickerPickerOpen&&this.props.setStickerPickerOpen(!1)})),(0,h.A)(this,"onFinished",(()=>{this.props.isStickerPickerOpen&&this.props.setStickerPickerOpen(!1)})),(0,h.A)(this,"launchManageIntegrations",(()=>{var e,t;null===(e=sv.J.sharedInstance())||void 0===e||null===(e=e.getPrimaryManager())||void 0===e||e.open(this.props.room,`type_${Bg.x.STICKERPICKER.preferred}`,null!==(t=this.state.widgetId)&&void 0!==t?t:void 0)})),this.state={imError:null,stickerpickerWidget:null,widgetId:null}}async acquireScalarClient(){return this.scalarClient?Promise.resolve(this.scalarClient):sv.J.sharedInstance().hasManager()?(this.scalarClient=null!==(e=null===(t=sv.J.sharedInstance().getPrimaryManager())||void 0===t?void 0:t.getScalarClient())&&void 0!==e?e:null,null===(n=this.scalarClient)||void 0===n?void 0:n.connect().then((()=>(this.forceUpdate(),this.scalarClient))).catch((e=>{this.imError((0,P.AO)("integration_manager|error_connecting_heading"),e)}))):void sv.J.sharedInstance().openNoManagerDialog();var e,t,n}componentDidMount(){window.addEventListener("resize",this.onResize),this.dispatcherRef=w.A.register(this.onAction),E.J.safeGet().on(i.ClientEvent.AccountData,this.updateWidget),rl.A.instance.on(I.H,this.onRightPanelStoreUpdate),this.updateWidget()}componentWillUnmount(){const e=E.J.get();e&&e.removeListener(i.ClientEvent.AccountData,this.updateWidget),rl.A.instance.off(I.H,this.onRightPanelStoreUpdate),window.removeEventListener("resize",this.onResize),w.A.unregister(this.dispatcherRef)}componentDidUpdate(){this.sendVisibilityToWidget(this.props.isStickerPickerOpen)}imError(e,t){o.v.error(e,t),this.setState({imError:(0,P._t)(e)}),this.props.setStickerPickerOpen(!1)}defaultStickerpickerContent(){const e=n("./res/img/stickerpack-placeholder.png");return s.createElement(Ae.A,{onClick:this.launchManageIntegrations,className:"mx_Stickers_contentPlaceholder"},s.createElement("p",null,(0,P._t)("stickers|empty")),s.createElement("p",{className:"mx_Stickers_addLink"},(0,P._t)("stickers|empty_add_prompt")),s.createElement("img",{src:e,alt:""}))}errorStickerpickerContent(){return s.createElement("div",{style:{textAlign:"center"},className:"error"},s.createElement("p",null," ",this.state.imError," "))}sendVisibilityToWidget(e){if(!this.state.stickerpickerWidget)return;const t=rv.c.instance.getMessagingForUid(wg.A.calcWidgetUid(this.state.stickerpickerWidget.id));t&&e!==this.prevSentVisibility&&(t.updateVisibility(e).catch((e=>{o.v.error("Error updating widget visibility: ",e)})),this.prevSentVisibility=e)}getStickerpickerContent(){var e;if(this.state.imError)return this.errorStickerpickerContent();const t=this.state.stickerpickerWidget;let n;if(null!=t&&null!==(e=t.content)&&void 0!==e&&e.url){t.content.name=t.content.name||(0,P._t)("common|stickerpack");const e={id:t.id,url:t.content.url,name:t.content.name,type:t.content.type,data:t.content.data,creatorUserId:t.content.creatorUserId||t.sender};n=s.createElement("div",{className:"mx_Stickers_content_container"},s.createElement("div",{id:"stickersContent",className:"mx_Stickers_content",style:{border:"none",height:this.popoverHeight,width:this.popoverWidth}},s.createElement(Ug,{persistKey:Cf,zIndex:3500},s.createElement(Vv,{app:e,room:this.props.room,threadId:this.props.threadId,fullWidth:!0,userId:E.J.safeGet().credentials.userId,creatorUserId:t.sender||E.J.safeGet().credentials.userId,waitForIframeLoad:!0,showMenubar:!0,onEditClick:this.launchManageIntegrations,onDeleteClick:this.removeStickerpickerWidgets,showTitle:!1,showPopout:!1,handleMinimisePointerEvents:!0,userWidget:!0,showLayoutButtons:!1}))))}else n=this.defaultStickerpickerContent();return n}render(){return this.props.isStickerPickerOpen?s.createElement(Fe.Ay,(0,p.A)({chevronFace:Fe.t4.Bottom,menuWidth:this.popoverWidth,menuHeight:this.popoverHeight,onFinished:this.onFinished,menuPaddingTop:0,menuPaddingLeft:0,menuPaddingRight:0,zIndex:3500,mountAsChild:!0},this.props.menuPosition),s.createElement(Af,{element:this.getStickerpickerContent(),onResize:this.onFinished})):null}}(0,h.A)(xf,"defaultProps",{threadId:null}),(0,h.A)(xf,"currentWidget",void 0);var kf=n("./src/components/views/rooms/ReplyTile.tsx");class Rf extends s.Component{render(){return this.props.replyToEvent?s.createElement("div",{className:"mx_ReplyPreview"},s.createElement("div",{className:"mx_ReplyPreview_section"},s.createElement("div",{className:"mx_ReplyPreview_header"},s.createElement("span",null,(0,P._t)("composer|replying_title")),s.createElement(Ae.A,{className:"mx_ReplyPreview_header_cancel",onClick:()=>{return e=this.context.timelineRenderingType,void w.A.dispatch({action:"reply_to_event",event:null,context:e});var e}})),s.createElement(kf.A,{mxEvent:this.props.replyToEvent,permalinkCreator:this.props.permalinkCreator}))):null}}(0,h.A)(Rf,"contextType",Sp.Ay);var If=n("./src/audio/VoiceRecording.ts"),Tf=n("./src/components/views/audio_messages/Waveform.tsx"),Pf=n("./src/utils/MarkedExecution.ts");class Nf extends s.PureComponent{constructor(e){super(e),(0,h.A)(this,"waveform",[]),(0,h.A)(this,"scheduledUpdate",new Pf.L((()=>this.updateWaveform()),(()=>requestAnimationFrame((()=>this.scheduledUpdate.trigger()))))),this.state={waveform:(0,Vg.DG)(0,If.IZ)}}componentDidMount(){this.props.recorder.liveData.onUpdate((e=>{this.waveform=(0,Vg.$S)(Array.from(e.waveform),If.IZ),this.scheduledUpdate.mark()}))}updateWaveform(){this.setState({waveform:this.waveform})}render(){return s.createElement(Tf.A,{relHeights:this.state.waveform})}}(0,h.A)(Nf,"defaultProps",{progress:1});var Df=n("./src/components/views/audio_messages/Clock.tsx");class Mf extends s.PureComponent{constructor(e){super(e),(0,h.A)(this,"seconds",0),(0,h.A)(this,"scheduledUpdate",new Pf.L((()=>this.updateClock()),(()=>requestAnimationFrame((()=>this.scheduledUpdate.trigger()))))),this.state={seconds:0}}componentDidMount(){this.props.recorder.liveData.onUpdate((e=>{this.seconds=e.timeSeconds,this.scheduledUpdate.mark()}))}updateClock(){this.setState({seconds:this.seconds})}render(){return s.createElement(Df.A,{seconds:this.state.seconds,"aria-live":"off"})}}var Of=n("./src/utils/Singleflight.ts"),Lf=n("./src/audio/Playback.ts");class Ff{constructor(e,t){(0,h.A)(this,"lastUpload",void 0),(0,h.A)(this,"buffer",new Uint8Array(0)),(0,h.A)(this,"playback",void 0),(0,h.A)(this,"onDataAvailable",(e=>{const t=new Uint8Array(e);this.buffer=(0,Vg.xW)(this.buffer,t)})),this.matrixClient=e,this.voiceRecording=t,this.voiceRecording.onDataAvailable=this.onDataAvailable}async start(){if(this.lastUpload||this.hasRecording)throw new Error("Recording already prepared");return this.voiceRecording.start()}async stop(){return await this.voiceRecording.stop(),this.audioBuffer}on(e,t){return this.voiceRecording.on(e,t),this}off(e,t){return this.voiceRecording.off(e,t),this}emit(e,...t){return this.voiceRecording.emit(e,...t)}get hasRecording(){return this.buffer.length>0}get isRecording(){return this.voiceRecording.isRecording}getPlayback(){return this.playback=Of.j.for(this,"playback").do((()=>new Lf.Y(this.audioBuffer.buffer,this.voiceRecording.amplitudes))),this.playback}async upload(e){if(!this.hasRecording)throw new Error("No recording available to upload");if(this.lastUpload)return this.lastUpload;try{this.emit(If.$T.Uploading);const{url:t,file:n}=await(0,mu.QM)(this.matrixClient,e,new Blob([this.audioBuffer],{type:this.contentType}));this.lastUpload={mxc:t,encrypted:n},this.emit(If.$T.Uploaded)}catch(e){throw this.emit(If.$T.Ended),e}return this.lastUpload}get durationSeconds(){return this.voiceRecording.durationSeconds}get contentType(){return this.voiceRecording.contentType}get contentLength(){return this.buffer.length}get liveData(){return this.voiceRecording.liveData}get isSupported(){return this.voiceRecording.isSupported}destroy(){var e;null===(e=this.playback)||void 0===e||e.destroy(),this.voiceRecording.destroy()}get audioBuffer(){return this.buffer.slice(0)}}function Uf(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}function Bf(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Vf(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Bf(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Bf(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class jf extends B.r{constructor(){super(w.A,{})}static get instance(){return this.internalInstance||(this.internalInstance=new jf,this.internalInstance.start()),this.internalInstance}async onAction(e){}static getVoiceRecordingId(e,t){return"io.element.thread"===(null==t?void 0:t.rel_type)||(null==t?void 0:t.rel_type)===i.RelationType.Thread?e.roomId+"|"+t.event_id:e.roomId}getActiveRecording(e){return this.state[e]}startRecording(e){if(!this.matrixClient)throw new Error("Cannot start a recording without a MatrixClient");if(!e)throw new Error("Recording must be associated with a room");if(this.state[e])throw new Error("A recording is already in progress");const t=(n=this.matrixClient,new Ff(n,new If.Qj));var n;return this.updateState(Vf(Vf({},this.state),{},{[e]:t})),t}disposeRecording(e){var t;null===(t=this.state[e])||void 0===t||t.destroy();const n=this.state,{[e]:i}=n,r=(0,Ve.A)(n,[e].map(Uf));return this.reset(r)}}(0,h.A)(jf,"internalInstance",void 0),window.mxVoiceRecordingStore=jf.instance;var zf=n("./src/components/views/audio_messages/RecordingPlayback.tsx"),Wf=n("./src/audio/PlaybackManager.ts"),Hf=n("./src/utils/local-room.ts"),Gf=n("./src/components/views/rooms/SendMessageComposer.tsx"),Kf=n("./src/utils/Reply.ts");class Jf extends s.PureComponent{constructor(e,t){super(e,t),(0,h.A)(this,"voiceRecordingId",void 0),(0,h.A)(this,"onCancel",(async()=>{await this.disposeRecording()})),(0,h.A)(this,"onRecordStartEndClick",(async()=>{if(this.state.recorder)return void await this.state.recorder.stop();const e=()=>{A.Ay.createDialog(_v.A,{title:(0,P._t)("voip|unable_to_access_audio_input_title"),description:s.createElement(s.Fragment,null,s.createElement("p",null,(0,P._t)("voip|unable_to_access_audio_input_description")))})};try{var t;const e=await oe.Ay.getDevices();if(null==e||null===(t=e[oe.cm.AudioInput])||void 0===t||!t.length)return void A.Ay.createDialog(_v.A,{title:(0,P._t)("voip|no_audio_input_title"),description:s.createElement(s.Fragment,null,s.createElement("p",null,(0,P._t)("voip|no_audio_input_description")))})}catch(t){return o.v.error("Error getting devices: ",t),void e()}try{Wf.T.instance.pauseAllExcept();const e=jf.instance.startRecording(this.voiceRecordingId);await e.start(),this.bindNewRecorder(e),this.setState({recorder:e,recordingPhase:If.$T.Started})}catch(t){o.v.error("Error starting recording: ",t),e(),jf.instance.disposeRecording(this.voiceRecordingId)}})),(0,h.A)(this,"onRecordingUpdate",(e=>{e!==If.$T.EndingSoon&&this.setState({recordingPhase:e})})),this.state={},this.voiceRecordingId=jf.getVoiceRecordingId(this.props.room,this.props.relation)}componentDidMount(){const e=jf.instance.getActiveRecording(this.voiceRecordingId);e&&(!e.isRecording&&e.hasRecording||o.v.warn("Cached recording hasn't ended yet and might cause issues"),this.bindNewRecorder(e),this.setState({recorder:e,recordingPhase:If.$T.Ended}))}async componentWillUnmount(){const e=jf.instance.getActiveRecording(this.voiceRecordingId);await(null==e?void 0:e.stop()),this.bindNewRecorder(null)}async send(){if(!this.state.recorder)throw new Error("No recording started - cannot send anything");const{replyToEvent:e,relation:t}=this.props;let n;await this.state.recorder.stop();try{n=await this.state.recorder.upload(this.voiceRecordingId)}catch(e){return o.v.error("Error uploading voice message:",e),void this.setState({didUploadFail:!0})}try{const o=(r=n.mxc,s=this.state.recorder.contentType,a=Math.round(1e3*this.state.recorder.durationSeconds),l=this.state.recorder.contentLength,c=n.encrypted,d=this.state.recorder.getPlayback().thumbnailWaveform.map((e=>Math.round(1024*e))),{body:"Voice message",msgtype:i.MsgType.Audio,url:r,file:c,info:{duration:a,mimetype:s,size:l},"org.matrix.msc1767.text":"Voice message","org.matrix.msc1767.file":{url:r,file:c,name:"Voice message.ogg",mimetype:s,size:l},"org.matrix.msc1767.audio":{duration:a,waveform:d},"org.matrix.msc3245.voice":{}});(0,Gf.LO)(E.J.safeGet().getSafeUserId(),o,null,e),(0,Gf.gV)(o,t),e&&((0,Kf.fh)(o,e),w.A.dispatch({action:"reply_to_event",event:null,context:this.context.timelineRenderingType})),(0,Hf.Y)(this.props.room.roomId,(e=>E.J.safeGet().sendMessage(e,o)),this.props.room.client)}catch(e){o.v.error("Error sending voice message:",e)}var r,s,a,l,c,d;await this.disposeRecording()}async disposeRecording(){await jf.instance.disposeRecording(this.voiceRecordingId),this.setState({recorder:void 0,recordingPhase:void 0,didUploadFail:!1})}bindNewRecorder(e){this.state.recorder&&this.state.recorder.off(I.H,this.onRecordingUpdate),e&&e.on(I.H,this.onRecordingUpdate)}renderWaveformArea(){return this.state.recorder?this.state.recordingPhase!==If.$T.Started?s.createElement(zf.A,{playback:this.state.recorder.getPlayback(),layout:zf._.Composer}):s.createElement("div",{className:"mx_MediaBody mx_VoiceMessagePrimaryContainer mx_VoiceRecordComposerTile_recording"},s.createElement(Mf,{recorder:this.state.recorder}),s.createElement(Nf,{recorder:this.state.recorder})):null}render(){if(!this.state.recordingPhase)return null;let e,t,n;if(this.state.recordingPhase===If.$T.Started){var i;let t=(0,P._t)("composer|send_voice_message");this.state.recorder&&(t=(0,P._t)("composer|stop_voice_message")),e=s.createElement(Ae.A,{className:"mx_VoiceRecordComposerTile_stop",onClick:this.onRecordStartEndClick,title:t}),!this.state.recorder||null!==(i=this.state.recorder)&&void 0!==i&&i.isRecording||(e=null)}return this.state.recorder&&this.state.recordingPhase!==If.$T.Uploading&&(t=s.createElement(Ae.A,{className:"mx_VoiceRecordComposerTile_delete",title:(0,P._t)("action|delete"),onClick:this.onCancel})),this.state.recordingPhase===If.$T.Uploading?n=s.createElement("span",{className:"mx_VoiceRecordComposerTile_uploadingState"},s.createElement(He.A,{w:16,h:16})):this.state.didUploadFail&&this.state.recordingPhase===If.$T.Ended&&(n=s.createElement("span",{className:"mx_VoiceRecordComposerTile_failedState"},s.createElement("span",{className:"mx_VoiceRecordComposerTile_uploadState_badge"},s.createElement(da.A,{notification:ma.d.forSymbol("!",pa.S.Highlight)})),s.createElement("span",{className:"text-warning"},(0,P._t)("timeline|send_state_failed")))),s.createElement(s.Fragment,null,n,t,e,this.renderWaveformArea())}}(0,h.A)(Jf,"contextType",Sp.Ay);var qf=n("./src/components/views/rooms/MessageComposerButtons.tsx"),$f=n("./src/utils/localRoom/isLocalRoom.ts"),Yf=n("./src/components/views/rooms/wysiwyg_composer/index.ts");const Zf="mx_wysiwyg_state_";let Xf=0;function Qf(e){var t;return s.createElement(Ae.A,{className:"mx_MessageComposer_sendMessage",onClick:e.onClick,title:null!==(t=e.title)&&void 0!==t?t:(0,P._t)("composer|send_button_title")})}class e_ extends s.Component{constructor(e,t){var n;super(e,t),(0,h.A)(this,"dispatcherRef",void 0),(0,h.A)(this,"messageComposerInput",(0,s.createRef)()),(0,h.A)(this,"voiceRecordingButton",(0,s.createRef)()),(0,h.A)(this,"ref",(0,s.createRef)()),(0,h.A)(this,"instanceId",void 0),(0,h.A)(this,"_voiceRecording",void 0),(0,h.A)(this,"saveWysiwygEditorState",(()=>{if(this.shouldSaveWysiwygEditorState()){const{isRichTextEnabled:e,composerContent:t}=this.state,n={content:t,isRichText:e,replyEventId:this.props.replyToEvent?this.props.replyToEvent.getId():void 0};localStorage.setItem(this.editorStateKey,JSON.stringify(n))}else this.clearStoredEditorState()})),(0,h.A)(this,"shouldSaveWysiwygEditorState",(()=>{const{isWysiwygLabEnabled:e,isComposerEmpty:t}=this.state;return e&&(!t||!!this.props.replyToEvent)})),(0,h.A)(this,"onResize",((e,t)=>{if(e===Ie.x.Resize){const{narrow:e}=this.context;this.setState({isMenuOpen:!!e&&this.state.isMenuOpen,isStickerPickerOpen:!1})}})),(0,h.A)(this,"onAction",(e=>{switch(e.action){case"reply_to_event":e.context===this.context.timelineRenderingType&&window.setTimeout((()=>{this.props.resizeNotifier.notifyTimelineHeightChanged()}),100);break;case R.r.SettingUpdated:{const t=e;switch(t.settingName){case"MessageComposerInput.showStickersButton":{const e=V.A.getValue("MessageComposerInput.showStickersButton");this.state.showStickersButton!==e&&this.setState({showStickersButton:e});break}case"MessageComposerInput.showPollsButton":{const e=V.A.getValue("MessageComposerInput.showPollsButton");this.state.showPollsButton!==e&&this.setState({showPollsButton:e});break}case"feature_wysiwyg_composer":this.state.isWysiwygLabEnabled!==t.newValue&&this.setState({isWysiwygLabEnabled:Boolean(t.newValue)})}}}})),(0,h.A)(this,"onTombstoneClick",(e=>{var t,n;e.preventDefault();const r=null===(t=this.context.tombstone)||void 0===t?void 0:t.getContent().replacement_room,s=E.J.safeGet().getRoom(r);let o;if(s){const e=s.currentState.getStateEvents(i.EventType.RoomCreate,"");null!=e&&e.getId()&&(o=e.getId())}const a=null===(n=this.context.tombstone)||void 0===n?void 0:n.getSender(),l=a?[a.split(":").slice(1).join(":")]:void 0;w.A.dispatch({action:R.r.ViewRoom,highlighted:!0,event_id:o,room_id:r,auto_join:!0,via_servers:l,metricsTrigger:"Tombstone",metricsViaKeyboard:"click"!==e.type})})),(0,h.A)(this,"renderPlaceholderText",(()=>{if(this.props.replyToEvent){var e;const t=(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===i.THREAD_RELATION_TYPE.name;return t&&this.props.e2eStatus?(0,P._t)("composer|placeholder_thread_encrypted"):t?(0,P._t)("composer|placeholder_thread"):this.props.e2eStatus?(0,P._t)("composer|placeholder_reply_encrypted"):(0,P._t)("composer|placeholder_reply")}return this.props.e2eStatus?(0,P._t)("composer|placeholder_encrypted"):(0,P._t)("composer|placeholder")})),(0,h.A)(this,"addEmoji",(e=>(w.A.dispatch({action:R.r.ComposerInsert,text:e,timelineRenderingType:this.context.timelineRenderingType}),!0))),(0,h.A)(this,"sendMessage",(async()=>{var e,t;if(this.state.haveRecording&&this.voiceRecordingButton.current)await(null===(t=this.voiceRecordingButton.current)||void 0===t?void 0:t.send());else if(null===(e=this.messageComposerInput.current)||void 0===e||e.sendMessage(),this.state.isWysiwygLabEnabled){const{relation:e,replyToEvent:t}=this.props,n=this.state.composerContent;this.setState({composerContent:"",initialComposerContent:""}),w.A.dispatch({action:R.r.ClearAndFocusSendMessageComposer,timelineRenderingType:this.context.timelineRenderingType}),await(0,Yf._z)(n,this.state.isRichTextEnabled,{mxClient:this.props.mxClient,roomContext:this.context,relation:e,replyToEvent:t})}})),(0,h.A)(this,"onChange",(e=>{this.setState({isComposerEmpty:e.isEmpty})})),(0,h.A)(this,"onWysiwygChange",(e=>{this.setState({composerContent:e,isComposerEmpty:0===(null==e?void 0:e.length)})})),(0,h.A)(this,"onRichTextToggle",(async()=>{const{richToPlain:e,plainToRich:t}=await(0,Yf.Os)(),{isRichTextEnabled:n,composerContent:i}=this.state,r=n?await e(i,!1):await t(i,!1);this.setState({isRichTextEnabled:!n,composerContent:r,initialComposerContent:r})})),(0,h.A)(this,"onVoiceStoreUpdate",(()=>{this.updateRecordingState()})),(0,h.A)(this,"onRecordingStarted",(()=>{const e=jf.getVoiceRecordingId(this.props.room,this.props.relation);this.voiceRecording=jf.instance.getActiveRecording(e),this.setState({haveRecording:!!this.voiceRecording})})),(0,h.A)(this,"onRecordingEndingSoon",(({secondsLeft:e})=>{this.setState({recordingTimeLeftSeconds:e}),window.setTimeout((()=>this.setState({recordingTimeLeftSeconds:void 0})),3e3)})),(0,h.A)(this,"setStickerPickerOpen",(e=>{this.setState({isStickerPickerOpen:e,isMenuOpen:!1})})),(0,h.A)(this,"toggleStickerPickerOpen",(()=>{this.setStickerPickerOpen(!this.state.isStickerPickerOpen)})),(0,h.A)(this,"toggleButtonMenu",(()=>{this.setState({isMenuOpen:!this.state.isMenuOpen})})),(0,h.A)(this,"onRecordStartEndClick",(()=>{var e;null===(e=this.voiceRecordingButton.current)||void 0===e||e.onRecordStartEndClick(),this.context.narrow&&this.toggleButtonMenu()})),this.context=t;const r=V.A.getValue("feature_wysiwyg_composer");let o=!0,a="";if(r){const e=this.restoreWysiwygEditorState();e&&(o=e.isRichText,a=e.content)}this.state={isComposerEmpty:0===(null===(n=a)||void 0===n?void 0:n.length),composerContent:a,haveRecording:!1,recordingTimeLeftSeconds:void 0,isMenuOpen:!1,isStickerPickerOpen:!1,showStickersButton:V.A.getValue("MessageComposerInput.showStickersButton"),showPollsButton:V.A.getValue("MessageComposerInput.showPollsButton"),isWysiwygLabEnabled:r,isRichTextEnabled:o,initialComposerContent:a},this.instanceId=Xf++}get editorStateKey(){var e;let t=Zf+this.props.room.roomId;return(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===i.THREAD_RELATION_TYPE.name&&(t+=`_${this.props.relation.event_id}`),t}restoreWysiwygEditorState(){const e=localStorage.getItem(this.editorStateKey);if(e)try{return JSON.parse(e)}catch(e){o.v.error(e)}}clearStoredEditorState(){localStorage.removeItem(this.editorStateKey)}get voiceRecording(){return this._voiceRecording}set voiceRecording(e){this._voiceRecording&&(this._voiceRecording.off(If.$T.Started,this.onRecordingStarted),this._voiceRecording.off(If.$T.EndingSoon,this.onRecordingEndingSoon)),this._voiceRecording=e,e&&(e.on(If.$T.Started,this.onRecordingStarted),e.on(If.$T.EndingSoon,this.onRecordingEndingSoon))}componentDidMount(){if(jf.instance.on(I.H,this.onVoiceStoreUpdate),window.addEventListener("beforeunload",this.saveWysiwygEditorState),this.state.isWysiwygLabEnabled){const e=this.restoreWysiwygEditorState();null!=e&&e.replyEventId&&w.A.dispatch({action:"reply_to_event",event:this.props.room.findEventById(e.replyEventId),context:this.context.timelineRenderingType})}V.A.monitorSetting("MessageComposerInput.showStickersButton",null),V.A.monitorSetting("MessageComposerInput.showPollsButton",null),V.A.monitorSetting("feature_wysiwyg_composer",null),this.dispatcherRef=w.A.register(this.onAction),this.waitForOwnMember(),Ie.A.instance.trackElementDimensions(`MessageComposer${this.instanceId}`,this.ref.current),Ie.A.instance.on(`MessageComposer${this.instanceId}`,this.onResize),this.updateRecordingState()}waitForOwnMember(){const e=this.props.room.getMember(E.J.safeGet().getUserId());e?this.setState({me:e}):this.props.room.loadMembersIfNeeded().then((()=>{var e;const t=null!==(e=this.props.room.getMember(E.J.safeGet().getSafeUserId()))&&void 0!==e?e:void 0;this.setState({me:t})}))}componentWillUnmount(){jf.instance.off(I.H,this.onVoiceStoreUpdate),w.A.unregister(this.dispatcherRef),Ie.A.instance.stopTrackingElementDimensions(`MessageComposer${this.instanceId}`),Ie.A.instance.removeListener(`MessageComposer${this.instanceId}`,this.onResize),window.removeEventListener("beforeunload",this.saveWysiwygEditorState),this.saveWysiwygEditorState(),this.voiceRecording=null}updateRecordingState(){const e=jf.getVoiceRecordingId(this.props.room,this.props.relation);this.voiceRecording=jf.instance.getActiveRecording(e),this.voiceRecording?this.voiceRecording.hasRecording&&!this.voiceRecording.isRecording&&this.setState({haveRecording:!0}):this.setState({haveRecording:!1})}get showStickersButton(){return this.state.showStickersButton&&!(0,$f.F)(this.props.room)}getMenuPosition(){if(this.ref.current){const e=this.state.isWysiwygLabEnabled&&this.state.isRichTextEnabled,t=this.ref.current.getBoundingClientRect(),n=e?36:0,i=new DOMRect(t.x,t.y+n,t.width,t.height-n);return(0,Fe.qv)(i)}}render(){var e;const t=Boolean(!this.state.isWysiwygLabEnabled&&this.props.e2eStatus),n=t&&s.createElement("div",{className:"mx_MessageComposer_e2eIconWrapper"},s.createElement($v.A,{key:"e2eIcon",status:this.props.e2eStatus,className:"mx_MessageComposer_e2eIcon"})),r=[],o=this.getMenuPosition(),a=this.context.canSendMessages&&!this.context.tombstone;let l;if(a)l=this.state.isWysiwygLabEnabled&&o?s.createElement(Yf.W1,{key:"controls_input",disabled:this.state.haveRecording,onChange:this.onWysiwygChange,onSend:this.sendMessage,isRichTextEnabled:this.state.isRichTextEnabled,initialContent:this.state.initialComposerContent,e2eStatus:this.props.e2eStatus,menuPosition:o,placeholder:this.renderPlaceholderText(),eventRelation:this.props.relation}):s.createElement(Gf.Ay,{ref:this.messageComposerInput,key:"controls_input",room:this.props.room,placeholder:this.renderPlaceholderText(),relation:this.props.relation,replyToEvent:this.props.replyToEvent,onChange:this.onChange,disabled:this.state.haveRecording,toggleStickerPickerOpen:this.toggleStickerPickerOpen}),r.push(s.createElement(Jf,{key:"controls_voice_record",ref:this.voiceRecordingButton,room:this.props.room,relation:this.props.relation,replyToEvent:this.props.replyToEvent}));else if(this.context.tombstone){const e=this.context.tombstone.getContent().replacement_room,t=e?s.createElement("a",{href:(0,uu.B4)(E.J.safeGet(),e),className:"mx_MessageComposer_roomReplaced_link",onClick:this.onTombstoneClick},(0,P._t)("composer|room_upgraded_link")):"";r.push(s.createElement("div",{className:"mx_MessageComposer_replaced_wrapper",key:"room_replaced"},s.createElement("div",{className:"mx_MessageComposer_replaced_valign"},s.createElement("img",{"aria-hidden":!0,alt:"",className:"mx_MessageComposer_roomReplaced_icon",src:"img/room_replaced.4ac105f.svg"}),s.createElement("span",{className:"mx_MessageComposer_roomReplaced_header"},(0,P._t)("composer|room_upgraded_notice")),s.createElement("br",null),t)))}else r.push(s.createElement("div",{key:"controls_error",className:"mx_MessageComposer_noperm_error"},(0,P._t)("composer|no_perms_notice")));const c=Boolean(this.state.recordingTimeLeftSeconds),d=this.state.recordingTimeLeftSeconds?Math.round(this.state.recordingTimeLeftSeconds):0,u=(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===i.THREAD_RELATION_TYPE.name?this.props.relation.event_id:null;r.push(s.createElement(xf,{room:this.props.room,threadId:u,isStickerPickerOpen:this.state.isStickerPickerOpen,setStickerPickerOpen:this.setStickerPickerOpen,menuPosition:o,key:"stickers"}));const m=a&&(!this.state.isComposerEmpty||this.state.haveRecording),p=re()({mx_MessageComposer:!0,"mx_MessageComposer--compact":this.props.compact,mx_MessageComposer_e2eStatus:t,mx_MessageComposer_wysiwyg:this.state.isWysiwygLabEnabled});return s.createElement(Te.m,{open:c,description:(0,Bp.U)(d),placement:"bottom"},s.createElement("div",{className:p,ref:this.ref,role:"region","aria-label":(0,P._t)("a11y|message_composer")},s.createElement("div",{className:"mx_MessageComposer_wrapper"},s.createElement(Rf,{replyToEvent:this.props.replyToEvent,permalinkCreator:this.props.permalinkCreator}),s.createElement("div",{className:"mx_MessageComposer_row"},n,l,s.createElement("div",{className:"mx_MessageComposer_actions"},r,a&&s.createElement(qf.Ay,{addEmoji:this.addEmoji,haveRecording:this.state.haveRecording,isMenuOpen:this.state.isMenuOpen,isStickerPickerOpen:this.state.isStickerPickerOpen,menuPosition:o,relation:this.props.relation,onRecordStartEndClick:this.onRecordStartEndClick,setStickerPickerOpen:this.setStickerPickerOpen,showLocationButton:!window.electron&&V.A.getValue($.f.LocationSharing),showPollsButton:this.state.showPollsButton,showStickersButton:this.showStickersButton,isRichTextEnabled:this.state.isRichTextEnabled,onComposerModeClick:this.onRichTextToggle,toggleButtonMenu:this.toggleButtonMenu}),m&&s.createElement(Qf,{key:"controls_send",onClick:this.sendMessage,title:this.state.haveRecording?(0,P._t)("composer|send_button_voice_message"):void 0}))))))}}(0,h.A)(e_,"contextType",Sp.Ay),(0,h.A)(e_,"defaultProps",{compact:!1,isRichTextEnabled:!0});const t_=(0,Pe.dt)(e_);class n_{constructor(e){(0,h.A)(this,"serializedParts",null),(0,h.A)(this,"caret",null),this.event=e}setEditorState(e,t){this.caret=e,this.serializedParts=t}hasEditorState(){return!!this.serializedParts}getSerializedParts(){return this.serializedParts}getCaret(){return this.caret}getEvent(){return this.event}}var i_=n("./src/utils/FileUtils.ts");class r_ extends s.PureComponent{constructor(e){super(e),(0,h.A)(this,"dispatcherRef",void 0),(0,h.A)(this,"unmounted",!1),(0,h.A)(this,"onAction",(e=>{this.unmounted||function(e){return[R.r.UploadStarted,R.r.UploadProgress,R.r.UploadFailed,R.r.UploadFinished,R.r.UploadCanceled].includes(e.action)}(e)&&this.setState(this.calculateState())})),(0,h.A)(this,"onCancelClick",(e=>{e.preventDefault(),mu.Ay.sharedInstance().cancelUpload(this.state.currentUpload)})),this.state=this.calculateState()}componentDidMount(){this.unmounted=!1,this.dispatcherRef=w.A.register(this.onAction)}componentWillUnmount(){this.unmounted=!0,w.A.unregister(this.dispatcherRef)}getUploadsInRoom(){return mu.Ay.sharedInstance().getCurrentUploads(this.props.relation).filter((e=>e.roomId===this.props.room.roomId))}calculateState(){const[e,...t]=this.getUploadsInRoom();return{currentUpload:e,currentFile:null==e?void 0:e.fileName,currentLoaded:null==e?void 0:e.loaded,currentTotal:null==e?void 0:e.total,countFiles:t.length+1}}render(){if(!this.state.currentFile)return null;let e;e=this.state.countFiles>1?(0,P._t)("room|upload|uploading_multiple_file",{filename:this.state.currentFile,count:this.state.countFiles-1}):(0,P._t)("room|upload|uploading_single_file",{filename:this.state.currentFile});const t=(0,i_.Ov)(this.state.currentTotal);return s.createElement("div",{className:"mx_UploadBar"},s.createElement("div",{className:"mx_UploadBar_filename"},e," (",t,")"),s.createElement(Ae.A,{onClick:this.onCancelClick,className:"mx_UploadBar_cancel"}),s.createElement(Jd.A,{value:this.state.currentLoaded,max:this.state.currentTotal}))}}var s_=n("./src/utils/strings.ts");const o_=["mxEvent","permalinkCreator","onMenuToggle"],a_=e=>{let{mxEvent:t,permalinkCreator:n,onMenuToggle:i}=e,r=(0,Ve.A)(e,o_);const[o,a,l,c]=(0,Fe.EF)(),d=(0,s.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),w.A.dispatch({action:R.r.ViewRoom,event_id:t.getId(),highlighted:!0,room_id:t.getRoomId(),metricsTrigger:void 0}),c()}),[t,c]),u=(0,s.useCallback)((async e=>{if(n){null==e||e.preventDefault(),null==e||e.stopPropagation();const i=n.forEvent(t.getId());await(0,s_.nC)(i),c()}}),[t,c,n]);(0,s.useEffect)((()=>{null==i||i(o)}),[o,i]);const m=E.J.safeGet().getRoom(t.getRoomId()),h=!!m&&!Sv.aK.instance.hasMaximisedWidget(m);return s.createElement(s.Fragment,null,s.createElement(Fe.oW,(0,p.A)({},r,{className:"mx_BaseCard_header_title_button--option",onClick:l,title:(0,P._t)("right_panel|thread_list|context_menu_label"),isExpanded:o,ref:a})),o&&s.createElement(Be.Ay,(0,p.A)({onFinished:c,className:"mx_RoomTile_contextMenu",compact:!0,rightAligned:!0},{left:(g=a.current.getBoundingClientRect()).left+window.scrollX+g.width,top:g.bottom+window.scrollY,chevronFace:Fe.t4.None}),s.createElement(Be.tx,null,h&&s.createElement(Be.R$,{onClick:e=>d(e),label:(0,P._t)("timeline|mab|view_in_room"),iconClassName:"mx_ThreadPanel_viewInRoom"}),n&&s.createElement(Be.R$,{onClick:e=>u(e),label:(0,P._t)("timeline|mab|copy_link_thread"),iconClassName:"mx_ThreadPanel_copyLinkToThread"}))));var g};const l_=({parent:e,onFileDrop:t})=>{const[n,i]=(0,s.useState)({dragging:!1,counter:0});return(0,s.useEffect)((()=>{if(!e||e.ondrop)return;const n=e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer&&i((t=>({counter:t.counter+1,dragging:!(!e.dataTransfer.types.includes("Files")&&!e.dataTransfer.types.includes("application/x-moz-file"))||t.dragging})))},r=e=>{e.stopPropagation(),e.preventDefault(),i((e=>({counter:e.counter-1,dragging:!(e.counter<=1)&&e.dragging})))},s=e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer&&(e.dataTransfer.dropEffect="none",(e.dataTransfer.types.includes("Files")||e.dataTransfer.types.includes("application/x-moz-file"))&&(e.dataTransfer.dropEffect="copy"))},o=e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer&&(t(e.dataTransfer),i((e=>({dragging:!1,counter:e.counter-1}))))};return null==e||e.addEventListener("drop",o),null==e||e.addEventListener("dragover",s),null==e||e.addEventListener("dragenter",n),null==e||e.addEventListener("dragleave",r),()=>{null==e||e.removeEventListener("drop",o),null==e||e.removeEventListener("dragover",s),null==e||e.removeEventListener("dragenter",n),null==e||e.removeEventListener("dragleave",r)}}),[e,t]),n.dragging?s.createElement("div",{className:"mx_FileDropTarget"},s.createElement("img",{src:"img/upload-big.ade34b1.svg",className:"mx_FileDropTarget_image",alt:""}),(0,P._t)("room|drop_file_prompt")):null};var c_,d_,u_=n("./src/dispatcher/payloads/ComposerInsertPayload.ts");function m_(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function p_(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?m_(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):m_(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class h_ extends s.Component{constructor(e,t){var n;super(e,t),(0,h.A)(this,"dispatcherRef",void 0),(0,h.A)(this,"layoutWatcherRef",void 0),(0,h.A)(this,"timelinePanel",(0,s.createRef)()),(0,h.A)(this,"card",(0,s.createRef)()),(0,h.A)(this,"eventId",void 0),(0,h.A)(this,"onAction",(e=>{switch(e.phase==sl.n.ThreadView&&e.event&&this.setupThread(e.event),e.action){case R.r.ComposerInsert:if(e.composerType)break;if(e.timelineRenderingType!==Sp.Ae.Thread)break;w.A.dispatch(p_(p_({},e),{},{composerType:this.state.editState?u_.D.Edit:u_.D.Send}));break;case R.r.EditEvent:if(e.timelineRenderingType!==Sp.Ae.Thread)return;if(e.event&&!e.event.getThread())return;this.setState({editState:e.event?new n_(e.event):void 0},(()=>{var t;e.event&&(null===(t=this.timelinePanel.current)||void 0===t||t.scrollToEventIfNeeded(e.event.getId()))}));break;case"reply_to_event":e.context===Sp.Ae.Thread&&this.setState({replyToEvent:e.event})}})),(0,h.A)(this,"setupThread",(e=>{const t=e.getId();let n=this.props.room.getThread(t);if(!n){const i=[];null===e.status&&i.push(e),n=this.props.room.createThread(t,e,i,!0)}this.updateThread(n)})),(0,h.A)(this,"onNewThread",(e=>{e.id===this.props.mxEvent.getId()&&this.setupThread(this.props.mxEvent)})),(0,h.A)(this,"updateThreadRelation",(()=>{this.setState({lastReply:this.threadLastReply})})),(0,h.A)(this,"updateThread",(e=>{this.state.thread!==e&&(this.setupThreadListeners(e,this.state.thread),e&&this.setState({thread:e,lastReply:this.threadLastReply},(async()=>this.postThreadUpdate(e))))})),(0,h.A)(this,"resetJumpToEvent",(e=>{var t,n;this.props.initialEvent&&this.props.initialEventScrollIntoView&&e===(null===(t=this.props.initialEvent)||void 0===t?void 0:t.getId())&&w.A.dispatch({action:R.r.ViewRoom,room_id:this.props.room.roomId,event_id:null===(n=this.props.initialEvent)||void 0===n?void 0:n.getId(),highlighted:this.props.isInitialEventHighlighted,scroll_into_view:!1,replyingToEvent:this.state.replyToEvent,metricsTrigger:void 0})})),(0,h.A)(this,"onMeasurement",(e=>{this.setState({narrow:e})})),(0,h.A)(this,"onKeyDown",(e=>{let t=!1;if((0,Re.zM)().getRoomAction(e)===Se.bY.UploadFile)w.A.dispatch({action:"upload_file",context:Sp.Ae.Thread},!0),t=!0;t&&(e.stopPropagation(),e.preventDefault())})),(0,h.A)(this,"onFileDrop",(e=>{const t=this.props.mxEvent.getRoomId();t?mu.Ay.sharedInstance().sendContentListToRoom(Array.from(e.files),t,this.threadRelation,E.J.safeGet(),Sp.Ae.Thread):console.warn("Unknwon roomId for event",this.props.mxEvent)})),(0,h.A)(this,"renderThreadViewHeader",(()=>s.createElement("div",{className:"mx_BaseCard_header_title"},s.createElement(uc.A,{size:"4",className:"mx_BaseCard_header_title_heading"},(0,P._t)("common|thread")),s.createElement(a_,{mxEvent:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator})))),this.setEventId(this.props.mxEvent);const r=null!==(n=this.props.room.getThread(this.eventId))&&void 0!==n?n:void 0;this.state={layout:V.A.getValue("layout"),narrow:!1,thread:r,lastReply:null==r?void 0:r.lastReply((e=>e.isRelation(i.THREAD_RELATION_TYPE.name)&&!e.status))}}componentDidMount(){this.setupThreadListeners(this.state.thread),this.layoutWatcherRef=V.A.watchSetting("layout",null,((...[,,,e])=>this.setState({layout:e}))),this.state.thread&&this.postThreadUpdate(this.state.thread),this.setupThread(this.props.mxEvent),this.dispatcherRef=w.A.register(this.onAction),this.props.room.on(i.ThreadEvent.New,this.onNewThread)}componentWillUnmount(){var e;w.A.unregister(this.dispatcherRef);const t=this.props.mxEvent.getRoomId();V.A.unwatchSetting(this.layoutWatcherRef);const n=Wa.M.instance.roomViewStore.getRoomId()!==t;this.props.initialEvent&&!n&&w.A.dispatch({action:R.r.ViewRoom,room_id:this.props.room.roomId,metricsTrigger:void 0}),w.A.dispatch({action:R.r.ViewThread,thread_id:null}),null===(e=this.state.thread)||void 0===e||e.off(i.ThreadEvent.NewReply,this.updateThreadRelation),this.props.room.off(i.RoomEvent.LocalEchoUpdated,this.updateThreadRelation),this.props.room.removeListener(i.ThreadEvent.New,this.onNewThread)}componentDidUpdate(e){e.mxEvent!==this.props.mxEvent&&(this.setEventId(this.props.mxEvent),this.setupThread(this.props.mxEvent)),e.room!==this.props.room&&rl.A.instance.setCard({phase:sl.n.RoomSummary})}setEventId(e){if(!e.getId())throw new Error("Got thread event without id");this.eventId=e.getId()}get threadLastReply(){var e,t;return null!==(e=null===(t=this.state.thread)||void 0===t?void 0:t.lastReply((e=>e.isRelation(i.THREAD_RELATION_TYPE.name)&&!e.status)))&&void 0!==e?e:void 0}async postThreadUpdate(e){var t,n;w.A.dispatch({action:R.r.ViewThread,thread_id:e.id}),e.emit(i.ThreadEvent.ViewThread),this.updateThreadRelation(),null===(t=this.timelinePanel.current)||void 0===t||t.refreshTimeline(null===(n=this.props.initialEvent)||void 0===n?void 0:n.getId())}setupThreadListeners(e,t){var n;t&&(null===(n=this.state.thread)||void 0===n||n.off(i.ThreadEvent.NewReply,this.updateThreadRelation),this.props.room.off(i.RoomEvent.LocalEchoUpdated,this.updateThreadRelation));e&&(e.on(i.ThreadEvent.NewReply,this.updateThreadRelation),this.props.room.on(i.RoomEvent.LocalEchoUpdated,this.updateThreadRelation))}get threadRelation(){var e,t,n,r;const s={rel_type:i.THREAD_RELATION_TYPE.name,event_id:null===(e=this.state.thread)||void 0===e?void 0:e.id,is_falling_back:!0},o=null!==(t=null===(n=this.state.lastReply)||void 0===n?void 0:n.getId())&&void 0!==t?t:null===(r=this.state.thread)||void 0===r?void 0:r.id;return o&&(s["m.in_reply_to"]={event_id:o}),s}render(){var e,t,n,i;const r=this.props.isInitialEventHighlighted?null===(e=this.props.initialEvent)||void 0===e?void 0:e.getId():void 0,a=this.threadRelation;let l;var c;this.state.thread?(this.props.initialEvent&&this.props.initialEvent.getRoomId()!==this.state.thread.roomId&&o.v.warn("ThreadView attempting to render TimelinePanel with mismatched initialEvent",this.state.thread.roomId,this.props.initialEvent.getRoomId(),this.props.initialEvent.getId()),l=s.createElement(s.Fragment,null,s.createElement(l_,{parent:this.card.current,onFileDrop:this.onFileDrop}),s.createElement(yf,{key:this.state.thread.id,ref:this.timelinePanel,showReadReceipts:this.context.showReadReceipts,manageReadReceipts:!0,manageReadMarkers:!0,sendReadReceiptOnLoad:!0,timelineSet:this.state.thread.timelineSet,showUrlPreview:this.context.showUrlPreview,layout:this.state.layout===zp.P.Bubble?zp.P.Bubble:zp.P.Group,hideThreadedMessages:!1,hidden:!1,showReactions:!0,className:"mx_RoomView_messagePanel",permalinkCreator:this.props.permalinkCreator,membersLoaded:!0,editState:this.state.editState,eventId:null===(c=this.props.initialEvent)||void 0===c?void 0:c.getId(),highlightedEventId:r,eventScrollIntoView:this.props.initialEventScrollIntoView,onEventScrolledIntoView:this.resetJumpToEvent}))):l=s.createElement("div",{className:"mx_RoomView_messagePanelSpinner"},s.createElement(Na.A,null));return s.createElement(Ld.yw,(0,p.A)({},this.context,{timelineRenderingType:Sp.Ae.Thread,threadId:null===(t=this.state.thread)||void 0===t?void 0:t.id,liveTimeline:null===(n=this.state)||void 0===n||null===(n=n.thread)||void 0===n||null===(n=n.timelineSet)||void 0===n?void 0:n.getLiveTimeline(),narrow:this.state.narrow}),s.createElement(Ep.A,{className:re()("mx_ThreadView mx_ThreadPanel",{mx_ThreadView_narrow:this.state.narrow}),onClose:this.props.onClose,withoutScrollContainer:!0,header:this.renderThreadViewHeader(),ref:this.card,onKeyDown:this.onKeyDown,onBack:e=>{y.A.trackInteraction("WebThreadViewBackButton",e)}},this.card.current&&s.createElement(bf,{sensor:this.card.current,onMeasurement:this.onMeasurement}),s.createElement("div",{className:"mx_ThreadView_timelinePanelWrapper"},l),mu.Ay.sharedInstance().getCurrentUploads(a).length>0&&s.createElement(r_,{room:this.props.room,relation:a}),(null===(i=this.state.thread)||void 0===i?void 0:i.timelineSet)&&s.createElement(t_,{room:this.props.room,resizeNotifier:this.props.resizeNotifier,relation:a,replyToEvent:this.state.replyToEvent,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus,compact:!0})))}}function g_(){return g_=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},g_.apply(null,arguments)}(0,h.A)(h_,"contextType",Sp.Ay);var v_=function(e,t){return s.createElement("svg",g_({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",role:"presentation","aria-hidden":!0,ref:t},e),c_||(c_=s.createElement("path",{stroke:"#656D77",strokeLinecap:"round",strokeWidth:1.5,d:"M1.75 2h12.5M1.75 6h12.5M1.75 10h6.5"})),d_||(d_=s.createElement("path",{stroke:"#656D77",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"m6.172 13 2.121 2.121 5.657-5.657"})))},f_=(0,s.forwardRef)(v_);var __=n("./src/accessibility/context_menu/ContextMenuButton.tsx");let y_=function(e){return e[e.My=0]="My",e[e.All=1]="All",e}({});const b_=({label:e,description:t,onClick:n,isSelected:i})=>s.createElement(Fe.sH,{active:i,className:"mx_ThreadPanel_Header_FilterOptionItem",onClick:n},s.createElement("span",null,e),s.createElement("span",null,t)),E_=({filterOption:e,setFilterOption:t})=>{const n=(0,Pe.nH)(),i=(0,Ld.ME)("room"),[r,a,l,c]=(0,Fe.EF)(),d=[{label:(0,P._t)("threads|all_threads"),description:(0,P._t)("threads|all_threads_description"),key:y_.All},{label:(0,P._t)("threads|my_threads"),description:(0,P._t)("threads|my_threads_description"),key:y_.My}],u=d.find((t=>t.key===e)),m=d.map((e=>s.createElement(b_,{key:e.key,label:e.label,description:e.description,onClick:()=>{t(e.key),c()},isSelected:e===u}))),p=r?s.createElement(Fe.Ay,{top:108,right:33,onFinished:c,chevronFace:Fe.t4.Top,wrapperClassName:"mx_BaseCard_header_title"},m):null,h=s.useCallback((e=>{y.A.trackInteraction("WebThreadsMarkAllReadButton",e),i.room?(0,el.G9)(i.room,n).catch((e=>{o.v.error("Failed to mark all threads read",e)})):o.v.error("No room in context to mark all threads read")}),[i.room,n]);return s.createElement("div",{className:"mx_BaseCard_header_title"},s.createElement(Te.m,{label:(0,P._t)("threads|mark_all_read")},s.createElement(Xa.K,{onClick:h,size:"24px"},s.createElement(f_,null))),s.createElement("div",{className:"mx_ThreadPanel_vertical_separator"}),s.createElement(__.V,{className:"mx_ThreadPanel_dropdown",ref:a,isExpanded:r,onClick:e=>{l(),y.A.trackInteraction("WebRightPanelThreadPanelFilterDropdown",e)}},`${(0,P._t)("threads|show_thread_filter")} ${null==u?void 0:u.label}`),p)},w_=({roomId:e,onClose:t,permalinkCreator:n})=>{var r,o,a;const l=(0,s.useContext)(Pe.Ay),c=(0,s.useContext)(Sp.Ay),d=(0,s.useRef)(null),u=(0,s.useRef)(null),m=(0,s.useRef)(null),[h,g]=(0,s.useState)(y_.All),[v,f]=(0,s.useState)(null),[_,y]=(0,s.useState)(!1),b=h===y_.My?null==v?void 0:v.threadsTimelineSets[1]:null==v?void 0:v.threadsTimelineSets[0],E=Boolean(null==v||null===(r=v.threadsTimelineSets)||void 0===r||null===(r=r[0])||void 0===r||null===(r=r.getLiveTimeline())||void 0===r||null===(r=r.getEvents())||void 0===r?void 0:r.length);return(0,s.useEffect)((()=>{const t=l.getRoom(e);null==t||t.createThreadsTimelineSets().then((()=>t.fetchRoomThreads())).then((()=>{g(y_.All),f(t)}))}),[l,e]),(0,s.useEffect)((()=>{var e;b&&!i.Thread.hasServerSideSupport&&(null===(e=d.current)||void 0===e||e.refreshTimeline())}),[b,d]),s.createElement(Ld.yw,(0,p.A)({},c,{timelineRenderingType:Sp.Ae.ThreadsList,showHiddenEvents:!0,narrow:_}),s.createElement(Ep.A,{header:E&&s.createElement(E_,{filterOption:h,setFilterOption:g}),id:"thread-panel",className:"mx_ThreadPanel",ariaLabelledBy:"thread-panel-tab",role:"tabpanel",onClose:t,withoutScrollContainer:!0,ref:u,closeButtonRef:m},u.current&&s.createElement(bf,{sensor:u.current,onMeasurement:y}),b?s.createElement(yf,{key:h+":"+(null!==(o=null===(a=b.getFilter())||void 0===a?void 0:a.filterId)&&void 0!==o?o:e),ref:d,showReadReceipts:!1,manageReadReceipts:!1,manageReadMarkers:!1,sendReadReceiptOnLoad:!1,timelineSet:b,showUrlPreview:!1,empty:s.createElement(Ef,{Icon:hp.A,title:(0,P._t)("threads|empty_title"),description:(0,P._t)("threads|empty_description",{replyInThread:(0,P._t)("action|reply_in_thread")})}),alwaysShowTimestamps:!0,layout:zp.P.Group,hideThreadedMessages:!1,hidden:!1,showReactions:!1,className:"mx_RoomView_messagePanel",membersLoaded:!0,permalinkCreator:n,disableGrouping:!0}):s.createElement("div",{className:"mx_AutoHideScrollbar"},s.createElement(Na.A,null))))};function S_(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{d:"M12 3c7 0 7 7 7 7v6l1.293 1.293c.63.63.184 1.707-.707 1.707H4.414c-.89 0-1.337-1.077-.707-1.707L5 16v-6s0-7 7-7Zm5 7.01v-.022l-.009-.146a6.591 6.591 0 0 0-.073-.607 6.608 6.608 0 0 0-.582-1.84c-.319-.638-.766-1.215-1.398-1.637C14.318 5.344 13.4 5 12 5c-1.4 0-2.317.344-2.937.758-.633.422-1.08.999-1.4 1.636a6.606 6.606 0 0 0-.58 1.841A6.596 6.596 0 0 0 7 9.988v6.84L6.828 17h10.344L17 16.828V10.01ZM12 22a2 2 0 0 1-2-2h4a2 2 0 0 1-2 2Z"})})}S_.displayName="NotificationsIcon";const A_=(0,s.forwardRef)(S_);class C_ extends s.PureComponent{constructor(e,t){super(e,t),(0,h.A)(this,"card",s.createRef()),(0,h.A)(this,"onMeasurement",(e=>{this.setState({narrow:e})})),this.state={narrow:!1}}render(){const e=s.createElement(Ef,{Icon:A_,title:(0,P._t)("notif_panel|empty_heading"),description:(0,P._t)("notif_panel|empty_description")});let t;const n=E.J.safeGet().getNotifTimelineSet();return n?t=s.createElement(yf,{manageReadReceipts:!1,manageReadMarkers:!1,timelineSet:n,showUrlPreview:!1,empty:e,alwaysShowTimestamps:!0,layout:zp.P.Group}):(o.v.error("No notifTimelineSet available!"),t=s.createElement(Na.A,null)),s.createElement(Ld.yw,(0,p.A)({},this.context,{timelineRenderingType:Sp.Ae.Notification,narrow:this.state.narrow}),s.createElement(Ep.A,{header:(0,P._t)("notifications|enable_prompt_toast_title"),className:"mx_ThreadPanel",onClose:this.props.onClose,withoutScrollContainer:!0},this.card.current&&s.createElement(bf,{sensor:this.card.current,onMeasurement:this.onMeasurement}),t))}}function x_(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{d:"M12 16c1.25 0 2.313-.438 3.188-1.313.874-.874 1.312-1.937 1.312-3.187 0-1.25-.438-2.313-1.313-3.188C14.313 7.439 13.25 7 12 7c-1.25 0-2.312.438-3.187 1.313C7.938 9.187 7.5 10.25 7.5 11.5c0 1.25.438 2.313 1.313 3.188C9.688 15.562 10.75 16 12 16Zm0-1.8c-.75 0-1.387-.262-1.912-.787A2.604 2.604 0 0 1 9.3 11.5c0-.75.263-1.387.787-1.912A2.604 2.604 0 0 1 12 8.8c.75 0 1.387.262 1.912.787.525.526.788 1.163.788 1.913s-.262 1.387-.787 1.912A2.604 2.604 0 0 1 12 14.2Zm0 4.8c-2.317 0-4.433-.613-6.35-1.837-1.917-1.226-3.367-2.88-4.35-4.963a.812.812 0 0 1-.1-.313 2.93 2.93 0 0 1 0-.774.812.812 0 0 1 .1-.313c.983-2.083 2.433-3.738 4.35-4.963C7.567 4.614 9.683 4 12 4c2.317 0 4.433.612 6.35 1.838 1.917 1.224 3.367 2.879 4.35 4.962a.81.81 0 0 1 .1.313 2.925 2.925 0 0 1 0 .774.81.81 0 0 1-.1.313c-.983 2.083-2.433 3.738-4.35 4.963C16.433 18.387 14.317 19 12 19Zm0-2a9.544 9.544 0 0 0 5.188-1.488A9.773 9.773 0 0 0 20.8 11.5a9.773 9.773 0 0 0-3.613-4.013A9.544 9.544 0 0 0 12 6a9.545 9.545 0 0 0-5.187 1.487A9.773 9.773 0 0 0 3.2 11.5a9.773 9.773 0 0 0 3.613 4.012A9.544 9.544 0 0 0 12 17Z"})})}(0,h.A)(C_,"contextType",Sp.Ay),x_.displayName="VisibilityOnIcon";const k_=(0,s.forwardRef)(x_);var R_=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/unpin.js");function I_(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{d:"M14.597 5.708a1.004 1.004 0 0 1 0-1.416.996.996 0 0 1 1.412 0l4.699 4.714c.39.39.39 1.025 0 1.416l-4.7 4.714a.996.996 0 0 1-1.411 0 1.004 1.004 0 0 1 0-1.416l3.043-3.054H8.487C6.599 10.666 5 12.27 5 14.333 5.002 16.396 6.6 18 8.488 18h2.093a1 1 0 1 1 0 2H8.487C5.42 20 3 17.425 3 14.333c0-3.092 2.42-5.666 5.486-5.666h9.059l-2.95-2.959Z"})})}I_.displayName="ForwardIcon";const T_=(0,s.forwardRef)(I_);var P_=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/delete.js"),N_=n("./src/components/views/messages/MessageEvent.tsx"),D_=n("./src/events/forward/getForwardableEvent.ts"),M_=(n("./src/events/location/getShareableLocationEvent.ts"),n("./src/components/views/dialogs/ConfirmRedactDialog.tsx"));function O_({event:e,room:t,permalinkCreator:n}){var i,r;const o=e.getSender();if(!o)throw new Error("Pinned event unexpectedly has no sender");const a=Boolean(e.threadRootId),l=!e.isThreadRoot&&a;return s.createElement("div",{className:"mx_PinnedEventTile",role:"listitem"},s.createElement("div",null,s.createElement($p.A,{className:"mx_PinnedEventTile_senderAvatar",member:e.sender,size:"32px",fallbackUserId:o})),s.createElement("div",{className:"mx_PinnedEventTile_wrapper"},s.createElement("div",{className:"mx_PinnedEventTile_top"},s.createElement(Te.m,{label:(null===(i=e.sender)||void 0===i?void 0:i.name)||o},s.createElement("span",{className:re()("mx_PinnedEventTile_sender",(0,lh.yJ)(o))},(null===(r=e.sender)||void 0===r?void 0:r.name)||o)),s.createElement(L_,{event:e,room:t,permalinkCreator:n})),s.createElement(N_.A,{mxEvent:e,maxImageHeight:150,onHeightChanged:()=>{},permalinkCreator:n,replacingEventId:e.replacingEventId()}),l&&s.createElement("div",{className:"mx_PinnedEventTile_thread"},s.createElement(hp.A,null),(0,P._t)("right_panel|pinned_messages|reply_thread",{},{link:n=>s.createElement("button",{type:"button",onClick:()=>{if(!e.threadRootId)return;const n=t.findEventById(e.threadRootId);n&&w.A.dispatch({action:R.r.ShowThread,rootEvent:n,push:!0})}},n)}))))}function L_({event:e,room:t,permalinkCreator:n}){var r;const[o,a]=(0,s.useState)(!1),l=(0,Pe.nH)(),c=(0,s.useCallback)((()=>{y.A.trackInteraction("PinnedMessageListViewTimeline"),w.A.dispatch({action:R.r.ViewRoom,event_id:e.getId(),highlighted:!0,room_id:e.getRoomId(),metricsTrigger:void 0})}),[e]),d=(0,Kh.U)(t,(()=>og.A.canUnpin(l,e))),u=(0,s.useCallback)((async()=>{await og.A.pinOrUnpinEvent(l,e),y.A.trackPinUnpinMessage("Unpin","MessagePinningList")}),[e,l]),m=(0,Vp.qe)(e)&&(0,D_.e)(e,l),p=(0,s.useCallback)((()=>{m&&w.A.dispatch({action:R.r.OpenForwardDialog,event:m,permalinkCreator:n})}),[m,n]),h=(null===(r=t.getLiveTimeline().getState(i.EventTimeline.FORWARDS))||void 0===r?void 0:r.maySendRedactionForEvent(e,l.getSafeUserId()))&&e.getType()!==i.EventType.RoomServerAcl&&e.getType()!==i.EventType.RoomEncryption,g=(0,s.useCallback)((()=>(0,M_.Q)({mxEvent:e})),[e]);return s.createElement($a.W,{open:o,onOpenChange:a,showTitle:!1,title:(0,P._t)("right_panel|pinned_messages|menu"),side:"right",align:"start",trigger:s.createElement(Xa.K,{size:"24px","aria-label":(0,P._t)("right_panel|pinned_messages|menu")},s.createElement(Rg.A,null))},s.createElement(Ya.D,{Icon:k_,label:(0,P._t)("right_panel|pinned_messages|view"),onSelect:c}),d&&s.createElement(Ya.D,{Icon:R_.A,label:(0,P._t)("action|unpin"),onSelect:u}),m&&s.createElement(Ya.D,{Icon:T_,label:(0,P._t)("action|forward"),onSelect:p}),h&&s.createElement(s.Fragment,null,s.createElement(Hm.w,null),s.createElement(Ya.D,{kind:"critical",Icon:P_.A,label:(0,P._t)("action|delete"),onSelect:g})))}function F_({matrixClient:e,roomId:t,onFinished:n}){return s.createElement(Pa.A,{hasCancel:!0,title:(0,P._t)("right_panel|pinned_messages|unpin_all|title"),titleClass:"mx_UnpinAllDialog_title",className:"mx_UnpinAllDialog",onFinished:n,fixedWidth:!1},s.createElement(Qa.E,{as:"span"},(0,P._t)("right_panel|pinned_messages|unpin_all|content")),s.createElement("div",{className:"mx_UnpinAllDialog_buttons"},s.createElement(Sl.$,{destructive:!0,onClick:async()=>{try{await og.A.unpinAllEvents(e,t),y.A.trackPinUnpinMessage("Unpin","UnpinAll")}catch(e){o.v.error("Failed to unpin all events:",e)}n()}},(0,P._t)("action|continue")),s.createElement(Sl.$,{kind:"tertiary",onClick:n},(0,P._t)("action|cancel"))))}function U_({room:e,onClose:t,permalinkCreator:n}){const r=(0,Pe.nH)(),o=(0,s.useContext)(Sp.Ay),a=cg(e),l=(e=>{const[t,n]=(0,s.useState)(new Set),r=(0,s.useCallback)((t=>{t&&t.getType()!==rg.M||n(dg(e))}),[e]);return(0,Me.YK)(e,i.RoomEvent.AccountData,r),(0,s.useEffect)((()=>(n(dg(e)),()=>{n(new Set)})),[e]),t})(e),c=mg(e,a);let d;return(0,s.useEffect)((()=>{if(!r||r.isGuest())return;a.filter((e=>!l.has(e))).length>0&&r.setRoomAccountData(e.roomId,rg.M,{event_ids:a})}),[r,e.roomId,a,l]),d=a.length?null!=c&&c.length?s.createElement(B_,{events:(0,Vg.Bo)(c),room:e,permalinkCreator:n}):s.createElement(Na.A,null):s.createElement(Ef,{Icon:fp.A,title:(0,P._t)("right_panel|pinned_messages|empty_title"),description:(0,P._t)("right_panel|pinned_messages|empty_description",{pinAction:(0,P._t)("action|pin")})}),s.createElement(Ep.A,{header:(0,P._t)("right_panel|pinned_messages|header",{count:a.length}),className:"mx_PinnedMessagesCard",onClose:t},s.createElement(Ld.yw,(0,p.A)({},o,{timelineRenderingType:Sp.Ae.Pinned}),d))}function B_({events:e,room:t,permalinkCreator:n}){const i=(0,Pe.nH)(),r=(0,Kh.U)(t,(()=>og.A.userHasPinOrUnpinPermission(i,t))),o=(0,s.useCallback)((async()=>{A.Ay.createDialog(F_,{roomId:t.roomId,matrixClient:i})}),[t,i]);return s.createElement(s.Fragment,null,s.createElement("div",{className:re()("mx_PinnedMessagesCard_wrapper",{mx_PinnedMessagesCard_wrapper_unpin_all:r}),role:"list"},e.map(((i,r)=>s.createElement(s.Fragment,null,s.createElement(O_,{key:i.getId(),event:i,permalinkCreator:n,room:t}),e.length-1!==r&&s.createElement(Hm.w,{key:`separator-${i.getId()}`,className:"mx_PinnedMessagesCard_Separator"}))))),r&&s.createElement("div",{className:"mx_PinnedMessagesCard_unpin"},s.createElement(Sl.$,{kind:"tertiary",onClick:o},(0,P._t)("right_panel|pinned_messages|unpin_all|button"))))}const V_=e=>{const t=re()({mx_JumpToBottomButton:!0,mx_JumpToBottomButton_highlight:e.highlight});let n;return e.numUnreadMessages&&(n=s.createElement("div",{className:"mx_JumpToBottomButton_badge"},e.numUnreadMessages)),s.createElement("div",{className:t},s.createElement(Ae.A,{className:"mx_JumpToBottomButton_scrollDown",title:(0,P._t)("room|jump_to_bottom_button"),onClick:e.onScrollToBottomClick}),n)};class j_ extends s.Component{constructor(e,t){super(e,t),(0,h.A)(this,"dispatcherRef",void 0),(0,h.A)(this,"layoutWatcherRef",void 0),(0,h.A)(this,"timelinePanel",s.createRef()),(0,h.A)(this,"card",s.createRef()),(0,h.A)(this,"readReceiptsSettingWatcher",void 0),(0,h.A)(this,"onRoomViewStoreUpdate",(async e=>{const t={initialEventId:Wa.M.instance.roomViewStore.getInitialEventId(),isInitialEventHighlighted:Wa.M.instance.roomViewStore.isInitialEventHighlighted(),replyToEvent:Wa.M.instance.roomViewStore.getQuotingEvent()};this.setState(t)})),(0,h.A)(this,"onAction",(e=>{if(e.action===R.r.EditEvent)this.setState({editState:e.event?new n_(e.event):void 0},(()=>{var t;e.event&&(null===(t=this.timelinePanel.current)||void 0===t||t.scrollToEventIfNeeded(e.event.getId()))}))})),(0,h.A)(this,"onScroll",(()=>{const e=this.timelinePanel.current;e&&(e.isAtEndOfLiveTimeline()?this.setState({atEndOfLiveTimeline:!0}):this.setState({atEndOfLiveTimeline:!1}),this.state.initialEventId&&this.state.isInitialEventHighlighted&&w.A.dispatch({action:R.r.ViewRoom,room_id:this.props.room.roomId,event_id:this.state.initialEventId,highlighted:!1,replyingToEvent:this.state.replyToEvent,metricsTrigger:void 0}))})),(0,h.A)(this,"onMeasurement",(e=>{this.setState({narrow:e})})),(0,h.A)(this,"jumpToLiveTimeline",(()=>{var e;this.state.initialEventId&&this.state.isInitialEventHighlighted?w.A.dispatch({action:R.r.ViewRoom,room_id:this.props.room.roomId}):(null===(e=this.timelinePanel.current)||void 0===e||e.jumpToLiveTimeline(),w.A.fire(R.r.FocusSendMessageComposer))})),this.state={showReadReceipts:V.A.getValue("showReadReceipts",e.room.roomId),layout:V.A.getValue("layout"),atEndOfLiveTimeline:!0,narrow:!1}}componentDidMount(){Wa.M.instance.roomViewStore.addListener(I.H,this.onRoomViewStoreUpdate),this.dispatcherRef=w.A.register(this.onAction),this.readReceiptsSettingWatcher=V.A.watchSetting("showReadReceipts",null,((...[,,,e])=>this.setState({showReadReceipts:e}))),this.layoutWatcherRef=V.A.watchSetting("layout",null,((...[,,,e])=>this.setState({layout:e})))}componentWillUnmount(){Wa.M.instance.roomViewStore.removeListener(I.H,this.onRoomViewStoreUpdate),V.A.unwatchSetting(this.readReceiptsSettingWatcher),V.A.unwatchSetting(this.layoutWatcherRef),w.A.unregister(this.dispatcherRef)}render(){var e,t;const n=this.state.isInitialEventHighlighted?this.state.initialEventId:void 0;let r;this.state.atEndOfLiveTimeline||(r=s.createElement(V_,{highlight:this.props.room.getUnreadNotificationCount(i.NotificationCountType.Highlight)>0,onScrollToBottomClick:this.jumpToLiveTimeline}));const o=mu.Ay.sharedInstance().getCurrentUploads(this.props.composerRelation).length>0,a=this.props.room.getMyMembership()===oa.O.Join;return s.createElement(Ld.yw,(0,p.A)({},this.context,{timelineRenderingType:null!==(e=this.props.timelineRenderingType)&&void 0!==e?e:this.context.timelineRenderingType,liveTimeline:null===(t=this.props.timelineSet)||void 0===t?void 0:t.getLiveTimeline(),narrow:this.state.narrow}),s.createElement(Ep.A,{className:this.props.classNames,onClose:this.props.onClose,withoutScrollContainer:!0,header:(0,P._t)("right_panel|video_room_chat|title"),ref:this.card},this.card.current&&s.createElement(bf,{sensor:this.card.current,onMeasurement:this.onMeasurement}),s.createElement("div",{className:"mx_TimelineCard_timeline"},r,s.createElement(yf,{ref:this.timelinePanel,showReadReceipts:this.state.showReadReceipts,manageReadReceipts:!0,manageReadMarkers:!1,sendReadReceiptOnLoad:!0,timelineSet:this.props.timelineSet,showUrlPreview:this.context.showUrlPreview,layout:this.state.layout===zp.P.Bubble?zp.P.Bubble:zp.P.Group,hideThreadedMessages:!1,hidden:!1,showReactions:!0,className:"mx_RoomView_messagePanel",permalinkCreator:this.props.permalinkCreator,membersLoaded:!0,editState:this.state.editState,eventId:this.state.initialEventId,resizeNotifier:this.props.resizeNotifier,highlightedEventId:n,onScroll:this.onScroll})),o&&s.createElement(r_,{room:this.props.room,relation:this.props.composerRelation}),a&&s.createElement(t_,{room:this.props.room,relation:this.props.composerRelation,resizeNotifier:this.props.resizeNotifier,replyToEvent:this.state.replyToEvent,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus,compact:!0})))}}(0,h.A)(j_,"contextType",Sp.Ay);var z_=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/plus.js");const W_=({app:e,room:t})=>{const n=wg.A.getWidgetName(e),[i,r]=(0,s.useState)();(0,s.useEffect)((()=>{r(wg.A.canUserModifyWidgets(t.client,t.roomId))}),[t.client,t.roomId]);const o=Sv.aK.instance.isInContainer(t,e,Sv.mc.Top),a=o?()=>{Sv.aK.instance.moveToContainer(t,e,Sv.mc.Right)}:()=>{Sv.aK.instance.moveToContainer(t,e,Sv.mc.Top)},[l,c,d,u]=(0,Fe.EF)();let m;if(l){var p,h,g;const t=null===(p=c.current)||void 0===p?void 0:p.getBoundingClientRect(),n=null!==(h=null==t?void 0:t.right)&&void 0!==h?h:0,i=null!==(g=null==t?void 0:t.top)&&void 0!==g?g:0;m=s.createElement(Mv,{chevronFace:Fe.t4.None,right:Ie.A.instance.windowWidth-n,bottom:Ie.A.instance.windowHeight-i,onFinished:u,app:e})}const v=!o&&!Sv.aK.instance.canAddToContainer(t,Sv.mc.Top);let f;f=v?(0,P._t)("right_panel|pinned_messages|limits",{count:Sv.yQ}):o?(0,P._t)("action|unpin"):(0,P._t)("action|pin");const _=Sv.aK.instance.isInContainer(t,e,Sv.mc.Center);let y="";o?y=(0,P._t)("widget|unpin_to_view_right_panel"):_&&(y=(0,P._t)("widget|close_to_view_right_panel"));const b=re()("mx_BaseCard_Button mx_ExtensionsCard_Button",{mx_ExtensionsCard_Button_pinned:o});return s.createElement("div",{className:b,ref:c},s.createElement(Ae.A,{className:"mx_ExtensionsCard_icon_app",onClick:()=>{rl.A.instance.pushCard({phase:sl.n.Widget,state:{widgetId:e.id}})},title:o||_?y:void 0,disabled:o||_},s.createElement(Lv,{app:e,size:"24px"}),s.createElement(Qa.E,{size:"md",weight:"medium",className:"mx_lineClamp"},n)),i&&s.createElement(Fe.oW,{className:"mx_ExtensionsCard_app_options",isExpanded:l,onClick:d,title:(0,P._t)("common|options")}),s.createElement(Ae.A,{className:"mx_ExtensionsCard_app_pinToggle",onClick:a,title:f,disabled:v}),m)},H_=({room:e,onClose:t})=>{const n=(0,wg.X)(e),i=(0,s.useMemo)((()=>n.filter((e=>void 0!==e.eventId))),[n]);let r;if(i.length<1)r=s.createElement(Ef,{Icon:up,title:(0,P._t)("right_panel|extensions_empty_title"),description:(0,P._t)("right_panel|extensions_empty_description",{addIntegrations:(0,P._t)("right_panel|add_integrations")})});else{let t=null;Sv.aK.instance.canCopyLayoutToRoom(e)&&(t=s.createElement(bu,{onClick:()=>Sv.aK.instance.copyLayoutToRoom(e)},(0,P._t)("widget|set_room_layout"))),r=s.createElement(s.Fragment,null,s.createElement(Hm.w,null),i.map((t=>s.createElement(W_,{key:t.id,app:t,room:e}))),t)}return s.createElement(Ep.A,{header:(0,P._t)("right_panel|extensions_button"),className:"mx_ExtensionsCard",onClose:t},s.createElement(Sl.$,{size:"sm",onClick:()=>{const t=sv.J.sharedInstance();var n;t.hasManager()?null===(n=t.getPrimaryManager())||void 0===n||n.open(e):t.openNoManagerDialog()},kind:"secondary",Icon:z_.A},(0,P._t)("right_panel|add_integrations")),r)};function G_(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}class K_ extends s.Component{constructor(e,t){super(e,t),(0,h.A)(this,"delayedUpdate",(0,v.throttle)((()=>{this.forceUpdate()}),500,{leading:!0,trailing:!0})),(0,h.A)(this,"onRoomStateMember",((e,t,n)=>{var i;this.props.room&&n.roomId===this.props.room.roomId&&(this.state.phase===sl.n.MemberList||this.state.phase===sl.n.MemberInfo&&n.userId===(null===(i=this.state.cardState)||void 0===i||null===(i=i.member)||void 0===i?void 0:i.userId))&&this.delayedUpdate()})),(0,h.A)(this,"onRightPanelStoreUpdate",(()=>{this.setState(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?G_(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):G_(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},K_.getDerivedStateFromProps(this.props)))})),(0,h.A)(this,"onClose",(()=>{var e,t;if(null!==(e=this.props.overwriteCard)&&void 0!==e&&null!==(e=e.state)&&void 0!==e&&e.member)w.A.dispatch({action:R.r.ViewHomePage});else if(this.state.phase===sl.n.EncryptionPanel&&null!==(t=this.state.cardState)&&void 0!==t&&null!==(t=t.verificationRequest)&&void 0!==t&&t.pending)this.state.cardState.verificationRequest.cancel();else{var n,i;rl.A.instance.togglePanel(null!==(n=null===(i=this.props.room)||void 0===i?void 0:i.roomId)&&void 0!==n?n:null)}})),(0,h.A)(this,"onSearchQueryChanged",(e=>{this.setState({searchQuery:e})})),this.state={searchQuery:""}}componentDidMount(){this.context.on(i.RoomStateEvent.Members,this.onRoomStateMember),rl.A.instance.on(I.H,this.onRightPanelStoreUpdate)}componentWillUnmount(){var e;null===(e=this.context)||void 0===e||e.removeListener(i.RoomStateEvent.Members,this.onRoomStateMember),rl.A.instance.off(I.H,this.onRightPanelStoreUpdate)}static getDerivedStateFromProps(e){var t,n,i;let r;return e.room&&(r=rl.A.instance.currentCardForRoom(e.room.roomId)),{cardState:null===(t=r)||void 0===t?void 0:t.state,phase:null!==(n=null===(i=r)||void 0===i?void 0:i.phase)&&void 0!==n?n:void 0}}render(){var e,t,n,r,o;let a=s.createElement("div",null);const l=null===(e=this.props.room)||void 0===e?void 0:e.roomId,c=null!==(t=null===(n=this.props.overwriteCard)||void 0===n?void 0:n.phase)&&void 0!==t?t:this.state.phase,d=null!==(r=null===(o=this.props.overwriteCard)||void 0===o?void 0:o.state)&&void 0!==r?r:this.state.cardState;switch(c){case sl.n.MemberList:l&&(a=s.createElement(of,{roomId:l,key:l,onClose:this.onClose,searchQuery:this.state.searchQuery,onSearchQueryChanged:this.onSearchQueryChanged}));break;case sl.n.MemberInfo:case sl.n.EncryptionPanel:if(null!=d&&d.member){var u;const e=d.member instanceof i.RoomMember?d.member:void 0;a=s.createElement(af.Ay,{user:d.member,room:null!==(u=this.context.getRoom(null==e?void 0:e.roomId))&&void 0!==u?u:this.props.room,key:null!=l?l:d.member.userId,onClose:this.onClose,phase:c,verificationRequest:d.verificationRequest,verificationRequestPromise:d.verificationRequestPromise})}break;case sl.n.ThreePidMemberInfo:null!=d&&d.memberInfoEvent&&(a=s.createElement(lf,{event:d.memberInfoEvent,key:l,onClose:this.onClose}));break;case sl.n.NotificationPanel:a=s.createElement(C_,{onClose:this.onClose});break;case sl.n.PinnedMessages:this.props.room&&(a=s.createElement(U_,{room:this.props.room,onClose:this.onClose,permalinkCreator:this.props.permalinkCreator}));break;case sl.n.Timeline:this.props.room&&(a=s.createElement(j_,{classNames:"mx_ThreadPanel mx_TimelineCard",room:this.props.room,timelineSet:this.props.room.getUnfilteredTimelineSet(),resizeNotifier:this.props.resizeNotifier,onClose:this.onClose,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus}));break;case sl.n.FilePanel:l&&(a=s.createElement(Sf,{roomId:l,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose}));break;case sl.n.ThreadView:this.props.room&&null!=d&&d.threadHeadEvent&&(a=s.createElement(h_,{room:this.props.room,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose,mxEvent:d.threadHeadEvent,initialEvent:d.initialEvent,isInitialEventHighlighted:d.isInitialEventHighlighted,initialEventScrollIntoView:d.initialEventScrollIntoView,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus}));break;case sl.n.ThreadPanel:this.props.room&&(a=s.createElement(w_,{roomId:this.props.room.roomId,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose,permalinkCreator:this.props.permalinkCreator}));break;case sl.n.RoomSummary:this.props.room&&(a=s.createElement(Eg,{room:this.props.room,permalinkCreator:this.props.permalinkCreator,onSearchChange:this.props.onSearchChange,onSearchCancel:this.props.onSearchCancel,focusRoomSearch:null==d?void 0:d.focusRoomSearch}));break;case sl.n.Extensions:this.props.room&&(a=s.createElement(H_,{room:this.props.room,onClose:this.onClose}));break;case sl.n.Widget:this.props.room&&null!=d&&d.widgetId&&(a=s.createElement(jv,{room:this.props.room,widgetId:d.widgetId,onClose:this.onClose}))}return s.createElement("aside",{className:"mx_RightPanel",id:"mx_RightPanel"},a)}}(0,h.A)(K_,"contextType",Pe.Ay);class J_{constructor(){(0,h.A)(this,"scrollStateMap",new Map)}getScrollState(e){return this.scrollStateMap.get(e)}setScrollState(e,t){null===t?this.scrollStateMap.delete(e):this.scrollStateMap.set(e,t)}}void 0===window.mxRoomScrollStateStore&&(window.mxRoomScrollStateStore=new J_);const q_=window.mxRoomScrollStateStore;var $_=n("./src/stores/WidgetEchoStore.ts"),Y_=n("./src/utils/ShieldUtils.ts"),Z_=n("./node_modules/@matrix-org/react-sdk-module-api/lib/lifecycles/RoomViewLifecycle.js"),X_=n("./src/IdentityAuthClient.tsx");class Q_ extends s.PureComponent{constructor(e){super(e),(0,h.A)(this,"onViewClick",(()=>{this.setState({hidden:!1})})),this.state={hidden:!0}}render(){const e=re()({mx_InviteReason:!0,mx_InviteReason_hidden:this.state.hidden});return s.createElement("div",{className:e},s.createElement("div",{className:"mx_InviteReason_reason"},this.props.htmlReason?(0,qh.bk)(this.props.htmlReason):this.props.reason),s.createElement(Ae.A,{kind:"link_inline",className:"mx_InviteReason_view",onClick:this.onViewClick},(0,P._t)("common|view_message")))}}var ey=n("./res/img/element-icons/ask-to-join.svg");var ty=function(e){return e.NotLoggedIn="NotLoggedIn",e.Joining="Joining",e.Loading="Loading",e.Rejecting="Rejecting",e.Kicked="Kicked",e.Banned="Banned",e.OtherThreePIDError="OtherThreePIDError",e.InvitedEmailNotFoundInAccount="InvitedEmailNotFoundInAccount",e.InvitedEmailNoIdentityServer="InvitedEmailNoIdentityServer",e.InvitedEmailMismatch="InvitedEmailMismatch",e.Invite="Invite",e.ViewingRoom="ViewingRoom",e.RoomNotFound="RoomNotFound",e.OtherError="OtherError",e.PromptAskToJoin="PromptAskToJoin",e.Knocked="Knocked",e.RequestDenied="requestDenied",e}(ty||{});class ny extends s.Component{constructor(e){super(e),(0,h.A)(this,"onLoginClick",(()=>{w.A.dispatch({action:"start_login",screenAfterLogin:this.makeScreenAfterLogin()})})),(0,h.A)(this,"onRegisterClick",(()=>{w.A.dispatch({action:"start_registration",screenAfterLogin:this.makeScreenAfterLogin()})})),(0,h.A)(this,"onChangeReason",(e=>{this.setState({reason:e.target.value})})),this.state={busy:!1}}componentDidMount(){this.checkInvitedEmail()}componentDidUpdate(e,t){this.props.invitedEmail===e.invitedEmail&&this.props.inviterName===e.inviterName||this.checkInvitedEmail()}async checkInvitedEmail(){if(this.props.inviterName&&this.props.invitedEmail){this.setState({busy:!0});try{const e=await E.J.safeGet().getThreePids();if(this.setState({accountEmails:e.threepids.filter((e=>"email"===e.medium)).map((e=>e.address))}),!E.J.safeGet().getIdentityServerUrl())return void this.setState({busy:!1});const t=new X_.A,n=await t.getAccessToken(),i=await E.J.safeGet().lookupThreePid("email",this.props.invitedEmail,n);if(!("mxid"in i))throw new P.P7("room|error_3pid_invite_email_lookup");this.setState({invitedEmailMxid:i.mxid})}catch(e){this.setState({threePidFetchError:e})}this.setState({busy:!1})}}getMessageCase(){if(E.J.safeGet().isGuest())return ty.NotLoggedIn;const e=this.getMyMember();if(e){var t;const n=null===(t=e.events.member)||void 0===t?void 0:t.getPrevContent().membership;if(e.isKicked())return n===oa.O.Knock?ty.RequestDenied:this.props.promptAskToJoin?ty.PromptAskToJoin:ty.Kicked;if(e.membership===oa.O.Ban)return ty.Banned}if(this.props.joining)return ty.Joining;if(this.props.rejecting)return ty.Rejecting;if(this.props.loading||this.state.busy)return ty.Loading;if(this.props.knocked)return ty.Knocked;if(this.props.canAskToJoinAndMembershipIsLeave||this.props.promptAskToJoin)return ty.PromptAskToJoin;if(this.props.inviterName){if(this.props.invitedEmail){if(this.state.threePidFetchError)return ty.OtherThreePIDError;if(this.state.accountEmails&&!this.state.accountEmails.includes(this.props.invitedEmail))return ty.InvitedEmailNotFoundInAccount;if(!E.J.safeGet().getIdentityServerUrl())return ty.InvitedEmailNoIdentityServer;if(this.state.invitedEmailMxid!=E.J.safeGet().getUserId())return ty.InvitedEmailMismatch}return ty.Invite}return this.props.error?"M_NOT_FOUND"==this.props.error.errcode?ty.RoomNotFound:ty.OtherError:ty.ViewingRoom}getKickOrBanInfo(){var e,t,n,i;const r=this.getMyMember();if(!r)return{};const s=null===(e=r.events.member)||void 0===e?void 0:e.getSender(),o=s?null===(t=this.props.room)||void 0===t?void 0:t.currentState.getMember(s):void 0;return{memberName:null!==(n=null==o?void 0:o.name)&&void 0!==n?n:s,reason:null===(i=r.events.member)||void 0===i?void 0:i.getContent().reason}}joinRule(){var e,t;return null!==(e=null===(t=this.props.room)||void 0===t||null===(t=t.currentState.getStateEvents(i.EventType.RoomJoinRules,""))||void 0===t?void 0:t.getContent().join_rule)&&void 0!==e?e:null}getMyMember(){var e,t;return null!==(e=null===(t=this.props.room)||void 0===t?void 0:t.getMember(E.J.safeGet().getSafeUserId()))&&void 0!==e?e:null}getInviteMember(){var e;const{room:t}=this.props;if(!t)return null;const n=E.J.safeGet().getSafeUserId(),i=t.currentState.getMember(n);if(!i)return null;const r=null===(e=i.events.member)||void 0===e?void 0:e.getSender();return r?t.currentState.getMember(r):null}isDMInvite(){var e;const t=this.getMyMember();if(!t)return!1;const n=null===(e=t.events.member)||void 0===e?void 0:e.getContent();return(null==n?void 0:n.membership)===oa.O.Invite&&n.is_direct}makeScreenAfterLogin(){var e,t,n,i,r,s;return{screen:"room",params:{email:this.props.invitedEmail,signurl:this.props.signUrl,room_name:null!==(e=null===(t=this.props.oobData)||void 0===t?void 0:t.name)&&void 0!==e?e:null,room_avatar_url:null!==(n=null===(i=this.props.oobData)||void 0===i?void 0:i.avatarUrl)&&void 0!==n?n:null,inviter_name:null!==(r=null===(s=this.props.oobData)||void 0===s?void 0:s.inviterName)&&void 0!==r?r:null}}}render(){var e,t,n,r,o,a;const l=u.Ay.get().brand,c=null!==(e=null!==(t=null===(n=this.props.room)||void 0===n?void 0:n.name)&&void 0!==t?t:this.props.roomAlias)&&void 0!==e?e:"",d=null!==(r=null===(o=this.props.room)||void 0===o?void 0:o.isSpaceRoom())&&void 0!==r?r:(null===(a=this.props.oobData)||void 0===a?void 0:a.roomType)===i.RoomType.Space;let m,p,h,g,v,f,_,y,b=!1;const w=[],S=this.getMessageCase();switch(S){case ty.Joining:var A;m=null!==(A=this.props.oobData)&&void 0!==A&&A.roomType||d?d?(0,P._t)("room|joining_space"):(0,P._t)("room|joining_room"):(0,P._t)("room|joining"),b=!0;break;case ty.Loading:m=(0,P._t)("common|loading"),b=!0;break;case ty.Rejecting:m=(0,P._t)("room|rejecting"),b=!0;break;case ty.NotLoggedIn:{const e={canJoin:!1};this.props.roomId&&ev.r.instance.invoke(Z_.J.PreviewRoomNotLoggedIn,e,this.props.roomId),e.canJoin?(m=(0,P._t)("room|join_title"),v=(0,P._t)("action|join"),g=()=>{ev.r.instance.invoke(Z_.J.JoinFromRoomPreview,this.props.roomId)}):(m=(0,P._t)("room|join_title_account"),V.A.getValue($.f.Registration)&&(v=(0,P._t)("room|join_button_account"),g=this.onRegisterClick),_=(0,P._t)("action|sign_in"),f=this.onLoginClick),this.props.previewLoading&&(y=s.createElement("div",null,s.createElement(Na.A,{w:20,h:20}),(0,P._t)("room|loading_preview")));break}case ty.Kicked:{const{memberName:e,reason:t}=this.getKickOrBanInfo();m=c?(0,P._t)("room|kicked_from_room_by",{memberName:e,roomName:c}):(0,P._t)("room|kicked_by",{memberName:e}),p=t?(0,P._t)("room|kick_reason",{reason:t}):void 0,v=d?(0,P._t)("room|forget_space"):(0,P._t)("room|forget_room"),g=this.props.onForgetClick,this.joinRule()!==i.JoinRule.Invite&&(_=v,f=g,v=(0,P._t)("room|rejoin_button"),g=this.props.onJoinClick);break}case ty.RequestDenied:m=(0,P._t)("room|knock_denied_title"),p=(0,P._t)("room|knock_denied_subtitle"),v=d?(0,P._t)("room|forget_space"):(0,P._t)("room|forget_room"),g=this.props.onForgetClick;break;case ty.Banned:{const{memberName:e,reason:t}=this.getKickOrBanInfo();m=c?(0,P._t)("room|banned_from_room_by",{memberName:e,roomName:c}):(0,P._t)("room|banned_by",{memberName:e}),p=t?(0,P._t)("room|kick_reason",{reason:t}):void 0,v=d?(0,P._t)("room|forget_space"):(0,P._t)("room|forget_room"),g=this.props.onForgetClick;break}case ty.OtherThreePIDError:{var C;m=c?(0,P._t)("room|3pid_invite_error_title_room",{roomName:c}):(0,P._t)("room|3pid_invite_error_title");const e=this.joinRule(),t=(0,P._t)("room|3pid_invite_error_description",{errcode:(null===(C=this.state.threePidFetchError)||void 0===C?void 0:C.errcode)||(0,P._t)("error|unknown_error_code")});switch(e){case"invite":p=[(0,P._t)("room|3pid_invite_error_invite_subtitle"),t],v=(0,P._t)("room|3pid_invite_error_invite_action"),g=this.props.onJoinClick;break;case"public":p=(0,P._t)("room|3pid_invite_error_public_subtitle"),v=(0,P._t)("room|join_the_discussion"),g=this.props.onJoinClick;break;default:p=t,v=(0,P._t)("room|3pid_invite_error_invite_action"),g=this.props.onJoinClick}break}case ty.InvitedEmailNotFoundInAccount:m=c?(0,P._t)("room|3pid_invite_email_not_found_account_room",{roomName:c,email:this.props.invitedEmail}):(0,P._t)("room|3pid_invite_email_not_found_account",{email:this.props.invitedEmail}),p=(0,P._t)("room|link_email_to_receive_3pid_invite",{brand:l}),v=(0,P._t)("room|join_the_discussion"),g=this.props.onJoinClick;break;case ty.InvitedEmailNoIdentityServer:m=c?(0,P._t)("room|invite_sent_to_email_room",{roomName:c,email:this.props.invitedEmail}):(0,P._t)("room|invite_sent_to_email",{email:this.props.invitedEmail}),p=(0,P._t)("room|3pid_invite_no_is_subtitle",{brand:l}),v=(0,P._t)("room|join_the_discussion"),g=this.props.onJoinClick;break;case ty.InvitedEmailMismatch:m=c?(0,P._t)("room|invite_sent_to_email_room",{roomName:c,email:this.props.invitedEmail}):(0,P._t)("room|invite_sent_to_email",{email:this.props.invitedEmail}),p=(0,P._t)("room|invite_email_mismatch_suggestion",{brand:l}),v=(0,P._t)("room|join_the_discussion"),g=this.props.onJoinClick;break;case ty.Invite:{var x,k,R;const e=this.isDMInvite(),t=s.createElement(aa.A,{room:this.props.room,oobData:this.props.oobData}),n=this.getInviteMember(),i=s.createElement("span",{className:"mx_RoomPreviewBar_inviter"},null!==(x=null==n?void 0:n.rawDisplayName)&&void 0!==x?x:this.props.inviterName),r=s.createElement(s.Fragment,null,e?(0,P._t)("room|dm_invite_subtitle",{},{userName:i}):(0,P._t)("room|invite_subtitle",{},{userName:i}),n&&s.createElement(s.Fragment,null,s.createElement("br",null),s.createElement("span",{className:"mx_RoomPreviewBar_inviter_mxid"},n.userId)));var I;if(e)m=(0,P._t)("room|dm_invite_title",{user:null!==(I=null==n?void 0:n.name)&&void 0!==I?I:this.props.inviterName}),v=(0,P._t)("room|dm_invite_action");else m=(0,P._t)("room|invite_title",{roomName:c}),v=(0,P._t)("action|accept");p=[t,r];const o=E.J.safeGet().getSafeUserId(),a=null===(k=this.props.room)||void 0===k?void 0:k.currentState.getMember(o),l=null==a||null===(R=a.events.member)||void 0===R?void 0:R.getContent();null!=l&&l.reason&&(h=s.createElement(Q_,{reason:l.reason,htmlReason:l["io.element.html_reason"]})),g=this.props.onJoinClick,_=(0,P._t)("action|reject"),f=this.props.onRejectClick,this.props.onRejectAndIgnoreClick&&w.push(s.createElement(Ae.A,{kind:"secondary",onClick:this.props.onRejectAndIgnoreClick,key:"ignore"},(0,P._t)("room|invite_reject_ignore")));break}case ty.ViewingRoom:m=this.props.canPreview?(0,P._t)("room|peek_join_prompt",{roomName:c}):c?(0,P._t)("room|no_peek_join_prompt",{roomName:c}):(0,P._t)("room|no_peek_no_name_join_prompt"),v=(0,P._t)("room|join_the_discussion"),g=this.props.onJoinClick;break;case ty.RoomNotFound:m=c?(0,P._t)("room|not_found_title_name",{roomName:c}):(0,P._t)("room|not_found_title"),p=(0,P._t)("room|not_found_subtitle");break;case ty.OtherError:var T;m=c?(0,P._t)("room|inaccessible_name",{roomName:c}):(0,P._t)("room|inaccessible"),p=[(0,P._t)("room|inaccessible_subtitle_1"),(0,P._t)("room|inaccessible_subtitle_2",{errcode:String(null===(T=this.props.error)||void 0===T?void 0:T.errcode)},{issueLink:e=>s.createElement("a",{href:u.Ay.get().feedback.new_issue_url,target:"_blank",rel:"noreferrer noopener"},e)})];break;case ty.PromptAskToJoin:var N;m=c?(0,P._t)("room|knock_prompt_name",{roomName:c}):(0,P._t)("room|knock_prompt");p=[s.createElement(aa.A,{room:this.props.room,oobData:this.props.oobData}),(0,P._t)("room|knock_subtitle")],h=s.createElement(Sa.A,{autoFocus:!0,className:"mx_RoomPreviewBar_fullWidth",element:"textarea",onChange:this.onChangeReason,placeholder:(0,P._t)("room|knock_message_field_placeholder"),type:"text",value:null!==(N=this.state.reason)&&void 0!==N?N:""}),g=()=>this.props.onSubmitAskToJoin&&this.props.onSubmitAskToJoin(this.state.reason),v=(0,P._t)("room|knock_send_action");break;case ty.Knocked:m=(0,P._t)("room|knock_sent"),p=[s.createElement(s.Fragment,null,s.createElement(ey.I,{className:"mx_Icon mx_Icon_16 mx_RoomPreviewBar_icon"}),(0,P._t)("room|knock_sent_subtitle"))],f=this.props.onCancelAskToJoin,_=(0,P._t)("room|knock_cancel_action")}let D,M,O,L;p&&(Array.isArray(p)||(p=[p]),D=p.map(((e,t)=>s.createElement("p",{key:`subTitle${t}`},e)))),M=b?s.createElement("h3",{className:"mx_RoomPreviewBar_spinnerTitle"},s.createElement(Na.A,null),m):s.createElement("h3",null,m),g&&(O=s.createElement(Ae.A,{kind:"primary",onClick:g},v)),f&&(L=s.createElement(Ae.A,{kind:"secondary",onClick:f},_));const F=this.props.canPreview,U=re()("mx_RoomPreviewBar",`mx_RoomPreviewBar_${S}`,{mx_RoomPreviewBar_panel:F,mx_RoomPreviewBar_dialog:!F}),B=F?s.createElement(s.Fragment,null,L,w,O):s.createElement(s.Fragment,null,O,w,L);return s.createElement("div",{role:"complementary",className:U},s.createElement("div",{className:"mx_RoomPreviewBar_message"},M,D),h,s.createElement("div",{className:re()("mx_RoomPreviewBar_actions",{mx_RoomPreviewBar_fullWidth:S===ty.PromptAskToJoin})},B),s.createElement("div",{className:"mx_RoomPreviewBar_footer"},y))}}(0,h.A)(ny,"defaultProps",{onJoinClick(){}});var iy=n("./src/utils/membership.ts");const ry=(e,t=250)=>{const[n,r]=(0,s.useState)(e.getJoinedMembers()),o=(0,s.useMemo)((()=>(0,v.throttle)((()=>{r(e.getJoinedMembers())}),t,{leading:!0,trailing:!0})),[e,t]);return(0,Me.YK)(e.currentState,i.RoomStateEvent.Members,o),n},sy=(e,{throttleWait:t}={throttleWait:250})=>{const[n,r]=(0,s.useState)(e.getJoinedMemberCount()),o=(0,s.useMemo)((()=>(0,v.throttle)((()=>{r(e.getJoinedMemberCount())}),t,{leading:!0,trailing:!0})),[e,t]);return(0,Me.YK)(e.currentState,i.RoomStateEvent.Members,o),(0,Me.YK)(e,i.RoomEvent.Summary,o),n},oy=e=>{const[t,n]=(0,s.useState)(e.getMyMembership());return(0,Me.YK)(e,i.RoomEvent.MyMembership,(()=>{n(e.getMyMembership())})),t};var ay=n("./src/components/views/elements/FacePile.tsx");const ly=["room","onlyKnownUsers","numShown"],cy=5,dy=e=>{var t;return!(null===(t=mc.A.shared().getDMRoomsForUserId(e.userId))||void 0===t||!t.length)},uy=e=>{let{room:t,onlyKnownUsers:n=!0,numShown:i=cy}=e,r=(0,Ve.A)(e,ly);const o=(0,s.useContext)(Pe.Ay),a=t.getMyMembership()===oa.O.Join;let l=ry(t);const c=l.length,d=[e=>e.getMxcAvatarUrl()?0:1];n?l=l.filter(dy):d.unshift((e=>dy(e)?0:1));const u=(0,v.sortBy)(l.filter((e=>e.userId!==o.getUserId())),d).slice(0,i);if(u.length<1)return null;const m=u.map((e=>e.name)).reverse().join(", ");return s.createElement(ay.A,(0,p.A)({members:u,size:"28px",overflow:l.length>i,tooltipLabel:r.onClick?(0,P._t)("room|face_pile_tooltip_label",{count:c}):(0,P._t)("common|n_members",{count:c}),tooltipShortcut:a?(0,P._t)("room|face_pile_tooltip_shortcut_joined",{commaSeparatedMembers:m}):(0,P._t)("room|face_pile_tooltip_shortcut",{commaSeparatedMembers:m})},r),n&&s.createElement("span",{className:"mx_FacePile_summary"},(0,P._t)("room|face_pile_summary",{count:l.length})))},my=({room:e})=>{const t=(0,sg.e)((async()=>{if(e.getMyMembership()!==oa.O.Invite)return null;try{return await e.client.getRoomSummary(e.roomId)}catch{return null}}),[e]),n=(0,Kh.U)(e,(e=>e.getJoinRule())),r=oy(e),o=sy(e);let a,l,c;if((0,ig.j)(e)?(a="mx_RoomInfoLine_video",l=(0,P._t)("common|video_room")):n===i.JoinRule.Public?(a="mx_RoomInfoLine_public",l=e.isSpaceRoom()?(0,P._t)("common|public_space"):(0,P._t)("common|public_room")):(a="mx_RoomInfoLine_private",l=e.isSpaceRoom()?(0,P._t)("common|private_space"):(0,P._t)("common|private_room")),r===oa.O.Invite&&t)c=s.createElement("span",{className:"mx_RoomInfoLine_members"},(0,P._t)("common|n_members",{count:t.num_joined_members}));else if(o&&void 0!==t){const e=()=>rl.A.instance.setCard({phase:sl.n.MemberList});c=s.createElement(Ae.A,{kind:"link",className:"mx_RoomInfoLine_members",onClick:e},(0,P._t)("common|n_members",{count:o}))}return s.createElement("div",{className:`mx_RoomInfoLine ${a}`},l,c)},py=({room:e,onJoinButtonClicked:t,onRejectButtonClicked:n})=>{const r=(0,s.useContext)(Pe.Ay),o=(0,ig.j)(e),a=oy(e);(0,De.F)(w.A,(t=>{t.action===R.r.JoinRoomError&&t.roomId===e.roomId&&c(!1)}));const[l,c]=(0,s.useState)(!1),d=(0,Kh.U)(e,(e=>e.getJoinRule())),u=(0,iy.Cs)(a)===iy._T.Leave&&d!==i.JoinRule.Public,m=()=>w.A.dispatch({action:R.r.ViewUserSettings,initialTabId:wa.v.Labs});let p,h,g=null;if(a===oa.O.Join)p=s.createElement(Ae.A,{kind:"danger_outline",onClick:()=>{w.A.dispatch({action:"leave_room",room_id:e.roomId})}},(0,P._t)("action|leave"));else if(a===oa.O.Invite){var v;const i=null===(v=e.getMember(r.getUserId()))||void 0===v||null===(v=v.events.member)||void 0===v?void 0:v.getSender();if(i){const t=e.getMember(i);g=s.createElement("div",{className:"mx_RoomPreviewCard_inviter"},s.createElement($p.A,{member:t,fallbackUserId:i,size:"32px"}),s.createElement("div",null,s.createElement("div",{className:"mx_RoomPreviewCard_inviter_name"},(0,P._t)("room|invites_you_text",{},{inviter:()=>s.createElement("strong",null,(null==t?void 0:t.name)||i)})),t?s.createElement("div",{className:"mx_RoomPreviewCard_inviter_mxid"},i):null))}p=s.createElement(s.Fragment,null,s.createElement(Ae.A,{kind:"primary_outline",onClick:()=>{c(!0),n()}},(0,P._t)("action|reject")),s.createElement(Ae.A,{kind:"primary",onClick:()=>{c(!0),t()}},(0,P._t)("action|accept")))}else p=s.createElement(Ae.A,{kind:"primary",onClick:()=>{t(),r.isGuest()||c(!0)},disabled:u},(0,P._t)("action|join"));return l&&(p=s.createElement(He.A,null)),h=o?s.createElement(s.Fragment,null,s.createElement(aa.A,{room:e,size:"50px",viewAvatarOnClick:!0}),s.createElement("div",{className:"mx_RoomPreviewCard_video"}),s.createElement(Ue.s,{onClick:m,tooltipTitle:(0,P._t)("labs|video_rooms_beta")})):e.isSpaceRoom()?s.createElement(aa.A,{room:e,size:"80px",viewAvatarOnClick:!0}):s.createElement(aa.A,{room:e,size:"50px",viewAvatarOnClick:!0}),s.createElement("div",{className:"mx_RoomPreviewCard"},g,s.createElement("div",{className:"mx_RoomPreviewCard_avatar"},h),s.createElement("h1",{className:"mx_RoomPreviewCard_name"},s.createElement(Ap.A,{room:e})),s.createElement(my,{room:e}),s.createElement(ng,{room:e,className:"mx_RoomPreviewCard_topic"}),"public"===e.getJoinRule()&&s.createElement(uy,{room:e}),u?s.createElement("div",{className:"mx_RoomPreviewCard_notice"},(0,P._t)("room|join_failed_needs_invite",{roomName:e.name})):null,s.createElement("div",{className:"mx_RoomPreviewCard_joinButtons"},p))};var hy=n("./src/components/views/dialogs/RoomUpgradeDialog.tsx");class gy extends s.PureComponent{constructor(e,t){super(e,t),(0,h.A)(this,"onStateEvents",(e=>{if(!this.props.room||e.getRoomId()!==this.props.room.roomId)return;if("m.room.tombstone"!==e.getType())return;const t=this.props.room.currentState.getStateEvents("m.room.tombstone","");this.setState({upgraded:t&&t.getContent().replacement_room})})),(0,h.A)(this,"onUpgradeClick",(()=>{A.Ay.createDialog(hy.A,{room:this.props.room})}));const n=this.props.room.currentState.getStateEvents("m.room.tombstone","");this.state={upgraded:null==n?void 0:n.getContent().replacement_room}}componentDidMount(){this.context.on(i.RoomStateEvent.Events,this.onStateEvents)}componentWillUnmount(){this.context.removeListener(i.RoomStateEvent.Events,this.onStateEvents)}render(){let e=s.createElement("div",null,s.createElement("div",{className:"mx_RoomUpgradeWarningBar_body"},s.createElement("p",null,(0,P._t)("room|upgrade_warning_bar")),s.createElement("p",null,(0,P._t)("room_settings|advanced|room_upgrade_warning",{},{b:e=>s.createElement("strong",null,e),i:e=>s.createElement("i",null,e)}))),s.createElement("p",{className:"mx_RoomUpgradeWarningBar_upgradelink"},s.createElement(Ae.A,{onClick:this.onUpgradeClick},(0,P._t)("room_settings|advanced|room_upgrade_button"))));return this.state.upgraded&&(e=s.createElement("div",{className:"mx_RoomUpgradeWarningBar_body"},s.createElement("p",null,(0,P._t)("room|upgrade_warning_bar_upgraded")))),s.createElement("div",{className:"mx_RoomUpgradeWarningBar"},s.createElement("div",{className:"mx_RoomUpgradeWarningBar_wrapped"},s.createElement("div",{className:"mx_RoomUpgradeWarningBar_header"},(0,P._t)("room|upgrade_warning_bar_unstable",{},{roomVersion:()=>s.createElement("code",null,this.props.room.getVersion()),i:e=>s.createElement("i",null,e)})),e,s.createElement("div",{className:"mx_RoomUpgradeWarningBar_small"},(0,P._t)("room|upgrade_warning_bar_admins"))))}}(0,h.A)(gy,"contextType",Pe.Ay);var vy=function(e){return e.CloseScalar="close_scalar",e.GetWidgets="get_widgets",e.SetWidget="set_widget",e.JoinRulesState="join_rules_state",e.SetPlumbingState="set_plumbing_state",e.GetMembershipCount="get_membership_count",e.GetRoomEncryptionState="get_room_enc_state",e.CanSendEvent="can_send_event",e.MembershipState="membership_state",e.invite="invite",e.Kick="kick",e.BotOptions="bot_options",e.SetBotOptions="set_bot_options",e.SetBotPower="set_bot_power",e.GetOpenIdToken="get_open_id_token",e.SendEvent="send_event",e.ReadEvents="read_events",e}(vy||{});function fy(e,t){const n=(0,Hg.ZV)(e.data);n.response=t,e.source.postMessage(n,e.origin)}function _y(e,t,n){o.v.error("Action:"+e.data.action+" failed with message: "+t);const i=(0,Hg.ZV)(e.data);i.response={error:{message:t}},n&&(i.response.error._error=n),e.source.postMessage(i,e.origin)}function yy(e,t){const n=E.J.safeGet(),i=e.data.widget_id;let r=e.data.type;const s=e.data.url,o=e.data.name,a=e.data.data,l=e.data.avatar_url,c=e.data.userWidget;if(i&&void 0!==s){if(null!==s){if(void 0!==o&&"string"!=typeof o)return void _y(e,(0,P._t)("scalar|error_create"),new Error("Optional field 'name' must be a string."));if(void 0!==a&&!(a instanceof Object))return void _y(e,(0,P._t)("scalar|error_create"),new Error("Optional field 'data' must be an Object."));if(void 0!==l&&"string"!=typeof l)return void _y(e,(0,P._t)("scalar|error_create"),new Error("Optional field 'avatar_url' must be a string."));if("string"!=typeof r)return void _y(e,(0,P._t)("scalar|error_create"),new Error("Field 'type' must be a string."));if("string"!=typeof s)return void _y(e,(0,P._t)("scalar|error_create"),new Error("Field 'url' must be a string or null."))}if(r=Bg.x.fromString(r),c)wg.A.setUserWidget(n,i,r,s,o,a).then((()=>{fy(e,{success:!0}),w.A.dispatch({action:"user_widget_updated"})})).catch((t=>{_y(e,(0,P._t)("scalar|error_create"),t)}));else{if(!t)return void _y(e,(0,P._t)("scalar|error_missing_room_id"));wg.A.setRoomWidget(n,t,i,r,s,o,a,l).then((()=>{fy(e,{success:!0})}),(t=>{_y(e,(0,P._t)("scalar|error_send_request"),t)}))}}else _y(e,(0,P._t)("scalar|error_create"),new Error("Missing required widget fields."))}function by(e,t){const n=E.J.get();if(!n)return void _y(e,(0,P._t)("widget|error_need_to_be_logged_in"));let i=[];if(t){const r=n.getRoom(t);if(!r)return void _y(e,(0,P._t)("scalar|error_room_unknown"));i=wg.A.getRoomWidgets(r).map((e=>e.event))}const r=wg.A.getUserWidgetsArray(n);i=i.concat(r),fy(e,i)}function Ey(e,t,n,i){const r=E.J.get();if(!r)return void _y(e,(0,P._t)("widget|error_need_to_be_logged_in"));const s=r.getRoom(t);if(!s)return void _y(e,(0,P._t)("scalar|error_room_unknown"));const o=s.currentState.getStateEvents(n,i);fy(e,o?o.getContent():null)}const wy=function(e){let t,n;e.origin||(e.origin=e.originalEvent.origin);try{var i;Sy||(Sy=null===(i=sv.J.sharedInstance().getPrimaryManager())||void 0===i?void 0:i.uiUrl),t=new URL(Sy)}catch{return}try{n=new URL(e.origin)}catch{return}if(t.origin!==n.origin||!e.data.action||e.data.api)return;if(e.data.action===vy.CloseScalar)return w.A.dispatch({action:vy.CloseScalar}),void fy(e,null);const r=e.data.room_id,s=e.data.user_id;if(!r)return e.data.action===vy.GetWidgets?void by(e,null):e.data.action===vy.SetWidget?void yy(e,null):e.data.action===vy.GetOpenIdToken?void async function(e){try{fy(e,await E.J.safeGet().getOpenIdToken())}catch(t){o.v.warn("Unable to fetch openId token.",t),_y(e,"Unable to fetch openId token.")}}(e):void _y(e,(0,P._t)("scalar|error_missing_room_id_request"));if(r===Wa.M.instance.roomViewStore.getRoomId())if(e.data.action!==vy.GetWidgets)if(e.data.action!==vy.SetWidget)if(e.data.action!==vy.JoinRulesState)if(e.data.action!==vy.SetPlumbingState)if(e.data.action!==vy.GetMembershipCount)if(e.data.action!==vy.GetRoomEncryptionState)if(e.data.action!==vy.CanSendEvent)if(e.data.action!==vy.SendEvent)if(e.data.action!==vy.ReadEvents)if(s)switch(e.data.action){case vy.MembershipState:!function(e,t,n){o.v.log(`membership_state of ${n} in room ${t} requested.`),Ey(e,t,"m.room.member",n)}(e,r,s);break;case vy.invite:!function(e,t,n){o.v.log(`Received request to invite ${n} into room ${t}`);const i=E.J.get();if(!i)return void _y(e,(0,P._t)("widget|error_need_to_be_logged_in"));const r=i.getRoom(t);if(r){const t=r.getMember(n);if(t&&[oa.O.Join,oa.O.Invite].includes(t.membership))return void fy(e,{success:!0})}i.invite(t,n).then((function(){fy(e,{success:!0})}),(function(t){_y(e,(0,P._t)("widget|error_need_invite_permission"),t)}))}(e,r,s);break;case vy.Kick:!function(e,t,n){o.v.log(`Received request to kick ${n} from room ${t}`);const i=E.J.get();if(!i)return void _y(e,(0,P._t)("widget|error_need_to_be_logged_in"));const r=i.getRoom(t);if(r){const t=r.getMember(n);if(!t||(0,iy.Cs)(t.membership)===iy._T.Leave)return void fy(e,{success:!0})}const s=e.data.reason;i.kick(t,n,s).then((()=>{fy(e,{success:!0})})).catch((t=>{_y(e,(0,P._t)("widget|error_need_kick_permission"),t)}))}(e,r,s);break;case vy.BotOptions:!function(e,t,n){o.v.log(`bot_options of ${n} in room ${t} requested.`),Ey(e,t,"m.room.bot.options","_"+n)}(e,r,s);break;case vy.SetBotOptions:!function(e,t,n){o.v.log(`Received request to set options for bot ${n} in room ${t}`);const i=E.J.get();i?i.sendStateEvent(t,"m.room.bot.options",e.data.content,"_"+n).then((()=>{fy(e,{success:!0})}),(t=>{_y(e,t.message?t.message:(0,P._t)("scalar|error_send_request"),t)})):_y(e,(0,P._t)("widget|error_need_to_be_logged_in"))}(e,r,s);break;case vy.SetBotPower:!async function(e,t,n,i,r){if(!(Number.isInteger(i)&&i>=0))return void _y(e,(0,P._t)("scalar|error_power_level_invalid"));o.v.log(`Received request to set power level to ${i} for bot ${n} in room ${t}.`);const s=E.J.get();if(s)try{const o=await s.getStateEvent(t,"m.room.power_levels","");var a,l,c;if(!0===r)if((null!==(a=null!==(l=null===(c=o.users)||void 0===c?void 0:c[n])&&void 0!==l?l:o.users_default)&&void 0!==a?a:0)>=i)return fy(e,{success:!0});return await s.setPowerLevel(t,n,i),fy(e,{success:!0})}catch(t){var d;const n=t instanceof Error?t:void 0;_y(e,null!==(d=null==n?void 0:n.message)&&void 0!==d?d:(0,P._t)("scalar|error_send_request"),n)}else _y(e,(0,P._t)("widget|error_need_to_be_logged_in"))}(e,r,s,e.data.level,e.data.ignoreIfGreater);break;default:o.v.warn("Unhandled postMessage event with action '"+e.data.action+"'")}else _y(e,(0,P._t)("scalar|error_missing_user_id_request"));else!async function(e,t){const n=e.data.type,i=e.data.state_key,r=e.data.limit;if("string"!=typeof n)return void _y(e,(0,P._t)("scalar|failed_read_event"),new Error("Invalid 'type' in request"));if(!["m.room.power_levels","m.room.encryption","m.room.member","m.room.name","m.widgets","im.vector.modular.widgets","io.element.integrations.installations"].includes(n))return void _y(e,(0,P._t)("scalar|failed_read_event"),new Error("Disallowed 'type' in request"));let s;if(void 0!==r){if("number"!=typeof r||r<0)return void _y(e,(0,P._t)("scalar|failed_read_event"),new Error("Invalid 'limit' in request"));s=Math.min(r,Number.MAX_SAFE_INTEGER)}else s=Number.MAX_SAFE_INTEGER;const o=E.J.get();if(!o)return void _y(e,(0,P._t)("widget|error_need_to_be_logged_in"));const a=o.getRoom(t);if(a){if(void 0!==i){if("string"!=typeof i&&!0!==i)return void _y(e,(0,P._t)("scalar|failed_read_event"),new Error("Invalid 'state_key' in request"));const t=!0===i?void 0:i;let r=[];return r=r.concat(a.currentState.getStateEvents(n,t)||[]),r=r.slice(0,s),void fy(e,{events:r.map((e=>e.getEffectiveEvent()))})}_y(e,(0,P._t)("scalar|failed_read_event"),new Error("Reading message events is not implemented"))}else _y(e,(0,P._t)("scalar|error_room_unknown"))}(e,r);else!async function(e,t){const n=e.data.type,i=e.data.state_key,r=e.data.content;if("string"!=typeof n)return void _y(e,(0,P._t)("scalar|failed_send_event"),new Error("Invalid 'type' in request"));if(!["m.widgets","im.vector.modular.widgets","io.element.integrations.installations"].includes(n))return void _y(e,(0,P._t)("scalar|failed_send_event"),new Error("Disallowed 'type' in request"));if(!r||"object"!=typeof r)return void _y(e,(0,P._t)("scalar|failed_send_event"),new Error("Invalid 'content' in request"));const s=E.J.get();if(!s)return void _y(e,(0,P._t)("widget|error_need_to_be_logged_in"));if(s.getRoom(t))if(void 0!==i)try{fy(e,{room_id:t,event_id:(await s.sendStateEvent(t,n,r,i)).event_id})}catch(t){return void _y(e,(0,P._t)("scalar|failed_send_event"),t)}else _y(e,(0,P._t)("scalar|failed_send_event"),new Error("Sending message events is not implemented"));else _y(e,(0,P._t)("scalar|error_room_unknown"))}(e,r);else!function(e,t){const n=""+e.data.event_type,i=Boolean(e.data.is_state),r=E.J.get();if(!r)return void _y(e,(0,P._t)("widget|error_need_to_be_logged_in"));const s=r.getRoom(t);if(!s)return void _y(e,(0,P._t)("scalar|error_room_unknown"));if(s.getMyMembership()!==oa.O.Join)return void _y(e,(0,P._t)("scalar|error_membership"));const o=r.credentials.userId;let a;a=i?s.currentState.maySendStateEvent(n,o):s.currentState.maySendEvent(n,o),a?fy(e,!0):_y(e,(0,P._t)("scalar|error_permission"))}(e,r);else!async function(e,t){var n;const i=E.J.get();if(!i)return void _y(e,(0,P._t)("widget|error_need_to_be_logged_in"));if(!i.getRoom(t))return void _y(e,(0,P._t)("scalar|error_room_unknown"));fy(e,Boolean(await(null===(n=i.getCrypto())||void 0===n?void 0:n.isEncryptionEnabledInRoom(t))))}(e,r);else!function(e,t){const n=E.J.get();if(!n)return void _y(e,(0,P._t)("widget|error_need_to_be_logged_in"));const i=n.getRoom(t);if(!i)return void _y(e,(0,P._t)("scalar|error_room_unknown"));fy(e,i.getJoinedMemberCount())}(e,r);else!function(e,t,n){if("string"!=typeof n)throw new Error("Plumbing state status should be a string");o.v.log(`Received request to set plumbing state to status "${n}" in room ${t}`);const i=E.J.get();i?i.sendStateEvent(t,"m.room.plumbing",{status:n}).then((()=>{fy(e,{success:!0})}),(t=>{_y(e,t.message?t.message:(0,P._t)("scalar|error_send_request"),t)})):_y(e,(0,P._t)("widget|error_need_to_be_logged_in"))}(e,r,e.data.status);else!function(e,t){o.v.log(`join_rules of ${t} requested.`),Ey(e,t,"m.room.join_rules","")}(e,r);else yy(e,r);else by(e,r);else _y(e,(0,P._t)("scalar|error_room_not_visible",{roomId:r}))};let Sy,Ay=0;class Cy extends de{start(e){this.vertical?e.style.minHeight="":e.style.minWidth=""}finish(e){const t=e.offsetParent;if(t)if(this.vertical){const n=(e.offsetHeight/t.offsetHeight*100).toFixed(2)+"%";e.style.minHeight=n,e.style.height=n}else{const n=(e.offsetWidth/t.offsetWidth*100).toFixed(2)+"%";e.style.minWidth=n,e.style.width=n}}}class xy extends me{static createSizer(e,t,n){return new Cy(e,t,n)}}var ky=n("./src/utils/numbers.ts");class Ry extends s.Component{constructor(e){super(e),(0,h.A)(this,"unmounted",!1),(0,h.A)(this,"resizeContainer",void 0),(0,h.A)(this,"resizer",void 0),(0,h.A)(this,"dispatcherRef",void 0),(0,h.A)(this,"onIsResizing",(e=>{this.setState({resizingVertical:e}),e||this.relaxResizer()})),(0,h.A)(this,"collectResizer",(e=>{this.resizeContainer&&this.resizer.detach(),e&&(this.resizer.container=e,this.resizer.attach()),this.resizeContainer=e,this.loadResizerPreferences()})),(0,h.A)(this,"getAppsHash",(e=>e.map((e=>e.id)).join("~"))),(0,h.A)(this,"relaxResizer",(()=>{const e=this.resizer.getDistributors();e.forEach((e=>e.start())),e.forEach((e=>e.finish()))})),(0,h.A)(this,"loadResizerPreferences",(()=>{const e=Sv.aK.instance.getResizerDistributions(this.props.room,Sv.mc.Top);if(this.state.apps&&this.topApps().length-1===e.length)e.forEach(((e,t)=>{const n=this.resizer.forHandleAt(t);n&&(n.size=e,n.finish())}));else if(this.state.apps){const e=this.resizer.getDistributors();e.forEach((e=>e.item.clearSize())),e.forEach((e=>e.start())),e.forEach((e=>e.finish()))}})),(0,h.A)(this,"onAction",(e=>{const t=this.props.room.roomId+"_hide_widget_drawer";if("appsDrawer"===e.action)e.show?localStorage.setItem(t,"false"):localStorage.setItem(t,"true")})),(0,h.A)(this,"getApps",(()=>({[Sv.mc.Top]:Sv.aK.instance.getContainerWidgets(this.props.room,Sv.mc.Top),[Sv.mc.Center]:Sv.aK.instance.getContainerWidgets(this.props.room,Sv.mc.Center)}))),(0,h.A)(this,"topApps",(()=>this.state.apps[Sv.mc.Top])),(0,h.A)(this,"centerApps",(()=>this.state.apps[Sv.mc.Center])),(0,h.A)(this,"updateApps",(()=>{this.unmounted||this.setState({apps:this.getApps()})})),this.state={apps:this.getApps(),resizingVertical:!1,resizingHorizontal:!1,resizing:!1},this.resizer=this.createResizer()}componentDidMount(){this.unmounted=!1,this.props.resizeNotifier.on("isResizing",this.onIsResizing),0===Ay&&window.addEventListener("message",wy,!1),Ay+=1,Sv.aK.instance.on(Sv.aK.emissionForRoom(this.props.room),this.updateApps),this.dispatcherRef=w.A.register(this.onAction)}componentWillUnmount(){this.unmounted=!0,function(){if(Ay-=1,0===Ay&&window.removeEventListener("message",wy),Ay<0){const e=new Error("ScalarMessaging: mismatched startListening / stopListening detected. Negative count");o.v.error(e)}}(),Sv.aK.instance.off(Sv.aK.emissionForRoom(this.props.room),this.updateApps),w.A.unregister(this.dispatcherRef),this.resizeContainer&&this.resizer.detach(),this.props.resizeNotifier.off("isResizing",this.onIsResizing)}createResizer(){const e=new ge(null,xy,{onResizeStart:()=>{var e;null===(e=this.resizeContainer)||void 0===e||e.classList.add("mx_AppsDrawer--resizing"),this.setState({resizingHorizontal:!0})},onResizeStop:()=>{var e;null===(e=this.resizeContainer)||void 0===e||e.classList.remove("mx_AppsDrawer--resizing"),Sv.aK.instance.setResizerDistributions(this.props.room,Sv.mc.Top,this.topApps().slice(1).map(((e,t)=>this.resizer.forHandleAt(t).size))),this.setState({resizingHorizontal:!1})}});return e.setClassNames({handle:"mx_ResizeHandle",vertical:"mx_ResizeHandle--vertical",reverse:"mx_ResizeHandle_reverse"}),e}componentDidUpdate(e,t){e.userId!==this.props.userId||e.room!==this.props.room?this.updateApps():this.getAppsHash(this.topApps())!==this.getAppsHash(t.apps[Sv.mc.Top])&&this.loadResizerPreferences()}isResizing(){return this.state.resizingVertical||this.state.resizingHorizontal}render(){if(!this.props.showApps)return s.createElement("div",null);const e=this.centerApps().length>0,t=(e?this.centerApps():this.topApps()).map(((e,t,n)=>s.createElement(Vv,{key:e.id,app:e,fullWidth:n.length<2,room:this.props.room,userId:this.props.userId,creatorUserId:e.creatorUserId,widgetPageTitle:wg.A.getWidgetDataTitle(e),waitForIframeLoad:e.waitForIframeLoad,pointerEvents:this.isResizing()?"none":void 0})));if(0===t.length)return s.createElement("div",null);let n;0===t.length&&$_.A.roomHasPendingWidgets(this.props.room.roomId,wg.A.getRoomWidgets(this.props.room))&&(n=s.createElement(Na.A,null));const i=re()({mx_AppsDrawer:!0,"mx_AppsDrawer--maximised":e,"mx_AppsDrawer--resizing":this.state.resizing,"mx_AppsDrawer--2apps":2===t.length,"mx_AppsDrawer--3apps":3===t.length}),r=s.createElement("div",{className:"mx_AppsContainer",ref:this.collectResizer},t.map(((e,n)=>n<1?e:s.createElement(s.Fragment,{key:e.key},s.createElement(le,{reverse:n>t.length/2}),e))));let o;return o=e?r:s.createElement(Iy,{room:this.props.room,minHeight:100,maxHeight:this.props.maxHeight-50,className:"mx_AppsDrawer_resizer",handleWrapperClass:"mx_AppsDrawer_resizer_container",handleClass:"mx_AppsDrawer_resizer_container_handle",resizeNotifier:this.props.resizeNotifier},r),s.createElement("div",{role:this.props.role,className:i},o,n)}}(0,h.A)(Ry,"defaultProps",{showApps:!0});const Iy=({room:e,minHeight:t,maxHeight:n,className:i,handleWrapperClass:r,handleClass:o,resizeNotifier:a,children:l})=>{let c=Sv.aK.instance.getContainerHeight(e,Sv.mc.Top);var d;(t||(t=100),n||(n=Ie.A.instance.windowHeight/4*3),c)?(c=(0,ky.qE)(c,0,100),c=(0,ky.yj)(c/100,t,n)):c=null!==(d=u.Ay.get().default_widget_container_height)&&void 0!==d?d:280;return s.createElement(pu.c,{size:{height:Math.min(c,n),width:void 0},minHeight:t,maxHeight:n,onResizeStart:()=>{a.startResizing()},onResize:()=>{a.notifyTimelineHeightChanged()},onResizeStop:(i,r,s,o)=>{let l=c+o.height;l=100*(0,ky.s5)(l,t,n),Sv.aK.instance.setContainerHeight(e,Sv.mc.Top,l),a.stopResizing()},className:i,handleWrapperClass:r,handleClasses:{bottom:o},enable:{bottom:!0}},l)};var Ty=n("./node_modules/matrix-js-sdk/src/webrtc/callEventTypes.ts");class Py extends s.PureComponent{constructor(e){super(e),(0,h.A)(this,"element",void 0),(0,h.A)(this,"setElementRef",(e=>{var t;e?(this.element=e,e.addEventListener("resize",this.onResize)):null===(t=this.element)||void 0===t||t.removeEventListener("resize",this.onResize)})),(0,h.A)(this,"onNewStream",(()=>{this.setState({audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()}),this.playMedia()})),(0,h.A)(this,"onMuteStateChanged",(()=>{this.setState({audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()})})),(0,h.A)(this,"onResize",(e=>{this.props.onResize&&!this.props.feed.isLocal()&&this.props.onResize(e)})),this.state={audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()}}componentDidMount(){this.updateFeed(null,this.props.feed),this.playMedia()}componentWillUnmount(){this.updateFeed(this.props.feed,null)}componentDidUpdate(e,t){this.updateFeed(e.feed,this.props.feed),t.videoMuted===this.state.videoMuted&&e.feed.stream===this.props.feed.stream||this.playMedia()}static getDerivedStateFromProps(e){return{audioMuted:e.feed.isAudioMuted(),videoMuted:e.feed.isVideoMuted()}}updateFeed(e,t){e!==t&&(e&&(this.props.feed.removeListener(ou.BL.NewStream,this.onNewStream),this.props.feed.removeListener(ou.BL.MuteStateChanged,this.onMuteStateChanged),this.props.feed.purpose===Ty.h.Usermedia&&this.props.feed.measureVolumeActivity(!1),this.stopMedia()),t&&(this.props.feed.addListener(ou.BL.NewStream,this.onNewStream),this.props.feed.addListener(ou.BL.MuteStateChanged,this.onMuteStateChanged),this.props.feed.purpose===Ty.h.Usermedia&&this.props.feed.measureVolumeActivity(!0),this.playMedia()))}async playMedia(){const e=this.element;if(e){e.muted=!0,e.srcObject=this.props.feed.stream,e.autoplay=!0;try{await e.play()}catch(e){o.v.info(`Failed to play media element with feed for userId ${this.props.feed.userId} with purpose ${this.props.feed.purpose}`,e)}}}stopMedia(){const e=this.element;e&&(e.pause(),e.removeAttribute("src"))}render(){const{pipMode:e,primary:t,secondary:n,feed:i}=this.props,r=re()("mx_VideoFeed",{mx_VideoFeed_primary:t,mx_VideoFeed_secondary:n,mx_VideoFeed_voice:this.state.videoMuted}),o=re()("mx_VideoFeed_mic",{mx_VideoFeed_mic_muted:this.state.audioMuted,mx_VideoFeed_mic_unmuted:!this.state.audioMuted});let a,l;if(i.purpose===Ty.h.Screenshare||e||(a=s.createElement("div",{className:o})),this.state.videoMuted){var c;const n=Ee.Ay.instance.roomIdForCall(this.props.call),i=null!==(c=n?E.J.safeGet().getRoom(n):void 0)&&void 0!==c?c:void 0;let r;e&&t?r="76px":e&&!t?r="16px":!e&&t&&(r="160px"),l=s.createElement(aa.A,{room:i,size:r})}else{const e=re()("mx_VideoFeed_video",{mx_VideoFeed_video_mirror:this.props.feed.isLocal()&&this.props.feed.purpose===Ty.h.Usermedia&&V.A.getValue("VideoView.flipVideoHorizontally")});l=s.createElement("video",{className:e,ref:this.setElementRef})}return s.createElement("div",{className:r},a,l)}}class Ny extends s.Component{render(){const e=this.props.feeds.map((e=>s.createElement(Py,{key:e.stream.id,feed:e,call:this.props.call,primary:!1,pipMode:this.props.pipMode}))),t=re()("mx_LegacyCallViewSidebar",{mx_LegacyCallViewSidebar_pipMode:this.props.pipMode});return s.createElement("div",{className:t},e)}}const Dy=({onExpand:e,onPin:t,onMaximize:n})=>s.createElement("div",{className:"mx_LegacyCallViewHeader_controls"},n&&s.createElement(Ae.A,{className:"mx_LegacyCallViewHeader_button mx_LegacyCallViewHeader_button_fullscreen",onClick:n,title:(0,P._t)("voip|maximise")}),t&&s.createElement(Ae.A,{className:"mx_LegacyCallViewHeader_button mx_LegacyCallViewHeader_button_pin",onClick:t,title:(0,P._t)("action|pin")}),e&&s.createElement(Ae.A,{className:"mx_LegacyCallViewHeader_button mx_LegacyCallViewHeader_button_expand",onClick:e,title:(0,P._t)("voip|expand")})),My=({callRoom:e})=>s.createElement("span",{className:"mx_LegacyCallViewHeader_secondaryCallInfo"},s.createElement(aa.A,{room:e,size:"16px"}),s.createElement("span",{className:"mx_LegacyCallView_secondaryCall_roomName"},(0,P._t)("voip|on_hold",{name:e.name}))),Oy=({pipMode:e=!1,callRooms:t,onPipMouseDown:n,onExpand:i,onPin:r,onMaximize:o})=>{const[a,l]=t,c=a.name;return e?s.createElement("div",{className:"mx_LegacyCallViewHeader mx_LegacyCallViewHeader_pip",onMouseDown:n},s.createElement(aa.A,{room:a,size:"32px"}),s.createElement("div",{className:"mx_LegacyCallViewHeader_callInfo"},s.createElement("div",{className:"mx_LegacyCallViewHeader_roomName"},c),l&&s.createElement(My,{callRoom:l})),s.createElement(Dy,{onExpand:i,onPin:r,onMaximize:o})):s.createElement("div",{className:"mx_LegacyCallViewHeader"},s.createElement("div",{className:"mx_LegacyCallViewHeader_icon"}),s.createElement("span",{className:"mx_LegacyCallViewHeader_text"},(0,P._t)("action|call")),s.createElement(Dy,{onMaximize:o}))};class Ly extends s.Component{constructor(...e){super(...e),(0,h.A)(this,"onHoldClick",(()=>{this.props.call.setRemoteOnHold(!0),this.props.onFinished()})),(0,h.A)(this,"onUnholdClick",(()=>{Ee.Ay.instance.setActiveCallRoomId(this.props.call.roomId),this.props.onFinished()})),(0,h.A)(this,"onTransferClick",(()=>{Ee.Ay.instance.showTransferDialog(this.props.call),this.props.onFinished()}))}render(){const e=this.props.call.isRemoteOnHold()?(0,P._t)("action|resume"):(0,P._t)("action|hold"),t=this.props.call.isRemoteOnHold()?this.onUnholdClick:this.onHoldClick;let n;return this.props.call.opponentCanBeTransferred()&&(n=s.createElement(Fe.Dr,{className:"mx_LegacyCallContextMenu_item",onClick:this.onTransferClick},(0,P._t)("action|transfer"))),s.createElement(Fe.Ay,this.props,s.createElement(Fe.Dr,{className:"mx_LegacyCallContextMenu_item",onClick:t},e),n)}}var Fy=n("./src/components/views/voip/DialPad.tsx");class Uy extends s.Component{constructor(e){super(e),(0,h.A)(this,"numberEntryFieldRef",(0,s.createRef)()),(0,h.A)(this,"onDigitPress",((e,t)=>{var n;(this.props.call.sendDtmfDigit(e),this.setState({value:this.state.value+e}),"click"===t.type)&&(null===(n=this.numberEntryFieldRef.current)||void 0===n||n.focus())})),(0,h.A)(this,"onCancelClick",(()=>{this.props.onFinished()})),(0,h.A)(this,"onKeyDown",(e=>{"Backspace"!==e.code&&"Delete"!==e.code||e.preventDefault()})),(0,h.A)(this,"onChange",(e=>{this.setState({value:e.target.value})})),this.state={value:""}}render(){return s.createElement(Fe.Ay,this.props,s.createElement("div",{className:"mx_DialPadContextMenuWrapper"},s.createElement("div",null,s.createElement(Ae.A,{className:"mx_DialPadContextMenu_cancel",onClick:this.onCancelClick})),s.createElement("div",{className:"mx_DialPadContextMenu_header"},s.createElement(Sa.A,{ref:this.numberEntryFieldRef,className:"mx_DialPadContextMenu_dialled",value:this.state.value,autoFocus:!0,onKeyDown:this.onKeyDown,onChange:this.onChange})),s.createElement("div",{className:"mx_DialPadContextMenu_dialPad"},s.createElement(Fy.Ay,{onDigitPress:this.onDigitPress,hasDial:!1}))))}}const By=["deviceKinds"],Vy={[oe.cm.AudioInput]:(0,P.AO)("voip|input_devices"),[oe.cm.AudioOutput]:(0,P.AO)("voip|output_devices"),[oe.cm.VideoInput]:(0,P.AO)("common|cameras")},jy=({label:e,selected:t,onClick:n})=>s.createElement(Be.h6,{iconClassName:"mx_DeviceContextMenu_device_icon",label:e,active:t,onClick:n}),zy=({deviceKind:e})=>{const[t,n]=(0,s.useState)([]),[i,r]=(0,s.useState)(oe.Ay.getDevice(e));(0,s.useEffect)((()=>{(async()=>{var t,i;n(null!==(t=null===(i=await oe.Ay.getDevices())||void 0===i?void 0:i[e])&&void 0!==t?t:[])})()}),[e]);return s.createElement(Be.tx,{label:(0,P._t)(Vy[e])},t.map((({label:t,deviceId:n})=>s.createElement(jy,{key:n,label:t,selected:i===n,onClick:()=>(t=>{oe.Ay.instance.setDevice(t,e),r(t)})(n)}))))},Wy=e=>{let{deviceKinds:t}=e,n=(0,Ve.A)(e,By);return s.createElement(Be.Ay,(0,p.A)({compact:!0,className:"mx_DeviceContextMenu"},n),t.map((e=>s.createElement(zy,{key:e,deviceKind:e}))))},Hy=["children","state","className","onLabel","offLabel","forceHide","onHover"],Gy=["state","deviceKinds"],Ky=(0,s.forwardRef)(((e,t)=>{let{children:n,state:i,className:r,onLabel:o,offLabel:a,forceHide:l,onHover:c}=e,d=(0,Ve.A)(e,Hy);const u=re()("mx_LegacyCallViewButtons_button",r,{mx_LegacyCallViewButtons_button_on:i,mx_LegacyCallViewButtons_button_off:!i}),m=l?void 0:i?o:a;return s.createElement(Ae.A,(0,p.A)({ref:t,className:u,title:m,placement:"top",onTooltipOpenChange:c},d),n)})),Jy=e=>{let{state:t,deviceKinds:n}=e,i=(0,Ve.A)(e,Gy);const[r,o,a,l]=(0,Fe.EF)(),[c,d]=(0,s.useState)(!1),u=re()("mx_LegacyCallViewButtons_button","mx_LegacyCallViewButtons_dropdownButton",{mx_LegacyCallViewButtons_dropdownButton_collapsed:!r});return s.createElement(Ky,(0,p.A)({ref:o,forceHide:r||c,state:t},i),s.createElement(Ky,{className:u,onClick:e=>{e.stopPropagation(),a()},onHover:e=>d(e),state:t}),r&&o.current&&s.createElement(Wy,(0,p.A)({},(0,Fe.Gi)(o.current.getBoundingClientRect()),{onFinished:l,deviceKinds:n})))};class qy extends s.Component{constructor(e){super(e),(0,h.A)(this,"dialpadButton",(0,s.createRef)()),(0,h.A)(this,"contextMenuButton",(0,s.createRef)()),(0,h.A)(this,"controlsHideTimer",null),(0,h.A)(this,"onControlsHideTimer",(()=>{this.state.hoveringControls||this.state.showDialpad||this.state.showMoreMenu||(this.controlsHideTimer=null,this.setState({visible:!1}))})),(0,h.A)(this,"onMouseEnter",(()=>{this.setState({hoveringControls:!0})})),(0,h.A)(this,"onMouseLeave",(()=>{this.setState({hoveringControls:!1})})),(0,h.A)(this,"onDialpadClick",(()=>{this.state.showDialpad?this.setState({showDialpad:!1}):(this.setState({showDialpad:!0}),this.showControls())})),(0,h.A)(this,"onMoreClick",(()=>{this.setState({showMoreMenu:!0}),this.showControls()})),(0,h.A)(this,"closeDialpad",(()=>{this.setState({showDialpad:!1})})),(0,h.A)(this,"closeContextMenu",(()=>{this.setState({showMoreMenu:!1})})),this.state={showDialpad:!1,hoveringControls:!1,showMoreMenu:!1,visible:!0}}componentDidMount(){this.showControls()}showControls(){this.state.showMoreMenu||this.state.showDialpad||(this.state.visible||this.setState({visible:!0}),null!==this.controlsHideTimer&&clearTimeout(this.controlsHideTimer),this.controlsHideTimer=window.setTimeout(this.onControlsHideTimer,2e3))}render(){const e=re()("mx_LegacyCallViewButtons",{mx_LegacyCallViewButtons_hidden:!this.state.visible});let t,n;return this.state.showDialpad&&this.dialpadButton.current&&(t=s.createElement(Uy,(0,p.A)({},(0,Fe.t$)(this.dialpadButton.current.getBoundingClientRect(),Fe.t4.None,8),{mountAsChild:!this.props.pipMode,onFinished:this.closeDialpad,call:this.props.call}))),this.state.showMoreMenu&&this.contextMenuButton.current&&(n=s.createElement(Ly,(0,p.A)({},(0,Fe.t$)(this.contextMenuButton.current.getBoundingClientRect(),Fe.t4.None,8),{mountAsChild:!this.props.pipMode,onFinished:this.closeContextMenu,call:this.props.call}))),s.createElement("div",{className:e,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave},t,n,this.props.buttonsVisibility.dialpad&&s.createElement(Fe.oW,{className:"mx_LegacyCallViewButtons_button mx_LegacyCallViewButtons_dialpad",ref:this.dialpadButton,onClick:this.onDialpadClick,isExpanded:this.state.showDialpad,title:(0,P._t)("voip|dialpad"),placement:"top"}),s.createElement(Jy,{state:!this.props.buttonsState.micMuted,className:"mx_LegacyCallViewButtons_button_mic",onLabel:(0,P._t)("voip|disable_microphone"),offLabel:(0,P._t)("voip|enable_microphone"),onClick:this.props.handlers.onMicMuteClick,deviceKinds:[oe.cm.AudioInput,oe.cm.AudioOutput]}),this.props.buttonsVisibility.vidMute&&s.createElement(Jy,{state:!this.props.buttonsState.vidMuted,className:"mx_LegacyCallViewButtons_button_vid",onLabel:(0,P._t)("voip|disable_camera"),offLabel:(0,P._t)("voip|enable_camera"),onClick:this.props.handlers.onVidMuteClick,deviceKinds:[oe.cm.VideoInput]}),this.props.buttonsVisibility.screensharing&&s.createElement(Ky,{state:this.props.buttonsState.screensharing,className:"mx_LegacyCallViewButtons_button_screensharing",onLabel:(0,P._t)("voip|stop_screenshare"),offLabel:(0,P._t)("voip|start_screenshare"),onClick:this.props.handlers.onScreenshareClick}),this.props.buttonsVisibility.sidebar&&s.createElement(Ky,{state:this.props.buttonsState.sidebarShown,className:"mx_LegacyCallViewButtons_button_sidebar",onLabel:(0,P._t)("voip|hide_sidebar_button"),offLabel:(0,P._t)("voip|show_sidebar_button"),onClick:this.props.handlers.onToggleSidebarClick}),this.props.buttonsVisibility.contextMenu&&s.createElement(Fe.oW,{className:"mx_LegacyCallViewButtons_button mx_LegacyCallViewButtons_button_more",onClick:this.onMoreClick,ref:this.contextMenuButton,isExpanded:this.state.showMoreMenu,title:(0,P._t)("voip|more_button"),placement:"top"}),s.createElement(Ae.A,{className:"mx_LegacyCallViewButtons_button mx_LegacyCallViewButtons_button_hangup",onClick:this.props.handlers.onHangupClick,title:(0,P._t)("voip|hangup"),placement:"top"}))}}function $y(){return document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement}function Yy(){const e=document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen;e&&e.call(document)}class Zy extends s.Component{constructor(e){super(e),(0,h.A)(this,"dispatcherRef",void 0),(0,h.A)(this,"contentWrapperRef",(0,s.createRef)()),(0,h.A)(this,"buttonsRef",(0,s.createRef)()),(0,h.A)(this,"onAction",(e=>{if("video_fullscreen"===e.action){if(!this.contentWrapperRef.current)return;e.fullscreen?function(e){const t=e.requestFullscreen||e.webkitRequestFullScreen||e.msRequestFullscreen;t&&t.call(e)}(this.contentWrapperRef.current):$y()&&Yy()}})),(0,h.A)(this,"onCallState",(e=>{this.setState({callState:e})})),(0,h.A)(this,"onFeedsChanged",(e=>{const{primary:t,secondary:n,sidebar:i}=Zy.getOrderedFeeds(e);this.setState({primaryFeed:t,secondaryFeed:n,sidebarFeeds:i,micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted()})})),(0,h.A)(this,"onCallLocalHoldUnhold",(()=>{this.setState({isLocalOnHold:this.props.call.isLocalOnHold()})})),(0,h.A)(this,"onCallRemoteHoldUnhold",(()=>{this.setState({isRemoteOnHold:this.props.call.isRemoteOnHold(),isLocalOnHold:this.props.call.isLocalOnHold()})})),(0,h.A)(this,"onMouseMove",(()=>{var e;null===(e=this.buttonsRef.current)||void 0===e||e.showControls()})),(0,h.A)(this,"onMaximizeClick",(()=>{w.A.dispatch({action:"video_fullscreen",fullscreen:!0})})),(0,h.A)(this,"onMicMuteClick",(async()=>{const e=!this.state.micMuted;this.setState({micMuted:await this.props.call.setMicrophoneMuted(e)})})),(0,h.A)(this,"onVidMuteClick",(async()=>{const e=!this.state.vidMuted;this.setState({vidMuted:await this.props.call.setLocalVideoMuted(e)})})),(0,h.A)(this,"onScreenshareClick",(async()=>{let e;e=this.state.screensharing?await this.props.call.setScreensharingEnabled(!1):await this.props.call.setScreensharingEnabled(!0),this.setState({sidebarShown:!0,screensharing:e})})),(0,h.A)(this,"onNativeKeyDown",(e=>{var t,n;let i=!1;switch((0,Re.zM)().getCallAction(e)){case Se.bY.ToggleMicInCall:this.onMicMuteClick(),null===(t=this.buttonsRef.current)||void 0===t||t.showControls(),i=!0;break;case Se.bY.ToggleWebcamInCall:this.onVidMuteClick(),null===(n=this.buttonsRef.current)||void 0===n||n.showControls(),i=!0}i&&(e.stopPropagation(),e.preventDefault())})),(0,h.A)(this,"onCallResumeClick",(()=>{const e=Ee.Ay.instance.roomIdForCall(this.props.call);e&&Ee.Ay.instance.setActiveCallRoomId(e)})),(0,h.A)(this,"onTransferClick",(()=>{const e=Ee.Ay.instance.getTransfereeForCallId(this.props.call.callId);e&&this.props.call.transferToCall(e)})),(0,h.A)(this,"onHangupClick",(()=>{const e=Ee.Ay.instance.roomIdForCall(this.props.call);e&&Ee.Ay.instance.hangupOrReject(e)})),(0,h.A)(this,"onToggleSidebar",(()=>{this.setState({sidebarShown:!this.state.sidebarShown})}));const{primary:t,secondary:n,sidebar:i}=Zy.getOrderedFeeds(this.props.call.getFeeds());this.state={isLocalOnHold:this.props.call.isLocalOnHold(),isRemoteOnHold:this.props.call.isRemoteOnHold(),micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted(),screensharing:this.props.call.isScreensharing(),callState:this.props.call.state,primaryFeed:t,secondaryFeed:n,sidebarFeeds:i,sidebarShown:!0}}componentDidMount(){this.updateCallListeners(null,this.props.call),this.dispatcherRef=w.A.register(this.onAction),document.addEventListener("keydown",this.onNativeKeyDown)}componentWillUnmount(){$y()&&Yy(),document.removeEventListener("keydown",this.onNativeKeyDown),this.updateCallListeners(this.props.call,null),w.A.unregister(this.dispatcherRef)}static getDerivedStateFromProps(e){const{primary:t,secondary:n,sidebar:i}=Zy.getOrderedFeeds(e.call.getFeeds());return{primaryFeed:t,secondaryFeed:n,sidebarFeeds:i}}componentDidUpdate(e){this.props.call!==e.call&&(this.setState({isLocalOnHold:this.props.call.isLocalOnHold(),isRemoteOnHold:this.props.call.isRemoteOnHold(),micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted(),callState:this.props.call.state}),this.updateCallListeners(null,this.props.call))}updateCallListeners(e,t){e!==t&&(e&&(e.removeListener(su.$E.State,this.onCallState),e.removeListener(su.$E.LocalHoldUnhold,this.onCallLocalHoldUnhold),e.removeListener(su.$E.RemoteHoldUnhold,this.onCallRemoteHoldUnhold),e.removeListener(su.$E.FeedsChanged,this.onFeedsChanged)),t&&(t.on(su.$E.State,this.onCallState),t.on(su.$E.LocalHoldUnhold,this.onCallLocalHoldUnhold),t.on(su.$E.RemoteHoldUnhold,this.onCallRemoteHoldUnhold),t.on(su.$E.FeedsChanged,this.onFeedsChanged)))}static getOrderedFeeds(e){if(e.length<=2)return{primary:e.find((e=>!e.isLocal())),secondary:e.find((e=>e.isLocal())),sidebar:[]};let t;const n=e.filter((e=>e.purpose===Ty.h.Screenshare));t=n.find((e=>!e.isLocal()))||n[0],t||(t=e.find((e=>!e.isLocal())));const i=[...e];return t&&i.splice(i.indexOf(t),1),i.sort(((e,t)=>e.isLocal()&&!t.isLocal()?-1:!e.isLocal()&&t.isLocal()?1:0)),{primary:t,sidebar:i}}renderCallControls(){const{call:e,pipMode:t}=this.props,{callState:n,micMuted:i,vidMuted:r,screensharing:o,sidebarShown:a,secondaryFeed:l,sidebarFeeds:c}=this.state;let d=!1;Vl.A.isFeatureActiveForHomeserver("feature_video_call")&&(d=e.opponentSupportsSDPStreamMetadata()||e.hasLocalUserMediaVideoTrack);let u=!1;Vl.A.isFeatureActiveForHomeserver("feature_screenshare_call")&&(u=(e.opponentSupportsSDPStreamMetadata()||e.hasLocalUserMediaVideoTrack)&&e.state===su.iP.Connected);const m=l&&!l.isVideoMuted()||c.length>0,p=n===su.iP.Connected,h=n===su.iP.Connected&&e.opponentSupportsDTMF();return s.createElement(qy,{ref:this.buttonsRef,call:e,pipMode:t,handlers:{onToggleSidebarClick:this.onToggleSidebar,onScreenshareClick:this.onScreenshareClick,onHangupClick:this.onHangupClick,onMicMuteClick:this.onMicMuteClick,onVidMuteClick:this.onVidMuteClick},buttonsState:{micMuted:i,vidMuted:r,sidebarShown:a,screensharing:o},buttonsVisibility:{vidMute:d,screensharing:u,sidebar:m,contextMenu:p,dialpad:h}})}renderToast(){var e;const{call:t}=this.props;if(!t.getFeeds().some((e=>e.purpose===Ty.h.Screenshare)))return null;const n=t.isScreensharing(),{primaryFeed:i,sidebarShown:r}=this.state,o=null==i||null===(e=i.getMember())||void 0===e?void 0:e.name;if(!o)return null;let a=n?(0,P._t)("voip|you_are_presenting"):(0,P._t)("voip|user_is_presenting",{sharerName:o});return r||(a+=" â€¢ "+(t.isLocalVideoMuted()?(0,P._t)("voip|camera_disabled"):(0,P._t)("voip|camera_enabled"))),s.createElement("div",{className:"mx_LegacyCallView_toast"},a)}renderContent(){var e;const{pipMode:t,call:n,onResize:i}=this.props,{isLocalOnHold:r,isRemoteOnHold:o,sidebarShown:a,primaryFeed:l,secondaryFeed:c,sidebarFeeds:d}=this.state,u=Ee.Ay.instance.roomIdForCall(n),m=null!==(e=u?E.J.safeGet().getRoom(u):void 0)&&void 0!==e?e:void 0,p=t?"76px":"160px",h=Ee.Ay.instance.getTransfereeForCallId(n.callId),g=r||o;let v;if(a&&c&&!c.isVideoMuted()&&(v=s.createElement(Py,{feed:c,call:n,pipMode:t,onResize:i,secondary:!0})),h||g){const e=re()("mx_LegacyCallView_content",{mx_LegacyCallView_content_hold:g}),t=(0,Rh._V)(n.getOpponentMember(),1024,1024,"crop");let i;if(h){const e=E.J.safeGet(),t=Ee.Ay.instance.roomIdForCall(n),r=t?e.getRoom(t):null,o=r?r.name:(0,P._t)("voip|unknown_person"),a=Ee.Ay.instance.roomIdForCall(h),l=a?e.getRoom(a):null,c=l?l.name:(0,P._t)("voip|unknown_person");i=s.createElement("div",{className:"mx_LegacyCallView_status"},(0,P._t)("voip|consulting",{transferTarget:o,transferee:c},{a:e=>s.createElement(Ae.A,{kind:"link_inline",onClick:this.onTransferClick},e)}))}else{let e;if(o)e=(0,P._t)(Ee.Ay.instance.hasAnyUnheldCall()?(0,P.AO)("voip|call_held_switch"):(0,P.AO)("voip|call_held_resume"),{},{a:e=>s.createElement(Ae.A,{kind:"link_inline",onClick:this.onCallResumeClick},e)});else if(r){var f;e=(0,P._t)("voip|call_held",{peerName:null===(f=n.getOpponentMember())||void 0===f?void 0:f.name})}i=s.createElement("div",{className:"mx_LegacyCallView_status"},e)}return s.createElement("div",{className:e,onMouseMove:this.onMouseMove},s.createElement("div",{className:"mx_LegacyCallView_holdBackground",style:{backgroundImage:"url("+t+")"}}),i)}return n.noIncomingFeeds()?s.createElement("div",{className:"mx_LegacyCallView_content",onMouseMove:this.onMouseMove},s.createElement("div",{className:"mx_LegacyCallView_avatarsContainer"},s.createElement("div",{className:"mx_LegacyCallView_avatarContainer",style:{width:p,height:p}},s.createElement(aa.A,{room:m,size:p}))),s.createElement("div",{className:"mx_LegacyCallView_status"},(0,P._t)("voip|connecting")),v):t?s.createElement("div",{className:"mx_LegacyCallView_content",onMouseMove:this.onMouseMove},s.createElement(Py,{feed:l,call:n,pipMode:t,onResize:i,primary:!0})):c?s.createElement("div",{className:"mx_LegacyCallView_content",onMouseMove:this.onMouseMove},s.createElement(Py,{feed:l,call:n,pipMode:t,onResize:i,primary:!0}),v):s.createElement("div",{className:"mx_LegacyCallView_content",onMouseMove:this.onMouseMove},s.createElement(Py,{feed:l,call:n,pipMode:t,onResize:i,primary:!0}),a&&s.createElement(Ny,{feeds:d,call:n,pipMode:Boolean(t)}))}render(){const{call:e,secondaryCall:t,pipMode:n,showApps:i,onMouseDownOnHeader:r}=this.props,{sidebarShown:o,sidebarFeeds:a}=this.state,l=E.J.safeGet(),c=Ee.Ay.instance.roomIdForCall(e),d=Ee.Ay.instance.roomIdForCall(t),u=c?l.getRoom(c):null;if(!u)return null;const m=d?l.getRoom(d):null,p=re()({mx_LegacyCallView:!0,mx_LegacyCallView_pip:n,mx_LegacyCallView_large:!n,mx_LegacyCallView_sidebar:o&&0!==a.length&&!n,mx_LegacyCallView_belowWidget:i});return s.createElement("div",{className:p},s.createElement(Oy,{onPipMouseDown:r,pipMode:n,callRooms:[u,m],onMaximize:this.onMaximizeClick}),s.createElement("div",{className:"mx_LegacyCallView_content_wrapper",ref:this.contentWrapperRef},this.renderToast(),this.renderContent(),this.renderCallControls()))}}class Xy extends s.Component{constructor(e){super(e),(0,h.A)(this,"updateCall",(()=>{const e=this.getCall();e!==this.state.call&&this.setState({call:e})})),(0,h.A)(this,"onResizeStart",(()=>{this.props.resizeNotifier.startResizing()})),(0,h.A)(this,"onResize",(()=>{this.props.resizeNotifier.notifyTimelineHeightChanged()})),(0,h.A)(this,"onResizeStop",(()=>{this.props.resizeNotifier.stopResizing()})),this.state={call:this.getCall()}}componentDidMount(){Ee.Ay.instance.addListener(Ee.uv.CallState,this.updateCall),Ee.Ay.instance.addListener(Ee.uv.CallChangeRoom,this.updateCall)}componentWillUnmount(){Ee.Ay.instance.removeListener(Ee.uv.CallState,this.updateCall),Ee.Ay.instance.removeListener(Ee.uv.CallChangeRoom,this.updateCall)}getCall(){const e=Ee.Ay.instance.getCallForRoom(this.props.roomId);return e&&[su.iP.Ended,su.iP.Ringing].includes(e.state)?null:e}render(){return this.state.call?s.createElement("div",{className:"mx_LegacyCallViewForRoom"},s.createElement(pu.c,{minHeight:380,maxHeight:"80vh",enable:{top:!1,right:!1,bottom:!0,left:!1,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},onResizeStart:this.onResizeStart,onResize:this.onResize,onResizeStop:this.onResizeStop,className:"mx_LegacyCallViewForRoom_ResizeWrapper",handleClasses:{bottom:"mx_LegacyCallViewForRoom_ResizeHandle"}},s.createElement(Zy,{call:this.state.call,pipMode:!1,showApps:this.props.showApps}))):null}}class Qy extends s.Component{shouldComponentUpdate(e){return(0,Hg.No)(this.props,e)}render(){const e=s.createElement(Xy,{roomId:this.props.room.roomId,resizeNotifier:this.props.resizeNotifier,showApps:this.props.showApps});let t;return V.A.getValue($.f.Widgets)&&(t=s.createElement(Ry,{room:this.props.room,userId:this.props.userId,showApps:this.props.showApps,resizeNotifier:this.props.resizeNotifier})),s.createElement(Ka.A,{role:"region",className:"mx_AuxPanel"},this.props.children,t,e)}}(0,h.A)(Qy,"defaultProps",{showApps:!0});const eb=["children"];function tb(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function nb(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?tb(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):tb(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const ib=e=>{let{children:t}=e,n=(0,Ve.A)(e,eb);return(0,dl.jsx)(Qa.E,nb(nb({},n),{},{children:t}))};var rb=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/video-call-solid.js");function sb(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{d:"m20.958 16.374.039 3.527c0 .285-.11.537-.33.756-.22.22-.472.33-.756.33a15.97 15.97 0 0 1-6.57-1.105 16.223 16.223 0 0 1-5.563-3.663 16.084 16.084 0 0 1-3.653-5.573 16.313 16.313 0 0 1-1.115-6.56c0-.285.11-.537.33-.757.22-.22.471-.329.755-.329l3.528.039a1.069 1.069 0 0 1 1.085.93l.543 3.954c.026.181.013.349-.039.504a1.088 1.088 0 0 1-.271.426l-1.64 1.64c.337.672.721 1.308 1.154 1.909.433.6 1.444 1.696 1.444 1.696s1.095 1.01 1.696 1.444c.6.433 1.237.817 1.909 1.153l1.64-1.64a1.08 1.08 0 0 1 .426-.27c.155-.052.323-.065.504-.04l3.954.543a1.069 1.069 0 0 1 .93 1.085Z"})})}sb.displayName="VoiceCallIcon";const ob=(0,s.forwardRef)(sb);var ab=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/close.js");function lb(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{d:"M12 17a.97.97 0 0 0 .713-.288A.968.968 0 0 0 13 16v-4a.968.968 0 0 0-.287-.713A.968.968 0 0 0 12 11a.968.968 0 0 0-.713.287A.968.968 0 0 0 11 12v4c0 .283.096.52.287.712.192.192.43.288.713.288Zm0-8c.283 0 .52-.096.713-.287A.967.967 0 0 0 13 8a.967.967 0 0 0-.287-.713A.968.968 0 0 0 12 7a.968.968 0 0 0-.713.287A.967.967 0 0 0 11 8c0 .283.096.52.287.713.192.191.43.287.713.287Zm0 13a9.738 9.738 0 0 1-3.9-.788 10.099 10.099 0 0 1-3.175-2.137c-.9-.9-1.612-1.958-2.137-3.175A9.738 9.738 0 0 1 2 12a9.74 9.74 0 0 1 .788-3.9 10.099 10.099 0 0 1 2.137-3.175c.9-.9 1.958-1.612 3.175-2.137A9.738 9.738 0 0 1 12 2a9.74 9.74 0 0 1 3.9.788 10.098 10.098 0 0 1 3.175 2.137c.9.9 1.613 1.958 2.137 3.175A9.738 9.738 0 0 1 22 12a9.738 9.738 0 0 1-.788 3.9 10.098 10.098 0 0 1-2.137 3.175c-.9.9-1.958 1.613-3.175 2.137A9.738 9.738 0 0 1 12 22Z"})})}lb.displayName="InfoSolidIcon";const cb=(0,s.forwardRef)(lb);function db(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{d:"M20.293 17.293c.63.63.184 1.707-.707 1.707H4.414c-.89 0-1.337-1.077-.707-1.707L5 16v-6s0-7 7-7 7 7 7 7v6l1.293 1.293ZM12 22a2 2 0 0 1-2-2h4a2 2 0 0 1-2 2Z"})})}db.displayName="NotificationsSolidIcon";const ub=(0,s.forwardRef)(db),mb=(e,t="")=>(null==e?void 0:e.name)||t;var pb=n("./src/hooks/useCall.ts"),hb=n("./src/models/Call.ts");const gb=async(e,t,n,i)=>{const{analyticsName:r}=bb(n);y.A.trackInteraction(r),n==yb.LegacyCall||n==yb.JitsiCall?await Ee.Ay.instance.placeCall(e.roomId,t):n==yb.ElementCall&&w.A.dispatch({action:R.r.ViewRoom,room_id:e.roomId,view_call:!0,skipLobby:i,metricsTrigger:void 0})};var vb=n("./src/widgets/ManagedHybrid.ts"),fb=n("./src/stores/CallStore.ts");const _b=e=>{const t=(0,s.useMemo)((()=>u.Ay.get("element_call").guest_spa_url),[]),{joinRule:n,canInvite:r,canChangeJoinRule:o}=(0,Kh.U)(e,(t=>({joinRule:e.getJoinRule(),canInvite:e.canInvite(e.myUserId),canChangeJoinRule:t.maySendStateEvent(i.EventType.RoomJoinRules,e.myUserId)}))),a=(0,s.useMemo)((()=>n===i.JoinRule.Public||n===i.JoinRule.Knock&&r),[r,n]);return{canInviteGuests:(0,s.useMemo)((()=>(o||a)&&void 0!==t),[o,a,t]),guestSpaUrl:t,isRoomJoinable:()=>{const t=e.getJoinRule();return t===i.JoinRule.Public||t===i.JoinRule.Knock&&e.canInvite(e.myUserId)},canInvite:r}};let yb=function(e){return e[e.ElementCall=0]="ElementCall",e[e.JitsiCall=1]="JitsiCall",e[e.LegacyCall=2]="LegacyCall",e}({});const bb=e=>{switch(e){case yb.ElementCall:return{label:(0,P._t)("voip|element_call"),analyticsName:"WebVoipOptionElementCall",children:s.createElement(Ue.s,null)};case yb.JitsiCall:return{label:(0,P._t)("voip|jitsi_call"),analyticsName:"WebVoipOptionJitsi"};case yb.LegacyCall:return{label:(0,P._t)("voip|legacy_call"),analyticsName:"WebVoipOptionLegacy"}}};var Eb=function(e){return e[e.NoCall=0]="NoCall",e[e.NoOneHere=1]="NoOneHere",e[e.NoPermission=2]="NoPermission",e[e.Unpinned=3]="Unpinned",e[e.Ongoing=4]="Ongoing",e[e.NotJoined=5]="NotJoined",e}(Eb||{});function wb(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{d:"M2.95 16.3 1.5 21.25a.936.936 0 0 0 .25 1 .936.936 0 0 0 1 .25l4.95-1.45a10.23 10.23 0 0 0 2.1.712c.717.159 1.45.238 2.2.238a9.737 9.737 0 0 0 3.9-.788 10.098 10.098 0 0 0 3.175-2.137c.9-.9 1.613-1.958 2.137-3.175A9.738 9.738 0 0 0 22 12a9.738 9.738 0 0 0-.788-3.9 10.099 10.099 0 0 0-2.137-3.175c-.9-.9-1.958-1.612-3.175-2.137A9.737 9.737 0 0 0 12 2a9.737 9.737 0 0 0-3.9.788 10.099 10.099 0 0 0-3.175 2.137c-.9.9-1.612 1.958-2.137 3.175A9.738 9.738 0 0 0 2 12a10.179 10.179 0 0 0 .95 4.3Z"})})}wb.displayName="ChatSolidIcon";const Sb=(0,s.forwardRef)(wb);var Ab=n("./src/stores/notifications/NotificationState.ts");const Cb=({room:e})=>{const t=(0,s.useContext)(Wa.A),n=t.roomNotificationStateStore.getRoomState(e),i=(0,Me.dF)(n,Ab.ce.Update,(()=>null==n?void 0:n.level)),r=!!i&&[pa.S.Activity,pa.S.Notification,pa.S.Highlight].includes(i);return s.createElement(Te.m,{label:(0,P._t)("right_panel|video_room_chat|title")},s.createElement(Xa.K,{"aria-label":(0,P._t)("right_panel|video_room_chat|title"),onClick:e=>{e.stopPropagation(),t.rightPanelStore.showOrHidePhase(sl.n.Timeline)},indicator:r?"default":void 0},s.createElement(Sb,null)))};var xb=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/check.js");const kb=({room:e})=>{const[t,n]=(0,s.useState)(!1),r=(0,Me.DY)(e,i.RoomStateEvent.Update,(0,s.useCallback)((()=>e.getMembersWithMembership(oa.O.Knock)),[e])),o=r.length;if(e.getJoinRule()!==i.JoinRule.Knock||0===o)return null;const a=e.client,l=a.getUserId()||"",c=e.canInvite(l),d=e.getMember(l),u=e.getLiveTimeline().getState(i.EventTimeline.FORWARDS),m=!(!d||!u)&&u.hasSufficientPowerLevelFor("kick",d.powerLevel);if(!c&&!m)return null;const p=e=>{A.Ay.createDialog(_v.A,{title:e.name,description:e.message})},h=()=>w.A.dispatch({action:"open_room_settings",room_id:e.roomId,initial_tab_id:fh.e.People});let g=s.createElement(Ae.A,{className:"mx_RoomKnocksBar_action",kind:"primary",onClick:h,title:(0,P._t)("action|view")},(0,P._t)("action|view")),v=(0,lh.ki)(r.map((e=>e.name)),3,!0),f=null;var _;1===o&&(g=s.createElement(s.Fragment,null,s.createElement(Ae.A,{className:"mx_RoomKnocksBar_action",disabled:!m||t,kind:"icon_primary_outline",onClick:()=>(t=>{n(!0),a.kick(e.roomId,t).catch(p).finally((()=>n(!1)))})(r[0].userId),title:(0,P._t)("action|deny")},s.createElement(ab.A,{width:18,height:18})),s.createElement(Ae.A,{className:"mx_RoomKnocksBar_action",disabled:!c||t,kind:"icon_primary",onClick:()=>(t=>{n(!0),a.invite(e.roomId,t).catch(p).finally((()=>n(!1)))})(r[0].userId),title:(0,P._t)("action|approve")},s.createElement(xb.A,{width:18,height:18}))),v=`${r[0].name} (${r[0].userId})`,f=(null===(_=r[0].events.member)||void 0===_?void 0:_.getContent().reason)&&s.createElement(Ae.A,{className:"mx_RoomKnocksBar_link",element:"a",kind:"link_inline",onClick:h},(0,P._t)("action|view_message")));return s.createElement("div",{className:"mx_RoomKnocksBar"},r.slice(0,2).map((e=>s.createElement($p.A,{className:"mx_RoomKnocksBar_avatar",key:e.userId,member:e,size:"32px"}))),s.createElement("div",{className:"mx_RoomKnocksBar_content"},s.createElement(uc.A,{size:"4"},(0,P._t)("room|header|n_people_asking_to_join",{count:o})),s.createElement("p",{className:"mx_RoomKnocksBar_paragraph"},v,f)),g)},Rb=({room:e})=>{const{canInviteGuests:t,guestSpaUrl:n,isRoomJoinable:i,canInvite:r}=_b(e),a=(0,s.useCallback)((()=>{if(!i())throw new Error("Cannot create link for room that users can not join without invite.");if(!n)throw new Error("No guest SPA url for external links provided.");const t=new URL(n);t.pathname="/room/",t.searchParams.set("roomId",e.roomId),e.hasEncryptionStateEvent()&&t.searchParams.set("perParticipantE2EE","true");for(const n of(0,uu.Ex)(e))t.searchParams.set("viaServers",n);return t.hash="/"+e.name+t.search,t.search="",o.v.info("Generated element call external url:",t),t}),[n,i,e]),l=(0,s.useCallback)((()=>{try{const e=a();A.Ay.createDialog(wp.G,{target:e,customTitle:(0,P._t)("share|share_call"),subtitle:(0,P._t)("share|share_call_subtitle")})}catch(e){o.v.error("Could not generate call link.",e)}}),[a]),c=(0,s.useCallback)((()=>{i()?l():A.Ay.createDialog(Ib,{room:e,canInvite:r}).finished.then((()=>{i()&&l()}))}),[i,l,e,r]);return s.createElement(s.Fragment,null,t&&s.createElement(Te.m,{label:(0,P._t)("voip|get_call_link")},s.createElement(Xa.K,{onClick:c},s.createElement(ip.A,null))))},Ib=({onFinished:e,room:t,canInvite:n})=>{const r=V.A.getValue("feature_ask_to_join"),[o,a]=s.useState(void 0),l=(0,s.useCallback)((async n=>{void 0===o&&(a(n),await t.client.sendStateEvent(t.roomId,i.EventType.RoomJoinRules,{join_rule:n},""),setTimeout((()=>e()),500))}),[o,e,t.client,t.roomId]);return s.createElement(Pa.A,{title:(0,P._t)("update_room_access_modal|title"),onFinished:e,className:"mx_JoinRuleDialog"},s.createElement("p",null,(0,P._t)("update_room_access_modal|description")),s.createElement("div",{className:"mx_JoinRuleDialogButtons"},r&&n&&s.createElement(Sl.$,{kind:"secondary",className:"mx_Dialog_nonDialogButton",disabled:o===i.JoinRule.Knock,onClick:()=>l(i.JoinRule.Knock)},(0,P._t)("action|ask_to_join")),s.createElement(Sl.$,{className:"mx_Dialog_nonDialogButton",kind:"destructive",disabled:o===i.JoinRule.Public,onClick:()=>l(i.JoinRule.Public)},(0,P._t)("common|public"))),s.createElement("p",null,(0,P._t)("update_room_access_modal|dont_change_description")),s.createElement("div",{className:"mx_JoinRuleDialogButtons"},s.createElement(Sl.$,{kind:"tertiary",className:"mx_Dialog_nonDialogButton",onClick:()=>{void 0===o&&e()}},(0,P._t)("update_room_access_modal|no_change"))))};n("./src/utils/presence.ts"),n("./src/utils/room/getJoinedNonFunctionalMembers.ts"),n("./src/components/views/rooms/PresenceLabel.tsx");function Tb(e){const t=mc.A.shared().getUserIdForRoomId(e.roomId);return t?e.getMember(t):null}const Pb=e=>{const[t,n]=(0,s.useState)(Tb(e)),r=()=>{n(Tb(e))};return(0,Me.ml)(e.currentState,i.RoomStateEvent.Members,r),(0,Me.ml)(e.client,i.ClientEvent.AccountData,r),(0,s.useEffect)(r,[e]),t};var Nb=n("./src/tchap/@types/tchap.ts");function Db(e){return pg.A.getTchapRoomAccessRule(e)===Nb.Kv.Unrestricted}function Mb({room:e}){const t=function(e){const[t,n]=(0,s.useState)(Db(e));return(0,Me.YK)(e.currentState,i.RoomStateEvent.Events,(t=>{console.log(t.getType()),t.getType()===Nb.Ep&&n(Db(e))})),t}(e);return t?s.createElement("div",{className:"tc_RoomHeader_external"},s.createElement("span",null,(0,P._t)("External users allowed"))):null}function Ob({room:e,additionalButtons:t,oobData:n}){const r=(0,Pe.nH)(),o=function(e,t){let n=(0,P._t)("common|unnamed_room");t&&t.name&&(n=t.name);const[r,o]=(0,s.useState)(mb(e,n));return(0,Me.YK)(e,i.RoomEvent.Name,(()=>{o(mb(e,n))})),(0,s.useEffect)((()=>{o(mb(e,n))}),[e,n]),r}(e),a=((0,Kh.U)(e,(e=>e.getJoinRule())),ry(e,2500)),l=sy(e,{throttleWait:2500}),{voiceCallDisabledReason:c,voiceCallClick:d,videoCallDisabledReason:m,videoCallClick:p,toggleCallMaximized:h,isViewingCall:g,isConnectedToCall:_,hasActiveCallSession:b,callOptions:E,showVoiceCallButton:S,showVideoCallButton:A}=(e=>{var t,n;const i=(0,Oe.ny)("feature_group_calls"),r=(0,s.useMemo)((()=>u.Ay.get("element_call").use_exclusively),[]),o=(0,Me.dF)(Ee.Ay.instance,Ee.uv.CallsChanged,(()=>null!==Ee.Ay.instance.getCallForRoom(e.roomId))),a=(0,wg.X)(e),l=(0,s.useMemo)((()=>a.find((e=>Bg.x.JITSI.matches(e.type)))),[a]),c=!!l,d=(0,s.useMemo)((()=>a.find(vb.ec)),[a]),m=!!d,p=(0,pb.Gc)(e.roomId),h=(0,pb.jd)(p)===hb.KN.Connected,g=null!==p,v=(0,pb.q0)(p)>0,f=(0,Me.dF)(Wa.M.instance.roomViewStore,I.H,(()=>Wa.M.instance.roomViewStore.isViewingCall()||(0,ig.j)(e))),_=sy(e),[y,b]=(0,Kh.U)(e,(()=>[e.currentState.mayClientSendStateEvent("im.vector.modular.widgets",e.client),e.currentState.mayClientSendStateEvent(hb.Ho.MEMBER_EVENT_TYPE.name,e.client)])),E=(0,s.useMemo)((()=>{const e=[];return _<=2?e.push(yb.LegacyCall):(y||c)&&e.push(yb.JitsiCall),i&&((g||b)&&e.push(yb.ElementCall),r&&!c)||g&&Bg.x.CALL.matches(p.widget.type)?[yb.ElementCall]:e}),[_,y,c,i,g,b,r,null==p?void 0:p.widget.type]);let S;var A;(E.includes(yb.JitsiCall)||E.includes(yb.LegacyCall))&&(S=null!=l?l:d),S=E.includes(yb.ElementCall)?null==p?void 0:p.widget:null!==(A=null==p?void 0:p.widget)&&void 0!==A?A:l;const C=(0,s.useCallback)((()=>{k(Sv.aK.instance.canAddToContainer(e,Sv.mc.Top)),N(!!S&&Sv.aK.instance.isInContainer(e,S,Sv.mc.Top))}),[e,S]);(0,Me.ml)(Sv.aK.instance,Sv.aK.emissionForRoom(e),C),(0,s.useEffect)((()=>{C()}),[e,l,p,C]);const[x,k]=(0,s.useState)(!1),[T,N]=(0,s.useState)(!1),D=!Bg.x.CALL.matches(null!==(t=null===(n=S)||void 0===n?void 0:n.type)&&void 0!==t?t:"")&&x&&!T,M=(0,Me.dF)(fb.e.instance,fb.s.ConnectedCalls,(()=>Array.from(fb.e.instance.connectedCalls))),{canInviteGuests:O}=_b(e),L=(0,s.useMemo)((()=>M.find((t=>t.roomId!=e.roomId))?Eb.Ongoing:g&&(c||m)?D?Eb.Unpinned:Eb.Ongoing:o?Eb.Ongoing:_<=1&&!O?Eb.NoOneHere:b||y?Eb.NoCall:Eb.NoPermission),[M,O,g,c,o,m,b,y,_,D,e.roomId]),F=(0,s.useCallback)(((t,n)=>{var i;null==t||t.stopPropagation(),S&&D?Sv.aK.instance.moveToContainer(e,S,Sv.mc.Top):gb(e,su.JG.Voice,n,null!==(i=null==t?void 0:t.shiftKey)&&void 0!==i&&i)}),[D,e,S]),U=(0,s.useCallback)(((t,n)=>{var i;null==t||t.stopPropagation(),S&&D?Sv.aK.instance.moveToContainer(e,S,Sv.mc.Top):gb(e,su.JG.Video,n,null!==(i=null==t?void 0:t.shiftKey)&&void 0!==i&&i)}),[S,D,e]);let B,j;switch(L){case Eb.NoPermission:B=null,j=null;break;case Eb.Ongoing:B=(0,P._t)("voip|disabled_ongoing_call"),j=(0,P._t)("voip|disabled_ongoing_call");break;case Eb.NoOneHere:B=(0,P._t)("voip|disabled_no_one_here"),j=(0,P._t)("voip|disabled_no_one_here");break;case Eb.Unpinned:case Eb.NotJoined:case Eb.NoCall:B=null,j=null}const z=(0,s.useCallback)((()=>{w.A.dispatch({action:R.r.ViewRoom,room_id:e.roomId,metricsTrigger:void 0,view_call:!f})}),[f,e.roomId]);let W=(0,vb.dq)(e)||!E.includes(yb.LegacyCall),H=!1;return _>2&&!V.A.getValue($.f.Widgets)&&(W=!0,H=!0),{voiceCallDisabledReason:B,voiceCallClick:F,videoCallDisabledReason:j,videoCallClick:U,toggleCallMaximized:z,isViewingCall:f,isConnectedToCall:h,hasActiveCallSession:v,callOptions:E,showVoiceCallButton:!W,showVideoCallButton:!H}})(e),C=(0,Oe.ny)("feature_group_calls"),x=(0,s.useMemo)((()=>u.Ay.get("element_call").use_exclusively&&C),[C]),k=(e=>{const[t,n]=(0,s.useState)(pa.S.None),r=(0,s.useCallback)((()=>{switch(null==e?void 0:e.threadsAggregateNotificationType){case i.NotificationCountType.Highlight:return void n(pa.S.Highlight);case i.NotificationCountType.Total:return void n(pa.S.Notification)}(0,ol.Nb)(e)?n(pa.S.Activity):n(pa.S.None)}),[e]);return(0,Me.ml)(e,i.RoomEvent.UnreadNotifications,r),(0,Me.ml)(e,i.RoomEvent.Receipt,r),(0,Me.ml)(e,i.RoomEvent.Timeline,r),(0,Me.ml)(e,i.RoomEvent.Redaction,r),(0,Me.ml)(e,i.RoomEvent.LocalEchoUpdated,r),(0,Me.ml)(e,i.RoomEvent.MyMembership,r),(0,Me.ml)(e,i.ThreadEvent.New,r),(0,Me.ml)(e,i.ThreadEvent.Update,r),(0,s.useEffect)((()=>{r()}),[r]),t})(e),T=(()=>{const[e,t]=(0,s.useState)(Ea.n.instance.globalState);return(0,Me.ml)(Ea.n.instance,Ea.N,(e=>{t(e)})),e})(),N=!!Pb(e),D=(function(e,t){const[n,r]=(0,s.useState)(null),o=(0,s.useMemo)((()=>(0,v.throttle)((()=>{e.getCrypto()&&(0,Y_.G)(e,t).then((e=>{r(e)}))}),250,{leading:!0,trailing:!0})),[e,t]);(0,s.useEffect)(o,[o]),(0,Me.YK)(t,i.RoomStateEvent.Members,o),(0,Me.YK)(e,f.CryptoEvent.UserTrustStatusChanged,o),(0,Me.YK)(e,f.CryptoEvent.DevicesUpdated,o)}(r,e),(0,Oe.ny)("feature_notifications")),M=(0,Oe.ny)("feature_ask_to_join"),O=(0,s.useCallback)((e=>p(e,E[0])),[E,p]),L=s.createElement(Te.m,{label:g?(0,P._t)("voip|minimise_call"):(0,P._t)("voip|maximise_call")},s.createElement(Xa.K,{onClick:h},s.createElement(rb.A,null))),F=s.createElement(Te.m,{label:null!=m?m:(0,P._t)("voip|video_call")},s.createElement(Sl.$,{size:"sm",onClick:O,Icon:rb.A,className:"mx_RoomHeader_join_button",disabled:!!m,color:"primary","aria-label":null!=m?m:(0,P._t)("action|join")},(0,P._t)("action|join"))),U=s.createElement(Te.m,{label:null!=m?m:(0,P._t)("voip|video_call")},s.createElement(rb.A,null)),[B,j]=(0,s.useState)(!1),z=(0,s.useCallback)((e=>{m||j(e)}),[m]),W=s.createElement(s.Fragment,null,E.length>1?s.createElement($a.W,{open:B,onOpenChange:z,title:(0,P._t)("voip|video_call_using"),trigger:s.createElement(Xa.K,{disabled:!!m,"aria-label":null!=m?m:(0,P._t)("voip|video_call")},U),side:"left",align:"start"},E.map((e=>{const{label:t,children:n}=bb(e);return s.createElement(Ya.D,{key:e,label:t,"aria-label":t,children:n,className:"mx_RoomHeader_videoCallOption",onClick:t=>p(t,e),Icon:rb.A,onSelect:()=>{}})}))):s.createElement(Xa.K,{disabled:!!m,"aria-label":null!=m?m:(0,P._t)("voip|video_call"),onClick:O},U));let H=s.createElement(Te.m,{label:null!=c?c:(0,P._t)("voip|voice_call")},s.createElement(Xa.K,{disabled:!!c||g||_,"aria-label":null!=c?c:(0,P._t)("voip|voice_call"),onClick:e=>d(e,E[0])},s.createElement(ob,null)));const G=s.createElement(Te.m,{label:(0,P._t)("voip|close_lobby")},s.createElement(Xa.K,{onClick:h},s.createElement(ab.A,null)));let K=W;_?K=L:g&&(K=G),A||(K=void 0),S||(H=void 0);const J=(0,Ld.ME)("mainSplitContentType"),q=(0,ig.j)(e),Y=q||J.mainSplitContentType===Sp.DZ.MaximisedWidget||J.mainSplitContentType===Sp.DZ.Call;return s.createElement(s.Fragment,null,s.createElement(zh.s,{as:"header",align:"center",gap:"var(--cpd-space-3x)",className:"mx_RoomHeader light-panel"},s.createElement(il.A,{room:e,size:"40px"}),s.createElement(Mb,{room:e}),s.createElement("button",{"aria-label":(0,P._t)("right_panel|room_summary_card|title"),tabIndex:0,onClick:()=>rl.A.instance.showOrHidePhase(sl.n.RoomSummary),className:"mx_RoomHeader_infoWrapper"},s.createElement(Qh,{flex:"1",className:"mx_RoomHeader_info"},s.createElement(ib,{as:"div",size:"lg",weight:"semibold",dir:"auto",role:"heading","aria-level":1,className:"mx_RoomHeader_heading"},s.createElement("span",{className:"mx_RoomHeader_truncated mx_lineClamp"},o)))),s.createElement(zh.s,{align:"center",gap:"var(--cpd-space-2x)"},null==t?void 0:t.map((e=>{const t=e.label();return s.createElement(Te.m,{label:t,key:e.id},s.createElement(Xa.K,{"aria-label":t,onClick:t=>{t.stopPropagation(),e.onClick()}},"function"==typeof e.icon?e.icon():e.icon))})),g&&s.createElement(Rb,{room:e}),!b||_||g?s.createElement(s.Fragment,null,!N&&Vl.A.isFeatureActiveForHomeserver("feature_video_group_call")&&pg.A.getTchapRoomType(e)!==Nb.C9.Forum&&!q&&K,N&&Vl.A.isFeatureActiveForHomeserver("feature_video_call")&&!q&&K,N&&Vl.A.isFeatureActiveForHomeserver("feature_audio_call")&&!x&&!q&&H):F,s.createElement(Te.m,{label:(0,P._t)("right_panel|room_summary_card|title")},s.createElement(Xa.K,{onClick:e=>{e.stopPropagation(),rl.A.instance.showOrHidePhase(sl.n.RoomSummary)},"aria-label":(0,P._t)("right_panel|room_summary_card|title")},s.createElement(cb,null))),Y&&s.createElement(Cb,{room:e}),Vl.A.isFeatureActiveForHomeserver("feature_thread")?s.createElement(Te.m,{label:(0,P._t)("common|threads")},s.createElement(Xa.K,{indicator:(0,el.W7)(k),onClick:e=>{e.stopPropagation(),rl.A.instance.showOrHidePhase(sl.n.ThreadPanel),y.A.trackInteraction("WebRoomHeaderButtonsThreadsButton",e)},"aria-label":(0,P._t)("common|threads")},s.createElement(Za.A,null))):null,D&&s.createElement(Te.m,{label:(0,P._t)("notifications|enable_prompt_toast_title")},s.createElement(Xa.K,{indicator:(0,el.W7)(T.level),onClick:e=>{e.stopPropagation(),rl.A.instance.showOrHidePhase(sl.n.NotificationPanel)},"aria-label":(0,P._t)("notifications|enable_prompt_toast_title")},s.createElement(ub,null)))),!N&&s.createElement(ib,{as:"div",size:"sm",weight:"medium"},s.createElement(ay.A,{className:"mx_RoomHeader_members",members:a.slice(0,3),size:"20px",overflow:!1,viewUserOnClick:!1,tooltipLabel:(0,P._t)("room|header_face_pile_tooltip"),onClick:e=>{rl.A.instance.showOrHidePhase(sl.n.MemberList),e.stopPropagation()},"aria-label":(0,P._t)("common|n_members",{count:l})},(0,lh.B4)(l)))),M&&s.createElement(kb,{room:e}))}const Lb=({roomWidth:e})=>{const t=(0,s.useRef)(null),i=(0,s.useRef)(new Map);return(0,s.useEffect)((()=>{const e=()=>{var e;t.current&&(null===(e=t.current)||void 0===e?void 0:e.height)!==Ie.A.instance.windowHeight&&(t.current.height=Ie.A.instance.windowHeight)},r=w.A.register((e=>{const r="effects.",s=function(e){if(!e)return!1;const t=Date.now(),n=e.getTs();return t-n>Fb}(e.event);if(t.current&&e.action.startsWith(r)&&!s){(async e=>{if(!e)return null;let t=i.current.get(e)||null;if(null===t){var r;const s=null===(r=Zg.y.find((t=>t.command===e)))||void 0===r?void 0:r.options;try{const{default:r}=await n("./src/effects lazy recursive ^\\.\\/.*$ referencedExports: default")(`./${e}`);t=new r(s),i.current.set(e,t)}catch(t){o.v.warn(`Unable to load effect module at '../../../effects/${e}.`,t)}}return t})(e.action.slice(8)).then((e=>null==e?void 0:e.start(t.current)))}})),s=t.current;return s&&(s.height=Ie.A.instance.windowHeight),Ie.A.instance.on(Ie.x.Resize,e),()=>{w.A.unregister(r),Ie.A.instance.off(Ie.x.Resize,e);const t=i.current;for(const e in t){const n=t.get(e);n&&n.isRunning&&n.stop()}}}),[]),s.createElement("canvas",{ref:t,width:e,style:{display:"block",zIndex:999999,pointerEvents:"none",position:"fixed",top:0,right:0},"aria-hidden":!0})},Fb=1728e5;const Ub=({room:e,resizing:t,call:n,skipLobby:i,role:r})=>{const o=(0,s.useContext)(Pe.Ay);(0,s.useEffect)((()=>{n.clean()}),[n]),(0,s.useEffect)((()=>{var e,t;null!==(t=(e=n.widget).data)&&void 0!==t||(e.data={}),n.widget.data.skipLobby=i}),[n.widget,i]),(0,s.useEffect)((()=>(n.connectionState===hb.KN.Disconnected&&n.start(),()=>{n.connected||n.destroy()})),[n]);const a=(0,s.useCallback)((async()=>{const e=[...fb.e.instance.connectedCalls].filter((e=>Wa.M.instance.roomViewStore.getRoomId()!==e.roomId));await Promise.all(e.map((async e=>await e.disconnect())))}),[]);return s.createElement("div",{className:"mx_CallView"},s.createElement(Vv,{app:n.widget,room:e,userId:o.credentials.userId,creatorUserId:n.widget.creatorUserId,waitForIframeLoad:n.widget.waitForIframeLoad,showMenubar:!1,pointerEvents:t?"none":void 0,stickyPromise:a}))},Bb=({room:e,resizing:t,waitForCall:n,skipLobby:i,role:r})=>{const o=(0,pb.Gc)(e.roomId);return(0,s.useEffect)((()=>{null!==o||n||hb.Ho.create(e,i)}),[o,e,i,n]),null===o?null:s.createElement(Ub,{room:e,resizing:t,call:o,skipLobby:i,role:r})};var Vb=n("./src/toasts/DesktopNotificationsToast.ts"),jb=n("./src/email.ts");const zb=(e,t)=>{const[n,i]=(0,s.useState)((()=>Array.isArray(t)?t:new Array(e).fill(t)));return[n,(e,t)=>i((n=>{const i=[...n];return i[e]=t,i}))]};var Wb=n("./src/components/views/dialogs/AddExistingToSpaceDialog.tsx"),Hb=n("./src/components/views/spaces/SpacePublicShare.tsx"),Gb=n("./node_modules/matrix-js-sdk/src/@types/event.ts");class Kb{constructor(e,t,n,i=!1){(0,h.A)(this,"viaMap",new Map),(0,h.A)(this,"backRefs",new Map),(0,h.A)(this,"roomMap",new Map),(0,h.A)(this,"loadRequest",void 0),(0,h.A)(this,"nextBatch",void 0),(0,h.A)(this,"_rooms",void 0),(0,h.A)(this,"serverSupportError",void 0),this.root=e,this.pageSize=t,this.maxDepth=n,this.suggestedOnly=i}get noSupport(){return!!this.serverSupportError}get canLoadMore(){return!!this.serverSupportError||!!this.nextBatch||!this._rooms}get loading(){return!!this.loadRequest}get rooms(){return this._rooms}async load(e=this.pageSize){if(this.loadRequest)return this.loadRequest.then((e=>e.rooms));let t;this.loadRequest=this.root.client.getRoomHierarchy(this.root.roomId,e,this.maxDepth,this.suggestedOnly,this.nextBatch);try{({rooms:t,next_batch:this.nextBatch}=await this.loadRequest)}catch(e){if("M_UNRECOGNIZED"!==e.errcode)throw e;return this.serverSupportError=e,[]}finally{this.loadRequest=void 0}return this._rooms?this._rooms=this._rooms.concat(t):this._rooms=t,t.forEach((e=>{this.roomMap.set(e.room_id,e),e.children_state.forEach((t=>{if(t.type!==Gb.Bx.SpaceChild)return;const n=t.state_key;if(this.backRefs.has(n)||this.backRefs.set(n,[]),this.backRefs.get(n).push(e.room_id),Array.isArray(t.content.via)){this.viaMap.has(n)||this.viaMap.set(n,new Set);const e=this.viaMap.get(n);t.content.via.forEach((t=>e.add(t)))}}))})),t}getRelation(e,t){var n;return null===(n=this.roomMap.get(e))||void 0===n?void 0:n.children_state.find((e=>e.state_key===t))}isSuggested(e,t){var n;return null===(n=this.getRelation(e,t))||void 0===n?void 0:n.content.suggested}removeRelation(e,t){const n=this.backRefs.get(t);1===(null==n?void 0:n.length)?this.backRefs.delete(t):null!=n&&n.length&&this.backRefs.set(t,n.filter((t=>t!==e)));const i=this.roomMap.get(e);i&&(i.children_state=i.children_state.filter((e=>e.state_key!==t)))}}var Jb=n("./src/components/views/elements/InfoTooltip.tsx"),qb=n("./src/utils/RoomUpgrade.ts");function $b(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Yb(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?$b(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):$b(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const Zb=({room:e,suggested:t,selected:n,hasPermissions:r,onToggleClick:o,onViewRoomClick:a,onJoinRoomClick:l,numChildRooms:c,children:d})=>{var u,m;const p=(0,s.useContext)(Pe.Ay),h=(0,Me.DY)(p,i.ClientEvent.Room,(()=>{const t=null==p?void 0:p.getRoom(e.room_id);return(null==t?void 0:t.getMyMembership())===oa.O.Join?t:void 0})),g=(0,Me.DY)(h,i.RoomEvent.Name,(e=>null==e?void 0:e.name)),v=g||e.name||e.canonical_alias||(null===(u=e.aliases)||void 0===u?void 0:u[0])||(e.room_type===i.RoomType.Space?(0,P._t)("common|unnamed_space"):(0,P._t)("common|unnamed_room")),[f,_]=(0,xa.X)(!0),[y,b,E,w]=(0,ha.A9)(),[S,A]=(0,s.useState)(!1),C=e=>{e.preventDefault(),e.stopPropagation(),a()},x=async t=>{A(!0),t.preventDefault(),t.stopPropagation();try{await l(),await(0,qb.R)(p,e.room_id)}finally{A(!1)}};let k,R,I;k=S?s.createElement(Ae.A,{disabled:!0,onClick:x,kind:"primary_outline",onFocus:y,tabIndex:b?0:-1,title:(0,P._t)("space|joining_space")},s.createElement(Na.A,{w:24,h:24})):h||e.join_rule===i.JoinRule.Knock?s.createElement(Ae.A,{onClick:C,kind:"primary_outline",onFocus:y,tabIndex:b?0:-1},(0,P._t)("action|view")):s.createElement(Ae.A,{onClick:x,kind:"primary",onFocus:y,tabIndex:b?0:-1},(0,P._t)("action|join")),o&&(R=r?s.createElement(ka.A,{checked:!!n,onChange:o,tabIndex:b?0:-1}):s.createElement(Kg.A,{tooltip:(0,P._t)("space|user_lacks_permission"),onClick:e=>{e.stopPropagation()}},s.createElement(ka.A,{disabled:!0,tabIndex:b?0:-1}))),I=h?s.createElement(aa.A,{room:h,size:"20px"}):s.createElement(ja.A,{name:v,idName:e.room_id,url:e.avatar_url?(0,Up.lH)(e.avatar_url).getSquareThumbnailHttp(20):null,size:"20px"});let T,N,D,M,O=(0,P._t)("common|n_members",{count:null!==(m=e.num_joined_members)&&void 0!==m?m:0});if(void 0!==c&&(O+=" Â· "+(0,P._t)("common|n_rooms",{count:c})),h){const e=(0,Jh.e)(h);T=(0,qh.sH)(null==e?void 0:e.text,null==e?void 0:e.html)}else T=e.topic;T&&(N=s.createElement(qh.XZ,{options:{attributes:{onClick(e){e.stopPropagation()}}}}," Â· ",T)),h&&(D=s.createElement("div",{className:"mx_SpaceHierarchy_roomTile_joined"},(0,P._t)("common|joined"))),!t||h&&!r||(M=s.createElement(Jb.A,{tooltip:(0,P._t)("space|suggested_tooltip")},(0,P._t)("space|suggested")));const L=s.createElement(s.Fragment,null,s.createElement("div",{className:"mx_SpaceHierarchy_roomTile_item"},s.createElement("div",{className:"mx_SpaceHierarchy_roomTile_avatar"},I),s.createElement("div",{className:"mx_SpaceHierarchy_roomTile_name"},v,D,M),s.createElement("div",{className:"mx_SpaceHierarchy_roomTile_info"},O,N)),s.createElement("div",{className:"mx_SpaceHierarchy_actions"},k,R));let F,U,B;if(d){if(F=s.createElement("div",{className:re()("mx_SpaceHierarchy_subspace_toggle",{mx_SpaceHierarchy_subspace_toggle_shown:f}),onClick:e=>{e.stopPropagation(),_()}}),f){const e=e=>{var t;if((0,Re.zM)().getAccessibilityAction(e)===Se.bY.ArrowLeft)e.preventDefault(),e.stopPropagation(),null===(t=w.current)||void 0===t||t.focus()};U=s.createElement("div",{className:"mx_SpaceHierarchy_subspace_children",onKeyDown:e,role:"group"},d)}B=e=>{let t=!1;switch((0,Re.zM)().getAccessibilityAction(e)){case Se.bY.ArrowLeft:f&&(t=!0,_());break;case Se.bY.ArrowRight:if(t=!0,f){var n,i;const e=null===(n=w.current)||void 0===n?void 0:n.nextElementSibling;null==e||null===(i=e.querySelector(".mx_SpaceHierarchy_roomTile"))||void 0===i||i.focus()}else _()}t&&(e.preventDefault(),e.stopPropagation())}}return s.createElement("li",{className:"mx_SpaceHierarchy_roomTileWrapper",role:"treeitem","aria-selected":n,"aria-expanded":d?f:void 0},s.createElement(Ae.A,{className:re()("mx_SpaceHierarchy_roomTile",{mx_SpaceHierarchy_subspace:e.room_type===i.RoomType.Space,mx_SpaceHierarchy_joining:S}),onClick:r&&o?o:C,onKeyDown:B,ref:E,onFocus:y,tabIndex:b?0:-1},L,F),U)},Xb=(e,t,n,i)=>{var r,s;const o=t.roomMap.get(n);if(e.isGuest()&&!(null!=o&&o.world_readable||null!=o&&o.guest_can_join))return void w.A.dispatch({action:"require_registration"});const a=(0,x.iW)(null!==(r=null==o?void 0:o.canonical_alias)&&void 0!==r?r:"",null!==(s=null==o?void 0:o.aliases)&&void 0!==s?s:[])||void 0;w.A.dispatch({action:R.r.ViewRoom,should_peek:!0,room_alias:a,room_id:n,via_servers:Array.from(t.viaMap.get(n)||[]),oob_data:{avatarUrl:null==o?void 0:o.avatar_url,name:(null==o?void 0:o.name)||a||(0,P._t)("common|unnamed_room"),roomType:i},metricsTrigger:"RoomDirectory"})},Qb=async(e,t,n)=>{if(e.isGuest())w.A.dispatch({action:"require_registration"});else{try{await e.joinRoom(n,{viaServers:Array.from(t.viaMap.get(n)||[])})}catch(e){throw e instanceof i.MatrixError?Wa.M.instance.roomViewStore.showJoinRoomError(e,n):(o.v.warn("Got a non-MatrixError while joining room",e),Wa.M.instance.roomViewStore.showJoinRoomError(new i.MatrixError({error:(0,P._t)("error|unknown")}),n)),e}w.A.dispatch({action:R.r.JoinRoomReady,roomId:n,metricsTrigger:"SpaceHierarchy"})}},eE=({root:e,roomSet:t,hierarchy:n,parents:r,selectedMap:o,onViewRoomClick:a,onJoinRoomClick:l,onToggleClick:c})=>{const d=(0,s.useContext)(Pe.Ay),u=d.getRoom(e.room_id),m=null==u?void 0:u.currentState.maySendStateEvent(i.EventType.SpaceChild,d.getSafeUserId()),p=(0,v.sortBy)(e.children_state,(e=>(0,xe.tK)(e.content.order,e.origin_server_ts,e.state_key))),[h,g]=p.reduce(((e,r)=>{const s=n.roomMap.get(r.state_key);return s&&t.has(s)&&e[s.room_type===i.RoomType.Space?0:1].push(((e,t,n)=>{const r=e.getRoomUpgradeHistory(t.room_id,!0,V.A.getValue("feature_dynamic_room_predecessors"));let s=null;for(let e=r.length-1;e>=0;--e)if(n.roomMap.get(r[e].roomId)){s=r[e];break}var o,a,l,c,d;return s?Yb(Yb({},t),{},{room_id:s.roomId,room_type:s.getType(),name:s.name,topic:null===(o=s.currentState.getStateEvents(i.EventType.RoomTopic,""))||void 0===o?void 0:o.getContent().topic,avatar_url:null!==(a=s.getMxcAvatarUrl())&&void 0!==a?a:void 0,canonical_alias:null!==(l=s.getCanonicalAlias())&&void 0!==l?l:void 0,aliases:s.getAltAliases(),world_readable:(null===(c=s.currentState.getStateEvents(i.EventType.RoomHistoryVisibility,""))||void 0===c?void 0:c.getContent().history_visibility)===i.HistoryVisibility.WorldReadable,guest_can_join:(null===(d=s.currentState.getStateEvents(i.EventType.RoomGuestAccess,""))||void 0===d?void 0:d.getContent().guest_access)===i.GuestAccess.CanJoin,num_joined_members:s.getJoinedMemberCount()}):t})(d,s,n)),e}),[[],[]]),f=new Set(r).add(e.room_id);return s.createElement(s.Fragment,null,(0,v.uniqBy)(g,"room_id").map((t=>{var i;return s.createElement(Zb,{key:t.room_id,room:t,suggested:n.isSuggested(e.room_id,t.room_id),selected:null==o||null===(i=o.get(e.room_id))||void 0===i?void 0:i.has(t.room_id),onViewRoomClick:()=>a(t.room_id,t.room_type),onJoinRoomClick:()=>l(t.room_id,f),hasPermissions:m,onToggleClick:c?()=>c(e.room_id,t.room_id):void 0})})),h.filter((e=>!f.has(e.room_id))).map((r=>{var d;return s.createElement(Zb,{key:r.room_id,room:r,numChildRooms:r.children_state.filter((e=>{const i=n.roomMap.get(e.state_key);return i&&t.has(i)&&!i.room_type})).length,suggested:n.isSuggested(e.room_id,r.room_id),selected:null==o||null===(d=o.get(e.room_id))||void 0===d?void 0:d.has(r.room_id),onViewRoomClick:()=>a(r.room_id,i.RoomType.Space),onJoinRoomClick:()=>l(r.room_id,f),hasPermissions:m,onToggleClick:c?()=>c(e.room_id,r.room_id):void 0},s.createElement(eE,{root:r,roomSet:t,hierarchy:n,parents:f,selectedMap:o,onViewRoomClick:a,onJoinRoomClick:l,onToggleClick:c}))})))},tE=({hierarchy:e,selected:t,setSelected:n,setError:r})=>{const o=(0,s.useContext)(Pe.Ay),[a,l]=(0,s.useState)(!1),[c,d]=(0,s.useState)(!1),u=Array.from(t.keys()).flatMap((e=>[...t.get(e).values()].map((t=>[e,t])))),m=u.every((([t,n])=>e.isSuggested(t,n))),p=!u.length||a||c;let h=(0,P._t)("common|saving");c||(h=m?(0,P._t)("space|unmark_suggested"):(0,P._t)("space|mark_suggested"));const g=u.length?void 0:(0,P._t)("space|select_room_below");return s.createElement(s.Fragment,null,s.createElement(Ae.A,{onClick:async()=>{l(!0);try{const t=o.getSafeUserId();for(const[n,r]of u){await o.sendStateEvent(n,i.EventType.SpaceChild,{},r);const s=o.getRoom(r),a=null==s?void 0:s.currentState.getStateEvents(i.EventType.SpaceParent,n);null!=s&&s.currentState.maySendStateEvent(i.EventType.SpaceParent,t)&&Array.isArray(null==a?void 0:a.getContent().via)&&await o.sendStateEvent(r,i.EventType.SpaceParent,{},n),e.removeRelation(n,r)}}catch{r((0,P._t)("space|failed_remove_rooms"))}l(!1),n(new Map)},kind:"danger_outline",disabled:p,"aria-label":a?(0,P._t)("redact|ongoing"):(0,P._t)("action|remove"),title:g,placement:"top"},a?(0,P._t)("redact|ongoing"):(0,P._t)("action|remove")),s.createElement(Ae.A,{onClick:async()=>{d(!0);try{for(const[n,r]of u){var t;const s=!m,a=null===(t=e.getRelation(n,r))||void 0===t?void 0:t.content;if(!a||a.suggested===s)continue;const l=Yb(Yb({},a),{},{suggested:!m});await o.sendStateEvent(n,i.EventType.SpaceChild,l,r),a.suggested=l.suggested}}catch{r("Failed to update some suggestions. Try again later")}d(!1),n(new Map)},kind:"primary_outline",disabled:p,"aria-label":h,title:g,placement:"top"},h))},nE=({space:e,initialText:t="",showRoom:n,additionalButtons:r})=>{const o=(0,s.useContext)(Pe.Ay),[a,l]=(0,s.useState)(t),[c,d]=(0,s.useState)(new Map),{loading:u,rooms:m,hierarchy:p,loadMore:h,error:g}=(e=>{const[t,n]=(0,s.useState)([]),[i,r]=(0,s.useState)(),[o,a]=(0,s.useState)(),l=(0,s.useCallback)((()=>{a(void 0);const t=new Kb(e,20);t.load().then((()=>{var i;e===t.root&&n(null!==(i=t.rooms)&&void 0!==i?i:[])}),a),r(t)}),[e]);(0,s.useEffect)(l,[l]),(0,De.F)(w.A,(e=>{e.action===R.r.UpdateSpaceHierarchy&&(n([]),l())}));const c=(0,s.useCallback)((async e=>{var t;!i||i.loading||!i.canLoadMore||i.noSupport||o||(await i.load(e).catch(a),n(null!==(t=i.rooms)&&void 0!==t?t:[]))}),[o,i]);return(null==i?void 0:i.root)!==e?{loading:!0,loadMore:c}:{loading:i.loading,rooms:t,hierarchy:i,loadMore:c,error:o}})(e),v=(0,s.useMemo)((()=>{if(null==m||!m.length||!p)return new Set;const e=a.toLowerCase().trim();if(!e)return new Set(m);const t=m.filter((t=>{var n,i;return(null===(n=t.name)||void 0===n?void 0:n.toLowerCase().includes(e))||(null===(i=t.topic)||void 0===i?void 0:i.toLowerCase().includes(e))})),n=new Set,i=[...t.map((e=>e.room_id))];for(;i.length;){var r;const e=i.pop();n.add(e),null===(r=p.backRefs.get(e))||void 0===r||r.forEach((e=>{n.has(e)||i.push(e)}))}return new Set(m.filter((e=>n.has(e.room_id))))}),[m,p,a]),[f,_]=(0,s.useState)("");let y=f;!f&&g&&(y=(0,P._t)("space|failed_load_rooms"));const b=(e=>{const t=t=>{t[0].isIntersecting&&e()},n=(0,s.useRef)();return e=>{n.current?n.current.disconnect():e&&(n.current=new IntersectionObserver(t,{root:e.parentElement,rootMargin:"0px 0px 600px 0px"})),n.current&&e&&n.current.observe(e)}})(h);if(!u&&p.noSupport)return s.createElement("p",null,(0,P._t)("space|incompatible_server_hierarchy"));const E=(e,t)=>{if(_(""),!c.has(e))return void d(new Map(c.set(e,new Set([t]))));const n=c.get(e);n.has(t)?(n.delete(t),d(new Map(c.set(e,new Set(n))))):d(new Map(c.set(e,new Set([...n,t]))))};return s.createElement(ha.Se,{onKeyDown:(e,t)=>{var n;(0,Re.zM)().getAccessibilityAction(e)===Se.bY.ArrowDown&&e.currentTarget.classList.contains("mx_SpaceHierarchy_search")&&(null===(n=t.nodes[0])||void 0===n||n.focus())},handleHomeEnd:!0,handleUpDown:!0},(({onKeyDownHandler:h})=>{let g;if(p&&(!u||null!=m&&m.length)){const t=(null==e?void 0:e.getMyMembership())===oa.O.Join&&e.currentState.maySendStateEvent(i.EventType.SpaceChild,o.getSafeUserId()),l=p.roomMap.get(e.roomId);let u,m;v.size&&l?u=s.createElement(s.Fragment,null,s.createElement(eE,{root:l,roomSet:v,hierarchy:p,parents:new Set,selectedMap:c,onToggleClick:t?E:void 0,onViewRoomClick:(e,t)=>n(o,p,e,t),onJoinRoomClick:async(e,t)=>{for(const e of t){var n;(null===(n=o.getRoom(e))||void 0===n?void 0:n.getMyMembership())!==oa.O.Join&&await Qb(o,p,e)}await Qb(o,p,e)}})):p.canLoadMore||(u=s.createElement("div",{className:"mx_SpaceHierarchy_noResults"},s.createElement("h3",null,(0,P._t)("common|no_results_found")),s.createElement("div",null,(0,P._t)("space|no_search_result_hint")))),p.canLoadMore&&(m=s.createElement("div",{ref:b},s.createElement(Na.A,null))),g=s.createElement(s.Fragment,null,s.createElement("div",{className:"mx_SpaceHierarchy_listHeader"},s.createElement("h4",{className:"mx_SpaceHierarchy_listHeader_header"},a.trim()?(0,P._t)("space|title_when_query_available"):(0,P._t)("space|title_when_query_unavailable")),s.createElement("div",{className:"mx_SpaceHierarchy_listHeader_buttons"},r,t&&s.createElement(tE,{hierarchy:p,selected:c,setSelected:d,setError:_}))),y&&s.createElement("div",{className:"mx_SpaceHierarchy_error"},y),s.createElement("ul",{className:"mx_SpaceHierarchy_list",onKeyDown:h,role:"tree","aria-label":(0,P._t)("common|space")},u),m)}else g=s.createElement(Na.A,null);return s.createElement(s.Fragment,null,s.createElement(Kv.A,{className:"mx_SpaceHierarchy_search mx_textinput_icon mx_textinput_search",placeholder:(0,P._t)("space|search_placeholder"),onSearch:l,autoFocus:!0,initialValue:t,onKeyDown:h}),g)}))};var iE=function(e){return e[e.Landing=0]="Landing",e[e.PublicCreateRooms=1]="PublicCreateRooms",e[e.PublicShare=2]="PublicShare",e[e.PrivateScope=3]="PrivateScope",e[e.PrivateInvite=4]="PrivateInvite",e[e.PrivateCreateRooms=5]="PrivateCreateRooms",e[e.PrivateExistingRooms=6]="PrivateExistingRooms",e}(iE||{});const rE=({space:e})=>{const[t,n,r,o]=(0,Fe.EF)(),a=(0,Ne.g)($.C.CreateRooms),l=((0,Ne.g)($.C.CreateSpaces),(0,Oe.ny)("feature_video_rooms")),c=(0,Oe.ny)("feature_element_call_video_rooms");let d=null;if(t){const t=n.current.getBoundingClientRect();d=s.createElement(Be.Ay,{left:t.left+window.scrollX+0,top:t.bottom+window.scrollY+8,chevronFace:Fe.t4.None,onFinished:o,className:"mx_RoomTile_contextMenu",compact:!0},s.createElement(Be.tx,{first:!0},a&&s.createElement(s.Fragment,null,s.createElement(Be.R$,{label:(0,P._t)("action|new_room"),iconClassName:"mx_RoomList_iconNewRoom",onClick:async t=>{t.preventDefault(),t.stopPropagation(),o(),y.A.trackInteraction("WebSpaceHomeCreateRoomButton",t),await(0,Le.PT)(e)&&w.A.fire(R.r.UpdateSpaceHierarchy)}}),l&&s.createElement(Be.R$,{label:(0,P._t)("action|new_video_room"),iconClassName:"mx_RoomList_iconNewVideoRoom",onClick:async t=>{t.preventDefault(),t.stopPropagation(),o(),await(0,Le.PT)(e,c?i.RoomType.UnstableCall:i.RoomType.ElementVideo)&&w.A.fire(R.r.UpdateSpaceHierarchy)}},s.createElement(Ue.s,null))),s.createElement(Be.R$,{label:(0,P._t)("action|add_existing_room"),iconClassName:"mx_RoomList_iconAddExistingRoom",onClick:t=>{t.preventDefault(),t.stopPropagation(),o(),(0,Le.yV)(e)}})))}return s.createElement(s.Fragment,null,s.createElement(Fe.VJ,{kind:"primary",ref:n,onClick:r,isExpanded:t,label:(0,P._t)("action|add")},(0,P._t)("action|add")),d)},sE=({space:e})=>{const t=(0,s.useContext)(Pe.Ay),n=oy(e),r=t.getSafeUserId(),o=(0,s.useCallback)((()=>{var t;return rl.A.instance.isOpenForRoom(e.roomId)&&(null===(t=rl.A.instance.currentCardForRoom(e.roomId))||void 0===t?void 0:t.phase)===sl.n.MemberList}),[e.roomId]),a=(0,Me.dF)(rl.A.instance,I.H,o);let l;(0,Le.MI)(e)&&(0,Ne.g)($.C.InviteUsers)&&(l=s.createElement(Ae.A,{kind:"primary",className:"mx_SpaceRoomView_landing_inviteButton",onClick:()=>{(0,Le.Lo)(e)}},(0,P._t)("action|invite")));let c,d;n===oa.O.Join&&e.currentState.maySendStateEvent(i.EventType.SpaceChild,r)&&(c=s.createElement(rE,{space:e})),(0,Le.Kv)(e)&&(d=s.createElement(Ae.A,{className:"mx_SpaceRoomView_landing_settingsButton",onClick:()=>{(0,Le.hL)(e)},title:(0,P._t)("common|settings"),placement:"bottom"}));return s.createElement("div",{className:"mx_SpaceRoomView_landing"},s.createElement("div",{className:"mx_SpaceRoomView_landing_header"},s.createElement(aa.A,{room:e,size:"80px",viewAvatarOnClick:!0,type:"square"})),s.createElement("div",{className:"mx_SpaceRoomView_landing_name"},s.createElement(Ap.A,{room:e},(e=>{const t={name:()=>s.createElement("h1",null,e)};return(0,P._t)("space|landing_welcome",{},t)}))),s.createElement("div",{className:"mx_SpaceRoomView_landing_infoBar"},s.createElement(my,{room:e}),s.createElement("div",{className:"mx_SpaceRoomView_landing_infoBar_interactive"},s.createElement(uy,{room:e,onlyKnownUsers:!1,numShown:7,onClick:a?void 0:()=>{rl.A.instance.setCard({phase:sl.n.MemberList})}}),l,d)),s.createElement(ng,{room:e,className:"mx_SpaceRoomView_landing_topic"}),s.createElement(nE,{space:e,showRoom:Xb,additionalButtons:c}))},oE=({space:e,title:t,description:n,onFinished:r})=>{const[a,l]=(0,s.useState)(!1),[c,d]=(0,s.useState)(""),u=[(0,P._t)("common|general"),(0,P._t)("common|random"),(0,P._t)("common|support")],[m,p]=zb(3,[(0,P._t)("common|general"),(0,P._t)("common|random"),""]),h=new Array(3).fill(0).map(((e,t)=>{const n="roomName"+t;return s.createElement(Sa.A,{key:n,name:n,type:"text",label:(0,P._t)("common|room_name"),placeholder:u[t],value:m[t],onChange:e=>p(t,e.target.value),autoFocus:2===t,disabled:a,autoComplete:"off"})})),g=async t=>{if(t.preventDefault(),!a){d(""),l(!0);try{var n;const t=e.getJoinRule()===i.JoinRule.Public,s=m.map((e=>e.trim())).filter(Boolean),o=await Promise.all(s.map((n=>(0,K.Ay)(e.client,{createOpts:{preset:t?i.Preset.PublicChat:i.Preset.PrivateChat,name:n},spinner:!1,encryption:!1,andView:!1,inlineErrors:!0,parentSpace:e,joinRule:t?void 0:i.JoinRule.Restricted,suggested:!0}))));r(null!==(n=o[0])&&void 0!==n?n:void 0)}catch(e){o.v.error("Failed to create initial space rooms",e),d((0,P._t)("create_space|failed_create_initial_rooms"))}l(!1)}};let v=e=>{e.preventDefault(),r()},f=(0,P._t)("create_space|skip_action");return m.some((e=>e.trim()))&&(v=g,f=a?(0,P._t)("create_space|creating_rooms"):(0,P._t)("action|continue")),s.createElement("div",null,s.createElement("h1",null,t),s.createElement("div",{className:"mx_SpaceRoomView_description"},n),c&&s.createElement("div",{className:"mx_SpaceRoomView_errorText"},c),s.createElement("form",{onSubmit:v,id:"mx_SpaceSetupFirstRooms"},h),s.createElement("div",{className:"mx_SpaceRoomView_buttons"},s.createElement(Ae.A,{kind:"primary",disabled:a,onClick:v,element:"input",type:"submit",form:"mx_SpaceSetupFirstRooms",value:f})))},aE=({space:e,onFinished:t})=>s.createElement("div",null,s.createElement("h1",null,(0,P._t)("create_space|add_existing_rooms_heading")),s.createElement("div",{className:"mx_SpaceRoomView_description"},(0,P._t)("create_space|add_existing_rooms_description")),s.createElement(Wb.sS,{space:e,emptySelectionButton:s.createElement(Ae.A,{kind:"primary",onClick:t},(0,P._t)("create_space|skip_action")),filterPlaceholder:(0,P._t)("space|room_filter_placeholder"),onFinished:t,roomsRenderer:Wb.FM,dmsRenderer:Wb.nZ})),lE=({justCreatedOpts:e,space:t,onFinished:n,firstRoomId:i})=>{var r;return s.createElement("div",{className:"mx_SpaceRoomView_publicShare"},s.createElement("h1",null,(0,P._t)("create_space|share_heading",{name:(null==e||null===(r=e.createOpts)||void 0===r?void 0:r.name)||t.name})),s.createElement("div",{className:"mx_SpaceRoomView_description"},(0,P._t)("create_space|share_description")),s.createElement(Hb.A,{space:t}),s.createElement("div",{className:"mx_SpaceRoomView_buttons"},s.createElement(Ae.A,{kind:"primary",onClick:n},i?(0,P._t)("create_space|done_action_first_room"):(0,P._t)("create_space|done_action"))))},cE=({space:e,justCreatedOpts:t,onFinished:n})=>{var i;return s.createElement("div",{className:"mx_SpaceRoomView_privateScope"},s.createElement("h1",null,(0,P._t)("create_space|private_personal_heading")),s.createElement("div",{className:"mx_SpaceRoomView_description"},(0,P._t)("create_space|private_personal_description",{name:(null==t||null===(i=t.createOpts)||void 0===i?void 0:i.name)||e.name})),s.createElement(Ae.A,{className:"mx_SpaceRoomView_privateScope_justMeButton",onClick:()=>{n(!1)}},(0,P._t)("create_space|personal_space"),s.createElement("div",null,(0,P._t)("create_space|personal_space_description"))),s.createElement(Ae.A,{className:"mx_SpaceRoomView_privateScope_meAndMyTeammatesButton",onClick:()=>{n(!0)}},(0,P._t)("create_space|private_space"),s.createElement("div",null,(0,P._t)("create_space|private_space_description"))))},dE=(0,Ip.A)({rules:[{key:"email",test:({value:e})=>!e||jb.X(e),invalid:()=>(0,P._t)("auth|email_field_label_invalid")}]}),uE=({space:e,onFinished:t})=>{const[n,i]=(0,s.useState)(!1),[r,a]=(0,s.useState)(""),l=[(0,s.useRef)(null),(0,s.useRef)(null),(0,s.useRef)(null)],[c,d]=zb(3,""),u=new Array(3).fill(0).map(((e,t)=>{const i="emailAddress"+t;return s.createElement(Sa.A,{key:i,name:i,type:"text",label:(0,P._t)("common|email_address"),placeholder:(0,P._t)("auth|email_field_label"),value:c[t],onChange:e=>d(t,e.target.value),ref:l[t],onValidate:dE,autoFocus:0===t,disabled:n})})),m=async r=>{if(r.preventDefault(),n)return;a("");for(const e of l){var s;if(!1===await(null===(s=e.current)||void 0===s?void 0:s.validate({allowEmpty:!0})))return e.current.focus(),void e.current.validate({allowEmpty:!0,focused:!0})}i(!0);const d=c.map((e=>e.trim())).filter(Boolean);try{const n=await(0,C.wq)(e.client,e.roomId,d),i=Object.keys(n.states).filter((e=>"error"===n.states[e]));i.length>0?(o.v.log("Failed to invite users to space: ",n),a((0,P._t)("create_space|failed_invite_users",{csvUsers:i.join(", ")}))):t()}catch(e){o.v.error("Failed to invite users to space: ",e),a((0,P._t)("invite|error_invite"))}i(!1)};let p=e=>{e.preventDefault(),t()},h=(0,P._t)("create_space|skip_action");return c.some((e=>e.trim()))&&(p=m,h=n?(0,P._t)("create_space|inviting_users"):(0,P._t)("action|continue")),s.createElement("div",{className:"mx_SpaceRoomView_inviteTeammates"},s.createElement("h1",null,(0,P._t)("create_space|invite_teammates_heading")),s.createElement("div",{className:"mx_SpaceRoomView_description"},(0,P._t)("create_space|invite_teammates_description")),r&&s.createElement("div",{className:"mx_SpaceRoomView_errorText"},r),s.createElement("form",{onSubmit:p,id:"mx_SpaceSetupPrivateInvite"},u),s.createElement("div",{className:"mx_SpaceRoomView_inviteTeammates_buttons"},s.createElement(Ae.A,{className:"mx_SpaceRoomView_inviteTeammates_inviteDialogButton",onClick:()=>(0,C._7)(e.roomId)},(0,P._t)("create_space|invite_teammates_by_username"))),s.createElement("div",{className:"mx_SpaceRoomView_buttons"},s.createElement(Ae.A,{kind:"primary",disabled:n,onClick:p,element:"input",type:"submit",form:"mx_SpaceSetupPrivateInvite",value:h})))};class mE extends s.PureComponent{constructor(e,t){var n;super(e,t),(0,h.A)(this,"dispatcherRef",void 0),(0,h.A)(this,"onMyMembership",((e,t)=>{e.roomId===this.props.space.roomId&&this.setState({myMembership:t})})),(0,h.A)(this,"onRightPanelStoreUpdate",(()=>{this.setState({showRightPanel:rl.A.instance.isOpenForRoom(this.props.space.roomId)})})),(0,h.A)(this,"onAction",(e=>{e.action!==R.r.ViewRoom||e.room_id!==this.props.space.roomId||this.setState({phase:iE.Landing})})),(0,h.A)(this,"goToFirstRoom",(async()=>{this.state.firstRoomId?w.A.dispatch({action:R.r.ViewRoom,room_id:this.state.firstRoomId,metricsTrigger:void 0}):this.setState({phase:iE.Landing})}));let r=iE.Landing;const s=null===(n=this.props.space.currentState.getStateEvents(i.EventType.RoomCreate,""))||void 0===n?void 0:n.getSender();var o;this.props.justCreatedOpts&&t.getSafeUserId()===s&&(r=(null===(o=this.props.justCreatedOpts.createOpts)||void 0===o?void 0:o.preset)===i.Preset.PublicChat?iE.PublicCreateRooms:iE.PrivateScope);this.state={phase:r,showRightPanel:rl.A.instance.isOpenForRoom(this.props.space.roomId),myMembership:this.props.space.getMyMembership()}}componentDidMount(){this.dispatcherRef=w.A.register(this.onAction),rl.A.instance.on(I.H,this.onRightPanelStoreUpdate),this.context.on(i.RoomEvent.MyMembership,this.onMyMembership)}componentWillUnmount(){w.A.unregister(this.dispatcherRef),rl.A.instance.off(I.H,this.onRightPanelStoreUpdate),this.context.off(i.RoomEvent.MyMembership,this.onMyMembership)}renderBody(){var e;switch(this.state.phase){case iE.Landing:return this.state.myMembership===oa.O.Join?s.createElement(sE,{space:this.props.space}):s.createElement(py,{room:this.props.space,onJoinButtonClicked:this.props.onJoinButtonClicked,onRejectButtonClicked:this.props.onRejectButtonClicked});case iE.PublicCreateRooms:return s.createElement(oE,{space:this.props.space,title:(0,P._t)("create_space|setup_rooms_community_heading",{spaceName:(null===(e=this.props.justCreatedOpts)||void 0===e||null===(e=e.createOpts)||void 0===e?void 0:e.name)||this.props.space.name}),description:s.createElement(s.Fragment,null,(0,P._t)("create_space|setup_rooms_community_description"),s.createElement("br",null),(0,P._t)("create_space|setup_rooms_description")),onFinished:e=>this.setState({phase:iE.PublicShare,firstRoomId:e})});case iE.PublicShare:return s.createElement(lE,{justCreatedOpts:this.props.justCreatedOpts,space:this.props.space,onFinished:this.goToFirstRoom,firstRoomId:this.state.firstRoomId});case iE.PrivateScope:return s.createElement(cE,{space:this.props.space,justCreatedOpts:this.props.justCreatedOpts,onFinished:e=>{this.setState({phase:e?iE.PrivateCreateRooms:iE.PrivateExistingRooms})}});case iE.PrivateInvite:return s.createElement(uE,{space:this.props.space,onFinished:()=>this.setState({phase:iE.Landing})});case iE.PrivateCreateRooms:return s.createElement(oE,{space:this.props.space,title:(0,P._t)("create_space|setup_rooms_private_heading"),description:s.createElement(s.Fragment,null,(0,P._t)("create_space|setup_rooms_private_description"),s.createElement("br",null),(0,P._t)("create_space|setup_rooms_description")),onFinished:e=>this.setState({phase:iE.PrivateInvite,firstRoomId:e})});case iE.PrivateExistingRooms:return s.createElement(aE,{space:this.props.space,onFinished:()=>this.setState({phase:iE.Landing})})}}render(){const e=this.state.showRightPanel&&this.state.phase===iE.Landing?s.createElement(K_,{room:this.props.space,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.props.permalinkCreator}):void 0;return s.createElement("main",{className:"mx_SpaceRoomView"},s.createElement(eh.A,null,s.createElement(gu,{panel:e,resizeNotifier:this.props.resizeNotifier,analyticsRoomType:"space"},this.renderBody())))}}(0,h.A)(mE,"contextType",Pe.Ay);var pE=n("./src/components/structures/RoomStatusBar.tsx");class hE extends s.PureComponent{render(){return s.createElement("div",{className:"mx_TopUnreadMessagesBar"},s.createElement(Ae.A,{className:"mx_TopUnreadMessagesBar_scrollUp",title:(0,P._t)("room|jump_read_marker"),onClick:this.props.onScrollUpClick}),s.createElement(Ae.A,{className:"mx_TopUnreadMessagesBar_markAsRead",title:(0,P._t)("notifications|mark_all_read"),onClick:this.props.onCloseClick}))}}var gE=n("./src/utils/direct-messages.ts"),vE=n("./src/components/views/messages/EncryptionEvent.tsx"),fE=n("./src/components/structures/RoomStatusBarUnsentMessages.tsx");const _E=({text:e})=>s.createElement("div",{className:"mx_LargeLoader"},s.createElement(Na.A,{w:45,h:45}),s.createElement("div",{className:"mx_LargeLoader_text"},e));class yE extends s.Component{constructor(e,t){super(e,t),(0,h.A)(this,"callEventGroupers",new Map),this.buildLegacyCallEventGroupers(this.props.timeline)}buildLegacyCallEventGroupers(e){this.callEventGroupers=(0,pf.fN)(this.callEventGroupers,e)}render(){const e=this.props.timeline,t=e[this.props.ourEventsIndexes[0]],n=t.getId(),i=t.getTs(),r=[s.createElement(Xp.A,{key:i+"-search",roomId:t.getRoomId(),ts:i})],o=V.A.getValue("layout"),a=V.A.getValue("showTwelveHourTimestamps"),l=V.A.getValue("alwaysShowTimestamps"),c=E.J.safeGet();for(let t=0;t<e.length;t++){var d;const i=e[t];let p;const h=!this.props.ourEventsIndexes.includes(t);if(h||(p=this.props.searchHighlights),(0,nh.bN)(i,c,null===(d=this.context)||void 0===d?void 0:d.showHiddenEvents)){var u;const d=e[t-1],g=d&&!(0,Bp.fq)(d.getDate()||void 0,i.getDate()||void 0)&&Ch(d,i,c,null===(u=this.context)||void 0===u?void 0:u.showHiddenEvents,Sp.Ae.Search);let v=!0;const f=e[t+1];if(f){var m;v=(0,Bp.fq)(i.getDate()||void 0,f.getDate()||void 0)||i.getSender()!==f.getSender()||!Ch(i,f,c,null===(m=this.context)||void 0===m?void 0:m.showHiddenEvents,Sp.Ae.Search)}r.push(s.createElement(Wp.Ay,{key:`${n}+${t}`,mxEvent:i,layout:o,contextual:h,highlights:p,permalinkCreator:this.props.permalinkCreator,highlightLink:this.props.resultLink,onHeightChanged:this.props.onHeightChanged,isTwelveHour:a,alwaysShowTimestamps:l,lastInSection:v,continuation:g,callEventGrouper:this.callEventGroupers.get(i.getContent().call_id)}))}}return s.createElement("li",{"data-scroll-tokens":n},s.createElement("ol",null,r))}}(0,h.A)(yE,"contextType",Sp.Ay);var bE=n("./src/Typeguards.ts");async function EE(e,t,n,r){const s={limit:10};void 0!==n&&(s.rooms=[n]);const o={search_categories:{room_events:{search_term:t,filter:s,order_by:i.SearchOrderBy.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}};return{response:await e.search({body:o},r),query:o}}async function wE(e,t,n,i){const r=await EE(e,t,n,i),s={abortSignal:i,_query:r.query,results:[],highlights:[]};return e.processRoomEventsSearch(s,r.response)}function SE(e,t){const n=e.result,i=t.result;return n.origin_server_ts>i.origin_server_ts?-1:n.origin_server_ts<i.origin_server_ts?1:0}async function AE(e,t,n=!0){const i=cf.A.get(),r={search_term:e,before_limit:1,after_limit:1,limit:10,order_by_recency:!0,room_id:void 0};void 0!==t&&(r.room_id=t);const s=await i.search(r);if(!s)throw new Error("Local search failed");r.next_batch=s.next_batch;return{response:s,query:r}}function CE(e,t){try{const n=e[e.length-1].result,i=t[t.length-1].result;return n.origin_server_ts<=i.origin_server_ts?-1:1}catch{return 0}}function xE(e,t,n,i){const r=n.concat(i).sort(SE);t.results=r.slice(0,10),e.cachedEvents=r.slice(10)}function kE(e,t,n){var i;const r=function(e,t,n){var i;const r={},s=null!==(i=e.cachedEvents)&&void 0!==i?i:[];let o=e.oldestEventFrom;var a,l,c,d;if(r.highlights=e.highlights,t&&n&&n.results)CE(null!==(a=t.results)&&void 0!==a?a:[],n.results)<0&&(o="local"),xE(e,r,null!==(l=t.results)&&void 0!==l?l:[],n.results),r.highlights=(null!==(c=t.highlights)&&void 0!==c?c:[]).concat(null!==(d=n.highlights)&&void 0!==d?d:[]);else if(t){var u,m;CE(null!==(u=t.results)&&void 0!==u?u:[],s)<0&&(o="local"),xE(e,r,null!==(m=t.results)&&void 0!==m?m:[],s)}else n&&n.results?(CE(n.results,s)<0&&(o="server"),xE(e,r,n.results,s)):(r.results=s,e.cachedEvents=[]);return e.oldestEventFrom=o,r}(e,t,n);if(e.count)r.count=e.count;else{var s,o;const e=null!==(s=null==t?void 0:t.count)&&void 0!==s?s:0,i=null!==(o=null==n?void 0:n.count)&&void 0!==o?o:0;r.count=e+i}return t&&(0,bE.E)(e.seshatQuery)&&(e.seshatQuery.next_batch=t.next_batch),n&&(e.serverSideNextBatch=n.next_batch),null!==(i=e.seshatQuery)&&void 0!==i&&i.next_batch?r.next_batch=e.seshatQuery.next_batch:e.serverSideNextBatch&&(r.next_batch=e.serverSideNextBatch),!r.next_batch&&(0,bE.E)(e.cachedEvents)&&e.cachedEvents.length>0&&(r.next_batch="cached"),r}function RE(e=[]){for(const t of e){const e=t.context.getTimeline();for(const t of e){const e=t.event;e.curve25519Key&&(t.makeEncrypted(i.EventType.RoomMessageEncrypted,{algorithm:e.algorithm},e.curve25519Key,e.ed25519Key),t.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain,delete e.curve25519Key,delete e.ed25519Key,delete e.algorithm,delete e.forwardingCurve25519KeyChain)}}}async function IE(e,t,n,i){let r;var s;void 0!==n?r=await(null===(s=e.getCrypto())||void 0===s?void 0:s.isEncryptionEnabledInRoom(n))?async function(e,t,n){const i={results:[],highlights:[]};if(""===t)return i;const r=await AE(t,n);i.seshatQuery=r.query;const s={search_categories:{room_events:r.response}},o=e.processRoomEventsSearch(i,s);return RE(o.results),o}(e,t,n):wE(e,t,n,i):r=async function(e,t,n){const i=EE(e,t,void 0,n),r=AE(t);await Promise.all([i,r]);const s=await r,o=await i,a=o.query,l=o.response,c=s.query,d=s.response,u={seshatQuery:c,_query:a,serverSideNextBatch:l.search_categories.room_events.next_batch,cachedEvents:[],oldestEventFrom:"server",results:[],highlights:[]},m={search_categories:{room_events:kE(u,d,l.search_categories.room_events)}},p=e.processRoomEventsSearch(u,m);return RE(p.results),p}(e,t,i);return r}function TE(e,t){const n=t.seshatQuery,i=t._query;if(n){if(i){const n=async function(e,t){var n;const i=cf.A.get(),r=t.seshatQuery,s=t.oldestEventFrom;let o,a;if(null==r||!r.next_batch||t.serverSideNextBatch&&"server"!==s||(o=await i.search(r)),t.serverSideNextBatch&&("local"===s||null==r||!r.next_batch)){const n={body:t._query,next_batch:t.serverSideNextBatch};a=await e.search(n)}const l={search_categories:{room_events:kE(t,o,null===(n=a)||void 0===n?void 0:n.search_categories.room_events)}},c=t.results?t.results.length:0,d=e.processRoomEventsSearch(t,l),u=d.results.length-c;return RE(d.results.slice(Math.max(d.results.length-u,0))),t.pendingRequest=void 0,d}(e,t);return t.pendingRequest=n,n}{const n=async function(e,t){var n,i;const r=cf.A.get();if(!t.seshatQuery)throw new Error("localSearchProcess must be called first");const s=await r.search(t.seshatQuery);if(!s)throw new Error("Local search pagination failed");t.seshatQuery.next_batch=s.next_batch;const o=null!==(n=null===(i=s.results)||void 0===i?void 0:i.length)&&void 0!==n?n:0,a={search_categories:{room_events:s}},l=e.processRoomEventsSearch(t,a);return RE(l.results.slice(Math.max(l.results.length-o,0))),t.pendingRequest=void 0,l}(e,t);return t.pendingRequest=n,n}}return e.backPaginateRoomEventsSearch(t)}let PE=function(e){return e.Room="Room",e.All="All",e}({});var NE=n("./src/tchap/i18n/Tchapi18nUtils.tsx");function DE(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}let ME=function(e){};const OE=(0,s.forwardRef)((({term:e,scope:t,promise:n,abortController:r,resizeNotifier:a,className:l,onUpdate:c,inProgress:d},u)=>{const m=(0,s.useContext)(Pe.Ay),p=(0,Ld.ME)("showHiddenEvents"),[g,v]=(0,s.useState)(null),[f,_]=(0,s.useState)(null),y=(0,s.useRef)(!1),b=(0,s.useRef)(new Map).current,E=(0,s.useRef)();(0,s.useEffect)((()=>()=>{b.forEach((e=>e.stop())),b.clear()}),[b]);const w=(0,s.useCallback)((t=>(c(!0,null),t.then((async t=>{if(ME("search complete"),y.current)return o.v.error("Discarding stale search results"),!1;let n=t.highlights;n.includes(e)||(n=n.concat(e)),n=n.sort((function(e,t){return t.length-e.length}));for(const e of t.results)for(const t of e.context.getTimeline()){if(!t.getServerAggregatedRelation(i.THREAD_RELATION_TYPE.name)||t.getThread())continue;const e=m.getRoom(t.getRoomId()),n=null==e?void 0:e.findThreadForEvent(t);n?t.setThread(n):null==e||e.createThread(t.getId(),t,[],!0)}return v(n),_(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?DE(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):DE(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},t)),c(!1,t),!1}),(e=>{var t;return y.current?(o.v.error("Discarding stale search results"),!1):(o.v.error("Search failed",e),A.Ay.createDialog(_v.A,{title:(0,P._t)("error_dialog|search_failed|title"),description:null!==(t=null==e?void 0:e.message)&&void 0!==t?t:NE.A.getServerDownMessage()}),c(!1,null),!1)})))),[m,e,c]);if((0,s.useEffect)((()=>(y.current=!1,w(n),()=>{y.current=!0,null==r||r.abort()})),[]),null===f)return s.createElement("div",{className:"mx_RoomView_messagePanel mx_RoomView_messagePanelSearchSpinner"});const S=[];var C;(d&&S.push(s.createElement("li",{key:"search-spinner"},s.createElement(Na.A,null))),f.next_batch)||(null!=f&&null!==(C=f.results)&&void 0!==C&&C.length?S.push(s.createElement("li",{key:"search-top-marker"},s.createElement("h2",{className:"mx_RoomView_topMarker"},(0,P._t)("no_more_results")))):S.push(s.createElement("li",{key:"search-top-marker"},s.createElement("h2",{className:"mx_RoomView_topMarker"},(0,P._t)("common|no_results")))));const x=()=>{var e;null===(e=E.current)||void 0===e||e.checkScroll()};let k,R=[],I=[];for(let e=((null==f||null===(T=f.results)||void 0===T?void 0:T.length)||0)-1;e>=0;e--){var T;const n=f.results[e],i=n.context.getEvent(),r=i.getRoomId(),a=m.getRoom(r);if(!a){o.v.log("Hiding search result from an unknown room",r);continue}if(!(0,nh.bN)(i,m,p.showHiddenEvents))continue;t===PE.All&&r!==k&&(S.push(s.createElement("li",{key:i.getId()+"-room"},s.createElement("h2",null,(0,P._t)("common|room"),": ",a.name))),k=r);const l="#/room/"+r+"/"+i.getId(),c=n.context.getTimeline(),d=e>0?f.results[e-1].context.getTimeline():[];if(e>0&&c[c.length-1].getId()==d[0].getId()){if(0==R.length){for(let e=0==R.length?0:1;e<n.context.getTimeline().length;e++)R.push(c[e]);I.push(n.context.getOurEventIndex())}for(let e=1;e<d.length;e++)R.push(d[e]);I.push(I[I.length-1]+f.results[e-1].context.getOurEventIndex()+1);continue}0==R.length&&(R=n.context.getTimeline(),I=[],I.push(n.context.getOurEventIndex()));let u=b.get(r);u||(u=new uu.pE(a),u.start(),b.set(r,u)),S.push(s.createElement(yE,{key:i.getId(),timeline:R,ourEventsIndexes:I,searchHighlights:null!=g?g:[],resultLink:l,permalinkCreator:u,onHeightChanged:x})),I=[],R=[]}return s.createElement(Zp.A,{ref:e=>{"function"==typeof u?u(e):u&&(u.current=e),E.current=e},className:"mx_RoomView_searchResultsPanel "+l,onFillRequest:async e=>{if(!e)return!1;if(!f.next_batch)return ME("no more search results"),!1;ME("requesting more search results");const t=function(e,t){const n=cf.A.get();return t.pendingRequest?t.pendingRequest:null===n?e.backPaginateRoomEventsSearch(t):TE(e,t)}(m,f);return w(t)},resizeNotifier:a},s.createElement("li",{className:"mx_RoomView_scrollheader"}),S)}));var LE=n("./src/VoipUserMapper.ts");const FE=({roomView:e,resizeNotifier:t,inviteEvent:n})=>{const i=(0,Ld.ME)("room"),r=u.Ay.get().brand;return s.createElement("div",{className:"mx_RoomView mx_RoomView--local"},s.createElement(eh.A,null,s.createElement(Ob,{room:i.room}),s.createElement("main",{className:"mx_RoomView_body",ref:e},s.createElement("div",{className:"mx_RoomView_timeline"},s.createElement(Zp.A,{className:"mx_RoomView_messagePanel",resizeNotifier:t},s.createElement(oh.A,{className:"mx_cryptoEvent mx_cryptoEvent_icon",title:(0,P._t)("room|waiting_for_join_title",{brand:r}),subtitle:(0,P._t)("room|waiting_for_join_subtitle",{brand:r})}),s.createElement(Eh,null),s.createElement(Wp.f3,{mxEvent:n}))))))},UE=({searchInfo:e,isRoomEncrypted:t,onSearchScopeChange:n,onCancelClick:i})=>{var r;const o=null!==(r=null==e?void 0:e.scope)&&void 0!==r?r:PE.Room;return s.createElement(s.Fragment,null,s.createElement(y.Z,{screenName:"RoomSearch"}),s.createElement("div",{className:"mx_RoomSearchAuxPanel"},s.createElement("div",{className:"mx_RoomSearchAuxPanel_summary"},s.createElement(Pm.A,{width:"24px",height:"24px"}),s.createElement("div",{className:"mx_RoomSearchAuxPanel_summary_text"},void 0!==(null==e?void 0:e.count)?(0,P._t)("room|search|summary",{count:e.count},{query:()=>s.createElement("strong",null,e.term)}):s.createElement(He.A,null),s.createElement(uf,{kind:df.Search,isRoomEncrypted:t,showLogo:!1}))),s.createElement("div",{className:"mx_RoomSearchAuxPanel_buttons"},s.createElement(bu,{onClick:()=>n(o===PE.Room?PE.All:PE.Room),kind:"primary"},o===PE.All?(0,P._t)("room|search|this_room_button"):(0,P._t)("room|search|all_rooms_button")),s.createElement(Xa.K,{onClick:i,destructive:!0,tooltip:(0,P._t)("action|cancel"),"aria-label":(0,P._t)("action|cancel")},s.createElement(ab.A,{width:"20px",height:"20px"})))))};var BE=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/pin-solid.js"),VE=n("./src/components/views/rooms/EventPreview.tsx");function jE({room:e,permalinkCreator:t,resizeNotifier:n}){const i=cg(e),r=mg(e,i),o=r.length,a=1===o,[l,c]=(0,s.useState)(o-1);(0,s.useEffect)((()=>{c((()=>o-1))}),[o]);const d=r[l];if(function(e,t){const n=(0,s.useRef)(null);(0,s.useEffect)((()=>{(n.current&&!e||!n.current&&e)&&t.notifyTimelineHeightChanged(),n.current=e}),[e,t])}(d,n),!d)return null;const u=d.isRedacted()||d.isDecryptionFailure();return s.createElement("div",{className:"mx_PinnedMessageBanner","data-single-message":a,"aria-label":(0,P._t)("room|pinned_message_banner|description")},s.createElement("button",{"aria-label":(0,P._t)("room|pinned_message_banner|go_to_message"),type:"button",className:"mx_PinnedMessageBanner_main",onClick:()=>{y.A.trackInteraction("PinnedMessageBannerClick"),w.A.dispatch({action:R.r.ViewRoom,event_id:d.getId(),highlighted:!0,room_id:e.roomId,metricsTrigger:void 0}),c((e=>-1==--e?o-1:e))}},s.createElement("div",{className:"mx_PinnedMessageBanner_content"},s.createElement(WE,{count:o,currentIndex:l}),s.createElement(BE.A,{width:"20px",height:"20px",className:"mx_PinnedMessageBanner_PinIcon"}),!a&&s.createElement("div",{className:"mx_PinnedMessageBanner_title"},(0,P._t)("room|pinned_message_banner|title",{index:l+1,length:o},{bold:e=>s.createElement("span",{className:"mx_PinnedMessageBanner_title_counter"},e)})),s.createElement(VE.B,{mxEvent:d,className:"mx_PinnedMessageBanner_message"}),u&&s.createElement("div",{className:"mx_PinnedMessageBanner_redactedMessage"},s.createElement(N_.A,{mxEvent:d,maxImageHeight:20,permalinkCreator:t,replacingEventId:d.replacingEventId()})))),!a&&s.createElement(KE,{room:e}))}const zE=3;function WE({count:e,currentIndex:t}){const n=Math.min(e,zE),i=t%n,r=Math.ceil(e/n),o=t>=(r-1)*zE,a=n-(r*n-e);return s.createElement("div",{className:"mx_PinnedMessageBanner_Indicators"},Array.from({length:n}).map(((e,t)=>s.createElement(HE,{key:t,active:t===i,hidden:o&&a<=t}))))}function HE({active:e,hidden:t}){return s.createElement("div",{className:re()("mx_PinnedMessageBanner_Indicator",{"mx_PinnedMessageBanner_Indicator--active":e,"mx_PinnedMessageBanner_Indicator--hidden":t})})}function GE(e){return rl.A.instance.isOpenForRoom(e)?rl.A.instance.currentCard.phase:null}function KE({room:e}){const[t,n]=(0,s.useState)(GE(e.roomId));(0,Me.ml)(rl.A.instance,I.H,(()=>n(GE(e.roomId))));const i=t===sl.n.PinnedMessages;return s.createElement(Sl.$,{className:"mx_PinnedMessageBanner_actions",kind:"tertiary",onClick:()=>{i?y.A.trackInteraction("PinnedMessageBannerCloseListButton"):y.A.trackInteraction("PinnedMessageBannerViewAllButton"),rl.A.instance.showOrHidePhase(sl.n.PinnedMessages)}},i?(0,P._t)("room|pinned_message_banner|button_close_list"):(0,P._t)("room|pinned_message_banner|button_view_all"))}const JE=["upgradeRecommendation"],qE=["upgradeRecommendation"];function $E(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function YE(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?$E(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):$E(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let ZE=function(e){};const XE="sandbox"in document.createElement("iframe");function QE(e){const t=(0,Ld.ME)("room").room,n=e.localRoom.currentState.getStateEvents(i.EventType.RoomEncryption)[0];let r;n&&(r=s.createElement(vE.A,{mxEvent:n}));const o=()=>{t.state=yh.cd.NEW,w.A.dispatch({action:"local_room_event",roomId:t.roomId})};let a=null,l=null;if(t.isError){const e=s.createElement(Ae.A,{onClick:o,className:"mx_RoomStatusBar_unsentRetry"},(0,P._t)("action|retry"));a=s.createElement(fE.E,{title:(0,P._t)("room|status_bar|some_messages_not_sent"),notificationState:ma.d.RED_EXCLAMATION,buttons:e})}else l=s.createElement(t_,{room:e.localRoom,resizeNotifier:e.resizeNotifier,permalinkCreator:e.permalinkCreator});return s.createElement("div",{className:"mx_RoomView mx_RoomView--local"},s.createElement(eh.A,null,s.createElement(Ob,{room:t}),s.createElement("main",{className:"mx_RoomView_body",ref:e.roomView},s.createElement(l_,{parent:e.roomView.current,onFileDrop:e.onFileDrop}),s.createElement("div",{className:"mx_RoomView_timeline"},s.createElement(Zp.A,{className:"mx_RoomView_messagePanel",resizeNotifier:e.resizeNotifier},r,s.createElement(Eh,null))),a,l)))}function ew(e){const t=(0,P._t)("room|creating_room_text",{names:e.names});return s.createElement("div",{className:"mx_RoomView mx_RoomView--local"},s.createElement(eh.A,null,s.createElement(Ob,{room:e.localRoom}),s.createElement("div",{className:"mx_RoomView_body"},s.createElement(_E,{text:t}))))}class tw extends s.Component{constructor(e,t){var n;if(super(e,t),(0,h.A)(this,"askToJoinEnabled",void 0),(0,h.A)(this,"dispatcherRef",void 0),(0,h.A)(this,"settingWatchers",[]),(0,h.A)(this,"unmounted",!1),(0,h.A)(this,"permalinkCreators",{}),(0,h.A)(this,"roomView",(0,s.createRef)()),(0,h.A)(this,"searchResultsPanel",(0,s.createRef)()),(0,h.A)(this,"messagePanel",null),(0,h.A)(this,"roomViewBody",(0,s.createRef)()),(0,h.A)(this,"onIsResizing",(e=>{this.setState({resizing:e})})),(0,h.A)(this,"onWidgetStoreUpdate",(()=>{this.state.room&&(this.checkWidgets(this.state.room),this.doMaybeRemoveOwnJitsiWidget())})),(0,h.A)(this,"onWidgetEchoStoreUpdate",(()=>{this.state.room&&this.checkWidgets(this.state.room)})),(0,h.A)(this,"onWidgetLayoutChange",(()=>{this.state.room&&(w.A.dispatch({action:"appsDrawer",show:!0}),this.context.widgetLayoutStore.hasMaximisedWidget(this.state.room)&&this.context.rightPanelStore.setCard({phase:sl.n.Timeline}),this.checkWidgets(this.state.room))})),(0,h.A)(this,"checkWidgets",(e=>{this.setState({hasPinnedWidgets:this.context.widgetLayoutStore.hasPinnedWidgets(e),mainSplitContentType:this.getMainSplitContentType(e),showApps:this.shouldShowApps(e)})})),(0,h.A)(this,"getMainSplitContentType",(e=>this.context.roomViewStore.isViewingCall()||(0,ig.j)(e)?Sp.DZ.Call:this.context.widgetLayoutStore.hasMaximisedWidget(e)?Sp.DZ.MaximisedWidget:Sp.DZ.Timeline)),(0,h.A)(this,"onRoomViewStoreUpdate",(async e=>{var t,n,i,r,s,a,l,c;if(this.unmounted)return;const d=null!==(t=this.context.roomViewStore.getRoomLoadError())&&void 0!==t?t:void 0;if(!e&&!d&&this.state.roomId!==this.context.roomViewStore.getRoomId())return;const u=null!==(n=this.context.roomViewStore.getRoomId())&&void 0!==n?n:null,m=null!==(i=null===(r=this.context.client)||void 0===r?void 0:r.getRoom(null!=u?u:void 0))&&void 0!==i?i:void 0,p={roomId:null!=u?u:void 0,roomAlias:null!==(s=this.context.roomViewStore.getRoomAlias())&&void 0!==s?s:void 0,roomLoading:this.context.roomViewStore.isRoomLoading(),roomLoadError:d,joining:this.context.roomViewStore.isJoining(),replyToEvent:null!==(a=this.context.roomViewStore.getQuotingEvent())&&void 0!==a?a:void 0,shouldPeek:this.state.matrixClientIsReady&&this.context.roomViewStore.shouldPeek(),showReadReceipts:V.A.getValue("showReadReceipts",u),showRedactions:V.A.getValue("showRedactions",u),showJoinLeaves:V.A.getValue("showJoinLeaves",u),showAvatarChanges:V.A.getValue("showAvatarChanges",u),showDisplaynameChanges:V.A.getValue("showDisplaynameChanges",u),wasContextSwitch:this.context.roomViewStore.getWasContextSwitch(),mainSplitContentType:m?this.getMainSplitContentType(m):void 0,initialEventId:void 0,showRightPanel:!!u&&this.context.rightPanelStore.isOpenForRoom(u),activeCall:u?fb.e.instance.getActiveCall(u):null,promptAskToJoin:this.context.roomViewStore.promptAskToJoin(),viewRoomOpts:this.context.roomViewStore.getViewRoomOpts()};var h;this.state.mainSplitContentType!==Sp.DZ.Timeline&&p.mainSplitContentType===Sp.DZ.Timeline&&this.context.rightPanelStore.isOpen&&this.context.rightPanelStore.currentCard.phase===sl.n.Timeline&&this.context.rightPanelStore.roomPhaseHistory.some((e=>e.phase===sl.n.Timeline))&&(this.context.rightPanelStore.setCard({phase:sl.n.RoomSummary}),this.context.rightPanelStore.togglePanel(null!==(h=this.state.roomId)&&void 0!==h?h:null),p.showRightPanel=!1);const g=null!==(l=this.context.roomViewStore.getInitialEventId())&&void 0!==l?l:this.state.initialEventId;if(g){var v,f;let e=null==m?void 0:m.findEventById(g);var _;if(!e&&this.context.client&&u)e=null!==(_=await(0,Vp.$I)(this.context.client,u,g))&&void 0!==_?_:void 0;p.initialEventPixelOffset=void 0;const t=null===(v=e)||void 0===v?void 0:v.getThread();null==t||!t.rootEvent||null!==(f=e)&&void 0!==f&&f.isThreadRoot?(p.initialEventId=g,p.isInitialEventHighlighted=this.context.roomViewStore.isInitialEventHighlighted(),p.initialEventScrollIntoView=this.context.roomViewStore.initialEventScrollIntoView()):w.A.dispatch({action:R.r.ShowThread,rootEvent:t.rootEvent,initialEvent:e,highlighted:this.context.roomViewStore.isInitialEventHighlighted(),scroll_into_view:this.context.roomViewStore.initialEventScrollIntoView()})}var y,b;(this.settingWatchers=this.settingWatchers.concat([V.A.watchSetting("showReadReceipts",u,((...[,,,e])=>this.setState({showReadReceipts:e}))),V.A.watchSetting("showRedactions",u,((...[,,,e])=>this.setState({showRedactions:e}))),V.A.watchSetting("showJoinLeaves",u,((...[,,,e])=>this.setState({showJoinLeaves:e}))),V.A.watchSetting("showAvatarChanges",u,((...[,,,e])=>this.setState({showAvatarChanges:e}))),V.A.watchSetting("showDisplaynameChanges",u,((...[,,,e])=>this.setState({showDisplaynameChanges:e})))]),e||!this.state.shouldPeek||p.shouldPeek)||(null===(y=this.context.client)||void 0===y||y.stopPeeking());if(o.v.log("RVS update:",p.roomId,p.roomAlias,"loading?",p.roomLoading,"joining?",p.joining,"initial?",e,"shouldPeek?",p.shouldPeek),e&&(p.room=this.context.client.getRoom(p.roomId)||void 0,p.isRoomEncrypted=null,p.room&&(p.showApps=this.shouldShowApps(p.room),this.onRoomLoaded(p.room))),void 0===this.state.roomId&&void 0!==p.roomId&&!p.initialEventId&&p.roomId){const e=q_.getScrollState(p.roomId);e&&(p.initialEventId=e.focussedEvent,p.initialEventPixelOffset=e.pixelOffset)}this.state.timelineRenderingType===Sp.Ae.Search&&this.state.initialEventId!==p.initialEventId&&(p.timelineRenderingType=Sp.Ae.Room,null===(b=this.state.search)||void 0===b||null===(b=b.abortController)||void 0===b||b.abort(),p.search=void 0);this.setState(p),e&&this.setupRoom(p.room,p.roomId,!!p.joining,!!p.shouldPeek);const E=await this.getIsRoomEncrypted(p.roomId);this.setState(YE({isRoomEncrypted:E},E&&p.roomId&&{e2eStatus:null!==(c=tw.e2eStatusCache.get(p.roomId))&&void 0!==c?c:Y_.z.Warning}))})),(0,h.A)(this,"onConnectedCalls",(()=>{if(void 0===this.state.roomId)return;const e=fb.e.instance.getActiveCall(this.state.roomId);null===e&&w.A.dispatch({action:R.r.ViewRoom,room_id:this.state.roomId,view_call:!1,metricsTrigger:void 0},!0),this.setState({activeCall:e})})),(0,h.A)(this,"getRoomId",(()=>{var e,t;return null!==(e=null===(t=this.state.room)||void 0===t?void 0:t.roomId)&&void 0!==e?e:this.state.roomId})),(0,h.A)(this,"onRightPanelStoreUpdate",(()=>{const{roomId:e}=this.state;this.setState({showRightPanel:!!e&&this.context.rightPanelStore.isOpenForRoom(e)})})),(0,h.A)(this,"onPageUnload",(e=>mu.Ay.sharedInstance().getCurrentUploads().length>0?e.returnValue=(0,P._t)("quit_warning|file_upload_in_progress"):this.getCallForRoom()&&"ended"!==this.state.callState?e.returnValue=(0,P._t)("quit_warning|call_in_progress"):void 0)),(0,h.A)(this,"onReactKeyDown",(e=>{var t;let n=!1;switch((0,Re.zM)().getRoomAction(e)){case Se.bY.DismissReadMarker:null===(t=this.messagePanel)||void 0===t||t.forgetReadMarker(),this.jumpToLiveTimeline(),n=!0;break;case Se.bY.JumpToOldestUnread:this.jumpToReadMarker(),n=!0;break;case Se.bY.UploadFile:w.A.dispatch({action:"upload_file",context:Sp.Ae.Room},!0),n=!0}n&&(e.stopPropagation(),e.preventDefault())})),(0,h.A)(this,"onCallState",(e=>{if(!e)return;const t=this.getCallForRoom();this.setState({callState:null==t?void 0:t.state})})),(0,h.A)(this,"onAction",(async e=>{var t;if(this.context.client)switch(e.action){case"message_sent":this.checkDesktopNotifications();break;case"post_sticker_message":this.injectSticker(e.data.content.url,e.data.content.info,e.data.description||e.data.name,e.data.threadId);break;case"picture_snapshot":{const t=this.getRoomId();(0,bE.E)(t)&&mu.Ay.sharedInstance().sendContentListToRoom([e.file],t,void 0,this.context.client);break}case"notifier_enabled":case R.r.UploadStarted:case R.r.UploadFinished:case R.r.UploadCanceled:this.forceUpdate();break;case"appsDrawer":this.setState({showApps:e.show});break;case"reply_to_event":!this.unmounted&&this.state.search&&(null===(t=e.event)||void 0===t?void 0:t.getRoomId())===this.state.roomId&&e.context===Sp.Ae.Search&&this.onCancelSearchClick();break;case"MatrixActions.sync":var n;if(!this.state.matrixClientIsReady)this.setState({matrixClientIsReady:!(null===(n=this.context.client)||void 0===n||!n.isInitialSyncComplete())},(()=>{this.onRoomViewStoreUpdate(!0)}));break;case"local_room_event":this.onLocalRoomEvent(e.roomId);break;case R.r.EditEvent:{if(e.timelineRenderingType!==this.state.timelineRenderingType)return;if(e.event&&e.event.getRoomId()!==this.state.roomId)return void w.A.dispatch({action:R.r.ViewRoom,room_id:e.event.getRoomId(),metricsTrigger:void 0,deferred_action:e});const t=e.event?new n_(e.event):void 0;this.setState({editState:t,search:void 0},(()=>{var t;e.event&&(null===(t=this.messagePanel)||void 0===t||t.scrollToEventIfNeeded(e.event.getId()))}));break}case R.r.ComposerInsert:{if(e.composerType)break;let t=e.timelineRenderingType;if(t===Sp.Ae.Thread)break;this.state.timelineRenderingType===Sp.Ae.Search&&e.timelineRenderingType===Sp.Ae.Search&&(await this.onCancelSearchClick(),t=Sp.Ae.Room),w.A.dispatch(YE(YE({},e),{},{timelineRenderingType:t,composerType:this.state.editState?u_.D.Edit:u_.D.Send}));break}case R.r.FocusAComposer:w.A.dispatch(YE(YE({},e),{},{action:this.state.editState?R.r.FocusEditMessageComposer:R.r.FocusSendMessageComposer}));break;case"scroll_to_bottom":var i;if(e.timelineRenderingType===Sp.Ae.Room)null===(i=this.messagePanel)||void 0===i||i.jumpToLiveTimeline();break;case R.r.ViewUser:e.member?e.push?rl.A.instance.pushCard({phase:sl.n.MemberInfo,state:{member:e.member}}):rl.A.instance.setCards([{phase:sl.n.RoomSummary},{phase:sl.n.MemberList},{phase:sl.n.MemberInfo,state:{member:e.member}}]):rl.A.instance.showOrHidePhase(sl.n.MemberList);break;case R.r.View3pidInvite:((e,t)=>{e.event?t.pushCard({phase:sl.n.ThreePidMemberInfo,state:{memberInfoEvent:e.event}}):t.showOrHidePhase(sl.n.MemberList)})(e,rl.A.instance)}})),(0,h.A)(this,"onRoomTimeline",((e,t,n,i,r)=>{var s;this.unmounted||t&&t.roomId===(null===(s=this.state.room)||void 0===s?void 0:s.roomId)&&r.timeline.getTimelineSet()===t.getUnfilteredTimelineSet()&&("org.matrix.room.preview_urls"===e.getType()&&this.updatePreviewUrlVisibility(t),"m.room.encryption"===e.getType()&&(this.updateE2EStatus(t),this.updatePreviewUrlVisibility(t)),!n&&null!=r&&r.liveEvent&&(this.state.joining||(e.isBeingDecrypted()||e.isDecryptionFailure()||this.handleEffects(e),this.context.client&&e.getSender()!==this.context.client.getSafeUserId()&&(!this.state.search&&this.state.atEndOfLiveTimeline||(0,cu.A)(e,this.state)||this.setState((e=>({numUnreadMessages:e.numUnreadMessages+1})))))))})),(0,h.A)(this,"onEventDecrypted",(e=>{this.state.room&&this.state.matrixClientIsReady&&e.getRoomId()===this.state.room.roomId&&(e.isDecryptionFailure()||this.handleEffects(e))})),(0,h.A)(this,"handleEffects",(e=>{if(!this.state.room)return;this.context.roomNotificationStateStore.getRoomState(this.state.room).isUnread&&Zg.y.forEach((t=>{((0,Xg._)(e.getContent(),t.emojis)||e.getContent().msgtype===t.msgType)&&(e.isRelation(i.THREAD_RELATION_TYPE.name)||w.A.dispatch({action:`effects.${t.command}`,event:e}))}))})),(0,h.A)(this,"onRoomName",(e=>{this.state.room&&e.roomId==this.state.room.roomId&&this.forceUpdate()})),(0,h.A)(this,"onKeyBackupStatus",(()=>{this.forceUpdate()})),(0,h.A)(this,"canResetTimeline",(()=>!this.messagePanel||this.messagePanel.canResetTimeline())),(0,h.A)(this,"loadVirtualRoom",(async e=>{const t=(null==e?void 0:e.roomId)&&await LE.A.sharedInstance().getVirtualRoomForRoom(null==e?void 0:e.roomId);this.setState({virtualRoom:t||void 0})})),(0,h.A)(this,"onRoomLoaded",(e=>{this.unmounted||(this.context.widgetLayoutStore.on(Sv.aK.emissionForRoom(e),this.onWidgetLayoutChange),this.calculatePeekRules(e),this.loadMembersIfJoined(e),this.calculateRecommendedVersion(e),this.updatePermissions(e),this.checkWidgets(e),this.loadVirtualRoom(e),this.updateRoomEncrypted(e),this.getMainSplitContentType(e)!==Sp.DZ.Timeline&&this.context.roomNotificationStateStore.getRoomState(e).isUnread&&this.context.rightPanelStore.setCard({phase:sl.n.Timeline},!0,e.roomId),this.setState({tombstone:this.getRoomTombstone(e),liveTimeline:e.getLiveTimeline()}),w.A.dispatch({action:R.r.RoomLoaded}))})),(0,h.A)(this,"onRoomTimelineReset",(e=>{var t;e&&e.roomId===(null===(t=this.state.room)||void 0===t?void 0:t.roomId)&&e.getLiveTimeline()!==this.state.liveTimeline&&(o.v.log(`Live timeline of ${e.roomId} was reset`),this.setState({liveTimeline:e.getLiveTimeline()}))})),(0,h.A)(this,"onRoom",(e=>{e&&e.roomId===this.state.roomId&&(this.state.room&&this.context.widgetLayoutStore.off(Sv.aK.emissionForRoom(this.state.room),this.onWidgetLayoutChange),this.setState({room:e},(()=>{this.onRoomLoaded(e)})))})),(0,h.A)(this,"onUserVerificationChanged",(e=>{const t=this.state.room;t&&t.currentState.getMember(e)&&this.updateE2EStatus(t)})),(0,h.A)(this,"onCrossSigningKeysChanged",(()=>{const e=this.state.room;e&&this.updateE2EStatus(e)})),(0,h.A)(this,"onUrlPreviewsEnabledChange",(()=>{this.state.room&&this.updatePreviewUrlVisibility(this.state.room)})),(0,h.A)(this,"onRoomStateEvents",(async(e,t)=>{if(this.state.room&&this.state.room.roomId===t.roomId&&this.context.client)switch(e.getType()){case i.EventType.RoomTombstone:this.setState({tombstone:this.getRoomTombstone()});break;case i.EventType.RoomEncryption:await this.updateRoomEncrypted();break;default:this.updatePermissions(this.state.room)}})),(0,h.A)(this,"onRoomStateUpdate",(e=>{var t;e.roomId===(null===(t=this.state.room)||void 0===t?void 0:t.roomId)&&this.updateRoomMembers()})),(0,h.A)(this,"onMyMembership",(e=>{e.roomId===this.state.roomId&&(this.forceUpdate(),this.loadMembersIfJoined(e),this.updatePermissions(e))})),(0,h.A)(this,"updateRoomMembers",(0,v.throttle)((()=>{this.state.room&&(this.updateDMState(),this.updateE2EStatus(this.state.room))}),500,{leading:!0,trailing:!0})),(0,h.A)(this,"onInviteClick",(()=>{w.A.dispatch({action:"view_invite",roomId:this.getRoomId()})})),(0,h.A)(this,"onJoinButtonClicked",(()=>{var e;null!==(e=this.context.client)&&void 0!==e&&e.isGuest()?(w.A.dispatch({action:R.r.DoAfterSyncPrepared,deferred_action:{action:R.r.ViewRoom,room_id:this.getRoomId(),metricsTrigger:void 0}}),w.A.dispatch({action:"require_registration"})):Promise.resolve().then((()=>{var e;const t=null===(e=this.props.threepidInvite)||void 0===e?void 0:e.signUrl,n=this.getRoomId();var i;(0,bE.E)(n)&&w.A.dispatch({action:R.r.JoinRoom,roomId:n,opts:{inviteSignUrl:t},metricsTrigger:(null===(i=this.state.room)||void 0===i?void 0:i.getMyMembership())===oa.O.Invite?"Invite":"RoomPreview",canAskToJoin:this.state.canAskToJoin});return Promise.resolve()}))})),(0,h.A)(this,"onMessageListScroll",(()=>{var e;null!==(e=this.messagePanel)&&void 0!==e&&e.isAtEndOfLiveTimeline()?this.setState({numUnreadMessages:0,atEndOfLiveTimeline:!0}):this.setState({atEndOfLiveTimeline:!1}),this.updateTopUnreadMessagesBar()})),(0,h.A)(this,"resetJumpToEvent",(e=>{this.state.initialEventId&&this.state.initialEventScrollIntoView&&this.state.initialEventId===e&&(ZE("Removing scroll_into_view flag from initial event"),w.A.dispatch({action:R.r.ViewRoom,room_id:this.getRoomId(),event_id:this.state.initialEventId,highlighted:this.state.isInitialEventHighlighted,scroll_into_view:!1,replyingToEvent:this.state.replyToEvent,metricsTrigger:void 0}))})),(0,h.A)(this,"onSearch",((e,t=PE.Room)=>{const n=t===PE.Room?this.getRoomId():void 0;ZE("sending search request");const i=new AbortController,r=function(e,t,n,i){return null===cf.A.get()?wE(e,t,n,i):IE(e,t,n,i)}(this.context.client,e,n,i.signal);this.setState({timelineRenderingType:Sp.Ae.Search,search:{searchId:(new Date).getTime(),roomId:n,term:e,scope:t,promise:r,abortController:i}})})),(0,h.A)(this,"onSearchScopeChange",(e=>{var t,n;this.onSearch(null!==(t=null===(n=this.state.search)||void 0===n?void 0:n.term)&&void 0!==t?t:"",e)})),(0,h.A)(this,"onSearchUpdate",((e,t)=>{this.setState({search:YE(YE({},this.state.search),{},{count:null==t?void 0:t.count,inProgress:e})})})),(0,h.A)(this,"onForgetClick",(()=>{w.A.dispatch({action:"forget_room",room_id:this.getRoomId()})})),(0,h.A)(this,"onRejectButtonClicked",(()=>{var e;const t=this.getRoomId();t&&(this.setState({rejecting:!0}),null===(e=this.context.client)||void 0===e||e.leave(t).then((()=>{w.A.dispatch({action:R.r.ViewHomePage}),this.setState({rejecting:!1})}),(e=>{o.v.error(`Failed to reject invite: ${e}`);const t=e.message?e.message:JSON.stringify(e);A.Ay.createDialog(_v.A,{title:(0,P._t)("room|failed_reject_invite"),description:t}),this.setState({rejecting:!1})})))})),(0,h.A)(this,"onRejectAndIgnoreClick",(async()=>{this.setState({rejecting:!0});try{const e=this.state.room.getMember(this.context.client.getSafeUserId()).events.member,t=this.context.client.getIgnoredUsers();t.push(e.getSender()),await this.context.client.setIgnoredUsers(t),await this.context.client.leave(this.state.roomId),w.A.dispatch({action:R.r.ViewHomePage}),this.setState({rejecting:!1})}catch(e){o.v.error(`Failed to reject invite: ${e}`);const t=e instanceof Error?e.message:JSON.stringify(e);A.Ay.createDialog(_v.A,{title:(0,P._t)("room|failed_reject_invite"),description:t}),this.setState({rejecting:!1})}})),(0,h.A)(this,"onRejectThreepidInviteButtonClicked",(()=>{w.A.fire(R.r.ViewRoomDirectory)})),(0,h.A)(this,"onSearchChange",(0,v.debounce)((e=>{const t=e.target.value;this.onSearch(t)}),300)),(0,h.A)(this,"onCancelSearchClick",(()=>new Promise((e=>{this.setState({timelineRenderingType:Sp.Ae.Room,search:void 0},e)})))),(0,h.A)(this,"jumpToLiveTimeline",(()=>{var e;this.state.initialEventId&&this.state.isInitialEventHighlighted?w.A.dispatch({action:R.r.ViewRoom,room_id:this.getRoomId(),metricsTrigger:void 0}):(null===(e=this.messagePanel)||void 0===e||e.jumpToLiveTimeline(),w.A.fire(R.r.FocusSendMessageComposer))})),(0,h.A)(this,"jumpToReadMarker",(()=>{var e;null===(e=this.messagePanel)||void 0===e||e.jumpToReadMarker()})),(0,h.A)(this,"forgetReadMarker",(e=>{var t;e.stopPropagation(),null===(t=this.messagePanel)||void 0===t||t.forgetReadMarker()})),(0,h.A)(this,"updateTopUnreadMessagesBar",(()=>{if(!this.messagePanel)return;const e=this.messagePanel.canJumpToReadMarker();this.state.showTopUnreadMessagesBar!=e&&this.setState({showTopUnreadMessagesBar:e})})),(0,h.A)(this,"onStatusBarVisible",(()=>{this.unmounted||this.state.statusBarVisible||this.setState({statusBarVisible:!0})})),(0,h.A)(this,"onStatusBarHidden",(()=>{!this.unmounted&&this.state.statusBarVisible&&this.setState({statusBarVisible:!1})})),(0,h.A)(this,"handleScrollKey",(e=>{var t;let n;this.searchResultsPanel.current?n=this.searchResultsPanel.current:this.messagePanel&&(n=this.messagePanel),null===(t=n)||void 0===t||t.handleScrollKey(e)})),(0,h.A)(this,"gatherTimelinePanelRef",(e=>{this.messagePanel=e})),(0,h.A)(this,"onHiddenHighlightsClick",(()=>{const e=this.getOldRoom();e&&w.A.dispatch({action:R.r.ViewRoom,room_id:e.roomId,metricsTrigger:"Predecessor"})})),(0,h.A)(this,"onFileDrop",(async e=>{const t=this.getRoomId();t&&this.context.client&&await mu.Ay.sharedInstance().sendContentListToRoom(Array.from(e.files),t,void 0,this.context.client,Sp.Ae.Room)})),(0,h.A)(this,"onMeasurement",(e=>{this.setState({narrow:e})})),(0,h.A)(this,"onSubmitAskToJoin",(e=>{const t=this.getRoomId();(0,bE.E)(t)&&w.A.dispatch({action:R.r.SubmitAskToJoin,roomId:t,opts:{reason:e}})})),(0,h.A)(this,"onCancelAskToJoin",(()=>{const e=this.getRoomId();(0,bE.E)(e)&&w.A.dispatch({action:R.r.CancelAskToJoin,roomId:e})})),this.askToJoinEnabled=V.A.getValue("feature_ask_to_join"),!t.client)throw new Error("Unable to create RoomView without MatrixClient");const r=t.client.hasLazyLoadMembersEnabled();this.state={roomId:void 0,roomLoading:!0,peekLoading:!1,shouldPeek:!0,membersLoaded:!r,numUnreadMessages:0,callState:void 0,activeCall:null,canPeek:!1,canSelfRedact:!1,showApps:!1,isPeeking:!1,showRightPanel:!1,joining:!1,showTopUnreadMessagesBar:!1,statusBarVisible:!1,canReact:!1,canSendMessages:!1,resizing:!1,layout:V.A.getValue("layout"),lowBandwidth:V.A.getValue("lowBandwidth"),alwaysShowTimestamps:V.A.getValue("alwaysShowTimestamps"),showTwelveHourTimestamps:V.A.getValue("showTwelveHourTimestamps"),userTimezone:du.dB(),readMarkerInViewThresholdMs:V.A.getValue("readMarkerInViewThresholdMs"),readMarkerOutOfViewThresholdMs:V.A.getValue("readMarkerOutOfViewThresholdMs"),showHiddenEvents:V.A.getValue("showHiddenEventsInTimeline"),showReadReceipts:!0,showRedactions:!0,showJoinLeaves:!0,showAvatarChanges:!0,showDisplaynameChanges:!0,matrixClientIsReady:null===(n=t.client)||void 0===n?void 0:n.isInitialSyncComplete(),mainSplitContentType:Sp.DZ.Timeline,timelineRenderingType:Sp.Ae.Room,liveTimeline:void 0,narrow:!1,msc3946ProcessDynamicPredecessor:V.A.getValue("feature_dynamic_room_predecessors"),canAskToJoin:this.askToJoinEnabled,promptAskToJoin:!1,viewRoomOpts:{buttons:[]},isRoomEncrypted:null}}doMaybeRemoveOwnJitsiWidget(){if(!this.state.roomId||!this.state.room||!this.context.client)return;const e=this.context.widgetStore.getApps(this.state.roomId).filter((e=>e.eventId&&Bg.x.JITSI.matches(e.type)));if(e.length<2)return;const t=this.context.client.getSafeUserId(),n=e.find((e=>e.creatorUserId===t));if(!n)return;const i=this.state.room.findEventById(n.eventId);if(!i)return;const r=i.getTs();if(!r)return;const s=e.reduce(((e,t)=>{var i;if(t.eventId===n.eventId)return e;const r=(null===(i=this.state.room.findEventById(t.eventId))||void 0===i?void 0:i.getTs())||0;return Math.max(e,r)}),0);s&&r>s&&r-s<3e4&&wg.A.setRoomWidget(this.context.client,this.state.roomId,n.id)}getPermalinkCreatorForRoom(){const{room:e,roomId:t}=this.state;if(void 0===e){if((0,bE.E)(t)){const e=new uu.pE(null,t);return this.permalinkCreators[t]=e,e}throw new Error("Cannot get a permalink creator without a roomId")}return this.permalinkCreators[e.roomId]||(this.permalinkCreators[e.roomId]=new uu.pE(e),this.state.room&&e.roomId===this.state.room.roomId?this.permalinkCreators[e.roomId].start():this.permalinkCreators[e.roomId].load()),this.permalinkCreators[e.roomId]}stopAllPermalinkCreators(){if(this.permalinkCreators)for(const e of Object.keys(this.permalinkCreators))this.permalinkCreators[e].stop()}setupRoom(e,t,n,r){var s;if(!n&&t)if(!e&&r)o.v.info(`Attempting to peek into room ${t}`),this.setState({peekLoading:!0,isPeeking:!0}),null===(s=this.context.client)||void 0===s||s.peekInRoom(t).then((e=>{this.unmounted||(this.setState({room:e,peekLoading:!1,canAskToJoin:this.askToJoinEnabled&&e.getJoinRule()===i.JoinRule.Knock}),this.onRoomLoaded(e))})).catch((e=>{if(!this.unmounted){if(this.setState({isPeeking:!1}),"M_GUEST_ACCESS_FORBIDDEN"!==e.errcode&&"M_FORBIDDEN"!==e.errcode)throw e;this.setState({peekLoading:!1})}}));else if(e){var a;null===(a=this.context.client)||void 0===a||a.stopPeeking(),this.setState({isPeeking:!1,canAskToJoin:this.askToJoinEnabled&&e.getJoinRule()===i.JoinRule.Knock})}}shouldShowApps(e){if(!XE||!e)return!1;const t=e.roomId+"_hide_widget_drawer",n=localStorage.getItem(t),i=!n||"false"===n,r=this.context.widgetLayoutStore.getContainerWidgets(e,Sv.mc.Top);return i&&r.length>0}componentDidMount(){this.unmounted=!1,this.dispatcherRef=w.A.register(this.onAction),this.context.client&&(this.context.client.on(i.ClientEvent.Room,this.onRoom),this.context.client.on(i.RoomEvent.Timeline,this.onRoomTimeline),this.context.client.on(i.RoomEvent.TimelineReset,this.onRoomTimelineReset),this.context.client.on(i.RoomEvent.Name,this.onRoomName),this.context.client.on(i.RoomStateEvent.Events,this.onRoomStateEvents),this.context.client.on(i.RoomStateEvent.Update,this.onRoomStateUpdate),this.context.client.on(i.RoomEvent.MyMembership,this.onMyMembership),this.context.client.on(f.CryptoEvent.KeyBackupStatus,this.onKeyBackupStatus),this.context.client.on(f.CryptoEvent.UserTrustStatusChanged,this.onUserVerificationChanged),this.context.client.on(f.CryptoEvent.KeysChanged,this.onCrossSigningKeysChanged),this.context.client.on(i.MatrixEventEvent.Decrypted,this.onEventDecrypted)),this.context.roomViewStore.on(I.H,this.onRoomViewStoreUpdate),this.context.rightPanelStore.on(I.H,this.onRightPanelStoreUpdate),$_.A.on(I.H,this.onWidgetEchoStoreUpdate),this.context.widgetStore.on(I.H,this.onWidgetStoreUpdate),fb.e.instance.on(fb.s.ConnectedCalls,this.onConnectedCalls),this.props.resizeNotifier.on("isResizing",this.onIsResizing),this.settingWatchers=[V.A.watchSetting("layout",null,((...[,,,e])=>this.setState({layout:e}))),V.A.watchSetting("lowBandwidth",null,((...[,,,e])=>this.setState({lowBandwidth:e}))),V.A.watchSetting("alwaysShowTimestamps",null,((...[,,,e])=>this.setState({alwaysShowTimestamps:e}))),V.A.watchSetting("showTwelveHourTimestamps",null,((...[,,,e])=>this.setState({showTwelveHourTimestamps:e}))),V.A.watchSetting(du.cd,null,((...[,,,e])=>this.setState({userTimezone:e}))),V.A.watchSetting("readMarkerInViewThresholdMs",null,((...[,,,e])=>this.setState({readMarkerInViewThresholdMs:e}))),V.A.watchSetting("readMarkerOutOfViewThresholdMs",null,((...[,,,e])=>this.setState({readMarkerOutOfViewThresholdMs:e}))),V.A.watchSetting("showHiddenEventsInTimeline",null,((...[,,,e])=>this.setState({showHiddenEvents:e}))),V.A.watchSetting("urlPreviewsEnabled",null,this.onUrlPreviewsEnabledChange),V.A.watchSetting("urlPreviewsEnabled_e2ee",null,this.onUrlPreviewsEnabledChange),V.A.watchSetting("feature_dynamic_room_predecessors",null,((...[,,,e])=>this.setState({msc3946ProcessDynamicPredecessor:e})))],this.onRoomViewStoreUpdate(!0);const e=this.getCallForRoom(),t=null==e?void 0:e.state;this.setState({callState:t}),this.context.legacyCallHandler.on(Ee.uv.CallState,this.onCallState),window.addEventListener("beforeunload",this.onPageUnload)}shouldComponentUpdate(e,t){const n=(0,Hg.No)(this.props,e),i=this.state,{upgradeRecommendation:r}=i,s=(0,Ve.A)(i,JE),{upgradeRecommendation:o}=t,a=(0,Ve.A)(t,qE),l=(null==o?void 0:o.needsUpgrade)!==(null==r?void 0:r.needsUpgrade)||(0,Hg.No)(s,a);return n||l}componentDidUpdate(){this.messagePanel&&void 0===this.state.atEndOfLiveTimeline&&this.setState({atEndOfLiveTimeline:this.messagePanel.isAtEndOfLiveTimeline()})}componentWillUnmount(){var e,t;(this.unmounted=!0,this.context.legacyCallHandler.removeListener(Ee.uv.CallState,this.onCallState),this.state.roomId&&q_.setScrollState(this.state.roomId,this.getScrollState()),this.state.shouldPeek)&&(null===(e=this.context.client)||void 0===e||e.stopPeeking());this.stopAllPermalinkCreators(),w.A.unregister(this.dispatcherRef),this.context.client&&(this.context.client.removeListener(i.ClientEvent.Room,this.onRoom),this.context.client.removeListener(i.RoomEvent.Timeline,this.onRoomTimeline),this.context.client.removeListener(i.RoomEvent.TimelineReset,this.onRoomTimelineReset),this.context.client.removeListener(i.RoomEvent.Name,this.onRoomName),this.context.client.removeListener(i.RoomStateEvent.Events,this.onRoomStateEvents),this.context.client.removeListener(i.RoomEvent.MyMembership,this.onMyMembership),this.context.client.removeListener(i.RoomStateEvent.Update,this.onRoomStateUpdate),this.context.client.removeListener(f.CryptoEvent.KeyBackupStatus,this.onKeyBackupStatus),this.context.client.removeListener(f.CryptoEvent.UserTrustStatusChanged,this.onUserVerificationChanged),this.context.client.removeListener(f.CryptoEvent.KeysChanged,this.onCrossSigningKeysChanged),this.context.client.removeListener(i.MatrixEventEvent.Decrypted,this.onEventDecrypted)),window.removeEventListener("beforeunload",this.onPageUnload),this.context.roomViewStore.off(I.H,this.onRoomViewStoreUpdate),this.context.rightPanelStore.off(I.H,this.onRightPanelStoreUpdate),$_.A.removeListener(I.H,this.onWidgetEchoStoreUpdate),this.context.widgetStore.removeListener(I.H,this.onWidgetStoreUpdate),this.props.resizeNotifier.off("isResizing",this.onIsResizing),this.state.room&&this.context.widgetLayoutStore.off(Sv.aK.emissionForRoom(this.state.room),this.onWidgetLayoutChange),fb.e.instance.off(fb.s.ConnectedCalls,this.onConnectedCalls),this.context.legacyCallHandler.off(Ee.uv.CallState,this.onCallState),this.updateRoomMembers.cancel();for(const e of this.settingWatchers)V.A.unwatchSetting(e);this.viewsLocalRoom&&this.state.room&&(null===(t=this.context.client)||void 0===t||t.store.removeRoom(this.state.room.roomId))}onLocalRoomEvent(e){this.context.client&&this.state.room&&e===this.state.room.roomId&&(0,gE.Cp)(this.context.client,this.state.room)}getRoomTombstone(e=this.state.room){var t;return null!==(t=null==e?void 0:e.currentState.getStateEvents(i.EventType.RoomTombstone,""))&&void 0!==t?t:void 0}async getIsRoomEncrypted(e=this.state.roomId){var t;const n=null===(t=this.context.client)||void 0===t?void 0:t.getCrypto();return!(!n||!e)&&await n.isEncryptionEnabledInRoom(e)}async calculateRecommendedVersion(e){const t=await e.getRecommendedVersion();this.unmounted||this.setState({upgradeRecommendation:t})}async loadMembersIfJoined(e){var t;if(null!==(t=this.context.client)&&void 0!==t&&t.hasLazyLoadMembersEnabled()&&e&&e.getMyMembership()===oa.O.Join)try{await e.loadMembersIfNeeded(),this.unmounted||this.setState({membersLoaded:!0})}catch(t){const n=`Fetching room members for ${e.roomId} failed. Room members will appear incomplete.`;o.v.error(n),o.v.error(t)}}calculatePeekRules(e){const t=e.currentState.getStateEvents(i.EventType.RoomHistoryVisibility,"");this.setState({canPeek:(null==t?void 0:t.getContent().history_visibility)===i.HistoryVisibility.WorldReadable})}updatePreviewUrlVisibility(e){this.setState((({isRoomEncrypted:t})=>({showUrlPreview:this.getPreviewUrlVisibility(e,t)})))}getPreviewUrlVisibility({roomId:e},t){const n=t?"urlPreviewsEnabled_e2ee":"urlPreviewsEnabled";return V.A.getValue(n,e)}async updateE2EStatus(e){if(!this.context.client||!this.state.isRoomEncrypted)return;const t=await this.cacheAndGetE2EStatus(e,this.context.client);this.unmounted||this.setState({e2eStatus:t})}async cacheAndGetE2EStatus(e,t){let n=tw.e2eStatusCache.get(e.roomId);return n&&this.setState({e2eStatus:n}),n=await(0,Y_.G)(t,e),tw.e2eStatusCache.set(e.roomId,n),n}async updateRoomEncrypted(e=this.state.room){if(!e||!this.context.client)return;const t=await this.getIsRoomEncrypted(e.roomId),n=t?await this.cacheAndGetE2EStatus(e,this.context.client):null;this.setState(YE({isRoomEncrypted:t,showUrlPreview:this.getPreviewUrlVisibility(e,t)},n&&{e2eStatus:n}))}updatePermissions(e){if(e&&this.context.client){const t=this.context.client.getSafeUserId(),n=e.getMyMembership()===oa.O.Join&&e.currentState.maySendEvent(i.EventType.Reaction,t),r=e.maySendMessage(),s=e.currentState.maySendEvent(i.EventType.RoomRedaction,t);this.setState({canReact:n,canSendMessages:r,canSelfRedact:s})}}checkDesktopNotifications(){if(!this.state.room)return;this.state.room.getJoinedMemberCount()+this.state.room.getInvitedMemberCount()>1&&S.default.shouldShowPrompt()&&(0,Vb.P)(!0)}updateDMState(){const e=this.state.room;if((null==e?void 0:e.getMyMembership())!=oa.O.Join)return;const t=null==e?void 0:e.getDMInviter();t&&x.FZ(e.client,e.roomId,t)}injectSticker(e,t,n,i){const r=this.getRoomId();this.context.client&&r&&(this.context.client.isGuest()?w.A.dispatch({action:"require_registration"}):mu.Ay.sharedInstance().sendStickerContentToRoom(e,r,i,t,n,this.context.client).then(void 0,(e=>{e.name})))}getScrollState(){const e=this.messagePanel;if(!e)return null;if(this.state.atEndOfLiveTimeline)return null;const t=e.getScrollState();return!t||t.stuckAtBottom?null:{focussedEvent:t.trackedScrollToken,pixelOffset:t.pixelOffset}}getCallForRoom(){return this.state.room?this.context.legacyCallHandler.getCallForRoom(this.state.room.roomId):null}getOldRoom(){var e,t;const{roomId:n}=(null===(e=this.state.room)||void 0===e?void 0:e.findPredecessor(this.state.msc3946ProcessDynamicPredecessor))||{};return(null===(t=this.context.client)||void 0===t?void 0:t.getRoom(n))||null}getHiddenHighlightCount(){const e=this.getOldRoom();return e?e.getUnreadNotificationCount(i.NotificationCountType.Highlight):0}get messagePanelClassNames(){return re()("mx_RoomView_messagePanel",{mx_IRCLayout:this.state.layout===zp.P.IRC})}get viewsLocalRoom(){return(0,$f.F)(this.state.room)}get permalinkCreator(){return this.getPermalinkCreatorForRoom()}renderLocalRoomCreateLoader(e){var t;if(!this.state.room||null===(t=this.context)||void 0===t||!t.client)return null;const n=this.state.room.getDefaultRoomName(this.context.client.getSafeUserId());return s.createElement(Ld.yw,this.state,s.createElement(ew,{localRoom:e,names:n,resizeNotifier:this.props.resizeNotifier,mainSplitContentType:this.state.mainSplitContentType}))}renderLocalRoomView(e){return s.createElement(Ld.yw,this.state,s.createElement(QE,{localRoom:e,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.permalinkCreator,roomView:this.roomView,onFileDrop:this.onFileDrop,mainSplitContentType:this.state.mainSplitContentType}))}renderWaitingForThirdPartyRoomView(e){return s.createElement(Ld.yw,this.state,s.createElement(FE,{resizeNotifier:this.props.resizeNotifier,roomView:this.roomView,inviteEvent:e}))}render(){var e;if(!this.context.client)return null;const{isRoomEncrypted:t}=this.state,n=null===t;if(this.state.room instanceof yh.Np)return this.state.room.state===yh.cd.CREATING?this.renderLocalRoomCreateLoader(this.state.room):this.renderLocalRoomView(this.state.room);if(this.state.room){const{shouldEncrypt:e,inviteEvent:t}=bh(this.state.room);if(e)return this.renderWaitingForThirdPartyRoomView(t)}if(!this.state.room){const e=!this.state.matrixClientIsReady||this.state.roomLoading||this.state.peekLoading;if(e){const t=!this.state.matrixClientIsReady||!this.state.roomId||this.state.peekLoading;return s.createElement("div",{className:"mx_RoomView"},s.createElement(eh.A,null,s.createElement(ny,{canPreview:!1,previewLoading:t&&!this.state.roomLoadError,error:this.state.roomLoadError,loading:e,joining:this.state.joining,oobData:this.props.oobData,roomId:this.state.roomId})))}{var r,o;let e;this.props.oobData&&(e=this.props.oobData.inviterName);const t=null===(r=this.props.threepidInvite)||void 0===r?void 0:r.toEmail,n=this.state.roomAlias;return s.createElement("div",{className:"mx_RoomView"},s.createElement(eh.A,null,s.createElement(ny,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectThreepidInviteButtonClicked,canPreview:!1,error:this.state.roomLoadError,roomAlias:n,joining:this.state.joining,inviterName:e,invitedEmail:t,oobData:this.props.oobData,signUrl:null===(o=this.props.threepidInvite)||void 0===o?void 0:o.signUrl,roomId:this.state.roomId,promptAskToJoin:this.state.promptAskToJoin,onSubmitAskToJoin:this.onSubmitAskToJoin,onCancelAskToJoin:this.onCancelAskToJoin})))}}const a=this.state.room.getMyMembership();if((0,ig.j)(this.state.room)&&a!==oa.O.Join)return s.createElement(eh.A,null,s.createElement("div",{className:"mx_MainSplit"},s.createElement(py,{room:this.state.room,onJoinButtonClicked:this.onJoinButtonClicked,onRejectButtonClicked:this.onRejectButtonClicked})),";");if(a===oa.O.Invite&&!this.state.room.isSpaceRoom()){if(this.state.joining||this.state.rejecting)return s.createElement(eh.A,null,s.createElement(ny,{canPreview:!1,error:this.state.roomLoadError,joining:this.state.joining,rejecting:this.state.rejecting,roomId:this.state.roomId}));{const e=this.context.client.getSafeUserId(),t=this.state.room.getMember(e),n=t?t.events.member:null;let i=(0,P._t)("room|inviter_unknown");var l,c;if(n)i=null!==(l=null===(c=n.sender)||void 0===c?void 0:c.name)&&void 0!==l?l:n.getSender();return s.createElement("div",{className:"mx_RoomView"},s.createElement(eh.A,null,s.createElement(ny,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectButtonClicked,onRejectAndIgnoreClick:this.onRejectAndIgnoreClick,inviterName:i,canPreview:!1,joining:this.state.joining,room:this.state.room,roomId:this.state.roomId})))}}if(this.state.canAskToJoin&&[oa.O.Knock,oa.O.Leave].includes(a))return s.createElement("div",{className:"mx_RoomView"},s.createElement(eh.A,null,s.createElement(ny,{onJoinClick:this.onJoinButtonClicked,room:this.state.room,canAskToJoinAndMembershipIsLeave:a===oa.O.Leave,promptAskToJoin:this.state.promptAskToJoin,knocked:a===oa.O.Knock,onSubmitAskToJoin:this.onSubmitAskToJoin,onCancelAskToJoin:this.onCancelAskToJoin,onForgetClick:this.onForgetClick})));let d,u=null;{const e=this.getCallForRoom();e&&"ended"!==this.state.callState&&"ringing"!==this.state.callState&&(u=e)}let m=!0;mu.Ay.sharedInstance().getCurrentUploads().length>0?d=s.createElement(r_,{room:this.state.room}):this.state.search||(m=this.state.statusBarVisible,d=s.createElement(pE.A,{room:this.state.room,isPeeking:a!==oa.O.Join,onInviteClick:this.onInviteClick,onVisible:this.onStatusBarVisible,onHidden:this.onStatusBarHidden}));const p=re()("mx_RoomView_statusArea",{mx_RoomView_statusArea_expanded:m}),h=d&&s.createElement("div",{role:"region",className:p,"aria-label":(0,P._t)("a11y|room_status_bar")},s.createElement("div",{className:"mx_RoomView_statusAreaBox"},s.createElement("div",{className:"mx_RoomView_statusAreaBox_line"}),d)),g=this.state.upgradeRecommendation,v=g&&g.needsUpgrade&&this.state.room.userMayUpgradeRoom(this.context.client.getSafeUserId()),f=this.getHiddenHighlightCount();let _,y;if(this.state.timelineRenderingType===Sp.Ae.Search)n||(_=s.createElement(UE,{searchInfo:this.state.search,onCancelClick:this.onCancelSearchClick,onSearchScopeChange:this.onSearchScopeChange,isRoomEncrypted:t}));else if(v)_=s.createElement(gy,{room:this.state.room});else if(a!==oa.O.Join){var b,E;let e;this.props.oobData&&(e=this.props.oobData.inviterName);const t=null===(b=this.props.threepidInvite)||void 0===b?void 0:b.toEmail;if(y=s.createElement(ny,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectThreepidInviteButtonClicked,joining:this.state.joining,inviterName:e,invitedEmail:t,oobData:this.props.oobData,canPreview:this.state.canPeek,room:this.state.room,roomId:this.state.roomId}),!(this.state.canPeek||null!==(E=this.state.room)&&void 0!==E&&E.isSpaceRoom()))return s.createElement("div",{className:"mx_RoomView"},y)}else f>0&&(_=s.createElement(Ae.A,{element:"div",className:"mx_RoomView_auxPanel_hiddenHighlights",onClick:this.onHiddenHighlightsClick},(0,P._t)("room|unread_notifications_predecessor",{count:f})));if(null!==(e=this.state.room)&&void 0!==e&&e.isSpaceRoom()&&!this.props.forceTimeline)return s.createElement(mE,{space:this.state.room,justCreatedOpts:this.props.justCreatedOpts,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.permalinkCreator,onJoinButtonClicked:this.onJoinButtonClicked,onRejectButtonClicked:this.props.threepidInvite?this.onRejectThreepidInviteButtonClicked:this.onRejectButtonClicked});const w=s.createElement(Qy,{room:this.state.room,userId:this.context.client.getSafeUserId(),showApps:this.state.showApps,resizeNotifier:this.props.resizeNotifier},_),S=s.createElement(jE,{room:this.state.room,permalinkCreator:this.permalinkCreator,resizeNotifier:this.props.resizeNotifier});let A;let C;!n&&a===oa.O.Join&&!this.state.search&&(A=s.createElement(t_,{room:this.state.room,e2eStatus:this.state.e2eStatus,resizeNotifier:this.props.resizeNotifier,replyToEvent:this.state.replyToEvent,permalinkCreator:this.permalinkCreator}));let x,k,R=!1;var I;(this.state.search&&(C=s.createElement(OE,{key:this.state.search.searchId,ref:this.searchResultsPanel,term:this.state.search.term,scope:this.state.search.scope,promise:this.state.search.promise,abortController:this.state.search.abortController,inProgress:!!this.state.search.inProgress,resizeNotifier:this.props.resizeNotifier,className:this.messagePanelClassNames,onUpdate:this.onSearchUpdate}),R=!0),this.state.isInitialEventHighlighted&&(x=this.state.initialEventId),n)||(k=s.createElement(yf,{ref:this.gatherTimelinePanelRef,timelineSet:this.state.room.getUnfilteredTimelineSet(),overlayTimelineSet:null===(I=this.state.virtualRoom)||void 0===I?void 0:I.getUnfilteredTimelineSet(),overlayTimelineSetFilter:pf.Xm,showReadReceipts:this.state.showReadReceipts,manageReadReceipts:!this.state.isPeeking,sendReadReceiptOnLoad:!this.state.wasContextSwitch,manageReadMarkers:!this.state.isPeeking,hidden:R,highlightedEventId:x,eventId:this.state.initialEventId,eventScrollIntoView:this.state.initialEventScrollIntoView,eventPixelOffset:this.state.initialEventPixelOffset,onScroll:this.onMessageListScroll,onEventScrolledIntoView:this.resetJumpToEvent,onReadMarkerUpdated:this.updateTopUnreadMessagesBar,showUrlPreview:this.state.showUrlPreview,className:this.messagePanelClassNames,membersLoaded:this.state.membersLoaded,permalinkCreator:this.permalinkCreator,resizeNotifier:this.props.resizeNotifier,showReactions:!0,layout:this.state.layout,editState:this.state.editState}));let T,N;this.state.showTopUnreadMessagesBar&&!this.state.search&&(T=s.createElement(hE,{onScrollUpClick:this.jumpToReadMarker,onCloseClick:this.forgetReadMarker})),!1!==this.state.atEndOfLiveTimeline||this.state.search||(N=s.createElement(V_,{highlight:this.state.room.getUnreadNotificationCount(i.NotificationCountType.Highlight)>0,numUnreadMessages:this.state.numUnreadMessages,onScrollToBottomClick:this.jumpToLiveTimeline}));const D=!n&&this.state.room&&this.state.showRightPanel?s.createElement(K_,{room:this.state.room,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.permalinkCreator,e2eStatus:this.state.e2eStatus,onSearchChange:this.onSearchChange,onSearchCancel:this.onCancelSearchClick}):void 0,M=re()("mx_RoomView_timeline",{mx_RoomView_timeline_rr_enabled:this.state.showReadReceipts});let{mainSplitContentType:O}=this.state;this.state.search&&(O=Sp.DZ.Timeline);const L=re()("mx_RoomView",{mx_RoomView_inCall:Boolean(u),mx_RoomView_immersive:O!==Sp.DZ.Timeline}),F=V.A.getValue("showChatEffects");let U,B;switch(O){case Sp.DZ.Timeline:B="mx_MainSplit_timeline",U=s.createElement(s.Fragment,null,this.roomViewBody.current&&s.createElement(bf,{sensor:this.roomViewBody.current,onMeasurement:this.onMeasurement}),w,S,s.createElement("main",{className:M},s.createElement(l_,{parent:this.roomView.current,onFileDrop:this.onFileDrop}),T,N,k,C),h,y,A);break;case Sp.DZ.MaximisedWidget:B="mx_MainSplit_maximisedWidget",U=s.createElement(s.Fragment,null,s.createElement(Ry,{room:this.state.room,userId:this.context.client.getSafeUserId(),resizeNotifier:this.props.resizeNotifier,showApps:!0,role:"main"}),y);break;case Sp.DZ.Call:var j;B="mx_MainSplit_call",U=s.createElement(s.Fragment,null,s.createElement(Bb,{room:this.state.room,resizing:this.state.resizing,waitForCall:(0,ig.j)(this.state.room),skipLobby:null!==(j=this.context.roomViewStore.skipCallLobby())&&void 0!==j&&j,role:"main"}),y)}const z=re()("mx_RoomView_body",B);let W,H,G="other_room";return this.state.mainSplitContentType!==Sp.DZ.Timeline&&(W="wide",H=420,G=this.state.mainSplitContentType===Sp.DZ.Call?"video_room":"maximised_widget"),s.createElement(Ld.yw,this.state,s.createElement("div",{className:L,ref:this.roomView,onKeyDown:this.onReactKeyDown},F&&this.roomView.current&&s.createElement(Lb,{roomWidth:this.roomView.current.offsetWidth}),s.createElement(eh.A,null,s.createElement(gu,{panel:D,resizeNotifier:this.props.resizeNotifier,sizeKey:W,defaultSize:H,analyticsRoomType:G},s.createElement("div",{className:z,ref:this.roomViewBody,"data-layout":this.state.layout},s.createElement(Ob,{room:this.state.room,additionalButtons:this.state.viewRoomOpts.buttons}),U)))))}}(0,h.A)(tw,"e2eStatusCache",new Map),(0,h.A)(tw,"contextType",Wa.A);class nw extends s.Component{constructor(e){super(e),(0,h.A)(this,"onToastStoreUpdate",(()=>{this.setState({toasts:T.A.sharedInstance().getToasts(),countSeen:T.A.sharedInstance().getCountSeen()})})),this.state={toasts:T.A.sharedInstance().getToasts(),countSeen:T.A.sharedInstance().getCountSeen()}}componentDidMount(){T.A.sharedInstance().on("update",this.onToastStoreUpdate),this.onToastStoreUpdate()}componentWillUnmount(){T.A.sharedInstance().removeListener("update",this.onToastStoreUpdate)}render(){const e=this.state.toasts.length,t=e>1;let n,i;if(0!==e){const r=this.state.toasts[0],{title:o,icon:a,key:l,component:c,className:d,bodyClassName:u,props:m}=r,p=re()("mx_Toast_body",u),h=re()("mx_Toast_toast",d,{mx_Toast_hasIcon:a,[`mx_Toast_icon_${a}`]:a}),g=Object.assign({},m,{key:l,toastKey:l}),v=s.createElement(c,g);let f,_;(o&&t||this.state.countSeen>0)&&(f=` (${this.state.countSeen+1}/${this.state.countSeen+e})`),o&&(_=s.createElement("div",{className:"mx_Toast_title"},s.createElement(Qa.E,{size:"lg",weight:"semibold",as:"h2"},o),s.createElement("span",{className:"mx_Toast_title_countIndicator"},f))),n=s.createElement("div",{className:h},_,s.createElement("div",{className:p},v)),i=re()("mx_ToastContainer",{mx_ToastContainer_stacked:t})}return n?s.createElement("div",{className:i,role:"alert"},n):null}}class iw extends s.Component{constructor(e,t){super(e,t),this.state={loading:!0}}componentDidMount(){this.props.userId&&this.loadProfileInfo()}componentDidUpdate(e){e.userId!==this.props.userId&&this.props.userId&&this.loadProfileInfo()}async loadProfileInfo(){let e;this.setState({loading:!0});try{e=await this.context.getProfileInfo(this.props.userId)}catch(e){return A.Ay.createDialog(_v.A,{title:(0,P._t)("error_dialog|error_loading_user_profile"),description:e instanceof Error?e.message:(0,P._t)("invite|failed_generic")}),void this.setState({loading:!1})}const t=new i.MatrixEvent({type:"m.room.member",content:e}),n=new i.RoomMember("",this.props.userId);n.setMembershipEvent(t),this.setState({member:n,loading:!1})}render(){if(this.state.loading)return s.createElement(Na.A,null);if(this.state.member){const e=s.createElement(K_,{overwriteCard:{phase:sl.n.MemberInfo,state:{member:this.state.member}},resizeNotifier:this.props.resizeNotifier});return s.createElement(gu,{panel:e,resizeNotifier:this.props.resizeNotifier,defaultSize:420,analyticsRoomType:"user_profile"},s.createElement(Xd,null))}return s.createElement("div",null)}}(0,h.A)(iw,"contextType",Pe.Ay);const rw=({backgroundImage:e,blurMultiplier:t})=>{if(!e)return null;const n={};if(t){const e=getComputedStyle(document.documentElement).getPropertyValue("--lp-background-blur").replace("px",""),i=parseInt(e,10);isNaN(i)||(n.filter=`blur(${i*t}px)`)}return s.createElement("div",{className:"mx_BackdropPanel"},s.createElement("img",{role:"presentation",alt:"",style:n,className:"mx_BackdropPanel--image",src:e}))};var sw=n("./src/stores/OwnBeaconStore.ts"),ow=n("./res/img/location/live-location.svg");const aw=({isMinimized:e})=>{const t=(0,Me.dF)(sw.g.instance,sw.q.MonitoringLivePosition,(()=>sw.g.instance.isMonitoringLiveLocation)),n=(0,Me.dF)(sw.g.instance,sw.q.LocationPublishError,(()=>sw.g.instance.getLiveBeaconIdsWithLocationPublishError())),i=(0,Me.dF)(sw.g.instance,sw.q.BeaconUpdateError,(()=>sw.g.instance.getLiveBeaconIds().filter((e=>sw.g.instance.beaconUpdateErrors.has(e))))),r=(0,Me.dF)(sw.g.instance,sw.q.LivenessChange,(()=>sw.g.instance.getLiveBeaconIds())),o=!!n.length,a=!!i.length;if(((e,t)=>{(0,s.useEffect)((()=>{const n=()=>{"visible"===document.visibilityState&&e.forEach((e=>{var n;return null===(n=t.get(e))||void 0===n?void 0:n.monitorLiveness()}))};return e.length&&document.addEventListener("visibilitychange",n),()=>{document.removeEventListener("visibilitychange",n)}}),[e,t])})(r,sw.g.instance.beacons),!t)return null;const l=((e,t,n)=>{var i,r;const s=null!==(i=null!==(r=null==t?void 0:t[0])&&void 0!==r?r:null==n?void 0:n[0])&&void 0!==i?i:null==e?void 0:e[0];if(!s)return;return sw.g.instance.getBeaconById(s)})(r,i,n),c=l?e=>{w.A.dispatch({action:R.r.ViewRoom,room_id:l.roomId,metricsTrigger:void 0,event_id:l.beaconInfoId,scroll_into_view:!0,highlighted:!0})}:null,d=((e,t)=>e?(0,P._t)("location_sharing|error_stopping_live_location"):t?(0,P._t)("location_sharing|error_sharing_live_location"):(0,P._t)("location_sharing|live_location_active"))(a,o);return s.createElement(Ae.A,{className:re()("mx_LeftPanelLiveShareWarning",{mx_LeftPanelLiveShareWarning__minimized:e,mx_LeftPanelLiveShareWarning__error:o||a}),title:e?d:void 0,onClick:c},e?s.createElement(ow.I,{height:10}):d)};function lw(e,t,n){return(1-(n=(0,v.clamp)(n,0,1)))*e+n*t}const cw=58,dw=58,uw=76,mw=8;class pw extends s.Component{constructor(...e){super(...e),(0,h.A)(this,"callViewWrapper",(0,s.createRef)()),(0,h.A)(this,"initX",0),(0,h.A)(this,"initY",0),(0,h.A)(this,"desiredTranslationX",Ie.A.instance.windowWidth-mw-336),(0,h.A)(this,"desiredTranslationY",Ie.A.instance.windowHeight-dw-232),(0,h.A)(this,"translationX",this.desiredTranslationX),(0,h.A)(this,"translationY",this.desiredTranslationY),(0,h.A)(this,"mouseHeld",!1),(0,h.A)(this,"scheduledUpdate",new Pf.L((()=>this.animationCallback()),(()=>requestAnimationFrame((()=>this.scheduledUpdate.trigger()))))),(0,h.A)(this,"startingPositionX",0),(0,h.A)(this,"startingPositionY",0),(0,h.A)(this,"_moving",!1),(0,h.A)(this,"animationCallback",(()=>{var e,t;if(!this.moving&&Math.abs(this.translationX-this.desiredTranslationX)<=1&&Math.abs(this.translationY-this.desiredTranslationY)<=1)this.translationX=this.desiredTranslationX,this.translationY=this.desiredTranslationY,this.setStyle();else{const e=this.moving?.2:.1;this.translationX=lw(this.translationX,this.desiredTranslationX,e),this.translationY=lw(this.translationY,this.desiredTranslationY,e),this.setStyle(),this.scheduledUpdate.mark()}null===(e=(t=this.props).onMove)||void 0===e||e.call(t)})),(0,h.A)(this,"setStyle",(()=>{this.callViewWrapper.current&&(this.callViewWrapper.current.style.transform=`translateX(${this.translationX}px) translateY(${this.translationY}px)`)})),(0,h.A)(this,"onResize",(()=>{this.snap(!1)})),(0,h.A)(this,"snap",((e=!1)=>{var t,n;const i=this.desiredTranslationX,r=this.desiredTranslationY,s=Ie.A.instance.windowWidth-((null===(t=this.callViewWrapper.current)||void 0===t?void 0:t.clientWidth)||336),o=Ie.A.instance.windowHeight-((null===(n=this.callViewWrapper.current)||void 0===n?void 0:n.clientHeight)||232);i>=s/2&&r>=o/2?(this.desiredTranslationX=s-mw,this.desiredTranslationY=o-dw):i>=s/2&&r<=o/2?(this.desiredTranslationX=s-mw,this.desiredTranslationY=cw):i<=s/2&&r>=o/2?(this.desiredTranslationX=uw,this.desiredTranslationY=o-dw):(this.desiredTranslationX=uw,this.desiredTranslationY=cw),e||(this.translationX=this.desiredTranslationX,this.translationY=this.desiredTranslationY),this.scheduledUpdate.mark()})),(0,h.A)(this,"onStartMoving",(e=>{e.preventDefault(),e.stopPropagation(),this.mouseHeld=!0,this.startingPositionX=e.clientX,this.startingPositionY=e.clientY})),(0,h.A)(this,"onMoving",(e=>{this.mouseHeld&&(Math.abs(this.startingPositionX-e.clientX)<5&&Math.abs(this.startingPositionY-e.clientY)<5||(e.preventDefault(),e.stopPropagation(),this.moving||(this.moving=!0,this.initX=e.pageX-this.desiredTranslationX,this.initY=e.pageY-this.desiredTranslationY,this.scheduledUpdate.mark()),this.setTranslation(e.pageX-this.initX,e.pageY-this.initY)))})),(0,h.A)(this,"onEndMoving",(e=>{this.mouseHeld&&(e.preventDefault(),e.stopPropagation(),this.mouseHeld=!1,setTimeout((()=>this.moving=!1)),this.snap(!0))})),(0,h.A)(this,"onClickCapture",(e=>{this.moving&&(e.preventDefault(),e.stopPropagation())}))}get moving(){return this._moving}set moving(e){this._moving=e}componentDidMount(){document.addEventListener("mousemove",this.onMoving),document.addEventListener("mouseup",this.onEndMoving),Ie.A.instance.on(Ie.x.Resize,this.onResize),this.snap()}componentWillUnmount(){document.removeEventListener("mousemove",this.onMoving),document.removeEventListener("mouseup",this.onEndMoving),Ie.A.instance.off(Ie.x.Resize,this.onResize)}componentDidUpdate(e){e.children!==this.props.children&&this.snap(!0)}setTranslation(e,t){var n,i;const r=(null===(n=this.callViewWrapper.current)||void 0===n?void 0:n.clientWidth)||336,s=(null===(i=this.callViewWrapper.current)||void 0===i?void 0:i.clientHeight)||232;e+r>=Ie.A.instance.windowWidth?this.desiredTranslationX=Ie.A.instance.windowWidth-r:this.desiredTranslationX=e<=0?0:e,t+s>=Ie.A.instance.windowHeight?this.desiredTranslationY=Ie.A.instance.windowHeight-s:this.desiredTranslationY=t<=0?0:t}render(){const e={transform:`translateX(${this.translationX}px) translateY(${this.translationY}px)`},t=this.props.children.map((e=>e({onStartMoving:this.onStartMoving,onResize:this.onResize})));return s.createElement("aside",{className:this.props.className,style:e,ref:this.callViewWrapper,onClickCapture:this.onClickCapture,onDoubleClick:this.props.onDoubleClick},t)}}function hw(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{d:"M12.207 5.293a1 1 0 0 1 0 1.414L7.914 11H18.5a1 1 0 1 1 0 2H7.914l4.293 4.293a1 1 0 0 1-1.414 1.414l-6-6a1 1 0 0 1 0-1.414l6-6a1 1 0 0 1 1.414 0Z"})})}hw.displayName="ArrowLeftIcon";const gw=(0,s.forwardRef)(hw);class vw extends s.Component{constructor(e,t){super(e,t),(0,h.A)(this,"room",void 0),this.room=t.getRoom(this.props.persistentRoomId)}render(){const e=vv.Ay.instance.get(this.props.persistentWidgetId,this.props.persistentRoomId);return e?s.createElement(Vv,{key:e.id,app:e,fullWidth:!0,room:this.room,userId:this.context.getSafeUserId(),creatorUserId:e.creatorUserId,widgetPageTitle:wg.A.getWidgetDataTitle(e),waitForIframeLoad:e.waitForIframeLoad,miniMode:!0,showMenubar:!1,pointerEvents:this.props.pointerEvents,movePersistedElement:this.props.movePersistedElement,overlay:this.props.children}):null}}var fw,_w;function yw(){return yw=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},yw.apply(null,arguments)}(0,h.A)(vw,"contextType",Pe.Ay);var bw=function(e,t){return s.createElement("svg",yw({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0,ref:t},e),fw||(fw=s.createElement("path",{fill:"currentColor",d:"M8.027 15.961c1.141 1.232 3.888 3.365 4.637 3.803l.151.09c1.143.679 4.722 2.807 7.33.815 2.021-1.542 1.364-3.278.684-3.794-.466-.362-1.838-1.36-3.128-2.26-1.268-.883-1.974-.175-2.452.303l-.026.026-.96.961c-.246.245-.618.156-.974-.125a26 26 0 0 1-2.692-2.385l-.004-.004c-.47-.47-1.4-1.4-2.373-2.68-.28-.356-.37-.728-.125-.973l.96-.961.027-.026c.478-.478 1.186-1.184.303-2.452-.9-1.29-1.898-2.662-2.26-3.128-.516-.68-2.252-1.337-3.794.684-1.992 2.608.136 6.187.815 7.33l.09.151c.438.75 2.56 3.484 3.791 4.625"})),_w||(_w=s.createElement("path",{fill:"currentColor",d:"M20.697 3.078a.64.64 0 0 0 0-.893.615.615 0 0 0-.88 0L17 5.045l-2.817-2.86a.615.615 0 0 0-.88 0 .64.64 0 0 0 0 .893l2.817 2.86-2.938 2.984a.64.64 0 0 0 0 .893.615.615 0 0 0 .88 0L17 6.832l2.938 2.983a.615.615 0 0 0 .88 0 .64.64 0 0 0 0-.893L17.88 5.939z"})))},Ew=(0,s.forwardRef)(bw);const ww=({widgetId:e,room:t,viewingRoom:n,onStartMoving:r,movePersistedElement:o})=>{const a=(0,s.useMemo)((()=>vv.Ay.instance.getApps(t.roomId).find((t=>t.id===e))),[t,e]),l=(0,Me.DY)(t,i.RoomEvent.Name,(0,s.useCallback)((()=>t.name),[t])),c=(0,pb.Jf)(e,t.roomId),d=(0,s.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),null!==c?w.A.dispatch({action:R.r.ViewRoom,room_id:t.roomId,view_call:!0,metricsTrigger:"WebFloatingCallWindow"}):n?Sv.aK.instance.moveToContainer(t,a,Sv.mc.Center):w.A.dispatch({action:R.r.ViewRoom,room_id:t.roomId,metricsTrigger:"WebFloatingCallWindow"})}),[t,c,a,n]),u=(0,s.useCallback)((e=>{var t;(e.preventDefault(),e.stopPropagation(),null!==c)?c.disconnect().catch((e=>console.error("Failed to leave call",e))):null===(t=rv.c.instance.getMessagingForUid(wg.A.getWidgetUid(a)))||void 0===t||t.transport.send(ov.k.HangupCall,{}).catch((e=>console.error("Failed to leave Jitsi",e)))}),[c,a]);return s.createElement("div",{className:"mx_WidgetPip",onMouseDown:r,onClick:d},s.createElement(vw,{persistentWidgetId:e,persistentRoomId:t.roomId,pointerEvents:"none",movePersistedElement:o},s.createElement("div",{onMouseDown:r,className:"mx_WidgetPip_overlay"},s.createElement(lc.A,{className:"mx_WidgetPip_header"},s.createElement(ha.k,{onClick:d,className:"mx_WidgetPip_backButton","aria-label":(0,P._t)("action|back")},s.createElement(gw,{className:"mx_Icon mx_Icon_16"}),l)),(null!==c||Bg.x.JITSI.matches(null==a?void 0:a.type))&&s.createElement(lc.A,{className:"mx_WidgetPip_footer"},s.createElement(ha.k,{onClick:u,title:(0,P._t)("action|leave"),"aria-label":(0,P._t)("action|leave"),placement:"top"},s.createElement(Ew,{className:"mx_Icon mx_Icon_24"}))))))},Sw=[su.iP.Connected,su.iP.InviteSent,su.iP.Connecting,su.iP.CreateAnswer,su.iP.CreateOffer,su.iP.WaitLocalMedia];function Aw(e){if(!e)return[null,[]];const t=Ee.Ay.instance.getAllActiveCallsForPip(e);let n=null,i=[];for(const e of t)Sw.includes(e.state)&&(e.isRemoteOnHold()||null!==n?i.push(e):n=e);return null===n&&i.length>0&&(n=i[0],i=i.slice(1)),i.length>1&&o.v.log("Found more than 1 secondary call! Other calls will not be shown."),[n,i]}class Cw extends s.Component{constructor(e){super(e),(0,h.A)(this,"onMove",(()=>{var e,t;return null===(e=(t=this.props.movePersistedElement).current)||void 0===e?void 0:e.call(t)})),(0,h.A)(this,"onRoomViewStoreUpdate",(()=>{var e,t;const n=Wa.M.instance.roomViewStore.getRoomId(),i=this.state.viewedRoomId;if(n===i)return;const r=null===(e=E.J.get())||void 0===e?void 0:e.getRoom(i);r&&Sv.aK.instance.off(Sv.aK.emissionForRoom(r),this.updateCalls);const s=null===(t=E.J.get())||void 0===t?void 0:t.getRoom(n||void 0);if(s&&Sv.aK.instance.on(Sv.aK.emissionForRoom(s),this.updateCalls),!n)return;const[o,a]=Aw(n);this.setState({viewedRoomId:n,primaryCall:o,secondaryCall:a[0]}),this.updateShowWidgetInPip()})),(0,h.A)(this,"onWidgetPersistence",(()=>{this.updateShowWidgetInPip()})),(0,h.A)(this,"onWidgetDockChanges",(()=>{this.updateShowWidgetInPip()})),(0,h.A)(this,"updateCalls",(()=>{if(!this.state.viewedRoomId)return;const[e,t]=Aw(this.state.viewedRoomId);this.setState({primaryCall:e,secondaryCall:t[0]}),this.updateShowWidgetInPip()})),(0,h.A)(this,"onCallRemoteHold",(()=>{if(!this.state.viewedRoomId)return;const[e,t]=Aw(this.state.viewedRoomId);this.setState({primaryCall:e,secondaryCall:t[0]})})),(0,h.A)(this,"onDoubleClick",(()=>{var e;const t=null===(e=this.state.primaryCall)||void 0===e?void 0:e.roomId;var n;(null!=t?t:this.state.persistentRoomId)&&w.A.dispatch({action:R.r.ViewRoom,room_id:null!==(n=null!=t?t:this.state.persistentRoomId)&&void 0!==n?n:void 0,metricsTrigger:"WebFloatingCallWindow"})}));const t=Wa.M.instance.roomViewStore.getRoomId(),[n,i]=Aw(t);this.state={viewedRoomId:t||void 0,primaryCall:n||null,secondaryCall:i[0],persistentWidgetId:Lg.A.instance.getPersistentWidgetId(),persistentRoomId:Lg.A.instance.getPersistentRoomId(),showWidgetInPip:!1}}componentDidMount(){Ee.Ay.instance.addListener(Ee.uv.CallChangeRoom,this.updateCalls),Ee.Ay.instance.addListener(Ee.uv.CallState,this.updateCalls),Wa.M.instance.roomViewStore.addListener(I.H,this.onRoomViewStoreUpdate),E.J.safeGet().on(su.$E.RemoteHoldUnhold,this.onCallRemoteHold);const e=E.J.safeGet().getRoom(this.state.viewedRoomId);e&&Sv.aK.instance.on(Sv.aK.emissionForRoom(e),this.updateCalls),Lg.A.instance.on(Lg.y.Persistence,this.onWidgetPersistence),Lg.A.instance.on(Lg.y.Dock,this.onWidgetDockChanges),Lg.A.instance.on(Lg.y.Undock,this.onWidgetDockChanges)}componentWillUnmount(){Ee.Ay.instance.removeListener(Ee.uv.CallChangeRoom,this.updateCalls),Ee.Ay.instance.removeListener(Ee.uv.CallState,this.updateCalls);const e=E.J.get();null==e||e.removeListener(su.$E.RemoteHoldUnhold,this.onCallRemoteHold),Wa.M.instance.roomViewStore.removeListener(I.H,this.onRoomViewStoreUpdate);const t=null==e?void 0:e.getRoom(this.state.viewedRoomId);t&&Sv.aK.instance.off(Sv.aK.emissionForRoom(t),this.updateCalls),Lg.A.instance.off(Lg.y.Persistence,this.onWidgetPersistence),Lg.A.instance.off(Lg.y.Dock,this.onWidgetDockChanges),Lg.A.instance.off(Lg.y.Undock,this.onWidgetDockChanges)}updateShowWidgetInPip(){const e=Lg.A.instance.getPersistentWidgetId(),t=Lg.A.instance.getPersistentRoomId();let n=!1,i=!1;e&&t&&E.J.safeGet().getRoom(t)&&(i=!Lg.A.instance.isDocked(e,t),n=this.state.viewedRoomId!==t);const r=n||i;this.setState({showWidgetInPip:r,persistentWidgetId:e,persistentRoomId:t})}render(){const e=!0,t=[];if(this.state.primaryCall){const n=this.state.primaryCall;t.push((({onStartMoving:t,onResize:i})=>s.createElement(Zy,{key:"call-view",onMouseDownOnHeader:t,call:n,secondaryCall:this.state.secondaryCall,pipMode:e,onResize:i})))}return this.state.showWidgetInPip&&this.state.persistentWidgetId&&t.push((({onStartMoving:e})=>{var t;return s.createElement(ww,{key:"widget-pip",widgetId:this.state.persistentWidgetId,room:E.J.safeGet().getRoom(null!==(t=this.state.persistentRoomId)&&void 0!==t?t:void 0),viewingRoom:this.state.viewedRoomId===this.state.persistentRoomId,onStartMoving:e,movePersistedElement:this.props.movePersistedElement})})),t.length?s.createElement(pw,{className:"mx_LegacyCallPreview",draggable:e,onDoubleClick:this.onDoubleClick,onMove:this.onMove},t):null}}const xw=()=>{const e=(0,s.useRef)();return s.createElement(Cw,{movePersistedElement:e})};var kw=n("./node_modules/matrix-js-sdk/src/pushprocessor.ts");class Rw{static encodeActions(e){const t=e.notify,n=e.sound,r=e.highlight;if(t){const e=[i.PushRuleActionName.Notify];return n&&e.push({set_tweak:"sound",value:n}),r?e.push({set_tweak:"highlight"}):e.push({set_tweak:"highlight",value:!1}),e}return[i.PushRuleActionName.DontNotify]}static decodeActions(e){let t,n=!1,r=!1;for(const s of e)if(s===i.PushRuleActionName.Notify)n=!0;else if(s===i.PushRuleActionName.DontNotify)n=!1;else{if("object"!=typeof s)return null;if("sound"===s.set_tweak)t=s.value;else{if("highlight"!==s.set_tweak)return null;r=s.value}}void 0===r&&(r=!0);const s={notify:n,highlight:r};return void 0!==t&&(s.sound=t),s}}const Iw=Rw.encodeActions;class Tw{}(0,h.A)(Tw,"ACTION_NOTIFY",Iw({notify:!0})),(0,h.A)(Tw,"ACTION_NOTIFY_DEFAULT_SOUND",Iw({notify:!0,sound:"default"})),(0,h.A)(Tw,"ACTION_NOTIFY_RING_SOUND",Iw({notify:!0,sound:"ring"})),(0,h.A)(Tw,"ACTION_HIGHLIGHT",Iw({notify:!0,highlight:!0})),(0,h.A)(Tw,"ACTION_HIGHLIGHT_DEFAULT_SOUND",Iw({notify:!0,sound:"default",highlight:!0})),(0,h.A)(Tw,"ACTION_DONT_NOTIFY",Iw({notify:!1})),(0,h.A)(Tw,"ACTION_DISABLED",void 0);let Pw=function(e){return e.Off="off",e.On="on",e.Loud="loud",e}({});class Nw{static actionsFor(e){return e===Pw.On?Tw.ACTION_NOTIFY:e===Pw.Loud?Tw.ACTION_HIGHLIGHT_DEFAULT_SOUND:[]}static contentRuleVectorStateKind(e){const t=Rw.decodeActions(e.actions);if(!t)return null;let n=0;t.sound&&n++,t.highlight&&n++;let i=null;switch(n){case 0:i=Pw.On;break;case 2:i=Pw.Loud}return i}}(0,h.A)(Nw,"OFF",Pw.Off),(0,h.A)(Nw,"ON",Pw.On),(0,h.A)(Nw,"LOUD",Pw.Loud),(0,h.A)(Nw,"states",Pw);class Dw{constructor(e){(0,h.A)(this,"description",void 0),(0,h.A)(this,"vectorStateToActions",void 0),(0,h.A)(this,"syncedRuleIds",void 0),this.description=e.description,this.vectorStateToActions=e.vectorStateToActions,this.syncedRuleIds=e.syncedRuleIds}ruleToVectorState(e){let t=!1;e&&(t=e.enabled);for(const n of Object.values(Nw.states)){const i=this.vectorStateToActions[n];if(i){if(t&&JSON.stringify(Rw.decodeActions(e.actions))===JSON.stringify(Rw.decodeActions(i)))return n}else if(!t)return n}o.v.error(`Cannot translate rule actions into Vector rule state. Rule: ${JSON.stringify(e)}, Expected: ${JSON.stringify(this.vectorStateToActions)}`)}}const Mw={".m.rule.contains_display_name":new Dw({description:(0,P.AO)("settings|notifications|rule_contains_display_name"),vectorStateToActions:{[Pw.On]:Tw.ACTION_NOTIFY,[Pw.Loud]:Tw.ACTION_HIGHLIGHT_DEFAULT_SOUND,[Pw.Off]:Tw.ACTION_DISABLED}}),".m.rule.contains_user_name":new Dw({description:(0,P.AO)("settings|notifications|rule_contains_user_name"),vectorStateToActions:{[Pw.On]:Tw.ACTION_NOTIFY,[Pw.Loud]:Tw.ACTION_HIGHLIGHT_DEFAULT_SOUND,[Pw.Off]:Tw.ACTION_DISABLED},syncedRuleIds:[i.RuleId.IsUserMention]}),".m.rule.roomnotif":new Dw({description:(0,P.AO)("settings|notifications|rule_roomnotif"),vectorStateToActions:{[Pw.On]:Tw.ACTION_NOTIFY,[Pw.Loud]:Tw.ACTION_HIGHLIGHT,[Pw.Off]:Tw.ACTION_DISABLED},syncedRuleIds:[i.RuleId.IsRoomMention]}),".m.rule.room_one_to_one":new Dw({description:(0,P.AO)("settings|notifications|rule_room_one_to_one"),vectorStateToActions:{[Pw.On]:Tw.ACTION_NOTIFY,[Pw.Loud]:Tw.ACTION_NOTIFY_DEFAULT_SOUND,[Pw.Off]:Tw.ACTION_DONT_NOTIFY},syncedRuleIds:[i.RuleId.PollStartOneToOne,i.RuleId.PollStartOneToOneUnstable,i.RuleId.PollEndOneToOne,i.RuleId.PollEndOneToOneUnstable]}),".m.rule.encrypted_room_one_to_one":new Dw({description:(0,P.AO)("settings|notifications|rule_encrypted_room_one_to_one"),vectorStateToActions:{[Pw.On]:Tw.ACTION_NOTIFY,[Pw.Loud]:Tw.ACTION_NOTIFY_DEFAULT_SOUND,[Pw.Off]:Tw.ACTION_DONT_NOTIFY}}),".m.rule.message":new Dw({description:(0,P.AO)("settings|notifications|rule_message"),vectorStateToActions:{[Pw.On]:Tw.ACTION_NOTIFY,[Pw.Loud]:Tw.ACTION_NOTIFY_DEFAULT_SOUND,[Pw.Off]:Tw.ACTION_DONT_NOTIFY},syncedRuleIds:[i.RuleId.PollStart,i.RuleId.PollStartUnstable,i.RuleId.PollEnd,i.RuleId.PollEndUnstable]}),".m.rule.encrypted":new Dw({description:(0,P.AO)("settings|notifications|rule_encrypted"),vectorStateToActions:{[Pw.On]:Tw.ACTION_NOTIFY,[Pw.Loud]:Tw.ACTION_NOTIFY_DEFAULT_SOUND,[Pw.Off]:Tw.ACTION_DONT_NOTIFY}}),".m.rule.invite_for_me":new Dw({description:(0,P.AO)("settings|notifications|rule_invite_for_me"),vectorStateToActions:{[Pw.On]:Tw.ACTION_NOTIFY,[Pw.Loud]:Tw.ACTION_NOTIFY_DEFAULT_SOUND,[Pw.Off]:Tw.ACTION_DISABLED}}),".m.rule.call":new Dw({description:(0,P.AO)("settings|notifications|rule_call"),vectorStateToActions:{[Pw.On]:Tw.ACTION_NOTIFY,[Pw.Loud]:Tw.ACTION_NOTIFY_RING_SOUND,[Pw.Off]:Tw.ACTION_DISABLED}}),".m.rule.suppress_notices":new Dw({description:(0,P.AO)("settings|notifications|rule_suppress_notices"),vectorStateToActions:{[Pw.On]:Tw.ACTION_DISABLED,[Pw.Loud]:Tw.ACTION_NOTIFY_DEFAULT_SOUND,[Pw.Off]:Tw.ACTION_DONT_NOTIFY}}),".m.rule.tombstone":new Dw({description:(0,P.AO)("settings|notifications|rule_tombstone"),vectorStateToActions:{[Pw.On]:Tw.ACTION_NOTIFY,[Pw.Loud]:Tw.ACTION_HIGHLIGHT,[Pw.Off]:Tw.ACTION_DISABLED}})};class Ow{static parseContentRules(e){const t=Ow.categoriseContentRules(e);return t.loud.length?{vectorState:Pw.Loud,rules:t.loud,externalRules:[...t.loud_but_disabled,...t.on,...t.on_but_disabled,...t.other]}:t.loud_but_disabled.length?{vectorState:Pw.Off,rules:t.loud_but_disabled,externalRules:[...t.on,...t.on_but_disabled,...t.other]}:t.on.length?{vectorState:Pw.On,rules:t.on,externalRules:[...t.on_but_disabled,...t.other]}:t.on_but_disabled.length?{vectorState:Pw.Off,rules:t.on_but_disabled,externalRules:t.other}:{vectorState:Pw.On,rules:[],externalRules:t.other}}static categoriseContentRules(e){const t={on:[],on_but_disabled:[],loud:[],loud_but_disabled:[],other:[]};for(const n in e.global)for(let r=0;r<Object.keys(e.global[n]).length;++r){const s=e.global[n][r];if("."!==s.rule_id[0]&&n===i.PushRuleKind.ContentSpecific)switch(s.kind=n,Nw.contentRuleVectorStateKind(s)){case Pw.On:s.enabled?t.on.push(s):t.on_but_disabled.push(s);break;case Pw.Loud:s.enabled?t.loud.push(s):t.loud_but_disabled.push(s);break;default:t.other.push(s)}}return t}}const Lw=async(e,t,n,i)=>{i?(await e.setPushRuleActions("global",n,t,i),await e.setPushRuleEnabled("global",n,t,!0)):await e.setPushRuleEnabled("global",n,t,!1)},Fw=async(e,t,n)=>{const i=new kw.j(e),r=null==t?void 0:t.map((e=>i.getPushRuleAndKindById(e))).filter((e=>Boolean(e)));if(null!=r&&r.length)for(const{kind:t,rule:i}of r)await Lw(e,i.rule_id,t,n)};function Uw(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Bw(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Uw(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Uw(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const Vw=e=>e?Bw(Bw({},e.rule),{},{kind:e.kind}):void 0,jw=async(e,t)=>{if((null==e?void 0:e.getType())!==i.EventType.PushRules)return;const n=new kw.j(t);Object.entries(Mw).forEach((async([e,i])=>{try{await(async(e,t,n,i)=>{var r;const s=Vw(t.getPushRuleAndKindById(n));if(!s)return;const o=null===(r=i.syncedRuleIds)||void 0===r?void 0:r.map((e=>Vw(t.getPushRuleAndKindById(e)))).filter((e=>Boolean(e)));if(null==o||!o.length)return;const a=i.ruleToVectorState(s),l=o.filter((e=>e.enabled!==s.enabled||i.ruleToVectorState(e)!==a));l.length&&await Fw(e,l.map((({rule_id:e})=>e)),s.enabled?s.actions:void 0)})(t,n,e,i)}catch(t){o.v.error(`Failed to fully synchronise push rules for ${e}`,t)}}))};var zw=n("./src/contexts/LocalDeviceVerificationStateContext.ts");function Ww(e){const t=function(e){const[t,n]=(0,s.useState)(!1);return(0,s.useEffect)((()=>{const t=e.getUserId();if(!t)return;const i=e.getCrypto();null==i||i.getUserVerificationStatus(t).then((e=>n(e.isCrossSigningVerified())),(e=>o.v.error("Error fetching verification status",e)))}),[e]),(0,Me.ml)(e,f.CryptoEvent.UserTrustStatusChanged,((t,i)=>{t===e.getUserId()&&n(i.isCrossSigningVerified())})),t}(e.client);return s.createElement(Pe.Ay.Provider,{value:e.client},s.createElement(zw.f.Provider,{value:t},e.children))}function Hw(e){return e.closest("input, textarea, select, [contenteditable=true]")}class Gw extends s.Component{constructor(e){super(e),(0,h.A)(this,"_matrixClient",void 0),(0,h.A)(this,"_roomView",void 0),(0,h.A)(this,"_resizeContainer",void 0),(0,h.A)(this,"resizeHandler",void 0),(0,h.A)(this,"layoutWatcherRef",void 0),(0,h.A)(this,"compactLayoutWatcherRef",void 0),(0,h.A)(this,"backgroundImageWatcherRef",void 0),(0,h.A)(this,"timezoneProfileUpdateRef",void 0),(0,h.A)(this,"resizer",void 0),(0,h.A)(this,"onTimezoneUpdate",(async()=>{if(!V.A.getValue("userTimezonePublish")){try{await this._matrixClient.deleteExtendedProfileProperty("us.cloke.msc4175.tz")}catch(e){console.warn("Failed to delete timezone from user profile",e)}return}const e=V.A.getValue("userTimezone")||Intl.DateTimeFormat().resolvedOptions().timeZone;if(e&&"string"==typeof e)try{await this._matrixClient.setExtendedProfileProperty("us.cloke.msc4175.tz",e)}catch(e){console.warn("Failed to update user profile with current timezone",e)}})),(0,h.A)(this,"onCallState",(()=>{const e=Ee.Ay.instance.getAllActiveCalls();e!==this.state.activeCalls&&this.setState({activeCalls:e})})),(0,h.A)(this,"refreshBackgroundImage",(async()=>{let e=V.A.getValue("RoomList.backgroundImage");e=e?(0,Up.lH)(e).srcHttp:Va.V.instance.getHttpAvatarUrl(),this.setState({backgroundImage:e})})),(0,h.A)(this,"canResetTimelineInRoom",(e=>!this._roomView.current||this._roomView.current.canResetTimeline())),(0,h.A)(this,"onAccountData",(e=>{"m.ignored_user_list"===e.getType()&&w.A.dispatch({action:"ignore_state_changed"}),jw(e,this._matrixClient)})),(0,h.A)(this,"onCompactLayoutChanged",(()=>{this.setState({useCompactLayout:V.A.getValue("useCompactLayout")})})),(0,h.A)(this,"onSync",((e,t,n)=>{var r,s;const o=null===(r=this.state.syncErrorData)||void 0===r||null===(r=r.error)||void 0===r?void 0:r.errcode,a=null==n||null===(s=n.error)||void 0===s?void 0:s.errcode;e===t&&o===a||(this.setState({syncErrorData:e===i.SyncState.Error?n:void 0}),t===i.SyncState.Prepared&&e===i.SyncState.Syncing?this.updateServerNoticeEvents():this.calculateServerLimitToast(this.state.syncErrorData,this.state.usageLimitEventContent))})),(0,h.A)(this,"onRoomStateEvents",(e=>{const t=oc.Ay.instance.orderedLists[ve.zO.ServerNotice];null!=t&&t.some((t=>t.roomId===e.getRoomId()))&&this.updateServerNoticeEvents()})),(0,h.A)(this,"onUsageLimitDismissed",(()=>{this.setState({usageLimitDismissed:!0})})),(0,h.A)(this,"updateServerNoticeEvents",(async()=>{const e=oc.Ay.instance.orderedLists[ve.zO.ServerNotice];if(!e)return;const t=[];let n=0;for(const i of e){const e=i.currentState.getStateEvents("m.room.pinned_events","");if(!e||!e.getContent().pinned)continue;n=e.getTs();const r=e.getContent().pinned.slice(0,2);for(const e of r){const n=await this._matrixClient.getEventTimeline(i.getUnfilteredTimelineSet(),e),r=null==n?void 0:n.getEvents().find((t=>t.getId()===e));r&&t.push(r)}}if(n&&this.state.usageLimitEventTs&&this.state.usageLimitEventTs>n)return;const i=t.find((e=>e&&"m.room.message"===e.getType()&&"m.server_notice.usage_limit_reached"===e.getContent().server_notice_type)),r=null==i?void 0:i.getContent();this.calculateServerLimitToast(this.state.syncErrorData,r),this.setState({usageLimitEventContent:r,usageLimitEventTs:n,usageLimitDismissed:!1})})),(0,h.A)(this,"onPaste",(e=>{const t=Hw(e.target);if(t!==document.activeElement)if(null!=t&&t.focus)t.focus();else{var n;const e=!(null===(n=document.activeElement)||void 0===n||!n.closest(".mx_ThreadView"));w.A.dispatch({action:R.r.FocusSendMessageComposer,context:e?Sp.Ae.Thread:Sp.Ae.Room},!0)}})),(0,h.A)(this,"onReactKeyDown",(e=>{this.onKeyDown(e)})),(0,h.A)(this,"onNativeKeyDown",(e=>{e.target===document.body&&this.onKeyDown(e)})),(0,h.A)(this,"onKeyDown",(e=>{var t,n,i;let r=!1;switch((0,Re.zM)().getRoomAction(e)){case Se.bY.ScrollUp:case Se.bY.ScrollDown:case Se.bY.JumpToFirstMessage:case Se.bY.JumpToLatestMessage:this.onScrollKeyPressed(e),r=!0;break;case Se.bY.SearchInRoom:w.A.fire(R.r.FocusMessageSearch),r=!0}if(r)return e.stopPropagation(),void e.preventDefault();const s=(0,Re.zM)().getNavigationAction(e);switch(s){case Se.bY.NextLandmark:case Se.bY.PreviousLandmark:Hl.r.findAndFocusNextLandmark(Hl.H.MESSAGE_COMPOSER_OR_HOME,s===Se.bY.PreviousLandmark),r=!0;break;case Se.bY.FilterRooms:w.A.dispatch({action:"focus_room_filter"}),r=!0;break;case Se.bY.ToggleUserMenu:w.A.fire(R.r.ToggleUserMenu),r=!0;break;case Se.bY.ShowKeyboardSettings:w.A.dispatch({action:R.r.ViewUserSettings,initialTabId:wa.v.Keyboard}),r=!0;break;case Se.bY.GoToHome:if(r=!0,A.Ay.hasDialogs())return;w.A.dispatch({action:R.r.ViewHomePage});break;case Se.bY.ToggleSpacePanel:w.A.fire(R.r.ToggleSpacePanel),r=!0;break;case Se.bY.ToggleRoomSidePanel:"room_view"===this.props.page_type&&(rl.A.instance.togglePanel(null),r=!0);break;case Se.bY.SelectPrevRoom:w.A.dispatch({action:R.r.ViewRoomDelta,delta:-1,unread:!1}),r=!0;break;case Se.bY.SelectNextRoom:w.A.dispatch({action:R.r.ViewRoomDelta,delta:1,unread:!1}),r=!0;break;case Se.bY.SelectPrevUnreadRoom:w.A.dispatch({action:R.r.ViewRoomDelta,delta:-1,unread:!0});break;case Se.bY.SelectNextUnreadRoom:w.A.dispatch({action:R.r.ViewRoomDelta,delta:1,unread:!0});break;case Se.bY.PreviousVisitedRoomOrSpace:null===(t=l.A.get())||void 0===t||t.navigateForwardBack(!0),r=!0;break;case Se.bY.NextVisitedRoomOrSpace:null===(n=l.A.get())||void 0===n||n.navigateForwardBack(!1),r=!0}if(!r){switch((0,Re.zM)().getLabsAction(e)){case Se.bY.ToggleHiddenEventVisibility:{const e=V.A.getValueAt(ae.p.DEVICE,"showHiddenEventsInTimeline",void 0,!1);V.A.setValue("showHiddenEventsInTimeline",null,ae.p.DEVICE,!e),r=!0;break}}}if(!r&&null!==(i=l.A.get())&&void 0!==i&&i.overrideBrowserShortcuts()&&e.code.startsWith("Digit")&&"Digit0"!==e.code&&(0,se.Et)(e)&&(w.A.dispatch({action:R.r.SwitchSpace,num:parseInt(e.code.slice(5),10)}),r=!0),r)return e.stopPropagation(),void e.preventDefault();if(!(e.key===se.Uz.ALT||e.key===se.Uz.CONTROL||e.key===se.Uz.META||e.key===se.Uz.SHIFT)&&!e.ctrlKey&&!e.metaKey){const t=e.target!==document.body&&(e.key===se.Uz.SPACE||e.key===se.Uz.ENTER),n=1===e.key.length||"Dead"===e.key;if(!t&&n&&!Hw(e.target)){var o;const t=!(null===(o=document.activeElement)||void 0===o||!o.closest(".mx_ThreadView"));w.A.dispatch({action:R.r.FocusSendMessageComposer,context:t?Sp.Ae.Thread:Sp.Ae.Room},!0),e.stopPropagation()}}})),(0,h.A)(this,"onScrollKeyPressed",(e=>{var t;null===(t=this._roomView.current)||void 0===t||t.handleScrollKey(e)})),this.state={syncErrorData:void 0,useCompactLayout:V.A.getValue("useCompactLayout"),usageLimitDismissed:!1,activeCalls:Ee.Ay.instance.getAllActiveCalls()},this._matrixClient=this.props.matrixClient,oe.Ay.loadDevices(),this._roomView=s.createRef(),this._resizeContainer=s.createRef(),this.resizeHandler=s.createRef()}componentDidMount(){var e;document.addEventListener("keydown",this.onNativeKeyDown,!1),Ee.Ay.instance.addListener(Ee.uv.CallState,this.onCallState),this.updateServerNoticeEvents(),this._matrixClient.on(i.ClientEvent.AccountData,this.onAccountData),jw(this._matrixClient.getAccountData("m.push_rules"),this._matrixClient),this._matrixClient.on(i.ClientEvent.Sync,this.onSync),this.onSync(this._matrixClient.getSyncState(),null,null!==(e=this._matrixClient.getSyncStateData())&&void 0!==e?e:void 0),this._matrixClient.on(i.RoomStateEvent.Events,this.onRoomStateEvents),this.layoutWatcherRef=V.A.watchSetting("layout",null,this.onCompactLayoutChanged),this.compactLayoutWatcherRef=V.A.watchSetting("useCompactLayout",null,this.onCompactLayoutChanged),this.backgroundImageWatcherRef=V.A.watchSetting("RoomList.backgroundImage",null,this.refreshBackgroundImage),this.timezoneProfileUpdateRef=[V.A.watchSetting("userTimezonePublish",null,this.onTimezoneUpdate),V.A.watchSetting("userTimezone",null,this.onTimezoneUpdate)],this.resizer=this.createResizer(),this.resizer.attach(),Va.V.instance.on(I.H,this.refreshBackgroundImage),this.loadResizerPreferences(),this.refreshBackgroundImage()}componentWillUnmount(){var e,t;document.removeEventListener("keydown",this.onNativeKeyDown,!1),Ee.Ay.instance.removeListener(Ee.uv.CallState,this.onCallState),this._matrixClient.removeListener(i.ClientEvent.AccountData,this.onAccountData),this._matrixClient.removeListener(i.ClientEvent.Sync,this.onSync),this._matrixClient.removeListener(i.RoomStateEvent.Events,this.onRoomStateEvents),Va.V.instance.off(I.H,this.refreshBackgroundImage),V.A.unwatchSetting(this.layoutWatcherRef),V.A.unwatchSetting(this.compactLayoutWatcherRef),V.A.unwatchSetting(this.backgroundImageWatcherRef),null===(e=this.timezoneProfileUpdateRef)||void 0===e||e.forEach((e=>V.A.unwatchSetting(e))),null===(t=this.resizer)||void 0===t||t.detach()}createResizer(){var e;let t,n;const i={toggleSize:156,onCollapsed:e=>{n=e,e?(w.A.dispatch({action:"hide_left_panel"}),window.localStorage.setItem("mx_lhs_size","0")):w.A.dispatch({action:"show_left_panel"})},onResized:e=>{t=e,this.props.resizeNotifier.notifyLeftHandleResized()},onResizeStart:()=>{this.props.resizeNotifier.startResizing()},onResizeStop:()=>{n||window.localStorage.setItem("mx_lhs_size",""+t),this.props.resizeNotifier.stopResizing()},isItemCollapsed:e=>e.classList.contains("mx_LeftPanel_minimized"),handler:null!==(e=this.resizeHandler.current)&&void 0!==e?e:void 0},r=new ge(this._resizeContainer.current,he,i);return r.setClassNames({handle:"mx_ResizeHandle",vertical:"mx_ResizeHandle--vertical",reverse:"mx_ResizeHandle_reverse"}),r}loadResizerPreferences(){var e;let t=parseInt(window.localStorage.getItem("mx_lhs_size"),10);isNaN(t)&&(t=350),null===(e=this.resizer)||void 0===e||null===(e=e.forHandleWithId("lp-resizer"))||void 0===e||e.resize(t)}calculateServerLimitToast(e,t){var n;const i="M_RESOURCE_LIMIT_EXCEEDED"===(null==e||null===(n=e.error)||void 0===n?void 0:n.errcode);i&&(t=(null==e?void 0:e.error).data),t&&this.state.usageLimitDismissed?((e,t,n)=>{const i=(0,fe.AB)(e,n,{monthly_active_user:(0,P.AO)("error|mau"),hs_blocked:(0,P.AO)("error|hs_blocked"),"":(0,P.AO)("error|resource_limits")}),r=(0,fe.AB)(e,n,{"":(0,P.AO)("error|admin_contact_short")});T.A.sharedInstance().addOrReplaceToast({key:_e,title:(0,P._t)("common|warning"),props:{description:s.createElement(s.Fragment,null,i," ",r),primaryLabel:(0,P._t)("action|ok"),onPrimaryClick:()=>{ye(),t&&t()}},component:N.A,priority:70})})(t.limit_type,this.onUsageLimitDismissed,t.admin_contact):ye()}render(){let e;switch(this.props.page_type){case G.A.RoomView:e=s.createElement(tw,{ref:this._roomView,onRegistered:this.props.onRegistered,threepidInvite:this.props.threepidInvite,oobData:this.props.roomOobData,key:this.props.currentRoomId||"roomview",resizeNotifier:this.props.resizeNotifier,justCreatedOpts:this.props.roomJustCreatedOpts,forceTimeline:this.props.forceTimeline});break;case G.A.HomePage:e=s.createElement(Xd,{justRegistered:this.props.justRegistered});break;case G.A.UserView:this.props.currentUserId&&(e=s.createElement(iw,{userId:this.props.currentUserId,resizeNotifier:this.props.resizeNotifier}))}const t=re()({mx_MatrixChat_wrapper:!0,mx_MatrixChat_useCompactLayout:this.state.useCompactLayout}),n=re()({mx_MatrixChat:!0,"mx_MatrixChat--with-avatar":this.state.backgroundImage}),i=this.state.activeCalls.map((e=>s.createElement(lu,{call:e,key:e.callId})));return s.createElement(Ww,{client:this._matrixClient},s.createElement("div",{onPaste:this.onPaste,onKeyDown:this.onReactKeyDown,className:t,"aria-hidden":this.props.hideToSRUsers},s.createElement(nw,null),s.createElement("div",{className:n},s.createElement("div",{className:"mx_LeftPanel_outerWrapper"},s.createElement(aw,{isMinimized:this.props.collapseLhs||!1}),s.createElement("div",{className:"mx_LeftPanel_wrapper"},s.createElement(rw,{blurMultiplier:.5,backgroundImage:this.state.backgroundImage}),s.createElement(tc,null),s.createElement(rw,{backgroundImage:this.state.backgroundImage}),s.createElement("div",{className:"mx_LeftPanel_wrapper--user",ref:this._resizeContainer,"data-collapsed":!!this.props.collapseLhs||void 0},s.createElement(nu,{pageType:this.props.page_type,isMinimized:this.props.collapseLhs||!1,resizeNotifier:this.props.resizeNotifier})))),s.createElement(le,{passRef:this.resizeHandler,id:"lp-resizer"}),s.createElement("div",{className:"mx_RoomView_wrapper"},e))),s.createElement(xw,null),s.createElement(ru,null),i)}}(0,h.A)(Gw,"displayName","LoggedInView");const Kw=Gw;function Jw(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}let qw=function(e){return e[e.Primary=0]="Primary",e[e.Cancel=1]="Cancel",e}({});const $w=({onFinished:e,analyticsOwner:t,privacyPolicyUrl:n,primaryButton:i,cancelButton:r,hasCancel:o})=>{const a=n?s.createElement("span",null,(0,P._t)("analytics|privacy_policy",{},{PrivacyPolicyUrl:e=>s.createElement(Ra.A,{href:n,rel:"norefferer noopener",target:"_blank"},e)})):"";return s.createElement(Pa.A,{className:"mx_AnalyticsLearnMoreDialog",contentId:"mx_AnalyticsLearnMore",title:(0,P._t)("analytics|enable_prompt",{analyticsOwner:t}),onFinished:e},s.createElement("div",{className:"mx_Dialog_content"},s.createElement("div",{className:"mx_AnalyticsLearnMore_image_holder"}),s.createElement("div",{className:"mx_AnalyticsLearnMore_copy"},(0,P._t)("analytics|pseudonymous_usage_data",{analyticsOwner:t})),s.createElement("ul",{className:"mx_AnalyticsLearnMore_bullets"},s.createElement("li",null,(0,P._t)("analytics|bullet_1",{},{Bold:e=>s.createElement("strong",null,e)})),s.createElement("li",null,(0,P._t)("analytics|bullet_2",{},{Bold:e=>s.createElement("strong",null,e)})),s.createElement("li",null,(0,P._t)("analytics|disable_prompt"))),a),s.createElement(Da.A,{primaryButton:i,cancelButton:r,onPrimaryButtonClick:()=>e(qw.Primary),onCancel:()=>e(qw.Cancel),hasCancel:o}))},Yw=e=>{var t;const n=u.Ay.get("privacy_policy_url"),i=null!==(t=u.Ay.get("analytics_owner"))&&void 0!==t?t:u.Ay.get("brand");A.Ay.createDialog($w,function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Jw(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Jw(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({privacyPolicyUrl:n,analyticsOwner:i},e),"mx_AnalyticsLearnMoreDialog_wrapper")},Zw=()=>{w.A.dispatch({action:R.r.PseudonymousAnalyticsAccept})},Xw=()=>{w.A.dispatch({action:R.r.PseudonymousAnalyticsReject})},Qw=()=>{Yw({onFinished:e=>{e===qw.Primary&&Zw()},primaryButton:(0,P._t)("action|enable")})},eS=()=>{Yw({onFinished:e=>{e===qw.Primary?Zw():e===qw.Cancel&&Xw()},primaryButton:(0,P._t)("analytics|accept_button"),cancelButton:(0,P._t)("action|stop")})},tS="analytics";const nS=()=>{var e;const t=V.A.getValue("analyticsOptIn",null,!0);let n;if(t)n={description:(0,P._t)("analytics|consent_migration"),primaryLabel:(0,P._t)("analytics|accept_button"),onPrimaryClick:Zw,secondaryLabel:(0,P._t)("action|learn_more"),onSecondaryClick:eS};else{if(null!=t)return;{const e=e=>s.createElement(Ae.A,{kind:"link_inline",onClick:Qw},e);n={description:(0,P._t)("analytics|learn_more",{},{LearnMoreLink:e}),primaryLabel:(0,P._t)("action|yes"),onPrimaryClick:Zw,secondaryLabel:(0,P._t)("action|no"),onSecondaryClick:Xw}}}const i=null!==(e=u.Ay.get("analytics_owner"))&&void 0!==e?e:u.Ay.get().brand;T.A.sharedInstance().addOrReplaceToast({key:tS,title:(0,P._t)("analytics|enable_prompt",{analyticsOwner:i}),props:n,component:N.A,className:"mx_AnalyticsToast",priority:10})},iS=()=>{T.A.sharedInstance().dismissToast(tS)};var rS=n("./src/stores/ThreepidInviteStore.ts"),sS=n("./src/components/views/elements/DialPadBackspaceButton.tsx");class oS extends s.PureComponent{constructor(e){super(e),(0,h.A)(this,"numberEntryFieldRef",(0,s.createRef)()),(0,h.A)(this,"onCancelClick",(()=>{this.props.onFinished(!1)})),(0,h.A)(this,"onChange",(e=>{this.setState({value:e.target.value})})),(0,h.A)(this,"onFormSubmit",(e=>{e.preventDefault(),this.onDialPress()})),(0,h.A)(this,"onDigitPress",((e,t)=>{var n;(this.setState({value:this.state.value+e}),"click"===t.type)&&(null===(n=this.numberEntryFieldRef.current)||void 0===n||n.focus())})),(0,h.A)(this,"onDeletePress",(e=>{var t;0!==this.state.value.length&&(this.setState({value:this.state.value.slice(0,-1)}),"click"===e.type&&(null===(t=this.numberEntryFieldRef.current)||void 0===t||t.focus()))})),(0,h.A)(this,"onDialPress",(async()=>{Ee.Ay.instance.dialNumber(this.state.value),this.props.onFinished(!0)})),this.state={value:""}}render(){const e=s.createElement(sS.A,{onBackspacePress:this.onDeletePress});let t;return t=0!==this.state.value.length?s.createElement(Sa.A,{ref:this.numberEntryFieldRef,className:"mx_DialPadModal_field",id:"dialpad_number",value:this.state.value,autoFocus:!0,onChange:this.onChange,postfixComponent:e}):s.createElement(Sa.A,{ref:this.numberEntryFieldRef,className:"mx_DialPadModal_field",id:"dialpad_number",value:this.state.value,autoFocus:!0,onChange:this.onChange}),s.createElement("div",{className:"mx_DialPadModal"},s.createElement("div",null,s.createElement(Ae.A,{className:"mx_DialPadModal_cancel",onClick:this.onCancelClick})),s.createElement("div",{className:"mx_DialPadModal_header"},s.createElement("form",{onSubmit:this.onFormSubmit},t)),s.createElement("div",{className:"mx_DialPadModal_dialPad"},s.createElement(Fy.Ay,{hasDial:!0,onDigitPress:this.onDigitPress,onDeletePress:this.onDeletePress,onDialPress:this.onDialPress})))}}const aS=()=>{window.location.href="mobile_guide/"},lS=()=>{document.cookie="element_mobile_redirect_to_guide=false;path=/;max-age=14400",dS()},cS="mobileguide",dS=()=>{T.A.sharedInstance().dismissToast(cS)},uS="_toast-container_pnye8_17",mS=["children","className"];function pS(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function hS(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?pS(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):pS(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const gS=(0,s.forwardRef)((function(e,t){let{children:n,className:i}=e,r=(0,Ve.A)(e,mS);const s=ie(uS,i);return(0,dl.jsx)("div",hS(hS({},r),{},{className:s,ref:t,children:n}))}));function vS(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{d:"M3.5 20c-.417 0-.77-.146-1.063-.438A1.447 1.447 0 0 1 2 18.5c0-.417.146-.77.438-1.063A1.446 1.446 0 0 1 3.5 17H4V6c0-.55.196-1.02.588-1.412A1.926 1.926 0 0 1 6 4h14a.97.97 0 0 1 .712.287c.192.192.288.43.288.713s-.096.52-.288.713A.968.968 0 0 1 20 6H6v11h4.5c.417 0 .77.146 1.063.438.291.291.437.645.437 1.062 0 .417-.146.77-.438 1.063A1.446 1.446 0 0 1 10.5 20h-7ZM15 20a.968.968 0 0 1-.713-.288A.968.968 0 0 1 14 19V9c0-.283.096-.52.287-.713A.968.968 0 0 1 15 8h6a.97.97 0 0 1 .712.287c.192.192.288.43.288.713v10c0 .283-.096.52-.288.712A.968.968 0 0 1 21 20h-6Zm1-3h4v-7h-4v7Z"})})}vS.displayName="DevicesIcon";const fS=(0,s.forwardRef)(vS);function _S(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{fillRule:"evenodd",d:"M6.5 2h11a4.5 4.5 0 1 1 0 9h-11a4.5 4.5 0 0 1 0-9Zm0 2h7.258A4.479 4.479 0 0 0 13 6.5c0 .925.28 1.785.758 2.5H6.5a2.5 2.5 0 0 1 0-5ZM15 6.5a2.5 2.5 0 1 1 5 0 2.5 2.5 0 0 1-5 0Zm-13 11A4.5 4.5 0 0 1 6.5 13h11a4.5 4.5 0 1 1 0 9h-11A4.5 4.5 0 0 1 2 17.5Zm8.242-2.5H17.5a2.5 2.5 0 0 1 0 5h-7.258A4.478 4.478 0 0 0 11 17.5c0-.925-.28-1.785-.758-2.5ZM6.5 15a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5Z",clipRule:"evenodd"})})}_S.displayName="PreferencesIcon";const yS=(0,s.forwardRef)(_S);function bS(e,t){return(0,dl.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:[(0,dl.jsx)("path",{d:"M5.188 8v2h2V8h-2Zm3.875 0v2h2V8h-2Zm3.875 0v2h2V8h-2Zm3.875 0v2h2V8h-2ZM5.188 11.531v2h2v-2h-2Zm3.875 0v2h2v-2h-2Zm3.875 0v2h2v-2h-2Zm3.875 0v2h2v-2h-2ZM9 15a1 1 0 1 0 0 2h6a1 1 0 1 0 0-2H9Z"}),(0,dl.jsx)("path",{fillRule:"evenodd",d:"M2 6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6Zm2 0h16v12H4V6Z",clipRule:"evenodd"})]})}bS.displayName="KeyboardIcon";const ES=(0,s.forwardRef)(bS);function wS(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{fillRule:"evenodd",d:"M18 3a4 4 0 0 1 4 4v10a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V7a4 4 0 0 1 4-4h12Zm-8 2h8a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-8V5ZM8 19H6a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2v14Z",clipRule:"evenodd"})})}wS.displayName="SidebarIcon";const SS=(0,s.forwardRef)(wS);function AS(e,t){return(0,dl.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:[(0,dl.jsx)("path",{d:"M6 12a1 1 0 1 0-2 0 8.001 8.001 0 0 0 7 7.938V21a1 1 0 1 0 2 0v-1.062A8.001 8.001 0 0 0 20 12a1 1 0 1 0-2 0 6 6 0 0 1-12 0Z"}),(0,dl.jsx)("path",{fillRule:"evenodd",d:"M14 12V6a2 2 0 1 0-4 0v6a2 2 0 1 0 4 0ZM12 2a4 4 0 0 0-4 4v6a4 4 0 0 0 8 0V6a4 4 0 0 0-4-4Z",clipRule:"evenodd"})]})}AS.displayName="MicOnIcon";const CS=(0,s.forwardRef)(AS);function xS(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{d:"M6 22c-.55 0-1.02-.196-1.412-.587A1.926 1.926 0 0 1 4 20V10c0-.55.196-1.02.588-1.412A1.926 1.926 0 0 1 6 8h1V6c0-1.383.487-2.563 1.463-3.538C9.438 1.487 10.617 1 12 1s2.563.488 3.537 1.462C16.512 3.438 17 4.617 17 6v2h1c.55 0 1.02.196 1.413.588.391.391.587.862.587 1.412v10c0 .55-.196 1.02-.587 1.413A1.926 1.926 0 0 1 18 22H6Zm0-2h12V10H6v10ZM9 8h6V6c0-.833-.292-1.542-.875-2.125A2.893 2.893 0 0 0 12 3c-.833 0-1.542.292-2.125.875A2.893 2.893 0 0 0 9 6v2Z"})})}xS.displayName="LockIcon";const kS=(0,s.forwardRef)(xS);function RS(e,t){return(0,dl.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:[(0,dl.jsx)("path",{d:"M12 5a1 1 0 0 1-1-1V3a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1Zm-7.071-.071a1 1 0 0 1 1.414 0l.707.707A1 1 0 0 1 5.636 7.05l-.707-.707a1 1 0 0 1 0-1.414Z"}),(0,dl.jsx)("path",{fillRule:"evenodd",d:"M15.734 15.325C15.316 15.795 15 16.371 15 17v2a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2v-2c0-.63-.316-1.205-.734-1.675a5 5 0 1 1 7.468 0Zm-1.493-1.33a3 3 0 1 0-4.482 0c.433.486.894 1.166 1.112 2.005h2.258c.218-.84.679-1.52 1.112-2.005ZM13 18h-2v1h2v-1Z",clipRule:"evenodd"}),(0,dl.jsx)("path",{d:"M2 12a1 1 0 0 1 1-1h1a1 1 0 1 1 0 2H3a1 1 0 0 1-1-1Zm18-1a1 1 0 1 0 0 2h1a1 1 0 1 0 0-2h-1Zm-3.05-5.364a1 1 0 0 0 1.414 1.414l.707-.707a1 1 0 0 0-1.414-1.414l-.707.707Z"})]})}RS.displayName="LabsIcon";const IS=(0,s.forwardRef)(RS);var TS=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/block.js"),PS=n("./src/components/structures/TabbedView.tsx");const NS={controls:"_controls_1h4nb_17","button-group":"_button-group_1h4nb_27"},DS="_control_9gon8_18",MS="_enable-ligatures_9gon8_70",OS=["className","enableLigatures"];function LS(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function FS(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?LS(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):LS(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const US=(0,s.forwardRef)((function(e,t){let{className:n,enableLigatures:i}=e,r=(0,Ve.A)(e,OS);const s=ie(DS,n,{[MS]:i});return(0,dl.jsx)("input",FS(FS({ref:t},r),{},{className:s}))})),BS=(0,s.forwardRef)((function(e,t){return(0,dl.jsx)(dm,{asChild:!0,children:(0,dl.jsx)(US,FS({ref:t},e))})}));var VS=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/check-circle-solid.js"),jS=n("./node_modules/@vector-im/compound-web/dist/components/InlineSpinner/InlineSpinner.js");const zS=["children","className"],WS=["children","className"],HS=["children","className"],GS=["children","className"];function KS(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function JS(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?KS(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):KS(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const qS=(0,s.forwardRef)((function(e,t){let{children:n,className:i}=e,r=(0,Ve.A)(e,zS);const s=ie(bm,wm,i);return(0,dl.jsxs)(um,JS(JS({ref:t},r),{},{className:s,children:[(0,dl.jsx)(av.A,{}),n]}))})),$S=(0,s.forwardRef)((function(e,t){let{children:n,className:i}=e,r=(0,Ve.A)(e,WS);const s=ie(bm,Sm,i);return(0,dl.jsxs)(um,JS(JS({ref:t},r),{},{className:s,children:[(0,dl.jsx)(VS.A,{}),n]}))})),YS=(0,s.forwardRef)((function(e,t){let{children:n,className:i}=e,r=(0,Ve.A)(e,HS);const s=ie(bm,i);return(0,dl.jsxs)(um,JS(JS({ref:t},r),{},{className:s,children:[(0,dl.jsx)(jS.Z,{}),n]}))})),ZS=(0,s.forwardRef)((function(e,t){let{children:n,className:i}=e,r=(0,Ve.A)(e,GS);const s=ie(bm,Em,i);return(0,dl.jsx)(um,JS(JS({ref:t},r),{},{className:s,children:n}))})),XS=["className","label","onSave","onCancel","onInput","onClearServerErrors","serverInvalid","saveButtonLabel","cancelButtonLabel","savedLabel","savingLabel","helpLabel","disabled","children"];function QS(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function eA(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?QS(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):QS(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function tA(e,t){switch(t){case 0:return 0===e||3===e?1:e;case 1:return 2;case 4:return 0;case 2:return 2===e?3:e;case 3:return 2===e?0:e;case 5:return 3===e?0:e}!function(e){throw new Error(`Unreachable value: ${e}`)}(t)}const nA=(0,s.forwardRef)((function(e,t){let{className:n,label:i,onSave:r,onCancel:o,onInput:a,onClearServerErrors:l,serverInvalid:c,saveButtonLabel:d,cancelButtonLabel:u,savedLabel:m,savingLabel:p,helpLabel:h,disabled:g,children:v}=e,f=(0,Ve.A)(e,XS);const[_,y]=(0,s.useReducer)(tA,0),b=(0,s.useRef)(!1),[E,w]=(0,s.useState)(!1),S=1===_||2===_||E,A=(0,s.useRef)(void 0);(0,s.useEffect)((()=>(3===_&&(A.current=setTimeout((()=>{y(5),A.current=void 0}),2e3)),()=>{A.current&&clearTimeout(A.current),A.current=void 0})),[_]);const C=(0,s.useRef)(null),x=(0,s.useRef)(null),k=(0,s.useRef)(null),R=(0,s.useCallback)((()=>{b.current||(b.current=!0,w(!0))}),[E,w]),I=(0,s.useCallback)((e=>{b.current&&(e.currentTarget.contains(e.relatedTarget)||(b.current=!1,w(!1)))}),[E,w]),T=(0,s.useCallback)((e=>{y(0),null==a||a(e)}),[y,a]),P=(0,s.useCallback)((async e=>{if(e.preventDefault(),0!==_)try{var t;y(1),null===(t=x.current)||void 0===t||t.blur(),await(null==r?void 0:r(e)),y(2)}catch{y(3)}}),[r,_,A]),N=(0,s.useCallback)((e=>{var t;null===(t=k.current)||void 0===t||t.blur(),null==o||o(e),y(4)}),[k,o]);return(0,dl.jsx)(km,{className:n,onSubmit:P,onReset:N,onFocus:R,onBlur:I,onClearServerErrors:l,ref:C,children:(0,dl.jsxs)(Om,{name:"input",serverInvalid:c,children:[(0,dl.jsx)(Bm,{children:i}),(0,dl.jsxs)("div",{className:NS.controls,children:[(0,dl.jsx)(BS,eA(eA({ref:t},f),{},{onInput:T,disabled:g||2===_})),S&&(0,dl.jsxs)("div",{className:NS["button-group"],children:[(0,dl.jsx)(Te.m,{label:d,children:(0,dl.jsx)(pm,{asChild:!0,children:(0,dl.jsx)(Sl.$,{type:"submit",kind:"primary",size:"sm",ref:x,disabled:1!==_,iconOnly:!0,Icon:xb.A})})}),(0,dl.jsx)(Te.m,{label:u,children:(0,dl.jsx)(Sl.$,{type:"reset",kind:"secondary",size:"sm",ref:k,className:NS.button,disabled:2===_,iconOnly:!0,Icon:ab.A})})]})]}),2===_?(0,dl.jsx)(YS,{children:p}):v,m&&3===_&&(0,dl.jsx)($S,{children:m}),h&&(0===_||1===_)&&(0,dl.jsx)(mm,{children:e=>(void 0===e||e.valid)&&!c&&(0,dl.jsx)(ZS,{children:h})})]})})}));function iA(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{d:"m10.6 13.8-2.15-2.15a.948.948 0 0 0-.7-.275.948.948 0 0 0-.7.275.948.948 0 0 0-.275.7.95.95 0 0 0 .275.7L9.9 15.9c.2.2.433.3.7.3.267 0 .5-.1.7-.3l5.65-5.65a.948.948 0 0 0 .275-.7.948.948 0 0 0-.275-.7.948.948 0 0 0-.7-.275.948.948 0 0 0-.7.275L10.6 13.8ZM12 22a9.738 9.738 0 0 1-3.9-.788 10.099 10.099 0 0 1-3.175-2.137c-.9-.9-1.612-1.958-2.137-3.175A9.738 9.738 0 0 1 2 12a9.74 9.74 0 0 1 .788-3.9 10.099 10.099 0 0 1 2.137-3.175c.9-.9 1.958-1.612 3.175-2.137A9.738 9.738 0 0 1 12 2a9.74 9.74 0 0 1 3.9.788 10.098 10.098 0 0 1 3.175 2.137c.9.9 1.613 1.958 2.137 3.175A9.738 9.738 0 0 1 22 12a9.738 9.738 0 0 1-.788 3.9 10.098 10.098 0 0 1-2.137 3.175c-.9.9-1.958 1.613-3.175 2.137A9.738 9.738 0 0 1 12 22Zm0-2c2.233 0 4.125-.775 5.675-2.325C19.225 16.125 20 14.233 20 12c0-2.233-.775-4.125-2.325-5.675C16.125 4.775 14.233 4 12 4c-2.233 0-4.125.775-5.675 2.325C4.775 7.875 4 9.767 4 12c0 2.233.775 4.125 2.325 5.675C7.875 19.225 9.767 20 12 20Z"})})}iA.displayName="CheckCircleIcon";const rA=(0,s.forwardRef)(iA);function sA(e,t){return(0,dl.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:[(0,dl.jsx)("path",{d:"M11.287 7.287A.968.968 0 0 1 12 7c.283 0 .52.096.713.287.191.192.287.43.287.713s-.096.52-.287.713A.968.968 0 0 1 12 9a.968.968 0 0 1-.713-.287A.967.967 0 0 1 11 8c0-.283.096-.52.287-.713Zm0 4A.968.968 0 0 1 12 11c.283 0 .52.096.713.287.191.192.287.43.287.713v4a.97.97 0 0 1-.287.712A.968.968 0 0 1 12 17a.968.968 0 0 1-.713-.288A.968.968 0 0 1 11 16v-4c0-.283.096-.52.287-.713Z"}),(0,dl.jsx)("path",{fillRule:"evenodd",d:"M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2s10 4.477 10 10Zm-2 0a8 8 0 1 1-16 0 8 8 0 0 1 16 0Z",clipRule:"evenodd"})]})}sA.displayName="InfoIcon";const oA=(0,s.forwardRef)(sA),aA={alert:"_alert_1bz08_19",content:"_content_1bz08_46","text-content":"_text-content_1bz08_53",title:"_title_1bz08_57",icon:"_icon_1bz08_57",actions:"_actions_1bz08_73"},lA=["type","title","children","className","actions","onClose"];function cA(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function dA(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?cA(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):cA(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const uA=e=>{let{type:t,title:n,children:i,className:r,actions:o,onClose:a}=e,l=(0,Ve.A)(e,lA);const c=ie(aA.alert,r),d=(0,s.useCallback)((e=>{switch(t){case"critical":return(0,dl.jsx)(av.A,dA({},e));case"info":return(0,dl.jsx)(oA,dA({},e));case"success":return(0,dl.jsx)(rA,dA({},e))}}),[t]);return(0,dl.jsxs)("div",dA(dA({},l),{},{className:c,"data-type":t,children:[d({width:24,height:24,className:aA.icon,"aria-hidden":!0}),(0,dl.jsxs)("div",{className:aA.content,children:[(0,dl.jsxs)("div",{className:aA["text-content"],children:[(0,dl.jsx)(Qa.E,{size:"md",weight:"semibold",children:n}),(0,dl.jsx)(Qa.E,{size:"sm",weight:"regular",children:i})]}),o&&(0,dl.jsx)("div",{className:aA.actions,children:o})]}),a&&(0,dl.jsx)(Xa.K,{onClick:a,"aria-label":"Close",role:"button",className:aA.close,children:(0,dl.jsx)(ab.A,{})})]}))};var mA=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/pop-out.js");function pA(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{d:"M9 12.031c0-.283.096-.52.288-.712A.968.968 0 0 1 10 11.03h7.15l-1.875-1.875a.96.96 0 0 1-.3-.7c0-.266.108-.508.325-.725a.93.93 0 0 1 .712-.287.977.977 0 0 1 .688.287l3.6 3.6c.1.1.17.209.212.325.042.117.063.242.063.375 0 .134-.02.259-.063.375a.877.877 0 0 1-.212.325l-3.6 3.6a.93.93 0 0 1-.712.288.977.977 0 0 1-.688-.288 1.02 1.02 0 0 1-.313-.712.931.931 0 0 1 .288-.713l1.875-1.875H10a.968.968 0 0 1-.712-.287A.968.968 0 0 1 9 12.03Zm-6-7c0-.55.196-1.02.588-1.412A1.926 1.926 0 0 1 5 3.03h6a.97.97 0 0 1 .713.288.968.968 0 0 1 .287.712.97.97 0 0 1-.287.713.968.968 0 0 1-.713.287H5v14h6a.97.97 0 0 1 .713.288.968.968 0 0 1 .287.712.97.97 0 0 1-.287.713.968.968 0 0 1-.713.287H5c-.55 0-1.02-.196-1.412-.587A1.926 1.926 0 0 1 3 19.03v-14Z"})})}pA.displayName="SignOutIcon";const hA=(0,s.forwardRef)(pA),gA=(0,s.createContext)(null);gA.displayName="ToastContext";class vA{constructor(){(0,h.A)(this,"currentToast",void 0),(0,h.A)(this,"updateCallback",void 0),(0,h.A)(this,"idSeq",0)}setCallback(e){this.updateCallback=e}displayToast(e){var t;const n=++this.idSeq;this.currentToast={id:n,contents:e},null===(t=this.updateCallback)||void 0===t||t.call(this);return()=>{var e,t;(null===(e=this.currentToast)||void 0===e?void 0:e.id)===n&&(this.currentToast=void 0,null===(t=this.updateCallback)||void 0===t||t.call(this))}}getActiveToast(){var e;return null===(e=this.currentToast)||void 0===e?void 0:e.contents}}var fA=n("./src/components/views/elements/CopyableText.tsx");const _A=({children:e})=>s.createElement(s.Fragment,null,s.createElement(He.A,null),e),yA=({username:e})=>{const t=(0,s.useId)();return s.createElement("div",{className:"mx_UserProfileSettings_profile_controls_userId"},s.createElement("div",{className:"mx_UserProfileSettings_profile_controls_userId_label",id:t},(0,P._t)("settings|general|username")),s.createElement(fA.A,{getTextToCopy:()=>e,"aria-labelledby":t},e))},bA=({externalAccountManagementUrl:e})=>s.createElement(Ae.A,{onClick:null,element:"a",kind:"primary",target:"_blank",rel:"noreferrer noopener",href:e},s.createElement(mA.A,{className:"mx_UserProfileSettings_accountmanageIcon",width:"24",height:"24"}),(0,P._t)("settings|general|oidc_manage_button")),EA=()=>{const e=(0,Pe.nH)(),t=(0,s.useCallback)((async()=>{await Oa(e)?A.Ay.createDialog(La):w.A.dispatch({action:"logout"})}),[e]);return s.createElement(Ae.A,{onClick:t,kind:"danger_outline"},s.createElement(hA,{className:"mx_UserProfileSettings_accountmanageIcon",width:"24",height:"24"}),(0,P._t)("action|sign_out"))},wA=({externalAccountManagementUrl:e,canSetDisplayName:t,canSetAvatar:n})=>{var i,r;const[a,l]=(0,s.useState)(Va.V.instance.avatarMxc),[c,d]=(0,s.useState)(null!==(i=Va.V.instance.displayName)&&void 0!==i?i:""),[u,m]=(0,s.useState)(!1),[p,h]=(0,s.useState)(),[g,v]=(0,s.useState)(!1),f=(0,s.useContext)(gA),_=(0,Pe.nH)();(0,s.useEffect)((()=>{(async()=>{try{const e=await _.getMediaConfig();h(e["m.upload.size"])}catch(e){o.v.warn("Failed to get media config",e)}})()}),[_]);const b=(0,s.useCallback)((async()=>{const e=f.displayToast(s.createElement(_A,null,(0,P._t)("settings|general|avatar_remove_progress")));try{await _.setAvatarUrl(""),l("")}finally{e()}}),[f,_]),E=(0,s.useCallback)((async e=>{y.A.trackInteraction("WebProfileSettingsAvatarUploadButton"),o.v.log(`Uploading new avatar, ${e.name} of type ${e.type}, (${e.size}) bytes`);const t=f.displayToast(s.createElement(_A,null,(0,P._t)("settings|general|avatar_save_progress")));try{m(!1);const{content_uri:t}=await _.uploadContent(e);await _.setAvatarUrl(t),l(t)}catch{m(!0)}finally{t()}}),[f,_]),w=(0,s.useCallback)((e=>{d(e.target.value)}),[]),S=(0,s.useCallback)((()=>{var e;d(null!==(e=Va.V.instance.displayName)&&void 0!==e?e:"")}),[]),A=(0,s.useCallback)((async()=>{try{v(!1),await _.setDisplayName(c)}catch(e){throw v(!0),e}}),[c,_]),C=(0,s.useMemo)((()=>za.A.getDisplayUserIdentifier(_.getSafeUserId(),{withDisplayName:!0})),[_]),x=!t||!n;return s.createElement("div",{className:"mx_UserProfileSettings"},s.createElement("h2",null,(0,P._t)("common|profile")),s.createElement("div",null,x?(0,P._t)("settings|general|profile_subtitle_oidc"):(0,P._t)("settings|general|profile_subtitle")),s.createElement("div",{className:"mx_UserProfileSettings_profile"},s.createElement(Od.A,{avatar:null!=a?a:void 0,avatarAltText:(0,P._t)("common|user_avatar"),onChange:E,removeAvatar:a?b:void 0,placeholderName:c,placeholderId:null!==(r=_.getUserId())&&void 0!==r?r:"",disabled:!n}),s.createElement(nA,{className:"mx_UserProfileSettings_profile_displayName",label:(0,P._t)("settings|general|display_name"),value:c,saveButtonLabel:(0,P._t)("common|save"),cancelButtonLabel:(0,P._t)("common|cancel"),savedLabel:(0,P._t)("common|saved"),savingLabel:(0,P._t)("common|updating"),onChange:w,onCancel:S,onSave:A,disabled:!t},g&&s.createElement(qS,null,(0,P._t)("settings|general|display_name_error")))),u&&s.createElement(uA,{title:(0,P._t)("settings|general|avatar_upload_error_title"),type:"critical"},void 0===p?(0,P._t)("settings|general|avatar_upload_error_text_generic"):(0,P._t)("settings|general|avatar_upload_error_text",{size:(0,lh.z3)(p)})),C&&s.createElement(yA,{username:C}),s.createElement(zh.s,{gap:"var(--cpd-space-4x)",className:"mx_UserProfileSettings_profile_buttons"},e&&s.createElement(bA,{externalAccountManagementUrl:e}),s.createElement(EA,null)))};var SA=n("./src/components/structures/InteractiveAuth.tsx"),AA=n("./src/components/views/auth/InteractiveAuthEntryComponents.tsx");class CA extends s.Component{constructor(e){super(e),(0,h.A)(this,"onStagePhaseChange",((e,t)=>{const n={[AA.av.PHASE_PREAUTH]:{body:(0,P._t)("settings|general|deactivate_confirm_body_sso"),continueText:(0,P._t)("auth|sso"),continueKind:"danger"},[AA.av.PHASE_POSTAUTH]:{body:(0,P._t)("settings|general|deactivate_confirm_body"),continueText:(0,P._t)("settings|general|deactivate_confirm_continue"),continueKind:"danger"}},i={[AA.av.LOGIN_TYPE]:n,[AA.av.UNSTABLE_LOGIN_TYPE]:n}[e];let r,s,o;if(i){const e=i[t];e&&(e.body&&(r=e.body),e.continueText&&(s=e.continueText),e.continueKind&&(o=e.continueKind))}this.setState({bodyText:r,continueText:s,continueKind:o})})),(0,h.A)(this,"onUIAuthFinished",(async(e,t)=>{e||(t!==SA.R?(o.v.error("Error during UI Auth:",{result:t}),this.setState({errStr:(0,P._t)("settings|general|error_deactivate_communication")})):this.onCancel())})),(0,h.A)(this,"onUIAuthComplete",(e=>{E.J.safeGet().deactivateAccount(null!=e?e:void 0,this.state.shouldErase).then((e=>{w.A.fire(R.r.TriggerLogout),this.props.onFinished(!0)})).catch((e=>{o.v.error(e),this.setState({errStr:(0,P._t)("settings|general|error_deactivate_communication")})}))})),(0,h.A)(this,"onEraseFieldChange",(e=>{this.setState({shouldErase:e.currentTarget.checked,authEnabled:!1}),this.initAuth(e.currentTarget.checked)})),this.state={shouldErase:!1,errStr:null,authData:null,authEnabled:!0}}componentDidMount(){this.initAuth(!1)}onCancel(){this.props.onFinished(!1)}initAuth(e){E.J.safeGet().deactivateAccount(void 0,e).then((e=>{o.v.warn("User's account got deactivated without confirmation: Server had no auth"),this.setState({errStr:(0,P._t)("settings|general|error_deactivate_no_auth")})})).catch((e=>{e&&401===e.httpStatus&&e.data?this.setState({authData:e.data,authEnabled:!0}):this.setState({errStr:(0,P._t)("settings|general|error_deactivate_invalid_auth")})}))}render(){let e;this.state.errStr&&(e=s.createElement("div",{className:"error"},this.state.errStr));let t=s.createElement("div",null,(0,P._t)("common|loading"));return this.state.authData&&this.state.authEnabled&&(t=s.createElement("div",null,this.state.bodyText,s.createElement(SA.A,{matrixClient:E.J.safeGet(),authData:this.state.authData,makeRequest:this.onUIAuthComplete,onAuthFinished:this.onUIAuthFinished,onStagePhaseChange:this.onStagePhaseChange,continueText:this.state.continueText,continueKind:this.state.continueKind}))),s.createElement(Pa.A,{className:"mx_DeactivateAccountDialog",onFinished:this.props.onFinished,titleClass:"danger",title:(0,P._t)("settings|general|deactivate_section"),screenName:"DeactivateAccount"},s.createElement("div",{className:"mx_Dialog_content"},s.createElement("p",null,(0,P._t)("settings|general|deactivate_confirm_content")),s.createElement("ul",null,s.createElement("li",null,(0,P._t)("settings|general|deactivate_confirm_content_1")),s.createElement("li",null,(0,P._t)("settings|general|deactivate_confirm_content_2")),s.createElement("li",null,(0,P._t)("settings|general|deactivate_confirm_content_3")),s.createElement("li",null,(0,P._t)("settings|general|deactivate_confirm_content_4")),s.createElement("li",null,(0,P._t)("settings|general|deactivate_confirm_content_5"))),s.createElement("p",null,(0,P._t)("settings|general|deactivate_confirm_content_6")),s.createElement("div",{className:"mx_DeactivateAccountDialog_input_section"},s.createElement("p",null,s.createElement(ka.A,{checked:this.state.shouldErase,onChange:this.onEraseFieldChange},(0,P._t)("settings|general|deactivate_confirm_erase_label"))),e,t)))}}var xA=n("./src/components/views/auth/PassphraseField.tsx");const kA=/^[0-9 -.]+$/;const RA=127462-"A".charCodeAt(0),IA=/^[A-Z]{2}$/,TA=[{iso2:"GB",prefix:"44"},{iso2:"US",prefix:"1"},{iso2:"AF",prefix:"93"},{iso2:"AX",prefix:"358"},{iso2:"AL",prefix:"355"},{iso2:"DZ",prefix:"213"},{iso2:"AS",prefix:"1"},{iso2:"AD",prefix:"376"},{iso2:"AO",prefix:"244"},{iso2:"AI",prefix:"1"},{iso2:"AQ",prefix:"672"},{iso2:"AG",prefix:"1"},{iso2:"AR",prefix:"54"},{iso2:"AM",prefix:"374"},{iso2:"AW",prefix:"297"},{iso2:"AU",prefix:"61"},{iso2:"AT",prefix:"43"},{iso2:"AZ",prefix:"994"},{iso2:"BS",prefix:"1"},{iso2:"BH",prefix:"973"},{iso2:"BD",prefix:"880"},{iso2:"BB",prefix:"1"},{iso2:"BY",prefix:"375"},{iso2:"BE",prefix:"32"},{iso2:"BZ",prefix:"501"},{iso2:"BJ",prefix:"229"},{iso2:"BM",prefix:"1"},{iso2:"BT",prefix:"975"},{iso2:"BO",prefix:"591"},{iso2:"BA",prefix:"387"},{iso2:"BW",prefix:"267"},{iso2:"BV",prefix:"47"},{iso2:"BR",prefix:"55"},{iso2:"IO",prefix:"246"},{iso2:"VG",prefix:"1"},{iso2:"BN",prefix:"673"},{iso2:"BG",prefix:"359"},{iso2:"BF",prefix:"226"},{iso2:"BI",prefix:"257"},{iso2:"KH",prefix:"855"},{iso2:"CM",prefix:"237"},{iso2:"CA",prefix:"1"},{iso2:"CV",prefix:"238"},{iso2:"BQ",prefix:"599"},{iso2:"KY",prefix:"1"},{iso2:"CF",prefix:"236"},{iso2:"TD",prefix:"235"},{iso2:"CL",prefix:"56"},{iso2:"CN",prefix:"86"},{iso2:"CX",prefix:"61"},{iso2:"CC",prefix:"61"},{iso2:"CO",prefix:"57"},{iso2:"KM",prefix:"269"},{iso2:"CG",prefix:"242"},{iso2:"CD",prefix:"243"},{iso2:"CK",prefix:"682"},{iso2:"CR",prefix:"506"},{iso2:"HR",prefix:"385"},{iso2:"CU",prefix:"53"},{iso2:"CW",prefix:"599"},{iso2:"CY",prefix:"357"},{iso2:"CZ",prefix:"420"},{iso2:"CI",prefix:"225"},{iso2:"DK",prefix:"45"},{iso2:"DJ",prefix:"253"},{iso2:"DM",prefix:"1"},{iso2:"DO",prefix:"1"},{iso2:"EC",prefix:"593"},{iso2:"EG",prefix:"20"},{iso2:"SV",prefix:"503"},{iso2:"GQ",prefix:"240"},{iso2:"ER",prefix:"291"},{iso2:"EE",prefix:"372"},{iso2:"ET",prefix:"251"},{iso2:"FK",prefix:"500"},{iso2:"FO",prefix:"298"},{iso2:"FJ",prefix:"679"},{iso2:"FI",prefix:"358"},{iso2:"FR",prefix:"33"},{iso2:"GF",prefix:"594"},{iso2:"PF",prefix:"689"},{iso2:"TF",prefix:"262"},{iso2:"GA",prefix:"241"},{iso2:"GM",prefix:"220"},{iso2:"GE",prefix:"995"},{iso2:"DE",prefix:"49"},{iso2:"GH",prefix:"233"},{iso2:"GI",prefix:"350"},{iso2:"GR",prefix:"30"},{iso2:"GL",prefix:"299"},{iso2:"GD",prefix:"1"},{iso2:"GP",prefix:"590"},{iso2:"GU",prefix:"1"},{iso2:"GT",prefix:"502"},{iso2:"GG",prefix:"44"},{iso2:"GN",prefix:"224"},{iso2:"GW",prefix:"245"},{iso2:"GY",prefix:"592"},{iso2:"HT",prefix:"509"},{iso2:"HM",prefix:"672"},{iso2:"HN",prefix:"504"},{iso2:"HK",prefix:"852"},{iso2:"HU",prefix:"36"},{iso2:"IS",prefix:"354"},{iso2:"IN",prefix:"91"},{iso2:"ID",prefix:"62"},{iso2:"IR",prefix:"98"},{iso2:"IQ",prefix:"964"},{iso2:"IE",prefix:"353"},{iso2:"IM",prefix:"44"},{iso2:"IL",prefix:"972"},{iso2:"IT",prefix:"39"},{iso2:"JM",prefix:"1"},{iso2:"JP",prefix:"81"},{iso2:"JE",prefix:"44"},{iso2:"JO",prefix:"962"},{iso2:"KZ",prefix:"7"},{iso2:"KE",prefix:"254"},{iso2:"KI",prefix:"686"},{iso2:"XK",prefix:"383"},{iso2:"KW",prefix:"965"},{iso2:"KG",prefix:"996"},{iso2:"LA",prefix:"856"},{iso2:"LV",prefix:"371"},{iso2:"LB",prefix:"961"},{iso2:"LS",prefix:"266"},{iso2:"LR",prefix:"231"},{iso2:"LY",prefix:"218"},{iso2:"LI",prefix:"423"},{iso2:"LT",prefix:"370"},{iso2:"LU",prefix:"352"},{iso2:"MO",prefix:"853"},{iso2:"MK",prefix:"389"},{iso2:"MG",prefix:"261"},{iso2:"MW",prefix:"265"},{iso2:"MY",prefix:"60"},{iso2:"MV",prefix:"960"},{iso2:"ML",prefix:"223"},{iso2:"MT",prefix:"356"},{iso2:"MH",prefix:"692"},{iso2:"MQ",prefix:"596"},{iso2:"MR",prefix:"222"},{iso2:"MU",prefix:"230"},{iso2:"YT",prefix:"262"},{iso2:"MX",prefix:"52"},{iso2:"FM",prefix:"691"},{iso2:"MD",prefix:"373"},{iso2:"MC",prefix:"377"},{iso2:"MN",prefix:"976"},{iso2:"ME",prefix:"382"},{iso2:"MS",prefix:"1"},{iso2:"MA",prefix:"212"},{iso2:"MZ",prefix:"258"},{iso2:"MM",prefix:"95"},{iso2:"NA",prefix:"264"},{iso2:"NR",prefix:"674"},{iso2:"NP",prefix:"977"},{iso2:"NL",prefix:"31"},{iso2:"NC",prefix:"687"},{iso2:"NZ",prefix:"64"},{iso2:"NI",prefix:"505"},{iso2:"NE",prefix:"227"},{iso2:"NG",prefix:"234"},{iso2:"NU",prefix:"683"},{iso2:"NF",prefix:"672"},{iso2:"KP",prefix:"850"},{iso2:"MP",prefix:"1"},{iso2:"NO",prefix:"47"},{iso2:"OM",prefix:"968"},{iso2:"PK",prefix:"92"},{iso2:"PW",prefix:"680"},{iso2:"PS",prefix:"970"},{iso2:"PA",prefix:"507"},{iso2:"PG",prefix:"675"},{iso2:"PY",prefix:"595"},{iso2:"PE",prefix:"51"},{iso2:"PH",prefix:"63"},{iso2:"PN",prefix:"870"},{iso2:"PL",prefix:"48"},{iso2:"PT",prefix:"351"},{iso2:"PR",prefix:"1"},{iso2:"QA",prefix:"974"},{iso2:"RO",prefix:"40"},{iso2:"RU",prefix:"7"},{iso2:"RW",prefix:"250"},{iso2:"RE",prefix:"262"},{iso2:"WS",prefix:"685"},{iso2:"SM",prefix:"378"},{iso2:"SA",prefix:"966"},{iso2:"SN",prefix:"221"},{iso2:"RS",prefix:"381 p"},{iso2:"SC",prefix:"248"},{iso2:"SL",prefix:"232"},{iso2:"SG",prefix:"65"},{iso2:"SX",prefix:"1"},{iso2:"SK",prefix:"421"},{iso2:"SI",prefix:"386"},{iso2:"SB",prefix:"677"},{iso2:"SO",prefix:"252"},{iso2:"ZA",prefix:"27"},{iso2:"GS",prefix:"500"},{iso2:"KR",prefix:"82"},{iso2:"SS",prefix:"211"},{iso2:"ES",prefix:"34"},{iso2:"LK",prefix:"94"},{iso2:"BL",prefix:"590"},{iso2:"SH",prefix:"290 n"},{iso2:"KN",prefix:"1"},{iso2:"LC",prefix:"1"},{iso2:"MF",prefix:"590"},{iso2:"PM",prefix:"508"},{iso2:"VC",prefix:"1"},{iso2:"SD",prefix:"249"},{iso2:"SR",prefix:"597"},{iso2:"SJ",prefix:"47"},{iso2:"SZ",prefix:"268"},{iso2:"SE",prefix:"46"},{iso2:"CH",prefix:"41"},{iso2:"SY",prefix:"963"},{iso2:"ST",prefix:"239"},{iso2:"TW",prefix:"886"},{iso2:"TJ",prefix:"992"},{iso2:"TZ",prefix:"255"},{iso2:"TH",prefix:"66"},{iso2:"TL",prefix:"670"},{iso2:"TG",prefix:"228"},{iso2:"TK",prefix:"690"},{iso2:"TO",prefix:"676"},{iso2:"TT",prefix:"1"},{iso2:"TN",prefix:"216"},{iso2:"TR",prefix:"90"},{iso2:"TM",prefix:"993"},{iso2:"TC",prefix:"1"},{iso2:"TV",prefix:"688"},{iso2:"VI",prefix:"1"},{iso2:"UG",prefix:"256"},{iso2:"UA",prefix:"380"},{iso2:"AE",prefix:"971"},{iso2:"UY",prefix:"598"},{iso2:"UZ",prefix:"998"},{iso2:"VU",prefix:"678"},{iso2:"VA",prefix:"39"},{iso2:"VE",prefix:"58"},{iso2:"VN",prefix:"84"},{iso2:"WF",prefix:"681"},{iso2:"EH",prefix:"212"},{iso2:"YE",prefix:"967"},{iso2:"ZM",prefix:"260"},{iso2:"ZW",prefix:"263"}];class PA extends s.PureComponent{constructor(...e){super(...e),(0,h.A)(this,"validate",(0,Ip.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,P._t)(this.props.labelRequired)},{key:"email",test:({value:e})=>!e||jb.X(e),invalid:()=>(0,P._t)(this.props.labelInvalid)}]})),(0,h.A)(this,"onValidate",(async e=>{let t=this.validate;this.props.validationRules&&(t=this.props.validationRules);const n=await t(e);return this.props.onValidate&&this.props.onValidate(n),n}))}render(){return s.createElement(Sa.A,{id:this.props.id,ref:this.props.fieldRef,type:"text",label:(0,P._t)(this.props.label),value:this.props.value,autoFocus:this.props.autoFocus,onChange:this.props.onChange,onValidate:this.onValidate,tooltipAlignment:this.props.tooltipAlignment})}}(0,h.A)(PA,"defaultProps",{label:(0,P.AO)("auth|email_field_label"),labelRequired:(0,P.AO)("auth|email_field_label_required"),labelInvalid:(0,P.AO)("auth|email_field_label_invalid")});const NA=PA,DA=({onFinished:e})=>{const[t,n]=(0,s.useState)(""),i=(0,s.useRef)(null),r=async n=>{if(n.preventDefault(),i.current){if(t){if(!await i.current.validate({}))return i.current.focus(),void i.current.validate({focused:!0})}e(!0,t)}};return s.createElement(Pa.A,{title:(0,P._t)("auth|registration|continue_without_email_title"),className:"mx_RegistrationEmailPromptDialog",contentId:"mx_RegistrationEmailPromptDialog",onFinished:()=>e(!1),fixedWidth:!1},s.createElement("div",{className:"mx_Dialog_content",id:"mx_RegistrationEmailPromptDialog"},s.createElement("p",null,(0,P._t)("auth|registration|continue_without_email_description",{},{b:e=>s.createElement("strong",null,e)})),s.createElement("form",{onSubmit:r},s.createElement(NA,{fieldRef:i,autoFocus:!0,label:(0,P.AO)("auth|registration|continue_without_email_field_label"),value:t,onChange:e=>{const t=e.target;n(t.value)}}))),s.createElement(Da.A,{primaryButton:(0,P._t)("action|continue"),onPrimaryButtonClick:r,hasCancel:!1}))};var MA=n("./src/components/views/elements/Dropdown.tsx");function OA(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}class LA extends s.Component{constructor(e){super(e),(0,h.A)(this,"defaultCountry",void 0),(0,h.A)(this,"countries",void 0),(0,h.A)(this,"countryMap",void 0),(0,h.A)(this,"onSearchChange",(e=>{this.setState({searchQuery:e})})),(0,h.A)(this,"onOptionChange",(e=>{this.props.onOptionChange(this.countryMap.get(e))})),(0,h.A)(this,"getShortOption",(e=>{if(!this.props.isSmall)return;let t;return this.props.showPrefix&&(t="+"+this.countryMap.get(e).prefix),s.createElement("span",{className:"mx_CountryDropdown_shortOption"},this.flagImgForIso2(e),t)}));const t=new Intl.DisplayNames([(0,P.mf)()],{type:"region"});let n;this.countries=TA.map((e=>{var n;return function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?OA(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):OA(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({name:null!==(n=t.of(e.iso2))&&void 0!==n?n:e.iso2},e)})),this.countryMap=new Map(this.countries.map((e=>[e.iso2,e])));const i=u.Ay.get("default_country_code");if(i){const e=this.countries.find((e=>e.iso2===i.toUpperCase()));e&&(n=e)}if(!n)try{var r,o,a;const e=new Intl.Locale(null!==(r=navigator.language)&&void 0!==r?r:navigator.languages[0]),i=null!==(o=null!==(a=e.region)&&void 0!==a?a:e.language)&&void 0!==o?o:e.baseName,s=t.of(i).toUpperCase();n=this.countries.find((e=>e.iso2===i.toUpperCase()||e.name.toUpperCase()===s))}catch(e){console.warn("Failed to detect default locale",e)}this.defaultCountry=null!=n?n:this.countries[0],this.state={searchQuery:""}}componentDidMount(){this.props.value||this.props.onOptionChange(this.defaultCountry)}flagImgForIso2(e){return s.createElement("div",{className:"mx_Dropdown_option_emoji"},(t=e,IA.test(t)?String.fromCodePoint(...t.split("").map((e=>RA+e.charCodeAt(0)))):""));var t}render(){let e;if(this.state.searchQuery){if(e=this.countries.filter((e=>function(e,t){return"+"===e[0]&&(e=e.slice(1)),0==t.name.toUpperCase().indexOf(e.toUpperCase())||t.iso2==e.toUpperCase()||-1!==t.prefix.indexOf(e)}(this.state.searchQuery,e))),2==this.state.searchQuery.length&&this.countryMap.has(this.state.searchQuery.toUpperCase())){const t=this.countryMap.get(this.state.searchQuery.toUpperCase());e=e.filter((e=>e.iso2!=t.iso2)),e.unshift(t)}}else e=this.countries;const t=e.map((e=>s.createElement("div",{className:"mx_CountryDropdown_option",key:e.iso2},this.flagImgForIso2(e.iso2),e.name," (+",e.prefix,")"))),n=this.props.value||this.defaultCountry.iso2;return s.createElement(MA.A,{id:"mx_CountryDropdown",className:this.props.className+" mx_CountryDropdown",onOptionChange:this.onOptionChange,onSearchChange:this.onSearchChange,menuWidth:298,getShortOption:this.getShortOption,value:n,searchEnabled:!0,disabled:this.props.disabled,label:(0,P._t)("auth|country_dropdown"),autoComplete:"tel-country-code"},t)}}var FA=n("./src/components/views/auth/PassphraseConfirmField.tsx");let UA,BA,VA,jA,zA;var WA=function(e){return e.Email="field_email",e.PhoneNumber="field_phone_number",e.Username="field_username",e.Password="field_password",e.PasswordConfirm="field_password_confirm",e}(WA||{}),HA=function(e){return e[e.Unknown=0]="Unknown",e[e.Available=1]="Available",e[e.Unavailable=2]="Unavailable",e[e.Error=3]="Error",e[e.Invalid=4]="Invalid",e}(HA||{});UA=WA.Email,BA=WA.Password,VA=WA.PasswordConfirm,jA=WA.Username,zA=WA.PhoneNumber;class GA extends s.PureComponent{constructor(e){super(e),(0,h.A)(this,UA,null),(0,h.A)(this,BA,null),(0,h.A)(this,VA,null),(0,h.A)(this,jA,null),(0,h.A)(this,zA,null),(0,h.A)(this,"onSubmit",(async e=>{if(e.preventDefault(),e.persist(),!this.props.canSubmit)return;if(await this.verifyFieldsBeforeSubmit())if(""===this.state.email){if(!this.showEmail())return void this.doSubmit(e);A.Ay.createDialog(DA,{onFinished:async(t,n)=>{t&&void 0!==n&&this.setState({email:n},(()=>{this.doSubmit(e)}))}})}else this.doSubmit(e)})),(0,h.A)(this,"onEmailChange",(e=>{this.setState({email:e.target.value.trim()})})),(0,h.A)(this,"onEmailValidate",(e=>{this.markFieldValid(WA.Email,!!e.valid)})),(0,h.A)(this,"validateEmailRules",(0,Ip.A)({hideDescriptionIfValid:!0,rules:[{key:"required",test({value:e,allowEmpty:t}){return t||!this.authStepIsRequired("m.login.email.identity")||!!e},invalid:()=>(0,P._t)("auth|email_field_label_required")},{key:"email",test:({value:e})=>!e||jb.X(e),invalid:()=>(0,P._t)("auth|email_field_label_invalid")}]})),(0,h.A)(this,"onPasswordChange",(e=>{this.setState({password:e.target.value})})),(0,h.A)(this,"onPasswordValidate",(e=>{this.markFieldValid(WA.Password,!!e.valid)})),(0,h.A)(this,"onPasswordConfirmChange",(e=>{this.setState({passwordConfirm:e.target.value})})),(0,h.A)(this,"onPasswordConfirmValidate",(e=>{this.markFieldValid(WA.PasswordConfirm,!!e.valid)})),(0,h.A)(this,"onPhoneCountryChange",(e=>{this.setState({phoneCountry:e.iso2})})),(0,h.A)(this,"onPhoneNumberChange",(e=>{this.setState({phoneNumber:e.target.value})})),(0,h.A)(this,"onPhoneNumberValidate",(async e=>{const t=await this.validatePhoneNumberRules(e);return this.markFieldValid(WA.PhoneNumber,!!t.valid),t})),(0,h.A)(this,"validatePhoneNumberRules",(0,Ip.A)({description:()=>(0,P._t)("auth|msisdn_field_description"),hideDescriptionIfValid:!0,rules:[{key:"required",test({value:e,allowEmpty:t}){return t||!this.authStepIsRequired("m.login.msisdn")||!!e},invalid:()=>(0,P._t)("auth|registration_msisdn_field_required_invalid")},{key:"email",test:({value:e})=>{return!e||(t=e,kA.test(t));var t},invalid:()=>(0,P._t)("auth|msisdn_field_number_invalid")}]})),(0,h.A)(this,"onUsernameChange",(e=>{this.setState({username:e.target.value})})),(0,h.A)(this,"onUsernameValidate",(async e=>{const t=await this.validateUsernameRules(e);return this.markFieldValid(WA.Username,!!t.valid),t})),(0,h.A)(this,"validateUsernameRules",(0,Ip.A)({description:(e,t)=>t.every((({key:e,valid:t})=>"available"===e||t))?null:(0,P._t)("auth|registration_username_validation"),hideDescriptionIfValid:!0,async deriveData({value:e}){if(!e)return HA.Unknown;try{return await this.props.matrixClient.isUsernameAvailable(e)?HA.Available:HA.Unavailable}catch(e){return e instanceof i.MatrixError&&"M_INVALID_USERNAME"===e.errcode?HA.Invalid:HA.Error}},rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,P._t)("auth|username_field_required_invalid")},{key:"safeLocalpart",test:({value:e},t)=>(!e||Y.test(e))&&t!==HA.Invalid,invalid:()=>(0,P._t)("room_settings|general|alias_field_safe_localpart_invalid")},{key:"available",final:!0,test:async({value:e},t)=>!e||t===HA.Available,invalid:e=>e===HA.Error?(0,P._t)("auth|registration_username_unable_check"):(0,P._t)("auth|registration_username_in_use")}]})),this.state={fieldValid:{},phoneCountry:this.props.defaultPhoneCountry,username:this.props.defaultUsername||"",email:this.props.defaultEmail||"",phoneNumber:this.props.defaultPhoneNumber||"",password:this.props.defaultPassword||"",passwordConfirm:this.props.defaultPassword||""}}doSubmit(e){hu.Vo.instance.setAuthenticationType("Password");const t=this.state.email.trim(),n=this.props.onRegisterClick({username:this.state.username.trim(),password:this.state.password.trim(),email:t,phoneCountry:this.state.phoneCountry,phoneNumber:this.state.phoneNumber});n&&(e.target.disabled=!0,n.finally((function(){e.target.disabled=!1})))}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[WA.Username,WA.Password,WA.PasswordConfirm,WA.Email,WA.PhoneNumber];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise((e=>this.setState({},e))),this.allFieldsValid())return!0;const n=this.findFirstInvalidField(t);return!n||(n.focus(),n.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){return Object.values(this.state.fieldValid).every(Boolean)}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}markFieldValid(e,t){const{fieldValid:n}=this.state;n[e]=t,this.setState({fieldValid:n})}authStepIsRequired(e){return this.props.flows.every((t=>t.stages.includes(e)))}authStepIsUsed(e){return this.props.flows.some((t=>t.stages.includes(e)))}showEmail(){return!(u.Ay.get().disable_3pid_login||!this.authStepIsUsed("m.login.email.identity"))}showPhoneNumber(){return!(u.Ay.get().disable_3pid_login||!this.authStepIsUsed("m.login.msisdn"))}tooltipAlignment(){if(this.props.mobileRegister)return"bottom"}renderEmail(){if(!this.showEmail())return null;const e=this.authStepIsRequired("m.login.email.identity")?(0,P.AO)("auth|email_field_label"):(0,P.AO)("auth|registration|continue_without_email_field_label");return s.createElement(NA,{fieldRef:e=>this[WA.Email]=e,label:e,value:this.state.email,validationRules:this.validateEmailRules.bind(this),onChange:this.onEmailChange,onValidate:this.onEmailValidate,tooltipAlignment:this.tooltipAlignment()})}renderPassword(){return s.createElement(xA.A,{id:"mx_RegistrationForm_password",fieldRef:e=>this[WA.Password]=e,minScore:3,value:this.state.password,onChange:this.onPasswordChange,onValidate:this.onPasswordValidate,userInputs:[this.state.username],tooltipAlignment:this.tooltipAlignment()})}renderPasswordConfirm(){return s.createElement(FA.A,{id:"mx_RegistrationForm_passwordConfirm",fieldRef:e=>this[WA.PasswordConfirm]=e,autoComplete:"new-password",value:this.state.passwordConfirm,password:this.state.password,onChange:this.onPasswordConfirmChange,onValidate:this.onPasswordConfirmValidate,tooltipAlignment:this.tooltipAlignment()})}renderPhoneNumber(){if(!this.showPhoneNumber())return null;const e=this.authStepIsRequired("m.login.msisdn")?(0,P._t)("auth|phone_label"):(0,P._t)("auth|phone_optional_label"),t=s.createElement(LA,{value:this.state.phoneCountry,isSmall:!0,showPrefix:!0,onOptionChange:this.onPhoneCountryChange});return s.createElement(Sa.A,{ref:e=>this[WA.PhoneNumber]=e,type:"text",label:e,value:this.state.phoneNumber,prefixComponent:t,onChange:this.onPhoneNumberChange,onValidate:this.onPhoneNumberValidate})}renderUsername(){return s.createElement(Sa.A,{id:"mx_RegistrationForm_username",ref:e=>this[WA.Username]=e,type:"text",autoFocus:!0,label:(0,P._t)("common|username"),placeholder:(0,P._t)("common|username"),value:this.state.username,onChange:this.onUsernameChange,onValidate:this.onUsernameValidate,tooltipAlignment:this.tooltipAlignment(),autoCorrect:"off",autoCapitalize:"none"})}render(){const e=s.createElement("input",{className:"mx_Login_submit",type:"submit",value:(0,P._t)("action|register"),disabled:!this.props.canSubmit});let t,n;return this.showEmail()&&(t=this.showPhoneNumber()?s.createElement("div",null,(0,P._t)("auth|email_help_text")," ",(0,P._t)("auth|email_phone_discovery_text")):s.createElement("div",null,(0,P._t)("auth|email_help_text")," ",(0,P._t)("auth|email_discovery_text"))),n=this.props.mobileRegister?s.createElement(s.Fragment,null,s.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderPassword()),s.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderPasswordConfirm())):s.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderPassword(),this.renderPasswordConfirm()),s.createElement("div",null,s.createElement("form",{onSubmit:this.onSubmit},s.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderEmail(),this.renderPhoneNumber()),n,e))}}(0,h.A)(GA,"defaultProps",{onValidationChange:o.v.error,canSubmit:!0});var KA=n("./src/components/views/dialogs/InteractiveAuthDialog.tsx");function JA(e){const t=e.getIdentityServerUrl(!0);if(!t)throw new P.P7("settings|general|identity_server_not_set");return t}class qA{constructor(e){(0,h.A)(this,"sessionId",void 0),(0,h.A)(this,"submitUrl",void 0),(0,h.A)(this,"bind",!1),(0,h.A)(this,"clientSecret",void 0),(0,h.A)(this,"makeAddThreepidOnlyRequest",(e=>this.matrixClient.addThreePidOnly({sid:this.sessionId,client_secret:this.clientSecret,auth:null!=e?e:void 0}))),this.matrixClient=e,this.clientSecret=e.generateClientSecret()}async addEmailAddress(e){try{const t=await this.matrixClient.requestAdd3pidEmailToken(e,this.clientSecret,1);return this.sessionId=t.sid,t}catch(e){if(e instanceof i.MatrixError&&"M_THREEPID_IN_USE"===e.errcode)throw new P.P7("settings|general|email_address_in_use",{cause:e});throw e}}async bindEmailAddress(e){var t;this.bind=!0;const n=new X_.A,r=null!==(t=await n.getAccessToken())&&void 0!==t?t:void 0;try{const t=await this.matrixClient.requestEmailToken(e,this.clientSecret,1,void 0,r);return this.sessionId=t.sid,t}catch(e){if(e instanceof i.MatrixError&&"M_THREEPID_IN_USE"===e.errcode)throw new P.P7("settings|general|email_address_in_use",{cause:e});throw e}}async addMsisdn(e,t){try{const n=await this.matrixClient.requestAdd3pidMsisdnToken(e,t,this.clientSecret,1);return this.sessionId=n.sid,this.submitUrl=n.submit_url,n}catch(e){if(e instanceof i.MatrixError&&"M_THREEPID_IN_USE"===e.errcode)throw new P.P7("settings|general|msisdn_in_use",{cause:e});throw e}}async bindMsisdn(e,t){var n;this.bind=!0;const r=new X_.A,s=null!==(n=await r.getAccessToken())&&void 0!==n?n:void 0;try{const n=await this.matrixClient.requestMsisdnToken(e,t,this.clientSecret,1,void 0,s);return this.sessionId=n.sid,n}catch(e){if(e instanceof i.MatrixError&&"M_THREEPID_IN_USE"===e.errcode)throw new P.P7("settings|general|msisdn_in_use",{cause:e});throw e}}async checkEmailLinkClicked(){try{if(this.bind){const e=new X_.A,t=await e.getAccessToken();if(!t)throw new P.P7("settings|general|identity_server_no_token");await this.matrixClient.bindThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:JA(this.matrixClient),id_access_token:t})}else try{return await this.makeAddThreepidOnlyRequest(),[!0]}catch(t){var e;if(!(t instanceof i.MatrixError&&401===t.httpStatus&&null!==(e=t.data)&&void 0!==e&&e.flows))throw t;const n={[AA.av.PHASE_PREAUTH]:{title:(0,P._t)("auth|uia|sso_title"),body:(0,P._t)("auth|uia|sso_body"),continueText:(0,P._t)("auth|sso"),continueKind:"primary"},[AA.av.PHASE_POSTAUTH]:{title:(0,P._t)("settings|general|confirm_adding_email_title"),body:(0,P._t)("settings|general|confirm_adding_email_body"),continueText:(0,P._t)("action|confirm"),continueKind:"primary"}},{finished:r}=A.Ay.createDialog(KA.A,{title:(0,P._t)("settings|general|add_email_dialog_title"),matrixClient:this.matrixClient,authData:t.data,makeRequest:this.makeAddThreepidOnlyRequest,aestheticsForStagePhases:{[AA.av.LOGIN_TYPE]:n,[AA.av.UNSTABLE_LOGIN_TYPE]:n}});return r}}catch(e){if(e instanceof i.HTTPError&&401===e.httpStatus)throw new P.P7("settings|general|add_email_failed_verification",{cause:e});throw e}return[]}async haveMsisdnToken(e){const t=new X_.A;if(this.submitUrl)await this.matrixClient.submitMsisdnTokenOtherUrl(this.submitUrl,this.sessionId,this.clientSecret,e);else{if(!this.bind)throw new P.P7("settings|general|add_msisdn_misconfigured");await this.matrixClient.submitMsisdnToken(this.sessionId,this.clientSecret,e,await t.getAccessToken())}if(this.bind)return await this.matrixClient.bindThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:JA(this.matrixClient),id_access_token:await t.getAccessToken()}),[!0];try{return await this.makeAddThreepidOnlyRequest(),[!0]}catch(e){var n;if(!(e instanceof i.MatrixError&&401===e.httpStatus&&null!==(n=e.data)&&void 0!==n&&n.flows))throw e;const t={[AA.av.PHASE_PREAUTH]:{title:(0,P._t)("auth|uia|sso_title"),body:(0,P._t)("settings|general|add_msisdn_confirm_sso_button"),continueText:(0,P._t)("auth|sso"),continueKind:"primary"},[AA.av.PHASE_POSTAUTH]:{title:(0,P._t)("settings|general|add_msisdn_confirm_button"),body:(0,P._t)("settings|general|add_msisdn_confirm_body"),continueText:(0,P._t)("action|confirm"),continueKind:"primary"}},{finished:r}=A.Ay.createDialog(KA.A,{title:(0,P._t)("settings|general|add_msisdn_dialog_title"),matrixClient:this.matrixClient,authData:e.data,makeRequest:this.makeAddThreepidOnlyRequest,aestheticsForStagePhases:{[AA.av.LOGIN_TYPE]:t,[AA.av.UNSTABLE_LOGIN_TYPE]:t}});return r}}}var $A=function(e){return e.Display="display",e.Edit="edit",e}($A||{});class YA extends s.Component{constructor(e){super(e),(0,h.A)(this,"value",""),(0,h.A)(this,"placeholder",!1),(0,h.A)(this,"editableDiv",(0,s.createRef)()),(0,h.A)(this,"showPlaceholder",(e=>{this.editableDiv.current&&(e?(this.editableDiv.current.textContent=this.props.placeholder,this.editableDiv.current.setAttribute("class",this.props.className+" "+this.props.placeholderClassName),this.placeholder=!0,this.value=""):(this.editableDiv.current.textContent=this.value,this.editableDiv.current.setAttribute("class",this.props.className),this.placeholder=!1))})),(0,h.A)(this,"cancelEdit",(()=>{var e;this.setState({phase:$A.Display}),this.value=this.props.initialValue,this.showPlaceholder(!this.value),this.onValueChanged(!1),null===(e=this.editableDiv.current)||void 0===e||e.blur()})),(0,h.A)(this,"onValueChanged",(e=>{var t,n;null===(t=(n=this.props).onValueChanged)||void 0===t||t.call(n,this.value,e)})),(0,h.A)(this,"onKeyDown",(e=>{this.placeholder&&this.showPlaceholder(!1);if((0,Re.zM)().getAccessibilityAction(e)===Se.bY.Enter)e.stopPropagation(),e.preventDefault()})),(0,h.A)(this,"onKeyUp",(e=>{if(e.target.textContent){if(!this.placeholder){var t;this.value=null!==(t=e.target.textContent)&&void 0!==t?t:""}}else this.showPlaceholder(!0);switch((0,Re.zM)().getAccessibilityAction(e)){case Se.bY.Escape:this.cancelEdit();break;case Se.bY.Enter:this.onFinish(e)}})),(0,h.A)(this,"onClickDiv",(()=>{this.props.editable&&this.setState({phase:$A.Edit})})),(0,h.A)(this,"onFocus",(e=>{const t=e.target.childNodes[0];if(t){const n=document.createRange();n.setStart(t,0),n.setEnd(t,e.target.childNodes.length);const i=window.getSelection();i.removeAllRanges(),i.addRange(n)}})),(0,h.A)(this,"onFinish",((e,t=!1)=>{const n=this,i=(0,Re.zM)().getAccessibilityAction(e)===Se.bY.Enter||t;this.setState({phase:$A.Display},(()=>{this.value!==this.props.initialValue&&n.onValueChanged(i)}))})),(0,h.A)(this,"onBlur",(e=>{window.getSelection().removeAllRanges(),this.props.blurToCancel?this.cancelEdit():this.onFinish(e,this.props.blurToSubmit),this.showPlaceholder(!this.value)})),this.state={phase:$A.Display}}componentDidUpdate(e){e.initialValue!==this.props.initialValue&&(this.value=this.props.initialValue,this.editableDiv.current&&this.showPlaceholder(!this.value))}componentDidMount(){this.value=this.props.initialValue,this.editableDiv.current&&this.showPlaceholder(!this.value)}render(){const{className:e,editable:t,initialValue:n,label:i,labelClassName:r}=this.props;let o;return o=!t||this.state.phase===$A.Display&&(i||r)&&!this.value?s.createElement("div",{className:e+" "+r,onClick:this.onClickDiv},i||n):s.createElement("div",{ref:this.editableDiv,contentEditable:!0,className:e,onKeyDown:this.onKeyDown,onKeyUp:this.onKeyUp,onFocus:this.onFocus,onBlur:this.onBlur}),o}}(0,h.A)(YA,"defaultProps",{onValueChanged(){},initialValue:"",label:"",placeholder:"",editable:!0,className:"mx_EditableText",placeholderClassName:"mx_EditableText_placeholder",blurToSubmit:!1});class ZA extends s.Component{constructor(e){super(e),(0,h.A)(this,"addThreepid",void 0),(0,h.A)(this,"onEmailAddressChanged",(e=>{this.setState({emailAddress:e})})),(0,h.A)(this,"onSubmit",(()=>{const e=this.state.emailAddress;jb.X(e)?(this.addThreepid=new qA(E.J.safeGet()),this.addThreepid.addEmailAddress(e).then((()=>{A.Ay.createDialog(q.A,{title:(0,P._t)("auth|set_email|verification_pending_title"),description:(0,P._t)("auth|set_email|verification_pending_description"),button:(0,P._t)("action|continue"),onFinished:this.onEmailDialogFinished})}),(t=>{this.setState({emailBusy:!1}),o.v.error("Unable to add email address "+e+" "+t),A.Ay.createDialog(_v.A,{title:(0,P._t)("settings|general|error_add_email"),description:(0,_v.$)(t,(0,P._t)("invite|failed_generic"))})})),this.setState({emailBusy:!0})):A.Ay.createDialog(_v.A,{title:(0,P._t)("settings|general|error_invalid_email"),description:(0,P._t)("settings|general|error_invalid_email_detail")})})),(0,h.A)(this,"onCancelled",(()=>{this.props.onFinished(!1)})),(0,h.A)(this,"onEmailDialogFinished",(e=>{e?this.verifyEmailAddress():this.setState({emailBusy:!1})})),this.state={emailAddress:"",emailBusy:!1}}verifyEmailAddress(){var e;null===(e=this.addThreepid)||void 0===e||e.checkEmailLinkClicked().then((()=>{this.props.onFinished(!0)}),(e=>{this.setState({emailBusy:!1});let t=e;if(e instanceof P.P7&&(t=e.cause),t instanceof i.MatrixError&&"M_THREEPID_AUTH_FAILED"===t.errcode){const e=(0,P._t)("settings|general|error_email_verification")+" "+(0,P._t)("auth|set_email|verification_pending_description");A.Ay.createDialog(q.A,{title:(0,P._t)("auth|set_email|verification_pending_title"),description:e,button:(0,P._t)("action|continue"),onFinished:this.onEmailDialogFinished})}else o.v.error("Unable to verify email address: "+e),A.Ay.createDialog(_v.A,{title:(0,P._t)("settings|general|error_email_verification"),description:(0,_v.$)(e,(0,P._t)("invite|failed_generic"))})}))}render(){const e=this.state.emailBusy?s.createElement(Na.A,null):s.createElement(YA,{initialValue:this.state.emailAddress,className:"mx_SetEmailDialog_email_input",placeholder:(0,P._t)("common|email_address"),placeholderClassName:"mx_SetEmailDialog_email_input_placeholder",blurToCancel:!1,onValueChanged:this.onEmailAddressChanged});return s.createElement(Pa.A,{className:"mx_SetEmailDialog",onFinished:this.onCancelled,title:this.props.title,contentId:"mx_Dialog_content"},s.createElement("div",{className:"mx_Dialog_content"},s.createElement("p",{id:"mx_Dialog_content"},(0,P._t)("auth|set_email|description")),e),s.createElement("div",{className:"mx_Dialog_buttons"},s.createElement("input",{className:"mx_Dialog_primary",type:"submit",value:(0,P._t)("action|continue"),onClick:this.onSubmit}),s.createElement("input",{type:"submit",value:(0,P._t)("action|skip"),onClick:this.onCancelled})))}}const XA="field_old_password",QA="field_new_password",eC="field_new_password_confirm";var tC=function(e){return e.Edit="edit",e.Uploading="uploading",e.Error="error",e}(tC||{});class nC extends s.Component{constructor(e){super(e),(0,h.A)(this,XA,null),(0,h.A)(this,QA,null),(0,h.A)(this,eC,null),(0,h.A)(this,"onChangeOldPassword",(e=>{this.setState({oldPassword:e.target.value})})),(0,h.A)(this,"onOldPasswordValidate",(async e=>{const t=await this.validateOldPasswordRules(e);return this.markFieldValid(XA,t.valid),t})),(0,h.A)(this,"validateOldPasswordRules",(0,Ip.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,P._t)("auth|change_password_empty")}]})),(0,h.A)(this,"onChangeNewPassword",(e=>{this.setState({newPassword:e.target.value})})),(0,h.A)(this,"onNewPasswordValidate",(e=>{this.markFieldValid(QA,e.valid)})),(0,h.A)(this,"onChangeNewPasswordConfirm",(e=>{this.setState({newPasswordConfirm:e.target.value})})),(0,h.A)(this,"onNewPasswordConfirmValidate",(async e=>{const t=await this.validatePasswordConfirmRules(e);return this.markFieldValid(eC,t.valid),t})),(0,h.A)(this,"validatePasswordConfirmRules",(0,Ip.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,P._t)("auth|change_password_confirm_label")},{key:"match",test({value:e}){return!e||e===this.state.newPassword},invalid:()=>(0,P._t)("auth|change_password_confirm_invalid")}]})),(0,h.A)(this,"onClickChange",(async e=>{e.preventDefault();if(!await this.verifyFieldsBeforeSubmit())return;const t=this.state.oldPassword,n=this.state.newPassword,i=this.state.newPasswordConfirm;try{return this.checkPassword(t,n,i),this.onChangePassword(t,n)}catch(e){e instanceof Error?this.props.onError(e):this.props.onError(new P.P7("auth|change_password_error",{error:String(e),cause:void 0}))}})),this.state={fieldValid:{},phase:tC.Edit,oldPassword:"",newPassword:"",newPasswordConfirm:""}}async onChangePassword(e,t){const n=E.J.safeGet();this.changePassword(n,e,t)}changePassword(e,t,n){const i={type:"m.login.password",identifier:{type:"m.id.user",user:e.credentials.userId},password:t};this.setState({phase:tC.Uploading}),e.setPassword(i,n,!1).then((()=>{if(this.props.shouldAskForEmail)return this.optionallySetEmail().then((e=>{this.props.onFinished({didSetEmail:e})}));this.props.onFinished({})}),(e=>{e instanceof Error?this.props.onError(e):this.props.onError(new P.P7("auth|change_password_error",{error:String(e),cause:void 0}))})).finally((()=>{this.setState({phase:tC.Edit,oldPassword:"",newPassword:"",newPasswordConfirm:""})}))}checkPassword(e,t,n){if(t!==n)throw new P.P7("auth|change_password_mismatch");if(!t||0===t.length)throw new P.P7("auth|change_password_empty")}optionallySetEmail(){return A.Ay.createDialog(ZA,{title:(0,P._t)("auth|set_email_prompt")}).finished.then((([e])=>!!e))}markFieldValid(e,t){const{fieldValid:n}=this.state;n[e]=t,this.setState({fieldValid:n})}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[XA,QA,eC];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise((e=>this.setState({},e))),this.allFieldsValid())return!0;const n=this.findFirstInvalidField(t);return!n||(n.focus(),n.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){return Object.values(this.state.fieldValid).every(Boolean)}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}render(){const e=this.props.rowClassName,t=this.props.buttonClassName;switch(this.state.phase){case tC.Edit:return s.createElement("form",{className:this.props.className,onSubmit:this.onClickChange},s.createElement("div",{className:e},s.createElement(Sa.A,{ref:e=>this[XA]=e,type:"password",label:(0,P._t)("auth|change_password_current_label"),value:this.state.oldPassword,onChange:this.onChangeOldPassword,onValidate:this.onOldPasswordValidate})),s.createElement("div",{className:e},s.createElement(xA.A,{fieldRef:e=>this[QA]=e,type:"password",label:(0,P.AO)("auth|change_password_new_label"),minScore:3,value:this.state.newPassword,autoFocus:this.props.autoFocusNewPasswordInput,onChange:this.onChangeNewPassword,onValidate:this.onNewPasswordValidate,autoComplete:"new-password"})),s.createElement("div",{className:e},s.createElement(Sa.A,{ref:e=>this[eC]=e,type:"password",label:(0,P._t)("auth|change_password_confirm_label"),value:this.state.newPasswordConfirm,onChange:this.onChangeNewPasswordConfirm,onValidate:this.onNewPasswordConfirmValidate,autoComplete:"new-password"})),s.createElement(Ae.A,{className:t,kind:this.props.buttonKind,onClick:this.onClickChange},this.props.buttonLabel||(0,P._t)("auth|change_password_action")));case tC.Uploading:return s.createElement("div",{className:"mx_Dialog_content"},s.createElement(Na.A,null))}}}(0,h.A)(nC,"defaultProps",{onFinished(){},onError(){},confirm:!0});var iC=n("./src/components/views/settings/tabs/SettingsTab.tsx"),rC=n("./src/components/views/settings/shared/SettingsSection.tsx"),sC=n("./src/components/views/settings/shared/SettingsSubsection.tsx"),oC=n("./src/tchap/util/TchapUtils.ts"),aC=n("./src/components/views/elements/ToggleSwitch.tsx");const lC=()=>{const[e,t]=(0,s.useState)(!1),[n,i]=(0,s.useState)(!1);(0,s.useEffect)((()=>{(async()=>{const e=await oC.A.getUserRedListInfo();console.log("initialRedListValue",e),t(e)})()}),[]);return s.createElement(sC.P,{heading:(0,P._t)("settings|general|redlist"),stretchContent:!0},s.createElement("div",{className:"mx_SettingsFlag"},s.createElement("label",{className:"mx_SettingsFlag_label",htmlFor:"redList-toggle"},s.createElement("span",{className:"mx_SettingsFlag_labelText"},(0,P._t)("settings|general|redlist_title")),s.createElement("div",{className:"mx_SettingsFlag_microcopy"},(0,P._t)("settings|general|redlist_description"))),s.createElement(aC.A,{id:"redList-toggle",checked:e,onChange:e=>(async e=>{try{n||(i(!0),await oC.A.setUserRedListInfo(e),t(e)),i(!1)}catch(n){console.error("Error setting AccountData 'im.vector.hide_profile': "+n),t(!e),i(!1)}})(e),disabled:n,title:(0,P._t)("settings|general|redlist_title")})))},cC=({canChangePassword:e,onPasswordChangeError:t,onPasswordChanged:n})=>e?s.createElement(s.Fragment,null,s.createElement(sC.P,{heading:(0,P._t)("settings|general|account_section"),stretchContent:!0},s.createElement(sC.s,null,(0,P._t)("settings|general|password_change_section")),s.createElement(nC,{rowClassName:"",buttonKind:"primary",onError:t,onFinished:n}))):s.createElement(s.Fragment,null),dC=({onDeactivateClicked:e})=>s.createElement(rC.X,{heading:(0,P._t)("settings|general|deactivate_section")},s.createElement(sC.P,{heading:(0,P._t)("settings|general|account_management_section"),description:(0,P._t)("settings|general|deactivate_warning")},s.createElement(Ae.A,{onClick:e,kind:"danger"},(0,P._t)("settings|general|deactivate_section")))),uC=({closeSettingsFn:e})=>{const[t,n]=s.useState(),[r,a]=s.useState(!1),[l,c]=s.useState(!1),[d,u]=s.useState(!1),[m,p]=s.useState(!1),h=(0,Pe.nH)(),g=(0,s.useContext)(Wa.A);(0,s.useEffect)((()=>{(async e=>{const t=null!==(e=await h.getCapabilities())&&void 0!==e?e:{},i=t["m.change_password"],r=!i||!1!==i.enabled;await g.oidcClientStore.readyPromise;const s=g.oidcClientStore.accountManagementEndpoint,o=!t["m.3pid_changes"]||!0===t["m.3pid_changes"].enabled,l=!t["m.set_displayname"]||!0===t["m.set_displayname"].enabled,d=!t["m.set_avatar_url"]||!0===t["m.set_avatar_url"].enabled;a(o),c(l),u(d),n(s),p(r)})()}),[h,g.oidcClientStore]);const v=(0,s.useCallback)((e=>{o.v.error("Failed to change password: "+e);let t=e;e instanceof P.P7&&e.cause instanceof Error&&(t=e.cause);const n=(0,_v.$)(e,(0,P._t)("settings|general|error_password_change_unknown",{stringifiedError:String(e)}));let r=n;t instanceof i.HTTPError&&403===t.httpStatus?r=(0,P._t)("settings|general|error_password_change_403"):t instanceof i.HTTPError&&(r=(0,P._t)("settings|general|error_password_change_http",{errorMessage:n,httpStatus:t.httpStatus})),A.Ay.createDialog(_v.A,{title:(0,P._t)("settings|general|error_password_change_title"),description:r})}),[]),f=(0,s.useCallback)((()=>{const e=(0,P._t)("settings|general|password_change_success");A.Ay.createDialog(_v.A,{title:(0,P._t)("common|success"),description:e})}),[]),_=(0,s.useCallback)((()=>{A.Ay.createDialog(CA,{onFinished:t=>{t&&e()}})}),[e]);let y;const b=Boolean(t);return V.A.getValue($.f.Deactivate)&&!b&&(y=s.createElement(dC,{onDeactivateClicked:_})),s.createElement(iC.A,null,s.createElement(rC.X,null,s.createElement(wA,{externalAccountManagementUrl:t,canSetDisplayName:l,canSetAvatar:d}),s.createElement(cC,{canChangePassword:m,onPasswordChanged:f,onPasswordChangeError:v}),s.createElement(lC,null)),y)};var mC=n("./src/components/views/elements/SettingsFlag.tsx"),pC=n("./src/utils/maps.ts");const hC=()=>u.Ay.get("show_labs_settings")||V.A.getValue("developerMode");class gC extends s.Component{constructor(e){super(e),(0,h.A)(this,"labs",void 0),(0,h.A)(this,"betas",void 0);const t=V.A.getFeatureSettingNames(),[n,i]=t.reduce(((e,t)=>(e[V.A.getBetaInfo(t)?1:0].push(t),e)),[[],[]]);this.labs=n,this.betas=i,hC()||(this.labs=[])}render(){let e,t;if(this.betas.length&&(e=s.createElement(s.Fragment,null,this.betas.map((e=>s.createElement(Ue.A,{key:e,featureId:e}))))),this.labs.length){const e=new pC.h;this.labs.forEach((t=>{e.getOrCreate(V.A.getLabGroup(t),[]).push(s.createElement(mC.A,{level:ae.p.DEVICE,name:t,key:t}))})),e.getOrCreate(Nl.$q.Experimental,[]).push(s.createElement(mC.A,{key:"lowBandwidth",name:"lowBandwidth",level:ae.p.DEVICE})),e.getOrCreate(Nl.$q.Analytics,[]).push(s.createElement(mC.A,{key:"automaticErrorReporting",name:"automaticErrorReporting",level:ae.p.DEVICE}),s.createElement(mC.A,{key:"automaticDecryptionErrorReporting",name:"automaticDecryptionErrorReporting",level:ae.p.DEVICE})),t=s.createElement(s.Fragment,null,(0,v.sortBy)(Array.from(e.entries()),"0").map((([e,t])=>s.createElement(sC.P,{key:e,heading:(0,P._t)(Nl.B2[e])},t))))}return s.createElement(iC.A,null,s.createElement(rC.X,{heading:(0,P._t)("labs|beta_section")},s.createElement(sC.s,null,(0,P._t)("labs|beta_description",{brand:u.Ay.get("brand")})),e),t&&s.createElement(rC.X,{heading:(0,P._t)("labs|experimental_section")},s.createElement(sC.s,null,(0,P._t)("labs|experimental_description",{},{a:e=>s.createElement("a",{href:"https://github.com/vector-im/element-web/blob/develop/docs/labs.md",rel:"noreferrer noopener",target:"_blank"},e)})),t))}}const vC="_container_1vw5h_18",fC="_input_1vw5h_26",_C="_ui_1vw5h_27",yC=["className"];function bC(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function EC(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?bC(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):bC(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const wC=(0,s.forwardRef)((function(e,t){let{className:n}=e,i=(0,Ve.A)(e,yC);const r=ie(vC,n);return(0,dl.jsxs)("div",{className:r,children:[(0,dl.jsx)("input",EC(EC({ref:t},i),{},{className:fC,type:"radio"})),(0,dl.jsx)("div",{className:_C})]})})),SC=(0,s.forwardRef)((function(e,t){return(0,dl.jsx)(dm,{asChild:!0,children:(0,dl.jsx)(wC,EC({ref:t},e))})})),AC=["className","control","children"];function CC(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function xC(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?CC(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):CC(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const kC=(0,s.forwardRef)((function(e,t){let{className:n,control:i,children:r}=e,s=(0,Ve.A)(e,AC);const o=ie(vm,n);return(0,dl.jsxs)(lm,xC(xC({ref:t},s),{},{className:o,children:[(0,dl.jsx)("div",{className:_m,children:i}),(0,dl.jsx)("div",{className:fm,children:r})]}))}));class RC extends s.Component{constructor(e){super(e),this.state={message:e.message}}fakeEvent({message:e}){const t={type:"m.room.message",sender:this.props.userId,content:{"m.new_content":{msgtype:i.MsgType.Text,body:e,displayname:this.props.displayName,avatar_url:this.props.avatarUrl},msgtype:i.MsgType.Text,body:e,displayname:this.props.displayName,avatar_url:this.props.avatarUrl},unsigned:{age:97},event_id:"$9999999999999999999999999999999999999999999",room_id:"!999999999999999999:example.org"},n=new i.MatrixEvent(t);return n.sender={name:this.props.displayName||this.props.userId,rawDisplayName:this.props.displayName,userId:this.props.userId,getAvatarUrl:(...e)=>Rh.r4({avatarUrl:this.props.avatarUrl},32,32,"crop"),getMxcAvatarUrl:()=>this.props.avatarUrl},n}render(){const e=re()(this.props.className,{mx_IRCLayout:this.props.layout==zp.P.IRC,mx_EventTilePreview_loader:!this.props.userId});if(!this.props.userId)return s.createElement("div",{className:e},s.createElement(Na.A,null));const t=this.fakeEvent(this.state);return s.createElement("div",{className:e,role:"presentation"},s.createElement(Wp.Ay,{mxEvent:t,layout:this.props.layout,as:"div",hideTimestamp:!0,inhibitInteraction:!0}))}}function IC(){return s.createElement(sC.P,{heading:(0,P._t)("common|message_layout"),legacy:!1},s.createElement(TC,null),s.createElement(NC,null))}function TC(){return s.createElement(km,{className:"mx_LayoutSwitcher_LayoutSelector",onChange:async e=>{const t=new FormData(e.currentTarget).get("layout");await V.A.setValue("layout",null,ae.p.DEVICE,t)}},s.createElement(PC,{layout:zp.P.Group,label:(0,P._t)("common|modern")}),s.createElement(PC,{layout:zp.P.Bubble,label:(0,P._t)("settings|appearance|layout_bubbles")}),s.createElement(PC,{layout:zp.P.IRC,label:(0,P._t)("settings|appearance|layout_irc")}))}function PC({layout:e,label:t}){const n=(0,Oe.ti)("layout"),i=function(){const e=(0,Pe.nH)(),t=e.getSafeUserId(),[n,i]=(0,s.useState)({userId:t});return(0,s.useEffect)((()=>{(async()=>{const n=await e.getProfileInfo(t);i({userId:t,displayName:n.displayname,avatarUrl:n.avatar_url})})()}),[t,e,i]),n}();return s.createElement(Om,{name:"layout",className:"mxLayoutSwitcher_LayoutSelector_LayoutRadio"},s.createElement(Bm,{"aria-label":t},s.createElement("div",{className:"mxLayoutSwitcher_LayoutSelector_LayoutRadio_inline"},s.createElement(SC,{name:"layout",value:e,defaultChecked:n===e}),s.createElement("span",null,t)),s.createElement("hr",{className:"mxLayoutSwitcher_LayoutSelector_LayoutRadio_separator"}),s.createElement(RC,(0,p.A)({message:(0,P._t)("common|preview_message"),layout:e,className:"mxLayoutSwitcher_LayoutSelector_LayoutRadio_EventTilePreview"},i))))}function NC(){const e=(0,Oe.ti)("useCompactLayout"),t=(0,Oe.ti)("layout");return s.createElement(km,{onChange:async e=>{const t="on"===new FormData(e.currentTarget).get("compactLayout");await V.A.setValue("useCompactLayout",null,ae.p.DEVICE,t)}},s.createElement(kC,{name:"compactLayout",control:s.createElement(Xm,{disabled:t!==zp.P.Group,name:"compactLayout",defaultChecked:e})},s.createElement(Bm,null,(0,P._t)("settings|appearance|compact_layout")),s.createElement(ZS,null,(0,P._t)("settings|appearance|compact_layout_description"))))}class DC extends s.Component{constructor(e){super(e),(0,h.A)(this,"MESSAGE_PREVIEW_TEXT",(0,P._t)("common|preview_message")),(0,h.A)(this,"sizes",[9,10,11,12,13,14,15,16,17,18,20,22,24,26,28,30,32,34,36]),(0,h.A)(this,"layoutWatcherRef",void 0),(0,h.A)(this,"unmounted",!1),(0,h.A)(this,"onFontSizeChanged",(async e=>{const t=parseInt(e,10)||0;this.setState({fontSizeDelta:t}),await V.A.setValue("fontSizeDelta",null,ae.p.DEVICE,t)})),(0,h.A)(this,"computeDeltaFontSize",(e=>e-this.state.browserFontSize)),this.state={fontSizeDelta:V.A.getValue("fontSizeDelta",null),browserFontSize:ee.g.getBrowserDefaultFontSize(),useCustomFontSize:V.A.getValue("useCustomFontSize"),layout:V.A.getValue("layout")}}async componentDidMount(){this.unmounted=!1;const e=E.J.safeGet(),t=e.getSafeUserId(),n=await e.getProfileInfo(t);this.layoutWatcherRef=V.A.watchSetting("layout",null,(()=>{const e=V.A.getValue("layout");this.state.layout!==e&&this.setState({layout:e})})),this.unmounted||this.setState({userId:t,displayName:n.displayname,avatarUrl:n.avatar_url})}componentWillUnmount(){this.unmounted=!0,V.A.unwatchSetting(this.layoutWatcherRef)}render(){return s.createElement(sC.P,{heading:(0,P._t)("settings|appearance|font_size"),stretchContent:!0},s.createElement(Sa.A,{element:"select",className:"mx_FontScalingPanel_Dropdown",label:(0,P._t)("settings|appearance|font_size"),value:this.state.fontSizeDelta.toString(),onChange:e=>this.onFontSizeChanged(e.target.value)},this.sizes.map((e=>s.createElement("option",{key:e,value:this.computeDeltaFontSize(e)},e===this.state.browserFontSize?(0,P._t)("settings|appearance|font_size_default",{fontSize:e}):e)))),s.createElement(RC,{className:"mx_FontScalingPanel_preview",message:this.MESSAGE_PREVIEW_TEXT,layout:this.state.layout,userId:this.state.userId,displayName:this.state.displayName,avatarUrl:this.state.avatarUrl}))}}function MC(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function OC(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?MC(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):MC(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function LC(){const e=function(){const e=(0,Oe.ti)("theme"),t=(0,Oe.wL)(ae.p.DEVICE,"use_system_theme",null,!1,!0),n=(0,Oe.wL)(ae.p.DEVICE,"theme",null,!1,!0),i=(0,Oe.ti)("use_system_theme");return t?{theme:e,systemThemeActivated:!0}:n?{theme:e,systemThemeActivated:!1}:{theme:e,systemThemeActivated:i}}(),t=(0,s.useRef)(new Q.A),n=(0,Oe.ti)("feature_custom_themes");return s.createElement(sC.P,{heading:(0,P._t)("common|theme"),legacy:!1},t.current.isSystemThemeSupported()&&s.createElement(FC,{systemThemeActivated:e.systemThemeActivated}),s.createElement(UC,{theme:e.theme,disabled:e.systemThemeActivated}),n&&s.createElement(BC,{theme:e.theme}))}function FC({systemThemeActivated:e}){return s.createElement(km,{onChange:async e=>{const t="on"===new FormData(e.currentTarget).get("systemTheme");await V.A.setValue("use_system_theme",null,ae.p.DEVICE,t),w.A.dispatch({action:R.r.RecheckTheme})}},s.createElement(kC,{name:"systemTheme",control:s.createElement(Xm,{name:"systemTheme",defaultChecked:e})},s.createElement(Bm,null,V.A.getDisplayName("use_system_theme"))))}function UC({theme:e,disabled:t}){const n=function(){const e=(0,Oe.ti)("custom_themes");return(0,s.useMemo)((()=>{const t=(e||[]).reduce(((e,t)=>e.set(t.name,t)),new Map),n=(0,Fa.E0)(),i=n.filter((e=>!t.has(e.name))),r=n.filter((e=>t.has(e.name))),s=function(){const e=(0,Fa.TJ)("light");if(e)return{name:(0,P._t)("settings|appearance|high_contrast"),id:e}}();s&&i.push(s);return i.concat(r).map((e=>{const n=t.get(e.name),i=(n?n.is_dark:e.id.includes("dark"))||!1;return OC(OC({},e),{},{isDark:i})}))}),[e])}();return s.createElement(km,{className:"mx_ThemeChoicePanel_ThemeSelectors",onChange:async t=>{const n=new FormData(t.currentTarget).get("themeSelector");n&&e!==n&&(V.A.setValue("theme",null,ae.p.DEVICE,n).catch((()=>{w.A.dispatch({action:R.r.RecheckTheme})})),w.A.dispatch({action:R.r.RecheckTheme,forceTheme:n}))}},n.map((n=>{const i=e===n.id;return s.createElement(kC,{className:re()("mx_ThemeChoicePanel_themeSelector",{mx_ThemeChoicePanel_themeSelector_enabled:!t&&e===n.id,mx_ThemeChoicePanel_themeSelector_disabled:t,"cpd-theme-light":!n.isDark,"cpd-theme-dark":n.isDark}),name:"themeSelector",key:n.id,control:s.createElement(SC,{name:"themeSelector",checked:!t&&i,disabled:t,value:n.id})},s.createElement(Bm,{className:"mx_ThemeChoicePanel_themeSelector_Label"},n.name))})))}function BC({theme:e}){const[t,n]=(0,s.useState)(""),[i,r]=(0,s.useState)(),a=(0,s.useCallback)((()=>{r(void 0),n("")}),[r,n]);return s.createElement("div",{className:"mx_ThemeChoicePanel_CustomTheme"},s.createElement(nA,{className:"mx_ThemeChoicePanel_CustomTheme_EditInPlace",label:(0,P._t)("settings|appearance|custom_theme_add"),cancelButtonLabel:(0,P._t)("action|cancel"),saveButtonLabel:(0,P._t)("settings|appearance|custom_theme_add"),savingLabel:(0,P._t)("settings|appearance|custom_theme_downloading"),value:t,onChange:e=>{r(void 0),n(e.target.value)},onSave:async()=>{if(!t)return;const e=V.A.getValue("custom_themes").map((e=>e))||[];try{const n=await fetch(t),i=await n.json();if(!i||"string"!=typeof i.name||"object"!=typeof i.colors)return void r((0,P._t)("settings|appearance|custom_theme_invalid"));if(Boolean(e.find((e=>e.name===i.name))))return void a();e.push(i)}catch(e){return o.v.error(e),void r((0,P._t)("settings|appearance|custom_theme_error_downloading"))}a(),await V.A.setValue("custom_themes",null,ae.p.ACCOUNT,e)},onCancel:a},s.createElement(ZS,null,(0,P._t)("settings|appearance|custom_theme_help")),i&&s.createElement(qS,null,i)),s.createElement(VC,{theme:e}))}function VC({theme:e}){const t=(0,Oe.ti)("custom_themes")||[];return s.createElement("ul",{className:"mx_ThemeChoicePanel_CustomThemeList"},t.map((t=>s.createElement("li",{key:t.name,className:"mx_ThemeChoicePanel_CustomThemeList_theme","aria-label":t.name},s.createElement("span",{className:"mx_ThemeChoicePanel_CustomThemeList_name"},t.name),s.createElement(Xa.K,{destructive:!0,"aria-label":(0,P._t)("action|delete"),tooltip:(0,P._t)("action|delete"),onClick:async()=>{const n=(V.A.getValue("custom_themes").map((e=>e))||[]).filter((e=>e.name!==t.name));await V.A.setValue("custom_themes",null,ae.p.ACCOUNT,n),e===`custom-${t.name}`&&(await V.A.setValue("theme",null,ae.p.DEVICE,null),w.A.dispatch({action:R.r.RecheckTheme}))}},s.createElement(P_.A,null))))))}var jC=n("./src/components/views/elements/StyledRadioButton.tsx"),zC=n("./src/settings/enums/ImageSize.ts");class WC extends s.Component{constructor(e){super(e),(0,h.A)(this,"onSizeChange",(e=>{const t=e.target.value;this.setState({size:t}),V.A.setValue("Images.size",null,ae.p.ACCOUNT,t)})),this.state={size:V.A.getValue("Images.size")}}render(){return s.createElement(sC.P,{heading:(0,P._t)("settings|appearance|timeline_image_size")},s.createElement("div",{className:"mx_ImageSizePanel_radios"},s.createElement("label",null,s.createElement("div",{className:"mx_ImageSizePanel_size mx_ImageSizePanel_sizeDefault"}),s.createElement(jC.A,{name:"image_size",value:zC.h.Normal,checked:this.state.size===zC.h.Normal,onChange:this.onSizeChange},(0,P._t)("settings|appearance|image_size_default"))),s.createElement("label",null,s.createElement("div",{className:"mx_ImageSizePanel_size mx_ImageSizePanel_sizeLarge"}),s.createElement(jC.A,{name:"image_size",value:zC.h.Large,checked:this.state.size===zC.h.Large,onChange:this.onSizeChange},(0,P._t)("settings|appearance|image_size_large")))))}}class HC extends s.Component{constructor(e){super(e),this.state={useBundledEmojiFont:V.A.getValue("useBundledEmojiFont"),useSystemFont:V.A.getValue("useSystemFont"),systemFont:V.A.getValue("systemFont"),showAdvanced:!1}}renderAdvancedSection(){if(!V.A.getValue($.f.AdvancedSettings))return null;const e=u.Ay.get().brand,t=s.createElement(Ae.A,{kind:"link",onClick:()=>this.setState({showAdvanced:!this.state.showAdvanced}),"aria-expanded":this.state.showAdvanced},this.state.showAdvanced?(0,P._t)("action|hide_advanced"):(0,P._t)("action|show_advanced"));let n;if(this.state.showAdvanced){const t=(0,P._t)("settings|appearance|custom_font_description",{brand:e});n=s.createElement(s.Fragment,null,s.createElement(mC.A,{name:"useCompactLayout",level:ae.p.DEVICE,useCheckbox:!0}),s.createElement(mC.A,{name:"useBundledEmojiFont",level:ae.p.DEVICE,useCheckbox:!0,onChange:e=>this.setState({useBundledEmojiFont:e})}),s.createElement(mC.A,{name:"useSystemFont",level:ae.p.DEVICE,useCheckbox:!0,onChange:e=>this.setState({useSystemFont:e})}),s.createElement(Sa.A,{className:"mx_AppearanceUserSettingsTab_checkboxControlledField",label:V.A.getDisplayName("systemFont"),onChange:e=>{this.setState({systemFont:e.target.value}),V.A.setValue("systemFont",null,ae.p.DEVICE,e.target.value)},tooltipContent:t,forceTooltipVisible:!0,disabled:!this.state.useSystemFont,value:this.state.systemFont}))}return s.createElement(sC.P,null,t,n)}render(){return s.createElement(iC.A,null,s.createElement(rC.X,null,s.createElement(LC,null),s.createElement(IC,null),s.createElement(DC,null),this.renderAdvancedSection(),s.createElement(WC,null)))}}var GC=n("./src/SecurityManager.ts");class KC extends s.PureComponent{constructor(e){super(e),(0,h.A)(this,"unmounted",!1),(0,h.A)(this,"onKeyBackupSessionsRemaining",(e=>{this.setState({sessionsRemaining:e})})),(0,h.A)(this,"onKeyBackupStatus",(()=>{this.loadBackupStatus()})),(0,h.A)(this,"startNewBackup",(()=>{A.Ay.createDialog((0,s.lazy)((()=>n.e(9123).then(n.bind(n,"./src/async-components/views/dialogs/security/CreateKeyBackupDialog.tsx")))),{onFinished:()=>{this.loadBackupStatus()}},void 0,!1,!0)})),(0,h.A)(this,"deleteBackup",(()=>{A.Ay.createDialog(q.A,{title:(0,P._t)("settings|security|delete_backup"),description:(0,P._t)("settings|security|delete_backup_confirm_description"),button:(0,P._t)("settings|security|delete_backup"),danger:!0,onFinished:e=>{var t;if(!e)return;this.setState({loading:!0});const n=this.state.backupInfo.version;null===(t=E.J.safeGet().getCrypto())||void 0===t||t.deleteKeyBackupVersion(n)}})})),(0,h.A)(this,"restoreBackup",(async()=>{A.Ay.createDialog(Ta.A,void 0,void 0,!1,!0)})),(0,h.A)(this,"resetSecretStorage",(async()=>{this.setState({error:!1});try{await(0,GC.cb)((async()=>{}),{forceReset:!0})}catch(e){if(o.v.error("Error resetting secret storage",e),this.unmounted)return;this.setState({error:!0})}this.unmounted||this.loadBackupStatus()})),this.state={loading:!0,error:!1,backupKeyStored:null,backupKeyCached:null,backupKeyWellFormed:null,secretStorageKeyInAccount:null,secretStorageReady:null,backupInfo:null,backupTrustInfo:void 0,activeBackupVersion:null,sessionsRemaining:null}}componentDidMount(){this.unmounted=!1,this.loadBackupStatus(),E.J.safeGet().on(f.CryptoEvent.KeyBackupStatus,this.onKeyBackupStatus),E.J.safeGet().on(f.CryptoEvent.KeyBackupSessionsRemaining,this.onKeyBackupSessionsRemaining)}componentWillUnmount(){this.unmounted=!0,E.J.get()&&(E.J.get().removeListener(f.CryptoEvent.KeyBackupStatus,this.onKeyBackupStatus),E.J.get().removeListener(f.CryptoEvent.KeyBackupSessionsRemaining,this.onKeyBackupSessionsRemaining))}async loadBackupStatus(){this.setState({loading:!0}),this.getUpdatedDiagnostics();try{var e,t,n,i,r;const s=E.J.safeGet(),o=null!==(e=await(null===(t=s.getCrypto())||void 0===t?void 0:t.getKeyBackupInfo()))&&void 0!==e?e:null,a=o?await(null===(n=s.getCrypto())||void 0===n?void 0:n.isKeyBackupTrusted(o)):void 0,l=null!==(i=await(null===(r=s.getCrypto())||void 0===r?void 0:r.getActiveSessionBackupVersion()))&&void 0!==i?i:null;if(this.unmounted)return;this.setState({loading:!1,error:!1,backupInfo:o,backupTrustInfo:a,activeBackupVersion:l})}catch(e){if(o.v.log("Unable to fetch key backup status",e),this.unmounted)return;this.setState({loading:!1,error:!0,backupInfo:null,backupTrustInfo:void 0,activeBackupVersion:null})}}async getUpdatedDiagnostics(){const e=E.J.safeGet(),t=e.getCrypto();if(!t)return;const n=e.secretStorage,i=!!await e.isKeyBackupKeyStored(),r=await t.getSessionBackupPrivateKey(),s=!!r,o=r instanceof Uint8Array,a=await n.hasKey(),l=await t.isSecretStorageReady();this.unmounted||this.setState({backupKeyStored:i,backupKeyCached:s,backupKeyWellFormed:o,secretStorageKeyInAccount:a,secretStorageReady:l})}render(){const{loading:e,error:t,backupKeyStored:n,backupKeyCached:i,backupKeyWellFormed:r,secretStorageKeyInAccount:o,secretStorageReady:a,backupInfo:l,backupTrustInfo:c,sessionsRemaining:d}=this.state;let u,m,p;const h=[];if(t)u=s.createElement(sC.s,{className:"error"},(0,P._t)("settings|security|error_loading_key_backup_status"));else if(e)u=s.createElement(Na.A,null);else if(l){let e,t,n=(0,P._t)("settings|security|restore_key_backup");null!==this.state.activeBackupVersion?u=s.createElement(sC.s,null,"âœ… ",(0,P._t)("settings|security|key_backup_active")):(u=s.createElement(s.Fragment,null,s.createElement(sC.s,null,(0,P._t)("settings|security|key_backup_inactive_warning",{},{b:e=>s.createElement("b",null,e)}))),n=(0,P._t)("settings|security|key_backup_connect")),e=null===d?"":d>0?s.createElement("div",null,(0,P._t)("settings|security|key_backup_in_progress",{sessionsRemaining:d})," ",s.createElement("br",null)):s.createElement("div",null,(0,P._t)("settings|security|key_backup_complete")," ",s.createElement("br",null)),null!=c&&c.matchesDecryptionKey&&(t=(0,P._t)("settings|security|key_backup_can_be_restored")),m=s.createElement(s.Fragment,null,s.createElement("tr",null,s.createElement("th",{scope:"row"},(0,P._t)("settings|security|key_backup_latest_version")),s.createElement("td",null,l.version," (",(0,P._t)("settings|security|key_backup_algorithm")," ",s.createElement("code",null,l.algorithm),")")),s.createElement("tr",null,s.createElement("th",{scope:"row"},(0,P._t)("settings|security|key_backup_active_version")),s.createElement("td",null,null===this.state.activeBackupVersion?(0,P._t)("settings|security|key_backup_active_version_none"):this.state.activeBackupVersion))),p=s.createElement(s.Fragment,null,e,s.createElement("div",null,t)),h.push(s.createElement(Ae.A,{key:"restore",kind:"primary_outline",onClick:this.restoreBackup},n))}else u=s.createElement(s.Fragment,null,s.createElement(sC.s,null,(0,P._t)("settings|security|key_backup_inactive_warning",{},{b:e=>s.createElement("strong",null,e)}))),h.push(s.createElement(Ae.A,{key:"setup",kind:"primary_outline",onClick:this.startNewBackup},(0,P._t)("encryption|setup_secure_backup|title")));o&&h.push(s.createElement(Ae.A,{key:"reset",kind:"danger_outline",onClick:this.resetSecretStorage},(0,P._t)("Generate a new code")));let g,v="";return i&&(v=", ",v+=r?(0,P._t)("settings|security|backup_key_well_formed"):(0,P._t)("settings|security|backup_key_unexpected_type")),h.length&&(g=s.createElement("div",{className:"mx_SecureBackupPanel_buttonRow"},h)),s.createElement(s.Fragment,null,s.createElement(sC.s,null,(0,P._t)("settings|security|backup_keys_description")),u,s.createElement("details",null,s.createElement("summary",{className:"mx_SecureBackupPanel_advanced"},(0,P._t)("common|advanced")),s.createElement("table",{className:"mx_SecureBackupPanel_statusList"},s.createElement("tr",null,s.createElement("th",{scope:"row"},(0,P._t)("settings|security|backup_key_stored_status")),s.createElement("td",null,!0===n?(0,P._t)("settings|security|cross_signing_in_4s"):(0,P._t)("settings|security|cross_signing_not_stored"))),s.createElement("tr",null,s.createElement("th",{scope:"row"},(0,P._t)("settings|security|backup_key_cached_status")),s.createElement("td",null,i?(0,P._t)("settings|security|cross_signing_cached"):(0,P._t)("settings|security|cross_signing_not_cached"),v)),s.createElement("tr",null,s.createElement("th",{scope:"row"},(0,P._t)("settings|security|4s_public_key_status")),s.createElement("td",null,o?(0,P._t)("settings|security|4s_public_key_in_account_data"):(0,P._t)("settings|security|cross_signing_not_found"))),s.createElement("tr",null,s.createElement("th",{scope:"row"},(0,P._t)("settings|security|secret_storage_status")),s.createElement("td",null,a?(0,P._t)("settings|security|secret_storage_ready"):(0,P._t)("settings|security|secret_storage_not_ready"))),m),p),g)}}class JC extends s.Component{constructor(e,t){super(e),(0,h.A)(this,"onExportE2eKeysClicked",(()=>{A.Ay.createDialog((0,s.lazy)((()=>n.e(7692).then(n.bind(n,"./src/async-components/views/dialogs/security/ExportE2eKeysDialog.tsx")))),{matrixClient:this.context})})),(0,h.A)(this,"onImportE2eKeysClicked",(()=>{A.Ay.createDialog((0,s.lazy)((()=>n.e(7211).then(n.bind(n,"./src/async-components/views/dialogs/security/ImportE2eKeysDialog.tsx")))),{matrixClient:this.context})})),(0,h.A)(this,"updateBlacklistDevicesFlag",(e=>{const t=this.context.getCrypto();t&&(t.globalBlacklistUnverifiedDevices=e)})),t.getCrypto()?this.state={deviceIdentityKey:void 0}:this.state={deviceIdentityKey:null}}componentDidMount(){var e;void 0===this.state.deviceIdentityKey&&(null===(e=this.context.getCrypto())||void 0===e||e.getOwnDeviceKeys().then((e=>{this.setState({deviceIdentityKey:e.ed25519})})).catch((e=>{o.v.error(`CryptographyPanel: Error fetching own device keys: ${e}`),this.setState({deviceIdentityKey:null})})))}render(){const e=this.context,t=e.deviceId;let n,i,r=this.state.deviceIdentityKey;return r=void 0===r?"...":null===r?(0,P._t)("encryption|not_supported"):lh.y$(r),e.getCrypto()&&(n=s.createElement("div",{className:"mx_CryptographyPanel_importExportButtons"},s.createElement(Ae.A,{kind:"primary_outline",onClick:this.onExportE2eKeysClicked},(0,P._t)("settings|security|export_megolm_keys")),s.createElement(Ae.A,{kind:"primary_outline",onClick:this.onImportE2eKeysClicked},(0,P._t)("settings|security|import_megolm_keys")))),V.A.canSetValue("blacklistUnverifiedDevices",null,ae.p.DEVICE)&&(i=s.createElement(mC.A,{name:"blacklistUnverifiedDevices",level:ae.p.DEVICE,onChange:this.updateBlacklistDevicesFlag})),s.createElement(sC.P,{heading:(0,P._t)("settings|security|cryptography_section")}," ",s.createElement("div",{className:"mx_SettingsTab_subsectionText"},s.createElement("div",null,(0,P._t)("These keys only apply to the current session.")),s.createElement("div",null,s.createElement("b",null,(0,P._t)("Please note this is not your recovery code for your automatic backup.")))),s.createElement("details",null,s.createElement("summary",null,(0,P._t)("common|advanced")),s.createElement(sC.s,null,s.createElement("table",{className:"mx_CryptographyPanel_sessionInfo"},s.createElement("tr",null,s.createElement("th",{scope:"row"},(0,P._t)("settings|security|session_id")),s.createElement("td",null,s.createElement("code",null,t))),s.createElement("tr",null,s.createElement("th",{scope:"row"},(0,P._t)("settings|security|session_key")),s.createElement("td",null,s.createElement("code",null,s.createElement("b",null,r))))))),n,i)}}(0,h.A)(JC,"contextType",Pe.Ay);class qC extends s.Component{constructor(...e){super(...e),(0,h.A)(this,"onConfirm",(()=>{this.props.onFinished(!0)})),(0,h.A)(this,"onDecline",(()=>{this.props.onFinished(!1)}))}render(){return s.createElement(Pa.A,{className:"mx_ConfirmDestroyCrossSigningDialog",hasCancel:!0,onFinished:this.props.onFinished,title:(0,P._t)("encryption|destroy_cross_signing_dialog|title")},s.createElement("div",{className:"mx_ConfirmDestroyCrossSigningDialog_content"},s.createElement("p",null,(0,P._t)("encryption|destroy_cross_signing_dialog|warning"))),s.createElement(Da.A,{primaryButton:(0,P._t)("encryption|destroy_cross_signing_dialog|primary_button_text"),onPrimaryButtonClick:this.onConfirm,primaryButtonClass:"danger",cancelButton:(0,P._t)("action|cancel"),onCancel:this.onDecline}))}}var $C=n("./src/components/views/dialogs/security/SetupEncryptionDialog.tsx");class YC extends s.PureComponent{constructor(e){super(e),(0,h.A)(this,"unmounted",!1),(0,h.A)(this,"onAccountData",(e=>{const t=e.getType();(t.startsWith("m.cross_signing")||t.startsWith("m.secret_storage"))&&this.getUpdatedStatus()})),(0,h.A)(this,"onBootstrapClick",(()=>{this.state.crossSigningPrivateKeysInStorage?A.Ay.createDialog($C.A,{},void 0,!1,!0):(0,GC.cb)()})),(0,h.A)(this,"onStatusChanged",(()=>{this.getUpdatedStatus()})),(0,h.A)(this,"onResetCrossSigningClick",(()=>{A.Ay.createDialog(qC,{onFinished:async e=>{e&&this.resetCrossSigning()}})})),this.state={error:!1}}componentDidMount(){this.unmounted=!1;const e=E.J.safeGet();e.on(i.ClientEvent.AccountData,this.onAccountData),e.on(f.CryptoEvent.UserTrustStatusChanged,this.onStatusChanged),e.on(f.CryptoEvent.KeysChanged,this.onStatusChanged),this.getUpdatedStatus()}componentWillUnmount(){this.unmounted=!0;const e=E.J.get();e&&(e.removeListener(i.ClientEvent.AccountData,this.onAccountData),e.removeListener(f.CryptoEvent.UserTrustStatusChanged,this.onStatusChanged),e.removeListener(f.CryptoEvent.KeysChanged,this.onStatusChanged))}async getUpdatedStatus(){const e=E.J.safeGet(),t=e.getCrypto();if(!t)return;const n=await t.getCrossSigningStatus(),i=n.publicKeysOnDevice,r=n.privateKeysInSecretStorage,s=n.privateKeysCachedLocally.masterKey,o=n.privateKeysCachedLocally.selfSigningKey,a=n.privateKeysCachedLocally.userSigningKey,l=await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"),c=await t.isCrossSigningReady();this.setState({crossSigningPublicKeysOnDevice:i,crossSigningPrivateKeysInStorage:r,masterPrivateKeyCached:s,selfSigningPrivateKeyCached:o,userSigningPrivateKeyCached:a,homeserverSupportsCrossSigning:l,crossSigningReady:c})}async resetCrossSigning(){this.setState({error:!1});try{const e=E.J.safeGet();await(0,GC.J6)((async()=>{await e.getCrypto().bootstrapCrossSigning({authUploadDeviceSigningKeys:async t=>{const{finished:n}=A.Ay.createDialog(KA.A,{title:(0,P._t)("encryption|bootstrap_title"),matrixClient:e,makeRequest:t}),[i]=await n;if(!i)throw new Error("Cross-signing key upload auth canceled")},setupNewCrossSigning:!0})}))}catch(e){this.setState({error:!0}),o.v.error("Error bootstrapping cross-signing",e)}this.unmounted||this.getUpdatedStatus()}render(){const{error:e,crossSigningPublicKeysOnDevice:t,crossSigningPrivateKeysInStorage:n,masterPrivateKeyCached:i,selfSigningPrivateKeyCached:r,userSigningPrivateKeyCached:o,homeserverSupportsCrossSigning:a,crossSigningReady:l}=this.state;let c,d;e&&(c=s.createElement("div",{className:"error"},e.toString())),d=void 0===a?s.createElement(Na.A,null):a?l&&n?s.createElement(sC.s,null,"âœ… ",(0,P._t)("encryption|cross_signing_ready")):l&&!n?s.createElement(sC.s,null,"âš ï¸ ",(0,P._t)("encryption|cross_signing_ready_no_backup")):n?s.createElement(sC.s,null,(0,P._t)("encryption|cross_signing_untrusted")):s.createElement(sC.s,null,(0,P._t)("encryption|cross_signing_not_ready")):s.createElement(sC.s,null,(0,P._t)("encryption|cross_signing_unsupported"));const u=t||n||i||r||o,m=[],p=[];if(!(t&&n&&i&&r&&o)&&a){let e=(0,P._t)("Activate on this device");n&&(e=(0,P._t)("encryption|verify_toast_title")),p.push(s.createElement(Ae.A,{key:"setup",kind:"primary",onClick:this.onBootstrapClick},e))}let h,g;return u&&p.push(s.createElement(Ae.A,{key:"reset",kind:"danger",onClick:this.onResetCrossSigningClick},(0,P._t)("action|reset"))),m.length&&(h=s.createElement("div",{className:"mx_CrossSigningPanel_buttonRow"},m)),p.length&&(g=s.createElement("div",{className:"mx_CrossSigningPanel_buttonRow"},p)),s.createElement(s.Fragment,null,d,s.createElement("details",null,s.createElement("summary",{className:"mx_CrossSigningPanel_advanced"},(0,P._t)("common|advanced")),s.createElement("table",{className:"mx_CrossSigningPanel_statusList"},s.createElement("tbody",null,s.createElement("tr",null,s.createElement("th",{scope:"row"},(0,P._t)("settings|security|cross_signing_public_keys")),s.createElement("td",null,t?(0,P._t)("settings|security|cross_signing_in_memory"):(0,P._t)("settings|security|cross_signing_not_found"))),s.createElement("tr",null,s.createElement("th",{scope:"row"},(0,P._t)("settings|security|cross_signing_private_keys")),s.createElement("td",null,n?(0,P._t)("settings|security|cross_signing_in_4s"):(0,P._t)("settings|security|cross_signing_not_in_4s"))),s.createElement("tr",null,s.createElement("th",{scope:"row"},(0,P._t)("settings|security|cross_signing_master_private_Key")),s.createElement("td",null,i?(0,P._t)("settings|security|cross_signing_cached"):(0,P._t)("settings|security|cross_signing_not_cached"))),s.createElement("tr",null,s.createElement("th",{scope:"row"},(0,P._t)("settings|security|cross_signing_self_signing_private_key")),s.createElement("td",null,r?(0,P._t)("settings|security|cross_signing_cached"):(0,P._t)("settings|security|cross_signing_not_cached"))),s.createElement("tr",null,s.createElement("th",{scope:"row"},(0,P._t)("settings|security|cross_signing_user_signing_private_key")),s.createElement("td",null,o?(0,P._t)("settings|security|cross_signing_cached"):(0,P._t)("settings|security|cross_signing_not_cached"))),s.createElement("tr",null,s.createElement("th",{scope:"row"},(0,P._t)("settings|security|cross_signing_homeserver_support")),s.createElement("td",null,a?(0,P._t)("settings|security|cross_signing_homeserver_support_exists"):(0,P._t)("settings|security|cross_signing_not_found"))))),g),c,h)}}s.PureComponent;s.Component;var ZC=n("./src/utils/device/clientInformation.ts"),XC=n("./src/utils/device/parseUserAgent.ts"),QC=n("./src/utils/device/isDeviceVerified.ts");function ex(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function tx(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ex(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ex(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const nx=(e,t)=>{const{name:n,version:i,url:r}=(0,ZC.Uh)(e,t.device_id);return{appName:n,appVersion:i,url:r}};let ix=function(e){return e.Unsupported="Unsupported",e.Default="Default",e}({});const rx=()=>{var e;const t=(0,s.useContext)(Wa.A).client,n=t.getDeviceId(),r=t.getSafeUserId(),[a,l]=(0,s.useState)({}),[c,d]=(0,s.useState)(void 0),[u,m]=(0,s.useState)([]),[p,h]=(0,s.useState)(new Map),[g,v]=(0,s.useState)(!0),[_,y]=(0,s.useState)(!0),[b,E]=(0,s.useState)();(0,s.useEffect)((()=>{t.doesServerSupportUnstableFeature("org.matrix.msc3881").then((e=>{y(e)}))}),[t]);const w=(0,s.useCallback)((async()=>{v(!0);try{var e,n;const s=await async function(e){const{devices:t}=await e.getDevices(),n={};for(const r of t)n[r.device_id]=tx(tx(tx({},r),{},{isVerified:await(0,QC.z)(e,r.device_id)},nx(e,r)),(0,XC.y)(r[i.UNSTABLE_MSC3852_LAST_SEEN_UA.name]));return n}(t);l(s);const{pushers:o}=await t.getPushers();m(o);const a=new Map;Object.keys(s).forEach((e=>{const n=`${i.LOCAL_NOTIFICATION_SETTINGS_PREFIX.name}.${e}`,r=t.getAccountData(n);r&&a.set(e,r.getContent())})),h(a);const c=t.getUserId(),u=null===(e=await(null===(n=t.getCrypto())||void 0===n?void 0:n.getUserDeviceInfo([c])))||void 0===e?void 0:e.get(c),p=[];for(const e of null!==(r=null==u?void 0:u.values())&&void 0!==r?r:[]){var r;e.dehydrated&&p.push(e.deviceId)}d(1==p.length?p[0]:void 0),v(!1)}catch(e){404==e.httpStatus?E(ix.Unsupported):(o.v.error("Error loading sessions:",e),E(ix.Default)),v(!1)}}),[t]);(0,s.useEffect)((()=>{w()}),[w]),(0,s.useEffect)((()=>{const e=Object.keys(a);e.length&&(0,ZC.eD)(e,t)}),[a,t]),(0,Me.ml)(t,f.CryptoEvent.DevicesUpdated,(e=>{e.includes(r)&&w()})),(0,Me.ml)(t,i.ClientEvent.AccountData,(e=>{const t=e.getType();if(t.startsWith(i.LOCAL_NOTIFICATION_SETTINGS_PREFIX.name)){const n=new Map(p),i=t.slice(t.lastIndexOf(".")+1);n.set(i,e.getContent()),h(n)}}));const S=!(null===(e=a[n])||void 0===e||!e.isVerified)&&r?async e=>await t.getCrypto().requestDeviceVerification(r,e):void 0,A=(0,s.useCallback)((async(e,n)=>{const i=a[e];if(n!==(null==i?void 0:i.display_name))try{await t.setDeviceDetails(e,{display_name:n}),await w()}catch(e){throw o.v.error("Error setting device name",e),new Error((0,P._t)("settings|sessions|error_set_name"))}}),[t,a,w]),C=(0,s.useCallback)((async(e,n)=>{try{const r=u.find((t=>t[i.PUSHER_DEVICE_ID.name]===e));r?await t.setPusher(tx(tx({},r),{},{[i.PUSHER_ENABLED.name]:n})):p.has(e)&&await t.setLocalNotificationSettings(e,{is_silenced:!n})}catch(e){throw o.v.error("Error setting pusher state",e),new Error((0,P._t)("settings|sessions|error_pusher_state"))}finally{await w()}}),[t,u,p,w]);return{devices:a,dehydratedDeviceId:c,pushers:u,localNotificationSettings:p,currentDeviceId:n,isLoadingDeviceList:g,error:b,requestDeviceVerification:S,refreshDevices:w,saveDeviceName:A,setPushNotifications:C,supportsMSC3881:_}};class sx extends s.Component{constructor(e){super(e),(0,h.A)(this,"onProvisioningToggled",(()=>{const e=this.state.provisioningEnabled;V.A.setValue("integrationProvisioning",null,ae.p.ACCOUNT,!e).catch((t=>{o.v.error("Error changing integration manager provisioning"),o.v.error(t),this.setState({provisioningEnabled:e})})),this.setState({provisioningEnabled:!e})}));const t=sv.J.sharedInstance().getPrimaryManager();this.state={currentManager:t,provisioningEnabled:V.A.getValue("integrationProvisioning")}}render(){const e=this.state.currentManager;let t,n;return e?(t=`(${e.name})`,n=(0,P._t)("integration_manager|use_im_default",{serverName:e.name},{b:e=>s.createElement("strong",null,e)})):n=(0,P._t)("integration_manager|use_im"),V.A.getValue($.f.Widgets)?s.createElement("label",{className:"mx_SetIntegrationManager",htmlFor:"toggle_integration"},s.createElement("div",{className:"mx_SettingsFlag"},s.createElement("div",{className:"mx_SetIntegrationManager_heading_manager"},s.createElement(uc.A,{size:"3"},(0,P._t)("integration_manager|manage_title")),s.createElement(uc.A,{size:"4"},t)),s.createElement(aC.A,{id:"toggle_integration",checked:this.state.provisioningEnabled,disabled:!1,onChange:this.onProvisioningToggled})),s.createElement(sC.s,null,n),s.createElement(sC.s,null,(0,P._t)("integration_manager|explainer"))):null}}class ox extends s.Component{constructor(...e){super(...e),(0,h.A)(this,"onUnignoreClicked",(()=>{this.props.onUnignored(this.props.userId)}))}render(){const e=`mx_SecurityUserSettingsTab_ignoredUser_${this.props.userId}`;return s.createElement("div",{className:"mx_SecurityUserSettingsTab_ignoredUser"},s.createElement(Ae.A,{onClick:this.onUnignoreClicked,kind:"primary_sm","aria-describedby":e,disabled:this.props.inProgress},(0,P._t)("action|unignore")),s.createElement("span",{id:e},this.props.userId))}}class ax extends s.Component{constructor(e){super(e),(0,h.A)(this,"dispatcherRef",void 0),(0,h.A)(this,"onAction",(({action:e})=>{if("ignore_state_changed"===e){const e=E.J.safeGet().getIgnoredUsers(),t=this.state.waitingUnignored.filter((t=>e.includes(t)));this.setState({ignoredUserIds:e,waitingUnignored:t})}})),(0,h.A)(this,"onMyMembership",((e,t)=>{e.isSpaceRoom()||(t===oa.O.Invite?this.addInvitedRoom(e):this.state.invitedRoomIds.has(e.roomId)&&this.removeInvitedRoom(e.roomId))})),(0,h.A)(this,"addInvitedRoom",(e=>{this.setState((({invitedRoomIds:t})=>({invitedRoomIds:new Set(t).add(e.roomId)})))})),(0,h.A)(this,"removeInvitedRoom",(e=>{this.setState((({invitedRoomIds:t})=>{const n=new Set(t);return n.delete(e),{invitedRoomIds:n}}))})),(0,h.A)(this,"onUserUnignored",(async e=>{const{ignoredUserIds:t,waitingUnignored:n}=this.state,i=t.filter((e=>!n.includes(e))),r=i.indexOf(e);-1!==r&&(i.splice(r,1),this.setState((({waitingUnignored:t})=>({waitingUnignored:[...t,e]}))),E.J.safeGet().setIgnoredUsers(i))})),(0,h.A)(this,"getInvitedRooms",(()=>E.J.safeGet().getRooms().filter((e=>e.hasMembershipState(E.J.safeGet().getUserId(),oa.O.Invite))))),(0,h.A)(this,"manageInvites",(async e=>{this.setState({managingInvites:!0});const t=Array.from(this.state.invitedRoomIds),n=E.J.safeGet(),i=e?n.joinRoom.bind(n):n.leave.bind(n);for(let e=0;e<t.length;e++){const n=t[e];await i(n).then((()=>{this.removeInvitedRoom(n)}),(async t=>{"M_LIMIT_EXCEEDED"===t.errcode?(await(0,g.yy)(t.retry_after_ms||2500),e--):o.v.warn(t)}))}this.setState({managingInvites:!1})})),(0,h.A)(this,"onAcceptAllInvitesClicked",(()=>{this.manageInvites(!0)})),(0,h.A)(this,"onRejectAllInvitesClicked",(()=>{this.manageInvites(!1)}));const t=new Set(this.getInvitedRooms().map((e=>e.roomId)));this.state={ignoredUserIds:E.J.safeGet().getIgnoredUsers(),waitingUnignored:[],managingInvites:!1,invitedRoomIds:t}}componentDidMount(){this.dispatcherRef=w.A.register(this.onAction),E.J.safeGet().on(i.RoomEvent.MyMembership,this.onMyMembership),E.J.safeGet().getVersions().then((e=>this.setState({versions:e})))}componentWillUnmount(){w.A.unregister(this.dispatcherRef),E.J.safeGet().removeListener(i.RoomEvent.MyMembership,this.onMyMembership)}renderIgnoredUsers(){const{waitingUnignored:e,ignoredUserIds:t}=this.state,n=null!=t&&t.length?t.map((t=>s.createElement(ox,{userId:t,onUnignored:this.onUserUnignored,key:t,inProgress:e.includes(t)}))):(0,P._t)("settings|security|ignore_users_empty");return s.createElement(sC.P,{heading:(0,P._t)("settings|security|ignore_users_section")},s.createElement(sC.s,null,n))}renderManageInvites(){const{invitedRoomIds:e}=this.state;return 0===e.size?null:s.createElement(sC.P,{heading:(0,P._t)("settings|security|bulk_options_section")},s.createElement("div",{className:"mx_SecurityUserSettingsTab_bulkOptions"},s.createElement(Ae.A,{onClick:this.onAcceptAllInvitesClicked,kind:"primary_outline",disabled:this.state.managingInvites},(0,P._t)("settings|security|bulk_options_accept_all_invites",{invitedRooms:e.size})),s.createElement(Ae.A,{onClick:this.onRejectAllInvitesClicked,kind:"danger_outline",disabled:this.state.managingInvites},(0,P._t)("settings|security|bulk_options_reject_all_invites",{invitedRooms:e.size})),this.state.managingInvites?s.createElement(He.A,null):s.createElement("div",null)))}render(){const e=s.createElement(rC.X,{heading:(0,P._t)("common|secure_backup")},s.createElement(KC,null)),t=(sC.P,(0,P._t)("settings|security|message_search_section"),s.createElement(sC.P,{heading:(0,P._t)("common|cross_signing")},s.createElement(YC,null)));let n,i,r;if((0,_h.u)(E.J.safeGet())||(n=s.createElement("div",{className:"mx_SecurityUserSettingsTab_warning"},(0,P._t)("settings|security|e2ee_default_disabled_warning"))),hu.Vo.instance.isEnabled()){const e=()=>{Yw({primaryButton:(0,P._t)("action|ok"),hasCancel:!1})};i=s.createElement(rC.X,{heading:(0,P._t)("common|privacy")},s.createElement(sC.P,{heading:(0,P._t)("common|analytics"),description:(0,P._t)("settings|security|analytics_description")},s.createElement(Ae.A,{kind:"link",onClick:e},(0,P._t)("action|learn_more")),hu.Vo.instance.isEnabled()&&s.createElement(mC.A,{name:"pseudonymousAnalyticsOptIn",level:ae.p.ACCOUNT})),s.createElement(sC.P,{heading:(0,P._t)("settings|sessions|title")},s.createElement(mC.A,{name:"deviceClientInformationOptIn",level:ae.p.ACCOUNT})))}if(V.A.getValue($.f.AdvancedSettings)){const e=this.renderIgnoredUsers(),t=this.renderManageInvites();(e||t)&&(r=s.createElement(rC.X,{heading:(0,P._t)("common|advanced")},e,t))}return s.createElement(iC.A,null,n,e,Vl.A.showWidgetsSettings&&s.createElement(sx,null),s.createElement(rC.X,{heading:(0,P._t)("settings|security|encryption_section")},t,s.createElement(JC,null),i),r)}}const lx=["icon","label","onDeleteClick","disabled"],cx=e=>{let{icon:t,label:n,onDeleteClick:i,disabled:r=!1}=e,o=(0,Ve.A)(e,lx);return s.createElement("div",(0,p.A)({className:"mx_Tag"},o),null==t?void 0:t(),n,i&&s.createElement(Ae.A,{"aria-label":"Remove",className:"mx_Tag_delete",onClick:i,disabled:r},s.createElement(ab.A,null)))};class dx extends s.PureComponent{constructor(e){super(e),(0,h.A)(this,"onInputChange",(e=>{this.setState({newTag:e.target.value})})),(0,h.A)(this,"onAdd",(e=>{e.preventDefault(),this.state.newTag&&(this.props.onAdd(this.state.newTag),this.setState({newTag:""}))})),this.state={newTag:""}}onRemove(e){this.props.onRemove(e)}render(){return s.createElement("div",{className:re()("mx_TagComposer",{mx_TagComposer_disabled:this.props.disabled})},s.createElement("form",{className:"mx_TagComposer_input",onSubmit:this.onAdd},s.createElement(Sa.A,{id:this.props.id?this.props.id+"_field":void 0,value:this.state.newTag,onChange:this.onInputChange,label:this.props.label||(0,P._t)("notifications|keyword"),placeholder:this.props.placeholder||(0,P._t)("notifications|keyword_new"),disabled:this.props.disabled,autoComplete:"off"}),s.createElement(Ae.A,{onClick:this.onAdd,kind:"primary",disabled:this.props.disabled},(0,P._t)("action|add"))),s.createElement("div",{className:"mx_TagComposer_tags",role:"list"},this.props.tags.map(((e,t)=>s.createElement(cx,{label:e,key:e,onDeleteClick:this.onRemove.bind(this,e),disabled:this.props.disabled,role:"listitem"})))))}}var ux=n("./src/components/views/typography/Caption.tsx"),mx=n("./src/components/views/settings/shared/SettingsSubsectionHeading.tsx");function px(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function hx(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?px(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):px(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var gx=function(e){return e.Loading="loading",e.Ready="ready",e.Persisting="persisting",e.Error="error",e.SavingError="savingError",e}(gx||{}),vx=function(e){return e.Master="master",e.VectorGlobal="vector_global",e.VectorMentions="vector_mentions",e.VectorOther="vector_other",e.Other="other",e}(vx||{});const fx="_keywords",_x=vx.VectorMentions,yx=[i.RuleId.DM,i.RuleId.EncryptedDM,i.RuleId.Message,i.RuleId.EncryptedMessage,i.RuleId.ContainsDisplayName,i.RuleId.ContainsUserName,i.RuleId.AtRoomNotification,i.RuleId.InviteToSelf,i.RuleId.IncomingCall,i.RuleId.SuppressNotices,i.RuleId.Tombstone],bx=[Pw.Off,Pw.On,Pw.Loud],Ex=(e,t,n)=>{var i;if(null===(i=n.syncedRuleIds)||void 0===i||!i.length)return;const r=n.syncedRuleIds.reduce(((t,i)=>{if(t===Pw.Loud)return t;const r=((e,t)=>{for(const n in t){const i=t[n].find((t=>t.rule_id===e));if(i)return i}})(i,e);if(r){const e=n.ruleToVectorState(r);if(e&&bx.indexOf(e)>bx.indexOf(t))return e}return t}),n.ruleToVectorState(t));return r},wx=()=>s.createElement("div",null,s.createElement(mC.A,{name:"Notifications.showbold",level:ae.p.DEVICE}),Vl.A.isFeatureActiveForHomeserver("feature_thread")?s.createElement(mC.A,{name:"Notifications.tac_only_notifications",level:ae.p.DEVICE}):null);class Sx extends s.PureComponent{constructor(e){var t;super(e),(0,h.A)(this,"settingWatchers",[]),(0,h.A)(this,"onMasterRuleChanged",(async e=>{this.setState({phase:gx.Persisting});const t=this.state.masterPushRule;try{await E.J.safeGet().setPushRuleEnabled("global",t.kind,t.rule_id,!e),await this.refreshFromServer()}catch(e){this.setState({phase:gx.Error}),o.v.error("Error updating master push rule:",e),this.showSaveError()}})),(0,h.A)(this,"setSavingError",(e=>{this.setState((({ruleIdsWithError:t})=>({phase:gx.SavingError,ruleIdsWithError:hx(hx({},t),{},{[e]:!0})})))})),(0,h.A)(this,"updateDeviceNotifications",(async e=>{await V.A.setValue("deviceNotificationsEnabled",null,ae.p.DEVICE,e)})),(0,h.A)(this,"onEmailNotificationsChanged",(async(e,t)=>{this.setState({phase:gx.Persisting});try{if(t)await E.J.safeGet().setPusher({kind:"email",app_id:"m.email",pushkey:e,app_display_name:"Email Notifications",device_display_name:e,lang:navigator.language,data:{brand:u.Ay.get().brand},append:!0});else{var n;const t=null===(n=this.state.pushers)||void 0===n?void 0:n.find((t=>"email"===t.kind&&t.pushkey===e));t&&await E.J.safeGet().removePusher(t.pushkey,t.app_id)}await this.refreshFromServer()}catch(e){this.setState({phase:gx.Error}),o.v.error("Error updating email pusher:",e),this.showSaveError()}})),(0,h.A)(this,"onDesktopNotificationsChanged",(async e=>{await V.A.setValue("notificationsEnabled",null,ae.p.DEVICE,e)})),(0,h.A)(this,"onDesktopShowBodyChanged",(async e=>{await V.A.setValue("notificationBodyEnabled",null,ae.p.DEVICE,e)})),(0,h.A)(this,"onAudioNotificationsChanged",(async e=>{await V.A.setValue("audioNotificationsEnabled",null,ae.p.DEVICE,e)})),(0,h.A)(this,"onRadioChecked",(async(e,t)=>{this.setState((({ruleIdsWithError:t})=>({phase:gx.Persisting,ruleIdsWithError:hx(hx({},t),{},{[e.ruleId]:!1})})));try{const n=E.J.safeGet();if(e.ruleId===fx){if(!this.state.vectorKeywordRuleInfo)throw new Error("Notification data is incomplete.");for(const e of this.state.vectorKeywordRuleInfo.rules){let i,r;t===Pw.On?(1!==e.actions.length&&(r=Nw.actionsFor(t)),this.state.vectorKeywordRuleInfo.vectorState===Pw.Off&&(i=!0)):t===Pw.Loud?(3!==e.actions.length&&(r=Nw.actionsFor(t)),this.state.vectorKeywordRuleInfo.vectorState===Pw.Off&&(i=!0)):i=!1,r&&await n.setPushRuleActions("global",e.kind,e.rule_id,r),void 0!==i&&await n.setPushRuleEnabled("global",e.kind,e.rule_id,i)}}else{const i=Mw[e.ruleId],r=i.vectorStateToActions[t];if(!e.rule)throw new Error("Cannot update rule: push rule data is incomplete.");await Lw(n,e.rule.rule_id,e.rule.kind,r),await Fw(n,i.syncedRuleIds,r)}await this.refreshFromServer()}catch(t){this.setSavingError(e.ruleId),o.v.error("Error updating push rule:",t)}})),(0,h.A)(this,"onClearNotificationsClicked",(async()=>{try{this.setState({clearingNotifications:!0});const e=E.J.safeGet();await(0,el.XC)(e)}finally{this.setState({clearingNotifications:!1})}})),(0,h.A)(this,"onKeywordAdd",(e=>{if(!this.state.vectorKeywordRuleInfo)throw new Error("Notification data is incomplete.");const t=(0,Hg.ZV)(this.state.vectorKeywordRuleInfo.rules);this.setState({phase:gx.Persisting,vectorKeywordRuleInfo:hx(hx({},this.state.vectorKeywordRuleInfo),{},{rules:[...this.state.vectorKeywordRuleInfo.rules,{pattern:e}]})},(async()=>{await this.setKeywords(this.state.vectorKeywordRuleInfo.rules.map((e=>e.pattern)),t)}))})),(0,h.A)(this,"onKeywordRemove",(e=>{if(!this.state.vectorKeywordRuleInfo)throw new Error("Notification data is incomplete.");const t=(0,Hg.ZV)(this.state.vectorKeywordRuleInfo.rules);this.setState({phase:gx.Persisting,vectorKeywordRuleInfo:hx(hx({},this.state.vectorKeywordRuleInfo),{},{rules:this.state.vectorKeywordRuleInfo.rules.filter((t=>t.pattern!==e))})},(async()=>{await this.setKeywords(this.state.vectorKeywordRuleInfo.rules.map((e=>e.pattern)),t)}))})),this.state={phase:gx.Loading,deviceNotificationsEnabled:null===(t=V.A.getValue("deviceNotificationsEnabled"))||void 0===t||t,desktopNotifications:V.A.getValue("notificationsEnabled"),desktopShowBody:V.A.getValue("notificationBodyEnabled"),audioNotifications:V.A.getValue("audioNotificationsEnabled"),clearingNotifications:!1,ruleIdsWithError:{}}}get isInhibited(){var e;return!(null===(e=this.state.masterPushRule)||void 0===e||!e.enabled)}componentDidMount(){this.settingWatchers=[V.A.watchSetting("notificationsEnabled",null,((...[,,,,e])=>this.setState({desktopNotifications:e}))),V.A.watchSetting("deviceNotificationsEnabled",null,((...[,,,,e])=>{this.setState({deviceNotificationsEnabled:e})})),V.A.watchSetting("notificationBodyEnabled",null,((...[,,,,e])=>this.setState({desktopShowBody:e}))),V.A.watchSetting("audioNotificationsEnabled",null,((...[,,,,e])=>this.setState({audioNotifications:e})))],this.refreshFromServer(),this.refreshFromAccountData()}componentWillUnmount(){this.settingWatchers.forEach((e=>V.A.unwatchSetting(e)))}componentDidUpdate(e,t){this.state.deviceNotificationsEnabled!==t.deviceNotificationsEnabled&&this.persistLocalNotificationSettings(this.state.deviceNotificationsEnabled)}async refreshFromServer(){try{const e=(await Promise.all([this.refreshRules(),this.refreshPushers(),this.refreshThreepids()])).reduce(((e,t)=>Object.assign(t,e)),{});this.setState(hx(hx({},e),{},{phase:gx.Ready}))}catch(e){o.v.error("Error setting up notifications for settings: ",e),this.setState({phase:gx.Error})}}async refreshFromAccountData(){const e=E.J.safeGet(),t=e.getAccountData((0,el.uG)(e.deviceId));if(t){const e=!t.getContent().is_silenced;await this.updateDeviceNotifications(e)}}persistLocalNotificationSettings(e){const t=E.J.safeGet();return t.setAccountData((0,el.uG)(t.deviceId),{is_silenced:!e})}async refreshRules(){const e=await E.J.safeGet().getPushRules(),t={[i.RuleId.Master]:vx.Master,[i.RuleId.DM]:vx.VectorGlobal,[i.RuleId.EncryptedDM]:vx.VectorGlobal,[i.RuleId.Message]:vx.VectorGlobal,[i.RuleId.EncryptedMessage]:vx.VectorGlobal,[i.RuleId.ContainsDisplayName]:vx.VectorMentions,[i.RuleId.ContainsUserName]:vx.VectorMentions,[i.RuleId.AtRoomNotification]:vx.VectorMentions,[i.RuleId.InviteToSelf]:vx.VectorOther,[i.RuleId.IncomingCall]:vx.VectorOther,[i.RuleId.SuppressNotices]:vx.VectorOther,[i.RuleId.Tombstone]:vx.VectorOther},n={[vx.Master]:[],[vx.VectorGlobal]:[],[vx.VectorMentions]:[],[vx.VectorOther]:[],[vx.Other]:[]};for(const i in e.global){const s=i;for(const i of e.global[s]){var r;const e=Object.assign(i,{kind:s}),o=null!==(r=t[e.rule_id])&&void 0!==r?r:vx.Other;"."===e.rule_id[0]&&n[o].push(e)}}const s={};if(!(n.master.length>0))throw new Error("Failed to locate a master push rule");s.masterPushRule=n.master[0],s.vectorKeywordRuleInfo=Ow.parseContentRules(e),s.vectorPushRules={};const o=[vx.VectorGlobal,vx.VectorMentions,vx.VectorOther];for(const e of o){s.vectorPushRules[e]=[];for(const t of n[e]){const i=Mw[t.rule_id],r=i.ruleToVectorState(t);s.vectorPushRules[e].push({ruleId:t.rule_id,rule:t,vectorState:r,syncedVectorState:Ex(n,t,i),description:(0,P._t)(i.description)})}s.vectorPushRules[e].sort(((e,t)=>{let n=yx.indexOf(e.ruleId),i=yx.indexOf(t.ruleId);return n<0&&(n=yx.length),i<0&&(i=yx.length),n-i})),e===_x&&s.vectorPushRules[e].push({ruleId:fx,description:(0,P._t)("settings|notifications|messages_containing_keywords"),vectorState:s.vectorKeywordRuleInfo.vectorState})}return s}refreshPushers(){return E.J.safeGet().getPushers()}refreshThreepids(){return E.J.safeGet().getThreePids()}showSaveError(){A.Ay.createDialog(_v.A,{title:(0,P._t)("settings|notifications|error_saving"),description:(0,P._t)("settings|notifications|error_saving_detail")})}async setKeywords(e,t){try{const n=(0,Vg.Bo)(Array.from(new Set(e))),r=(0,Vg.Bo)(Array.from(new Set(t.map((e=>e.pattern))))),s=(0,Vg.ZQ)(r,n);for(const e of s.removed)for(const n of t.filter((t=>t.pattern===e)))await E.J.safeGet().deletePushRule("global",n.kind,n.rule_id);let o=this.state.vectorKeywordRuleInfo.vectorState;if(o===Pw.Off){const e=t.length?Nw.contentRuleVectorStateKind(t[0]):void 0;o=null!=e?e:Pw.On}const a=i.PushRuleKind.ContentSpecific;for(const e of s.added)await E.J.safeGet().addPushRule("global",a,e,{actions:Nw.actionsFor(o),pattern:e}),o===Pw.Off&&await E.J.safeGet().setPushRuleEnabled("global",a,e,!1);await this.refreshFromServer()}catch(e){this.setState({phase:gx.Error}),o.v.error("Error updating keyword push rules:",e),this.showSaveError()}}renderTopSection(){const e=s.createElement(jg.A,{value:!this.isInhibited,label:(0,P._t)("settings|notifications|enable_notifications_account"),caption:(0,P._t)("settings|notifications|enable_notifications_account_detail"),onChange:this.onMasterRuleChanged,disabled:this.state.phase===gx.Persisting});if(this.isInhibited)return e;const t=(this.state.threepids||[]).filter((e=>e.medium===i.ThreepidMedium.Email)).map((e=>{var t;return s.createElement(jg.A,{key:e.address,value:!(null===(t=this.state.pushers)||void 0===t||!t.some((t=>"email"===t.kind&&t.pushkey===e.address))),label:(0,P._t)("settings|notifications|enable_email_notifications",{email:e.address}),caption:(0,P._t)("settings|notifications|enable_notifications_email_detail",{},{a:e=>s.createElement(Ae.A,{kind:"link_inline",onClick:()=>{window.open(zl.A.helpEmailNotification,"_blank")}},e)}),onChange:this.onEmailNotificationsChanged.bind(this,e.address),disabled:this.state.phase===gx.Persisting})}));return s.createElement(sC.P,null,e,s.createElement(jg.A,{value:this.state.deviceNotificationsEnabled,label:(0,P._t)("settings|notifications|enable_notifications_device"),onChange:e=>this.updateDeviceNotifications(e),disabled:this.state.phase===gx.Persisting}),this.state.deviceNotificationsEnabled&&s.createElement(s.Fragment,null,s.createElement(jg.A,{value:this.state.desktopNotifications,onChange:this.onDesktopNotificationsChanged,label:(0,P._t)("settings|notifications|enable_desktop_notifications_session"),disabled:this.state.phase===gx.Persisting}),s.createElement(jg.A,{value:this.state.desktopShowBody,onChange:this.onDesktopShowBodyChanged,label:(0,P._t)("settings|notifications|show_message_desktop_notification"),disabled:this.state.phase===gx.Persisting}),s.createElement(jg.A,{value:this.state.audioNotifications,onChange:this.onAudioNotificationsChanged,label:(0,P._t)("settings|notifications|enable_audible_notifications_session"),disabled:this.state.phase===gx.Persisting})),Vl.A.isFeatureActiveForHomeserver("feature_email_notification")?t:null)}renderCategory(e){var t;if(this.isInhibited)return null;let n;if(e===vx.VectorMentions){var i;const e=(0,Vg.Bo)((null===(i=this.state.vectorKeywordRuleInfo)||void 0===i?void 0:i.rules.map((e=>e.pattern)))||[]);n=s.createElement(dx,{tags:e,onAdd:this.onKeywordAdd,onRemove:this.onKeywordRemove,disabled:this.state.phase===gx.Persisting,label:(0,P._t)("notifications|keyword"),placeholder:(0,P._t)("notifications|keyword_new")})}const r={[Pw.On]:(0,P._t)("common|on"),[Pw.Off]:(0,P._t)("common|off"),[Pw.Loud]:(0,P._t)("settings|notifications|noisy")},o=(e,t)=>{var n;return s.createElement(jC.A,{key:e.ruleId+t,name:e.ruleId,checked:(null!==(n=e.syncedVectorState)&&void 0!==n?n:e.vectorState)===t,onChange:this.onRadioChecked.bind(this,e,t),disabled:this.state.phase===gx.Persisting,"aria-label":r[t]})},a=null===(t=this.state.vectorPushRules)||void 0===t||null===(t=t[e])||void 0===t?void 0:t.map((t=>s.createElement("fieldset",{key:e+t.ruleId,className:"mx_UserNotifSettings_gridRowContainer"},s.createElement("legend",{className:"mx_UserNotifSettings_gridRowLabel"},t.description),o(t,Pw.Off),o(t,Pw.On),o(t,Pw.Loud),this.state.ruleIdsWithError[t.ruleId]&&s.createElement("div",{className:"mx_UserNotifSettings_gridRowError"},s.createElement(ux.H,{isError:!0},(0,P._t)("settings|notifications|error_updating"))))));let l;switch(e){case vx.VectorGlobal:l=(0,P._t)("notifications|class_global");break;case vx.VectorMentions:l=(0,P._t)("notifications|mentions_keywords");break;case vx.VectorOther:l=(0,P._t)("notifications|class_other");break;default:throw new Error("Developer error: Unnamed notifications section: "+e)}return s.createElement("div",null,s.createElement("div",{className:"mx_UserNotifSettings_grid"},s.createElement(mx.r,{heading:l}),s.createElement("span",{className:"mx_UserNotifSettings_gridColumnLabel"},r[Pw.Off]),s.createElement("span",{className:"mx_UserNotifSettings_gridColumnLabel"},r[Pw.On]),s.createElement("span",{className:"mx_UserNotifSettings_gridColumnLabel"},r[Pw.Loud]),a),n)}renderTargets(){var e;if(this.isInhibited)return null;const t=null===(e=this.state.pushers)||void 0===e?void 0:e.map((e=>s.createElement("tr",{key:e.kind+e.pushkey},s.createElement("td",null,e.app_display_name),s.createElement("td",null,e.device_display_name))));return null!=t&&t.length?s.createElement("div",{className:"mx_UserNotifSettings_floatingSection"},s.createElement("div",null,(0,P._t)("settings|notifications|push_targets")),s.createElement("table",null,s.createElement("tbody",null,t))):null}render(){if(this.state.phase===gx.Loading)return s.createElement(Na.A,null);if(this.state.phase===gx.Error)return s.createElement("p",null,(0,P._t)("settings|notifications|error_loading"));let e;return E.J.safeGet().getRooms().some((e=>(0,ol.GN)(e,!0)))&&(e=s.createElement(Ae.A,{onClick:this.onClearNotificationsClicked,disabled:this.state.clearingNotifications,kind:"danger",className:"mx_UserNotifSettings_clearNotifsButton"},(0,P._t)("notifications|mark_all_read"))),s.createElement(s.Fragment,null,this.renderTopSection(),this.renderCategory(vx.VectorGlobal),this.renderCategory(vx.VectorMentions),this.renderCategory(vx.VectorOther),this.renderTargets(),s.createElement(wx,null),e)}}var Ax=n("./src/RoomNotifs.ts");function Cx(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function xx(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Cx(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Cx(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function kx(e){const t=new Map;for(const r of Object.values(i.PushRuleKind))for(const i of null!==(n=e.global[r])&&void 0!==n?n:[]){var n;i.rule_id.startsWith(".")&&t.set(i.rule_id,xx(xx({},i),{},{kind:r}))}return t}function Rx(e,t,n){var r,s;const o={updated:[],added:[],deleted:[]},a=kx(e),l=function(e,t){const n=new Map;n.set(i.RuleId.Master,{rule_id:i.RuleId.Master,kind:i.PushRuleKind.Override,enabled:e.globalMute}),n.set(i.RuleId.EncryptedMessage,{rule_id:i.RuleId.EncryptedMessage,kind:i.PushRuleKind.Underride,enabled:!0,actions:Rw.encodeActions({notify:e.defaultLevels.room===Ax.dC.AllMessages,highlight:!1})}),n.set(i.RuleId.Message,{rule_id:i.RuleId.Message,kind:i.PushRuleKind.Underride,enabled:!0,actions:Rw.encodeActions({notify:e.defaultLevels.room===Ax.dC.AllMessages,highlight:!1})}),n.set(i.RuleId.EncryptedDM,{rule_id:i.RuleId.EncryptedDM,kind:i.PushRuleKind.Underride,enabled:!0,actions:Rw.encodeActions({notify:e.defaultLevels.dm===Ax.dC.AllMessages,highlight:!1,sound:e.sound.people})}),n.set(i.RuleId.DM,{rule_id:i.RuleId.DM,kind:i.PushRuleKind.Underride,enabled:!0,actions:Rw.encodeActions({notify:e.defaultLevels.dm===Ax.dC.AllMessages,highlight:!1,sound:e.sound.people})}),n.set(i.RuleId.SuppressNotices,{rule_id:i.RuleId.SuppressNotices,kind:i.PushRuleKind.Override,enabled:!e.activity.bot_notices,actions:Tw.ACTION_DONT_NOTIFY}),n.set(i.RuleId.InviteToSelf,{rule_id:i.RuleId.InviteToSelf,kind:i.PushRuleKind.Override,enabled:e.activity.invite,actions:Rw.encodeActions({notify:!0,highlight:!1,sound:e.sound.people})}),n.set(i.RuleId.MemberEvent,{rule_id:i.RuleId.MemberEvent,kind:i.PushRuleKind.Override,enabled:!0,actions:e.activity.status_event?Tw.ACTION_NOTIFY:Tw.ACTION_DONT_NOTIFY});const r=Rw.encodeActions({notify:!0,sound:e.sound.mentions,highlight:!0}),s=e.mentions.user?r:Tw.ACTION_DONT_NOTIFY;t&&n.set(i.RuleId.IsUserMention,{rule_id:i.RuleId.IsUserMention,kind:i.PushRuleKind.Override,enabled:!0,actions:s}),n.set(i.RuleId.ContainsDisplayName,{rule_id:i.RuleId.ContainsDisplayName,kind:i.PushRuleKind.Override,enabled:!0,actions:s}),n.set(i.RuleId.ContainsUserName,{rule_id:i.RuleId.ContainsUserName,kind:i.PushRuleKind.ContentSpecific,enabled:!0,actions:s});const o=e.mentions.room?Tw.ACTION_NOTIFY:Tw.ACTION_DONT_NOTIFY;return t&&n.set(i.RuleId.IsRoomMention,{rule_id:i.RuleId.IsRoomMention,kind:i.PushRuleKind.Override,enabled:!0,actions:o}),n.set(i.RuleId.AtRoomNotification,{rule_id:i.RuleId.AtRoomNotification,kind:i.PushRuleKind.Override,enabled:!0,actions:o}),n.set(i.RuleId.Tombstone,{rule_id:i.RuleId.Tombstone,kind:i.PushRuleKind.Override,enabled:e.activity.status_event,actions:Tw.ACTION_HIGHLIGHT}),n.set(i.RuleId.IncomingCall,{rule_id:i.RuleId.IncomingCall,kind:i.PushRuleKind.Underride,enabled:!0,actions:Rw.encodeActions({notify:!0,sound:e.sound.calls})}),n}(t,n);for(const e of l.values()){const t=a.get(e.rule_id);let n=!1;if(void 0===t)n=!0;else if(void 0!==e.enabled&&e.enabled!==t.enabled)n=!0;else if(void 0!==e.actions){const i=Rw.decodeActions(t.actions),r=Rw.decodeActions(e.actions);null===i||null===r?n=!0:(0,g.ky)(r,i)||(n=!0)}n&&o.updated.push(e)}const c=Rw.encodeActions({notify:!0,sound:t.sound.mentions,highlight:!0}),d=null!==(r=null===(s=e.global.content)||void 0===s?void 0:s.filter((e=>!e.rule_id.startsWith("."))))&&void 0!==r?r:[],u=new Set(t.keywords);for(const e of d){if(u.has(e.pattern)){let n=!1;if(e.enabled!==t.mentions.keywords)n=!0;else if(void 0!==e.actions){const t=Rw.decodeActions(e.actions),i=Rw.decodeActions(c);null===t||null===i?n=!0:(0,g.ky)(i,t)||(n=!0)}n&&o.updated.push({rule_id:e.rule_id,kind:i.PushRuleKind.ContentSpecific,enabled:t.mentions.keywords,actions:c})}else o.deleted.push({rule_id:e.rule_id,kind:i.PushRuleKind.ContentSpecific});u.delete(e.pattern)}for(const e of u)o.added.push({rule_id:e,kind:i.PushRuleKind.ContentSpecific,default:!1,enabled:t.mentions.keywords,pattern:e,actions:c});return o}function Ix(e){if(0===e.length)return!0;for(const t of e){if(null==t||!1===t||!t.enabled)continue;const e=Rw.decodeActions(t.actions);if(null!==e&&e.notify)return!0}return!1}function Tx(e){if(0===e.length)return!1;for(const t of e){if(null==t||!1===t||!t.enabled)continue;const e=Rw.decodeActions(t.actions);if(null!==e&&!e.notify&&!0!==e.highlight&&void 0===e.sound)return!0}return!1}function Px(e){for(const t of e){if(null==t||!1===t||!t.enabled)continue;const e=Rw.decodeActions(t.actions);if(null!==e&&e.notify&&void 0!==e.sound)return e.sound}}function Nx(e){const t=function(){const e=(0,s.useRef)(null);return(0,s.useCallback)((t=>{let n;return n=null===e.current?t():e.current.then(t),e.current=n,n}),[])}(),n=(0,s.useMemo)((()=>e.supportsIntentionalMentions()),[e]),r=(0,s.useRef)(null),[o,a]=(0,s.useState)(null),[l,c]=(0,s.useState)(!1),d=(0,s.useCallback)((async()=>{const t=await e.getPushRules(),s=function(e,t){var n,r,s,o;const a=kx(e),l=null!==(n=null===(r=e.global.content)||void 0===r?void 0:r.filter((e=>!e.rule_id.startsWith("."))))&&void 0!==n?n:[],c=[a.get(i.RuleId.DM),a.get(i.RuleId.EncryptedDM)],d=[a.get(i.RuleId.Message),a.get(i.RuleId.EncryptedMessage)];return{globalMute:null!==(s=null===(o=a.get(i.RuleId.Master))||void 0===o?void 0:o.enabled)&&void 0!==s&&s,defaultLevels:{room:Ix(d)?Ax.dC.AllMessages:Ax.dC.MentionsOnly,dm:Ix(c)?Ax.dC.AllMessages:Ax.dC.MentionsOnly},sound:{calls:Px([a.get(i.RuleId.IncomingCall)]),mentions:Px([t&&a.get(i.RuleId.IsUserMention),a.get(i.RuleId.ContainsUserName),a.get(i.RuleId.ContainsDisplayName),...l]),people:Px(c)},activity:{bot_notices:!Tx([a.get(i.RuleId.SuppressNotices)]),invite:Ix([a.get(i.RuleId.InviteToSelf)]),status_event:Ix([a.get(i.RuleId.MemberEvent),a.get(i.RuleId.Tombstone)])},mentions:{user:Ix([t&&a.get(i.RuleId.IsUserMention),a.get(i.RuleId.ContainsUserName),a.get(i.RuleId.ContainsDisplayName)]),room:Ix([t&&a.get(i.RuleId.IsRoomMention),a.get(i.RuleId.AtRoomNotification)]),keywords:Ix(l)},keywords:l.map((e=>e.pattern))}}(t,n),o=Rx(t,s,n);r.current=t,c(o.updated.length>0||o.added.length>0||o.deleted.length>0),a(s)}),[e,n]);(0,s.useEffect)((()=>{t(d).catch((e=>console.error(e)))}),[e,t,d]);const u=(0,s.useCallback)((i=>{a(i),t((async()=>{if(null!==r.current){const t=Rx(r.current,i,n);await async function(e,t){await Promise.all(t.deleted.map((t=>e.deletePushRule("global",t.kind,t.rule_id)))),await Promise.all(t.added.map((t=>e.addPushRule("global",t.kind,t.rule_id,t)))),await Promise.all(t.updated.map((async t=>{void 0!==t.enabled&&await e.setPushRuleEnabled("global",t.kind,t.rule_id,t.enabled),void 0!==t.actions&&await e.setPushRuleActions("global",t.kind,t.rule_id,t.actions)})))}(e,t),await d()}})).catch((e=>console.error(e)))}),[t,n,e,d]);return{model:o,hasPendingChanges:l,reconcile:u}}const Dx={globalMute:!1,defaultLevels:{room:Ax.dC.AllMessages,dm:Ax.dC.AllMessages},sound:{people:"default",mentions:"default",calls:"ring"},activity:{invite:!0,status_event:!1,bot_notices:!0},mentions:{user:!0,room:!0,keywords:!0},keywords:[]};var Mx=n("./src/components/views/elements/LabelledCheckbox.tsx");function Ox({children:e,icon:t,action:n,onAction:i}){return s.createElement("div",{className:"mx_SettingsBanner"},t,s.createElement("div",{className:"mx_SettingsBanner_content"},e),n&&s.createElement(Ae.A,{kind:"primary_outline",onClick:null!=i?i:null},n))}function Lx(e,t,n){const[i,r]=(0,s.useState)(n),o=(0,s.useCallback)((()=>{let t=!1;return e().then((e=>{t||r(e)})).catch((e=>console.error(e))),()=>{t=!0}}),t);return(0,s.useEffect)(o,[o]),[i,o]}const Fx=["children"],Ux=e=>{let{children:t}=e,n=(0,Ve.A)(e,Fx);return s.createElement("div",(0,p.A)({},n,{className:"mx_SettingsIndent"}),t)};function Bx(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Vx(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Bx(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Bx(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function jx(e){return s.createElement(Ae.A,{kind:"link_inline",onClick:()=>{w.A.dispatch({action:R.r.ViewUserSettings,initialTabId:wa.v.Account})}},e)}function zx(){const e=(0,s.useMemo)((()=>({kind:"email",app_id:"m.email",app_display_name:(0,P._t)("notifications|email_pusher_app_display_name"),lang:navigator.language,data:{brand:u.Ay.get().brand}})),[]),t=(0,Pe.nH)(),[n,r]=function(e){return Lx((()=>e.getPushers().then((e=>e.pushers))),[e],[])}(t),[o,a]=function(e){return Lx((()=>e.getThreePids().then((e=>e.threepids))),[e],[])}(t),l=(0,s.useCallback)(((i,s)=>{if(s)t.setPusher(Vx(Vx({},e),{},{pushkey:i,device_display_name:i,append:!0})).catch((e=>console.error(e)));else{const e=n.find((e=>"email"===e.kind&&e.pushkey===i));e&&t.removePusher(e.pushkey,e.app_id).catch((e=>console.error(e)))}a(),r()}),[e,t,n,r,a]),c=n.filter((e=>"email"!==e.kind));return s.createElement(s.Fragment,null,s.createElement(sC.P,{className:"mx_NotificationPusherSettings",heading:(0,P._t)("settings|notifications|email_section")},s.createElement(sC.s,{className:"mx_NotificationPusherSettings_description"},(0,P._t)("settings|notifications|email_description")),s.createElement("div",{className:"mx_SettingsSubsection_description mx_NotificationPusherSettings_detail"},s.createElement(sC.s,null,(0,P._t)("settings|notifications|email_select",{},{button:jx}))),s.createElement(Ux,null,o.filter((e=>e.medium===i.ThreepidMedium.Email)).map((e=>s.createElement(Mx.A,{key:e.address,label:e.address,value:void 0!==n.find((t=>t.pushkey===e.address)),onChange:t=>l(e.address,t)}))))),c.length>0&&s.createElement(sC.P,{heading:(0,P._t)("settings|notifications|push_targets")},s.createElement("ul",null,n.filter((e=>"email"!==e.kind)).map((e=>s.createElement("li",{key:e.pushkey},e.device_display_name||e.app_display_name))))))}function Wx(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Hx(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Wx(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Wx(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Gx=function(e){return e.AllMessages="all_messages",e.PeopleMentionsKeywords="people_mentions_keywords",e.MentionsKeywords="mentions_keywords",e}(Gx||{});function Kx(e){return s.createElement("strong",null,e)}function Jx(e){return s.createElement(Ra.A,{href:"https://element.io/help#settings2"},e)}function qx(){var e;const t=(0,Pe.nH)(),n=(0,Oe.ti)("notificationsEnabled"),i=(0,Oe.ti)("notificationBodyEnabled"),r=(0,Oe.ti)("audioNotificationsEnabled"),{model:o,hasPendingChanges:a,reconcile:l}=Nx(t),c=null===o||a,d=null!=o?o:Dx,[u,m]=(0,s.useState)(!1),p=(0,Pe.nH)().getRooms().some((e=>e.getUnreadNotificationCount()>0)),h=[{value:Gx.AllMessages,label:(0,P._t)("notifications|all_messages")},{value:Gx.PeopleMentionsKeywords,label:(0,P._t)("settings|notifications|people_mentions_keywords")},{value:Gx.MentionsKeywords,label:(0,P._t)("settings|notifications|mentions_keywords_only")}];return s.createElement("div",{className:"mx_NotificationSettings2"},a&&null!==o&&s.createElement(Ox,{icon:s.createElement("img",{src:"img/element-icons/new-and-improved.65a63c7.svg",alt:"",width:12}),action:(0,P._t)("action|proceed"),onAction:()=>l(o)},(0,P._t)("settings|notifications|labs_notice_prompt",{},{strong:Kx,a:Jx})),s.createElement(rC.X,null,s.createElement("div",{className:"mx_SettingsSubsection_content mx_NotificationSettings2_flags"},s.createElement(jg.A,{label:(0,P._t)("settings|notifications|enable_notifications_account"),value:!d.globalMute,disabled:c,onChange:e=>{l(Hx(Hx({},o),{},{globalMute:!e}))}}),s.createElement(jg.A,{label:(0,P._t)("settings|notifications|enable_desktop_notifications_session"),value:n,onChange:e=>V.A.setValue("notificationsEnabled",null,ae.p.DEVICE,e)}),s.createElement(jg.A,{label:(0,P._t)("settings|notifications|desktop_notification_message_preview"),value:i,onChange:e=>V.A.setValue("notificationBodyEnabled",null,ae.p.DEVICE,e)}),s.createElement(jg.A,{label:(0,P._t)("settings|notifications|enable_audible_notifications_session"),value:r,onChange:e=>V.A.setValue("audioNotificationsEnabled",null,ae.p.DEVICE,e)})),s.createElement(sC.P,{heading:(0,P._t)("settings|notifications|default_setting_section"),description:(0,P._t)("settings|notifications|default_setting_description")},s.createElement(Cp.A,{name:"defaultNotificationLevel",value:(g=d.defaultLevels,g.room===Ax.dC.AllMessages?Gx.AllMessages:g.dm===Ax.dC.AllMessages?Gx.PeopleMentionsKeywords:Gx.MentionsKeywords),disabled:c,definitions:h,onChange:e=>{l(Hx(Hx({},o),{},{defaultLevels:Hx(Hx({},o.defaultLevels),{},{dm:e!==Gx.MentionsKeywords?Ax.dC.AllMessages:Ax.dC.MentionsOnly,room:e===Gx.AllMessages?Ax.dC.AllMessages:Ax.dC.MentionsOnly})}))}})),s.createElement(sC.P,{heading:(0,P._t)("settings|notifications|play_sound_for_section"),description:(0,P._t)("settings|notifications|play_sound_for_description")},s.createElement(Mx.A,{label:"People",value:void 0!==d.sound.people,disabled:c||d.defaultLevels.dm===Ax.dC.MentionsOnly,onChange:e=>{l(Hx(Hx({},o),{},{sound:Hx(Hx({},o.sound),{},{people:e?"default":void 0})}))}}),s.createElement(Mx.A,{label:(0,P._t)("settings|notifications|mentions_keywords"),value:void 0!==d.sound.mentions,disabled:c,onChange:e=>{l(Hx(Hx({},o),{},{sound:Hx(Hx({},o.sound),{},{mentions:e?"default":void 0})}))}}),s.createElement(Mx.A,{label:(0,P._t)("settings|notifications|voip"),value:void 0!==d.sound.calls,disabled:c,onChange:e=>{l(Hx(Hx({},o),{},{sound:Hx(Hx({},o.sound),{},{calls:e?"ring":void 0})}))}})),s.createElement(sC.P,{heading:(0,P._t)("settings|notifications|other_section")},s.createElement(Mx.A,{label:(0,P._t)("settings|notifications|invites"),value:d.activity.invite,disabled:c,onChange:e=>{l(Hx(Hx({},o),{},{activity:Hx(Hx({},o.activity),{},{invite:e})}))}}),s.createElement(Mx.A,{label:(0,P._t)("settings|notifications|room_activity"),value:d.activity.status_event,disabled:c,onChange:e=>{l(Hx(Hx({},o),{},{activity:Hx(Hx({},o.activity),{},{status_event:e})}))}}),s.createElement(Mx.A,{label:(0,P._t)("settings|notifications|notices"),value:d.activity.bot_notices,disabled:c,onChange:e=>{l(Hx(Hx({},o),{},{activity:Hx(Hx({},o.activity),{},{bot_notices:e})}))}})),s.createElement(sC.P,{heading:(0,P._t)("settings|notifications|mentions_keywords"),description:(0,P._t)("settings|notifications|keywords",{},{badge:s.createElement(cl.V,{symbol:"1",count:1,level:pa.S.Notification})})},s.createElement(Mx.A,{label:(0,P._t)("settings|notifications|notify_at_room"),value:d.mentions.room,disabled:c,onChange:e=>{l(Hx(Hx({},o),{},{mentions:Hx(Hx({},o.mentions),{},{room:e})}))}}),s.createElement(Mx.A,{label:(0,P._t)("settings|notifications|notify_mention",{mxid:t.getUserId()}),value:d.mentions.user,disabled:c,onChange:e=>{l(Hx(Hx({},o),{},{mentions:Hx(Hx({},o.mentions),{},{user:e})}))}}),s.createElement(Mx.A,{label:(0,P._t)("settings|notifications|notify_keyword"),byline:(0,P._t)("settings|notifications|keywords_prompt"),value:d.mentions.keywords,disabled:c,onChange:e=>{l(Hx(Hx({},o),{},{mentions:Hx(Hx({},o.mentions),{},{keywords:e})}))}}),s.createElement(dx,{id:"mx_NotificationSettings2_Keywords",tags:null!==(e=null==o?void 0:o.keywords)&&void 0!==e?e:[],disabled:c,onAdd:e=>{l(Hx(Hx({},o),{},{keywords:[e,...o.keywords]}))},onRemove:e=>{l(Hx(Hx({},o),{},{keywords:o.keywords.filter((t=>t!==e))}))},label:(0,P._t)("notifications|keyword"),placeholder:(0,P._t)("notifications|keyword_new")}),s.createElement(mC.A,{name:"Notifications.showbold",level:ae.p.DEVICE}),s.createElement(mC.A,{name:"Notifications.tac_only_notifications",level:ae.p.DEVICE})),s.createElement(zx,null),s.createElement(sC.P,{heading:(0,P._t)("settings|notifications|quick_actions_section")},p&&s.createElement(Ae.A,{kind:"primary_outline",disabled:u,onClick:async()=>{m(!0),await(0,el.XC)(t),m(!1)}},(0,P._t)("settings|notifications|quick_actions_mark_all_read")),s.createElement(Ae.A,{kind:"danger_outline",disabled:null===o,onClick:()=>{l(Dx)}},(0,P._t)("settings|notifications|quick_actions_reset")))));var g}class $x extends s.Component{render(){const e=V.A.getValue(Nl.O5.NotificationSettings2);return s.createElement(iC.A,null,e?s.createElement(qx,null):s.createElement(rC.X,null,s.createElement(Sx,null)))}}class Yx extends s.Component{constructor(e){super(e),(0,h.A)(this,"onSearchChange",(e=>{this.setState({searchQuery:e})})),this.state={searchQuery:"",langs:null}}componentDidMount(){if(P.om().then((e=>{e.sort((function(e,t){return e.labelInTargetLanguage<t.labelInTargetLanguage?-1:e.labelInTargetLanguage>t.labelInTargetLanguage?1:0})),this.setState({langs:e})})).catch((()=>{this.setState({langs:[{value:"en",label:"English",labelInTargetLanguage:"English"}]})})),!this.props.value){const e=P.mf();this.props.onOptionChange(e)}}render(){if(null===this.state.langs)return s.createElement(Na.A,null);let e;e=this.state.searchQuery?this.state.langs.filter((e=>function(e,t){return!!t.labelInTargetLanguage.toUpperCase().includes(e.toUpperCase())||!!t.label.toUpperCase().includes(e.toUpperCase())||t.value.toUpperCase()===e.toUpperCase()}(this.state.searchQuery,e))):this.state.langs;const t=e.map((e=>s.createElement("div",{key:e.value},e.labelInTargetLanguage)));let n,i=V.A.getValue("language",null,!0);return i||(i=navigator.language||navigator.userLanguage),n=this.props.value||i,s.createElement(MA.A,{id:"mx_LanguageDropdown",className:re()("mx_LanguageDropdown",this.props.className),onOptionChange:this.props.onOptionChange,onSearchChange:this.onSearchChange,searchEnabled:!0,value:n,label:(0,P._t)("language_dropdown_label"),disabled:this.props.disabled},t)}}class Zx extends s.Component{constructor(e){super(e),this.onSearchChange=this.onSearchChange.bind(this),this.state={searchQuery:""}}componentDidMount(){const e=l.A.get();if(e){var t;const n=new Intl.DisplayNames([(0,P.mf)()],{type:"language",style:"short"});null===(t=e.getAvailableSpellCheckLanguages())||void 0===t||t.then((e=>{e.sort((function(e,t){return e<t?-1:e>t?1:0}));const t=[];e.forEach((e=>{t.push({label:n.of(e),value:e})})),this.setState({languages:t})})).catch((e=>{this.setState({languages:[{value:"en",label:n.of("en")}]})}))}}onSearchChange(e){this.setState({searchQuery:e})}render(){if(!this.state.languages)return s.createElement(Na.A,null);let e;e=this.state.searchQuery?this.state.languages.filter((e=>function(e,t){return!!t.label.toUpperCase().includes(e.toUpperCase())||t.value.toUpperCase()===e.toUpperCase()}(this.state.searchQuery,e))):this.state.languages;const t=e.map((e=>s.createElement("div",{key:e.value},e.label)));let n,i=V.A.getValue("language",null,!0);return i||(i=navigator.language||navigator.userLanguage),n=this.props.value||i,s.createElement(MA.A,{id:"mx_LanguageDropdown",className:this.props.className,onOptionChange:this.props.onOptionChange,onSearchChange:this.onSearchChange,searchEnabled:!0,value:n,label:(0,P._t)("language_dropdown_label"),placeholder:(0,P._t)("settings|general|spell_check_locale_placeholder")},t)}}class Xx extends s.Component{constructor(...e){super(...e),(0,h.A)(this,"onRemove",(e=>(e.stopPropagation(),e.preventDefault(),this.props.onRemoved(this.props.language))))}render(){var e;return s.createElement("div",{className:"mx_ExistingSpellCheckLanguage"},s.createElement("span",{className:"mx_ExistingSpellCheckLanguage_language"},null!==(e=this.props.label)&&void 0!==e?e:this.props.language),s.createElement(Ae.A,{onClick:this.onRemove,kind:"danger_sm"},(0,P._t)("action|remove")))}}class Qx extends s.Component{constructor(e){super(e),(0,h.A)(this,"onRemoved",(e=>{const t=this.props.languages.filter((t=>t!==e));this.props.onLanguagesChange(t)})),(0,h.A)(this,"onAddClick",(e=>{e.stopPropagation(),e.preventDefault();const t=this.state.newLanguage;this.setState({newLanguage:""}),t&&(this.props.languages.includes(t)||(this.props.languages.push(t),this.props.onLanguagesChange(this.props.languages)))})),(0,h.A)(this,"onNewLanguageChange",(e=>{this.state.newLanguage!==e&&this.setState({newLanguage:e})})),this.state={newLanguage:""}}render(){const e=new Intl.DisplayNames([(0,P.mf)()],{type:"language",style:"short"}),t=this.props.languages.map((t=>s.createElement(Xx,{language:t,label:e.of(t),onRemoved:this.onRemoved,key:t}))),n=s.createElement(Ae.A,{onClick:this.onAddClick,kind:"primary"},(0,P._t)("action|add"));return s.createElement(s.Fragment,null,t,s.createElement("form",{onSubmit:this.onAddClick,noValidate:!0},s.createElement(Zx,{className:"mx_GeneralUserSettingsTab_spellCheckLanguageInput",value:this.state.newLanguage,onOptionChange:this.onNewLanguageChange}),n))}}const ek=()=>{const[e,t]=(0,s.useState)((0,P.UK)()),n=(0,s.useCallback)((n=>{if(e===n)return;V.A.setValue("language",null,ae.p.DEVICE,n),t(n);const i=l.A.get();i&&(i.setLanguage([n]),i.reload())}),[e]);return s.createElement("div",{className:"mx_SettingsSubsection_dropdown"},(0,P._t)("settings|general|application_language"),s.createElement(Yx,{onOptionChange:n,value:e}),s.createElement("div",{className:"mx_PreferencesUserSettingsTab_section_hint"},(0,P._t)("settings|general|application_language_reload_hint")))},tk=()=>{var e;const[t,n]=(0,s.useState)(),[i,r]=(0,s.useState)();(0,s.useEffect)((()=>{(async()=>{const e=l.A.get(),[t,i]=await Promise.all([null==e?void 0:e.getSpellCheckEnabled(),null==e?void 0:e.getSpellCheckLanguages()]);n(t),r(i||void 0)})()}),[]);const o=(0,s.useCallback)((e=>{var t;n(e),null===(t=l.A.get())||void 0===t||t.setSpellCheckEnabled(e)}),[]),a=(0,s.useCallback)((e=>{var t;r(e),null===(t=l.A.get())||void 0===t||t.setSpellCheckLanguages(e)}),[]);return null!==(e=l.A.get())&&void 0!==e&&e.supportsSpellCheckSettings()?s.createElement(s.Fragment,null,s.createElement(jg.A,{label:(0,P._t)("settings|general|allow_spellcheck"),value:Boolean(t),onChange:o}),t&&void 0!==i&&!se.vL&&s.createElement(Qx,{languages:i,onLanguagesChange:a})):null};class nk extends s.Component{constructor(e){super(e),(0,h.A)(this,"onTimezoneChange",(e=>{this.setState({timezone:e}),du.nY(e)})),(0,h.A)(this,"onTimezoneSearchChange",(e=>{const t=e.toLowerCase(),n=t?du.QG().filter((e=>e.toLowerCase().includes(t))):du.QG();this.setState({timezones:n,timezoneSearch:t})})),(0,h.A)(this,"onAutocompleteDelayChange",(e=>{this.setState({autocompleteDelay:e.target.value}),V.A.setValue("autocompleteDelay",null,ae.p.DEVICE,e.target.value)})),(0,h.A)(this,"onReadMarkerInViewThresholdMs",(e=>{this.setState({readMarkerInViewThresholdMs:e.target.value}),V.A.setValue("readMarkerInViewThresholdMs",null,ae.p.DEVICE,e.target.value)})),(0,h.A)(this,"onReadMarkerOutOfViewThresholdMs",(e=>{this.setState({readMarkerOutOfViewThresholdMs:e.target.value}),V.A.setValue("readMarkerOutOfViewThresholdMs",null,ae.p.DEVICE,e.target.value)})),(0,h.A)(this,"onKeyboardShortcutsClicked",(()=>{w.A.dispatch({action:R.r.ViewUserSettings,initialTabId:wa.v.Keyboard})})),this.state={timezone:du.dB(),timezones:du.QG(),timezoneSearch:void 0,autocompleteDelay:V.A.getValueAt(ae.p.DEVICE,"autocompleteDelay").toString(10),readMarkerInViewThresholdMs:V.A.getValueAt(ae.p.DEVICE,"readMarkerInViewThresholdMs").toString(10),readMarkerOutOfViewThresholdMs:V.A.getValueAt(ae.p.DEVICE,"readMarkerOutOfViewThresholdMs").toString(10)}}renderGroup(e,t=ae.p.ACCOUNT){return e.map((e=>s.createElement(mC.A,{key:e,name:e,level:t})))}render(){const e=V.A.getValue("FTUE.useCaseSelection"),t=nk.ROOM_LIST_SETTINGS.filter((t=>"FTUE.userOnboardingButton"!==t||Zd(e))),n=(0,P._t)("settings|preferences|default_timezone",{timezone:du.cf()}),i=this.state.timezones.map((e=>s.createElement("div",{key:e},e)));return i.unshift(s.createElement("div",{key:""},n)),s.createElement(iC.A,null,s.createElement(rC.X,null,s.createElement(sC.P,{heading:(0,P._t)("settings|general|language_section")},s.createElement(ek,null),s.createElement(tk,null)),t.length>0&&s.createElement(sC.P,{heading:(0,P._t)("settings|preferences|room_list_heading")},this.renderGroup(t)),s.createElement(sC.P,{heading:(0,P._t)("common|spaces")},this.renderGroup(nk.SPACES_SETTINGS,ae.p.ACCOUNT)),s.createElement(sC.P,{heading:(0,P._t)("settings|preferences|keyboard_heading"),description:(0,P._t)("settings|preferences|keyboard_view_shortcuts_button",{},{a:e=>s.createElement(Ae.A,{kind:"link_inline",onClick:this.onKeyboardShortcutsClicked},e)})},this.renderGroup(nk.KEYBINDINGS_SETTINGS)),s.createElement(sC.P,{heading:(0,P._t)("settings|preferences|time_heading")},s.createElement("div",{className:"mx_SettingsSubsection_dropdown"},(0,P._t)("settings|preferences|user_timezone"),s.createElement(MA.A,{id:"mx_dropdownUserTimezone",className:"mx_dropdownUserTimezone",searchEnabled:!0,value:this.state.timezone,label:(0,P._t)("settings|preferences|user_timezone"),placeholder:n,onOptionChange:this.onTimezoneChange,onSearchChange:this.onTimezoneSearchChange},i)),this.renderGroup(nk.TIME_SETTINGS),s.createElement(mC.A,{name:"userTimezonePublish",level:ae.p.DEVICE})),s.createElement(sC.P,{heading:(0,P._t)("common|presence"),description:(0,P._t)("settings|preferences|presence_description")},this.renderGroup(nk.PRESENCE_SETTINGS)),s.createElement(sC.P,{heading:(0,P._t)("settings|preferences|composer_heading")},this.renderGroup(nk.COMPOSER_SETTINGS)),s.createElement(sC.P,{heading:(0,P._t)("settings|preferences|code_blocks_heading")},this.renderGroup(nk.CODE_BLOCKS_SETTINGS)),s.createElement(sC.P,{heading:(0,P._t)("settings|preferences|media_heading")},this.renderGroup(nk.IMAGES_AND_VIDEOS_SETTINGS)),s.createElement(sC.P,{heading:(0,P._t)("common|timeline")},this.renderGroup(nk.TIMELINE_SETTINGS)),s.createElement(sC.P,{heading:(0,P._t)("settings|preferences|room_directory_heading")},this.renderGroup(nk.ROOM_DIRECTORY_SETTINGS)),s.createElement(sC.P,{heading:(0,P._t)("common|general"),stretchContent:!0},this.renderGroup(nk.GENERAL_SETTINGS),s.createElement(mC.A,{name:"Electron.showTrayIcon",level:ae.p.PLATFORM,hideIfCannotSet:!0}),s.createElement(mC.A,{name:"Electron.enableHardwareAcceleration",level:ae.p.PLATFORM,hideIfCannotSet:!0,label:(0,P._t)("settings|preferences|Electron.enableHardwareAcceleration",{appName:u.Ay.get().brand})}),s.createElement(mC.A,{name:"Electron.alwaysShowMenuBar",level:ae.p.PLATFORM,hideIfCannotSet:!0}),s.createElement(mC.A,{name:"Electron.autoLaunch",level:ae.p.PLATFORM,hideIfCannotSet:!0}),s.createElement(mC.A,{name:"Electron.warnBeforeExit",level:ae.p.PLATFORM,hideIfCannotSet:!0}),s.createElement(Sa.A,{label:(0,P._t)("settings|preferences|autocomplete_delay"),type:"number",value:this.state.autocompleteDelay,onChange:this.onAutocompleteDelayChange}),s.createElement(Sa.A,{label:(0,P._t)("settings|preferences|rm_lifetime"),type:"number",value:this.state.readMarkerInViewThresholdMs,onChange:this.onReadMarkerInViewThresholdMs}),s.createElement(Sa.A,{label:(0,P._t)("settings|preferences|rm_lifetime_offscreen"),type:"number",value:this.state.readMarkerOutOfViewThresholdMs,onChange:this.onReadMarkerOutOfViewThresholdMs}))))}}(0,h.A)(nk,"ROOM_LIST_SETTINGS",["breadcrumbs","FTUE.userOnboardingButton"]),(0,h.A)(nk,"SPACES_SETTINGS",["Spaces.allRoomsInHome"]),(0,h.A)(nk,"KEYBINDINGS_SETTINGS",["ctrlFForSearch"]),(0,h.A)(nk,"PRESENCE_SETTINGS",["sendReadReceipts","sendTypingNotifications"]),(0,h.A)(nk,"COMPOSER_SETTINGS",["MessageComposerInput.autoReplaceEmoji","MessageComposerInput.useMarkdown","MessageComposerInput.suggestEmoji","MessageComposerInput.ctrlEnterToSend","MessageComposerInput.surroundWith","MessageComposerInput.showStickersButton","MessageComposerInput.insertTrailingColon"]),(0,h.A)(nk,"TIME_SETTINGS",["showTwelveHourTimestamps","alwaysShowTimestamps"]),(0,h.A)(nk,"CODE_BLOCKS_SETTINGS",["enableSyntaxHighlightLanguageDetection","expandCodeByDefault","showCodeLineNumbers"]),(0,h.A)(nk,"IMAGES_AND_VIDEOS_SETTINGS",["urlPreviewsEnabled","autoplayGifs","autoplayVideo","showImages"]),(0,h.A)(nk,"TIMELINE_SETTINGS",["showTypingNotifications","showRedactions","showReadReceipts","showJoinLeaves","showDisplaynameChanges","showChatEffects","showAvatarChanges","Pill.shouldShowPillAvatar","TextualBody.enableBigEmoji","scrollToBottomOnMessageSent","useOnlyCurrentProfiles"]),(0,h.A)(nk,"ROOM_DIRECTORY_SETTINGS",["SpotlightSearch.showNsfwPublicRooms"]),(0,h.A)(nk,"GENERAL_SETTINGS",["promptBeforeInviteUnknownUsers"]);const ik=e=>{switch(e){case oe.cm.AudioOutput:return oe.Ay.getAudioOutput();case oe.cm.AudioInput:return oe.Ay.getAudioInput();case oe.cm.VideoInput:return oe.Ay.getVideoInput()}};class rk extends s.Component{constructor(e,t){super(e,t),(0,h.A)(this,"refreshMediaDevices",(async e=>{var t;this.setState({mediaDevices:null!==(t=await oe.Ay.getDevices())&&void 0!==t?t:null,[oe.cm.AudioOutput]:ik(oe.cm.AudioOutput),[oe.cm.AudioInput]:ik(oe.cm.AudioInput),[oe.cm.VideoInput]:ik(oe.cm.VideoInput)}),e&&e.getTracks().forEach((e=>e.stop()))})),(0,h.A)(this,"requestMediaPermissions",(async()=>{const e=await(async(e=!0)=>{let t,n;try{t=await navigator.mediaDevices.getUserMedia({audio:!0,video:e})}catch(i){if(e&&"NotFoundError"===i.name)try{t=await navigator.mediaDevices.getUserMedia({audio:!0})}catch(e){n=e}else n=i}if(n){o.v.log("Failed to list userMedia devices",n);const e=u.Ay.get().brand;A.Ay.createDialog(_v.A,{title:(0,P._t)("voip|no_media_perms_title"),description:(0,P._t)("voip|no_media_perms_description",{brand:e})})}return t})();e&&await this.refreshMediaDevices(e)})),(0,h.A)(this,"setDevice",(async(e,t)=>{this.setState({[t]:e});try{await oe.Ay.instance.setDevice(e,t)}catch{o.v.error(`Failed to set device ${t}: ${e}`),this.setState({[t]:ik(t)})}})),(0,h.A)(this,"changeWebRtcMethod",(e=>{this.context.setForceTURN(!e)})),this.state={mediaDevices:null,[oe.cm.AudioOutput]:null,[oe.cm.AudioInput]:null,[oe.cm.VideoInput]:null,audioAutoGainControl:oe.Ay.getAudioAutoGainControl(),audioEchoCancellation:oe.Ay.getAudioEchoCancellation(),audioNoiseSuppression:oe.Ay.getAudioNoiseSuppression()}}async componentDidMount(){await oe.Ay.hasAnyLabeledDevices()&&await this.refreshMediaDevices()}renderDeviceOptions(e,t){return e.map((e=>s.createElement("option",{key:`${t}-${e.deviceId}`,value:e.deviceId},e.label)))}renderDropdown(e,t){var n;const i=null===(n=this.state.mediaDevices)||void 0===n?void 0:n[e].slice(0);if(null==i||!i.length)return null;const r=oe.Ay.getDefaultDevice(i);return s.createElement(Sa.A,{element:"select",label:t,value:this.state[e]||r,onChange:t=>this.setDevice(t.target.value,e)},this.renderDeviceOptions(i,e))}render(){let e,t,n,i;return this.state.mediaDevices?this.state.mediaDevices&&(t=this.renderDropdown(oe.cm.AudioOutput,(0,P._t)("settings|voip|audio_output"))||s.createElement("p",null,(0,P._t)("settings|voip|audio_output_empty")),n=this.renderDropdown(oe.cm.AudioInput,(0,P._t)("common|microphone"))||s.createElement("p",null,(0,P._t)("settings|voip|audio_input_empty")),i=this.renderDropdown(oe.cm.VideoInput,(0,P._t)("common|camera"))||s.createElement("p",null,(0,P._t)("settings|voip|video_input_empty"))):e=s.createElement("div",null,s.createElement("p",null,(0,P._t)("settings|voip|missing_permissions_prompt")),s.createElement(Ae.A,{onClick:this.requestMediaPermissions,kind:"primary"},(0,P._t)("settings|voip|request_permissions"))),s.createElement(iC.A,null,s.createElement(rC.X,null,e,s.createElement(sC.P,{heading:(0,P._t)("settings|voip|voice_section"),stretchContent:!0},t,n,s.createElement(jg.A,{value:this.state.audioAutoGainControl,onChange:async e=>{await oe.Ay.setAudioAutoGainControl(e),this.setState({audioAutoGainControl:oe.Ay.getAudioAutoGainControl()})},label:(0,P._t)("settings|voip|voice_agc")})),s.createElement(sC.P,{heading:(0,P._t)("settings|voip|video_section"),stretchContent:!0},i,s.createElement(mC.A,{name:"VideoView.flipVideoHorizontally",level:ae.p.ACCOUNT}))),s.createElement(rC.X,{heading:(0,P._t)("common|advanced")},s.createElement(sC.P,{heading:(0,P._t)("settings|voip|voice_processing")},s.createElement(jg.A,{value:this.state.audioNoiseSuppression,onChange:async e=>{await oe.Ay.setAudioNoiseSuppression(e),this.setState({audioNoiseSuppression:oe.Ay.getAudioNoiseSuppression()})},label:(0,P._t)("settings|voip|noise_suppression")}),s.createElement(jg.A,{value:this.state.audioEchoCancellation,onChange:async e=>{await oe.Ay.setAudioEchoCancellation(e),this.setState({audioEchoCancellation:oe.Ay.getAudioEchoCancellation()})},label:(0,P._t)("settings|voip|echo_cancellation")})),s.createElement(sC.P,{heading:(0,P._t)("settings|voip|connection_section")},s.createElement(mC.A,{name:"webRtcAllowPeerToPeer",level:ae.p.DEVICE,onChange:this.changeWebRtcMethod}),s.createElement(mC.A,{name:"fallbackICEServerAllowed",label:(0,P._t)("settings|voip|enable_fallback_ice_server",{server:new URL(su.ZB).pathname}),level:ae.p.DEVICE,hideIfCannotSet:!0}))))}}(0,h.A)(rk,"contextType",Pe.Ay);var sk=n("./src/BasePlatform.ts");const ok=["action"];function ak(){var e;null===(e=l.A.get())||void 0===e||e.installUpdate()}const lk=[sk.Kn.Ready,sk.Kn.Error,sk.Kn.NotAvailable],ck=()=>{const[e,t]=(0,s.useState)(null);(0,De.F)(w.A,(e=>{let{action:n}=e,i=(0,Ve.A)(e,ok);n===R.r.CheckUpdates&&t(i)}));const n=!!e&&!lk.includes(e.status);let i;return e&&(i=s.createElement("span",{className:"mx_UpdateCheckButton_summary"},function(e,t){switch(e){case sk.Kn.Error:return(0,P._t)("update|error_encountered",{errorDetail:t});case sk.Kn.Checking:return(0,P._t)("update|checking");case sk.Kn.NotAvailable:return(0,P._t)("update|no_update");case sk.Kn.Downloading:return(0,P._t)("update|downloading");case sk.Kn.Ready:return(0,P._t)("update|new_version_available",{},{a:e=>s.createElement(Ae.A,{kind:"link_inline",onClick:ak},e)})}}(e.status,e.detail),n&&s.createElement(He.A,null))),s.createElement(s.Fragment,null,s.createElement(Ae.A,{onClick:()=>{var e;t(null),null===(e=l.A.get())||void 0===e||e.startUpdateCheck()},kind:"primary_outline",disabled:n},(0,P._t)("update|check_action")),i)};class dk extends s.Component{constructor(e){super(e),(0,h.A)(this,"context",void 0),(0,h.A)(this,"onClearCacheAndReload",(()=>{l.A.get()&&(o.v.log("Clear cache & reload clicked"),this.context.stopClient(),this.context.store.deleteAllData().then((()=>{var e;null===(e=l.A.get())||void 0===e||e.reload()})))})),(0,h.A)(this,"onBugReport",(()=>{A.Ay.createDialog(Aa.A,{})})),(0,h.A)(this,"getVersionTextToCopy",(()=>{const{appVersion:e,cryptoVersion:t}=this.getVersionInfo();return`${e}\n${t}`})),this.state={appVersion:null,canUpdate:!1}}componentDidMount(){var e,t;null===(e=l.A.get())||void 0===e||e.getAppVersion().then((e=>this.setState({appVersion:e}))).catch((e=>{o.v.error("Error getting vector version: ",e)})),null===(t=l.A.get())||void 0===t||t.canSelfUpdate().then((e=>this.setState({canUpdate:e}))).catch((e=>{o.v.error("Error getting self updatability: ",e)}))}getVersionInfo(){var e,t;const n=u.Ay.get().brand,i=this.state.appVersion||"unknown",r=null!==(e=null===(t=this.context.getCrypto())||void 0===t?void 0:t.getVersion())&&void 0!==e?e:"<not-enabled>";return{appVersion:`${(0,P._t)("setting|help_about|brand_version",{brand:n})} ${i}`,cryptoVersion:`${(0,P._t)("setting|help_about|crypto_version")} ${r}`}}renderLegal(){const e=u.Ay.get().terms_and_conditions_links;if(!e)return null;const t=[];for(const n of e)t.push(s.createElement("div",{key:n.url},s.createElement(Ra.A,{href:n.url,target:"_blank",rel:"noreferrer noopener"},(0,P._t)(n.text))));return s.createElement("div",{className:"mx_SettingsTab_section"},s.createElement("span",{className:"mx_SettingsTab_subheading"},(0,P._t)("common|legal")),s.createElement("div",{className:"mx_SettingsTab_subsectionText"},t))}renderCredits(){return s.createElement("div",{className:"mx_SettingsTab_section"},s.createElement("span",{className:"mx_SettingsTab_subheading"},(0,P._t)("common|credits")),s.createElement("ul",{className:"mx_SettingsTab_subsectionText"},s.createElement("li",null,"The"," ",s.createElement("a",{href:"themes/element/img/backgrounds/lake.jpg",rel:"noreferrer noopener",target:"_blank"},"default cover photo")," ","is Â©Â ",s.createElement("a",{href:"https://www.flickr.com/golan",rel:"noreferrer noopener",target:"_blank"},"JesÃºs Roncero")," ","used under the terms ofÂ ",s.createElement("a",{href:"https://creativecommons.org/licenses/by-sa/4.0/",rel:"noreferrer noopener",target:"_blank"},"CC-BY-SA 4.0"),"."),s.createElement("li",null,"The"," ",s.createElement("a",{href:"https://github.com/matrix-org/twemoji-colr",rel:"noreferrer noopener",target:"_blank"},"twemoji-colr")," ","font is Â©Â ",s.createElement("a",{href:"https://mozilla.org",rel:"noreferrer noopener",target:"_blank"},"Mozilla Foundation")," ","used under the terms ofÂ ",s.createElement("a",{href:"https://www.apache.org/licenses/LICENSE-2.0",rel:"noreferrer noopener",target:"_blank"},"Apache 2.0"),"."),s.createElement("li",null,"The"," ",s.createElement("a",{href:"https://twemoji.twitter.com/",rel:"noreferrer noopener",target:"_blank"},"Twemoji")," ","emoji art is Â©Â ",s.createElement("a",{href:"https://twemoji.twitter.com/",rel:"noreferrer noopener",target:"_blank"},"Twitter, Inc and other contributors")," ","used under the terms ofÂ ",s.createElement("a",{href:"https://creativecommons.org/licenses/by/4.0/",rel:"noreferrer noopener",target:"_blank"},"CC-BY 4.0"),".")))}render(){let e,t;this.state.canUpdate&&(e=s.createElement(ck,null)),u.Ay.get().bug_report_endpoint_url&&(t=s.createElement("div",{className:"mx_SettingsTab_section"},s.createElement("span",{className:"mx_SettingsTab_subheading"},(0,P._t)("bug_reporting|title")),s.createElement("div",{className:"mx_SettingsTab_subsectionText"},s.createElement("p",null,(0,P._t)("If you've submitted a bug to the Tchap team (via support or GitHub), debug logs can help us track down the problem.")),s.createElement("p",null,(0,P._t)("bug_reporting|description"))),s.createElement(Ae.A,{onClick:this.onBugReport,kind:"primary"},(0,P._t)("bug_reporting|submit_debug_logs")),s.createElement("div",{className:"mx_SettingsTab_subsectionText"},(0,P._t)("bug_reporting|matrix_security_issue",{},{a:e=>s.createElement("a",{href:"https://matrix.org/security-disclosure-policy/",rel:"noreferrer noopener",target:"_blank"},e)}))));const{appVersion:n,cryptoVersion:i}=this.getVersionInfo(),r="support@tchap.beta.gouv.fr",o=s.createElement("div",{className:"mx_SettingsTab_section"},s.createElement("span",{className:"mx_SettingsTab_subheading"},(0,P._t)("Contact us")),s.createElement("div",{className:"mx_SettingsTab_subsectionText"},(0,P._t)("If you have any difficulties with using Tchap, please contact us by email at <b>%(supportEmail)s</b>",{supportEmail:r},{b:e=>s.createElement("b",null,e)})),s.createElement(Ae.A,{kind:"primary",element:"a",href:"mailto:"+r,target:"_blank",rel:"noreferrer noopener"},(0,P._t)("Contact us"),s.createElement("i",{className:"mx_ExternalLink_icon"}))),a=s.createElement("div",{className:"mx_SettingsTab_section"},s.createElement("span",{className:"mx_SettingsTab_subheading"},(0,P._t)("Frequently Asked Questions (FAQ)")),s.createElement("div",{className:"mx_SettingsTab_subsectionText"},(0,P._t)("We have compiled a list of the questions our users ask the most frequently. Your question may be answered there.")),s.createElement(Ae.A,{kind:"primary",element:"a",href:"https://www.tchap.gouv.fr/faq",target:"_blank",rel:"noreferrer noopener"},(0,P._t)("Read the FAQ"),s.createElement("i",{className:"mx_ExternalLink_icon"}))),l=s.createElement("div",{className:"mx_SettingsTab_section"},s.createElement("span",{className:"mx_SettingsTab_subheading"},(0,P._t)("Known issues")),s.createElement("div",{className:"mx_SettingsTab_subsectionText"},(0,P._t)("This version of Tchap Web is currently in development. There are known issues that will be solved soon.")),s.createElement(Ae.A,{kind:"primary",element:"a",href:"https://github.com/tchapgouv/tchap-web-v4/wiki/Nouveau-Tchap-Web",target:"_blank",rel:"noreferrer noopener"},(0,P._t)("Read the Known Issues"),s.createElement("i",{className:"mx_ExternalLink_icon"})));return s.createElement("div",{className:"mx_SettingsTab mx_HelpUserSettingsTab"},s.createElement("div",{className:"mx_SettingsTab_heading"},(0,P._t)("setting|help_about|title")),o,a,l,t,s.createElement("div",{className:"mx_SettingsTab_section"},s.createElement("span",{className:"mx_SettingsTab_subheading"},(0,P._t)("setting|help_about|versions")),s.createElement("div",{className:"mx_SettingsTab_subsectionText"},s.createElement(fA.A,{getTextToCopy:this.getVersionTextToCopy},n,s.createElement("br",null),i,s.createElement("br",null)),e)),this.renderLegal(),this.renderCredits(),s.createElement("div",{className:"mx_SettingsTab_section"},s.createElement("span",{className:"mx_SettingsTab_subheading"},(0,P._t)("common|advanced")),s.createElement("div",{className:"mx_SettingsTab_subsectionText"},s.createElement("div",null,(0,P._t)("setting|help_about|homeserver",{homeserverUrl:this.context.getHomeserverUrl()},{code:e=>s.createElement("code",null,e)})),s.createElement("div",null,this.context.getIdentityServerUrl()&&(0,P._t)("setting|help_about|identity_server",{identityServerUrl:this.context.getIdentityServerUrl()},{code:e=>s.createElement("code",null,e)})),s.createElement("details",null,s.createElement("summary",null,(0,P._t)("common|access_token")),s.createElement("b",null,(0,P._t)("setting|help_about|access_token_detail")),s.createElement(fA.A,{getTextToCopy:()=>this.context.getAccessToken()},this.context.getAccessToken())),s.createElement(Ae.A,{onClick:this.onClearCacheAndReload,kind:"danger"},(0,P._t)("setting|help_about|clear_cache_reload")))))}}(0,h.A)(dk,"contextType",Pe.Ay);var uk=n("./src/mjolnir/Mjolnir.ts"),mk=n("./src/mjolnir/BanList.ts");class pk extends s.Component{constructor(e){super(e),(0,h.A)(this,"onPersonalRuleChanged",(e=>{this.setState({newPersonalRule:e.target.value})})),(0,h.A)(this,"onNewListChanged",(e=>{this.setState({newList:e.target.value})})),(0,h.A)(this,"onAddPersonalRule",(async e=>{e.preventDefault(),e.stopPropagation();let t=mk.fy;this.state.newPersonalRule.startsWith("@")&&(t=mk.ZZ),this.setState({busy:!0});try{const e=await uk.u.sharedInstance().getOrCreatePersonalList();await e.banEntity(t,this.state.newPersonalRule,(0,P._t)("labs_mjolnir|ban_reason")),this.setState({newPersonalRule:""})}catch(e){o.v.error(e),A.Ay.createDialog(_v.A,{title:(0,P._t)("labs_mjolnir|error_adding_ignore"),description:(0,P._t)("labs_mjolnir|something_went_wrong")})}finally{this.setState({busy:!1})}})),(0,h.A)(this,"onSubscribeList",(async e=>{e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});try{const e=await E.J.safeGet().joinRoom(this.state.newList);await uk.u.sharedInstance().subscribeToList(e.roomId),this.setState({newList:""})}catch(e){o.v.error(e),A.Ay.createDialog(_v.A,{title:(0,P._t)("labs_mjolnir|error_adding_list_title"),description:(0,P._t)("labs_mjolnir|error_adding_list_description")})}finally{this.setState({busy:!1})}})),this.state={busy:!1,newPersonalRule:"",newList:""}}async removePersonalRule(e){this.setState({busy:!0});try{const t=uk.u.sharedInstance().getPersonalList();await t.unbanEntity(e.kind,e.entity)}catch(e){o.v.error(e),A.Ay.createDialog(_v.A,{title:(0,P._t)("labs_mjolnir|error_removing_ignore"),description:(0,P._t)("labs_mjolnir|something_went_wrong")})}finally{this.setState({busy:!1})}}async unsubscribeFromList(e){this.setState({busy:!0});try{await uk.u.sharedInstance().unsubscribeFromList(e.roomId),await E.J.safeGet().leave(e.roomId)}catch(e){o.v.error(e),A.Ay.createDialog(_v.A,{title:(0,P._t)("labs_mjolnir|error_removing_list_title"),description:(0,P._t)("labs_mjolnir|error_removing_list_description")})}finally{this.setState({busy:!1})}}viewListRules(e){const t=E.J.safeGet().getRoom(e.roomId),n=t?t.name:e.roomId,i=e=>{if(0===e.length)return s.createElement("i",null,(0,P._t)("labs_mjolnir|rules_empty"));const t=[];for(const n of e)t.push(s.createElement("li",{key:n.kind+n.entity},s.createElement("code",null,n.entity)));return s.createElement("ul",null,t)};A.Ay.createDialog(q.A,{title:(0,P._t)("labs_mjolnir|rules_title",{roomName:n}),description:s.createElement("div",null,s.createElement("h3",null,(0,P._t)("labs_mjolnir|rules_server")),i(e.serverRules),s.createElement("h3",null,(0,P._t)("labs_mjolnir|rules_user")),i(e.userRules)),button:(0,P._t)("action|close"),hasCancelButton:!1})}renderPersonalBanListRules(){const e=uk.u.sharedInstance().getPersonalList(),t=e?[...e.userRules,...e.serverRules]:[];if(!e||t.length<=0)return s.createElement("i",null,(0,P._t)("labs_mjolnir|personal_empty"));const n=[];for(const e of t)n.push(s.createElement("li",{key:e.entity,className:"mx_MjolnirUserSettingsTab_listItem"},s.createElement(Ae.A,{kind:"danger_sm",onClick:()=>this.removePersonalRule(e),disabled:this.state.busy},(0,P._t)("action|remove")),"Â ",s.createElement("code",null,e.entity)));return s.createElement("div",null,s.createElement("p",null,(0,P._t)("labs_mjolnir|personal_section")),s.createElement("ul",null,n))}renderSubscribedBanLists(){const e=uk.u.sharedInstance().getPersonalList(),t=uk.u.sharedInstance().lists.filter((t=>!e||e.roomId!==t.roomId));if(!t||t.length<=0)return s.createElement("i",null,(0,P._t)("labs_mjolnir|no_lists"));const n=[];for(const e of t){const t=E.J.safeGet().getRoom(e.roomId),i=t?s.createElement("span",null,t.name," (",s.createElement("code",null,e.roomId),")"):s.createElement("code",null,"list.roomId");n.push(s.createElement("li",{key:e.roomId,className:"mx_MjolnirUserSettingsTab_listItem"},s.createElement(Ae.A,{kind:"danger_sm",onClick:()=>this.unsubscribeFromList(e),disabled:this.state.busy},(0,P._t)("action|unsubscribe")),"Â ",s.createElement(Ae.A,{kind:"primary_sm",onClick:()=>this.viewListRules(e),disabled:this.state.busy},(0,P._t)("labs_mjolnir|view_rules")),"Â ",i))}return s.createElement("div",null,s.createElement("p",null,(0,P._t)("labs_mjolnir|lists")),s.createElement("ul",null,n))}render(){const e=u.Ay.get().brand;return s.createElement(iC.A,null,s.createElement(rC.X,null,s.createElement(sC.s,null,s.createElement("strong",{className:"warning"},(0,P._t)("labs_mjolnir|advanced_warning")),s.createElement("p",null,(0,P._t)("labs_mjolnir|explainer_1",{brand:e},{code:e=>s.createElement("code",null,e)})),s.createElement("p",null,(0,P._t)("labs_mjolnir|explainer_2"))),s.createElement(sC.P,{heading:(0,P._t)("labs_mjolnir|personal_heading"),description:(0,P._t)("labs_mjolnir|personal_description",{myBanList:(0,P._t)("labs_mjolnir|room_name")})},this.renderPersonalBanListRules(),s.createElement("form",{onSubmit:this.onAddPersonalRule,autoComplete:"off"},s.createElement(Sa.A,{type:"text",label:(0,P._t)("labs_mjolnir|personal_new_label"),placeholder:(0,P._t)("labs_mjolnir|personal_new_placeholder"),value:this.state.newPersonalRule,onChange:this.onPersonalRuleChanged}),s.createElement(Ae.A,{kind:"primary",onClick:this.onAddPersonalRule,disabled:this.state.busy},(0,P._t)("action|ignore")))),s.createElement(sC.P,{heading:(0,P._t)("labs_mjolnir|lists_heading"),description:s.createElement(s.Fragment,null,s.createElement("strong",{className:"warning"},(0,P._t)("labs_mjolnir|lists_description_1")),"Â ",s.createElement("span",null,(0,P._t)("labs_mjolnir|lists_description_2")))},this.renderSubscribedBanLists(),s.createElement("form",{onSubmit:this.onSubscribeList,autoComplete:"off"},s.createElement(Sa.A,{type:"text",label:(0,P._t)("labs_mjolnir|lists_new_label"),value:this.state.newList,onChange:this.onNewListChanged}),s.createElement(Ae.A,{kind:"primary",onClick:this.onSubscribeList,disabled:this.state.busy},(0,P._t)("action|subscribe"))))))}}function hk(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{d:"m12.971 3.54 7 3.889A2 2 0 0 1 21 9.177V19a2 2 0 0 1-2 2h-4v-9H9v9H5a2 2 0 0 1-2-2V9.177a2 2 0 0 1 1.029-1.748l7-3.89a2 2 0 0 1 1.942 0Z"})})}hk.displayName="HomeSolidIcon";const gk=(0,s.forwardRef)(hk);function vk(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{d:"m12.897 2.817 2.336 4.733 5.223.76a1 1 0 0 1 .555 1.705L17.23 13.7l.892 5.202a1 1 0 0 1-1.45 1.054L12 17.5l-4.672 2.456a1 1 0 0 1-1.451-1.054l.892-5.202-3.78-3.685a1 1 0 0 1 .555-1.706l5.223-.759 2.336-4.733a1 1 0 0 1 1.794 0Z"})})}vk.displayName="FavouriteSolidIcon";const fk=(0,s.forwardRef)(vk);function _k(e,t){return(0,dl.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:[(0,dl.jsx)("path",{d:"M12 15c-1.1 0-2.042-.392-2.825-1.175C8.392 13.042 8 12.1 8 11s.392-2.042 1.175-2.825C9.958 7.392 10.9 7 12 7s2.042.392 2.825 1.175C15.608 8.958 16 9.9 16 11s-.392 2.042-1.175 2.825C14.042 14.608 13.1 15 12 15Z"}),(0,dl.jsx)("path",{d:"M19.528 18.583A9.962 9.962 0 0 0 22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 2.52.933 4.824 2.472 6.583A9.976 9.976 0 0 0 12 22a9.976 9.976 0 0 0 7.528-3.417ZM8.75 16.388c-.915.221-1.818.538-2.709.95a8 8 0 1 1 11.918 0 14.679 14.679 0 0 0-2.709-.95A13.76 13.76 0 0 0 12 16c-1.1 0-2.183.13-3.25.387Z"})]})}_k.displayName="UserProfileSolidIcon";const yk=(0,s.forwardRef)(_k);var bk,Ek,wk;function Sk(){return Sk=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},Sk.apply(null,arguments)}var Ak=function(e,t){return s.createElement("svg",Sk({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0,ref:t},e),bk||(bk=s.createElement("mask",{id:"hash-circle_svg__a",fill:"#fff"},s.createElement("path",{fillRule:"evenodd",d:"M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16M8.34 5.156A.75.75 0 0 0 6.848 5l-.16 1.531H5.656a.75.75 0 0 0 0 1.5h.875L6.328 9.97h-.937a.75.75 0 0 0 0 1.5h.78l-.151 1.453a.75.75 0 1 0 1.492.156l.168-1.61H9.5l-.152 1.454a.75.75 0 1 0 1.492.156l.168-1.61h1.289a.75.75 0 0 0 0-1.5h-1.132l.202-1.937h.93a.75.75 0 0 0 0-1.5h-.773l.144-1.375A.75.75 0 1 0 10.176 5l-.16 1.531h-1.82zM9.657 9.97h-1.82l.202-1.938h1.82z",clipRule:"evenodd"}))),Ek||(Ek=s.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16M8.34 5.156A.75.75 0 0 0 6.848 5l-.16 1.531H5.656a.75.75 0 0 0 0 1.5h.875L6.328 9.97h-.937a.75.75 0 0 0 0 1.5h.78l-.151 1.453a.75.75 0 1 0 1.492.156l.168-1.61H9.5l-.152 1.454a.75.75 0 1 0 1.492.156l.168-1.61h1.289a.75.75 0 0 0 0-1.5h-1.132l.202-1.937h.93a.75.75 0 0 0 0-1.5h-.773l.144-1.375A.75.75 0 1 0 10.176 5l-.16 1.531h-1.82zM9.657 9.97h-1.82l.202-1.938h1.82z",clipRule:"evenodd"})),wk||(wk=s.createElement("path",{fill:"currentColor",d:"m7.672 4.332-.139 1.326zm.668.824 1.326.139zM6.848 5l-1.326-.138zm-.16 1.531v1.334h1.201l.125-1.195zm-.157 1.5 1.326.139.154-1.472H6.53zM6.328 9.97v1.333H7.53l.125-1.195zm-.156 1.5 1.326.138.154-1.471h-1.48zm-.152 1.453-1.326-.139zm.668.824.138-1.326zm.824-.668 1.326.139zm.168-1.61v-1.332H6.479l-.125 1.194zm1.82 0 1.326.14.154-1.473H9.5zm-.152 1.454 1.326.139zm.668.824.138-1.326zm.824-.668 1.326.139zm.168-1.61v-1.332H9.807l-.125 1.194zm.157-1.5L9.839 9.83l-.154 1.472h1.48zm.202-1.937V6.698h-1.201l-.125 1.195zm.157-1.5-1.326-.138-.154 1.472h1.48zm.144-1.375-1.326-.138zM11 4.332l.139-1.326zM10.176 5 8.85 4.862zm-.16 1.531v1.334h1.201l.125-1.195zm-1.82 0L6.87 6.393l-.154 1.472h1.48zm-.36 3.438L6.51 9.83l-.153 1.472h1.48zm1.82 0v1.333h1.202l.125-1.195zM8.04 8.03V6.698H6.838l-.125 1.195zm1.82 0 1.326.139.154-1.472H9.86zM15.667 9A6.667 6.667 0 0 1 9 15.667v2.666A9.333 9.333 0 0 0 18.333 9zM9 2.333A6.667 6.667 0 0 1 15.667 9h2.666A9.333 9.333 0 0 0 9-.333zM2.333 9A6.667 6.667 0 0 1 9 2.333V-.333A9.333 9.333 0 0 0-.333 9zM9 15.667A6.667 6.667 0 0 1 2.333 9H-.333A9.333 9.333 0 0 0 9 18.333zM7.533 5.658a.583.583 0 0 1-.52-.64l2.653.277A2.083 2.083 0 0 0 7.81 3.006zm.64-.52a.583.583 0 0 1-.64.52l.277-2.652a2.083 2.083 0 0 0-2.288 1.856zm-.16 1.532.16-1.531-2.651-.277-.16 1.53zM5.657 7.865h1.032V5.198H5.656zm.584-.584a.583.583 0 0 1-.584.584V5.198c-1.15 0-2.083.933-2.083 2.083zm-.584-.583c.322 0 .584.261.584.583H3.573c0 1.15.933 2.084 2.083 2.084zm.875 0h-.875v2.667h.875zm1.124 3.41.202-1.938-2.652-.277-.203 1.937zM5.39 11.301h.937V8.635h-.937zm.583-.583a.583.583 0 0 1-.583.583V8.635c-1.151 0-2.084.933-2.084 2.084zm-.583-.583c.322 0 .583.26.583.583H3.307c0 1.15.933 2.083 2.084 2.083zm.78 0h-.78v2.666h.78zm1.175 2.925.152-1.454-2.652-.277-.152 1.454zm-.52-.641c.32.033.553.32.52.64l-2.652-.277a2.083 2.083 0 0 0 1.855 2.29zm-.64.52a.583.583 0 0 1 .64-.52l-.277 2.652a2.083 2.083 0 0 0 2.289-1.855zm.168-1.61-.169 1.61 2.653.277.168-1.61zM9.5 10.136H7.68v2.666H9.5zm1.174 2.925.152-1.454-2.652-.277-.152 1.454zm-.52-.641c.32.033.553.32.52.64l-2.652-.277a2.083 2.083 0 0 0 1.855 2.29zm-.64.52a.583.583 0 0 1 .64-.52l-.277 2.652a2.083 2.083 0 0 0 2.289-1.855zm.168-1.61-.168 1.61 2.652.277.168-1.61zm2.615-1.194h-1.29v2.666h1.29zm-.584.583c0-.322.262-.583.584-.583v2.666c1.15 0 2.083-.933 2.083-2.083zm.584.583a.583.583 0 0 1-.584-.583h2.667c0-1.15-.933-2.084-2.083-2.084zm-1.132 0h1.132V8.635h-1.132zm-1.124-3.41L9.84 9.83l2.652.277.202-1.937zm2.256-1.194h-.93v2.667h.93zm-.584.583c0-.322.262-.583.584-.583v2.667c1.15 0 2.083-.933 2.083-2.084zm.584.584a.583.583 0 0 1-.584-.584h2.667c0-1.15-.933-2.083-2.083-2.083zm-.773 0h.773V5.198h-.773zm-1.182-2.847-.144 1.375 2.652.277.144-1.375zm.52.64a.583.583 0 0 1-.52-.64l2.652.277a2.083 2.083 0 0 0-1.855-2.289zm.64-.52a.583.583 0 0 1-.64.52l.277-2.652a2.083 2.083 0 0 0-2.29 1.856zm-.16 1.532.16-1.531-2.652-.277-.16 1.53zM8.196 7.865h1.82V5.198h-1.82zM7.014 5.018 6.87 6.393l2.652.277.144-1.375zm.823 6.284h1.82V8.635h-1.82zm-1.124-3.41L6.51 9.83l2.653.277.202-1.937zm3.146-1.194H8.04v2.667h1.82zm1.124 3.41.202-1.938-2.652-.277L8.33 9.83z",mask:"url(#hash-circle_svg__a)"})))},Ck=(0,s.forwardRef)(Ak);function xk(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function kk(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?xk(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):xk(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const Rk=(e,t)=>async n=>{const i=V.A.getValue("Spaces.enabledMetaSpaces");await V.A.setValue("Spaces.enabledMetaSpaces",null,ae.p.ACCOUNT,kk(kk({},i),{},{[e]:n.target.checked})),y.A.trackInteraction(t,n,[ke._b.Home,null,ke._b.Favourites,ke._b.People,ke._b.Orphans,ke._b.VideoRooms].indexOf(e))},Ik=()=>{const{[ke._b.Home]:e,[ke._b.Favourites]:t,[ke._b.People]:n,[ke._b.Orphans]:i,[ke._b.VideoRooms]:r}=(0,Oe.ti)("Spaces.enabledMetaSpaces"),o=(0,Oe.ti)("Spaces.allRoomsInHome"),a=(0,s.useMemo)((()=>u.Ay.get("element_call").guest_spa_url),[]),l=(0,P._t)("settings|sidebar|metaspaces_video_rooms_description")+(a?" "+(0,P._t)("settings|sidebar|metaspaces_video_rooms_description_invite_extension"):"");return s.createElement(iC.A,null,s.createElement(rC.X,null,s.createElement(sC.P,{heading:(0,P._t)("settings|sidebar|metaspaces_subsection"),description:(0,P._t)("settings|sidebar|spaces_explainer")},s.createElement(ka.A,{checked:!!e,onChange:Rk(ke._b.Home,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_checkbox",disabled:e},s.createElement(sC.s,null,s.createElement(gk,null),(0,P._t)("common|home")),s.createElement(sC.s,null,(0,P._t)("settings|sidebar|metaspaces_home_description"))),s.createElement(ka.A,{checked:o,disabled:!e,onChange:async e=>{await V.A.setValue("Spaces.allRoomsInHome",null,ae.p.ACCOUNT,e.target.checked),y.A.trackInteraction("WebSettingsSidebarTabSpacesCheckbox",e,1)},className:"mx_SidebarUserSettingsTab_checkbox mx_SidebarUserSettingsTab_homeAllRoomsCheckbox"},s.createElement(sC.s,null,(0,P._t)("settings|sidebar|metaspaces_home_all_rooms")),s.createElement(sC.s,null,(0,P._t)("settings|sidebar|metaspaces_home_all_rooms_description"))),s.createElement(ka.A,{checked:!!t,onChange:Rk(ke._b.Favourites,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_checkbox"},s.createElement(sC.s,null,s.createElement(fk,null),(0,P._t)("common|favourites")),s.createElement(sC.s,null,(0,P._t)("settings|sidebar|metaspaces_favourites_description"))),s.createElement(ka.A,{checked:!!n,onChange:Rk(ke._b.People,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_checkbox"},s.createElement(sC.s,null,s.createElement(yk,null),(0,P._t)("Direct Messages")),s.createElement(sC.s,null,(0,P._t)("settings|sidebar|metaspaces_people_description"))),s.createElement(ka.A,{checked:!!i,onChange:Rk(ke._b.Orphans,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_checkbox"},s.createElement(sC.s,null,s.createElement(Ck,null),(0,P._t)("settings|sidebar|metaspaces_orphans")),s.createElement(sC.s,null,(0,P._t)("settings|sidebar|metaspaces_orphans_description"))),V.A.getValue("feature_video_rooms")&&s.createElement(ka.A,{checked:!!r,onChange:Rk(ke._b.VideoRooms,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_checkbox"},s.createElement(sC.s,null,s.createElement(rb.A,null),(0,P._t)("settings|sidebar|metaspaces_video_rooms")),s.createElement(sC.s,null,l)))))};var Tk=n("./src/accessibility/KeyboardShortcutUtils.ts");const Pk=Object.entries(Se.R6).filter((([e])=>e!==Se.md.LABS||hC())),Nk=({name:e})=>{const t=(0,Tk.Lt)(e),n=(0,Tk.Tz)(e);return t&&n?s.createElement("li",{className:"mx_KeyboardShortcut_shortcutRow"},t,s.createElement(Gl.S,{value:n})):null},Dk=({categoryName:e,category:t})=>t.categoryLabel?s.createElement(sC.P,{heading:(0,P._t)(t.categoryLabel),key:e},s.createElement("ul",{className:"mx_KeyboardShortcut_shortcutList"},t.settingNames.map((e=>s.createElement(Nk,{key:e,name:e}))))):null,Mk=()=>s.createElement(iC.A,null,s.createElement(rC.X,null,Pk.map((([e,t])=>s.createElement(Dk,{key:e,categoryName:e,category:t})))));var Ok=n("./src/components/views/dialogs/VerificationRequestDialog.tsx");const Lk=["value","options","selectedLabel","className"],Fk=(e,t)=>n=>{const i=e.find((({id:e})=>e===n));return i?t?`${t}: ${i.label}`:i.label:null},Uk=e=>{let{value:t,options:n,selectedLabel:i,className:r}=e,o=(0,Ve.A)(e,Lk);return s.createElement(MA.A,(0,p.A)({},o,{value:t,className:re()("mx_FilterDropdown",r),getShortOption:Fk(n,i)}),n.map((({id:e,label:n,description:i})=>s.createElement("div",{className:"mx_FilterDropdown_option",key:e},e===t&&s.createElement(xb.A,{className:"mx_FilterDropdown_optionSelectedIcon"}),s.createElement("span",{className:"mx_FilterDropdown_optionLabel"},n),!!i&&s.createElement("span",{className:"mx_FilterDropdown_optionDescription"},i)))))},Bk=["title","description"],Vk=e=>{let{title:t,description:n}=e,i=(0,Ve.A)(e,Bk);return s.createElement(Ae.A,(0,p.A)({},i,{kind:"link_inline",onClick:()=>{A.Ay.createDialog(Ca.A,{title:t,description:n,button:(0,P._t)("action|got_it"),hasCloseButton:!0})},className:"mx_LearnMore_button"}),(0,P._t)("action|learn_more"))},jk=({device:e,saveDeviceName:t,stopEditing:n})=>{const[i,r]=(0,s.useState)(e.display_name||""),[o,a]=(0,s.useState)(!1),[l,c]=(0,s.useState)(null);(0,s.useEffect)((()=>{r(e.display_name||"")}),[e.display_name]);const d=async e=>{a(!0),c(null),e.preventDefault();try{await t(i),n()}catch{c((0,P._t)("settings|sessions|error_set_name")),a(!1)}},u=`device-rename-${e.device_id}`,m=`device-rename-description-${e.device_id}`;return s.createElement("form",{"aria-disabled":o,className:"mx_DeviceDetailHeading_renameForm",onSubmit:d,method:"post"},s.createElement("p",{id:u,className:"mx_DeviceDetailHeading_renameFormHeading"},(0,P._t)("settings|sessions|rename_form_heading")),s.createElement("div",null,s.createElement(Sa.A,{type:"text",value:i,autoComplete:"off",onChange:e=>r(e.target.value),autoFocus:!0,disabled:o,"aria-labelledby":u,"aria-describedby":m,className:"mx_DeviceDetailHeading_renameFormInput",maxLength:100}),s.createElement(ux.H,{id:m},(0,P._t)("settings|sessions|rename_form_caption"),s.createElement(Vk,{title:(0,P._t)("settings|sessions|rename_form_learn_more"),description:s.createElement(s.Fragment,null,s.createElement("p",null,(0,P._t)("settings|sessions|rename_form_learn_more_description_1")),s.createElement("p",null,(0,P._t)("settings|sessions|rename_form_learn_more_description_2")))}),!!l&&s.createElement("span",{className:"mx_DeviceDetailHeading_renameFormError"},l))),s.createElement("div",{className:"mx_DeviceDetailHeading_renameFormButtons"},s.createElement(Ae.A,{onClick:d,kind:"primary",disabled:o},(0,P._t)("action|save")),s.createElement(Ae.A,{onClick:n,kind:"secondary",disabled:o},(0,P._t)("action|cancel")),o&&s.createElement(Na.A,{w:16,h:16})))},zk=({device:e,saveDeviceName:t})=>{const[n,i]=(0,s.useState)(!1);return n?s.createElement(jk,{device:e,saveDeviceName:t,stopEditing:()=>i(!1)}):s.createElement("div",{className:"mx_DeviceDetailHeading"},s.createElement(uc.A,{size:"4"},e.display_name||e.device_id),s.createElement(Ae.A,{kind:"link_inline",onClick:()=>i(!0),className:"mx_DeviceDetailHeading_renameCta"},(0,P._t)("action|rename")))};var Wk;function Hk(){return Hk=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},Hk.apply(null,arguments)}var Gk=function(e,t){return s.createElement("svg",Hk({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0,ref:t},e),Wk||(Wk=s.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M2 3.05v6.22C2 15.63 9 17 9 17s7-1.37 7-7.73V3.05L9 1zm9.94 2.47c.19-.18.49-.17.67.02.16.18.16.45.02.63l-4.22 5.11-.03.04c-.28.34-.79.39-1.13.11a.3.3 0 0 1-.077-.067l-.023-.023-1.81-2.08c-.2-.24-.18-.6.06-.8.2-.18.49-.18.7-.04l1.57 1.1z",clipRule:"evenodd"})))},Kk=(0,s.forwardRef)(Gk);var Jk=n("./res/img/e2e/warning.svg"),qk=n("./res/img/element-icons/settings/inactive.svg"),$k=n("./src/components/views/settings/devices/types.ts");const Yk={[$k.e.Inactive]:qk.I,[$k.e.Verified]:Kk,[$k.e.Unverified]:Jk.I,[$k.e.Unverifiable]:Jk.I},Zk=({variation:e})=>{const t=Yk[e];return s.createElement("div",{className:re()("mx_DeviceSecurityCard_icon",e)},s.createElement(t,{height:16,width:16}))},Xk=({variation:e,heading:t,description:n,children:i})=>s.createElement("div",{className:"mx_DeviceSecurityCard"},s.createElement(Zk,{variation:e}),s.createElement("div",{className:"mx_DeviceSecurityCard_content"},s.createElement("p",{className:"mx_DeviceSecurityCard_heading"},t),s.createElement("p",{className:"mx_DeviceSecurityCard_description"},n),!!i&&s.createElement("div",{className:"mx_DeviceSecurityCard_actions"},i))),Qk={[$k.e.Verified]:{title:(0,P._t)("settings|sessions|verified_sessions"),description:s.createElement(s.Fragment,null,s.createElement("p",null,(0,P._t)("settings|sessions|verified_sessions_explainer_1")),s.createElement("p",null,(0,P._t)("settings|sessions|verified_sessions_explainer_2")))},[$k.e.Unverified]:{title:(0,P._t)("settings|sessions|unverified_sessions"),description:s.createElement(s.Fragment,null,s.createElement("p",null,(0,P._t)("settings|sessions|unverified_sessions_explainer_1")),s.createElement("p",null,(0,P._t)("settings|sessions|unverified_sessions_explainer_2")))},[$k.e.Unverifiable]:{title:(0,P._t)("settings|sessions|unverified_session"),description:s.createElement(s.Fragment,null,s.createElement("p",null,(0,P._t)("settings|sessions|unverified_session_explainer_1")),s.createElement("p",null,(0,P._t)("settings|sessions|unverified_session_explainer_2")),s.createElement("p",null,(0,P._t)("settings|sessions|unverified_session_explainer_3")))},[$k.e.Inactive]:{title:(0,P._t)("settings|sessions|inactive_sessions"),description:s.createElement(s.Fragment,null,s.createElement("p",null,(0,P._t)("settings|sessions|inactive_sessions_explainer_1")),s.createElement("p",null,(0,P._t)("settings|sessions|inactive_sessions_explainer_2")))}},eR=({variation:e})=>{const{title:t,description:n}=Qk[e];return s.createElement(Vk,{title:t,description:n})},tR=({device:e,isCurrentDevice:t,onVerifyDevice:n})=>{const i=((e,t)=>{if(e.isVerified){const e=t?(0,P._t)("settings|sessions|device_verified_description_current"):(0,P._t)("settings|sessions|device_verified_description");return{variation:$k.e.Verified,heading:(0,P._t)("settings|sessions|verified_session"),description:s.createElement(s.Fragment,null,e,s.createElement(eR,{variation:$k.e.Verified}))}}if(null===e.isVerified)return{variation:$k.e.Unverified,heading:(0,P._t)("settings|sessions|unverified_session"),description:s.createElement(s.Fragment,null,(0,P._t)("settings|sessions|unverified_session_explainer_1"),s.createElement(eR,{variation:$k.e.Unverifiable}))};const n=t?(0,P._t)("settings|sessions|device_unverified_description_current"):(0,P._t)("settings|sessions|device_unverified_description");return{variation:$k.e.Unverified,heading:(0,P._t)("settings|sessions|unverified_session"),description:s.createElement(s.Fragment,null,n,s.createElement(eR,{variation:$k.e.Unverified}))}})(e,t);return s.createElement(Xk,i,!1===e.isVerified&&!!n&&s.createElement(Ae.A,{kind:"primary",onClick:n},(0,P._t)("settings|sessions|verify_session")))};function nR(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function iR(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?nR(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):nR(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const rR=({device:e,pusher:t,localNotificationSettings:n,isSigningOut:r,onVerifyDevice:o,onSignOutDevice:a,saveDeviceName:l,setPushNotifications:c,supportsMSC3881:d,className:u,isCurrentDevice:m})=>{const p=[{id:"session",values:[{label:(0,P._t)("settings|sessions|session_id"),value:e.device_id},{label:(0,P._t)("settings|sessions|last_activity"),value:e.last_seen_ts&&(0,Bp.Yq)(new Date(e.last_seen_ts))}]},{id:"application",heading:(0,P._t)("common|application"),values:[{label:(0,P._t)("common|name"),value:e.appName},{label:(0,P._t)("common|version"),value:e.appVersion},{label:(0,P._t)("settings|sessions|url"),value:e.url}]},{id:"device",heading:(0,P._t)("common|device"),values:[{label:(0,P._t)("common|model"),value:e.deviceModel},{label:(0,P._t)("settings|sessions|os"),value:e.deviceOperatingSystem},{label:(0,P._t)("settings|sessions|browser"),value:e.client},{label:(0,P._t)("settings|sessions|ip"),value:e.last_seen_ip}]}].map((e=>iR(iR({},e),{},{values:e.values.filter((e=>!!e.value))}))).filter((e=>e.values.length)),h=!!t||!!n;return s.createElement("div",{className:re()("mx_DeviceDetails",u)},s.createElement("section",{className:"mx_DeviceDetails_section"},s.createElement(zk,{device:e,saveDeviceName:l}),s.createElement(tR,{device:e,onVerifyDevice:o,isCurrentDevice:m})),s.createElement("section",{className:"mx_DeviceDetails_section"},s.createElement("p",{className:"mx_DeviceDetails_sectionHeading"},(0,P._t)("settings|sessions|details_heading")),p.map((({heading:e,values:t,id:n},i)=>s.createElement("table",{className:"mx_DeviceDetails_metadataTable",key:i},e&&s.createElement("thead",null,s.createElement("tr",null,s.createElement("th",null,e))),s.createElement("tbody",null,t.map((({label:e,value:t})=>s.createElement("tr",{key:e},s.createElement("td",{className:"mxDeviceDetails_metadataLabel"},e),s.createElement("td",{className:"mxDeviceDetails_metadataValue"},t))))))))),h&&s.createElement("section",{className:"mx_DeviceDetails_section mx_DeviceDetails_pushNotifications"},s.createElement(aC.A,{checked:function(e){return e?!!e[i.PUSHER_ENABLED.name]:!n||!n.is_silenced}(t),disabled:function(e){return!n&&!(!e||d)}(t),onChange:t=>null==c?void 0:c(e.device_id,t),title:(0,P._t)("settings|sessions|push_toggle")}),s.createElement("p",{className:"mx_DeviceDetails_sectionHeading"},(0,P._t)("settings|sessions|push_heading"),s.createElement("small",{className:"mx_DeviceDetails_sectionSubheading"},(0,P._t)("settings|sessions|push_subheading")))),s.createElement("section",{className:"mx_DeviceDetails_section"},s.createElement(Ae.A,{onClick:a,kind:"danger_inline",disabled:r},s.createElement("span",{className:"mx_DeviceDetails_signOutButtonContent"},(0,P._t)("settings|sessions|sign_out"),r&&s.createElement(Na.A,{w:16,h:16})))))},sR=["isExpanded"],oR=e=>{let{isExpanded:t}=e,n=(0,Ve.A)(e,sR);const i=t?(0,P._t)("settings|sessions|hide_details"):(0,P._t)("settings|sessions|show_details");return s.createElement(Ae.A,(0,p.A)({},n,{"aria-label":i,title:i,kind:"icon",className:re()("mx_DeviceExpandDetailsButton",{mx_DeviceExpandDetailsButton_expanded:t})}),s.createElement(yp,{className:"mx_DeviceExpandDetailsButton_icon"}))};var aR,lR=n("./src/components/views/settings/devices/filter.ts");function cR(){return cR=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},cR.apply(null,arguments)}var dR=function(e,t){return s.createElement("svg",cR({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 22 23",role:"presentation","aria-hidden":!0,ref:t},e),aR||(aR=s.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M11 22.5c6.075 0 11-4.925 11-11S17.075.5 11 .5 0 5.425 0 11.5s4.925 11 11 11m0-4.24a1.375 1.375 0 1 0 0-2.75 1.375 1.375 0 0 0 0 2.75M9.09 9.429A1.91 1.91 0 0 1 11 7.518c1.048 0 1.91.862 1.91 1.91 0 .485-.208.659-1.026 1.224-.363.25-.86.598-1.246 1.108-.415.546-.67 1.227-.67 2.093h2.063c0-.424.113-.666.25-.846.164-.217.402-.4.775-.659l.124-.084c.676-.46 1.792-1.219 1.792-2.836A3.98 3.98 0 0 0 11 5.456a3.97 3.97 0 0 0-3.973 3.972z",clipRule:"evenodd"})))},uR=(0,s.forwardRef)(dR);var mR;function pR(){return pR=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},pR.apply(null,arguments)}var hR=function(e,t){return s.createElement("svg",pR({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 22 19",role:"presentation","aria-hidden":!0,ref:t},e),mR||(mR=s.createElement("path",{fill:"currentColor",d:"M3 15.5q-.824 0-1.412-.587A1.93 1.93 0 0 1 1 13.5v-11q0-.825.588-1.413A1.93 1.93 0 0 1 3 .5h16q.825 0 1.413.587Q21 1.675 21 2.5v11q0 .825-.587 1.413A1.93 1.93 0 0 1 19 15.5zm0-2h16v-11H3zm-2 5a.97.97 0 0 1-.712-.288A.97.97 0 0 1 0 17.5q0-.424.288-.712A.97.97 0 0 1 1 16.5h20q.424 0 .712.288A.97.97 0 0 1 22 17.5q0 .424-.288.712A.97.97 0 0 1 21 18.5zm2-5v-11z"})))},gR=(0,s.forwardRef)(hR);var vR;function fR(){return fR=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},fR.apply(null,arguments)}var _R=function(e,t){return s.createElement("svg",fR({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 20 17",role:"presentation","aria-hidden":!0,ref:t},e),vR||(vR=s.createElement("path",{fill:"currentColor",d:"M18 16.5H2q-.824 0-1.412-.587A1.93 1.93 0 0 1 0 14.5v-12q0-.825.588-1.412A1.92 1.92 0 0 1 2 .5h16q.825 0 1.413.588Q20 1.675 20 2.5v12q0 .825-.587 1.413A1.93 1.93 0 0 1 18 16.5M2 4.5v10h16v-10z"})))},yR=(0,s.forwardRef)(_R);var bR;function ER(){return ER=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},ER.apply(null,arguments)}var wR=function(e,t){return s.createElement("svg",ER({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 14 23",role:"presentation","aria-hidden":!0,ref:t},e),bR||(bR=s.createElement("path",{fill:"currentColor",d:"M12 .51 2 .5c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2v-18c0-1.1-.9-1.99-2-1.99m0 17.99H2v-14h10z"})))},SR=(0,s.forwardRef)(wR);const AR={[XC.b.Desktop]:gR,[XC.b.Mobile]:SR,[XC.b.Web]:yR,[XC.b.Unknown]:uR},CR={[XC.b.Desktop]:(0,P.AO)("settings|sessions|desktop_session"),[XC.b.Mobile]:(0,P.AO)("settings|sessions|mobile_session"),[XC.b.Web]:(0,P.AO)("settings|sessions|web_session"),[XC.b.Unknown]:(0,P.AO)("settings|sessions|unknown_session")},xR=({isVerified:e,isSelected:t,deviceType:n})=>{const i=AR[n]||AR[XC.b.Unknown],r=(0,P._t)(CR[n]||CR[XC.b.Unknown]);return s.createElement("div",{className:re()("mx_DeviceTypeIcon",{mx_DeviceTypeIcon_selected:t})},s.createElement("div",{className:"mx_DeviceTypeIcon_deviceIconWrapper"},s.createElement(i,{className:"mx_DeviceTypeIcon_deviceIcon",role:"img","aria-label":r})),e?s.createElement(Kk,{className:re()("mx_DeviceTypeIcon_verificationIcon","verified"),role:"img","aria-label":(0,P._t)("common|verified")}):s.createElement(Jk.I,{className:re()("mx_DeviceTypeIcon_verificationIcon","unverified"),role:"img","aria-label":(0,P._t)("common|unverified")}))};var kR=n("./src/utils/NativeEventUtils.ts"),RR=n("./src/components/views/settings/devices/DeviceMetaData.tsx");const IR=({device:e})=>s.createElement(uc.A,{size:"4"},e.display_name||e.device_id),TR=({device:e,children:t,isSelected:n,onClick:i})=>s.createElement("div",{className:re()("mx_DeviceTile",{mx_DeviceTile_interactive:!!i}),onClick:i},s.createElement(xR,{isVerified:e.isVerified,isSelected:n,deviceType:e.deviceType}),s.createElement("div",{className:"mx_DeviceTile_info"},s.createElement(IR,{device:e}),s.createElement("div",{className:"mx_DeviceTile_metadata"},s.createElement(RR.e,{device:e}))),s.createElement("div",{className:"mx_DeviceTile_actions",onClick:(0,kR.Z)((()=>{}))},t)),PR=({children:e,device:t,isSelected:n,onSelect:i,onClick:r})=>s.createElement("div",{className:"mx_SelectableDeviceTile"},s.createElement(ka.A,{kind:ka.x.Solid,checked:n,onChange:i,className:"mx_SelectableDeviceTile_checkbox",id:`device-tile-checkbox-${t.device_id}`},s.createElement(TR,{device:t,onClick:r,isSelected:n},e))),NR=["selectedDeviceCount","isAllSelected","isSelectDisabled","toggleSelectAll","children"],DR=e=>{let{selectedDeviceCount:t,isAllSelected:n,isSelectDisabled:i,toggleSelectAll:r,children:o}=e,a=(0,Ve.A)(e,NR);const l=n?(0,P._t)("common|deselect_all"):(0,P._t)("common|select_all");return s.createElement("div",(0,p.A)({className:"mx_FilteredDeviceListHeader"},a),!i&&s.createElement(Te.m,{label:l,placement:"top",isTriggerInteractive:!1},s.createElement(ka.A,{kind:ka.x.Solid,checked:n,onChange:r,id:"device-select-all-checkbox","aria-label":l})),s.createElement("span",{className:"mx_FilteredDeviceListHeader_label"},t>0?(0,P._t)("settings|sessions|n_sessions_selected",{count:t}):(0,P._t)("settings|sessions|title")),o)},MR=(e,t)=>t.includes(e),OR=(e,t)=>(t.last_seen_ts||0)-(e.last_seen_ts||0)||(e.display_name||e.device_id).localeCompare(t.display_name||t.device_id),LR="ALL",FR=({filter:e})=>{if((e=>!!e&&[$k.e.Inactive,$k.e.Unverified,$k.e.Verified].includes(e))(e)){const t={[$k.e.Verified]:{title:(0,P._t)("settings|sessions|verified_sessions"),description:(0,P._t)("settings|sessions|verified_sessions_list_description")},[$k.e.Unverified]:{title:(0,P._t)("settings|sessions|unverified_sessions"),description:(0,P._t)("settings|sessions|unverified_sessions_list_description")},[$k.e.Unverifiable]:{title:(0,P._t)("settings|sessions|unverified_session"),description:(0,P._t)("settings|sessions|unverified_session_explainer_1")},[$k.e.Inactive]:{title:(0,P._t)("settings|sessions|inactive_sessions"),description:(0,P._t)("settings|sessions|inactive_sessions_list_description",{inactiveAgeDays:lR.B1})}},{title:n,description:i}=t[e];return s.createElement("div",{className:"mx_FilteredDeviceList_securityCard"},s.createElement(Xk,{variation:e,heading:n,description:s.createElement("span",null,i,s.createElement(eR,{variation:e}))}))}return null},UR=({filter:e,clearFilter:t})=>s.createElement("div",{className:"mx_FilteredDeviceList_noResults"},(e=>{switch(e){case $k.e.Verified:return(0,P._t)("settings|sessions|no_verified_sessions");case $k.e.Unverified:return(0,P._t)("settings|sessions|no_unverified_sessions");case $k.e.Inactive:return(0,P._t)("settings|sessions|no_inactive_sessions");default:return(0,P._t)("settings|sessions|no_sessions")}})(e),!!e&&s.createElement(s.Fragment,null,"Â ",s.createElement(Ae.A,{kind:"link_inline",onClick:t},(0,P._t)("action|show_all")))),BR=({device:e,pusher:t,localNotificationSettings:n,isExpanded:i,isSigningOut:r,isSelected:o,onDeviceExpandToggle:a,onSignOutDevice:l,saveDeviceName:c,onRequestDeviceVerification:d,setPushNotifications:u,toggleSelected:m,supportsMSC3881:p,isSelectDisabled:h})=>{const g=s.createElement(s.Fragment,null,r&&s.createElement(Na.A,{w:16,h:16}),s.createElement(oR,{isExpanded:i,onClick:a}));return s.createElement("li",{className:"mx_FilteredDeviceList_listItem"},h?s.createElement(TR,{device:e,onClick:a},g):s.createElement(PR,{isSelected:o,onSelect:m,onClick:a,device:e},g),i&&s.createElement(rR,{device:e,pusher:t,localNotificationSettings:n,isSigningOut:r,onVerifyDevice:d,onSignOutDevice:l,saveDeviceName:c,setPushNotifications:u,supportsMSC3881:p,className:"mx_FilteredDeviceList_deviceDetails"}))},VR=(0,s.forwardRef)((({devices:e,pushers:t,localNotificationSettings:n,filter:r,expandedDeviceIds:o,signingOutDeviceIds:a,selectedDeviceIds:l,onFilterChange:c,onDeviceExpandToggle:d,saveDeviceName:u,onSignOutDevices:m,onRequestDeviceVerification:p,setPushNotifications:h,setSelectedDeviceIds:g,supportsMSC3881:v,disableMultipleSignout:f},_)=>{const y=((e,t)=>(0,lR.Im)(Object.values(e),t?[t]:[]).sort(OR))(e,r);function b(e){return t.find((t=>t[i.PUSHER_DEVICE_ID.name]===e.device_id))}const E=[{id:LR,label:(0,P._t)("settings|sessions|filter_all")},{id:$k.e.Verified,label:(0,P._t)("common|verified"),description:(0,P._t)("settings|sessions|filter_verified_description")},{id:$k.e.Unverified,label:(0,P._t)("common|unverified"),description:(0,P._t)("settings|sessions|filter_unverified_description")},{id:$k.e.Inactive,label:(0,P._t)("settings|sessions|filter_inactive"),description:(0,P._t)("settings|sessions|filter_inactive_description",{inactiveAgeDays:lR.B1})}],w=l.length>=y.length,S=!!a.length;return s.createElement("div",{className:"mx_FilteredDeviceList",ref:_},s.createElement(DR,{selectedDeviceCount:l.length,isAllSelected:w,toggleSelectAll:()=>{g(w?[]:y.map((e=>e.device_id)))},isSelectDisabled:f},l.length?s.createElement(s.Fragment,null,s.createElement(Ae.A,{kind:"danger_inline",disabled:S,onClick:()=>m(l),className:"mx_FilteredDeviceList_headerButton"},S&&s.createElement(Na.A,{w:16,h:16}),(0,P._t)("action|sign_out")),s.createElement(Ae.A,{kind:"content_inline",disabled:S,onClick:()=>g([]),className:"mx_FilteredDeviceList_headerButton"},(0,P._t)("action|cancel"))):s.createElement(Uk,{id:"device-list-filter",label:(0,P._t)("settings|sessions|filter_label"),value:r||LR,onOptionChange:e=>{c(e===LR?void 0:e)},options:E,selectedLabel:(0,P._t)("action|show")})),y.length?s.createElement(FR,{filter:r}):s.createElement(UR,{filter:r,clearFilter:()=>c(void 0)}),s.createElement("ol",{className:"mx_FilteredDeviceList_list"},y.map((e=>s.createElement(BR,{key:e.device_id,device:e,pusher:b(e),localNotificationSettings:n.get(e.device_id),isExpanded:o.includes(e.device_id),isSigningOut:a.includes(e.device_id),isSelected:MR(e.device_id,l),isSelectDisabled:f,onDeviceExpandToggle:()=>d(e.device_id),onSignOutDevice:()=>m([e.device_id]),saveDeviceName:t=>u(e.device_id,t),onRequestDeviceVerification:p?()=>p(e.device_id):void 0,setPushNotifications:h,toggleSelected:()=>{return t=e.device_id,void(MR(t,l)?g(l.filter((e=>e!==t))):g([...l,t]));var t},supportsMSC3881:v})))))})),jR=["options","title"],zR=e=>{let{options:t,title:n}=e,i=(0,Ve.A)(e,jR);const[r,o,a,l]=(0,Fe.EF)();return s.createElement(s.Fragment,null,s.createElement(Fe.VJ,(0,p.A)({},i,{onClick:a,title:n,isExpanded:r,ref:o}),s.createElement(Rg.A,{className:"mx_KebabContextMenu_icon"})),r&&s.createElement(Be.Ay,(0,p.A)({onFinished:l,compact:!0,rightAligned:!0,closeOnInteraction:!0},{left:(c=o.current.getBoundingClientRect()).left+window.scrollX+c.width,top:c.bottom+window.scrollY,chevronFace:Fe.t4.None}),s.createElement(Be.tx,null,t)));var c},WR=({onSignOutCurrentDevice:e,signOutAllOtherSessions:t,otherSessionsCount:n,disabled:i})=>{const r=[s.createElement(Be.R$,{key:"sign-out",label:(0,P._t)("action|sign_out"),onClick:e,isDestructive:!0}),...t?[s.createElement(Be.R$,{key:"sign-out-all-others",label:(0,P._t)("settings|sessions|sign_out_all_other_sessions",{otherSessionsCount:n}),onClick:t,isDestructive:!0})]:[]];return s.createElement(mx.r,{heading:(0,P._t)("settings|sessions|current_session")},s.createElement(zR,{disabled:i,title:(0,P._t)("common|options"),options:r}))},HR=({device:e,isLoading:t,isSigningOut:n,localNotificationSettings:i,otherSessionsCount:r,setPushNotifications:o,onVerifyCurrentDevice:a,onSignOutCurrentDevice:l,signOutAllOtherSessions:c,saveDeviceName:d})=>{const[u,m]=(0,s.useState)(!1);return s.createElement(sC.P,{heading:s.createElement(WR,{onSignOutCurrentDevice:l,signOutAllOtherSessions:c,otherSessionsCount:r,disabled:t||!e||n})},t&&!e&&s.createElement(Na.A,null),!!e&&s.createElement(s.Fragment,null,s.createElement(TR,{device:e,onClick:()=>m(!u)},s.createElement(oR,{isExpanded:u,onClick:()=>m(!u)})),u?s.createElement(rR,{device:e,localNotificationSettings:i,setPushNotifications:o,isSigningOut:n,onVerifyDevice:a,onSignOutDevice:l,saveDeviceName:d,className:"mx_CurrentDeviceSection_deviceDetails"}):s.createElement(s.Fragment,null,s.createElement("br",null),s.createElement(tR,{device:e,onVerifyDevice:a,isCurrentDevice:!0}))))},GR=({devices:e,currentDeviceId:t,goToFilteredList:n})=>{const i=Object.values(e),r=(0,lR.Im)(i,[$k.e.Unverified]).filter((e=>e.device_id!==t)).length,o=(0,lR.Im)(i,[$k.e.Inactive]).length;if(!(r|o))return null;const a=lR.B1;return s.createElement(sC.P,{heading:(0,P._t)("settings|sessions|security_recommendations"),description:(0,P._t)("settings|sessions|security_recommendations_description")},!!r&&s.createElement(Xk,{variation:$k.e.Unverified,heading:(0,P._t)("settings|sessions|unverified_sessions"),description:s.createElement(s.Fragment,null,(0,P._t)("settings|sessions|unverified_sessions_list_description"),s.createElement(eR,{variation:$k.e.Unverified}))},s.createElement(Ae.A,{kind:"link_inline",onClick:()=>n($k.e.Unverified)},(0,P._t)("action|view_all")+` (${r})`)),!!o&&s.createElement(s.Fragment,null,!!r&&s.createElement("div",{className:"mx_SecurityRecommendations_spacing"}),s.createElement(Xk,{variation:$k.e.Inactive,heading:(0,P._t)("settings|sessions|inactive_sessions"),description:s.createElement(s.Fragment,null,(0,P._t)("settings|sessions|inactive_sessions_list_description",{inactiveAgeDays:a}),s.createElement(eR,{variation:$k.e.Inactive}))},s.createElement(Ae.A,{kind:"link_inline",onClick:()=>n($k.e.Inactive)},(0,P._t)("action|view_all")+` (${o})`))))},KR=(e,t)=>async n=>e.deleteMultipleDevices(t,null!=n?n:void 0);var JR=n("./src/components/views/auth/LoginWithQR-types.ts");const qR=({otherSessionsCount:e,disabled:t,signOutAllOtherSessions:n})=>{const i=(0,Vg.Bo)([n?s.createElement(Be.R$,{key:"sign-out-all-others",label:(0,P._t)("settings|sessions|sign_out_n_sessions",{count:e}),onClick:n,isDestructive:!0}):null]);return s.createElement(mx.r,{heading:(0,P._t)("settings|sessions|other_sessions_heading")},!!i.length&&s.createElement(zR,{disabled:t,title:(0,P._t)("common|options"),options:i}))},$R=({delegatedAuthAccountUrl:e,deviceId:t,onFinished:n})=>{const[i,r]=(0,s.useState)(!1),o=((e,t)=>{const n=new URL(e);return n.searchParams.set("action","session_end"),n.searchParams.set("device_id",t),n.toString()})(e,t);return s.createElement(Pa.A,{onFinished:n,title:(0,P._t)("action|sign_out"),contentId:"mx_Dialog_content"},s.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},(0,P._t)("auth|oidc|logout_redirect_warning")),s.createElement("div",{className:"mx_Dialog_buttons"},i?s.createElement(Ae.A,{kind:"primary",onClick:()=>n(!0)},(0,P._t)("action|close")):s.createElement(s.Fragment,null,s.createElement(Ae.A,{kind:"secondary",onClick:()=>n(!1)},(0,P._t)("action|cancel")),s.createElement(Ae.A,{element:"a",onClick:()=>r(!0),kind:"primary",href:o,target:"_blank"},(0,P._t)("action|continue")))))};function YR(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}const ZR=(0,s.lazy)((()=>Promise.all([n.e(3860),n.e(8960)]).then(n.bind(n,"./src/components/views/auth/LoginWithQR.tsx")))),XR=(e,t,n)=>{const[r,a]=(0,s.useState)([]);return{onSignOutCurrentDevice:()=>{A.Ay.createDialog(La,{},void 0,!1,!0)},onSignOutOtherDevices:async r=>{if(!r.length)return;if(n&&1!==r.length)return void o.v.warn("Unexpectedly tried to sign out multiple OIDC-aware devices.");if(!n){if(!await(async e=>{const{finished:t}=A.Ay.createDialog(q.A,{title:(0,P._t)("action|sign_out"),description:s.createElement("div",null,s.createElement("p",null,(0,P._t)("settings|sessions|sign_out_confirm_description",{count:e}))),cancelButton:(0,P._t)("action|cancel"),button:(0,P._t)("action|sign_out")}),[n]=await t;return!!n})(r.length))return}let l=!1;try{if(a((e=>[...e,...r])),n){const[e]=r;try{l=await(async(e,t)=>{const{finished:n}=A.Ay.createDialog($R,{deviceId:t,delegatedAuthAccountUrl:e}),[i]=await n;return!!i})(n,e)}catch(e){o.v.error("Error deleting OIDC-aware sessions",e)}}else{const t=(0,g.v6)();await(async(e,t,n)=>{if(t.length)try{await KR(e,t)(null),await n(!0,void 0)}catch(s){var r;if(!(s instanceof i.MatrixError&&401===s.httpStatus&&null!==(r=s.data)&&void 0!==r&&r.flows))throw s;const o=t.length,a={[AA.av.PHASE_PREAUTH]:{title:(0,P._t)("auth|uia|sso_title"),body:(0,P._t)("settings|sessions|confirm_sign_out_sso",{count:o}),continueText:(0,P._t)("auth|sso"),continueKind:"primary"},[AA.av.PHASE_POSTAUTH]:{title:(0,P._t)("settings|sessions|confirm_sign_out",{count:o}),body:(0,P._t)("settings|sessions|confirm_sign_out_body",{count:o}),continueText:(0,P._t)("settings|sessions|confirm_sign_out_continue",{count:o}),continueKind:"danger"}};A.Ay.createDialog(KA.A,{title:(0,P._t)("common|authentication"),matrixClient:e,authData:s.data,onFinished:n,makeRequest:KR(e,t),aestheticsForStagePhases:{[AA.av.LOGIN_TYPE]:a,[AA.av.UNSTABLE_LOGIN_TYPE]:a}})}})(e,r,(async e=>{t.resolve(e)})),l=await t.promise}}catch(e){o.v.error("Error deleting sessions",e)}finally{l&&await t(),a((e=>e.filter((e=>!r.includes(e)))))}},signingOutDeviceIds:r}},QR=({showMsc4108QrCode:e})=>{var t;const{devices:n,dehydratedDeviceId:r,pushers:a,localNotificationSettings:l,currentDeviceId:c,isLoadingDeviceList:d,requestDeviceVerification:u,refreshDevices:m,saveDeviceName:p,setPushNotifications:h,supportsMSC3881:g}=rx(),[v,f]=(0,s.useState)(),[_,y]=(0,s.useState)([]),[b,E]=(0,s.useState)([]),w=(0,s.useRef)(null),S=(0,s.useRef)(),C=(0,s.useContext)(Wa.A),x=C.client,k=(0,sg.e)((async()=>(await C.oidcClientStore.readyPromise,C.oidcClientStore.accountManagementEndpoint)),[C.oidcClientStore]),R=!!k,I=null==x?void 0:x.getUserId(),T=I&&(null==x?void 0:x.getUser(I))||void 0,{[c]:N}=((0,sg.e)((()=>x.getVersions()),[x]),(0,sg.e)((async()=>{try{const e=await(null==x?void 0:x.getAuthIssuer());if(e)return(0,i.discoverAndValidateOIDCIssuerWellKnown)(e.issuer)}catch(e){o.v.error("Failed to discover OIDC metadata",e)}}),[x]),(0,sg.e)((async()=>{var e,t;return null!==(e=null===(t=x.getCrypto())||void 0===t?void 0:t.isCrossSigningReady())&&void 0!==e&&e}),[x]),n),D=(0,Ve.A)(n,[c].map(YR));r&&null!==(t=D[r])&&void 0!==t&&t.isVerified&&delete D[r];const M=Object.keys(D).length,O=M>0,L=(0,s.useCallback)((e=>{if(!u)return;const t=u(e);A.Ay.createDialog(Ok.A,{verificationRequestPromise:t,member:T,onFinished:async()=>{(await t).cancel(),await m()}})}),[u,m,T]),{onSignOutCurrentDevice:F,onSignOutOtherDevices:U,signingOutDeviceIds:B}=XR(x,(async()=>{await m(),E([])}),k);(0,s.useEffect)((()=>()=>{clearTimeout(S.current)}),[S]),(0,s.useEffect)((()=>{E([])}),[v,E]);const V=O&&!R?()=>{U(Object.keys(D))}:void 0,[j,z]=(0,s.useState)(e?JR.Kt.Show:null),W=(0,s.useCallback)((()=>{z(null)}),[z]);(0,s.useCallback)((()=>{z(JR.Kt.Show)}),[z]);return j?s.createElement(s.Suspense,{fallback:s.createElement(Na.A,null)},s.createElement(ZR,{mode:j,onFinished:W,client:x})):s.createElement(iC.A,null,s.createElement(rC.X,null,s.createElement(GR,{devices:n,goToFilteredList:e=>{f(e),clearTimeout(S.current),S.current=window.setTimeout((()=>{var e;return null===(e=w.current)||void 0===e?void 0:e.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}))},currentDeviceId:c}),s.createElement(HR,{device:N,localNotificationSettings:l.get(c),setPushNotifications:h,isSigningOut:B.includes(c),isLoading:d,saveDeviceName:e=>p(c,e),onVerifyCurrentDevice:()=>{A.Ay.createDialog($C.A,{onFinished:m})},onSignOutCurrentDevice:F,signOutAllOtherSessions:V,otherSessionsCount:M}),O&&s.createElement(sC.P,{heading:s.createElement(qR,{otherSessionsCount:M,signOutAllOtherSessions:V,disabled:!!B.length}),description:(0,P._t)("settings|sessions|best_security_note"),stretchContent:!0},s.createElement(VR,{devices:D,pushers:a,localNotificationSettings:l,filter:v,expandedDeviceIds:_,signingOutDeviceIds:B,selectedDeviceIds:b,setSelectedDeviceIds:E,onFilterChange:f,onDeviceExpandToggle:e=>{_.includes(e)?y(_.filter((t=>t!==e))):y([..._,e])},onRequestDeviceVerification:u?L:void 0,onSignOutDevices:U,saveDeviceName:p,setPushNotifications:h,ref:w,supportsMSC3881:g,disableMultipleSignout:R}))))};function eI(e){const t={strong:e=>s.createElement("span",{className:"mx_UserSettingsDialog_title_strong"},e)};switch(e){case wa.v.Account:return(0,P._t)("settings|account|dialog_title",void 0,t);case wa.v.SessionManager:return(0,P._t)("settings|sessions|dialog_title",void 0,t);case wa.v.Appearance:return(0,P._t)("settings|appearance|dialog_title",void 0,t);case wa.v.Notifications:return(0,P._t)("settings|notifications|dialog_title",void 0,t);case wa.v.Preferences:return(0,P._t)("settings|preferences|dialog_title",void 0,t);case wa.v.Keyboard:return(0,P._t)("settings|keyboard|dialog_title",void 0,t);case wa.v.Sidebar:return(0,P._t)("settings|sidebar|dialog_title",void 0,t);case wa.v.Voice:return(0,P._t)("settings|voip|dialog_title",void 0,t);case wa.v.Security:return(0,P._t)("settings|security|dialog_title",void 0,t);case wa.v.Labs:return(0,P._t)("settings|labs|dialog_title",void 0,t);case wa.v.Mjolnir:return(0,P._t)("settings|labs_mjolnir|dialog_title",void 0,t);case wa.v.Help:return(0,P._t)("setting|help_about|dialog_title",void 0,t)}}function tI(e){const t=(0,Oe.ti)($.f.Voip),n=(0,Oe.ti)("feature_mjolnir"),[i,r]=(0,s.useState)(e.showMsc4108QrCode),o=()=>{const r=[];return r.push(new PS.oz(wa.v.Account,(0,P.AO)("settings|account|title"),s.createElement(pp,null),s.createElement(uC,{closeSettingsFn:e.onFinished}),"UserSettingsGeneral")),r.push(new PS.oz(wa.v.SessionManager,(0,P.AO)("settings|sessions|title"),s.createElement(fS,null),s.createElement(QR,{showMsc4108QrCode:i}),void 0)),r.push(new PS.oz(wa.v.Appearance,(0,P.AO)("common|appearance"),s.createElement(k_,null),s.createElement(HC,null),"UserSettingsAppearance")),r.push(new PS.oz(wa.v.Notifications,(0,P.AO)("notifications|enable_prompt_toast_title"),s.createElement(A_,null),s.createElement($x,null),"UserSettingsNotifications")),r.push(new PS.oz(wa.v.Preferences,(0,P.AO)("common|preferences"),s.createElement(yS,null),s.createElement(nk,{closeSettingsFn:e.onFinished}),"UserSettingsPreferences")),r.push(new PS.oz(wa.v.Keyboard,(0,P.AO)("settings|keyboard|title"),s.createElement(ES,null),s.createElement(Mk,null),"UserSettingsKeyboard")),r.push(new PS.oz(wa.v.Sidebar,(0,P.AO)("settings|sidebar|title"),s.createElement(SS,null),s.createElement(Ik,null),"UserSettingsSidebar")),t&&r.push(new PS.oz(wa.v.Voice,(0,P.AO)("settings|voip|title"),s.createElement(CS,null),s.createElement(rk,null),"UserSettingsVoiceVideo")),r.push(new PS.oz(wa.v.Security,(0,P.AO)("room_settings|security|title"),s.createElement(kS,null),s.createElement(ax,{closeSettingsFn:e.onFinished}),"UserSettingsSecurityPrivacy")),(hC()||V.A.getFeatureSettingNames().some((e=>V.A.getBetaInfo(e))))&&r.push(new PS.oz(wa.v.Labs,(0,P.AO)("common|labs"),s.createElement(IS,null),s.createElement(gC,null),"UserSettingsLabs")),n&&r.push(new PS.oz(wa.v.Mjolnir,(0,P.AO)("labs_mjolnir|title"),s.createElement(TS.A,null),s.createElement(pk,null),"UserSettingMjolnir")),r.push(new PS.oz(wa.v.Help,(0,P.AO)("setting|help_about|title"),s.createElement(Tg,null),s.createElement(dk,null),"UserSettingsHelpAbout")),r},[a,l]=(0,PS.yz)(o(),wa.v.Account,e.initialTabId),[c,d]=function(){const e=(0,s.useRef)(new vA),[t,n]=(0,s.useState)(e.current.getActiveToast()),i=(0,s.useCallback)((()=>{n(e.current.getActiveToast())}),[n,e]);return(0,s.useEffect)((()=>{e.current.setCallback(i)}),[e,i]),[t,e.current]}();return s.createElement(Wa.A.Provider,{value:e.sdkContext},s.createElement(gA.Provider,{value:d},s.createElement(Pa.A,{className:"mx_UserSettingsDialog",hasCancel:!0,onFinished:e.onFinished,title:eI(a),titleClass:"mx_UserSettingsDialog_title"},s.createElement("div",{className:"mx_SettingsDialog_content"},s.createElement(PS.Ay,{tabs:o(),activeTabId:a,screenName:"UserSettings",onChange:e=>{l(e),r(!1)},responsive:!0})),s.createElement("div",{className:"mx_SettingsDialog_toastContainer"},c&&s.createElement(gS,null,c)))))}var nI=n("./src/components/views/dialogs/CreateRoomDialog.tsx");class iI extends s.Component{render(){return s.createElement("div",null,s.createElement("h2",null,(0,P._t)("Verified!")),s.createElement("p",null,(0,P._t)("The sharing of your Tchap Keys has succeeded. Your messages will be unlocked.")),s.createElement(Da.A,{onPrimaryButtonClick:this.props.onDone,primaryButton:(0,P._t)("Finish"),hasCancel:!1}))}}class rI extends s.Component{render(){return s.createElement("div",null,s.createElement("p",null,(0,P._t)("encryption|verification|other_party_cancelled")),s.createElement(Da.A,{primaryButton:(0,P._t)("action|ok"),hasCancel:!1,onPrimaryButtonClick:this.props.onDone}))}}var sI=n("./src/components/views/verification/VerificationShowSas.tsx");class oI extends s.Component{constructor(e){super(e),(0,h.A)(this,"showSasEvent",void 0),(0,h.A)(this,"onFinished",(()=>{this.props.onFinished(3===this.state.phase)})),(0,h.A)(this,"onCancelClick",(()=>{this.props.onFinished(3===this.state.phase)})),(0,h.A)(this,"onContinueClick",(()=>{this.setState({phase:2}),this.props.verifier.verify().then((()=>{this.setState({phase:3})})).catch((e=>{o.v.log("Verification failed",e)}))})),(0,h.A)(this,"onVerifierShowSas",(e=>{this.showSasEvent=e,this.setState({phase:1,sas:e.sas})})),(0,h.A)(this,"onVerifierCancel",(()=>{this.setState({phase:4})})),(0,h.A)(this,"onSasMatchesClick",(()=>{var e;null===(e=this.showSasEvent)||void 0===e||e.confirm(),this.setState({phase:2})})),(0,h.A)(this,"onVerifiedDoneClick",(()=>{this.props.onFinished(!0)}));let t=0;this.props.verifier.hasBeenCancelled&&(o.v.log("Verifier was cancelled in the background."),t=4),this.showSasEvent=null,this.state={phase:t,sasVerified:!1,opponentProfile:null,opponentProfileError:null,sas:null}}componentDidMount(){this.props.verifier.on(f.VerifierEvent.ShowSas,this.onVerifierShowSas),this.props.verifier.on(f.VerifierEvent.Cancel,this.onVerifierCancel),this.fetchOpponentProfile()}componentWillUnmount(){4!==this.state.phase&&3!==this.state.phase&&this.props.verifier.cancel(new Error("User cancel")),this.props.verifier.removeListener(f.VerifierEvent.ShowSas,this.onVerifierShowSas)}async fetchOpponentProfile(){try{const e=await E.J.safeGet().getProfileInfo(this.props.verifier.userId);this.setState({opponentProfile:e})}catch(e){this.setState({opponentProfileError:e})}}renderPhaseStart(){this.props.verifier.userId,E.J.safeGet().getUserId();let e;const t=this.state.opponentProfile;if(t){const n=t.avatar_url?(0,Up.lH)(t.avatar_url).getSquareThumbnailHttp(48):null;e=s.createElement("div",{className:"mx_IncomingSasDialog_opponentProfile"},s.createElement(ja.A,{name:t.displayname,idName:this.props.verifier.userId,url:n,size:"48px"}),s.createElement("h2",null,t.displayname))}else e=this.state.opponentProfileError?s.createElement("div",null,s.createElement(ja.A,{name:this.props.verifier.userId.slice(1),idName:this.props.verifier.userId,size:"48px"}),s.createElement("h2",null,this.props.verifier.userId)):s.createElement(Na.A,null);return s.createElement("div",null,s.createElement("p",null,(0,P._t)("One of your devices <b>wants to check your Tchap Keys</b> to unlock your messages.",{},{b:e=>s.createElement("b",null,e)})),s.createElement(Da.A,{primaryButton:(0,P._t)("action|continue"),hasCancel:!0,onPrimaryButtonClick:this.onContinueClick,onCancel:this.onCancelClick}))}renderPhaseShowSas(){return this.showSasEvent?s.createElement(sI.A,{sas:this.showSasEvent.sas,onCancel:this.onCancelClick,onDone:this.onSasMatchesClick,isSelf:this.props.verifier.userId===E.J.safeGet().getUserId(),inDialog:!0}):null}renderPhaseWaitForPartnerToConfirm(){return s.createElement("div",null,s.createElement(Na.A,null),s.createElement("p",null,(0,P._t)("encryption|verification|incoming_sas_dialog_waiting")))}renderPhaseVerified(){return s.createElement(iI,{onDone:this.onVerifiedDoneClick})}renderPhaseCancelled(){return s.createElement(rI,{onDone:this.onCancelClick})}render(){let e;switch(this.state.phase){case 0:e=this.renderPhaseStart();break;case 1:e=this.renderPhaseShowSas();break;case 2:e=this.renderPhaseWaitForPartnerToConfirm();break;case 3:e=this.renderPhaseVerified();break;case 4:e=this.renderPhaseCancelled()}return s.createElement(Pa.A,{title:(0,P._t)("encryption|verification|incoming_sas_dialog_title"),onFinished:this.onFinished,fixedWidth:!1},e)}}var aI=n("./src/stores/SetupEncryptionStore.ts"),lI=n("./src/components/structures/auth/SetupEncryptionBody.tsx");class cI extends s.PureComponent{render(){return s.createElement("div",{className:"mx_CompleteSecurityBody"},this.props.children)}}const dI=()=>{var e;const t=u.Ay.getObject("branding"),n=null!==(e=null==t?void 0:t.get("auth_footer_links"))&&void 0!==e?e:[{text:"Blog",url:"https://element.io/blog"},{text:"Mastodon",url:"https://mastodon.matrix.org/@Element"},{text:"GitHub",url:"https://github.com/element-hq/element-web"}],i=[];for(const e of n)i.push(s.createElement("a",{href:e.url,key:e.text,target:"_blank",rel:"noreferrer noopener"},e.text));return s.createElement("footer",{className:"mx_AuthFooter",role:"contentinfo"},i,s.createElement("a",{href:"https://matrix.org",target:"_blank",rel:"noreferrer noopener"},(0,P._t)("powered_by_matrix")))},uI=()=>s.createElement("header",{role:"banner",className:"lasuite fr-header lasuite-header"},s.createElement("div",{className:"fr-header__body"},s.createElement("div",{className:"fr-container lasuite-container"},s.createElement("div",{className:"fr-header__body-row"},s.createElement("div",{className:"fr-header__brand fr-enlarge-link"},s.createElement("div",{className:"fr-header__brand-top"},s.createElement("div",{className:"fr-header__logo"},s.createElement("p",{className:"fr-logo"},"RÃ©publique",s.createElement("br",null),"FranÃ§aise"))),s.createElement("div",{className:"fr-header__service"},s.createElement("a",{className:"lasuite-header__service-link ui-home",href:"/",title:"Accueil - Tchap - DINUM"},s.createElement("img",{src:"/themes/tchap/img/logos/tchap-logo.svg",alt:"",className:"lasuite-header__service-logo fr-responsive-img",width:"32",height:"32"}),s.createElement("p",{className:"fr-header__service-title lasuite-header__service-title"},"Tchap")))),s.createElement("div",{className:"fr-header__tools"},s.createElement("div",{className:"fr-header__tools-links lasuite-header__tools-links","data-fr-js-header-links":"true"},s.createElement("ul",{className:"fr-btns-group"},s.createElement("li",{className:"lasuite-nomobile"},s.createElement("button",{type:"button",className:"lasuite-gaufre-btn lasuite-gaufre-btn--vanilla js-lasuite-gaufre-btn",title:"Les services de La Suite numÃ©rique"},"Les services de La Suite numÃ©rique")))))))));class mI extends s.PureComponent{static getWelcomeBackgroundUrl(){if(mI.welcomeBackgroundUrl)return mI.welcomeBackgroundUrl;const e=u.Ay.getObject("branding");mI.welcomeBackgroundUrl="themes/element/img/backgrounds/lake.jpg";const t=null==e?void 0:e.get("welcome_background_url");if(t)if(Array.isArray(t)){const e=Math.floor(Math.random()*t.length);mI.welcomeBackgroundUrl=t[e]}else mI.welcomeBackgroundUrl=t;return mI.welcomeBackgroundUrl}render(){const e={background:`center/cover fixed url(${mI.getWelcomeBackgroundUrl()})`},t={position:"absolute",top:0,right:0,bottom:0,left:0,filter:"blur(40px)",background:e.background};return s.createElement("div",{className:"mx_AuthPage",style:e},s.createElement(uI,null),s.createElement("div",{className:"mx_AuthPage_modal",style:{position:"relative",background:"initial"}},s.createElement("div",{className:"mx_AuthPage_modalBlur",style:t}),s.createElement("div",{className:"mx_AuthPage_modalContent",style:{display:"flex",zIndex:1,background:"rgba(255, 255, 255, 0.59)",borderRadius:"8px"}},this.props.children)),s.createElement(dI,null))}}(0,h.A)(mI,"welcomeBackgroundUrl",void 0);class pI extends s.Component{constructor(e){super(e),(0,h.A)(this,"onStoreUpdate",(()=>{const e=aI.s.sharedInstance();this.setState({phase:e.phase,lostKeys:e.lostKeys()})})),(0,h.A)(this,"onSkipClick",(()=>{aI.s.sharedInstance().skip()}));const t=aI.s.sharedInstance();t.start(),this.state={phase:t.phase,lostKeys:t.lostKeys()}}componentDidMount(){aI.s.sharedInstance().on("update",this.onStoreUpdate)}componentWillUnmount(){const e=aI.s.sharedInstance();e.off("update",this.onStoreUpdate),e.stop()}render(){const{phase:e,lostKeys:t}=this.state;let n,i;if(e===aI.a.Loading)return null;if(e===aI.a.Intro)t?i=(0,P._t)("encryption|verification|after_new_login|unable_to_verify"):(n=s.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),i=(0,P._t)("encryption|verification|after_new_login|verify_this_device"));else if(e===aI.a.Done)n=s.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_verified"}),i=(0,P._t)("encryption|verification|after_new_login|device_verified");else if(e===aI.a.ConfirmSkip)n=s.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),i=(0,P._t)("common|are_you_sure");else if(e===aI.a.Busy)n=s.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),i=(0,P._t)("encryption|verification|after_new_login|verify_this_device");else if(e===aI.a.ConfirmReset)n=s.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),i=(0,P._t)("encryption|verification|after_new_login|reset_confirmation");else if(e!==aI.a.Finished)throw new Error(`Unknown phase ${e}`);let r;return u.Ay.get("force_verification")||e!==aI.a.Intro&&e!==aI.a.ConfirmReset||(r=s.createElement(Ae.A,{onClick:this.onSkipClick,className:"mx_CompleteSecurity_skip","aria-label":(0,P._t)("encryption|verification|after_new_login|skip_verification")})),s.createElement(mI,null,s.createElement(cI,null,s.createElement("h1",{className:"mx_CompleteSecurity_header"},n,i,r),s.createElement("div",{className:"mx_CompleteSecurity_body"},s.createElement(lI.A,{onFinished:this.props.onFinished}))))}}function hI(e){var t;(0,P.UK)()!==e&&(V.A.setValue("language",null,ae.p.DEVICE,e),null===(t=l.A.get())||void 0===t||t.reload())}function gI({disabled:e}){return u.Ay.get("disable_login_language_selector")?s.createElement("div",null):s.createElement(Yx,{className:"mx_AuthBody_language",onOptionChange:hI,value:(0,P.UK)(),disabled:e})}const vI=`<a href="https://matrix.org" target="_blank" rel="noreferrer noopener">\n    <img width="79" height="34" alt="Matrix" style="padding-left: 1px;vertical-align: middle" src="${n("./res/img/matrix.svg").A}"/>\n</a>`;class fI extends s.PureComponent{render(){const e=u.Ay.getObject("embedded_pages");let t;e&&(t=e.get("welcome_url"));const n={"$riot:ssoUrl":"#/start_sso","$riot:casUrl":"#/start_cas",$matrixLogo:vI,"[matrix]":vI};if(!t){var i;const e=u.Ay.getObject("branding"),r=null!==(i=null==e?void 0:e.get("auth_header_logo_url"))&&void 0!==i?i:"themes/element/img/logos/element-logo.svg";n.$logoUrl=r,t=Vl.A.isSSOFlowActive()?"welcome_sso.html":"welcome.html",n.$proconnectFaq=zl.A.helpProconnectInstances}return s.createElement(mI,null,s.createElement("div",{className:re()("mx_Welcome",{mx_WelcomePage_registrationDisabled:!V.A.getValue($.f.Registration)})},s.createElement(Nd,{className:"mx_WelcomePage",url:t,replaceMap:n}),s.createElement(gI,null)))}}function _I(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{d:"M6 22c-.55 0-1.02-.196-1.412-.587A1.926 1.926 0 0 1 4 20V10c0-.55.196-1.02.588-1.412A1.926 1.926 0 0 1 6 8h1V6c0-1.383.487-2.563 1.463-3.538C9.438 1.487 10.617 1 12 1s2.563.488 3.537 1.462C16.512 3.438 17 4.617 17 6v2h1c.55 0 1.02.196 1.413.588.391.391.587.862.587 1.412v10c0 .55-.196 1.02-.587 1.413A1.926 1.926 0 0 1 18 22H6ZM9 8h6V6c0-.833-.292-1.542-.875-2.125A2.893 2.893 0 0 0 12 3c-.833 0-1.542.292-2.125.875A2.893 2.893 0 0 0 9 6v2Z"})})}_I.displayName="LockSolidIcon";const yI=(0,s.forwardRef)(_I);class bI{constructor(e,t){(0,h.A)(this,"client",void 0),(0,h.A)(this,"clientSecret",void 0),(0,h.A)(this,"password",""),(0,h.A)(this,"sessionId",""),(0,h.A)(this,"logoutDevices",!1),(0,h.A)(this,"sendAttempt",0),this.client=(0,i.createClient)({baseUrl:e,idBaseUrl:t}),this.clientSecret=this.client.generateClientSecret()}requestResetToken(e){return this.sendAttempt++,this.client.requestPasswordEmailToken(e,this.clientSecret,this.sendAttempt).then((e=>(this.sessionId=e.sid,e)),(function(e){throw"M_THREEPID_NOT_FOUND"===e.errcode?e.message=(0,P._t)("auth|reset_password_email_not_found_title"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}setLogoutDevices(e){this.logoutDevices=e}async setNewPassword(e){this.password=e,await this.checkEmailLinkClicked()}async checkEmailLinkClicked(){const e={sid:this.sessionId,client_secret:this.clientSecret};try{await this.client.setPassword({type:"m.login.email.identity",threepid_creds:e},this.password,this.logoutDevices)}catch(e){throw 401===e.httpStatus?e.message=(0,P._t)("settings|general|add_email_failed_verification"):404===e.httpStatus?e.message=(0,P._t)("auth|reset_password_email_not_associated"):e.httpStatus&&(e.message+=` (Status ${e.httpStatus})`),e}}}class EI extends s.PureComponent{render(){var e;const t=u.Ay.getObject("branding"),n=null!==(e=null==t?void 0:t.get("auth_header_logo_url"))&&void 0!==e?e:"themes/element/img/logos/element-logo.svg";return s.createElement("aside",{className:"mx_AuthHeaderLogo"},s.createElement("img",{src:n,alt:"Element"}))}}class wI extends s.Component{render(){return s.createElement("div",{className:"mx_AuthHeader"},s.createElement(EI,null),s.createElement(gI,{disabled:this.props.disableLanguageSelector}))}}function SI({flex:e,className:t,children:n}){return s.createElement("main",{className:re()("mx_AuthBody",t,{mx_AuthBody_flex:e})},n)}function AI(e,t){return(0,dl.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,dl.jsx)("path",{d:"M4 4h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Zm0 5.111a1 1 0 0 0 .514.874l7 3.89a1 1 0 0 0 .972 0l7-3.89a1 1 0 1 0-.972-1.748L12 11.856 5.486 8.237A1 1 0 0 0 4 9.111Z"})})}AI.displayName="EmailSolidIcon";const CI=(0,s.forwardRef)(AI);var xI=n("./src/components/structures/ErrorMessage.tsx");const kI=({email:e,errorText:t,homeserver:n,loading:i,onInputChanged:r,onLoginClick:o,onSubmitForm:a})=>{const l=i?s.createElement(Na.A,{w:16,h:16}):(0,P._t)("auth|forgot_password_send_email"),c=(0,s.useRef)(null);return s.createElement(s.Fragment,null,s.createElement(CI,{className:"mx_AuthBody_icon"}),s.createElement("h1",null,(0,P._t)("auth|enter_email_heading")),s.createElement("form",{onSubmit:async e=>{var t,n,i;await(null===(t=c.current)||void 0===t?void 0:t.validate({allowEmpty:!1}))?a(e):(null===(n=c.current)||void 0===n||n.focus(),null===(i=c.current)||void 0===i||i.validate({allowEmpty:!1,focused:!0}))}},s.createElement("fieldset",{disabled:i},s.createElement("div",{className:"mx_AuthBody_fieldRow"},s.createElement(NA,{name:"reset_email",label:(0,P.AO)("common|email_address"),labelRequired:(0,P.AO)("auth|forgot_password_email_required"),labelInvalid:(0,P.AO)("auth|forgot_password_email_invalid"),value:e,autoFocus:!0,onChange:e=>r("email",e),fieldRef:c})),t&&s.createElement(xI.K,{message:t}),s.createElement("button",{type:"submit",className:"mx_Login_submit"},l),s.createElement("div",{className:"mx_AuthBody_button-container"},s.createElement(Ae.A,{className:"mx_AuthBody_sign-in-instead-button",element:"button",kind:"link",onClick:e=>{e.preventDefault(),o()}},(0,P._t)("auth|sign_in_instead"))))))};var RI=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/restart.js"),II=n("./res/img/element-icons/email-prompt.svg");const TI=(e,t)=>{const n=(0,s.useRef)(),[i,r]=(0,s.useState)(e);return(0,s.useEffect)((()=>()=>{clearTimeout(n.current)})),{toggle:()=>{r(!e),n.current=window.setTimeout((()=>r(e)),t)},value:i}},PI=({email:e,errorText:t,onReEnterEmailClick:n,onSubmitForm:i,onResendClick:r})=>{const{toggle:o,value:a}=TI(!1,2500);return s.createElement(s.Fragment,null,s.createElement(II.I,{className:"mx_AuthBody_emailPromptIcon--shifted"}),s.createElement("h1",null,(0,P._t)("auth|uia|email_auth_header")),s.createElement("div",{className:"mx_AuthBody_text"},s.createElement("p",null,(0,P._t)("auth|check_email_explainer",{email:e},{b:e=>s.createElement("strong",null,e)})),s.createElement("div",{className:"mx_AuthBody_did-not-receive"},s.createElement("span",{className:"mx_VerifyEMailDialog_text-light"},(0,P._t)("auth|check_email_wrong_email_prompt")),s.createElement(Ae.A,{className:"mx_AuthBody_resend-button",kind:"link",onClick:n},(0,P._t)("auth|check_email_wrong_email_button"))),s.createElement(xI.K,{message:(0,P._t)("auth|warning|dont_close_windows")})),t&&s.createElement(xI.K,{message:t}),s.createElement("input",{onClick:i,type:"button",className:"mx_Login_submit",value:(0,P._t)("action|next")}),s.createElement("div",{className:"mx_AuthBody_did-not-receive"},s.createElement("span",{className:"mx_VerifyEMailDialog_text-light"},(0,P._t)("auth|check_email_resend_prompt")),s.createElement(Te.m,{description:(0,P._t)("auth|check_email_resend_tooltip"),placement:"top",open:a},s.createElement(Ae.A,{className:"mx_AuthBody_resend-button",kind:"link",onClick:async()=>{await r(),o()}},s.createElement(RI.A,{className:"mx_Icon mx_Icon_16"}),(0,P._t)("action|resend")))))},NI=({email:e,errorText:t,onCloseClick:n,onReEnterEmailClick:i,onResendClick:r})=>{const{toggle:o,value:a}=TI(!1,2500);return s.createElement(s.Fragment,null,s.createElement(II.I,{className:"mx_AuthBody_emailPromptIcon"}),s.createElement("h1",null,(0,P._t)("auth|verify_email_heading")),s.createElement("p",null,(0,P._t)("auth|verify_email_explainer",{email:e},{b:e=>s.createElement("strong",null,e)})),s.createElement("div",{className:"mx_AuthBody_did-not-receive"},s.createElement("span",{className:"mx_VerifyEMailDialog_text-light"},(0,P._t)("auth|check_email_resend_prompt")),s.createElement(Te.m,{description:(0,P._t)("auth|check_email_resend_tooltip"),placement:"top",open:a},s.createElement(Ae.A,{className:"mx_AuthBody_resend-button",kind:"link",onClick:async()=>{await r(),o()}},s.createElement(RI.A,{className:"mx_Icon mx_Icon_16"}),(0,P._t)("action|resend"))),t&&s.createElement(xI.K,{message:t})),s.createElement("div",{className:"mx_AuthBody_did-not-receive"},s.createElement("span",{className:"mx_VerifyEMailDialog_text-light"},(0,P._t)("auth|check_email_wrong_email_prompt")),s.createElement(Ae.A,{className:"mx_AuthBody_resend-button",kind:"link",onClick:i},(0,P._t)("auth|check_email_wrong_email_button"))),s.createElement(Ae.A,{onClick:n,className:"mx_Dialog_cancelButton","aria-label":(0,P._t)("dialog_close_label")}))};var DI=function(e){return e[e.EnterEmail=1]="EnterEmail",e[e.SendingEmail=2]="SendingEmail",e[e.EmailSent=3]="EmailSent",e[e.PasswordInput=4]="PasswordInput",e[e.ResettingPassword=5]="ResettingPassword",e[e.Done=6]="Done",e}(DI||{});class MI extends s.Component{constructor(e){super(e),(0,h.A)(this,"unmounted",!1),(0,h.A)(this,"reset",void 0),(0,h.A)(this,"fieldPassword",null),(0,h.A)(this,"fieldPasswordConfirm",null),(0,h.A)(this,"useNewServerConfig",(async e=>{console.log("Using serverConfig corresponding to this email :",e),this.reset=new bI(e.hsUrl,e.isUrl),await this.checkServerLiveliness(e)})),(0,h.A)(this,"sendVerificationMail",(async()=>{try{return await this.reset.requestResetToken(this.state.email),!0}catch(e){this.handleError(e)}return!1})),(0,h.A)(this,"onSubmitForm",(async e=>{if(e.preventDefault(),![DI.SendingEmail,DI.ResettingPassword].includes(this.state.phase))switch(this.setState({errorText:""}),this.state.phase){case DI.EnterEmail:this.onPhaseEmailInputSubmit();break;case DI.EmailSent:this.onPhaseEmailSentSubmit();break;case DI.PasswordInput:this.onPhasePasswordInputSubmit()}})),(0,h.A)(this,"onInputChanged",((e,t)=>{let n=t.currentTarget.value;"email"===e&&(n=n.trim()),this.setState({[e]:n})})),this.state={phase:DI.EnterEmail,email:"",password:"",password2:"",errorText:null,serverIsAlive:!0,serverDeadError:"",logoutDevices:!1}}componentDidUpdate(e){}componentWillUnmount(){this.unmounted=!0}async checkServerLiveliness(e){try{if(await c.A.validateServerConfigWithStaticUrls(e.hsUrl,e.isUrl),this.unmounted)return!1;this.setState({serverIsAlive:!0})}catch(e){if(this.unmounted)return!1;const{serverIsAlive:t,serverDeadError:n}=c.A.authComponentStateForError(e,"forgot_password");return this.setState({serverIsAlive:t,errorText:n}),t}return!0}async onPhaseEmailInputSubmit(){this.phase=DI.SendingEmail;const e=await oC.A.fetchHomeserverForEmail(this.state.email);if(!e)return void this.setState({serverIsAlive:!1,errorText:NE.A.getServerDownMessage(),phase:DI.EnterEmail});const t=await oC.A.makeValidatedServerConfig(e);await this.useNewServerConfig(t),await this.sendVerificationMail()?this.phase=DI.EmailSent:this.phase=DI.EnterEmail}handleError(e){if(429!==(null==e?void 0:e.httpStatus))"ConnectionError"!==(null==e?void 0:e.name)?this.setState({errorText:e.message}):this.setState({errorText:(0,P._t)("cannot_reach_homeserver")+": "+(0,P._t)("cannot_reach_homeserver_detail")});else{var t;const n=parseInt(null==e||null===(t=e.data)||void 0===t?void 0:t.retry_after_ms,10),i=isNaN(n)?(0,P._t)("auth|reset_password|rate_limit_error"):(0,P._t)("auth|reset_password|rate_limit_error_with_time",{timeout:(0,Bp.Xo)(n/1e3)});this.setState({errorText:i})}}async onPhaseEmailSentSubmit(){this.setState({phase:DI.PasswordInput})}set phase(e){this.setState({phase:e})}async verifyFieldsBeforeSubmit(){const e=[this.fieldPassword,this.fieldPasswordConfirm],t=[];for(const n of e){if(!n)continue;await n.validate({allowEmpty:!1})||t.push(n)}return 0===t.length||(t[0].focus(),t[0].validate({allowEmpty:!1,focused:!0}),!1)}async onPhasePasswordInputSubmit(){if(!await this.verifyFieldsBeforeSubmit())return;if(this.state.logoutDevices){if(!await this.renderConfirmLogoutDevicesDialog())return}this.phase=DI.ResettingPassword,this.reset.setLogoutDevices(this.state.logoutDevices);try{return await this.reset.setNewPassword(this.state.password),void this.setState({phase:DI.Done})}catch(e){if(401!==e.httpStatus)return void this.handleError(e)}const e=A.Ay.createDialog(NI,{email:this.state.email,errorText:this.state.errorText,onCloseClick:()=>{e.close(),this.setState({phase:DI.PasswordInput})},onReEnterEmailClick:()=>{e.close(),this.setState({phase:DI.EnterEmail})},onResendClick:this.sendVerificationMail},"mx_VerifyEMailDialog",!1,!1,{onBeforeClose:async e=>("backgroundClick"===e&&this.setState({phase:DI.PasswordInput}),!0)});for(;this.state.phase===DI.ResettingPassword;)try{await this.reset.setNewPassword(this.state.password),this.setState({phase:DI.Done}),e.close()}catch{await(0,g.yy)(2e3)}}renderEnterEmail(){return s.createElement(kI,{email:this.state.email,errorText:this.state.errorText,homeserver:"",loading:this.state.phase===DI.SendingEmail,onInputChanged:this.onInputChanged,onLoginClick:this.props.onLoginClick,onSubmitForm:this.onSubmitForm})}async renderConfirmLogoutDevicesDialog(){const{finished:e}=A.Ay.createDialog(q.A,{title:(0,P._t)("common|warning"),description:s.createElement("div",null,s.createElement("p",null,(0,P._t)("auth|reset_password|other_devices_logout_warning_1")),s.createElement("p",null,(0,P._t)("auth|reset_password|other_devices_logout_warning_2"))),button:(0,P._t)("action|continue")}),[t]=await e;return!!t}renderCheckEmail(){return s.createElement(PI,{email:this.state.email,errorText:this.state.errorText,onReEnterEmailClick:()=>this.setState({phase:DI.EnterEmail}),onResendClick:this.sendVerificationMail,onSubmitForm:this.onSubmitForm})}renderSetPassword(){const e=this.state.phase===DI.ResettingPassword?s.createElement(Na.A,{w:16,h:16}):(0,P._t)("auth|reset_password_action");return s.createElement(s.Fragment,null,s.createElement(yI,{className:"mx_AuthBody_lockIcon"}),s.createElement("h1",null,(0,P._t)("auth|reset_password_title")),s.createElement("form",{onSubmit:this.onSubmitForm},s.createElement("fieldset",{disabled:this.state.phase===DI.ResettingPassword},s.createElement("div",{className:"mx_AuthBody_fieldRow"},s.createElement(xA.A,{name:"reset_password",type:"password",label:(0,P.AO)("auth|change_password_new_label"),value:this.state.password,minScore:3,fieldRef:e=>this.fieldPassword=e,onChange:this.onInputChanged.bind(this,"password"),autoComplete:"new-password"}),s.createElement(FA.A,{name:"reset_password_confirm",label:(0,P.AO)("auth|reset_password|confirm_new_password"),labelRequired:(0,P.AO)("auth|reset_password|password_not_entered"),labelInvalid:(0,P.AO)("auth|reset_password|passwords_mismatch"),value:this.state.password2,password:this.state.password,fieldRef:e=>this.fieldPasswordConfirm=e,onChange:this.onInputChanged.bind(this,"password2"),autoComplete:"new-password"})),s.createElement("div",{className:"mx_AuthBody_fieldRow"},s.createElement(ka.A,{onChange:()=>this.setState({logoutDevices:!this.state.logoutDevices}),checked:this.state.logoutDevices},(0,P._t)("auth|reset_password|sign_out_other_devices"))),this.state.errorText&&s.createElement(xI.K,{message:this.state.errorText}),s.createElement("button",{type:"submit",className:"mx_Login_submit"},e))))}renderDone(){return s.createElement(s.Fragment,null,s.createElement(xb.A,{className:"mx_Icon mx_Icon_32 mx_Icon_accent"}),s.createElement("h1",null,(0,P._t)("auth|reset_password|reset_successful")),this.state.logoutDevices?s.createElement("p",null,(0,P._t)("auth|reset_password|devices_logout_success")):null,s.createElement("input",{className:"mx_Login_submit",type:"button",onClick:this.props.onComplete,value:(0,P._t)("auth|reset_password|return_to_login")}))}render(){let e;switch(this.state.phase){case DI.EnterEmail:case DI.SendingEmail:e=this.renderEnterEmail();break;case DI.EmailSent:e=this.renderCheckEmail();break;case DI.PasswordInput:case DI.ResettingPassword:e=this.renderSetPassword();break;case DI.Done:e=this.renderDone();break;default:return o.v.warn(`unknown forgot password phase ${this.state.phase}`),void this.setState({phase:DI.EnterEmail})}return s.createElement(mI,null,s.createElement(wI,null),s.createElement(SI,{className:"mx_AuthBody_forgot-password"},e))}}async function OI(e,t,n){const r=e.getCrypto();if(!r)throw new Error("No crypto API found!");await r.bootstrapCrossSigning({authUploadDeviceSigningKeys:async r=>{if(n&&await async function(e){try{return await e.uploadDeviceSigningKeys(void 0,{}),o.v.log("uploadDeviceSigningKeys unexpectedly succeeded without UI auth!"),!1}catch(e){return e instanceof i.MatrixError&&e.data&&e.data.flows?e.data.flows.some((e=>1===e.stages.length&&"m.login.password"===e.stages[0])):(o.v.log("uploadDeviceSigningKeys advertised no flows!"),!1)}}(e))await r({type:"m.login.password",identifier:{type:"m.id.user",user:e.getUserId()},password:n});else if(t)await r({});else{const t={[AA.av.PHASE_PREAUTH]:{title:(0,P._t)("auth|uia|sso_title"),body:(0,P._t)("auth|uia|sso_preauth_body"),continueText:(0,P._t)("auth|sso"),continueKind:"primary"},[AA.av.PHASE_POSTAUTH]:{title:(0,P._t)("encryption|confirm_encryption_setup_title"),body:(0,P._t)("encryption|confirm_encryption_setup_body"),continueText:(0,P._t)("action|confirm"),continueKind:"primary"}},{finished:n}=A.Ay.createDialog(KA.A,{title:(0,P._t)("encryption|bootstrap_title"),matrixClient:e,makeRequest:r,aestheticsForStagePhases:{[AA.av.LOGIN_TYPE]:t,[AA.av.UNSTABLE_LOGIN_TYPE]:t}}),[i]=await n;if(!i)throw new Error("Cross-signing key upload auth canceled")}}})}const LI=({matrixClient:e,accountPassword:t,tokenLogin:n,onFinished:i})=>{const[r,a]=(0,s.useState)(!1),l=(0,s.useCallback)((async()=>{if(e.getCrypto()){a(!1);try{await OI(e,n,t),i(!0)}catch(e){if(n)return void i(!1);a(!0),o.v.error("Error bootstrapping cross-signing",e)}}}),[e,n,t,i]),c=(0,s.useCallback)((()=>{i(!1)}),[i]);let d;return(0,s.useEffect)((()=>{l()}),[l]),d=r?s.createElement("div",null,s.createElement("p",null,(0,P._t)("encryption|unable_to_setup_keys_error")),s.createElement("div",{className:"mx_Dialog_buttons"},s.createElement(Da.A,{primaryButton:(0,P._t)("action|retry"),onPrimaryButtonClick:l,onCancel:c}))):s.createElement("div",null,s.createElement(Na.A,null)),s.createElement(Pa.A,{className:"mx_CreateCrossSigningDialog",onFinished:i,title:(0,P._t)("encryption|bootstrap_title"),hasCancel:!1,fixedWidth:!1},s.createElement("div",null,d))};class FI extends s.Component{render(){return s.createElement(mI,null,s.createElement(cI,null,s.createElement(LI,{matrixClient:this.props.matrixClient,onFinished:this.props.onFinished,accountPassword:this.props.accountPassword,tokenLogin:this.props.tokenLogin})))}}var UI=n("./src/Login.ts");class BI extends s.PureComponent{constructor(e){super(e),(0,h.A)(this,"defaultServer",void 0),(0,h.A)(this,"fieldRef",(0,s.createRef)()),(0,h.A)(this,"validatedConf",void 0),(0,h.A)(this,"onDefaultChosen",(()=>{this.setState({defaultChosen:!0})})),(0,h.A)(this,"onOtherChosen",(()=>{this.setState({defaultChosen:!1})})),(0,h.A)(this,"onHomeserverChange",(e=>{this.setState({otherHomeserver:e.target.value})})),(0,h.A)(this,"validate",(0,Ip.A)({deriveData:async({value:e})=>{let t=(null!=e?e:"").trim();if(!t.includes("://"))try{const e=await i.AutoDiscovery.findClientConfig(t);return this.validatedConf=await c.A.buildValidatedConfigFromDiscovery(t,e),{}}catch(e){o.v.error(`Attempted ${t} as a server_name but it failed`,e)}t.includes("://")||(t="https://"+t);try{return this.validatedConf=await c.A.validateServerConfigWithStaticUrls(t),{}}catch(e){o.v.error(e);if(c.A.authComponentStateForError(e).serverErrorIsFatal){let t=(0,P._t)("auth|server_picker_failed_validate_homeserver");return e instanceof P.P7&&e.translatedMessage&&(t=e.translatedMessage),{error:t}}try{return this.validatedConf=await c.A.validateServerConfigWithStaticUrls(t,void 0,!0),{}}catch(e){return o.v.error(e),{error:(0,P._t)("auth|server_picker_invalid_url")}}}},rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,P._t)("auth|server_picker_required")},{key:"valid",test:async function({value:e},{error:t}){return!e||!t},invalid:function({error:e}){return null!=e?e:null}}]})),(0,h.A)(this,"onHomeserverValidate",(e=>this.validate(e))),(0,h.A)(this,"onSubmit",(async e=>{var t;if(e.preventDefault(),this.state.defaultChosen)return void this.props.onFinished(this.defaultServer);var n,i;if(!await(null===(t=this.fieldRef.current)||void 0===t?void 0:t.validate({allowEmpty:!1})))return null===(n=this.fieldRef.current)||void 0===n||n.focus(),void(null===(i=this.fieldRef.current)||void 0===i||i.validate({allowEmpty:!1,focused:!0}));this.props.onFinished(this.validatedConf)}));const t=u.Ay.get();this.defaultServer=t.validated_server_config;const{serverConfig:n}=this.props;let r="";n.isDefault||(r=n.isNameResolvable&&n.hsName?n.hsName:n.hsUrl),this.state={defaultChosen:n.isDefault,otherHomeserver:r}}render(){let e;"matrix.org"===this.defaultServer.hsName&&(e=(0,P._t)("auth|server_picker_matrix.org"));let t=this.defaultServer.hsName;return this.defaultServer.hsNameIsDifferent&&(t=s.createElement(Kg.A,{className:"mx_Login_underlinedServerName",tooltip:this.defaultServer.hsUrl},this.defaultServer.hsName)),s.createElement(Pa.A,{title:this.props.title||(0,P._t)("auth|server_picker_title"),className:"mx_ServerPickerDialog",contentId:"mx_ServerPickerDialog",onFinished:this.props.onFinished,fixedWidth:!1,hasCancel:!0},s.createElement("form",{className:"mx_Dialog_content",id:"mx_ServerPickerDialog",onSubmit:this.onSubmit},s.createElement("p",null,(0,P._t)("auth|server_picker_intro")," ",e),s.createElement(jC.A,{name:"defaultChosen",value:"true",checked:this.state.defaultChosen,onChange:this.onDefaultChosen},t),s.createElement(jC.A,{name:"defaultChosen",value:"false",className:"mx_ServerPickerDialog_otherHomeserverRadio",checked:!this.state.defaultChosen,onChange:this.onOtherChosen,childrenInLabel:!1,"aria-label":(0,P._t)("auth|server_picker_custom")},s.createElement(Sa.A,{type:"text",className:"mx_ServerPickerDialog_otherHomeserver",label:(0,P._t)("auth|server_picker_custom"),onChange:this.onHomeserverChange,onFocus:this.onOtherChosen,ref:this.fieldRef,onValidate:this.onHomeserverValidate,value:this.state.otherHomeserver,validateOnChange:!1,validateOnFocus:!1,autoFocus:!0,id:"mx_homeserverInput"})),s.createElement("p",null,(0,P._t)("auth|server_picker_explainer")),s.createElement(Ae.A,{className:"mx_ServerPickerDialog_continue",kind:"primary",onClick:this.onSubmit},(0,P._t)("action|continue")),s.createElement("h2",null,(0,P._t)("action|learn_more")),s.createElement(Ra.A,{href:"https://matrix.org/docs/matrix-concepts/elements-of-matrix/#homeserver",target:"_blank",rel:"noreferrer noopener"},(0,P._t)("auth|server_picker_learn_more"))))}}const VI=()=>{const e=u.Ay.get().brand;A.Ay.createDialog(Ca.A,{title:(0,P._t)("auth|server_picker_title_default"),description:(0,P._t)("auth|server_picker_description",{brand:e}),button:(0,P._t)("action|dismiss"),hasCloseButton:!1,fixedWidth:!1},"mx_ServerPicker_helpDialog")},jI=({title:e,dialogTitle:t,serverConfig:n,onServerConfigChange:i,disabled:r})=>{const o=u.Ay.get("disable_custom_urls");let a;if(!o&&i){const e=()=>{((e,t,n)=>{A.Ay.createDialog(BI,{title:e,serverConfig:t,onFinished:n})})(t,n,(e=>{e&&i(e)}))};a=s.createElement(Ae.A,{className:"mx_ServerPicker_change",kind:"link",onClick:e,disabled:r},(0,P._t)("action|edit"))}let l,c=n.isNameResolvable?n.hsName:n.hsUrl;return n.hsNameIsDifferent&&(c=s.createElement(Kg.A,{className:"mx_Login_underlinedServerName",tooltip:n.hsUrl},n.hsName)),"matrix.org"===n.hsName&&(l=s.createElement("span",{className:"mx_ServerPicker_desc"},(0,P._t)("auth|server_picker_description_matrix.org"))),s.createElement("div",{className:"mx_ServerPicker"},s.createElement("h2",null,e||(0,P._t)("common|homeserver")),o?null:s.createElement(Ae.A,{className:"mx_ServerPicker_help",onClick:VI,"aria-label":(0,P._t)("common|help")}),s.createElement("span",{className:"mx_ServerPicker_server",title:"string"==typeof c?c:void 0},c),a,l)};var zI=n("./src/components/structures/auth/header/AuthHeaderContext.tsx");function WI({title:e,icon:t,serverPicker:n,children:i}){var r,o,a;const l=(0,s.useContext)(zI.h);if(!l)return s.createElement(s.Fragment,null);const c=null!==(r=l.state[0])&&void 0!==r?r:null;return s.createElement(s.Fragment,null,null!==(o=null==c?void 0:c.icon)&&void 0!==o?o:t,s.createElement("h1",null,null!==(a=null==c?void 0:c.title)&&void 0!==a?a:e),i,!0!==(null==c?void 0:c.hideServerPicker)&&n)}var HI=n("./src/components/structures/auth/header/AuthHeaderProvider.tsx"),GI=n("./src/components/structures/auth/header/AuthHeaderModifier.tsx"),KI=n("./src/utils/oidc/authorize.ts");function JI(){return s.createElement("div",{className:"tc_pronnect"},s.createElement("a",{href:"#/email-precheck-sso",className:"tc_ButtonParent tc_ButtonProconnect tc_Button_iconPC"},s.createElement("div",null,(0,P._t)("auth|proconnect|email_title"))))}function qI(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}const $I=(...e)=>{V.A.getValue("debug_registration")&&o.v.log.call(console,"Registration debuglog:",...e)};class YI extends s.Component{constructor(e){super(e),(0,h.A)(this,"loginLogic",void 0),(0,h.A)(this,"latestServerConfig",void 0),(0,h.A)(this,"oidcNativeFlowEnabled",!1),(0,h.A)(this,"unloadCallback",(e=>{if(this.state.doingUIAuth)return e.preventDefault(),e.returnValue="",""})),(0,h.A)(this,"onFormSubmit",(async e=>{const t=await oC.A.fetchHomeserverForEmail(e.email),n=await oC.A.makeValidatedServerConfig(t);this.props.onServerConfigChange(n),this.setState({errorText:"",busy:!0,formVals:e,doingUIAuth:!0,matrixClient:(0,i.createClient)({baseUrl:n.hsUrl,idBaseUrl:n.isUrl})})})),(0,h.A)(this,"requestEmailToken",((e,t,n,i)=>{if(!this.state.matrixClient)throw new Error("Matrix client has not yet been loaded");return this.state.matrixClient.requestRegisterEmailToken(e,t,n)})),(0,h.A)(this,"onUIAuthFinished",(async(e,t)=>{if(!this.state.matrixClient)throw new Error("Matrix client has not yet been loaded");if($I("Registration: ui authentication finished: ",{success:e,response:t}),!e){var n;let e=t.message||t.toString();if(t instanceof i.MatrixError&&"M_RESOURCE_LIMIT_EXCEEDED"===t.errcode){const n=(0,fe.AB)(t.data.limit_type,t.data.admin_contact,fe.Ch),i=(0,fe.AB)(t.data.limit_type,t.data.admin_contact,fe.aZ);e=s.createElement("div",null,s.createElement("p",null,n),s.createElement("p",null,i))}else if(null!==(n=t.flows)&&void 0!==n&&n.some((e=>e.stages.includes(i.AuthType.Msisdn)))){var r;(null!==(r=t.flows)&&void 0!==r?r:[]).some((e=>e.stages.includes(i.AuthType.Msisdn)))||(e=(0,P._t)("auth|unsupported_auth_msisdn"))}else t instanceof i.MatrixError&&"M_USER_IN_USE"===t.errcode?e=(0,P._t)("auth|username_in_use"):t instanceof i.MatrixError&&"M_THREEPID_IN_USE"===t.errcode?e=(0,P._t)("auth|3pid_in_use"):t instanceof i.MatrixError&&"M_THREEPID_DENIED"===t.errcode&&(e=(0,P._t)("That email is not allowed on Tchap",{},{a:e=>s.createElement("a",{href:zl.A.requestDomainUrl},e)}));return void this.setState({busy:!1,doingUIAuth:!1,errorText:e})}const a=t.user_id,l=t.access_token;if(!a||!l)throw new Error("Registration failed");E.J.setJustRegisteredUserId(a);const c={doingUIAuth:!1,registeredUsername:a,differentLoggedInUserId:void 0,completedNoSignin:!1,busy:!0},[u,m]=await d.hP();u&&!m&&u!==a&&(o.v.log(`Found a session for ${u} but ${a} has just registered.`),c.differentLoggedInUserId=u);const p=Boolean(this.state.formVals.email),h=Boolean(l);if($I("Registration: ui auth finished:",{hasEmail:p,hasAccessToken:h}),h&&!c.differentLoggedInUserId)if(this.props.mobileRegister){const e={user_id:a,home_server:this.state.matrixClient.getHomeserverUrl(),access_token:l,device_id:t.device_id},n=new CustomEvent("mobileregistrationresponse",{detail:e});window.dispatchEvent(n),c.busy=!1,c.completedNoSignin=!0}else await this.props.onLoggedIn({userId:a,deviceId:t.device_id,homeserverUrl:this.state.matrixClient.getHomeserverUrl(),identityServerUrl:this.state.matrixClient.getIdentityServerUrl(),accessToken:l},this.state.formVals.password),this.setupPushers();else c.busy=!1,c.completedNoSignin=!0;this.setState(c)})),(0,h.A)(this,"onLoginClick",(e=>{e.preventDefault(),e.stopPropagation(),this.props.onLoginClick()})),(0,h.A)(this,"onGoToFormClicked",(e=>{e.preventDefault(),e.stopPropagation(),this.replaceClient(this.props.serverConfig),this.setState({busy:!1,doingUIAuth:!1})})),(0,h.A)(this,"makeRegisterRequest",(e=>{if(!this.state.matrixClient)throw new Error("Matrix client has not yet been loaded");const t={username:this.state.formVals.username,password:this.state.formVals.password,initial_device_display_name:this.props.defaultDeviceDisplayName,auth:void 0,inhibit_login:void 0};return e&&(t.auth=e),t.username=void 0,$I("Registration: sending registration request:",e),this.state.matrixClient.registerRequest(t)})),(0,h.A)(this,"onLoginClickWithCheck",(async e=>{e.preventDefault();const t=await d.L6({ignoreGuest:!0});return t||this.props.onLoginClick(),t})),this.state={busy:!1,errorText:null,formVals:{email:this.props.email},doingUIAuth:Boolean(this.props.sessionId),flows:null,completedNoSignin:!1,serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:""},this.oidcNativeFlowEnabled=V.A.getValue(Nl.O5.OidcNativeFlow);const{hsUrl:t,isUrl:n,delegatedAuthentication:r}=this.props.serverConfig;this.loginLogic=new UI.A(t,n,null,{defaultDeviceDisplayName:"Element login check",delegatedAuthentication:this.oidcNativeFlowEnabled?r:void 0})}componentDidMount(){this.replaceClient(this.props.serverConfig),window.addEventListener("beforeunload",this.unloadCallback)}componentWillUnmount(){window.removeEventListener("beforeunload",this.unloadCallback)}componentDidUpdate(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl||this.replaceClient(this.props.serverConfig)}async replaceClient(e){this.latestServerConfig=e;const{hsUrl:t,isUrl:n}=e;this.setState({errorText:null,serverDeadError:null,serverErrorIsFatal:!1,busy:!0});try{if(await c.A.validateServerConfigWithStaticUrls(t,n),e!==this.latestServerConfig)return;this.setState({serverIsAlive:!0,serverErrorIsFatal:!1})}catch(t){if(e!==this.latestServerConfig)return;if(this.setState(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?qI(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):qI(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({busy:!1},c.A.authComponentStateForError(t,"register"))),this.state.serverErrorIsFatal)return}const r=(0,i.createClient)({baseUrl:t,idBaseUrl:n});this.loginLogic.setHomeserverUrl(t),this.loginLogic.setIdentityServerUrl(n);const s=this.oidcNativeFlowEnabled?e.delegatedAuthentication:void 0;let a,l;this.loginLogic.setDelegatedAuthentication(s);try{const t=await this.loginLogic.getFlows(!0);if(e!==this.latestServerConfig)return;a=t.find((e=>"m.login.sso"===e.type||"m.login.cas"===e.type)),l=t.find((e=>"oidcNativeFlow"===e.type))}catch(t){if(e!==this.latestServerConfig)return;o.v.error("Failed to get login flows to check for SSO support",t)}if(await new Promise((e=>{this.setState((({flows:e})=>({matrixClient:r,ssoFlow:a,oidcNativeFlow:l,flows:l?[]:e,busy:!1})),e)})),!l)try{if(!this.state.doingUIAuth){if(await this.makeRegisterRequest(null),e!==this.latestServerConfig)return;o.v.log("Expecting 401 from register request but got success!")}}catch(t){if(e!==this.latestServerConfig)return;t instanceof i.MatrixError&&401===t.httpStatus?this.setState({flows:t.data.flows}):t instanceof i.MatrixError&&(403===t.httpStatus||"M_FORBIDDEN"===t.errcode)?a?w.A.dispatch({action:"start_login"}):this.setState({serverErrorIsFatal:!0,errorText:(0,P._t)("auth|registration_disabled"),flows:[]}):(o.v.log("Unable to query for supported registration methods.",t),this.setState({errorText:(0,P._t)("auth|failed_query_registration_methods"),flows:[]}))}}setupPushers(){if(!this.props.brand)return Promise.resolve();const e=E.J.safeGet();return e.getPushers().then((t=>{const n=t.pushers;for(let t=0;t<n.length;++t)if("email"===n[t].kind){const i=n[t];i.data={brand:this.props.brand},e.setPusher(i).then((()=>{o.v.log("Set email branding to "+this.props.brand)}),(e=>{o.v.error("Couldn't set email branding: "+e)}))}}),(e=>{o.v.error("Couldn't get pushers: "+e)}))}getUIAuthInputs(){return{emailAddress:this.state.formVals.email,phoneCountry:this.state.formVals.phoneCountry,phoneNumber:this.state.formVals.phoneNumber}}renderRegisterComponent(){if(this.state.matrixClient&&this.state.doingUIAuth)return s.createElement(SA.A,{matrixClient:this.state.matrixClient,makeRequest:this.makeRegisterRequest,onAuthFinished:this.onUIAuthFinished,inputs:this.getUIAuthInputs(),requestEmailToken:this.requestEmailToken,sessionId:this.props.sessionId,clientSecret:this.props.clientSecret,emailSid:this.props.idSid,poll:!0});if(!this.state.matrixClient&&!this.state.busy)return null;if(this.state.busy||!this.state.flows)return s.createElement("div",{className:"mx_AuthBody_spinner"},s.createElement(Na.A,null));if(this.state.matrixClient&&this.state.oidcNativeFlow)return s.createElement(Ae.A,{className:"mx_Login_fullWidthButton",kind:"primary",onClick:async()=>{await(0,KI.N)(this.props.serverConfig.delegatedAuthentication,this.state.oidcNativeFlow.clientId,this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl,!0)}},(0,P._t)("action|continue"));if(this.state.matrixClient&&this.state.flows.length){let e;return!this.props.mobileRegister&&this.state.ssoFlow&&Vl.A.isSSOFlowActive()&&(e=s.createElement(s.Fragment,null,s.createElement(JI,null),s.createElement("p",{style:{textAlign:"center",fontWeight:"bold"}},(0,P._t)("auth|proconnect|or")))),s.createElement(s.Fragment,null,e,s.createElement(GA,{defaultUsername:this.state.formVals.username,defaultEmail:this.state.formVals.email,defaultPhoneCountry:this.state.formVals.phoneCountry,defaultPhoneNumber:this.state.formVals.phoneNumber,defaultPassword:this.state.formVals.password,onRegisterClick:this.onFormSubmit,flows:this.state.flows,serverConfig:this.props.serverConfig,canSubmit:!this.state.serverErrorIsFatal,matrixClient:this.state.matrixClient,mobileRegister:this.props.mobileRegister}))}return null}render(){let e;const t=this.state.errorText;let n;if(t&&(e=s.createElement("div",{className:"mx_Login_error"},t)),!this.state.serverIsAlive){const e=re()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});n=s.createElement("div",{className:e},this.state.serverDeadError)}const i=s.createElement("span",{className:"mx_AuthBody_changeFlow"},(0,P._t)("auth|sign_in_instead_prompt",{},{a:e=>s.createElement(Ae.A,{kind:"link_inline",onClick:this.onLoginClick},e)}));let r,o;if(this.state.doingUIAuth&&(r=s.createElement(Ae.A,{kind:"link",className:"mx_AuthBody_changeFlow",onClick:this.onGoToFormClicked},(0,P._t)("action|go_back"))),this.state.completedNoSignin){let e;e=this.props.mobileRegister?void 0:this.state.differentLoggedInUserId?s.createElement("div",null,s.createElement("p",null,(0,P._t)("auth|account_clash",{newAccountId:this.state.registeredUsername,loggedInUserId:this.state.differentLoggedInUserId})),s.createElement("p",null,s.createElement(Ae.A,{kind:"link_inline",onClick:async e=>{await this.onLoginClickWithCheck(e)&&w.A.dispatch({action:"view_welcome_page"})}},(0,P._t)("auth|account_clash_previous_account")))):s.createElement("h2",null,(0,P._t)("auth|log_in_new_account",{},{a:e=>s.createElement(Ae.A,{kind:"link_inline",onClick:async e=>{await this.onLoginClickWithCheck(e)&&w.A.dispatch({action:"view_home_page"})}},e)})),o=s.createElement("div",null,s.createElement("h1",null,(0,P._t)("auth|registration_successful")),e)}else o=this.props.mobileRegister?s.createElement(s.Fragment,null,s.createElement("h1",null,(0,P._t)("auth|mobile_create_account_title",{hsName:this.props.serverConfig.hsName})),e,n,this.renderRegisterComponent()):s.createElement(s.Fragment,null,s.createElement("div",{className:"mx_Register_mainContent"},s.createElement(WI,{title:(0,P._t)("auth|create_account_title"),serverPicker:s.createElement(jI,{title:(0,P._t)("auth|server_picker_title_registration"),dialogTitle:(0,P._t)("auth|server_picker_dialog_title"),serverConfig:this.props.serverConfig,onServerConfigChange:this.state.doingUIAuth?void 0:this.props.onServerConfigChange})},e,n),s.createElement(GI.j,{title:(0,P._t)("auth|register_action"),hideServerPicker:!0}),this.renderRegisterComponent()),s.createElement("div",{className:"mx_Register_footerActions"},r,i));return this.props.mobileRegister?s.createElement("div",{className:"mx_MobileRegister_body"},o):s.createElement(mI,null,s.createElement(wI,null),s.createElement(HI.T,null,s.createElement(SI,{flex:!0},o)))}}let ZI,XI,QI,eT;const tT=/^[0-9()\-\s]*$/;var nT=function(e){return e.Email="login_field_email",e.MatrixId="login_field_mxid",e.Phone="login_field_phone",e.Password="login_field_password",e}(nT||{});ZI=nT.Email,XI=nT.Phone,QI=nT.MatrixId,eT=nT.Password;class iT extends s.PureComponent{constructor(e){super(e),(0,h.A)(this,ZI,null),(0,h.A)(this,XI,null),(0,h.A)(this,QI,null),(0,h.A)(this,eT,null),(0,h.A)(this,"setDisplayPassword",(e=>{this.setState({displayPassword:e})})),(0,h.A)(this,"onForgotPasswordClick",(e=>{var t,n;e.preventDefault(),e.stopPropagation(),null===(t=(n=this.props).onForgotPasswordClick)||void 0===t||t.call(n)})),(0,h.A)(this,"onSubmitForm",(async e=>{e.preventDefault();if(await this.verifyFieldsBeforeSubmit())switch(this.state.loginType){case nT.Email:case nT.MatrixId:this.props.onSubmit(this.props.username,void 0,void 0,this.state.password);break;case nT.Phone:this.props.onSubmit(void 0,this.props.phoneCountry,this.props.phoneNumber,this.state.password)}})),(0,h.A)(this,"onUsernameChanged",(e=>{var t,n;null===(t=(n=this.props).onUsernameChanged)||void 0===t||t.call(n,e.target.value)})),(0,h.A)(this,"onUsernameBlur",(e=>{var t,n;null===(t=(n=this.props).onUsernameBlur)||void 0===t||t.call(n,e.target.value)})),(0,h.A)(this,"onLoginTypeChange",(e=>{var t,n;const i=e.target.value;this.setState({loginType:i}),null===(t=(n=this.props).onUsernameChanged)||void 0===t||t.call(n,"")})),(0,h.A)(this,"onPhoneCountryChanged",(e=>{var t,n;null===(t=(n=this.props).onPhoneCountryChanged)||void 0===t||t.call(n,e.iso2)})),(0,h.A)(this,"onPhoneNumberChanged",(e=>{var t,n;null===(t=(n=this.props).onPhoneNumberChanged)||void 0===t||t.call(n,e.target.value)})),(0,h.A)(this,"onPasswordChanged",(e=>{this.setState({password:e.target.value})})),(0,h.A)(this,"validateUsernameRules",(0,Ip.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,P._t)("auth|username_field_required_invalid")}]})),(0,h.A)(this,"onUsernameValidate",(async e=>{const t=await this.validateUsernameRules(e);return this.markFieldValid(nT.MatrixId,t.valid),t})),(0,h.A)(this,"onEmailValidate",(e=>{this.markFieldValid(nT.Email,e.valid)})),(0,h.A)(this,"validatePhoneNumberRules",(0,Ip.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,P._t)("auth|msisdn_field_required_invalid")},{key:"number",test:({value:e})=>!e||tT.test(e),invalid:()=>(0,P._t)("auth|msisdn_field_number_invalid")}]})),(0,h.A)(this,"onPhoneNumberValidate",(async e=>{const t=await this.validatePhoneNumberRules(e);return this.markFieldValid(nT.Password,t.valid),t})),(0,h.A)(this,"validatePasswordRules",(0,Ip.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,P._t)("auth|password_field_label")}]})),(0,h.A)(this,"onPasswordValidate",(async e=>{const t=await this.validatePasswordRules(e);return this.markFieldValid(nT.Password,t.valid),t})),this.state={displayPassword:!1,fieldValid:{},loginType:nT.Email,password:""}}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[this.state.loginType,nT.Password];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise((e=>this.setState({},e))),this.allFieldsValid())return!0;const n=this.findFirstInvalidField(t);return!n||(n.focus(),n.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){return Object.values(this.state.fieldValid).every(Boolean)}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}markFieldValid(e,t){const{fieldValid:n}=this.state;n[e]=t,this.setState({fieldValid:n})}renderLoginField(e,t){const n={error:!1};switch(e){case nT.Email:return n.error=this.props.loginIncorrect&&!this.props.username,s.createElement(NA,{id:"mx_LoginForm_email",className:re()(n),name:"username",autoComplete:"email",type:"email",key:"email_input",placeholder:"joe@example.com",value:this.props.username,onChange:this.onUsernameChanged,onBlur:this.onUsernameBlur,disabled:this.props.busy,autoFocus:t,onValidate:this.onEmailValidate,fieldRef:e=>{this[nT.Email]=e}});case nT.MatrixId:return n.error=this.props.loginIncorrect&&!this.props.username,s.createElement(Sa.A,{id:"mx_LoginForm_username",className:re()(n),name:"username",autoComplete:"username",key:"username_input",type:"text",label:(0,P._t)("common|username"),placeholder:(0,P._t)("common|username"),value:this.props.username,onChange:this.onUsernameChanged,onBlur:this.onUsernameBlur,disabled:this.props.busy,autoFocus:t,onValidate:this.onUsernameValidate,ref:e=>{this[nT.MatrixId]=e}});case nT.Phone:{n.error=this.props.loginIncorrect&&!this.props.phoneNumber;const e=s.createElement(LA,{value:this.props.phoneCountry,isSmall:!0,showPrefix:!0,onOptionChange:this.onPhoneCountryChanged});return s.createElement(Sa.A,{id:"mx_LoginForm_phone",className:re()(n),name:"phoneNumber",autoComplete:"tel-national",key:"phone_input",type:"text",label:(0,P._t)("auth|msisdn_field_label"),value:this.props.phoneNumber,prefixComponent:e,onChange:this.onPhoneNumberChanged,disabled:this.props.busy,autoFocus:t,onValidate:this.onPhoneNumberValidate,ref:e=>{this[nT.Password]=e}})}}}isLoginEmpty(){switch(this.state.loginType){case nT.Email:case nT.MatrixId:return!this.props.username;case nT.Phone:return!this.props.phoneCountry||!this.props.phoneNumber}}render(){let e;this.props.onForgotPasswordClick&&(e=s.createElement(Ae.A,{className:"mx_Login_forgot",disabled:this.props.busy,kind:"link",onClick:this.onForgotPasswordClick},(0,P._t)("auth|reset_password_button")));const t=re()({error:this.props.loginIncorrect&&!this.isLoginEmpty()}),i=!this.isLoginEmpty(),r=this.renderLoginField(this.state.loginType,!i);let o;return u.Ay.get().disable_3pid_login||(o=s.createElement("div",{className:"mx_Login_type_container"},s.createElement("label",{className:"mx_Login_type_label"},(0,P._t)("auth|identifier_label")),s.createElement(Sa.A,{element:"select",value:this.state.loginType,onChange:this.onLoginTypeChange,disabled:this.props.busy},s.createElement("option",{key:nT.MatrixId,value:nT.MatrixId},(0,P._t)("common|username")),s.createElement("option",{key:nT.Email,value:nT.Email},(0,P._t)("common|email_address")),s.createElement("option",{key:nT.Password,value:nT.Password},(0,P._t)("auth|msisdn_field_label"))))),s.createElement("div",null,s.createElement("form",{onSubmit:this.onSubmitForm},r,s.createElement(Sa.A,{id:"mx_LoginForm_password",className:t,autoComplete:"current-password",type:this.state.displayPassword?"text":"password",name:"password",label:(0,P._t)("common|password"),value:this.state.password,onChange:this.onPasswordChanged,disabled:this.props.busy,autoFocus:i,onValidate:this.onPasswordValidate,ref:e=>this[nT.Password]=e,postfixComponent:s.createElement("div",{className:"tc_textInput_postfixComponent",onMouseDown:()=>this.setDisplayPassword(!0),onMouseUp:()=>this.setDisplayPassword(!1)},s.createElement("img",{src:n("./res/img/grey-eye.svg").A,width:"24",height:"24",alt:(0,P._t)("Eye")}))}),e,!this.props.busy&&s.createElement("input",{className:"mx_Login_submit",type:"submit",value:(0,P._t)("action|sign_in"),disabled:this.props.disableSubmit})))}}function rT(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function sT(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?rT(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):rT(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}(0,h.A)(iT,"defaultProps",{onUsernameChanged:function(){},onUsernameBlur:function(){},onPhoneCountryChanged:function(){},onPhoneNumberChanged:function(){},loginIncorrect:!1,disableSubmit:!1});class oT extends s.PureComponent{constructor(e){super(e),(0,h.A)(this,"unmounted",!1),(0,h.A)(this,"oidcNativeFlowEnabled",!1),(0,h.A)(this,"loginLogic",void 0),(0,h.A)(this,"stepRendererMap",void 0),(0,h.A)(this,"isBusy",(()=>!!this.state.busy||!!this.props.busy)),(0,h.A)(this,"tchap_setServerInMemory",(async e=>{const t=await oC.A.makeValidatedServerConfig(e);this.props.onServerConfigChange(t),await this.initLoginLogic(t)})),(0,h.A)(this,"onPasswordLogin",(async(e,t,n,i)=>{this.setState({busy:!0,busyLoggingIn:!0,errorText:null,loginIncorrect:!1});const r=await oC.A.fetchHomeserverForEmail(e);r?(await this.tchap_setServerInMemory(r),this.loginLogic.loginViaPassword(e,t,n,i).then((e=>{this.setState({serverIsAlive:!0}),this.props.onLoggedIn(e,i)}),(t=>{if(this.unmounted)return;let n;n=400===t.httpStatus&&e&&e.indexOf("@")>0?(0,P._t)("auth|unsupported_auth_email"):(0,fe.Y0)(t,this.props.serverConfig),this.setState({busy:!1,busyLoggingIn:!1,errorText:n,loginIncorrect:401===t.httpStatus||403===t.httpStatus})}))):this.setState({busy:!1,busyLoggingIn:!1,errorText:NE.A.getServerDownMessage("(err-03)"),loginIncorrect:!1})})),(0,h.A)(this,"onUsernameChanged",(e=>{this.setState({username:e})})),(0,h.A)(this,"onUsernameBlur",(async e=>{const t="@"===e[0];if(this.setState({username:e,busy:t,errorText:null,canTryLogin:!0}),t){const t=e.split(":").slice(1).join(":");try{const e=await c.A.validateServerName(t);this.props.onServerConfigChange(e),this.setState({busy:!1})}catch(e){o.v.error("Problem parsing URL or unhandled error doing .well-known discovery:",e);let t=(0,P._t)("auth|failed_homeserver_discovery");e instanceof P.P7&&e.translatedMessage&&(t=e.translatedMessage);let n=t,i={};c.A.isLivelinessError(e)&&(n=this.state.errorText,i=c.A.authComponentStateForError(e)),this.setState(sT({busy:!1,errorText:n},i))}}})),(0,h.A)(this,"onPhoneCountryChanged",(e=>{this.setState({phoneCountry:e})})),(0,h.A)(this,"onPhoneNumberChanged",(e=>{this.setState({phoneNumber:e})})),(0,h.A)(this,"onRegisterClick",(e=>{e.preventDefault(),e.stopPropagation(),this.props.onRegisterClick()})),(0,h.A)(this,"onTryRegisterClick",(e=>{var t,n;const r=null===(t=this.state.flows)||void 0===t?void 0:t.find((e=>"m.login.password"===e.type)),s=null===(n=this.state.flows)||void 0===n?void 0:n.find((e=>"m.login.sso"===e.type||"m.login.cas"===e.type));if(s&&!r){var o;e.preventDefault(),e.stopPropagation();const t="m.login.sso"===s.type?"sso":"cas";null===(o=l.A.get())||void 0===o||o.startSingleSignOn(this.loginLogic.createTemporaryClient(),t,this.props.fragmentAfterLogin,void 0,i.SSOAction.REGISTER)}else this.onRegisterClick(e)})),(0,h.A)(this,"isSupportedFlow",(e=>!!this.stepRendererMap[e.type]||(o.v.log("Skipping flow",e,"due to unsupported login type",e.type),!1))),(0,h.A)(this,"renderPasswordStep",(()=>s.createElement(iT,{onSubmit:this.onPasswordLogin,username:this.state.username,phoneCountry:this.state.phoneCountry,phoneNumber:this.state.phoneNumber,onUsernameChanged:this.onUsernameChanged,onUsernameBlur:this.onUsernameBlur,onPhoneCountryChanged:this.onPhoneCountryChanged,onPhoneNumberChanged:this.onPhoneNumberChanged,onForgotPasswordClick:this.props.onForgotPasswordClick,loginIncorrect:this.state.loginIncorrect,serverConfig:this.props.serverConfig,disableSubmit:this.isBusy(),busy:this.props.isSyncing||this.state.busyLoggingIn}))),(0,h.A)(this,"renderOidcNativeStep",(()=>{const e=this.state.flows.find((e=>"oidcNativeFlow"===e.type));return s.createElement(Ae.A,{className:"mx_Login_fullWidthButton",kind:"primary",onClick:async()=>{await(0,KI.N)(this.props.serverConfig.delegatedAuthentication,e.clientId,this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl)}},(0,P._t)("action|continue"))})),(0,h.A)(this,"renderSsoStep",(e=>!Vl.A.isSSOFlowActive()||this.isBusy()||this.state.busyLoggingIn?s.createElement(s.Fragment,null):s.createElement("div",{style:{marginBottom:"25px",position:"relative",top:"-15px"}},s.createElement("p",{style:{textAlign:"center",fontWeight:"bold"}},(0,P._t)("auth|proconnect|or")),s.createElement(JI,null)))),this.oidcNativeFlowEnabled=V.A.getValue(Nl.O5.OidcNativeFlow),this.state={busy:!1,errorText:null,loginIncorrect:!1,canTryLogin:!0,username:e.defaultUsername?e.defaultUsername:"",phoneCountry:"",phoneNumber:"",serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:""},this.stepRendererMap={"m.login.password":this.renderPasswordStep,"m.login.cas":()=>this.renderSsoStep("cas"),"m.login.sso":()=>this.renderSsoStep("sso"),oidcNativeFlow:()=>this.renderOidcNativeStep()}}componentDidMount(){this.unmounted=!1,this.initLoginLogic(this.props.serverConfig)}componentWillUnmount(){this.unmounted=!0}componentDidUpdate(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl&&e.serverConfig.delegatedAuthentication===this.props.serverConfig.delegatedAuthentication||this.initLoginLogic(this.props.serverConfig)}async checkServerLiveliness({hsUrl:e,isUrl:t}){try{const{warning:n}=await c.A.validateServerConfigWithStaticUrls(e,t);n?this.setState(sT(sT({},c.A.authComponentStateForError(n)),{},{errorText:""})):this.setState({serverIsAlive:!0,errorText:""})}catch(e){this.setState(sT({busy:!1},c.A.authComponentStateForError(e)))}}async initLoginLogic({hsUrl:e,isUrl:t}){let n=!1;this.props.serverConfig.isDefault&&e===this.props.serverConfig.hsUrl&&t===this.props.serverConfig.isUrl&&(n=!0);const i=n?this.props.fallbackHsUrl:null;this.setState({busy:!0,loginIncorrect:!1}),await this.checkServerLiveliness({hsUrl:e,isUrl:t});const r=new UI.A(e,t,i,{defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,delegatedAuthentication:this.oidcNativeFlowEnabled?this.props.serverConfig.delegatedAuthentication:void 0});this.loginLogic=r,r.getFlows().then((e=>{const t=e.filter(this.isSupportedFlow);this.setState({flows:t}),0===t.length&&this.setState({errorText:(0,P._t)("auth|unsupported_auth")})}),(e=>{this.setState({errorText:(0,fe.Vp)(e,this.props.serverConfig),loginIncorrect:!1,canTryLogin:!1})})).finally((()=>{this.setState({busy:!1})}))}renderLoginComponentForFlows(){if(!this.state.flows)return null;const e=(0,Vg.Bo)(["oidcNativeFlow","m.login.password","m.login.sso"].map((e=>{var t;return null===(t=this.state.flows)||void 0===t?void 0:t.find((t=>t.type===e))})));return s.createElement(s.Fragment,null,e.map((e=>{const t=this.stepRendererMap[e.type];return s.createElement(s.Fragment,{key:e.type},t())})))}render(){const e=this.isBusy()&&!this.state.busyLoggingIn?s.createElement("div",{className:"mx_Login_loader"},s.createElement(Na.A,null)):null,t=this.state.errorText;let n,i,r;if(t&&(n=s.createElement("div",{className:"mx_Login_error"},t)),!this.state.serverIsAlive){const e=re()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});i=s.createElement("div",{className:e},this.state.serverDeadError)}return this.props.isSyncing||this.state.busyLoggingIn?r=s.createElement("div",{className:"mx_AuthBody_paddedFooter"},s.createElement("div",{className:"mx_AuthBody_paddedFooter_title"},s.createElement(He.A,{w:20,h:20}),this.props.isSyncing?(0,P._t)("auth|syncing"):(0,P._t)("auth|signing_in")),this.props.isSyncing&&s.createElement("div",{className:"mx_AuthBody_paddedFooter_subtitle"},(0,P._t)("auth|sync_footer_subtitle"))):V.A.getValue($.f.Registration)&&(r=s.createElement("span",{className:"mx_AuthBody_changeFlow"},(0,P._t)("auth|create_account_prompt",{},{a:e=>s.createElement(Ae.A,{kind:"link_inline",onClick:this.onTryRegisterClick},e)}))),s.createElement(mI,null,s.createElement(wI,{disableLanguageSelector:this.props.isSyncing||this.state.busyLoggingIn}),s.createElement(SI,null,s.createElement("h1",null,(0,P._t)("action|sign_in"),e),n,i,this.renderLoginComponentForFlows(),r))}}var aT=n("./src/utils/KeyVerificationStateObserver.ts");class lT extends s.PureComponent{constructor(e){var t;super(e),(0,h.A)(this,"intervalHandle",void 0),(0,h.A)(this,"checkRequestIsPending",(()=>{const{request:e}=this.props;(0,f.canAcceptVerificationRequest)(e)||T.A.sharedInstance().dismissToast(this.props.toastKey)})),(0,h.A)(this,"cancel",(()=>{T.A.sharedInstance().dismissToast(this.props.toastKey);try{this.props.request.cancel()}catch(e){o.v.error("Error while cancelling verification request",e)}})),(0,h.A)(this,"accept",(async()=>{T.A.sharedInstance().dismissToast(this.props.toastKey);const{request:e}=this.props,t=E.J.safeGet();try{if(e.roomId){var n;w.A.dispatch({action:R.r.ViewRoom,room_id:e.roomId,should_peek:!1,metricsTrigger:"VerificationRequest"});const i=null!==(n=t.getUser(e.otherUserId))&&void 0!==n?n:void 0;rl.A.instance.setCards([{phase:sl.n.RoomSummary},{phase:sl.n.MemberInfo,state:{member:i}},{phase:sl.n.EncryptionPanel,state:{verificationRequest:e,member:i}}],void 0,e.roomId)}else A.Ay.createDialog(Ok.A,{verificationRequest:e,onFinished:()=>{e.cancel()}},void 0,!1,!0);await e.accept()}catch(e){o.v.error("Failed to accept verification request",e)}})),this.state={counter:Math.ceil((null!==(t=e.request.timeout)&&void 0!==t?t:0)/1e3)}}async componentDidMount(){const{request:e}=this.props;e.timeout&&e.timeout>0&&(this.intervalHandle=window.setInterval((()=>{let{counter:e}=this.state;e=Math.max(0,e-1),this.setState({counter:e})}),1e3)),e.on(f.VerificationRequestEvent.Change,this.checkRequestIsPending),this.checkRequestIsPending();const t=e.otherDeviceId;if(e.isSelfVerification&&t){const e=E.J.safeGet(),n=await e.getDevice(t);this.setState({ip:n.last_seen_ip,device:await(0,Yv.G)(e,e.getSafeUserId(),t)})}}componentWillUnmount(){clearInterval(this.intervalHandle);const{request:e}=this.props;e.off(f.VerificationRequestEvent.Change,this.checkRequestIsPending)}render(){const{request:e}=this.props;let t,n;if(e.isSelfVerification)this.state.device&&(t=this.state.device.displayName,n=(0,P._t)("encryption|verification|request_toast_detail",{deviceId:this.state.device.deviceId,ip:this.state.ip}));else{const n=E.J.safeGet(),i=e.otherUserId,r=e.roomId;if(t=r?(0,aT.M)(n,i,r):i,t===i){const e=n.getUser(i);e&&e.displayName&&(t=(0,P._t)("name_and_id",{name:e.displayName,userId:i}))}}const i=0===this.state.counter?(0,P._t)("action|ignore"):(0,P._t)("encryption|verification|request_toast_decline_counter",{counter:this.state.counter});return s.createElement(N.A,{description:t,detail:n,primaryLabel:e.isSelfVerification||!e.roomId?(0,P._t)("encryption|verification|request_toast_accept"):(0,P._t)("encryption|verification|request_toast_accept_user"),onPrimaryClick:this.accept,secondaryLabel:i,onSecondaryClick:this.cancel})}}var cT=n("./src/performance/index.ts");const dT=["matrixClient","loginType","fragmentAfterLogin","idp","primary","mini","action","flow"],uT=e=>{let t,{matrixClient:r,loginType:o,fragmentAfterLogin:a,idp:c,primary:d,mini:u,action:m,flow:h}=e,g=(0,Ve.A)(e,dT);t=c?(0,P._t)("auth|continue_with_idp",{provider:c.name}):i.DELEGATED_OIDC_COMPATIBILITY.findIn(h)?(0,P._t)("action|continue"):(0,P._t)("auth|sign_in_with_sso");const v=()=>{var e,t;const n=(e=>{switch(e){case i.IdentityProviderBrand.Apple:return"Apple";case i.IdentityProviderBrand.Facebook:return"Facebook";case i.IdentityProviderBrand.Github:return"GitHub";case i.IdentityProviderBrand.Gitlab:return"GitLab";case i.IdentityProviderBrand.Google:return"Google";default:return"SSO"}})(null!==(e=null==c?void 0:c.brand)&&void 0!==e?e:"");hu.Vo.instance.setAuthenticationType(n),null===(t=l.A.get())||void 0===t||t.startSingleSignOn(r,o,a,null==c?void 0:c.id,m)};let f,_;const y=null!=c&&c.brand?(e=>{switch(e){case i.IdentityProviderBrand.Apple:return n("./res/img/element-icons/brands/apple.svg").A;case i.IdentityProviderBrand.Facebook:return n("./res/img/element-icons/brands/facebook.svg").A;case i.IdentityProviderBrand.Github:return n("./res/img/element-icons/brands/github.svg").A;case i.IdentityProviderBrand.Gitlab:return n("./res/img/element-icons/brands/gitlab.svg").A;case i.IdentityProviderBrand.Google:return n("./res/img/element-icons/brands/google.svg").A;case i.IdentityProviderBrand.Twitter:return n("./res/img/element-icons/brands/twitter.svg").A;default:return null}})(c.brand):null;if(null!=c&&c.brand&&y){const e=c.brand.split(".").pop();_=`mx_SSOButton_brand_${e}`,f=s.createElement("img",{src:y,height:"24",width:"24",alt:e})}else if("string"==typeof(null==c?void 0:c.icon)&&c.icon.startsWith("mxc://")){var b;const e=null!==(b=(0,Up.lH)(c.icon,r).getSquareThumbnailHttp(24))&&void 0!==b?b:void 0;f=s.createElement("img",{src:e,height:"24",width:"24",alt:c.name})}const E=_?{[_]:_}:void 0,w=re()("mx_SSOButton",{mx_SSOButton_mini:u,mx_SSOButton_default:!c,mx_SSOButton_primary:d},E);return u?s.createElement(Ae.A,(0,p.A)({},g,{title:t,className:w,onClick:v}),f):s.createElement(Ae.A,(0,p.A)({},g,{className:w,onClick:v}),f,t)},mT=({matrixClient:e,flow:t,loginType:n,fragmentAfterLogin:i,primary:r,action:o,disabled:a})=>{const l=t.identity_providers||[];if(l.length<2)return s.createElement("div",{className:"mx_SSOButtons"},s.createElement(uT,{matrixClient:e,loginType:n,fragmentAfterLogin:i,idp:l[0],primary:r,action:o,flow:t,disabled:a}));const c=Math.ceil(l.length/6),d=Math.ceil(l.length/c);return s.createElement("div",{className:"mx_SSOButtons"},(0,v.chunk)(l,d).map((a=>s.createElement("div",{key:a[0].id,className:"mx_SSOButtons_row"},a.map((a=>s.createElement(uT,{key:a.id,matrixClient:e,loginType:n,fragmentAfterLogin:i,idp:a,mini:!0,primary:r,action:o,flow:t})))))))};class pT extends s.Component{constructor(...e){super(...e),(0,h.A)(this,"onConfirm",(()=>{this.props.onFinished(!0)})),(0,h.A)(this,"onDecline",(()=>{this.props.onFinished(!1)}))}render(){return s.createElement(Pa.A,{className:"mx_ConfirmWipeDeviceDialog",hasCancel:!0,onFinished:this.props.onFinished,title:(0,P._t)("auth|soft_logout|clear_data_title")},s.createElement("div",{className:"mx_ConfirmWipeDeviceDialog_content"},s.createElement("p",null,(0,P._t)("auth|soft_logout|clear_data_description"))),s.createElement(Da.A,{primaryButton:(0,P._t)("auth|soft_logout|clear_data_button"),onPrimaryButtonClick:this.onConfirm,primaryButtonClass:"danger",cancelButton:(0,P._t)("action|cancel"),onCancel:this.onDecline}))}}var hT=function(e){return e[e.Loading=0]="Loading",e[e.Password=1]="Password",e[e.CAS=2]="CAS",e[e.SSO=3]="SSO",e[e.PasswordWithSocialSignOn=4]="PasswordWithSocialSignOn",e[e.Unsupported=5]="Unsupported",e}(hT||{});const gT={"m.login.password":hT.Password,"m.login.cas":hT.CAS,"m.login.sso":hT.SSO};class vT extends s.Component{constructor(e,t){super(e,t),(0,h.A)(this,"onClearAll",(()=>{A.Ay.createDialog(pT,{onFinished:e=>{e&&(o.v.log("Clearing data from soft-logged-out session"),d.ri(this.context.oidcClientStore))}})})),(0,h.A)(this,"onPasswordChange",(e=>{this.setState({password:e.target.value})})),(0,h.A)(this,"onForgotPassword",(()=>{w.A.dispatch({action:"start_password_recovery"})})),(0,h.A)(this,"onPasswordLogin",(async e=>{var t;e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});const n=E.J.safeGet(),r=n.getHomeserverUrl(),s=n.getIdentityServerUrl(),a={identifier:{type:"m.id.user",user:n.getUserId()},password:this.state.password,device_id:null!==(t=n.getDeviceId())&&void 0!==t?t:void 0};let l;try{l=await(0,UI.b)(r,s,"m.login.password",a)}catch(e){let t=(0,P._t)("auth|failed_soft_logout_homeserver");return e instanceof i.MatrixError&&"M_FORBIDDEN"===e.errcode&&(401===e.httpStatus||403===e.httpStatus)&&(t=(0,P._t)("auth|incorrect_password")),void this.setState({busy:!1,errorText:t})}d.QC(l).catch((e=>{o.v.error(e),this.setState({busy:!1,errorText:(0,P._t)("auth|failed_soft_logout_auth")})}))})),this.state={loginView:hT.Loading,busy:!1,password:"",errorText:"",flows:[]}}componentDidMount(){d.b()?this.initLogin():w.A.dispatch({action:"start_login"})}async initLogin(){const e=this.props.realQueryParams;if(null==e?void 0:e.loginToken){this.setState({loginView:hT.Loading});if(await this.trySsoLogin())return}const t=E.J.safeGet(),n=(await t.loginFlows()).flows,i=n.map((e=>gT[e.type])),r=i.includes(hT.Password)&&i.includes(hT.SSO),s=i.filter((e=>!!e))[0]||hT.Unsupported,o=r?hT.PasswordWithSocialSignOn:s;this.setState({flows:n,loginView:o})}async trySsoLogin(){var e;this.setState({busy:!0});const t=localStorage.getItem(sk.FL);if(!t)return o.v.error("Homeserver URL unknown for SSO login callback"),this.setState({busy:!1,loginView:hT.Unsupported}),!1;const n=localStorage.getItem(sk.U7)||E.J.safeGet().getIdentityServerUrl(),i={token:this.props.realQueryParams.loginToken,device_id:null!==(e=E.J.safeGet().getDeviceId())&&void 0!==e?e:void 0};let r;try{r=await(0,UI.b)(t,n,"m.login.token",i)}catch(e){return o.v.error(e),this.setState({busy:!1,loginView:hT.Unsupported}),!1}return d.QC(r).then((()=>(this.props.onTokenLoginCompleted&&this.props.onTokenLoginCompleted(),!0))).catch((e=>(o.v.error(e),this.setState({busy:!1,loginView:hT.Unsupported}),!1)))}renderPasswordForm(e){let t;return this.state.errorText&&(t=s.createElement("span",{className:"mx_Login_error"},this.state.errorText)),s.createElement("form",{onSubmit:this.onPasswordLogin},e?s.createElement("p",null,e):null,t,s.createElement(Sa.A,{type:"password",label:(0,P._t)("common|password"),onChange:this.onPasswordChange,value:this.state.password,disabled:this.state.busy}),s.createElement(Ae.A,{onClick:this.onPasswordLogin,kind:"primary",disabled:this.state.busy},(0,P._t)("action|sign_in")),s.createElement(Ae.A,{onClick:this.onForgotPassword,kind:"link"},(0,P._t)("auth|forgot_password_prompt")))}renderSsoForm(e){const t=this.state.loginView===hT.CAS?"cas":"sso",n=this.state.flows.find((e=>e.type==="m.login."+t));return s.createElement("div",null,e?s.createElement("p",null,e):null,s.createElement(mT,{matrixClient:E.J.safeGet(),flow:n,loginType:t,fragmentAfterLogin:this.props.fragmentAfterLogin,primary:!this.state.flows.find((e=>"m.login.password"===e.type)),action:i.SSOAction.LOGIN}))}renderSignInSection(){return this.state.loginView===hT.Loading?s.createElement(Na.A,null):this.state.loginView===hT.Password?this.renderPasswordForm((0,P._t)("auth|soft_logout_intro_password")):this.state.loginView===hT.SSO||this.state.loginView===hT.CAS?this.renderSsoForm((0,P._t)("auth|soft_logout_intro_sso")):this.state.loginView===hT.PasswordWithSocialSignOn?s.createElement(s.Fragment,null,s.createElement("p",null,(0,P._t)("auth|soft_logout_intro_sso")),this.renderSsoForm(null),s.createElement("h2",{className:"mx_AuthBody_centered"},(0,P._t)("auth|sso_or_username_password",{ssoButtons:"",usernamePassword:""}).trim()),this.renderPasswordForm(null)):s.createElement("p",null,(0,P._t)("auth|soft_logout_intro_unsupported_auth"))}render(){return s.createElement(mI,null,s.createElement(wI,null),s.createElement(SI,null,s.createElement("h1",null,(0,P._t)("auth|soft_logout_heading")),s.createElement("h2",null,(0,P._t)("action|sign_in")),s.createElement("div",null,this.renderSignInSection()),s.createElement("h2",null,(0,P._t)("auth|soft_logout_subheading")),s.createElement("p",null,(0,P._t)("auth|soft_logout_warning")),s.createElement("div",null,s.createElement(Ae.A,{onClick:this.onClearAll,kind:"danger"},(0,P._t)("auth|soft_logout|clear_data_button")))))}}(0,h.A)(vT,"contextType",Wa.A);var fT=n("./src/sentry.ts"),_T=n("./src/Views.ts");const yT=["children","className"];function bT(e){let{children:t,className:n}=e,i=(0,Ve.A)(e,yT);const r=re()(n,"mx_SplashPage");return s.createElement("main",(0,p.A)({},i,{className:r}),t)}function ET({useCase:e,onClick:t,selected:n}){let i;switch(e){case Ad.PersonalMessaging:i=(0,P._t)("onboarding|use_case_personal_messaging");break;case Ad.WorkMessaging:i=(0,P._t)("onboarding|use_case_work_messaging");break;case Ad.CommunityMessaging:i=(0,P._t)("onboarding|use_case_community_messaging")}return s.createElement(Ae.A,{className:re()("mx_UseCaseSelectionButton",{mx_UseCaseSelectionButton_selected:n}),onClick:async()=>t(e)},s.createElement("div",{className:re()("mx_UseCaseSelectionButton_icon",{mx_UseCaseSelectionButton_messaging:e===Ad.PersonalMessaging,mx_UseCaseSelectionButton_work:e===Ad.WorkMessaging,mx_UseCaseSelectionButton_community:e===Ad.CommunityMessaging})}),s.createElement("span",null,i),s.createElement("div",{className:"mx_UseCaseSelectionButton_selectedIcon"}))}function wT({onFinished:e}){const[t,n]=(0,s.useState)(null);return(0,s.useEffect)((()=>{if(t){let n=window.setTimeout((()=>{n=null,e(t)}),1500);return()=>{null!==n&&clearTimeout(n),n=null}}}),[t,e]),s.createElement(bT,{className:re()("mx_UseCaseSelection",{mx_UseCaseSelection_selected:null!==t})},s.createElement("div",{className:"mx_UseCaseSelection_title mx_UseCaseSelection_slideIn"},s.createElement("h1",null,(0,P._t)("onboarding|use_case_heading1"))),s.createElement("div",{className:"mx_UseCaseSelection_info mx_UseCaseSelection_slideInDelayed"},s.createElement("h2",null,(0,P._t)("onboarding|use_case_heading2")),s.createElement("h3",null,(0,P._t)("onboarding|use_case_heading3"))),s.createElement("div",{className:"mx_UseCaseSelection_options mx_UseCaseSelection_slideInDelayed"},s.createElement(ET,{useCase:Ad.PersonalMessaging,selected:t===Ad.PersonalMessaging,onClick:n}),s.createElement(ET,{useCase:Ad.WorkMessaging,selected:t===Ad.WorkMessaging,onClick:n}),s.createElement(ET,{useCase:Ad.CommunityMessaging,selected:t===Ad.CommunityMessaging,onClick:n})),s.createElement("div",{className:"mx_UseCaseSelection_skip mx_UseCaseSelection_slideInDelayed"},s.createElement(Ae.A,{kind:"link",onClick:async()=>n(Ad.Skip)},(0,P._t)("action|skip"))))}function ST(e,t,n){(0,s.useEffect)((()=>{let i=null;const r=()=>{i=null,t(...n)};if(!1!==e)return i=window.setTimeout(r,100),()=>{i&&clearTimeout(i)}}),[e,t,n])}const AT=e=>{const t=(0,s.useRef)(null);return[(0,s.useCallback)((e=>{t.current=e}),[]),(0,s.useCallback)(((n,i)=>{t.current===n&&e(i)}),[e])]},CT="ALL_ROOMS",xT="mx_last_room_directory_server",kT="mx_last_room_directory_instance";let RT;const IT="nsfw",TT=e=>{var t,n;return!(null!==(t=e.name)&&void 0!==t&&t.toLocaleLowerCase().includes(IT)||null!==(n=e.topic)&&void 0!==n&&n.toLocaleLowerCase().includes(IT))},PT=()=>{const[e,t]=(0,s.useState)([]),[n,i]=(0,s.useState)(void 0),[r,o]=(0,s.useState)(null),[a,l]=(0,s.useState)(!1),[c,d]=(0,s.useState)(!1),[m,p]=(0,s.useState)(),[h,g]=AT(t),v=(0,Oe.ti)("SpotlightSearch.showNsfwPublicRooms");const f=(0,s.useCallback)((async({limit:e=20,query:t,roomTypes:i})=>{const r={limit:e};(null==n?void 0:n.roomServer)!=E.J.safeGet().getDomain()&&(r.server=null==n?void 0:n.roomServer),(null==n?void 0:n.instanceId)===CT?r.include_all_networks=!0:null!=n&&n.instanceId&&(r.third_party_instance_id=n.instanceId),(t||i)&&(r.filter={generic_search_term:t,room_types:i&&await E.J.safeGet().doesServerSupportUnstableFeature("org.matrix.msc3827.stable")?Array.from(i):void 0}),h(r),d(!0),p(void 0);try{const{chunk:e}=await E.J.safeGet().publicRooms(r);return g(r,v?e:e.filter(TT)),!0}catch(e){return p(!(e instanceof Error)||e),console.error("Could not fetch public rooms for params",r,e),g(r,[]),!1}finally{d(!1)}}),[n,h,g,v]);return(0,s.useEffect)((()=>{!async function(){if(E.J.get())if(RT)o(RT);else{const e=await E.J.safeGet().getThirdpartyProtocols();RT=e,o(e)}else l(!0)}()}),[]),(0,s.useEffect)((()=>{var e,t,n;if(null===r)return;const s=E.J.safeGet().getDomain(),o=localStorage.getItem(xT),a=null!==(e=localStorage.getItem(kT))&&void 0!==e?e:void 0;let c,d=s;o&&(null!==(t=u.Ay.getObject("room_directory"))&&void 0!==t&&null!==(t=t.get("servers"))&&void 0!==t&&t.includes(o)||null!==(n=V.A.getValue("room_directory_servers"))&&void 0!==n&&n.includes(o))&&(d=o),d!==s||a!==CT&&!Object.values(r).some((e=>{e.instances.some((e=>e.instance_id===a))}))||(c=a),l(!0),i({roomServer:d,instanceId:c})}),[r]),(0,s.useEffect)((()=>{n&&(localStorage.setItem(xT,n.roomServer),n.instanceId?localStorage.setItem(kT,n.instanceId):localStorage.removeItem(kT))}),[n]),{ready:a,loading:c,publicRooms:e,protocols:r,config:n,search:f,setConfig:function(e){if(!a)throw new Error("public room configuration not initialised yet");i(e)},error:m}};var NT=n("./src/stores/room-list/algorithms/tag-sorting/RecentAlgorithm.ts"),DT=n("./src/utils/SortMembers.ts"),MT=n("./src/components/views/avatars/SearchResultAvatar.tsx"),OT=n("./src/accessibility/context_menu/MenuItemRadio.tsx");function LT({label:e,description:t,onClick:n,isSelected:i,adornment:r}){return s.createElement(OT.s,{active:i,className:"mx_GenericDropdownMenu_Option mx_GenericDropdownMenu_Option--item",onClick:n},s.createElement("div",{className:"mx_GenericDropdownMenu_Option--label"},s.createElement("span",null,e),s.createElement("span",null,t)),r)}function FT({label:e,description:t,adornment:n,children:i}){return s.createElement(s.Fragment,null,s.createElement("div",{className:"mx_GenericDropdownMenu_Option mx_GenericDropdownMenu_Option--header"},s.createElement("div",{className:"mx_GenericDropdownMenu_Option--label"},s.createElement("span",null,e),s.createElement("span",null,t)),n),i)}function UT(e){return"options"in e}function BT(e,t){return t?t(e):e}function VT({value:e,onChange:t,options:n,selectedLabel:i,onOpen:r,onClose:o,toKey:a,className:l,AdditionalOptions:c}){const[d,u,m,h]=(0,Fe.EF)(),g=BT(e,a),v=n.flatMap((e=>UT(e)?[e,...e.options]:[e])).find((e=>BT(e.key,a)===g));let f;f=n&&UT(n[0])?s.createElement(s.Fragment,null,n.map((e=>s.createElement(FT,{key:BT(e.key,a),label:e.label,description:e.description,adornment:e.adornment},e.options.map((e=>s.createElement(LT,{key:BT(e.key,a),label:e.label,description:e.description,onClick:n=>{t(e.key),h(),null==o||o(n)},adornment:e.adornment,isSelected:BT(e.key,a)===g}))))))):s.createElement(s.Fragment,null,n.map((e=>s.createElement(LT,{key:BT(e.key,a),label:e.label,description:e.description,onClick:n=>{t(e.key),h(),null==o||o(n)},adornment:e.adornment,isSelected:BT(e.key,a)===g}))));const _=d&&u.current?s.createElement(Fe.Ay,(0,p.A)({onFinished:h,chevronFace:Fe.t4.Top,wrapperClassName:re()("mx_GenericDropdownMenu_wrapper",l)},(0,Fe.qv)(u.current.getBoundingClientRect())),f,c&&s.createElement(c,{menuDisplayed:d,openMenu:m,closeMenu:h})):null;return s.createElement(s.Fragment,null,s.createElement(Fe.VJ,{className:"mx_GenericDropdownMenu_button",ref:u,isExpanded:d,onClick:e=>{m(),null==r||r(e)}},i(v)),_)}var jT=n("./src/components/views/dialogs/TextInputDialog.tsx");function zT(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}const WT=(0,Ip.A)({deriveData:async({value:e})=>{try{return await E.J.safeGet().publicRooms({limit:1,server:null!=e?e:void 0}),{}}catch(e){return{error:e}}},rules:[{key:"required",test:async({value:e})=>!!e,invalid:()=>(0,P._t)("spotlight|public_rooms|network_dropdown_required_invalid")},{key:"available",final:!0,test:async(e,{error:t})=>!t,valid:()=>(0,P._t)("spotlight|public_rooms|network_dropdown_available_valid"),invalid:({error:e})=>e instanceof i.MatrixError&&"M_FORBIDDEN"===e.errcode?(0,P._t)("spotlight|public_rooms|network_dropdown_available_invalid_forbidden"):(0,P._t)("spotlight|public_rooms|network_dropdown_available_invalid")}],memoize:!0});function HT(e,...t){for(const n of t)e.delete(n)}function GT(){var e,t;const[n,i]=function(e,t,n=null,i=!1){const[r,o]=(0,s.useState)(V.A.getValue(e,null!=n?n:void 0,i)),a=(0,s.useCallback)((async i=>{o(i),V.A.setValue(e,n,t,i)}),[t,n,e]);return(0,s.useEffect)((()=>{const t=V.A.watchSetting(e,n,(()=>{o(V.A.getValue(e,n,i))}));return()=>{V.A.unwatchSetting(t)}}),[e,n,i]),[r,a]}("room_directory_servers",ae.p.ACCOUNT),r=E.J.safeGet().getDomain(),o=new Set(null!==(e=null===(t=u.Ay.getObject("room_directory"))||void 0===t?void 0:t.get("servers"))&&void 0!==e?e:[]);HT(o,r);const a=new Set(n);return HT(a,r),HT(a,...o),{allServers:[r,...Array.from(o).sort(),...Array.from(a).sort()],homeServer:r,userDefinedServers:Array.from(a).sort(),setUserDefinedServers:i}}const KT=({protocols:e,config:t,setConfig:n})=>{const{allServers:i,homeServer:r,userDefinedServers:o,setUserDefinedServers:a}=GT(),l=i.map((t=>function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?zT(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):zT(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({key:{roomServer:t,instanceId:void 0},label:t,description:t===r?(0,P._t)("spotlight|public_rooms|network_dropdown_your_server_description"):null,options:[{key:{roomServer:t,instanceId:void 0},label:oC.A.toFriendlyServerName(t)},...t===r&&e?Object.values(e).flatMap((e=>e.instances)).map((e=>({key:{roomServer:t,instanceId:e.instance_id},label:e.desc}))):[]]},o.includes(t)?{adornment:s.createElement(Ae.A,{className:"mx_NetworkDropdown_removeServer",title:(0,P._t)("spotlight|public_rooms|network_dropdown_remove_server_adornment",{roomServer:t}),onClick:()=>a((0,v.without)(o,t))})}:{}))),c=(0,s.useCallback)((({closeMenu:e})=>s.createElement(s.Fragment,null,s.createElement("span",{className:"mx_GenericDropdownMenu_divider"}),s.createElement(OT.s,{active:!1,className:"mx_GenericDropdownMenu_Option mx_GenericDropdownMenu_Option--item",onClick:async()=>{e();const{finished:t}=A.Ay.createDialog(jT.A,{title:(0,P._t)("spotlight|public_rooms|network_dropdown_add_dialog_title"),description:(0,P._t)("spotlight|public_rooms|network_dropdown_add_dialog_description"),button:(0,P._t)("action|add"),hasCancel:!1,placeholder:(0,P._t)("spotlight|public_rooms|network_dropdown_add_dialog_placeholder"),validator:WT,fixedWidth:!1},"mx_NetworkDropdown_dialog"),[r,s]=await t;r&&(i.includes(s)||(a([...o,s]),n({roomServer:s})))}},s.createElement("div",{className:"mx_GenericDropdownMenu_Option--label"},s.createElement("span",{className:"mx_NetworkDropdown_addServer"},(0,P._t)("spotlight|public_rooms|network_dropdown_add_server_option")))))),[i,n,a,o]);return s.createElement(VT,{className:"mx_NetworkDropdown_wrapper",value:t,toKey:e=>e?`${e.roomServer}-${e.instanceId}`:"null",options:l,onChange:e=>n(e),selectedLabel:e=>null!=e&&e.key?(0,P._t)("spotlight|public_rooms|network_dropdown_selected_label_instance",{server:oC.A.toFriendlyServerName(e.key.roomServer),instance:e.key.instanceId?e.label:"Matrix"}):(0,P._t)("spotlight|public_rooms|network_dropdown_selected_label"),AdditionalOptions:c})},JT=["children","endAdornment","className"],qT=e=>{let{children:t,endAdornment:n,className:i}=e,r=(0,Ve.A)(e,JT);const[o,a,l]=(0,ha.A9)();return s.createElement(Ae.A,(0,p.A)({},r,{className:re()(i,"mx_SpotlightDialog_option"),onFocus:o,ref:l,tabIndex:-1,"aria-selected":a,role:"option",element:"li"}),t,s.createElement("div",{className:"mx_SpotlightDialog_option--endAdornment"},s.createElement("kbd",{className:"mx_SpotlightDialog_enterPrompt","aria-hidden":!0},"â†µ"),n))};function $T({room:e,labelId:t,descriptionId:n,detailsId:i}){var r,o,a;let l=e.name||(0,x.iW)(null!==(r=e.canonical_alias)&&void 0!==r?r:"",null!==(o=e.aliases)&&void 0!==o?o:[])||(0,P._t)("common|unnamed_room");l.length>80&&(l=`${l.substring(0,80)}...`);let c=e.topic||"";return c.length>800&&(c=`${c.substring(0,800)}...`),s.createElement("div",{className:"mx_SpotlightDialog_result_publicRoomDetails"},s.createElement("div",{className:"mx_SpotlightDialog_result_publicRoomHeader"},s.createElement("span",{id:t,className:"mx_SpotlightDialog_result_publicRoomName"},l),s.createElement("span",{id:n,className:"mx_SpotlightDialog_result_publicRoomAlias"},null!==(a=e.canonical_alias)&&void 0!==a?a:e.room_id)),s.createElement("div",{id:i,className:"mx_SpotlightDialog_result_publicRoomDescription"},s.createElement("span",{className:"mx_SpotlightDialog_result_publicRoomMemberCount"},(0,P._t)("spotlight_dialog|count_of_members",{count:e.num_joined_members})),c&&s.createElement(s.Fragment,null,"Â Â·Â ",s.createElement("span",{className:"mx_SpotlightDialog_result_publicRoomTopic",dangerouslySetInnerHTML:{__html:(0,qh.kz)(c)}}))))}var YT=n("./src/hooks/useRoomNotificationState.ts"),ZT=n("./src/components/views/context_menus/RoomGeneralContextMenu.tsx"),XT=n("./src/components/views/context_menus/RoomNotificationContextMenu.tsx"),QT=n("./src/components/views/rooms/RoomTile.tsx");function eP({room:e}){const[t]=(0,YT.I)(e),[n,i]=(0,s.useState)(null),[r,o]=(0,s.useState)(null);let a,l;null!==n&&(a=e.isSpaceRoom()?s.createElement(We,(0,p.A)({},(0,QT._)(n),{space:e,onFinished:()=>i(null)})):s.createElement(ZT.e,(0,p.A)({},(0,QT._)(n),{room:e,onFinished:()=>i(null)}))),null!==r&&(l=s.createElement(XT.f,(0,p.A)({},(0,QT._)(r),{room:e,onFinished:()=>o(null)})));const c=re()("mx_SpotlightDialog_option--notifications",{mx_RoomNotificationContextMenu_iconBell:t===Ax.dC.AllMessages,mx_RoomNotificationContextMenu_iconBellDot:t===Ax.dC.AllMessagesLoud,mx_RoomNotificationContextMenu_iconBellMentions:t===Ax.dC.MentionsOnly,mx_RoomNotificationContextMenu_iconBellCrossed:t===Ax.dC.Mute});return s.createElement(s.Fragment,null,(0,Ne.g)($.C.RoomOptionsMenu)&&s.createElement(ua.o,{className:"mx_SpotlightDialog_option--menu",onClick:e=>{e.preventDefault(),e.stopPropagation();const t=e.target;i(t.getBoundingClientRect())},title:e.isSpaceRoom()?(0,P._t)("space|context_menu|options"):(0,P._t)("room|context_menu|title"),isExpanded:null!==n}),!e.isSpaceRoom()&&s.createElement(ua.o,{className:c,onClick:e=>{e.preventDefault(),e.stopPropagation();const t=e.target;o(t.getBoundingClientRect())},title:(0,P._t)("room_list|notification_options"),isExpanded:null!==r}),a,l)}var tP=n("./src/components/views/rooms/RoomContextDetails.tsx");const nP=["inputRef","className"],iP=e=>{let{inputRef:t,className:n}=e,i=(0,Ve.A)(e,nP);const[r,o,a]=(0,ha.A9)(t);return s.createElement(Ae.A,(0,p.A)({},i,{className:re()(n,"mx_SpotlightDialog_option"),onFocus:r,ref:a,tabIndex:-1,"aria-selected":o,role:"option"}))};var rP=n("./src/components/views/dialogs/spotlight/Filter.ts");const sP=50,oP="24px";function aP(e){var t;return!0===(null==e||null===(t=e.id)||void 0===t?void 0:t.startsWith("mx_SpotlightDialog_button_recentlyViewed_"))}function lP(e){const t=new Set;return e===rP.d.PublicRooms&&t.add(null),e===rP.d.PublicSpaces&&t.add(i.RoomType.Space),t}var cP=function(e){return e[e.People=0]="People",e[e.Rooms=1]="Rooms",e[e.Spaces=2]="Spaces",e[e.Suggestions=3]="Suggestions",e[e.PublicRoomsAndSpaces=4]="PublicRoomsAndSpaces",e}(cP||{});function dP(e){switch(e){case rP.d.People:return(0,P._t)("common|people");case rP.d.PublicRooms:return(0,P._t)("spotlight_dialog|public_rooms_label");case rP.d.PublicSpaces:return(0,P._t)("spotlight_dialog|public_spaces_label")}}const uP=e=>!(null==e||!e.room),mP=e=>!(null==e||!e.publicRoom),pP=e=>!(null==e||!e.member),hP=e=>{var t,n,i,r,s;return{publicRoom:e,section:cP.PublicRoomsAndSpaces,filter:[rP.d.PublicRooms,rP.d.PublicSpaces],query:(0,Vg.Bo)([e.room_id.toLowerCase(),null===(t=e.canonical_alias)||void 0===t?void 0:t.toLowerCase(),null===(n=e.name)||void 0===n?void 0:n.toLowerCase(),Pd()(null!==(i=null===(r=e.topic)||void 0===r?void 0:r.toLowerCase())&&void 0!==i?i:"",{allowedTags:[]}),...(null===(s=e.aliases)||void 0===s?void 0:s.map((e=>e.toLowerCase())))||[]])}},gP=e=>{const t=E.J.safeGet().getUserId();if(mc.A.shared().getUserIdForRoomId(e.roomId)){const n=e.getMembers().filter((e=>e.userId!==t)),i=[...n.map((e=>e.name.toLowerCase())),...n.map((e=>e.userId.toLowerCase()))].filter(Boolean);return{room:e,section:cP.People,filter:[rP.d.People],query:i}}return e.isSpaceRoom()?{room:e,section:cP.Spaces,filter:[]}:{room:e,section:cP.Rooms,filter:[]}},vP=(e,t)=>({alreadyFiltered:t,member:e,section:cP.Suggestions,filter:[rP.d.People],query:[e.userId.toLowerCase(),e.name.toLowerCase()].filter(Boolean)}),fP=new NT.V7,_P=(e,t)=>t.hasMentions?(0,P._t)("a11y|n_unread_messages_mentions",{count:t.count}):t.hasUnreadCount?(0,P._t)("a11y|n_unread_messages",{count:t.count}):t.isUnread?(0,P._t)("a11y|unread_messages"):void 0,yP=e=>V.A.getValue("feature_ask_to_join")&&i.JoinRule.Knock===e,bP=({initialText:e="",initialFilter:t=null,onFinished:n})=>{var r;const o=(0,s.useRef)(null),a=(0,s.useRef)(null),l=E.J.safeGet(),c=(0,s.useContext)(ha.ui),[d,u]=(0,s.useState)(e),[m,h]=(()=>{const[e,t]=(0,s.useState)((()=>{const e=E.J.safeGet(),t=V.A.getValue("SpotlightSearch.recentSearches",null);return(0,Vg.Bo)(t.map((t=>e.getRoom(t))))}));return[e,()=>{V.A.setValue("SpotlightSearch.recentSearches",null,ae.p.ACCOUNT,[]),t([])}]})(),[f,_]=(0,s.useState)(t),y=(0,s.useCallback)((e=>{var t,n,i;_(e),null===(t=o.current)||void 0===t||t.focus(),null===(n=a.current)||void 0===n||null===(i=n.scrollTo)||void 0===i||i.call(n,{top:0})}),[]),b=(0,s.useMemo)((()=>{const e=(0,DT.nf)(l),t=(0,DT._5)(l);return(0,DT.j2)(e,t)}),[l]),S=(0,Oe.ny)("feature_dynamic_room_predecessors"),A=(0,uu.Ne)(l.getUserId()),[x,k]=(0,s.useState)(!1),I=(0,s.useMemo)((()=>d.trim()),[d]),[T,N]=(0,s.useState)(!0);(0,s.useEffect)((()=>{l.isVersionSupported("v1.4").then((e=>e||l.doesServerSupportUnstableFeature("org.matrix.msc3827.stable"))).then((e=>{N(e)}))}),[l]);const{loading:D,publicRooms:M,protocols:O,config:L,setConfig:F,search:U,error:B}=PT(),{loading:j,users:z,search:W}=(()=>{const[e,t]=(0,s.useState)([]),[n,i]=(0,s.useState)(!1),[r,o]=AT(t);return{ready:!0,loading:n,users:e,search:(0,s.useCallback)((async({limit:e=20,query:n})=>{const s={limit:e,term:n};if(r(s),null==n||!n.length)return t([]),!0;try{i(!0);const{results:e}=await E.J.safeGet().searchUserDirectory(s);return o(s,e.map((e=>new gE.qv(e)))),!0}catch(t){return console.error("Could not fetch user in user directory for params",{limit:e,term:n},t),o(s,[]),!1}finally{i(!1)}}),[r,o])}})(),{loading:H,profile:G,search:K}=(()=>{const[e,t]=(0,s.useState)(null),[n,i]=(0,s.useState)(!1),[r,o]=AT(t);return{ready:!0,loading:n,profile:e,search:(0,s.useCallback)((async({query:e})=>{if(r(e),null==e||!e.length||!e.startsWith("@")||!e.includes(":"))return t(null),!0;i(!0);try{const t=await E.J.safeGet().getProfileInfo(e);return o(e,{user_id:e,avatar_url:t.avatar_url,display_name:t.displayname}),!0}catch(t){return console.error("Could not fetch profile info for params",{term:e},t),o(e,null),!1}finally{i(!1)}}),[r,o])}})(),J=(0,s.useMemo)((()=>[{query:I,roomTypes:lP(f),limit:sP}]),[I,f]);ST(f===rP.d.PublicRooms||f===rP.d.PublicSpaces,U,J),ST(f===rP.d.People,W,J),ST(f===rP.d.People,K,J);const q=(0,s.useMemo)((()=>{const e=((e,t)=>e.getVisibleRooms(t).filter((e=>!(0,$f.F)(e)&&(e.getMyMembership()===oa.O.Join||e.getMyMembership()==oa.O.Invite))))(l,S),t=e.map(gP),n=[],i=t.reduce(((e,t)=>{const n=mc.A.shared().getUserIdForRoomId(t.room.roomId);return n?(t.room.getJoinedMemberCount()>2||e.set(n,t),e):e}),new Map);function r(e,t){for(const r of e){if(i.has(r.userId)){const e=i.get(r.userId);t&&pP(e)&&!e.alreadyFiltered&&(e.alreadyFiltered=!0);continue}const e=vP(r,t);i.set(r.userId,e),n.push(e)}}return r(((e,t,n=!0)=>Object.values(e.filter((e=>!n||!mc.A.shared().getUserIdForRoomId(e.roomId))).reduce(((e,t)=>{for(const n of t.getJoinedMembers())e[n.userId]=n;return e}),{})).filter((e=>e.userId!==t.getUserId())))(e,l),!1),r(z,!0),G&&r([new gE.qv(G)],!0),[...xe.Ay.instance.enabledMetaSpaces.map((e=>({section:cP.Spaces,filter:[],avatar:s.createElement("div",{className:re()("mx_SpotlightDialog_metaspaceResult",`mx_SpotlightDialog_metaspaceResult_${e}`)}),name:(0,ke.Ff)(e,xe.Ay.instance.allRoomsInHome),onClick(){xe.Ay.instance.setActiveSpace(e)}}))),...t,...n,...M.map(hP)].filter((e=>null===f||e.filter.includes(f)))}),[l,z,G,M,f,S]),$=(0,s.useMemo)((()=>{const e={[cP.People]:[],[cP.Rooms]:[],[cP.Spaces]:[],[cP.Suggestions]:[],[cP.PublicRoomsAndSpaces]:[]};if(I){const t=I.toLowerCase(),n=(0,g.S8)(I);q.forEach((i=>{if(uP(i)){const e=mc.A.shared().getUserIdForRoomId(i.room.roomId);var r,s,o;if(!z.some((t=>t.userId===e)))if(!(null!==(r=i.room.normalizedName)&&void 0!==r&&r.includes(n)||null!==(s=i.room.getCanonicalAlias())&&void 0!==s&&s.toLowerCase().includes(t)||null!==(o=i.query)&&void 0!==o&&o.some((e=>e.includes(t)))))return}else if(pP(i)){var a;if(!(i.alreadyFiltered||null!==(a=i.query)&&void 0!==a&&a.some((e=>e.includes(t)))))return}else if(mP(i)){var l;if(null===(l=i.query)||void 0===l||!l.some((e=>e.includes(t))))return}else{var c;if(!(i.name.toLowerCase().includes(t)||null!==(c=i.query)&&void 0!==c&&c.some((e=>e.includes(t)))))return}e[i.section].push(i)}))}else f===rP.d.PublicRooms||f===rP.d.PublicSpaces?q.forEach((t=>{mP(t)&&e[t.section].push(t)})):f===rP.d.People&&q.forEach((t=>{pP(t)&&e[t.section].push(t)}));const t=l.getSafeUserId();for(const n of Object.values(e))n.sort(((e,n)=>uP(e)||uP(n)?uP(n)&&uP(e)?fP.getLastTs(n.room,t)-fP.getLastTs(e.room,t):-1:pP(e)||pP(n)?pP(n)&&pP(e)?b(e.member,n.member):-1:0));return e}),[I,f,l,q,z,b]);((e,t,n)=>{(0,s.useEffect)((()=>{if(!t)return;const i=window.setTimeout((()=>{hu.Vo.instance.trackEvent({eventName:"WebSearch",viaSpotlight:n,numResults:e,queryLength:t})}),1e3);return()=>{clearTimeout(i)}}),[e,t,n])})((0,v.sum)(Object.values($).map((e=>e.length))),d.length,!0);const Y=xe.Ay.instance.activeSpaceRoom,[Z,X]=((e,t)=>{var n;const[r,o]=(0,s.useState)([]),[a,l]=(0,s.useState)(),c=(0,s.useCallback)((()=>{l(e?new Kb(e,50):void 0)}),[e]);return(0,s.useEffect)(c,[c]),(0,s.useEffect)((()=>{if(!e||!a)return;let t=!1;return(async()=>{for(;null!=a&&a.canLoadMore&&!t&&e===a.root;)await a.load(),a.canLoadMore&&a.load(),o(a.rooms)})(),()=>{t=!0}}),[e,a]),[(0,s.useMemo)((()=>{const e=t.trim(),n=e.toLowerCase(),s=(0,g.S8)(e),o=E.J.safeGet();return null==r?void 0:r.filter((e=>{var t;return e.room_type!==i.RoomType.Space&&(null===(t=o.getRoom(e.room_id))||void 0===t?void 0:t.getMyMembership())!==oa.O.Join&&((0,g.S8)(e.name||"").includes(s)||(e.canonical_alias||"").includes(n))}))}),[r,t]),null!==(n=null==a?void 0:a.loading)&&void 0!==n&&n]})(null!=Y?Y:void 0,d);(0,s.useEffect)((()=>{setTimeout((()=>{const e=c.state.nodes[0];var t;e&&(c.dispatch({type:ha.ZU.SetFocus,payload:{node:e}}),null==e||null===(t=e.scrollIntoView)||void 0===t||t.call(e,{block:"nearest"}))}))}),[$,f]);const Q=(e,t=!1,i=!1)=>{if(t){const t=new Set(V.A.getValue("SpotlightSearch.recentSearches",null).reverse());t.delete(e.roomId),t.add(e.roomId),V.A.setValue("SpotlightSearch.recentSearches",null,ae.p.ACCOUNT,Array.from(t).reverse().slice(0,10))}w.A.dispatch({action:R.r.ViewRoom,metricsTrigger:"WebUnifiedSearch",metricsViaKeyboard:i,room_id:e.roomId,room_alias:e.roomAlias,auto_join:e.autoJoin&&!yP(e.joinRule),should_peek:e.shouldPeek,via_servers:e.viaServers}),yP(e.joinRule)&&w.A.dispatch({action:R.r.PromptAskToJoin}),n()};let ee,ne;if((I||f!==rP.d.PublicRooms&&f!==rP.d.PublicSpaces)&&(ee=s.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group","aria-labelledby":"mx_SpotlightDialog_section_otherSearches"},s.createElement("h4",{id:"mx_SpotlightDialog_section_otherSearches"},I?(0,P._t)("spotlight_dialog|heading_with_query",{query:d}):(0,P._t)("spotlight_dialog|heading_without_query")),s.createElement("div",null,f!==rP.d.PublicSpaces&&T&&s.createElement(qT,{id:"mx_SpotlightDialog_button_explorePublicSpaces",className:"mx_SpotlightDialog_explorePublicSpaces",onClick:()=>y(rP.d.PublicSpaces)},dP(rP.d.PublicSpaces)),f!==rP.d.PublicRooms&&s.createElement(qT,{id:"mx_SpotlightDialog_button_explorePublicRooms",className:"mx_SpotlightDialog_explorePublicRooms",onClick:()=>y(rP.d.PublicRooms)},dP(rP.d.PublicRooms)),f!==rP.d.People&&s.createElement(qT,{id:"mx_SpotlightDialog_button_startChat",className:"mx_SpotlightDialog_startChat",onClick:()=>y(rP.d.People)},dP(rP.d.People))))),I||null!==f){const e=e=>{var t;if(uP(e)){const t=Ea.n.instance.getRoomState(e.room),n=_P(e.room,t),i={"aria-label":n?`${e.room.name} ${n}`:e.room.name,"aria-describedby":`mx_SpotlightDialog_button_result_${e.room.roomId}_details`};return s.createElement(qT,(0,p.A)({id:`mx_SpotlightDialog_button_result_${e.room.roomId}`,key:`${cP[e.section]}-${e.room.roomId}`,onClick:t=>{Q({roomId:e.room.roomId},!0,"click"!==(null==t?void 0:t.type))},endAdornment:s.createElement(eP,{room:e.room})},i),s.createElement(il.A,{room:e.room,size:oP,tooltipProps:{tabIndex:-1}}),e.room.name,s.createElement(da.A,{notification:t}),s.createElement(tP.n,{id:`mx_SpotlightDialog_button_result_${e.room.roomId}_details`,className:"mx_SpotlightDialog_result_details",room:e.room}))}if(pP(e))return s.createElement(qT,{id:`mx_SpotlightDialog_button_result_${e.member.userId}`,key:`${cP[e.section]}-${e.member.userId}`,onClick:()=>{(0,gE.UZ)(l,[e.member]),n()},"aria-label":e.member instanceof i.RoomMember?e.member.rawDisplayName:e.member.name,"aria-describedby":`mx_SpotlightDialog_button_result_${e.member.userId}_details`},s.createElement(MT.N,{user:e.member,size:oP}),e.member instanceof i.RoomMember?e.member.rawDisplayName:e.member.name,s.createElement("div",{id:`mx_SpotlightDialog_button_result_${e.member.userId}_details`,className:"mx_SpotlightDialog_result_details"},e.member.userId));if(mP(e)){const t=l.getRoom(e.publicRoom.room_id),n=e.publicRoom.join_rule,i=(null==t?void 0:t.getMyMembership())===oa.O.Join||e.publicRoom.world_readable&&!yP(n)||l.isGuest(),r=t=>{var i;t.stopPropagation();const{publicRoom:r}=e;Q({roomAlias:r.canonical_alias||(null===(i=r.aliases)||void 0===i?void 0:i[0]),roomId:r.room_id,autoJoin:!e.publicRoom.world_readable&&!l.isGuest(),shouldPeek:e.publicRoom.world_readable||l.isGuest(),viaServers:L?[L.roomServer]:void 0,joinRule:n},!0,"click"!==t.type)};let o;return o=i?(0,P._t)("action|view"):yP(n)?(0,P._t)("action|ask_to_join"):(0,P._t)("action|join"),s.createElement(qT,{id:`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}`,className:"mx_SpotlightDialog_result_multiline",key:`${cP[e.section]}-${e.publicRoom.room_id}`,onClick:r,endAdornment:s.createElement(Ae.A,{kind:i?"primary_outline":"primary",onClick:r,tabIndex:-1},o),"aria-labelledby":`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_name`,"aria-describedby":`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_alias`,"aria-details":`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_details`},s.createElement(aa.A,{className:"mx_SearchResultAvatar",oobData:{roomId:e.publicRoom.room_id,name:e.publicRoom.name,avatarUrl:e.publicRoom.avatar_url,roomType:e.publicRoom.room_type},size:oP}),s.createElement($T,{room:e.publicRoom,labelId:`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_name`,descriptionId:`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_alias`,detailsId:`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_details`}))}return s.createElement(qT,{id:`mx_SpotlightDialog_button_result_${e.name}`,key:`${cP[e.section]}-${e.name}`,onClick:null!==(t=e.onClick)&&void 0!==t?t:null},e.avatar,e.name,e.description)};let t,r,o,a,c,d,u,m,h,g;if($[cP.People].length&&(t=s.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_people"},s.createElement("h4",{id:"mx_SpotlightDialog_section_people"},(0,P._t)("invite|recents_section")),s.createElement("div",null,$[cP.People].slice(0,sP).map(e)))),$[cP.Suggestions].length&&f===rP.d.People&&(r=s.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_suggestions"},s.createElement("h4",{id:"mx_SpotlightDialog_section_suggestions"},(0,P._t)("common|suggestions")),s.createElement("div",null,$[cP.Suggestions].slice(0,sP).map(e)))),$[cP.Rooms].length&&(o=s.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_rooms"},s.createElement("h4",{id:"mx_SpotlightDialog_section_rooms"},(0,P._t)("common|rooms")),s.createElement("div",null,$[cP.Rooms].slice(0,sP).map(e)))),$[cP.Spaces].length&&(a=s.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_spaces"},s.createElement("h4",{id:"mx_SpotlightDialog_section_spaces"},(0,P._t)("spotlight_dialog|spaces_title")),s.createElement("div",null,$[cP.Spaces].slice(0,sP).map(e)))),f===rP.d.PublicRooms||f===rP.d.PublicSpaces){let t;t=B?s.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchText"},f===rP.d.PublicRooms?(0,P._t)("spotlight_dialog|failed_querying_public_rooms"):(0,P._t)("spotlight_dialog|failed_querying_public_spaces")):$[cP.PublicRoomsAndSpaces].slice(0,sP).map(e),c=s.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_publicRooms"},s.createElement("div",{className:"mx_SpotlightDialog_sectionHeader"},s.createElement("h4",{id:"mx_SpotlightDialog_section_publicRooms"},(0,P._t)("common|suggestions")),s.createElement("div",{className:"mx_SpotlightDialog_options"},s.createElement(KT,{protocols:O,config:null!=L?L:null,setConfig:F}))),s.createElement("div",null,t))}Z.length&&Y&&null===f&&(d=s.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_spaceRooms"},s.createElement("h4",{id:"mx_SpotlightDialog_section_spaceRooms"},(0,P._t)("spotlight_dialog|other_rooms_in_space",{spaceName:Y.name})),s.createElement("div",null,Z.slice(0,sP).map((e=>s.createElement(qT,{id:`mx_SpotlightDialog_button_result_${e.room_id}`,key:e.room_id,onClick:t=>{Q({roomId:e.room_id},!0,"click"!==(null==t?void 0:t.type))}},s.createElement(ja.A,{name:e.name,idName:e.room_id,url:e.avatar_url?(0,Up.lH)(e.avatar_url).getSquareThumbnailHttp(parseInt(oP,10)):null,size:oP}),e.name||e.canonical_alias,e.name&&e.canonical_alias&&s.createElement("div",{className:"mx_SpotlightDialog_result_details"},e.canonical_alias)))),X&&s.createElement(Na.A,null)))),!I.startsWith("#")||!I.includes(":")||(0,te.M)(I)&&l.getRoom((0,te.M)(I))||(u=s.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group"},s.createElement("div",null,s.createElement(qT,{id:"mx_SpotlightDialog_button_joinRoomAlias",className:"mx_SpotlightDialog_joinRoomAlias",onClick:e=>{w.A.dispatch({action:R.r.ViewRoom,room_alias:I,auto_join:!0,metricsTrigger:"WebUnifiedSearch",metricsViaKeyboard:"click"!==(null==e?void 0:e.type)}),n()}},(0,P._t)("spotlight_dialog|join_button_text",{roomAddress:I}))))),f===rP.d.People?m=s.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_hiddenResults",role:"group"},s.createElement("h4",null,(0,P._t)("spotlight_dialog|result_may_be_hidden_privacy_warning")),s.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchText"},(0,P._t)("spotlight_dialog|cant_find_person_helpful_hint")),s.createElement(iP,{id:"mx_SpotlightDialog_button_inviteLink",className:"mx_SpotlightDialog_inviteLink",onClick:()=>{k(!0),(0,s_.nC)(A)},onTooltipOpenChange:e=>{e||k(!1)},title:x?(0,P._t)("common|copied"):(0,P._t)("action|copy")},s.createElement("span",{className:"mx_AccessibleButton mx_AccessibleButton_hasKind mx_AccessibleButton_kind_primary_outline"},(0,P._t)("spotlight_dialog|copy_link_text")))):!I||f!==rP.d.PublicRooms&&f!==rP.d.PublicSpaces||(m=s.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_hiddenResults",role:"group"},s.createElement("h4",null,(0,P._t)("spotlight_dialog|result_may_be_hidden_warning")),s.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchText"},(0,P._t)("spotlight_dialog|cant_find_room_helpful_hint")),s.createElement(qT,{id:"mx_SpotlightDialog_button_createNewRoom",className:"mx_SpotlightDialog_createRoom",onClick:()=>w.A.dispatch({action:"view_create_room",public:!0,defaultName:(0,v.capitalize)(I)})},s.createElement("span",{className:"mx_AccessibleButton mx_AccessibleButton_hasKind mx_AccessibleButton_kind_primary_outline"},(0,P._t)("spotlight_dialog|create_new_room_button"))))),f===rP.d.People&&(h=s.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group","aria-labelledby":"mx_SpotlightDialog_section_groupChat"},s.createElement("h4",{id:"mx_SpotlightDialog_section_groupChat"},(0,P._t)("spotlight_dialog|group_chat_section_title")),s.createElement(qT,{id:"mx_SpotlightDialog_button_startGroupChat",className:"mx_SpotlightDialog_startGroupChat",onClick:()=>(0,C.xZ)(I)},(0,P._t)("spotlight_dialog|start_group_chat_button")))),null===f&&(g=s.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group","aria-labelledby":"mx_SpotlightDialog_section_messageSearch"},s.createElement("h4",{id:"mx_SpotlightDialog_section_messageSearch"},(0,P._t)("spotlight_dialog|message_search_section_title")),s.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchText"},(0,P._t)("spotlight_dialog|search_messages_hint",{},{icon:()=>s.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchIcon"})})))),ne=s.createElement(s.Fragment,null,t,r,o,a,d,c,u,m,ee,h,g)}else{let e;m.length&&(e=s.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_recentSearches",role:"group",tabIndex:-1,"aria-labelledby":"mx_SpotlightDialog_section_recentSearches"},s.createElement("h4",null,s.createElement("span",{id:"mx_SpotlightDialog_section_recentSearches"},(0,P._t)("spotlight_dialog|recent_searches_section_title")),s.createElement(Ae.A,{kind:"link",onClick:h},(0,P._t)("action|clear"))),s.createElement("div",null,m.map((e=>{const t=Ea.n.instance.getRoomState(e),n=_P(0,t),i={"aria-label":n?`${e.name} ${n}`:e.name,"aria-describedby":`mx_SpotlightDialog_button_recentSearch_${e.roomId}_details`};return s.createElement(qT,(0,p.A)({id:`mx_SpotlightDialog_button_recentSearch_${e.roomId}`,key:e.roomId,onClick:t=>{Q({roomId:e.roomId},!0,"click"!==(null==t?void 0:t.type))},endAdornment:s.createElement(eP,{room:e})},i),s.createElement(il.A,{room:e,size:oP,tooltipProps:{tabIndex:-1}}),e.name,s.createElement(da.A,{notification:t}),s.createElement(tP.n,{id:`mx_SpotlightDialog_button_recentSearch_${e.roomId}_details`,className:"mx_SpotlightDialog_result_details",room:e}))}))))),ne=s.createElement(s.Fragment,null,s.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_recentlyViewed",role:"group","aria-labelledby":"mx_SpotlightDialog_section_recentlyViewed"},s.createElement("h4",{id:"mx_SpotlightDialog_section_recentlyViewed"},(0,P._t)("spotlight_dialog|recently_viewed_section_title")),s.createElement("div",null,sc.Y.instance.rooms.filter((e=>e.roomId!==Wa.M.instance.roomViewStore.getRoomId())).map((e=>s.createElement(iP,{id:`mx_SpotlightDialog_button_recentlyViewed_${e.roomId}`,title:e.name,key:e.roomId,onClick:t=>{Q({roomId:e.roomId},!1,"click"!==t.type)}},s.createElement(il.A,{room:e,size:"32px",tooltipProps:{tabIndex:-1}}),e.name))))),e,ee)}const ie=null===(r=c.state.activeNode)||void 0===r?void 0:r.id;return s.createElement(s.Fragment,null,s.createElement("div",{id:"mx_SpotlightDialog_keyboardPrompt"},(0,P._t)("spotlight_dialog|keyboard_scroll_hint",{},{arrows:()=>s.createElement(s.Fragment,null,s.createElement("kbd",null,"â†“"),s.createElement("kbd",null,"â†‘"),null!==!f&&!d&&s.createElement("kbd",null,"â†"),null!==!f&&!d&&s.createElement("kbd",null,"â†’"))})),s.createElement(Pa.A,{className:"mx_SpotlightDialog",onFinished:n,hasCancel:!1,onKeyDown:e=>{if((0,Re.zM)().getNavigationAction(e)===Se.bY.FilterRooms)e.stopPropagation(),e.preventDefault(),n();let t;const i=(0,Re.zM)().getAccessibilityAction(e);switch(i){case Se.bY.Escape:e.stopPropagation(),e.preventDefault(),n();break;case Se.bY.ArrowUp:case Se.bY.ArrowDown:if(e.stopPropagation(),e.preventDefault(),c.state.activeNode&&c.state.nodes.length>0){let e=c.state.nodes;if(!d&&null!==!f){const t=aP(c.state.activeNode)?c.state.activeNode:e.find(aP);e=e.filter((e=>e===t||!aP(e)))}const n=e.indexOf(c.state.activeNode);t=(0,ha.Ed)(e,n+(i===Se.bY.ArrowUp?-1:1))}break;case Se.bY.ArrowLeft:case Se.bY.ArrowRight:if(!d&&null!==!f&&c.state.activeNode&&c.state.nodes.length>0&&aP(c.state.activeNode)){e.stopPropagation(),e.preventDefault();const n=c.state.nodes.filter(aP),r=n.indexOf(c.state.activeNode);t=(0,ha.Ed)(n,r+(i===Se.bY.ArrowLeft?-1:1))}}var r;t&&(c.dispatch({type:ha.ZU.SetFocus,payload:{node:t}}),null===(r=t)||void 0===r||r.scrollIntoView({block:"nearest"}))},screenName:"UnifiedSearch","aria-label":(0,P._t)("spotlight_dialog|search_dialog")},s.createElement("div",{className:"mx_SpotlightDialog_searchBox mx_textinput"},null!==f&&s.createElement("div",{className:re()("mx_SpotlightDialog_filter",{mx_SpotlightDialog_filterPeople:f===rP.d.People,mx_SpotlightDialog_filterPublicRooms:f===rP.d.PublicRooms,mx_SpotlightDialog_filterPublicSpaces:f===rP.d.PublicSpaces})},s.createElement("span",null,dP(f)),s.createElement(Ae.A,{tabIndex:-1,title:(0,P._t)("spotlight_dialog|remove_filter",{filter:dP(f)}),className:"mx_SpotlightDialog_filter--close",onClick:()=>y(null)})),s.createElement("input",{ref:o,autoFocus:!0,type:"text",autoComplete:"off",autoCapitalize:"off",autoCorrect:"off",spellCheck:"false",placeholder:(0,P._t)("action|search"),value:d,onChange:e=>{const t=function(e){var t;const n=(0,uu.$N)(e);return null!==(t=null==n?void 0:n.primaryEntityId)&&void 0!==t?t:e}(e.currentTarget.value);u(t)},onKeyDown:e=>{var t;switch((0,Re.zM)().getAccessibilityAction(e)){case Se.bY.Backspace:d||null===f||(e.stopPropagation(),e.preventDefault(),y(null));break;case Se.bY.Enter:e.stopPropagation(),e.preventDefault(),null===(t=c.state.activeNode)||void 0===t||t.click()}},"aria-owns":"mx_SpotlightDialog_content","aria-activedescendant":ie,"aria-label":(0,P._t)("action|search"),"aria-describedby":"mx_SpotlightDialog_keyboardPrompt"}),(D||j||H)&&s.createElement(Na.A,{w:24,h:24})),s.createElement("div",{ref:a,id:"mx_SpotlightDialog_content",role:"listbox","aria-activedescendant":ie,"aria-describedby":"mx_SpotlightDialog_keyboardPrompt"},ne)))},EP=e=>s.createElement(ha.Se,null,(()=>s.createElement(bP,e)));var wP=n("./src/utils/dm/findDMForUser.ts"),SP=n("./src/utils/crypto/shouldForceDisableEncryption.ts");const AP="react_sdk_session_lock_ping",CP="react_sdk_session_lock_owner",xP="react_sdk_session_lock_claimant",kP=3e4;async function RP(e){const t=(0,F.A)(),n=o.v.getChild(`getSessionLock[${t}]`);let i=null;function r(){const e=window.localStorage.getItem(xP);if(e!==t)return n.warn(`Lock was claimed by ${e} while we were waiting for it: aborting startup`),-1;const i=window.localStorage.getItem(AP),r=window.localStorage.getItem(CP);if(null===i)return n.info("No other session has the lock: proceeding with startup"),0;const s=Date.now()-parseInt(i),o=kP-s;return o<=0?(n.info(`Last ping (from ${r}) was ${s}ms ago: proceeding with startup`),0):(n.info(`Last ping (from ${r}) was ${s}ms ago, waiting ${o}ms`),o)}function s(){window.localStorage.setItem(CP,t),window.localStorage.setItem(AP,Date.now().toString())}function a(){null!==i&&(n.debug("page hide: clearing our claim"),window.clearInterval(i),window.localStorage.removeItem(AP),window.localStorage.removeItem(CP),i=null)}for(window.localStorage.setItem(xP,t);;){const t=r();if(0==t)break;if(t<0)return await e(),!1;let n;const i=new Promise((e=>{n=t=>{t.key!==AP&&t.key!==xP||e(t)}})),s=new Promise((e=>{setTimeout(e,t,void 0)}));window.addEventListener("storage",n),await Promise.race([s,i]),window.removeEventListener("storage",n)}return s(),i=window.setInterval(s,5e3),window.addEventListener("storage",(function r(s){if(s.key===xP){const s=window.localStorage.getItem(xP);if(s===t)return;n.info(`Session ${s} is waiting for the lock`),window.removeEventListener("storage",r),async function(){await e(),null!==i&&window.clearInterval(i);window.localStorage.removeItem(AP),window.localStorage.removeItem(CP),i=null}().catch((e=>{n.error("Error releasing session lock",e)}))}})),window.addEventListener("pagehide",a),window.addEventListener("unload",a),!0}function IP(){const e=u.Ay.get().brand;return s.createElement(bT,{className:"mx_SessionLockStolenView"},s.createElement("h1",null,(0,P._t)("error_app_open_in_another_tab_title",{brand:e})),s.createElement("h2",null,(0,P._t)("error_app_open_in_another_tab",{brand:e})))}function TP(e){const t=u.Ay.get().brand;return s.createElement("div",{className:"mx_ConfirmSessionLockTheftView"},s.createElement("div",{className:"mx_ConfirmSessionLockTheftView_body"},s.createElement("p",null,(0,P._t)("error_app_opened_in_another_window",{brand:t,label:(0,P._t)("action|continue")})),s.createElement(Ae.A,{kind:"primary",onClick:e.onConfirm},(0,P._t)("action|continue"))))}function PP(e){const t=(0,Me.DY)(e.matrixClient,f.CryptoEvent.LegacyCryptoStoreMigrationProgress,((e,t)=>({progress:null!=e?e:-1,totalSteps:null!=t?t:-1})));let n,i;return e.syncError&&(n=s.createElement("div",{className:"mx_LoginSplashView_syncError"},(0,fe.cQ)(e.syncError))),i=-1!==t.totalSteps?s.createElement("div",{className:"mx_LoginSplashView_migrationProgress"},s.createElement("p",null,(0,P._t)("migrating_crypto",{brand:u.Ay.get().brand})),s.createElement(Jd.A,{value:t.progress,max:t.totalSteps})):s.createElement(Na.A,null),s.createElement("div",{className:"mx_MatrixChat_splash"},n,i,s.createElement("div",{className:"mx_LoginSplashView_splashButtons"},s.createElement(Ae.A,{kind:"link_inline",onClick:e.onLogoutClick},(0,P._t)("action|logout"))))}const NP="mx_draft_cleanup",DP=2592e6;function MP(){if(function(){try{const e=localStorage.getItem(NP);if(!e)return!0;const t=Number.parseInt(e||"",10);return!Number.isInteger(t)||Date.now()>t+DP}catch{return!0}}()){o.v.debug("Cleaning up editor drafts..."),function(){for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e);if(!t)continue;let n;if(t.startsWith(Gf.hE)&&(n=t.slice(Gf.hE.length).split("_$")[0]),t.startsWith(Zf)&&(n=t.slice(17).split("_$")[0]),!n)continue;E.J.safeGet().getRoom(n)||(o.v.debug(`Removing draft for unknown room with key ${t}`),localStorage.removeItem(t))}}();try{localStorage.setItem(NP,String(Date.now()))}catch(e){o.v.error("Failed to persist draft cleanup key",e)}}}function OP(){const[e,t]=(0,s.useState)(!1),[n,r]=(0,s.useState)(""),[o,a]=(0,s.useState)(!0),[c,d]=(0,s.useState)(""),u=e?s.createElement(Na.A,{w:16,h:16}):(0,P._t)("auth|proconnect|continue"),m=(0,s.useRef)(null),p=async(e=n)=>{var t;return!!await(null===(t=m.current)||void 0===t?void 0:t.validate({allowEmpty:!1,focused:!0}))&&jb.X(e)},h=e=>{d(e),t(!1)},g=async e=>{e.preventDefault(),t(!0);if(await p())try{var r;const e=await oC.A.fetchHomeserverForEmail(n);if(!e)return void h("This email address cannot be used in Tchap");const s=new UI.A(e.base_url,e.base_url,null,{}),o=s.createTemporaryClient(),a=await(async e=>{try{return await oC.A.makeValidatedServerConfig(e)}catch(e){return window.location.assign("email-precheck-sso"),null}})(e);if(!a)return void h((0,P._t)("auth|proconnect|error_homeserver"));const c=await(async e=>{const t=await e.getFlows();return!(null==t||!t.find((e=>"m.login.sso"===e.type)))})(s);if(!c)return void h((0,P._t)("auth|proconnect|error_sso_inactive"));null===(r=l.A.get())||void 0===r||r.startSingleSignOn(o,"sso","/home","",i.SSOAction.LOGIN),t(!1)}catch(e){h((0,P._t)("auth|proconnect|error"))}else h((0,P._t)("auth|proconnect|error_email"))};return s.createElement(mI,null,s.createElement(wI,null),s.createElement(SI,null,s.createElement("h1",null,(0,P._t)("auth|proconnect|email_title")),s.createElement("form",{onSubmit:g,className:"tc_pronnect"},s.createElement("fieldset",{disabled:e,className:"tc_login"},s.createElement("div",{className:"mx_AuthBody_fieldRow"},s.createElement(NA,{name:"check_email",label:(0,P.AO)("auth|proconnect|email_placeholder"),labelRequired:(0,P.AO)("auth|forgot_password_email_required"),labelInvalid:(0,P.AO)("auth|forgot_password_email_invalid"),value:n,autoFocus:!0,onChange:e=>(async e=>{const t=e.currentTarget.value;r(t);const n=await p(t);a(!n)})(e),fieldRef:m})),c&&s.createElement(xI.K,{message:c}),s.createElement(Ae.A,{type:"submit",title:(0,P._t)("auth|proconnect|continue"),className:"tc_ButtonParent tc_ButtonProconnect tc_Button_iconPC",element:"button",kind:"link",disabled:o,onClick:e=>{g(e)}},u),s.createElement("div",{className:"mx_AuthBody_button-container tc_bottomButton"},s.createElement(Ae.A,{className:"mx_AuthBody_sign-in-instead-button",element:"button",kind:"link",onClick:e=>{e.preventDefault(),window.location.assign("#/login")}},(0,P._t)("auth|proconnect|sign_in_password_instead")))))))}function LP(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function FP(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?LP(Object(n),!0).forEach((function(t){(0,h.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):LP(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const UP=["register","mobile_register","login","forgot_password","start_sso","start_cas","welcome"],BP=[R.r.ViewUserSettings,"view_create_chat","view_create_room"];class VP extends s.PureComponent{constructor(e){if(super(e),(0,h.A)(this,"firstSyncComplete",!1),(0,h.A)(this,"firstSyncPromise",void 0),(0,h.A)(this,"screenAfterLogin",void 0),(0,h.A)(this,"tokenLogin",void 0),(0,h.A)(this,"focusNext",void 0),(0,h.A)(this,"subTitleStatus",void 0),(0,h.A)(this,"prevWindowWidth",void 0),(0,h.A)(this,"loggedInView",(0,s.createRef)()),(0,h.A)(this,"dispatcherRef",void 0),(0,h.A)(this,"themeWatcher",void 0),(0,h.A)(this,"fontWatcher",void 0),(0,h.A)(this,"stores",void 0),(0,h.A)(this,"startInitSession",(()=>{const e=this.initSession();this.props.initPromiseCallback&&this.props.initPromiseCallback(e),e.catch((e=>{o.v.error("Error initialising Matrix session",e)}))})),(0,h.A)(this,"onWindowResized",(()=>{this.warnInConsole()})),(0,h.A)(this,"warnInConsole",(0,v.throttle)((()=>{const e="15px",t=(0,P._t)("console_wait"),i=(0,P._t)("console_scam_warning"),r=(0,P._t)("console_dev_note");n.g.mx_rage_logger.bypassRageshake("log",`%c${t}\n%c${i}\n%c${r}`,"font-size:50px; color:blue;",`font-size:${e}; color:red;`,`font-size:${e};`)}),1e3)),(0,h.A)(this,"onAction",(e=>{var t;if(this.state.view!==_T.A.LOCK_STOLEN){if(null!==(t=E.J.get())&&void 0!==t&&t.isGuest()&&BP.includes(e.action))return w.A.dispatch({action:R.r.DoAfterSyncPrepared,deferred_action:e}),void w.A.dispatch({action:"require_registration"});switch(e.action){case"MatrixActions.accountData":if("m.identity_server"===e.event_type){const t=e.event_content?e.event_content.base_url:null;t?(E.J.safeGet().setIdentityServerUrl(t),localStorage.removeItem("mx_is_access_token"),localStorage.setItem("mx_is_url",t)):(E.J.safeGet().setIdentityServerUrl(void 0),localStorage.removeItem("mx_is_access_token"),localStorage.removeItem("mx_is_url")),w.A.dispatch({action:"id_server_changed"})}break;case"logout":Ee.Ay.instance.hangupAllCalls(),Promise.all([...[...fb.e.instance.connectedCalls].map((e=>e.disconnect()))]).finally((()=>d.ri(this.stores.oidcClientStore)));break;case"require_registration":!async function(e={}){const t=A.Ay.createDialog(q.A,{hasCancelButton:!0,quitOnly:!0,title:V.A.getValue($.f.Registration)?(0,P._t)("auth|sign_in_or_register"):(0,P._t)("action|sign_in"),description:V.A.getValue($.f.Registration)?(0,P._t)("auth|sign_in_or_register_description"):(0,P._t)("auth|sign_in_description"),button:(0,P._t)("action|sign_in"),extraButtons:V.A.getValue($.f.Registration)?[s.createElement("button",{key:"register",onClick:()=>{t.close(),w.A.dispatch({action:"start_registration",screenAfterLogin:e.screen_after})}},(0,P._t)("auth|register_action"))]:[],onFinished:t=>{t?w.A.dispatch({action:"start_login",screenAfterLogin:e.screen_after}):e.go_home_on_cancel?w.A.dispatch({action:R.r.ViewHomePage}):e.go_welcome_on_cancel&&w.A.dispatch({action:"view_welcome_page"})}})}(e);break;case"start_mobile_registration":this.startRegistration(e.params||{},!0);break;case"start_registration":if(d.b()){this.onSoftLogout();break}e.screenAfterLogin&&(this.screenAfterLogin=e.screenAfterLogin),this.startRegistration(e.params||{});break;case"start_login":if(d.b()){this.onSoftLogout();break}e.screenAfterLogin&&(this.screenAfterLogin=e.screenAfterLogin),this.viewLogin();break;case"start_password_recovery":this.setStateForNewView({view:_T.A.FORGOT_PASSWORD}),this.notifyNewScreen("forgot_password");break;case"start_chat":(0,K.Ay)(E.J.safeGet(),{dmUserId:e.user_id});break;case"leave_room":this.leaveRoom(e.room_id);break;case"forget_room":this.forgetRoom(e.room_id);break;case"copy_room":this.copyRoom(e.room_id);break;case"reject_invite":A.Ay.createDialog(q.A,{title:(0,P._t)("reject_invitation_dialog|title"),description:(0,P._t)("reject_invitation_dialog|confirmation"),onFinished:t=>{if(t){const t=A.Ay.createDialog(Na.A,void 0,"mx_Dialog_spinner");E.J.safeGet().leave(e.room_id).then((()=>{t.close(),this.state.currentRoomId===e.room_id&&w.A.dispatch({action:R.r.ViewHomePage})}),(e=>{t.close(),A.Ay.createDialog(_v.A,{title:(0,P._t)("reject_invitation_dialog|failed"),description:e.toString()})}))}}});break;case"view_user_info":this.viewUser(e.userId,e.subAction);break;case"MatrixActions.RoomState.events":{const t=e.event;t.getType()===i.EventType.RoomCanonicalAlias&&t.getRoomId()===this.state.currentRoomId&&this.viewRoom({action:R.r.ViewRoom,room_id:this.state.currentRoomId,metricsTrigger:void 0});break}case R.r.ViewRoom:{const t=this.viewRoom(e);e.deferred_action&&t.then((()=>{w.A.dispatch(e.deferred_action)}));break}case R.r.ViewUserDeviceSettings:w.A.dispatch({action:R.r.ViewUserSettings,initialTabId:wa.v.SessionManager});break;case R.r.ViewUserSettings:{const t=e;A.Ay.createDialog(tI,FP(FP({},e.props),{},{initialTabId:t.initialTabId,sdkContext:this.stores}),void 0,!1,!0),this.viewSomethingBehindModal();break}case"view_create_room":this.createRoom(e.public,e.defaultName,e.type),this.viewSomethingBehindModal();break;case R.r.ViewRoomDirectory:A.Ay.createDialog(EP,{initialText:e.initialText,initialFilter:rP.d.PublicRooms},"mx_SpotlightDialog_wrapper",!1,!0),this.viewSomethingBehindModal();break;case"view_welcome_page":this.viewWelcome();break;case R.r.ViewHomePage:this.viewHome(e.justRegistered);break;case R.r.ViewStartChatOrReuse:this.chatCreateOrReuse(e.user_id);break;case"view_create_chat":(0,C.xZ)(e.initialText||""),this.viewSomethingBehindModal();break;case"view_invite":{const t=E.J.safeGet().getRoom(e.roomId);null!=t&&t.isSpaceRoom()?(0,Le.Lo)(t):(0,C._7)(e.roomId);break}case"view_last_screen":this.showScreenAfterLogin();break;case"hide_left_panel":this.setState({collapseLhs:!0},(()=>{this.state.resizeNotifier.notifyLeftHandleResized()}));break;case"show_left_panel":this.setState({collapseLhs:!1},(()=>{this.state.resizeNotifier.notifyLeftHandleResized()}));break;case R.r.OpenDialPad:A.Ay.createDialog(oS,{},"mx_Dialog_dialPadWrapper");break;case R.r.OnLoggedIn:this.stores.client=E.J.safeGet(),this.tokenLogin||d.b()||this.state.view===_T.A.LOGIN||this.state.view===_T.A.REGISTER||this.state.view===_T.A.COMPLETE_SECURITY||this.state.view===_T.A.E2E_SETUP||this.state.view===_T.A.USE_CASE_SELECTION||this.onLoggedIn();break;case"on_client_not_viable":this.onSoftLogout();break;case R.r.OnLoggedOut:this.onLoggedOut();break;case"will_start_client":this.setState({ready:!1},(()=>{this.onWillStartClient()}));break;case"client_started":this.onClientStarted().catch((e=>{o.v.error("Exception in onClientStarted",e)}));break;case"send_event":this.onSendEvent(e.room_id,e.event);break;case"aria_hide_main_app":this.setState({hideToSRUsers:!0});break;case"aria_unhide_main_app":this.setState({hideToSRUsers:!1});break;case R.r.PseudonymousAnalyticsAccept:iS(),V.A.setValue("pseudonymousAnalyticsOptIn",null,ae.p.ACCOUNT,!0);break;case R.r.PseudonymousAnalyticsReject:iS(),V.A.setValue("pseudonymousAnalyticsOptIn",null,ae.p.ACCOUNT,!1);break;case R.r.ShowThread:{const{rootEvent:t,initialEvent:n,highlighted:i,scrollIntoView:r,push:s}=e,o={phase:sl.n.ThreadView,state:{threadHeadEvent:t,initialEvent:n,isInitialEventHighlighted:i,initialEventScrollIntoView:r}};null!=s&&s?rl.A.instance.pushCard(o):rl.A.instance.setCards([{phase:sl.n.ThreadPanel},o]),w.A.dispatch({action:R.r.FocusSendMessageComposer,context:Sp.Ae.Thread});break}case R.r.OpenSpotlight:A.Ay.createDialog(EP,{initialText:e.initialText,initialFilter:e.initialFilter},"mx_SpotlightDialog_wrapper",!1,!0);break;case R.r.EmailPrecheckSSO:if(d.b()){this.onSoftLogout();break}this.viewEmailPrecheckSSO()}}})),(0,h.A)(this,"handleResize",(()=>{const e=1e3,t=Ie.A.instance.windowWidth;this.prevWindowWidth<e&&t>=e&&w.A.dispatch({action:"show_left_panel"}),this.prevWindowWidth>=e&&t<e&&w.A.dispatch({action:"hide_left_panel"}),this.prevWindowWidth=t,this.state.resizeNotifier.notifyWindowResized()})),(0,h.A)(this,"onRegisterClick",(()=>{this.showScreen("register")})),(0,h.A)(this,"onLoginClick",(()=>{this.showScreen("login")})),(0,h.A)(this,"onForgotPasswordClick",(()=>{this.showScreen("forgot_password")})),(0,h.A)(this,"onRegisterFlowComplete",((e,t)=>this.onUserCompletedLoginFlow(e,t))),(0,h.A)(this,"onUpdateStatusIndicator",((e,t)=>{const n=e.numUnreadStates;l.A.get()&&(l.A.get().setErrorStatus(t===i.SyncState.Error),l.A.get().setNotificationCount(n)),this.subTitleStatus="",t===i.SyncState.Error&&(this.subTitleStatus+=`[${(0,P._t)("common|offline")}] `),n>0?this.subTitleStatus+=`[${n}]`:e.level>=pa.S.Activity&&(this.subTitleStatus+="*"),this.setPageSubtitle()})),(0,h.A)(this,"onServerConfigChange",(e=>{this.setState({serverConfig:e})})),(0,h.A)(this,"onUserCompletedLoginFlow",(async(e,t)=>{this.stores.accountPasswordStore.setPassword(t),await d.QC(e),await this.postLoginSetup(),cT.A.instance.stop(cT.l.LOGIN),cT.A.instance.stop(cT.l.REGISTER)})),(0,h.A)(this,"onCompleteSecurityE2eSetupFinished",(()=>{E.J.currentUserIsJustRegistered()&&null===V.A.getValue("FTUE.useCaseSelection")?(this.setStateForNewView({view:_T.A.USE_CASE_SELECTION}),V.A.watchSetting("FTUE.useCaseSelection",null,((e,t,n,i,r)=>{null!==r&&this.state.view===_T.A.USE_CASE_SELECTION&&this.onShowPostLoginScreen()}))):this.onShowPostLoginScreen().catch((e=>{o.v.error("Exception showing post-login screen",e)}))})),this.stores=Wa.M.instance,this.stores.constructEagerStores(),this.state={view:_T.A.LOADING,collapseLhs:!1,currentRoomId:null,currentUserId:null,hideToSRUsers:!1,isMobileRegistration:!1,syncError:null,resizeNotifier:new X,ready:!1},u.Ay.put(this.props.config),this.firstSyncComplete=!1,this.firstSyncPromise=(0,g.v6)(),this.props.config.sync_timeline_limit&&(E.J.opts.initialSyncLimit=this.props.config.sync_timeline_limit),this.screenAfterLogin=this.props.initialScreenAfterLogin,this.screenAfterLogin){const e=this.screenAfterLogin.params||{};if(this.screenAfterLogin.screen.startsWith("room/")&&e.signurl&&e.email){const t=this.screenAfterLogin.screen.substring(5);rS.A.instance.storeInvite(t,e)}}this.prevWindowWidth=Ie.A.instance.windowWidth||1e3,this.subTitleStatus=""}async initSession(){var e,t,n;if(!await RP((()=>this.onSessionLockStolen())))return;if(d.b())return void d.L6();const i=await d.AK(this.props.realQueryParams,this.props.defaultDeviceDisplayName,this.getFragmentAfterLogin());if((null!==(e=this.props.realQueryParams)&&void 0!==e&&e.loginToken||null!==(t=this.props.realQueryParams)&&void 0!==t&&t.code||null!==(n=this.props.realQueryParams)&&void 0!==n&&n.state)&&this.props.onTokenLoginCompleted(),i)return this.tokenLogin=!0,await d.S4({ignoreGuest:!0}),void await this.postLoginSetup();const r=this.screenAfterLogin?this.screenAfterLogin.screen:null;await this.loadSession()||null!==r&&UP.includes(r)&&this.showScreenAfterLogin()}async onSessionLockStolen(){await new Promise((e=>{this.setState({view:_T.A.LOCK_STOLEN},e)})),await d.MV()}async postLoginSetup(){const e=E.J.safeGet(),t=Boolean(e.getCrypto());t||this.onLoggedIn();const n=[this.firstSyncPromise.promise];let i=!1;if(t&&n.push((async t=>{i=Boolean(await(null===(t=e.getCrypto())||void 0===t?void 0:t.userHasCrossSigningKeys()))})()),this.setState({pendingInitialSync:!0}),await Promise.all(n),t){if(i){0==ev.r.instance.extensions.cryptoSetup.SHOW_ENCRYPTION_SETUP_UI?this.onLoggedIn():this.setStateForNewView({view:_T.A.COMPLETE_SECURITY})}else await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing")&&!await(async e=>{const t=(0,SP.I)(e),n=e.getCrypto();return!n||t&&!await(0,Vg.qM)(e.getRooms(),(({roomId:e})=>n.isEncryptionEnabledInRoom(e)))})(e)?this.setStateForNewView({view:_T.A.E2E_SETUP}):this.onLoggedIn();this.setState({pendingInitialSync:!1})}else this.setState({pendingInitialSync:!1})}setState(e,t){this.shouldTrackPageChange(this.state,FP(FP({},this.state),e))&&this.startPageChangeTimer(),super.setState(e,t)}componentDidMount(){Ie.A.instance.on(Ie.x.Resize,this.handleResize),this.state.resizeNotifier.on("middlePanelResized",this.dispatchTimelineResize),Ea.n.instance.on(Ea.N,this.onUpdateStatusIndicator),this.dispatcherRef=w.A.register(this.onAction),this.themeWatcher=new Q.A,this.fontWatcher=new ee.g,this.themeWatcher.start(),this.fontWatcher.start(),(0,fT.ig)(u.Ay.get("sentry")),!function(){const e=o.v.getChild("checkSessionLockFree"),t=window.localStorage.getItem(AP);if(null===t)return e.info("No other session has the lock"),!0;const n=window.localStorage.getItem(CP),i=Date.now()-parseInt(t);return kP-i<=0?(e.info(`Last ping (from ${n}) was ${i}ms ago: lock is free`),!0):(e.info(`Last ping (from ${n}) was ${i}ms ago: lock is taken`),!1)}()?setTimeout((()=>this.setState({view:_T.A.CONFIRM_LOCK_THEFT})),0):this.startInitSession(),window.addEventListener("resize",this.onWindowResized)}componentDidUpdate(e,t){if(this.shouldTrackPageChange(t,this.state)){const e=this.stopPageChangeTimer();null!=e&&y.A.instance.trackPageChange(this.state.view,this.state.page_type,e)}"composer"===this.focusNext?(w.A.fire(R.r.FocusSendMessageComposer),this.focusNext=void 0):"threadsPanel"===this.focusNext&&w.A.fire(R.r.FocusThreadsPanel)}componentWillUnmount(){var e,t;d.NN(),w.A.unregister(this.dispatcherRef),null===(e=this.themeWatcher)||void 0===e||e.stop(),null===(t=this.fontWatcher)||void 0===t||t.stop(),Ie.A.destroy(),this.state.resizeNotifier.removeListener("middlePanelResized",this.dispatchTimelineResize),window.removeEventListener("resize",this.onWindowResized),this.stores.accountPasswordStore.clearPassword()}getFallbackHsUrl(){var e;if(null!==(e=this.getServerProperties().serverConfig)&&void 0!==e&&e.isDefault)return this.props.config.fallback_hs_url}getServerProperties(){return{serverConfig:this.state.serverConfig||u.Ay.get("validated_server_config")}}loadSession(){return Promise.resolve().then((()=>d.L6({fragmentQueryParams:this.props.startingFragmentQueryParams,enableGuest:this.props.enableGuest,guestHsUrl:this.getServerProperties().serverConfig.hsUrl,guestIsUrl:this.getServerProperties().serverConfig.isUrl,defaultDeviceDisplayName:this.props.defaultDeviceDisplayName}))).then((e=>(e||(rS.A.instance.pickBestInvite()&&V.A.getValue($.f.Registration)?w.A.dispatch({action:"start_registration"}):w.A.dispatch({action:"view_welcome_page"})),e)))}startPageChangeTimer(){cT.A.instance.start(cT.l.PAGE_CHANGE)}stopPageChangeTimer(){const e=cT.A.instance;e.stop(cT.l.PAGE_CHANGE);const t=e.getEntries({name:cT.l.PAGE_CHANGE}).pop();return t?t.duration:null}shouldTrackPageChange(e,t){return e.currentRoomId!==t.currentRoomId||e.view!==t.view||e.page_type!==t.page_type}setStateForNewView(e){if(void 0===e.view)throw new Error("setStateForNewView with no view!");this.setState(FP({currentUserId:void 0,justRegistered:!1},e))}setPage(e){this.setState({page_type:e})}async startRegistration(e,t){var n;if(!V.A.getValue($.f.Registration)||t&&!V.A.getValue("Registration.mobileRegistrationHelper"))return void this.showScreen("welcome");const i={view:_T.A.REGISTER};if(t&&e.hs_url)try{const t=await c.A.validateServerConfigWithStaticUrls(e.hs_url);i.serverConfig=t}catch{o.v.warn("Failed to load hs_url param:",e.hs_url)}else if(e.client_secret&&e.session_id&&e.hs_url&&e.is_url&&e.sid){i.serverConfig=await c.A.validateServerConfigWithStaticUrls(e.hs_url,e.is_url);const t=u.Ay.get("validated_server_config");t&&t.hsUrl===i.serverConfig.hsUrl&&(i.serverConfig.hsName=t.hsName,i.serverConfig.hsNameIsDifferent=t.hsNameIsDifferent,i.serverConfig.isDefault=t.isDefault,i.serverConfig.isNameResolvable=t.isNameResolvable),i.register_client_secret=e.client_secret,i.register_session_id=e.session_id,i.register_id_sid=e.sid}i.isMobileRegistration=t,this.setStateForNewView(i),J.A.isLogin=!0,null===(n=this.themeWatcher)||void 0===n||n.recheck(),this.notifyNewScreen(t?"mobile_register":"register")}async viewRoom(e){var t,n;if(this.focusNext=null!==(t=e.focusNext)&&void 0!==t?t:"composer",e.room_alias?o.v.log(`Switching to room alias ${e.room_alias} at event ${e.event_id}`):o.v.log(`Switching to room id ${e.room_id} at event ${e.event_id}`),!this.firstSyncComplete){if(!this.firstSyncPromise)return void o.v.warn("Cannot view a room before first sync. room_id:",e.room_id);await this.firstSyncPromise.promise}let i=e.room_alias||e.room_id;const r=E.J.safeGet().getRoom(e.room_id);if(r){var s;r.decryptAllEvents();const e=x.zQ(r);e&&(i=e,(0,te.i)(e,r.roomId)),null===(s=localStorage)||void 0===s||s.setItem("mx_last_room_id",r.roomId)}let a="#"===i[0]&&e.room_id===this.state.currentRoomId;var l,c,d,u;((0,$f.F)(this.state.currentRoomId)&&(a=!0),e.room_id===this.state.currentRoomId)&&(e.threepid_invite=null!==(l=e.threepid_invite)&&void 0!==l?l:this.state.threepidInvite,e.oob_data=null!==(c=e.oob_data)&&void 0!==c?c:this.state.roomOobData,e.forceTimeline=null!==(d=e.forceTimeline)&&void 0!==d?d:this.state.forceTimeline,e.justCreatedOpts=null!==(u=e.justCreatedOpts)&&void 0!==u?u:this.state.roomJustCreatedOpts);e.event_id&&e.highlighted&&(i+="/"+e.event_id),this.setState({view:_T.A.LOGGED_IN,currentRoomId:null!==(n=e.room_id)&&void 0!==n?n:null,page_type:G.A.RoomView,threepidInvite:e.threepid_invite,roomOobData:e.oob_data,forceTimeline:e.forceTimeline,ready:!0,roomJustCreatedOpts:e.justCreatedOpts},(()=>{var e;J.A.isLogin=!1,null===(e=this.themeWatcher)||void 0===e||e.recheck(),this.notifyNewScreen("room/"+i,a)}))}viewSomethingBehindModal(){this.state.view===_T.A.LOGGED_IN?this.state.currentRoomId||this.state.currentUserId||this.viewHome():this.viewWelcome()}viewWelcome(){var e;if(function(e){const t=new m.Q(e).get("embedded_pages");return!!t&&!0===new m.Q(t).get("login_for_welcome")}(u.Ay.get()))return this.viewLogin();this.setStateForNewView({view:_T.A.WELCOME}),this.notifyNewScreen("welcome"),J.A.isLogin=!0,null===(e=this.themeWatcher)||void 0===e||e.recheck()}viewLogin(e){var t;this.setStateForNewView(FP({view:_T.A.LOGIN},e)),this.notifyNewScreen("login"),J.A.isLogin=!0,null===(t=this.themeWatcher)||void 0===t||t.recheck()}viewEmailPrecheckSSO(){var e;this.setStateForNewView({view:_T.A.EMAIL_PRECHECK_SSO}),this.notifyNewScreen("email-precheck-sso"),J.A.isLogin=!0,null===(e=this.themeWatcher)||void 0===e||e.recheck()}viewHome(e=!1){var t;this.setStateForNewView({view:_T.A.LOGGED_IN,justRegistered:e,currentRoomId:null}),this.setPage(G.A.HomePage),this.notifyNewScreen("home"),J.A.isLogin=!1,null===(t=this.themeWatcher)||void 0===t||t.recheck()}viewUser(e,t){(this.firstSyncPromise?this.firstSyncPromise.promise:Promise.resolve()).then((()=>{"chat"!==t?(this.notifyNewScreen("user/"+e),this.setState({currentUserId:e}),this.setPage(G.A.UserView)):this.chatCreateOrReuse(e)}))}async createRoom(e=!1,t,n){const i=A.Ay.createDialog(nI.A,{type:n,defaultPublic:e,defaultName:t}),[r,s]=await i.finished;r&&(0,K.Ay)(E.J.safeGet(),s)}chatCreateOrReuse(e){if(E.J.safeGet().isGuest())return void w.A.dispatch({action:R.r.DoAfterSyncPrepared,deferred_action:{action:R.r.ViewStartChatOrReuse,user_id:e}});const t=E.J.safeGet(),n=(0,wP.D)(t,e);n?w.A.dispatch({action:R.r.ViewRoom,room_id:n.roomId,metricsTrigger:"MessageUser"}):w.A.dispatch({action:"start_chat",user_id:e})}leaveRoomWarnings(e){const t=E.J.safeGet().getRoom(e),n=null==t?void 0:t.isSpaceRoom(),r=[];if(1===(null==t?void 0:t.currentState.getJoinedMemberCount()))return r.push(s.createElement("strong",{className:"warning",key:"only_member_warning"}," ",(0,P._t)("leave_room_dialog|last_person_warning"))),r;const o=null==t?void 0:t.currentState.getStateEvents("m.room.join_rules","");if(o){"public"!==o.getContent().join_rule&&r.push(s.createElement("strong",{className:"warning",key:"non_public_warning"}," ",n?(0,P._t)("leave_room_dialog|space_rejoin_warning"):(0,P._t)("leave_room_dialog|room_rejoin_warning")))}const a=E.J.get();if(a&&t){const e=t.currentState.getStateEvents(i.EventType.RoomPowerLevels,""),n=(e?e.getContent():{}).users||{},o=n[a.getUserId()],l=Object.values(n);if(l.every((e=>"number"==typeof e))){const e=Math.max(...l);if(e===o&&l.lastIndexOf(e)==l.indexOf(e)){const t=e>=100?(0,P._t)("leave_room_dialog|room_leave_admin_warning"):(0,P._t)("leave_room_dialog|room_leave_mod_warning");r.push(s.createElement("strong",{className:"warning",key:"last_admin_warning"}," ",t))}}}return r}leaveRoom(e){var t,n;const i=E.J.safeGet(),r=i.getRoom(e),o=this.leaveRoomWarnings(e),a=null==r?void 0:r.isSpaceRoom();A.Ay.createDialog(q.A,{title:a?(0,P._t)("space|leave_dialog_action"):(0,P._t)("action|leave_room"),description:s.createElement("span",null,a?(0,P._t)("leave_room_dialog|leave_space_question",{spaceName:null!==(t=null==r?void 0:r.name)&&void 0!==t?t:(0,P._t)("common|unnamed_space")}):(0,P._t)("leave_room_dialog|leave_room_question",{roomName:null!==(n=null==r?void 0:r.name)&&void 0!==n?n:(0,P._t)("common|unnamed_room")}),o),button:(0,P._t)("action|leave"),danger:o.length>0,onFinished:async t=>{t&&(await(0,je.U)(i,e),w.A.dispatch({action:R.r.AfterLeaveRoom,room_id:e}))}})}forgetRoom(e){const t=E.J.safeGet().getRoom(e);E.J.safeGet().forget(e).then((()=>{this.state.currentRoomId===e&&w.A.dispatch({action:R.r.ViewHomePage}),t&&oc.Ay.instance.manualRoomUpdate(t,ve.w4.RoomRemoved)})).catch((e=>{var t;const n=e.errcode||(0,P.AO)("error|unknown_error_code");A.Ay.createDialog(_v.A,{title:(0,P._t)("error_dialog|forget_room_failed",{errCode:n}),description:null!==(t=null==e?void 0:e.message)&&void 0!==t?t:(0,P._t)("invite|failed_generic")})}))}async copyRoom(e){const t=(0,uu.B4)(E.J.safeGet(),e);await(0,s_.nC)(t)||A.Ay.createDialog(_v.A,{title:(0,P._t)("error_dialog|copy_room_link_failed|title"),description:(0,P._t)("error_dialog|copy_room_link_failed|description")})}async shouldForceVerification(){if(!u.Ay.get("force_verification"))return!1;if(!localStorage.getItem("must_verify_device"))return!1;const e=E.J.safeGet();if(e.isGuest())return!1;const t=e.getCrypto();return!await(null==t?void 0:t.isCrossSigningReady())}async onLoggedIn(){var e;J.A.isLogin=!1,null===(e=this.themeWatcher)||void 0===e||e.recheck(),ne.ng(),await this.onShowPostLoginScreen()}async onShowPostLoginScreen(e){var t;if(e&&(hu.Vo.instance.setProperty("ftueUseCaseSelection",e),V.A.setValue("FTUE.useCaseSelection",null,ae.p.ACCOUNT,e)),this.setStateForNewView({view:_T.A.LOGGED_IN}),null!==(t=this.screenAfterLogin)&&void 0!==t&&t.screen)this.showScreen(this.screenAfterLogin.screen,this.screenAfterLogin.params),this.screenAfterLogin=void 0;else if(E.J.currentUserIsJustRegistered())if(E.J.setJustRegisteredUserId(null),rS.A.instance.pickBestInvite()){const e=rS.A.instance.pickBestInvite(),t=rS.A.instance.translateToWireFormat(e);this.showScreen(`room/${e.roomId}`,t)}else w.A.dispatch({action:R.r.ViewHomePage,justRegistered:!0});else this.showScreenAfterLogin();u.Ay.get("mobile_guide_toast")&&(()=>{const e=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,t=/Android/.test(navigator.userAgent),n=u.Ay.get().brand;(e||t)&&(document.cookie.includes("element_mobile_redirect_to_guide=false")||T.A.sharedInstance().addOrReplaceToast({key:cS,title:(0,P._t)("mobile_guide|toast_title"),props:{description:(0,P._t)("mobile_guide|toast_description",{brand:n}),primaryLabel:(0,P._t)("mobile_guide|toast_accept"),onPrimaryClick:aS,secondaryLabel:(0,P._t)("action|dismiss"),onSecondaryClick:lS},component:N.A,priority:99}))})();const n=u.Ay.get("user_notice");if(n){const e="user_notice_"+n.title;n.show_once&&localStorage.getItem(e)||T.A.sharedInstance().addOrReplaceToast({key:e,title:n.title,props:{description:s.createElement(qh.XZ,null,n.description),primaryLabel:(0,P._t)("action|ok"),onPrimaryClick:()=>{T.A.sharedInstance().dismissToast(e),localStorage.setItem(e,"1")}},component:N.A,className:"mx_AnalyticsToast",priority:100})}}initPosthogAnalyticsToast(){null===V.A.getValue("pseudonymousAnalyticsOptIn")&&nS(),V.A.watchSetting("pseudonymousAnalyticsOptIn",null,((e,t,n,i,r)=>{null===r?nS():iS()}))}showScreenAfterLogin(){this.screenAfterLogin&&this.screenAfterLogin.screen?(this.showScreen(this.screenAfterLogin.screen,this.screenAfterLogin.params),this.screenAfterLogin=void 0):localStorage&&localStorage.getItem("mx_last_room_id")?this.viewLastRoom():E.J.safeGet().isGuest()?w.A.dispatch({action:"view_welcome_page"}):w.A.dispatch({action:R.r.ViewHomePage})}viewLastRoom(){var e;w.A.dispatch({action:R.r.ViewRoom,room_id:null!==(e=localStorage.getItem("mx_last_room_id"))&&void 0!==e?e:void 0,metricsTrigger:void 0})}onLoggedOut(){this.viewLogin({ready:!1,collapseLhs:!1,currentRoomId:null}),this.subTitleStatus="",this.setPageSubtitle(),this.stores.onLoggedOut()}onSoftLogout(){this.notifyNewScreen("soft_logout"),this.setStateForNewView({view:_T.A.SOFT_LOGOUT,ready:!1,collapseLhs:!1,currentRoomId:null}),this.subTitleStatus="",this.setPageSubtitle()}onWillStartClient(){this.firstSyncComplete=!1,this.firstSyncPromise=(0,g.v6)();const e=E.J.safeGet();e.setCanResetTimelineCallback((e=>(o.v.log("Request to reset timeline in room ",e," viewing:",this.state.currentRoomId),e!==this.state.currentRoomId||(!this.loggedInView.current||this.loggedInView.current.canResetTimelineInRoom(e))))),e.on(i.ClientEvent.Sync,((e,t,n)=>{var r;e===i.SyncState.Error||e===i.SyncState.Reconnecting?this.setState({syncError:null!==(r=null==n?void 0:n.error)&&void 0!==r?r:null}):this.state.syncError&&this.setState({syncError:null});e!==i.SyncState.Syncing||t!==i.SyncState.Syncing?(o.v.debug(`MatrixClient sync state => ${e}`),e===i.SyncState.Prepared&&(this.firstSyncComplete=!0,this.firstSyncPromise.resolve(),S.default.shouldShowPrompt()&&!E.J.userRegisteredWithinLastHours(24)&&(0,Vb.P)(!1),w.A.fire(R.r.FocusSendMessageComposer))):MP()})),e.on(i.HttpApiEvent.SessionLoggedOut,(function(e){if(!d.kQ()){if(A.Ay.forceCloseAllModals(),401===e.httpStatus&&e.data&&e.data.soft_logout)return o.v.warn("Soft logout issued by server - avoiding data deletion"),void d.hF();A.Ay.createDialog(_v.A,{title:(0,P._t)("auth|session_logged_out_title"),description:(0,P._t)("auth|session_logged_out_description")}),w.A.dispatch({action:"logout"})}})),e.on(i.HttpApiEvent.NoConsent,(function(t,n){A.Ay.createDialog(q.A,{title:(0,P._t)("terms|tac_title"),description:s.createElement("div",null,s.createElement("p",null," ",(0,P._t)("terms|tac_description",{homeserverDomain:e.getDomain()}))),button:(0,P._t)("terms|tac_button"),cancelButton:(0,P._t)("action|dismiss"),onFinished:e=>{if(e){window.open(n,"_blank").opener=null}}},void 0,!0)})),b.o.instance.start(e).catch((e=>o.v.error("Unable to start DecryptionFailureTracker",e))),e.on(i.ClientEvent.Room,(t=>{if(e.getCrypto()){const e=V.A.getValueAt(ae.p.ROOM_DEVICE,"blacklistUnverifiedDevices",t.roomId,!0);t.setBlacklistUnverifiedDevices(e)}})),e.on(f.CryptoEvent.KeyBackupFailed,(async t=>{var i;let r,a=null;if(Boolean(e.getCrypto()&&null!==await(null===(i=e.getCrypto())||void 0===i?void 0:i.getActiveSessionBackupVersion())))r=!0;else try{var l,c;a=null!==(l=await(null===(c=e.getCrypto())||void 0===c?void 0:c.getKeyBackupInfo()))&&void 0!==l?l:null,null!==a&&(r=!0)}catch(e){return void o.v.error("Saw key backup error but failed to check backup version!",e)}r?A.Ay.createDialog((0,s.lazy)((()=>n.e(6464).then(n.bind(n,"./src/async-components/views/dialogs/security/NewRecoveryMethodDialog.tsx"))))):A.Ay.createDialog((0,s.lazy)((()=>n.e(6762).then(n.bind(n,"./src/async-components/views/dialogs/security/RecoveryMethodRemovedDialog.tsx")))))})),e.on(f.CryptoEvent.VerificationRequestReceived,(e=>{e.verifier?A.Ay.createDialog(oI,{verifier:e.verifier},void 0,!1,!0):e.pending&&T.A.sharedInstance().addOrReplaceToast({key:"verifreq_"+e.transactionId,title:(0,P._t)("encryption|verification_requested_toast_title"),icon:"verification",props:{request:e},component:lT,priority:90})}))}async onClientStarted(){const e=E.J.safeGet(),t=await this.shouldForceVerification();[_T.A.COMPLETE_SECURITY,_T.A.E2E_SETUP].includes(this.state.view)||t&&this.setStateForNewView({view:_T.A.COMPLETE_SECURITY});const n=e.getCrypto();if(n){const t=V.A.getValueAt(ae.p.DEVICE,"blacklistUnverifiedDevices");n.globalBlacklistUnverifiedDevices=t,e.setGlobalErrorOnUnknownDevices(!1)}hu.Vo.instance.isEnabled()&&V.A.isLevelSupported(ae.p.ACCOUNT)&&this.initPosthogAnalyticsToast(),this.setState({ready:!0})}showScreen(e,t){const n=E.J.get();if(!n||n.isGuest()||!UP.includes(e))if(e===zl.A.secureBackupFragment){const e={action:R.r.ViewUserSettings,initialTabId:wa.v.Security};w.A.dispatch(e)}else if("register"===e)w.A.dispatch({action:"start_registration",params:t}),cT.A.instance.start(cT.l.REGISTER);else if("mobile_register"===e)w.A.dispatch({action:"start_mobile_registration",params:t});else if("login"===e)w.A.dispatch({action:"start_login",params:t}),cT.A.instance.start(cT.l.LOGIN);else if("forgot_password"===e)w.A.dispatch({action:"start_password_recovery",params:t});else if("soft_logout"===e)null!=n&&n.getUserId()&&!d.b()?this.viewLastRoom():w.A.dispatch({action:"start_login",params:t});else if("new"===e)w.A.dispatch({action:"view_create_room"});else if("dm"===e)w.A.dispatch({action:"view_create_chat"});else if("settings"===e)w.A.fire(R.r.ViewUserSettings);else if("welcome"===e)w.A.dispatch({action:"view_welcome_page"});else if("home"===e)w.A.dispatch({action:R.r.ViewHomePage});else if("directory"===e)w.A.fire(R.r.ViewRoomDirectory);else if("start_sso"===e||"start_cas"===e){var r;let t=E.J.get();if(!t){const{hsUrl:e,isUrl:n}=this.getServerProperties().serverConfig;t=(0,i.createClient)({baseUrl:e,idBaseUrl:n})}const n="start_sso"===e?"sso":"cas";null===(r=l.A.get())||void 0===r||r.startSingleSignOn(t,n,this.getFragmentAfterLogin())}else if(0===e.indexOf("room/")){var s,a,c;const n=e.substring(5),i=n.indexOf(":")+1;let r=n.length;n.substring(i).indexOf("/")>-1&&(r=i+n.substring(i).indexOf("/"));const o=n.substring(0,r);let l,d=n.substring(r+1);if(d||(d=void 0),null!=t&&t.signurl&&null!=t&&t.email&&(l=rS.A.instance.storeInvite(o,t)),!l){l=rS.A.instance.getInvites().find((e=>e.roomId===o))}let u=[];null!=t&&t.via&&(u="string"==typeof t.via?[t.via]:t.via);const m={action:R.r.ViewRoom,event_id:d,via_servers:u,highlighted:Boolean(d),threepid_invite:l,oob_data:{name:null===(s=l)||void 0===s?void 0:s.roomName,avatarUrl:null===(a=l)||void 0===a?void 0:a.roomAvatarUrl,inviterName:null===(c=l)||void 0===c?void 0:c.inviterName},room_alias:void 0,room_id:void 0,metricsTrigger:void 0};"#"===o[0]?m.room_alias=o:m.room_id=o,w.A.dispatch(m)}else if(0===e.indexOf("user/")){const n=e.substring(5);w.A.dispatch({action:"view_user_info",userId:n,subAction:null==t?void 0:t.action})}else"email-precheck-sso"===e?w.A.dispatch({action:"email_precheck_sso",params:t}):o.v.info(`Ignoring showScreen for '${e}'`);else w.A.dispatch({action:R.r.ViewHomePage})}notifyNewScreen(e,t=!1){this.props.onNewScreen&&this.props.onNewScreen(e,t),this.setPageSubtitle()}onLogoutClick(e){w.A.dispatch({action:"logout"}),e.stopPropagation(),e.preventDefault()}dispatchTimelineResize(){w.A.dispatch({action:"timeline_resize"})}onRegistered(e){return d.QC(e)}onSendEvent(e,t){const n=E.J.get();n&&n.sendEvent(e,t.getType(),t.getContent()).then((()=>{w.A.dispatch({action:"message_sent"})}))}setPageSubtitle(e=""){if(this.state.currentRoomId){const t=E.J.get(),n=null==t?void 0:t.getRoom(this.state.currentRoomId);n&&(e=`${this.subTitleStatus} | ${n.name} ${e}`)}else e=`${this.subTitleStatus} ${e}`;const t=`${u.Ay.get().brand} ${e}`;document.title!==t&&(document.title=t)}getFragmentAfterLogin(){let e="";const t=this.props.initialScreenAfterLogin;return t&&!["welcome","login","register","start_sso","start_cas","email-precheck-sso"].includes(t.screen)&&(e=`/${t.screen}`),e}render(){const e=this.getFragmentAfterLogin();let t;if(this.state.view===_T.A.LOADING)t=s.createElement("div",{className:"mx_MatrixChat_splash"},s.createElement(Na.A,null));else if(this.state.view===_T.A.CONFIRM_LOCK_THEFT)t=s.createElement(TP,{onConfirm:()=>{this.setState({view:_T.A.LOADING}),this.startInitSession()}});else if(this.state.view===_T.A.COMPLETE_SECURITY)t=s.createElement(pI,{onFinished:this.onCompleteSecurityE2eSetupFinished});else if(this.state.view===_T.A.E2E_SETUP)t=s.createElement(FI,{matrixClient:E.J.safeGet(),onFinished:this.onCompleteSecurityE2eSetupFinished,accountPassword:this.stores.accountPasswordStore.getPassword(),tokenLogin:!!this.tokenLogin});else if(this.state.view===_T.A.LOGGED_IN)t=this.state.ready&&this.state.page_type?s.createElement(Kw,(0,p.A)({},this.props,this.state,{ref:this.loggedInView,matrixClient:E.J.safeGet(),onRegistered:this.onRegistered,currentRoomId:this.state.currentRoomId})):s.createElement(PP,{matrixClient:E.J.safeGet(),onLogoutClick:this.onLogoutClick,syncError:this.state.syncError});else if(this.state.view===_T.A.WELCOME)t=s.createElement(fI,null);else if(this.state.view===_T.A.REGISTER&&V.A.getValue($.f.Registration)){var n;const i=null===(n=rS.A.instance.pickBestInvite())||void 0===n?void 0:n.toEmail;t=s.createElement(YI,(0,p.A)({clientSecret:this.state.register_client_secret,sessionId:this.state.register_session_id,idSid:this.state.register_id_sid,email:i,brand:this.props.config.brand,onLoggedIn:this.onRegisterFlowComplete,onLoginClick:this.onLoginClick,onServerConfigChange:this.onServerConfigChange,defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,fragmentAfterLogin:e,mobileRegister:this.state.isMobileRegistration},this.getServerProperties()))}else if(this.state.view===_T.A.FORGOT_PASSWORD&&V.A.getValue($.f.PasswordReset))t=s.createElement(MI,(0,p.A)({onComplete:this.onLoginClick,onLoginClick:this.onLoginClick},this.getServerProperties()));else if(this.state.view===_T.A.LOGIN){var i;const n=V.A.getValue($.f.PasswordReset);t=s.createElement(oT,(0,p.A)({isSyncing:this.state.pendingInitialSync,onLoggedIn:this.onUserCompletedLoginFlow,onRegisterClick:this.onRegisterClick,fallbackHsUrl:this.getFallbackHsUrl(),defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,onForgotPasswordClick:n?this.onForgotPasswordClick:void 0,onServerConfigChange:this.onServerConfigChange,fragmentAfterLogin:e,defaultUsername:null===(i=this.props.startingFragmentQueryParams)||void 0===i?void 0:i.defaultUsername},this.getServerProperties()))}else if(this.state.view===_T.A.SOFT_LOGOUT)t=s.createElement(vT,{realQueryParams:this.props.realQueryParams,onTokenLoginCompleted:this.props.onTokenLoginCompleted,fragmentAfterLogin:e});else if(this.state.view===_T.A.USE_CASE_SELECTION)t=s.createElement(wT,{onFinished:e=>this.onShowPostLoginScreen(e)});else if(this.state.view===_T.A.LOCK_STOLEN)t=s.createElement(IP,null);else{if(this.state.view!==_T.A.EMAIL_PRECHECK_SSO)return o.v.error(`Unknown view ${this.state.view}`),null;t=s.createElement(OP,null)}return s.createElement(eh.A,null,s.createElement(Wa.A.Provider,{value:this.stores},s.createElement(_.B,null,t)))}}(0,h.A)(VP,"displayName","MatrixChat"),(0,h.A)(VP,"defaultProps",{realQueryParams:{},startingFragmentQueryParams:{},config:{},onTokenLoginCompleted:()=>{}});var jP=n("./src/vector/url_utils.ts");let zP=null;function WP(e){const t=(0,jP._)(e);return{screen:t.location.substring(1),params:t.params}}function HP(){decodeURIComponent(window.location.hash)!==zP&&function(e){if(!window.matrixChat)return;o.v.log("Routing URL ",e.href);const t=WP(e);window.matrixChat.showScreen(t.screen,t.params)}(window.location)}function GP(e,t=!1){o.v.log("newscreen "+e);const n="#/"+e;zP=n,e.startsWith("room/")&&window.location.hash.includes("/$")===n.includes("/$")&&window.location.hash.startsWith(n)&&(t=!0),t?window.location.replace(n):window.location.assign(n)}const KP="mx_screen_after_login";function JP(e){const t=WP(e);(t.screen||t.params)&&function(e){null!=e&&e.screen&&sessionStorage.setItem(KP,JSON.stringify(e))}(t);const n=function(){const e=sessionStorage.getItem(KP);return e?JSON.parse(e):void 0}();return n}function qP(){const e=new URL(window.location.href);e.searchParams.delete("loginToken"),e.searchParams.delete("state"),e.searchParams.delete("code"),o.v.log(`Redirecting to ${e.href} to drop delegated authentication params from queryparams`),window.history.replaceState(null,"",e.href)}async function $P(e,t){var n;window.addEventListener("hashchange",HP);const r=l.A.get(),p=(0,jP.u)(window.location),h=window.location.protocol+"//"+window.location.host+window.location.pathname;o.v.log("Vector starting at "+h),null==r||r.startUpdater();const g=await async function(){let e;try{o.v.log("Verifying homeserver configuration");const t=u.Ay.get();let n=t.default_server_config;const r=t.default_server_name,s=t.default_hs_url,a=t.default_is_url,l=[n,r,s].filter((e=>!!e));if(s&&(n||r))throw new P.P7("error|invalid_configuration_mixed_server");if(l.length<1)throw new P.P7("error|invalid_configuration_no_server");let d;s&&(o.v.log("Config uses a default_hs_url - constructing a default_server_config using this information"),o.v.warn("DEPRECATED CONFIG OPTION: In the future, default_hs_url will not be accepted. Please use default_server_config instead."),n={"m.homeserver":{base_url:s}},a&&(n["m.identity_server"]={base_url:a})),!r&&n&&(o.v.log("Config uses a default_server_config - validating object"),d=await i.AutoDiscovery.fromDiscoveryConfig(n)),r&&(o.v.log("Config uses a default_server_name - doing .well-known lookup"),o.v.warn("DEPRECATED CONFIG OPTION: In the future, default_server_name will not be accepted. Please use default_server_config instead."),d=await i.AutoDiscovery.findClientConfig(r),null===d["m.homeserver"].base_url&&n&&(o.v.log("Finding base_url failed but a default_server_config was found - using it as a fallback"),d=await i.AutoDiscovery.fromDiscoveryConfig(n))),e=await c.A.buildValidatedConfigFromDiscovery(r,d,!0)}catch(t){const{hsUrl:n,isUrl:i,userId:r}=await d.yl();if(!n||!r)throw t;o.v.error(t),o.v.warn("A session was found - suppressing config error and using the session's homeserver"),o.v.log("Using pre-existing hsUrl and isUrl: ",{hsUrl:n,isUrl:i}),e=await c.A.validateServerConfigWithStaticUrls(n,i,!0)}return e.isDefault=!0,o.v.log("Using homeserver config:",e),o.v.log("Updating SdkConfig with validated discovery information"),u.Ay.add({validated_server_config:e}),u.Ay.get()}(),v=new m.Q(g),[f]=await d.hP(),_=!!f,y=!!p.loginToken,b=(0,u.Hy)(g);let E=!0===b.immediate;const w="#/welcome"===window.location.hash||"#"===window.location.hash||""===window.location.hash,S="#/login"===window.location.hash;if(!E&&b.on_welcome_page&&w&&(E=!0),!E&&b.on_login_page&&S&&(E=!0),!_&&!y&&E){o.v.log("Bypassing app load to redirect to SSO");const e=(0,i.createClient)({baseUrl:g.validated_server_config.hsUrl,idBaseUrl:g.validated_server_config.isUrl});return l.A.get().startSingleSignOn(e,"sso",`/${WP(window.location).screen}`),s.createElement(s.Fragment,null)}const A=null!==(n=v.get("default_device_display_name"))&&void 0!==n?n:null==r?void 0:r.getDefaultDeviceDisplayName(),C=JP(window.location),x={Wrapper:s.Fragment};return ev.r.instance.invoke(a.m.Wrapper,x),s.createElement(x.Wrapper,null,s.createElement(s.StrictMode,null,s.createElement(VP,{ref:t,onNewScreen:GP,config:g,realQueryParams:p,startingFragmentQueryParams:e,enableGuest:!g.disable_guests,onTokenLoginCompleted:qP,initialScreenAfterLogin:C,defaultDeviceDisplayName:A})))}window.React=s,o.v.log("Application is running in production mode"),window.matrixLogger=o.v},"./res/img/stickerpack-placeholder.png":e=>{e.exports="img/stickerpack-placeholder.877b5d0.png"},"./res/img/tchap/multi-device-messaging.png":e=>{e.exports="img/tchap/multi-device-messaging.2fdcff1.png"},"./res/img/user-onboarding/CommunityMessaging.png":e=>{e.exports="img/user-onboarding/CommunityMessaging.0e6a083.png"},"./res/img/user-onboarding/PersonalMessaging.png":e=>{e.exports="img/user-onboarding/PersonalMessaging.12f2bc3.png"},"./node_modules/@matrix-org/react-sdk-module-api/lib/lifecycles/WidgetLifecycle.js":(e,t)=>{"use strict";var n;t.Z=void 0,t.Z=n,function(e){e.CapabilitiesRequest="capabilities_request",e.PreLoadRequest="preload_request",e.IdentityRequest="identity_request"}(n||(t.Z=n={}))},"./node_modules/@matrix-org/react-sdk-module-api/lib/lifecycles/WrapperLifecycle.js":(e,t)=>{"use strict";var n;t.m=void 0,t.m=n,function(e){e.Wrapper="wrapper"}(n||(t.m=n={}))},"./node_modules/file-saver/dist/FileSaver.min.js":function(e,t,n){var i,r,s;r=[],void 0===(s="function"==typeof(i=function(){"use strict";function t(e,t){return void 0===t?t={autoBom:!1}:"object"!=typeof t&&(console.warn("Deprecated: Expected third argument to be a object"),t={autoBom:!t}),t.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob(["\ufeff",e],{type:e.type}):e}function i(e,t,n){var i=new XMLHttpRequest;i.open("GET",e),i.responseType="blob",i.onload=function(){l(i.response,t,n)},i.onerror=function(){console.error("could not download file")},i.send()}function r(e){var t=new XMLHttpRequest;t.open("HEAD",e,!1);try{t.send()}catch(e){}return 200<=t.status&&299>=t.status}function s(e){try{e.dispatchEvent(new MouseEvent("click"))}catch(n){var t=document.createEvent("MouseEvents");t.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),e.dispatchEvent(t)}}var o="object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof n.g&&n.g.global===n.g?n.g:void 0,a=o.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),l=o.saveAs||("object"!=typeof window||window!==o?function(){}:"download"in HTMLAnchorElement.prototype&&!a?function(e,t,n){var a=o.URL||o.webkitURL,l=document.createElement("a");t=t||e.name||"download",l.download=t,l.rel="noopener","string"==typeof e?(l.href=e,l.origin===location.origin?s(l):r(l.href)?i(e,t,n):s(l,l.target="_blank")):(l.href=a.createObjectURL(e),setTimeout((function(){a.revokeObjectURL(l.href)}),4e4),setTimeout((function(){s(l)}),0))}:"msSaveOrOpenBlob"in navigator?function(e,n,o){if(n=n||e.name||"download","string"!=typeof e)navigator.msSaveOrOpenBlob(t(e,o),n);else if(r(e))i(e,n,o);else{var a=document.createElement("a");a.href=e,a.target="_blank",setTimeout((function(){s(a)}))}}:function(e,t,n,r){if((r=r||open("","_blank"))&&(r.document.title=r.document.body.innerText="downloading..."),"string"==typeof e)return i(e,t,n);var s="application/octet-stream"===e.type,l=/constructor/i.test(o.HTMLElement)||o.safari,c=/CriOS\/[\d]+/.test(navigator.userAgent);if((c||s&&l||a)&&"undefined"!=typeof FileReader){var d=new FileReader;d.onloadend=function(){var e=d.result;e=c?e:e.replace(/^data:[^;]*;/,"data:attachment/file;"),r?r.location.href=e:location=e,r=null},d.readAsDataURL(e)}else{var u=o.URL||o.webkitURL,m=u.createObjectURL(e);r?r.location=m:location.href=m,r=null,setTimeout((function(){u.revokeObjectURL(m)}),4e4)}});o.saveAs=l.saveAs=l,e.exports=l})?i.apply(t,r):i)||(e.exports=s)},"./node_modules/hoist-non-react-statics/dist/hoist-non-react-statics.cjs.js":(e,t,n)=>{"use strict";var i=n("./node_modules/react-is/index.js"),r={childContextTypes:!0,contextType:!0,contextTypes:!0,defaultProps:!0,displayName:!0,getDefaultProps:!0,getDerivedStateFromError:!0,getDerivedStateFromProps:!0,mixins:!0,propTypes:!0,type:!0},s={name:!0,length:!0,prototype:!0,caller:!0,callee:!0,arguments:!0,arity:!0},o={$$typeof:!0,compare:!0,defaultProps:!0,displayName:!0,propTypes:!0,type:!0},a={};function l(e){return i.isMemo(e)?o:a[e.$$typeof]||r}a[i.ForwardRef]={$$typeof:!0,render:!0,defaultProps:!0,displayName:!0,propTypes:!0},a[i.Memo]=o;var c=Object.defineProperty,d=Object.getOwnPropertyNames,u=Object.getOwnPropertySymbols,m=Object.getOwnPropertyDescriptor,p=Object.getPrototypeOf,h=Object.prototype;e.exports=function e(t,n,i){if("string"!=typeof n){if(h){var r=p(n);r&&r!==h&&e(t,r,i)}var o=d(n);u&&(o=o.concat(u(n)));for(var a=l(t),g=l(n),v=0;v<o.length;++v){var f=o[v];if(!(s[f]||i&&i[f]||g&&g[f]||a&&a[f])){var _=m(n,f);try{c(t,f,_)}catch(e){}}}}return t}},"./node_modules/react-dom/cjs/react-dom-server-legacy.browser.production.min.js":(e,t,n)=>{"use strict";var i=n("./node_modules/react/index.js");function r(e){for(var t="https://reactjs.org/docs/error-decoder.html?invariant="+e,n=1;n<arguments.length;n++)t+="&args[]="+encodeURIComponent(arguments[n]);return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var s=Object.prototype.hasOwnProperty,o=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,a={},l={};function c(e){return!!s.call(l,e)||!s.call(a,e)&&(o.test(e)?l[e]=!0:(a[e]=!0,!1))}function d(e,t,n,i,r,s,o){this.acceptsBooleans=2===t||3===t||4===t,this.attributeName=i,this.attributeNamespace=r,this.mustUseProperty=n,this.propertyName=e,this.type=t,this.sanitizeURL=s,this.removeEmptyString=o}var u={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach((function(e){u[e]=new d(e,0,!1,e,null,!1,!1)})),[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach((function(e){var t=e[0];u[t]=new d(t,1,!1,e[1],null,!1,!1)})),["contentEditable","draggable","spellCheck","value"].forEach((function(e){u[e]=new d(e,2,!1,e.toLowerCase(),null,!1,!1)})),["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach((function(e){u[e]=new d(e,2,!1,e,null,!1,!1)})),"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach((function(e){u[e]=new d(e,3,!1,e.toLowerCase(),null,!1,!1)})),["checked","multiple","muted","selected"].forEach((function(e){u[e]=new d(e,3,!0,e,null,!1,!1)})),["capture","download"].forEach((function(e){u[e]=new d(e,4,!1,e,null,!1,!1)})),["cols","rows","size","span"].forEach((function(e){u[e]=new d(e,6,!1,e,null,!1,!1)})),["rowSpan","start"].forEach((function(e){u[e]=new d(e,5,!1,e.toLowerCase(),null,!1,!1)}));var m=/[\-:]([a-z])/g;function p(e){return e[1].toUpperCase()}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach((function(e){var t=e.replace(m,p);u[t]=new d(t,1,!1,e,null,!1,!1)})),"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach((function(e){var t=e.replace(m,p);u[t]=new d(t,1,!1,e,"http://www.w3.org/1999/xlink",!1,!1)})),["xml:base","xml:lang","xml:space"].forEach((function(e){var t=e.replace(m,p);u[t]=new d(t,1,!1,e,"http://www.w3.org/XML/1998/namespace",!1,!1)})),["tabIndex","crossOrigin"].forEach((function(e){u[e]=new d(e,1,!1,e.toLowerCase(),null,!1,!1)})),u.xlinkHref=new d("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1),["src","href","action","formAction"].forEach((function(e){u[e]=new d(e,1,!1,e.toLowerCase(),null,!0,!0)}));var h={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},g=["Webkit","ms","Moz","O"];Object.keys(h).forEach((function(e){g.forEach((function(t){t=t+e.charAt(0).toUpperCase()+e.substring(1),h[t]=h[e]}))}));var v=/["'&<>]/;function f(e){if("boolean"==typeof e||"number"==typeof e)return""+e;e=""+e;var t=v.exec(e);if(t){var n,i="",r=0;for(n=t.index;n<e.length;n++){switch(e.charCodeAt(n)){case 34:t="&quot;";break;case 38:t="&amp;";break;case 39:t="&#x27;";break;case 60:t="&lt;";break;case 62:t="&gt;";break;default:continue}r!==n&&(i+=e.substring(r,n)),r=n+1,i+=t}e=r!==n?i+e.substring(r,n):i}return e}var _=/([A-Z])/g,y=/^ms-/,b=Array.isArray;function E(e,t){return{insertionMode:e,selectedValue:t}}var w=new Map;function S(e,t,n){if("object"!=typeof n)throw Error(r(62));for(var i in t=!0,n)if(s.call(n,i)){var o=n[i];if(null!=o&&"boolean"!=typeof o&&""!==o){if(0===i.indexOf("--")){var a=f(i);o=f((""+o).trim())}else{a=i;var l=w.get(a);void 0!==l||(l=f(a.replace(_,"-$1").toLowerCase().replace(y,"-ms-")),w.set(a,l)),a=l,o="number"==typeof o?0===o||s.call(h,i)?""+o:o+"px":f((""+o).trim())}t?(t=!1,e.push(' style="',a,":",o)):e.push(";",a,":",o)}}t||e.push('"')}function A(e,t,n,i){switch(n){case"style":return void S(e,t,i);case"defaultValue":case"defaultChecked":case"innerHTML":case"suppressContentEditableWarning":case"suppressHydrationWarning":return}if(!(2<n.length)||"o"!==n[0]&&"O"!==n[0]||"n"!==n[1]&&"N"!==n[1])if(null!==(t=u.hasOwnProperty(n)?u[n]:null)){switch(typeof i){case"function":case"symbol":return;case"boolean":if(!t.acceptsBooleans)return}switch(n=t.attributeName,t.type){case 3:i&&e.push(" ",n,'=""');break;case 4:!0===i?e.push(" ",n,'=""'):!1!==i&&e.push(" ",n,'="',f(i),'"');break;case 5:isNaN(i)||e.push(" ",n,'="',f(i),'"');break;case 6:!isNaN(i)&&1<=i&&e.push(" ",n,'="',f(i),'"');break;default:t.sanitizeURL&&(i=""+i),e.push(" ",n,'="',f(i),'"')}}else if(c(n)){switch(typeof i){case"function":case"symbol":return;case"boolean":if("data-"!==(t=n.toLowerCase().slice(0,5))&&"aria-"!==t)return}e.push(" ",n,'="',f(i),'"')}}function C(e,t,n){if(null!=t){if(null!=n)throw Error(r(60));if("object"!=typeof t||!("__html"in t))throw Error(r(61));null!=(t=t.__html)&&e.push(""+t)}}function x(e,t,n,i){e.push(I(n));var r,o=n=null;for(r in t)if(s.call(t,r)){var a=t[r];if(null!=a)switch(r){case"children":n=a;break;case"dangerouslySetInnerHTML":o=a;break;default:A(e,i,r,a)}}return e.push(">"),C(e,o,n),"string"==typeof n?(e.push(f(n)),null):n}var k=/^[a-zA-Z][a-zA-Z:_\.\-\d]*$/,R=new Map;function I(e){var t=R.get(e);if(void 0===t){if(!k.test(e))throw Error(r(65,e));t="<"+e,R.set(e,t)}return t}function T(e,t,n,o,a){switch(t){case"select":e.push(I("select"));var l=null,d=null;for(h in n)if(s.call(n,h)){var u=n[h];if(null!=u)switch(h){case"children":l=u;break;case"dangerouslySetInnerHTML":d=u;break;case"defaultValue":case"value":break;default:A(e,o,h,u)}}return e.push(">"),C(e,d,l),l;case"option":d=a.selectedValue,e.push(I("option"));var m=u=null,p=null,h=null;for(l in n)if(s.call(n,l)){var g=n[l];if(null!=g)switch(l){case"children":u=g;break;case"selected":p=g;break;case"dangerouslySetInnerHTML":h=g;break;case"value":m=g;default:A(e,o,l,g)}}if(null!=d)if(n=null!==m?""+m:function(e){var t="";return i.Children.forEach(e,(function(e){null!=e&&(t+=e)})),t}(u),b(d)){for(o=0;o<d.length;o++)if(""+d[o]===n){e.push(' selected=""');break}}else""+d===n&&e.push(' selected=""');else p&&e.push(' selected=""');return e.push(">"),C(e,h,u),u;case"textarea":for(u in e.push(I("textarea")),h=d=l=null,n)if(s.call(n,u)&&null!=(m=n[u]))switch(u){case"children":h=m;break;case"value":l=m;break;case"defaultValue":d=m;break;case"dangerouslySetInnerHTML":throw Error(r(91));default:A(e,o,u,m)}if(null===l&&null!==d&&(l=d),e.push(">"),null!=h){if(null!=l)throw Error(r(92));if(b(h)&&1<h.length)throw Error(r(93));l=""+h}return"string"==typeof l&&"\n"===l[0]&&e.push("\n"),null!==l&&e.push(f(""+l)),null;case"input":for(d in e.push(I("input")),m=h=u=l=null,n)if(s.call(n,d)&&null!=(p=n[d]))switch(d){case"children":case"dangerouslySetInnerHTML":throw Error(r(399,"input"));case"defaultChecked":m=p;break;case"defaultValue":u=p;break;case"checked":h=p;break;case"value":l=p;break;default:A(e,o,d,p)}return null!==h?A(e,o,"checked",h):null!==m&&A(e,o,"checked",m),null!==l?A(e,o,"value",l):null!==u&&A(e,o,"value",u),e.push("/>"),null;case"menuitem":for(var v in e.push(I("menuitem")),n)if(s.call(n,v)&&null!=(l=n[v]))switch(v){case"children":case"dangerouslySetInnerHTML":throw Error(r(400));default:A(e,o,v,l)}return e.push(">"),null;case"title":for(g in e.push(I("title")),l=null,n)if(s.call(n,g)&&null!=(d=n[g]))switch(g){case"children":l=d;break;case"dangerouslySetInnerHTML":throw Error(r(434));default:A(e,o,g,d)}return e.push(">"),l;case"listing":case"pre":for(m in e.push(I(t)),d=l=null,n)if(s.call(n,m)&&null!=(u=n[m]))switch(m){case"children":l=u;break;case"dangerouslySetInnerHTML":d=u;break;default:A(e,o,m,u)}if(e.push(">"),null!=d){if(null!=l)throw Error(r(60));if("object"!=typeof d||!("__html"in d))throw Error(r(61));null!=(n=d.__html)&&("string"==typeof n&&0<n.length&&"\n"===n[0]?e.push("\n",n):e.push(""+n))}return"string"==typeof l&&"\n"===l[0]&&e.push("\n"),l;case"area":case"base":case"br":case"col":case"embed":case"hr":case"img":case"keygen":case"link":case"meta":case"param":case"source":case"track":case"wbr":for(var _ in e.push(I(t)),n)if(s.call(n,_)&&null!=(l=n[_]))switch(_){case"children":case"dangerouslySetInnerHTML":throw Error(r(399,t));default:A(e,o,_,l)}return e.push("/>"),null;case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return x(e,n,t,o);case"html":return 0===a.insertionMode&&e.push("<!DOCTYPE html>"),x(e,n,t,o);default:if(-1===t.indexOf("-")&&"string"!=typeof n.is)return x(e,n,t,o);for(p in e.push(I(t)),d=l=null,n)if(s.call(n,p)&&null!=(u=n[p]))switch(p){case"children":l=u;break;case"dangerouslySetInnerHTML":d=u;break;case"style":S(e,o,u);break;case"suppressContentEditableWarning":case"suppressHydrationWarning":break;default:c(p)&&"function"!=typeof u&&"symbol"!=typeof u&&e.push(" ",p,'="',f(u),'"')}return e.push(">"),C(e,d,l),l}}function P(e,t,n){if(e.push('\x3c!--$?--\x3e<template id="'),null===n)throw Error(r(395));return e.push(n),e.push('"></template>')}var N=/[<\u2028\u2029]/g;function D(e){return JSON.stringify(e).replace(N,(function(e){switch(e){case"<":return"\\u003c";case"\u2028":return"\\u2028";case"\u2029":return"\\u2029";default:throw Error("escapeJSStringsForInstructionScripts encountered a match it does not know how to replace. this means the match regex and the replacement characters are no longer in sync. This is a bug in React")}}))}function M(e,t,n,i){return n.generateStaticMarkup?(e.push(f(t)),!1):(""===t?e=i:(i&&e.push("\x3c!-- --\x3e"),e.push(f(t)),e=!0),e)}var O=Object.assign,L=Symbol.for("react.element"),F=Symbol.for("react.portal"),U=Symbol.for("react.fragment"),B=Symbol.for("react.strict_mode"),V=Symbol.for("react.profiler"),j=Symbol.for("react.provider"),z=Symbol.for("react.context"),W=Symbol.for("react.forward_ref"),H=Symbol.for("react.suspense"),G=Symbol.for("react.suspense_list"),K=Symbol.for("react.memo"),J=Symbol.for("react.lazy"),q=Symbol.for("react.scope"),$=Symbol.for("react.debug_trace_mode"),Y=Symbol.for("react.legacy_hidden"),Z=Symbol.for("react.default_value"),X=Symbol.iterator;function Q(e){if(null==e)return null;if("function"==typeof e)return e.displayName||e.name||null;if("string"==typeof e)return e;switch(e){case U:return"Fragment";case F:return"Portal";case V:return"Profiler";case B:return"StrictMode";case H:return"Suspense";case G:return"SuspenseList"}if("object"==typeof e)switch(e.$$typeof){case z:return(e.displayName||"Context")+".Consumer";case j:return(e._context.displayName||"Context")+".Provider";case W:var t=e.render;return(e=e.displayName)||(e=""!==(e=t.displayName||t.name||"")?"ForwardRef("+e+")":"ForwardRef"),e;case K:return null!==(t=e.displayName||null)?t:Q(e.type)||"Memo";case J:t=e._payload,e=e._init;try{return Q(e(t))}catch(e){}}return null}var ee={};function te(e,t){if(!(e=e.contextTypes))return ee;var n,i={};for(n in e)i[n]=t[n];return i}var ne=null;function ie(e,t){if(e!==t){e.context._currentValue2=e.parentValue,e=e.parent;var n=t.parent;if(null===e){if(null!==n)throw Error(r(401))}else{if(null===n)throw Error(r(401));ie(e,n)}t.context._currentValue2=t.value}}function re(e){e.context._currentValue2=e.parentValue,null!==(e=e.parent)&&re(e)}function se(e){var t=e.parent;null!==t&&se(t),e.context._currentValue2=e.value}function oe(e,t){if(e.context._currentValue2=e.parentValue,null===(e=e.parent))throw Error(r(402));e.depth===t.depth?ie(e,t):oe(e,t)}function ae(e,t){var n=t.parent;if(null===n)throw Error(r(402));e.depth===n.depth?ie(e,n):ae(e,n),t.context._currentValue2=t.value}function le(e){var t=ne;t!==e&&(null===t?se(e):null===e?re(t):t.depth===e.depth?ie(t,e):t.depth>e.depth?oe(t,e):ae(t,e),ne=e)}var ce={isMounted:function(){return!1},enqueueSetState:function(e,t){null!==(e=e._reactInternals).queue&&e.queue.push(t)},enqueueReplaceState:function(e,t){(e=e._reactInternals).replace=!0,e.queue=[t]},enqueueForceUpdate:function(){}};function de(e,t,n,i){var r=void 0!==e.state?e.state:null;e.updater=ce,e.props=n,e.state=r;var s={queue:[],replace:!1};e._reactInternals=s;var o=t.contextType;if(e.context="object"==typeof o&&null!==o?o._currentValue2:i,"function"==typeof(o=t.getDerivedStateFromProps)&&(r=null==(o=o(n,r))?r:O({},r,o),e.state=r),"function"!=typeof t.getDerivedStateFromProps&&"function"!=typeof e.getSnapshotBeforeUpdate&&("function"==typeof e.UNSAFE_componentWillMount||"function"==typeof e.componentWillMount))if(t=e.state,"function"==typeof e.componentWillMount&&e.componentWillMount(),"function"==typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),t!==e.state&&ce.enqueueReplaceState(e,e.state,null),null!==s.queue&&0<s.queue.length)if(t=s.queue,o=s.replace,s.queue=null,s.replace=!1,o&&1===t.length)e.state=t[0];else{for(s=o?t[0]:e.state,r=!0,o=o?1:0;o<t.length;o++){var a=t[o];null!=(a="function"==typeof a?a.call(e,s,n,i):a)&&(r?(r=!1,s=O({},s,a)):O(s,a))}e.state=s}else s.queue=null}var ue={id:1,overflow:""};function me(e,t,n){var i=e.id;e=e.overflow;var r=32-pe(i)-1;i&=~(1<<r),n+=1;var s=32-pe(t)+r;if(30<s){var o=r-r%5;return s=(i&(1<<o)-1).toString(32),i>>=o,r-=o,{id:1<<32-pe(t)+r|n<<r|i,overflow:s+e}}return{id:1<<s|n<<r|i,overflow:e}}var pe=Math.clz32?Math.clz32:function(e){return 0===(e>>>=0)?32:31-(he(e)/ge|0)|0},he=Math.log,ge=Math.LN2;var ve="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},fe=null,_e=null,ye=null,be=null,Ee=!1,we=!1,Se=0,Ae=null,Ce=0;function xe(){if(null===fe)throw Error(r(321));return fe}function ke(){if(0<Ce)throw Error(r(312));return{memoizedState:null,queue:null,next:null}}function Re(){return null===be?null===ye?(Ee=!1,ye=be=ke()):(Ee=!0,be=ye):null===be.next?(Ee=!1,be=be.next=ke()):(Ee=!0,be=be.next),be}function Ie(){_e=fe=null,we=!1,ye=null,Ce=0,be=Ae=null}function Te(e,t){return"function"==typeof t?t(e):t}function Pe(e,t,n){if(fe=xe(),be=Re(),Ee){var i=be.queue;if(t=i.dispatch,null!==Ae&&void 0!==(n=Ae.get(i))){Ae.delete(i),i=be.memoizedState;do{i=e(i,n.action),n=n.next}while(null!==n);return be.memoizedState=i,[i,t]}return[be.memoizedState,t]}return e=e===Te?"function"==typeof t?t():t:void 0!==n?n(t):t,be.memoizedState=e,e=(e=be.queue={last:null,dispatch:null}).dispatch=De.bind(null,fe,e),[be.memoizedState,e]}function Ne(e,t){if(fe=xe(),t=void 0===t?null:t,null!==(be=Re())){var n=be.memoizedState;if(null!==n&&null!==t){var i=n[1];e:if(null===i)i=!1;else{for(var r=0;r<i.length&&r<t.length;r++)if(!ve(t[r],i[r])){i=!1;break e}i=!0}if(i)return n[0]}}return e=e(),be.memoizedState=[e,t],e}function De(e,t,n){if(25<=Ce)throw Error(r(301));if(e===fe)if(we=!0,e={action:n,next:null},null===Ae&&(Ae=new Map),void 0===(n=Ae.get(t)))Ae.set(t,e);else{for(t=n;null!==t.next;)t=t.next;t.next=e}}function Me(){throw Error(r(394))}function Oe(){}var Le={readContext:function(e){return e._currentValue2},useContext:function(e){return xe(),e._currentValue2},useMemo:Ne,useReducer:Pe,useRef:function(e){fe=xe();var t=(be=Re()).memoizedState;return null===t?(e={current:e},be.memoizedState=e):t},useState:function(e){return Pe(Te,e)},useInsertionEffect:Oe,useLayoutEffect:function(){},useCallback:function(e,t){return Ne((function(){return e}),t)},useImperativeHandle:Oe,useEffect:Oe,useDebugValue:Oe,useDeferredValue:function(e){return xe(),e},useTransition:function(){return xe(),[!1,Me]},useId:function(){var e=_e.treeContext,t=e.overflow;e=((e=e.id)&~(1<<32-pe(e)-1)).toString(32)+t;var n=Fe;if(null===n)throw Error(r(404));return t=Se++,e=":"+n.idPrefix+"R"+e,0<t&&(e+="H"+t.toString(32)),e+":"},useMutableSource:function(e,t){return xe(),t(e._source)},useSyncExternalStore:function(e,t,n){if(void 0===n)throw Error(r(407));return n()}},Fe=null,Ue=i.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentDispatcher;function Be(e){return console.error(e),null}function Ve(){}function je(e,t,n,i,r,s,o,a){e.allPendingTasks++,null===n?e.pendingRootTasks++:n.pendingTasks++;var l={node:t,ping:function(){var t=e.pingedTasks;t.push(l),1===t.length&&nt(e)},blockedBoundary:n,blockedSegment:i,abortSet:r,legacyContext:s,context:o,treeContext:a};return r.add(l),l}function ze(e,t,n,i,r,s){return{status:0,id:-1,index:t,parentFlushed:!1,chunks:[],children:[],formatContext:i,boundary:n,lastPushedText:r,textEmbedded:s}}function We(e,t){if(null!=(e=e.onError(t))&&"string"!=typeof e)throw Error('onError returned something with a type other than "string". onError should return a string and may return null or undefined but must not return anything else. It received something of type "'+typeof e+'" instead');return e}function He(e,t){var n=e.onShellError;n(t),(n=e.onFatalError)(t),null!==e.destination?(e.status=2,e.destination.destroy(t)):(e.status=1,e.fatalError=t)}function Ge(e,t,n,i,r){for(fe={},_e=t,Se=0,e=n(i,r);we;)we=!1,Se=0,Ce+=1,be=null,e=n(i,r);return Ie(),e}function Ke(e,t,n,i){var s=n.render(),o=i.childContextTypes;if(null!=o){var a=t.legacyContext;if("function"!=typeof n.getChildContext)i=a;else{for(var l in n=n.getChildContext())if(!(l in o))throw Error(r(108,Q(i)||"Unknown",l));i=O({},a,n)}t.legacyContext=i,$e(e,t,s),t.legacyContext=a}else $e(e,t,s)}function Je(e,t){if(e&&e.defaultProps){for(var n in t=O({},t),e=e.defaultProps)void 0===t[n]&&(t[n]=e[n]);return t}return t}function qe(e,t,n,i,s){if("function"==typeof n)if(n.prototype&&n.prototype.isReactComponent){s=te(n,t.legacyContext);var o=n.contextType;de(o=new n(i,"object"==typeof o&&null!==o?o._currentValue2:s),n,i,s),Ke(e,t,o,n)}else{s=Ge(e,t,n,i,o=te(n,t.legacyContext));var a=0!==Se;if("object"==typeof s&&null!==s&&"function"==typeof s.render&&void 0===s.$$typeof)de(s,n,i,o),Ke(e,t,s,n);else if(a){i=t.treeContext,t.treeContext=me(i,1,0);try{$e(e,t,s)}finally{t.treeContext=i}}else $e(e,t,s)}else{if("string"!=typeof n){switch(n){case Y:case $:case B:case V:case U:case G:return void $e(e,t,i.children);case q:throw Error(r(343));case H:e:{n=t.blockedBoundary,s=t.blockedSegment,o=i.fallback,i=i.children;var l={id:null,rootSegmentID:-1,parentFlushed:!1,pendingTasks:0,forceClientRender:!1,completedSegments:[],byteSize:0,fallbackAbortableTasks:a=new Set,errorDigest:null},c=ze(0,s.chunks.length,l,s.formatContext,!1,!1);s.children.push(c),s.lastPushedText=!1;var d=ze(0,0,null,s.formatContext,!1,!1);d.parentFlushed=!0,t.blockedBoundary=l,t.blockedSegment=d;try{if(Ze(e,t,i),e.responseState.generateStaticMarkup||d.lastPushedText&&d.textEmbedded&&d.chunks.push("\x3c!-- --\x3e"),d.status=1,et(l,d),0===l.pendingTasks)break e}catch(t){d.status=4,l.forceClientRender=!0,l.errorDigest=We(e,t)}finally{t.blockedBoundary=n,t.blockedSegment=s}t=je(e,o,n,c,a,t.legacyContext,t.context,t.treeContext),e.pingedTasks.push(t)}return}if("object"==typeof n&&null!==n)switch(n.$$typeof){case W:if(i=Ge(e,t,n.render,i,s),0!==Se){n=t.treeContext,t.treeContext=me(n,1,0);try{$e(e,t,i)}finally{t.treeContext=n}}else $e(e,t,i);return;case K:return void qe(e,t,n=n.type,i=Je(n,i),s);case j:if(s=i.children,n=n._context,i=i.value,o=n._currentValue2,n._currentValue2=i,ne=i={parent:a=ne,depth:null===a?0:a.depth+1,context:n,parentValue:o,value:i},t.context=i,$e(e,t,s),null===(e=ne))throw Error(r(403));return i=e.parentValue,e.context._currentValue2=i===Z?e.context._defaultValue:i,e=ne=e.parent,void(t.context=e);case z:return void $e(e,t,i=(i=i.children)(n._currentValue2));case J:return void qe(e,t,n=(s=n._init)(n._payload),i=Je(n,i),void 0)}throw Error(r(130,null==n?n:typeof n,""))}switch(o=T((s=t.blockedSegment).chunks,n,i,e.responseState,s.formatContext),s.lastPushedText=!1,a=s.formatContext,s.formatContext=function(e,t,n){switch(t){case"select":return E(1,null!=n.value?n.value:n.defaultValue);case"svg":return E(2,null);case"math":return E(3,null);case"foreignObject":return E(1,null);case"table":return E(4,null);case"thead":case"tbody":case"tfoot":return E(5,null);case"colgroup":return E(7,null);case"tr":return E(6,null)}return 4<=e.insertionMode||0===e.insertionMode?E(1,null):e}(a,n,i),Ze(e,t,o),s.formatContext=a,n){case"area":case"base":case"br":case"col":case"embed":case"hr":case"img":case"input":case"keygen":case"link":case"meta":case"param":case"source":case"track":case"wbr":break;default:s.chunks.push("</",n,">")}s.lastPushedText=!1}}function $e(e,t,n){if(t.node=n,"object"==typeof n&&null!==n){switch(n.$$typeof){case L:return void qe(e,t,n.type,n.props,n.ref);case F:throw Error(r(257));case J:var i=n._init;return void $e(e,t,n=i(n._payload))}if(b(n))return void Ye(e,t,n);if(null===n||"object"!=typeof n?i=null:i="function"==typeof(i=X&&n[X]||n["@@iterator"])?i:null,i&&(i=i.call(n))){if(!(n=i.next()).done){var s=[];do{s.push(n.value),n=i.next()}while(!n.done);Ye(e,t,s)}return}throw e=Object.prototype.toString.call(n),Error(r(31,"[object Object]"===e?"object with keys {"+Object.keys(n).join(", ")+"}":e))}"string"==typeof n?(i=t.blockedSegment).lastPushedText=M(t.blockedSegment.chunks,n,e.responseState,i.lastPushedText):"number"==typeof n&&((i=t.blockedSegment).lastPushedText=M(t.blockedSegment.chunks,""+n,e.responseState,i.lastPushedText))}function Ye(e,t,n){for(var i=n.length,r=0;r<i;r++){var s=t.treeContext;t.treeContext=me(s,i,r);try{Ze(e,t,n[r])}finally{t.treeContext=s}}}function Ze(e,t,n){var i=t.blockedSegment.formatContext,r=t.legacyContext,s=t.context;try{return $e(e,t,n)}catch(l){if(Ie(),"object"!=typeof l||null===l||"function"!=typeof l.then)throw t.blockedSegment.formatContext=i,t.legacyContext=r,t.context=s,le(s),l;n=l;var o=t.blockedSegment,a=ze(0,o.chunks.length,null,o.formatContext,o.lastPushedText,!0);o.children.push(a),o.lastPushedText=!1,e=je(e,t.node,t.blockedBoundary,a,t.abortSet,t.legacyContext,t.context,t.treeContext).ping,n.then(e,e),t.blockedSegment.formatContext=i,t.legacyContext=r,t.context=s,le(s)}}function Xe(e){var t=e.blockedBoundary;(e=e.blockedSegment).status=3,tt(this,t,e)}function Qe(e,t,n){var i=e.blockedBoundary;e.blockedSegment.status=3,null===i?(t.allPendingTasks--,2!==t.status&&(t.status=2,null!==t.destination&&t.destination.push(null))):(i.pendingTasks--,i.forceClientRender||(i.forceClientRender=!0,e=void 0===n?Error(r(432)):n,i.errorDigest=t.onError(e),i.parentFlushed&&t.clientRenderedBoundaries.push(i)),i.fallbackAbortableTasks.forEach((function(e){return Qe(e,t,n)})),i.fallbackAbortableTasks.clear(),t.allPendingTasks--,0===t.allPendingTasks&&(i=t.onAllReady)())}function et(e,t){if(0===t.chunks.length&&1===t.children.length&&null===t.children[0].boundary){var n=t.children[0];n.id=t.id,n.parentFlushed=!0,1===n.status&&et(e,n)}else e.completedSegments.push(t)}function tt(e,t,n){if(null===t){if(n.parentFlushed){if(null!==e.completedRootSegment)throw Error(r(389));e.completedRootSegment=n}e.pendingRootTasks--,0===e.pendingRootTasks&&(e.onShellError=Ve,(t=e.onShellReady)())}else t.pendingTasks--,t.forceClientRender||(0===t.pendingTasks?(n.parentFlushed&&1===n.status&&et(t,n),t.parentFlushed&&e.completedBoundaries.push(t),t.fallbackAbortableTasks.forEach(Xe,e),t.fallbackAbortableTasks.clear()):n.parentFlushed&&1===n.status&&(et(t,n),1===t.completedSegments.length&&t.parentFlushed&&e.partialBoundaries.push(t)));e.allPendingTasks--,0===e.allPendingTasks&&(e=e.onAllReady)()}function nt(e){if(2!==e.status){var t=ne,n=Ue.current;Ue.current=Le;var i=Fe;Fe=e.responseState;try{var r,s=e.pingedTasks;for(r=0;r<s.length;r++){var o=s[r],a=e,l=o.blockedSegment;if(0===l.status){le(o.context);try{$e(a,o,o.node),a.responseState.generateStaticMarkup||l.lastPushedText&&l.textEmbedded&&l.chunks.push("\x3c!-- --\x3e"),o.abortSet.delete(o),l.status=1,tt(a,o.blockedBoundary,l)}catch(e){if(Ie(),"object"==typeof e&&null!==e&&"function"==typeof e.then){var c=o.ping;e.then(c,c)}else{o.abortSet.delete(o),l.status=4;var d=o.blockedBoundary,u=e,m=We(a,u);if(null===d?He(a,u):(d.pendingTasks--,d.forceClientRender||(d.forceClientRender=!0,d.errorDigest=m,d.parentFlushed&&a.clientRenderedBoundaries.push(d))),a.allPendingTasks--,0===a.allPendingTasks)(0,a.onAllReady)()}}}}s.splice(0,r),null!==e.destination&&lt(e,e.destination)}catch(t){We(e,t),He(e,t)}finally{Fe=i,Ue.current=n,n===Le&&le(t)}}}function it(e,t,n){switch(n.parentFlushed=!0,n.status){case 0:var i=n.id=e.nextSegmentId++;return n.lastPushedText=!1,n.textEmbedded=!1,e=e.responseState,t.push('<template id="'),t.push(e.placeholderPrefix),e=i.toString(16),t.push(e),t.push('"></template>');case 1:n.status=2;var s=!0;i=n.chunks;var o=0;n=n.children;for(var a=0;a<n.length;a++){for(s=n[a];o<s.index;o++)t.push(i[o]);s=rt(e,t,s)}for(;o<i.length-1;o++)t.push(i[o]);return o<i.length&&(s=t.push(i[o])),s;default:throw Error(r(390))}}function rt(e,t,n){var i=n.boundary;if(null===i)return it(e,t,n);if(i.parentFlushed=!0,i.forceClientRender)return e.responseState.generateStaticMarkup||(i=i.errorDigest,t.push("\x3c!--$!--\x3e"),t.push("<template"),i&&(t.push(' data-dgst="'),i=f(i),t.push(i),t.push('"')),t.push("></template>")),it(e,t,n),e=!!e.responseState.generateStaticMarkup||t.push("\x3c!--/$--\x3e");if(0<i.pendingTasks){i.rootSegmentID=e.nextSegmentId++,0<i.completedSegments.length&&e.partialBoundaries.push(i);var s=e.responseState,o=s.nextSuspenseID++;return s=s.boundaryPrefix+o.toString(16),i=i.id=s,P(t,e.responseState,i),it(e,t,n),t.push("\x3c!--/$--\x3e")}if(i.byteSize>e.progressiveChunkSize)return i.rootSegmentID=e.nextSegmentId++,e.completedBoundaries.push(i),P(t,e.responseState,i.id),it(e,t,n),t.push("\x3c!--/$--\x3e");if(e.responseState.generateStaticMarkup||t.push("\x3c!--$--\x3e"),1!==(n=i.completedSegments).length)throw Error(r(391));return rt(e,t,n[0]),e=!!e.responseState.generateStaticMarkup||t.push("\x3c!--/$--\x3e")}function st(e,t,n){return function(e,t,n,i){switch(n.insertionMode){case 0:case 1:return e.push('<div hidden id="'),e.push(t.segmentPrefix),t=i.toString(16),e.push(t),e.push('">');case 2:return e.push('<svg aria-hidden="true" style="display:none" id="'),e.push(t.segmentPrefix),t=i.toString(16),e.push(t),e.push('">');case 3:return e.push('<math aria-hidden="true" style="display:none" id="'),e.push(t.segmentPrefix),t=i.toString(16),e.push(t),e.push('">');case 4:return e.push('<table hidden id="'),e.push(t.segmentPrefix),t=i.toString(16),e.push(t),e.push('">');case 5:return e.push('<table hidden><tbody id="'),e.push(t.segmentPrefix),t=i.toString(16),e.push(t),e.push('">');case 6:return e.push('<table hidden><tr id="'),e.push(t.segmentPrefix),t=i.toString(16),e.push(t),e.push('">');case 7:return e.push('<table hidden><colgroup id="'),e.push(t.segmentPrefix),t=i.toString(16),e.push(t),e.push('">');default:throw Error(r(397))}}(t,e.responseState,n.formatContext,n.id),rt(e,t,n),function(e,t){switch(t.insertionMode){case 0:case 1:return e.push("</div>");case 2:return e.push("</svg>");case 3:return e.push("</math>");case 4:return e.push("</table>");case 5:return e.push("</tbody></table>");case 6:return e.push("</tr></table>");case 7:return e.push("</colgroup></table>");default:throw Error(r(397))}}(t,n.formatContext)}function ot(e,t,n){for(var i=n.completedSegments,s=0;s<i.length;s++)at(e,t,n,i[s]);if(i.length=0,e=e.responseState,i=n.id,n=n.rootSegmentID,t.push(e.startInlineScript),e.sentCompleteBoundaryFunction?t.push('$RC("'):(e.sentCompleteBoundaryFunction=!0,t.push('function $RC(a,b){a=document.getElementById(a);b=document.getElementById(b);b.parentNode.removeChild(b);if(a){a=a.previousSibling;var f=a.parentNode,c=a.nextSibling,e=0;do{if(c&&8===c.nodeType){var d=c.data;if("/$"===d)if(0===e)break;else e--;else"$"!==d&&"$?"!==d&&"$!"!==d||e++}d=c.nextSibling;f.removeChild(c);c=d}while(c);for(;b.firstChild;)f.insertBefore(b.firstChild,c);a.data="$";a._reactRetry&&a._reactRetry()}};$RC("')),null===i)throw Error(r(395));return n=n.toString(16),t.push(i),t.push('","'),t.push(e.segmentPrefix),t.push(n),t.push('")<\/script>')}function at(e,t,n,i){if(2===i.status)return!0;var s=i.id;if(-1===s){if(-1===(i.id=n.rootSegmentID))throw Error(r(392));return st(e,t,i)}return st(e,t,i),e=e.responseState,t.push(e.startInlineScript),e.sentCompleteSegmentFunction?t.push('$RS("'):(e.sentCompleteSegmentFunction=!0,t.push('function $RS(a,b){a=document.getElementById(a);b=document.getElementById(b);for(a.parentNode.removeChild(a);a.firstChild;)b.parentNode.insertBefore(a.firstChild,b);b.parentNode.removeChild(b)};$RS("')),t.push(e.segmentPrefix),s=s.toString(16),t.push(s),t.push('","'),t.push(e.placeholderPrefix),t.push(s),t.push('")<\/script>')}function lt(e,t){try{var n=e.completedRootSegment;if(null!==n&&0===e.pendingRootTasks){rt(e,t,n),e.completedRootSegment=null;var i=e.responseState.bootstrapChunks;for(n=0;n<i.length-1;n++)t.push(i[n]);n<i.length&&t.push(i[n])}var s,o=e.clientRenderedBoundaries;for(s=0;s<o.length;s++){var a=o[s];i=t;var l=e.responseState,c=a.id,d=a.errorDigest,u=a.errorMessage,m=a.errorComponentStack;if(i.push(l.startInlineScript),l.sentClientRenderFunction?i.push('$RX("'):(l.sentClientRenderFunction=!0,i.push('function $RX(b,c,d,e){var a=document.getElementById(b);a&&(b=a.previousSibling,b.data="$!",a=a.dataset,c&&(a.dgst=c),d&&(a.msg=d),e&&(a.stck=e),b._reactRetry&&b._reactRetry())};$RX("')),null===c)throw Error(r(395));if(i.push(c),i.push('"'),d||u||m){i.push(",");var p=D(d||"");i.push(p)}if(u||m){i.push(",");var h=D(u||"");i.push(h)}if(m){i.push(",");var g=D(m);i.push(g)}if(!i.push(")<\/script>"))return e.destination=null,s++,void o.splice(0,s)}o.splice(0,s);var v=e.completedBoundaries;for(s=0;s<v.length;s++)if(!ot(e,t,v[s]))return e.destination=null,s++,void v.splice(0,s);v.splice(0,s);var f=e.partialBoundaries;for(s=0;s<f.length;s++){var _=f[s];e:{o=e,a=t;var y=_.completedSegments;for(l=0;l<y.length;l++)if(!at(o,a,_,y[l])){l++,y.splice(0,l);var b=!1;break e}y.splice(0,l),b=!0}if(!b)return e.destination=null,s++,void f.splice(0,s)}f.splice(0,s);var E=e.completedBoundaries;for(s=0;s<E.length;s++)if(!ot(e,t,E[s]))return e.destination=null,s++,void E.splice(0,s);E.splice(0,s)}finally{0===e.allPendingTasks&&0===e.pingedTasks.length&&0===e.clientRenderedBoundaries.length&&0===e.completedBoundaries.length&&t.push(null)}}function ct(e,t){try{var n=e.abortableTasks;n.forEach((function(n){return Qe(n,e,t)})),n.clear(),null!==e.destination&&lt(e,e.destination)}catch(t){We(e,t),He(e,t)}}function dt(){}function ut(e,t,n,i){var s=!1,o=null,a="",l={push:function(e){return null!==e&&(a+=e),!0},destroy:function(e){s=!0,o=e}},c=!1;if(e=function(e,t,n,i,r,s,o,a,l){var c=[],d=new Set;return(n=ze(t={destination:null,responseState:t,progressiveChunkSize:void 0===i?12800:i,status:0,fatalError:null,nextSegmentId:0,allPendingTasks:0,pendingRootTasks:0,completedRootSegment:null,abortableTasks:d,pingedTasks:c,clientRenderedBoundaries:[],completedBoundaries:[],partialBoundaries:[],onError:void 0===r?Be:r,onAllReady:void 0===s?Ve:s,onShellReady:void 0===o?Ve:o,onShellError:void 0===a?Ve:a,onFatalError:void 0===l?Ve:l},0,null,n,!1,!1)).parentFlushed=!0,e=je(t,e,null,n,d,ee,null,ue),c.push(e),t}(e,function(e,t){return{bootstrapChunks:[],startInlineScript:"<script>",placeholderPrefix:(t=void 0===t?"":t)+"P:",segmentPrefix:t+"S:",boundaryPrefix:t+"B:",idPrefix:t,nextSuspenseID:0,sentCompleteSegmentFunction:!1,sentCompleteBoundaryFunction:!1,sentClientRenderFunction:!1,generateStaticMarkup:e}}(n,t?t.identifierPrefix:void 0),{insertionMode:1,selectedValue:null},1/0,dt,void 0,(function(){c=!0}),void 0,void 0),nt(e),ct(e,i),1===e.status)e.status=2,l.destroy(e.fatalError);else if(2!==e.status&&null===e.destination){e.destination=l;try{lt(e,l)}catch(t){We(e,t),He(e,t)}}if(s)throw o;if(!c)throw Error(r(426));return a}t.renderToNodeStream=function(){throw Error(r(207))},t.renderToStaticMarkup=function(e,t){return ut(e,t,!0,'The server used "renderToStaticMarkup" which does not support Suspense. If you intended to have the server wait for the suspended component please switch to "renderToReadableStream" which supports Suspense on the server')},t.renderToStaticNodeStream=function(){throw Error(r(208))},t.renderToString=function(e,t){return ut(e,t,!1,'The server used "renderToString" which does not support Suspense. If you intended for this Suspense boundary to render the fallback content on the server consider throwing an Error somewhere within the Suspense boundary. If you intended to have the server wait for the suspended component please switch to "renderToReadableStream" which supports Suspense on the server')},t.version="18.3.1"},"./node_modules/react-dom/cjs/react-dom-server.browser.production.min.js":(e,t,n)=>{"use strict";var i=n("./node_modules/react/index.js");function r(e){for(var t="https://reactjs.org/docs/error-decoder.html?invariant="+e,n=1;n<arguments.length;n++)t+="&args[]="+encodeURIComponent(arguments[n]);return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var s=null,o=0;function a(e,t){if(0!==t.length)if(512<t.length)0<o&&(e.enqueue(new Uint8Array(s.buffer,0,o)),s=new Uint8Array(512),o=0),e.enqueue(t);else{var n=s.length-o;n<t.length&&(0===n?e.enqueue(s):(s.set(t.subarray(0,n),o),e.enqueue(s),t=t.subarray(n)),s=new Uint8Array(512),o=0),s.set(t,o),o+=t.length}}function l(e,t){return a(e,t),!0}function c(e){s&&0<o&&(e.enqueue(new Uint8Array(s.buffer,0,o)),s=null,o=0)}var d=new TextEncoder;function u(e){return d.encode(e)}function m(e){return d.encode(e)}function p(e,t){"function"==typeof e.error?e.error(t):e.close()}var h=Object.prototype.hasOwnProperty,g=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,v={},f={};function _(e){return!!h.call(f,e)||!h.call(v,e)&&(g.test(e)?f[e]=!0:(v[e]=!0,!1))}function y(e,t,n,i,r,s,o){this.acceptsBooleans=2===t||3===t||4===t,this.attributeName=i,this.attributeNamespace=r,this.mustUseProperty=n,this.propertyName=e,this.type=t,this.sanitizeURL=s,this.removeEmptyString=o}var b={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach((function(e){b[e]=new y(e,0,!1,e,null,!1,!1)})),[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach((function(e){var t=e[0];b[t]=new y(t,1,!1,e[1],null,!1,!1)})),["contentEditable","draggable","spellCheck","value"].forEach((function(e){b[e]=new y(e,2,!1,e.toLowerCase(),null,!1,!1)})),["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach((function(e){b[e]=new y(e,2,!1,e,null,!1,!1)})),"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach((function(e){b[e]=new y(e,3,!1,e.toLowerCase(),null,!1,!1)})),["checked","multiple","muted","selected"].forEach((function(e){b[e]=new y(e,3,!0,e,null,!1,!1)})),["capture","download"].forEach((function(e){b[e]=new y(e,4,!1,e,null,!1,!1)})),["cols","rows","size","span"].forEach((function(e){b[e]=new y(e,6,!1,e,null,!1,!1)})),["rowSpan","start"].forEach((function(e){b[e]=new y(e,5,!1,e.toLowerCase(),null,!1,!1)}));var E=/[\-:]([a-z])/g;function w(e){return e[1].toUpperCase()}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach((function(e){var t=e.replace(E,w);b[t]=new y(t,1,!1,e,null,!1,!1)})),"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach((function(e){var t=e.replace(E,w);b[t]=new y(t,1,!1,e,"http://www.w3.org/1999/xlink",!1,!1)})),["xml:base","xml:lang","xml:space"].forEach((function(e){var t=e.replace(E,w);b[t]=new y(t,1,!1,e,"http://www.w3.org/XML/1998/namespace",!1,!1)})),["tabIndex","crossOrigin"].forEach((function(e){b[e]=new y(e,1,!1,e.toLowerCase(),null,!1,!1)})),b.xlinkHref=new y("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1),["src","href","action","formAction"].forEach((function(e){b[e]=new y(e,1,!1,e.toLowerCase(),null,!0,!0)}));var S={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},A=["Webkit","ms","Moz","O"];Object.keys(S).forEach((function(e){A.forEach((function(t){t=t+e.charAt(0).toUpperCase()+e.substring(1),S[t]=S[e]}))}));var C=/["'&<>]/;function x(e){if("boolean"==typeof e||"number"==typeof e)return""+e;e=""+e;var t=C.exec(e);if(t){var n,i="",r=0;for(n=t.index;n<e.length;n++){switch(e.charCodeAt(n)){case 34:t="&quot;";break;case 38:t="&amp;";break;case 39:t="&#x27;";break;case 60:t="&lt;";break;case 62:t="&gt;";break;default:continue}r!==n&&(i+=e.substring(r,n)),r=n+1,i+=t}e=r!==n?i+e.substring(r,n):i}return e}var k=/([A-Z])/g,R=/^ms-/,I=Array.isArray,T=m("<script>"),P=m("<\/script>"),N=m('<script src="'),D=m('<script type="module" src="'),M=m('" async=""><\/script>'),O=/(<\/|<)(s)(cript)/gi;function L(e,t,n,i){return t+("s"===n?"\\u0073":"\\u0053")+i}function F(e,t){return{insertionMode:e,selectedValue:t}}var U=m("\x3c!-- --\x3e");function B(e,t,n,i){return""===t?i:(i&&e.push(U),e.push(u(x(t))),!0)}var V=new Map,j=m(' style="'),z=m(":"),W=m(";");function H(e,t,n){if("object"!=typeof n)throw Error(r(62));for(var i in t=!0,n)if(h.call(n,i)){var s=n[i];if(null!=s&&"boolean"!=typeof s&&""!==s){if(0===i.indexOf("--")){var o=u(x(i));s=u(x((""+s).trim()))}else{o=i;var a=V.get(o);void 0!==a||(a=m(x(o.replace(k,"-$1").toLowerCase().replace(R,"-ms-"))),V.set(o,a)),o=a,s="number"==typeof s?0===s||h.call(S,i)?u(""+s):u(s+"px"):u(x((""+s).trim()))}t?(t=!1,e.push(j,o,z,s)):e.push(W,o,z,s)}}t||e.push(J)}var G=m(" "),K=m('="'),J=m('"'),q=m('=""');function $(e,t,n,i){switch(n){case"style":return void H(e,t,i);case"defaultValue":case"defaultChecked":case"innerHTML":case"suppressContentEditableWarning":case"suppressHydrationWarning":return}if(!(2<n.length)||"o"!==n[0]&&"O"!==n[0]||"n"!==n[1]&&"N"!==n[1])if(null!==(t=b.hasOwnProperty(n)?b[n]:null)){switch(typeof i){case"function":case"symbol":return;case"boolean":if(!t.acceptsBooleans)return}switch(n=u(t.attributeName),t.type){case 3:i&&e.push(G,n,q);break;case 4:!0===i?e.push(G,n,q):!1!==i&&e.push(G,n,K,u(x(i)),J);break;case 5:isNaN(i)||e.push(G,n,K,u(x(i)),J);break;case 6:!isNaN(i)&&1<=i&&e.push(G,n,K,u(x(i)),J);break;default:t.sanitizeURL&&(i=""+i),e.push(G,n,K,u(x(i)),J)}}else if(_(n)){switch(typeof i){case"function":case"symbol":return;case"boolean":if("data-"!==(t=n.toLowerCase().slice(0,5))&&"aria-"!==t)return}e.push(G,u(n),K,u(x(i)),J)}}var Y=m(">"),Z=m("/>");function X(e,t,n){if(null!=t){if(null!=n)throw Error(r(60));if("object"!=typeof t||!("__html"in t))throw Error(r(61));null!=(t=t.__html)&&e.push(u(""+t))}}var Q=m(' selected=""');function ee(e,t,n,i){e.push(re(n));var r,s=n=null;for(r in t)if(h.call(t,r)){var o=t[r];if(null!=o)switch(r){case"children":n=o;break;case"dangerouslySetInnerHTML":s=o;break;default:$(e,i,r,o)}}return e.push(Y),X(e,s,n),"string"==typeof n?(e.push(u(x(n))),null):n}var te=m("\n"),ne=/^[a-zA-Z][a-zA-Z:_\.\-\d]*$/,ie=new Map;function re(e){var t=ie.get(e);if(void 0===t){if(!ne.test(e))throw Error(r(65,e));t=m("<"+e),ie.set(e,t)}return t}var se=m("<!DOCTYPE html>");function oe(e,t,n,s,o){switch(t){case"select":e.push(re("select"));var a=null,l=null;for(p in n)if(h.call(n,p)){var c=n[p];if(null!=c)switch(p){case"children":a=c;break;case"dangerouslySetInnerHTML":l=c;break;case"defaultValue":case"value":break;default:$(e,s,p,c)}}return e.push(Y),X(e,l,a),a;case"option":l=o.selectedValue,e.push(re("option"));var d=c=null,m=null,p=null;for(a in n)if(h.call(n,a)){var g=n[a];if(null!=g)switch(a){case"children":c=g;break;case"selected":m=g;break;case"dangerouslySetInnerHTML":p=g;break;case"value":d=g;default:$(e,s,a,g)}}if(null!=l)if(n=null!==d?""+d:function(e){var t="";return i.Children.forEach(e,(function(e){null!=e&&(t+=e)})),t}(c),I(l)){for(s=0;s<l.length;s++)if(""+l[s]===n){e.push(Q);break}}else""+l===n&&e.push(Q);else m&&e.push(Q);return e.push(Y),X(e,p,c),c;case"textarea":for(c in e.push(re("textarea")),p=l=a=null,n)if(h.call(n,c)&&null!=(d=n[c]))switch(c){case"children":p=d;break;case"value":a=d;break;case"defaultValue":l=d;break;case"dangerouslySetInnerHTML":throw Error(r(91));default:$(e,s,c,d)}if(null===a&&null!==l&&(a=l),e.push(Y),null!=p){if(null!=a)throw Error(r(92));if(I(p)&&1<p.length)throw Error(r(93));a=""+p}return"string"==typeof a&&"\n"===a[0]&&e.push(te),null!==a&&e.push(u(x(""+a))),null;case"input":for(l in e.push(re("input")),d=p=c=a=null,n)if(h.call(n,l)&&null!=(m=n[l]))switch(l){case"children":case"dangerouslySetInnerHTML":throw Error(r(399,"input"));case"defaultChecked":d=m;break;case"defaultValue":c=m;break;case"checked":p=m;break;case"value":a=m;break;default:$(e,s,l,m)}return null!==p?$(e,s,"checked",p):null!==d&&$(e,s,"checked",d),null!==a?$(e,s,"value",a):null!==c&&$(e,s,"value",c),e.push(Z),null;case"menuitem":for(var v in e.push(re("menuitem")),n)if(h.call(n,v)&&null!=(a=n[v]))switch(v){case"children":case"dangerouslySetInnerHTML":throw Error(r(400));default:$(e,s,v,a)}return e.push(Y),null;case"title":for(g in e.push(re("title")),a=null,n)if(h.call(n,g)&&null!=(l=n[g]))switch(g){case"children":a=l;break;case"dangerouslySetInnerHTML":throw Error(r(434));default:$(e,s,g,l)}return e.push(Y),a;case"listing":case"pre":for(d in e.push(re(t)),l=a=null,n)if(h.call(n,d)&&null!=(c=n[d]))switch(d){case"children":a=c;break;case"dangerouslySetInnerHTML":l=c;break;default:$(e,s,d,c)}if(e.push(Y),null!=l){if(null!=a)throw Error(r(60));if("object"!=typeof l||!("__html"in l))throw Error(r(61));null!=(n=l.__html)&&("string"==typeof n&&0<n.length&&"\n"===n[0]?e.push(te,u(n)):e.push(u(""+n)))}return"string"==typeof a&&"\n"===a[0]&&e.push(te),a;case"area":case"base":case"br":case"col":case"embed":case"hr":case"img":case"keygen":case"link":case"meta":case"param":case"source":case"track":case"wbr":for(var f in e.push(re(t)),n)if(h.call(n,f)&&null!=(a=n[f]))switch(f){case"children":case"dangerouslySetInnerHTML":throw Error(r(399,t));default:$(e,s,f,a)}return e.push(Z),null;case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return ee(e,n,t,s);case"html":return 0===o.insertionMode&&e.push(se),ee(e,n,t,s);default:if(-1===t.indexOf("-")&&"string"!=typeof n.is)return ee(e,n,t,s);for(m in e.push(re(t)),l=a=null,n)if(h.call(n,m)&&null!=(c=n[m]))switch(m){case"children":a=c;break;case"dangerouslySetInnerHTML":l=c;break;case"style":H(e,s,c);break;case"suppressContentEditableWarning":case"suppressHydrationWarning":break;default:_(m)&&"function"!=typeof c&&"symbol"!=typeof c&&e.push(G,u(m),K,u(x(c)),J)}return e.push(Y),X(e,l,a),a}}var ae=m("</"),le=m(">"),ce=m('<template id="'),de=m('"></template>'),ue=m("\x3c!--$--\x3e"),me=m('\x3c!--$?--\x3e<template id="'),pe=m('"></template>'),he=m("\x3c!--$!--\x3e"),ge=m("\x3c!--/$--\x3e"),ve=m("<template"),fe=m('"'),_e=m(' data-dgst="');m(' data-msg="'),m(' data-stck="');var ye=m("></template>");function be(e,t,n){if(a(e,me),null===n)throw Error(r(395));return a(e,n),l(e,pe)}var Ee=m('<div hidden id="'),we=m('">'),Se=m("</div>"),Ae=m('<svg aria-hidden="true" style="display:none" id="'),Ce=m('">'),xe=m("</svg>"),ke=m('<math aria-hidden="true" style="display:none" id="'),Re=m('">'),Ie=m("</math>"),Te=m('<table hidden id="'),Pe=m('">'),Ne=m("</table>"),De=m('<table hidden><tbody id="'),Me=m('">'),Oe=m("</tbody></table>"),Le=m('<table hidden><tr id="'),Fe=m('">'),Ue=m("</tr></table>"),Be=m('<table hidden><colgroup id="'),Ve=m('">'),je=m("</colgroup></table>");var ze=m('function $RS(a,b){a=document.getElementById(a);b=document.getElementById(b);for(a.parentNode.removeChild(a);a.firstChild;)b.parentNode.insertBefore(a.firstChild,b);b.parentNode.removeChild(b)};$RS("'),We=m('$RS("'),He=m('","'),Ge=m('")<\/script>'),Ke=m('function $RC(a,b){a=document.getElementById(a);b=document.getElementById(b);b.parentNode.removeChild(b);if(a){a=a.previousSibling;var f=a.parentNode,c=a.nextSibling,e=0;do{if(c&&8===c.nodeType){var d=c.data;if("/$"===d)if(0===e)break;else e--;else"$"!==d&&"$?"!==d&&"$!"!==d||e++}d=c.nextSibling;f.removeChild(c);c=d}while(c);for(;b.firstChild;)f.insertBefore(b.firstChild,c);a.data="$";a._reactRetry&&a._reactRetry()}};$RC("'),Je=m('$RC("'),qe=m('","'),$e=m('")<\/script>'),Ye=m('function $RX(b,c,d,e){var a=document.getElementById(b);a&&(b=a.previousSibling,b.data="$!",a=a.dataset,c&&(a.dgst=c),d&&(a.msg=d),e&&(a.stck=e),b._reactRetry&&b._reactRetry())};$RX("'),Ze=m('$RX("'),Xe=m('"'),Qe=m(")<\/script>"),et=m(","),tt=/[<\u2028\u2029]/g;function nt(e){return JSON.stringify(e).replace(tt,(function(e){switch(e){case"<":return"\\u003c";case"\u2028":return"\\u2028";case"\u2029":return"\\u2029";default:throw Error("escapeJSStringsForInstructionScripts encountered a match it does not know how to replace. this means the match regex and the replacement characters are no longer in sync. This is a bug in React")}}))}var it=Object.assign,rt=Symbol.for("react.element"),st=Symbol.for("react.portal"),ot=Symbol.for("react.fragment"),at=Symbol.for("react.strict_mode"),lt=Symbol.for("react.profiler"),ct=Symbol.for("react.provider"),dt=Symbol.for("react.context"),ut=Symbol.for("react.forward_ref"),mt=Symbol.for("react.suspense"),pt=Symbol.for("react.suspense_list"),ht=Symbol.for("react.memo"),gt=Symbol.for("react.lazy"),vt=Symbol.for("react.scope"),ft=Symbol.for("react.debug_trace_mode"),_t=Symbol.for("react.legacy_hidden"),yt=Symbol.for("react.default_value"),bt=Symbol.iterator;function Et(e){if(null==e)return null;if("function"==typeof e)return e.displayName||e.name||null;if("string"==typeof e)return e;switch(e){case ot:return"Fragment";case st:return"Portal";case lt:return"Profiler";case at:return"StrictMode";case mt:return"Suspense";case pt:return"SuspenseList"}if("object"==typeof e)switch(e.$$typeof){case dt:return(e.displayName||"Context")+".Consumer";case ct:return(e._context.displayName||"Context")+".Provider";case ut:var t=e.render;return(e=e.displayName)||(e=""!==(e=t.displayName||t.name||"")?"ForwardRef("+e+")":"ForwardRef"),e;case ht:return null!==(t=e.displayName||null)?t:Et(e.type)||"Memo";case gt:t=e._payload,e=e._init;try{return Et(e(t))}catch(e){}}return null}var wt={};function St(e,t){if(!(e=e.contextTypes))return wt;var n,i={};for(n in e)i[n]=t[n];return i}var At=null;function Ct(e,t){if(e!==t){e.context._currentValue=e.parentValue,e=e.parent;var n=t.parent;if(null===e){if(null!==n)throw Error(r(401))}else{if(null===n)throw Error(r(401));Ct(e,n)}t.context._currentValue=t.value}}function xt(e){e.context._currentValue=e.parentValue,null!==(e=e.parent)&&xt(e)}function kt(e){var t=e.parent;null!==t&&kt(t),e.context._currentValue=e.value}function Rt(e,t){if(e.context._currentValue=e.parentValue,null===(e=e.parent))throw Error(r(402));e.depth===t.depth?Ct(e,t):Rt(e,t)}function It(e,t){var n=t.parent;if(null===n)throw Error(r(402));e.depth===n.depth?Ct(e,n):It(e,n),t.context._currentValue=t.value}function Tt(e){var t=At;t!==e&&(null===t?kt(e):null===e?xt(t):t.depth===e.depth?Ct(t,e):t.depth>e.depth?Rt(t,e):It(t,e),At=e)}var Pt={isMounted:function(){return!1},enqueueSetState:function(e,t){null!==(e=e._reactInternals).queue&&e.queue.push(t)},enqueueReplaceState:function(e,t){(e=e._reactInternals).replace=!0,e.queue=[t]},enqueueForceUpdate:function(){}};function Nt(e,t,n,i){var r=void 0!==e.state?e.state:null;e.updater=Pt,e.props=n,e.state=r;var s={queue:[],replace:!1};e._reactInternals=s;var o=t.contextType;if(e.context="object"==typeof o&&null!==o?o._currentValue:i,"function"==typeof(o=t.getDerivedStateFromProps)&&(r=null==(o=o(n,r))?r:it({},r,o),e.state=r),"function"!=typeof t.getDerivedStateFromProps&&"function"!=typeof e.getSnapshotBeforeUpdate&&("function"==typeof e.UNSAFE_componentWillMount||"function"==typeof e.componentWillMount))if(t=e.state,"function"==typeof e.componentWillMount&&e.componentWillMount(),"function"==typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),t!==e.state&&Pt.enqueueReplaceState(e,e.state,null),null!==s.queue&&0<s.queue.length)if(t=s.queue,o=s.replace,s.queue=null,s.replace=!1,o&&1===t.length)e.state=t[0];else{for(s=o?t[0]:e.state,r=!0,o=o?1:0;o<t.length;o++){var a=t[o];null!=(a="function"==typeof a?a.call(e,s,n,i):a)&&(r?(r=!1,s=it({},s,a)):it(s,a))}e.state=s}else s.queue=null}var Dt={id:1,overflow:""};function Mt(e,t,n){var i=e.id;e=e.overflow;var r=32-Ot(i)-1;i&=~(1<<r),n+=1;var s=32-Ot(t)+r;if(30<s){var o=r-r%5;return s=(i&(1<<o)-1).toString(32),i>>=o,r-=o,{id:1<<32-Ot(t)+r|n<<r|i,overflow:s+e}}return{id:1<<s|n<<r|i,overflow:e}}var Ot=Math.clz32?Math.clz32:function(e){return 0===(e>>>=0)?32:31-(Lt(e)/Ft|0)|0},Lt=Math.log,Ft=Math.LN2;var Ut="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},Bt=null,Vt=null,jt=null,zt=null,Wt=!1,Ht=!1,Gt=0,Kt=null,Jt=0;function qt(){if(null===Bt)throw Error(r(321));return Bt}function $t(){if(0<Jt)throw Error(r(312));return{memoizedState:null,queue:null,next:null}}function Yt(){return null===zt?null===jt?(Wt=!1,jt=zt=$t()):(Wt=!0,zt=jt):null===zt.next?(Wt=!1,zt=zt.next=$t()):(Wt=!0,zt=zt.next),zt}function Zt(){Vt=Bt=null,Ht=!1,jt=null,Jt=0,zt=Kt=null}function Xt(e,t){return"function"==typeof t?t(e):t}function Qt(e,t,n){if(Bt=qt(),zt=Yt(),Wt){var i=zt.queue;if(t=i.dispatch,null!==Kt&&void 0!==(n=Kt.get(i))){Kt.delete(i),i=zt.memoizedState;do{i=e(i,n.action),n=n.next}while(null!==n);return zt.memoizedState=i,[i,t]}return[zt.memoizedState,t]}return e=e===Xt?"function"==typeof t?t():t:void 0!==n?n(t):t,zt.memoizedState=e,e=(e=zt.queue={last:null,dispatch:null}).dispatch=tn.bind(null,Bt,e),[zt.memoizedState,e]}function en(e,t){if(Bt=qt(),t=void 0===t?null:t,null!==(zt=Yt())){var n=zt.memoizedState;if(null!==n&&null!==t){var i=n[1];e:if(null===i)i=!1;else{for(var r=0;r<i.length&&r<t.length;r++)if(!Ut(t[r],i[r])){i=!1;break e}i=!0}if(i)return n[0]}}return e=e(),zt.memoizedState=[e,t],e}function tn(e,t,n){if(25<=Jt)throw Error(r(301));if(e===Bt)if(Ht=!0,e={action:n,next:null},null===Kt&&(Kt=new Map),void 0===(n=Kt.get(t)))Kt.set(t,e);else{for(t=n;null!==t.next;)t=t.next;t.next=e}}function nn(){throw Error(r(394))}function rn(){}var sn={readContext:function(e){return e._currentValue},useContext:function(e){return qt(),e._currentValue},useMemo:en,useReducer:Qt,useRef:function(e){Bt=qt();var t=(zt=Yt()).memoizedState;return null===t?(e={current:e},zt.memoizedState=e):t},useState:function(e){return Qt(Xt,e)},useInsertionEffect:rn,useLayoutEffect:function(){},useCallback:function(e,t){return en((function(){return e}),t)},useImperativeHandle:rn,useEffect:rn,useDebugValue:rn,useDeferredValue:function(e){return qt(),e},useTransition:function(){return qt(),[!1,nn]},useId:function(){var e=Vt.treeContext,t=e.overflow;e=((e=e.id)&~(1<<32-Ot(e)-1)).toString(32)+t;var n=on;if(null===n)throw Error(r(404));return t=Gt++,e=":"+n.idPrefix+"R"+e,0<t&&(e+="H"+t.toString(32)),e+":"},useMutableSource:function(e,t){return qt(),t(e._source)},useSyncExternalStore:function(e,t,n){if(void 0===n)throw Error(r(407));return n()}},on=null,an=i.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentDispatcher;function ln(e){return console.error(e),null}function cn(){}function dn(e,t,n,i,r,s,o,a){e.allPendingTasks++,null===n?e.pendingRootTasks++:n.pendingTasks++;var l={node:t,ping:function(){var t=e.pingedTasks;t.push(l),1===t.length&&Cn(e)},blockedBoundary:n,blockedSegment:i,abortSet:r,legacyContext:s,context:o,treeContext:a};return r.add(l),l}function un(e,t,n,i,r,s){return{status:0,id:-1,index:t,parentFlushed:!1,chunks:[],children:[],formatContext:i,boundary:n,lastPushedText:r,textEmbedded:s}}function mn(e,t){if(null!=(e=e.onError(t))&&"string"!=typeof e)throw Error('onError returned something with a type other than "string". onError should return a string and may return null or undefined but must not return anything else. It received something of type "'+typeof e+'" instead');return e}function pn(e,t){var n=e.onShellError;n(t),(n=e.onFatalError)(t),null!==e.destination?(e.status=2,p(e.destination,t)):(e.status=1,e.fatalError=t)}function hn(e,t,n,i,r){for(Bt={},Vt=t,Gt=0,e=n(i,r);Ht;)Ht=!1,Gt=0,Jt+=1,zt=null,e=n(i,r);return Zt(),e}function gn(e,t,n,i){var s=n.render(),o=i.childContextTypes;if(null!=o){var a=t.legacyContext;if("function"!=typeof n.getChildContext)i=a;else{for(var l in n=n.getChildContext())if(!(l in o))throw Error(r(108,Et(i)||"Unknown",l));i=it({},a,n)}t.legacyContext=i,_n(e,t,s),t.legacyContext=a}else _n(e,t,s)}function vn(e,t){if(e&&e.defaultProps){for(var n in t=it({},t),e=e.defaultProps)void 0===t[n]&&(t[n]=e[n]);return t}return t}function fn(e,t,n,i,s){if("function"==typeof n)if(n.prototype&&n.prototype.isReactComponent){s=St(n,t.legacyContext);var o=n.contextType;Nt(o=new n(i,"object"==typeof o&&null!==o?o._currentValue:s),n,i,s),gn(e,t,o,n)}else{s=hn(e,t,n,i,o=St(n,t.legacyContext));var a=0!==Gt;if("object"==typeof s&&null!==s&&"function"==typeof s.render&&void 0===s.$$typeof)Nt(s,n,i,o),gn(e,t,s,n);else if(a){i=t.treeContext,t.treeContext=Mt(i,1,0);try{_n(e,t,s)}finally{t.treeContext=i}}else _n(e,t,s)}else{if("string"!=typeof n){switch(n){case _t:case ft:case at:case lt:case ot:case pt:return void _n(e,t,i.children);case vt:throw Error(r(343));case mt:e:{n=t.blockedBoundary,s=t.blockedSegment,o=i.fallback,i=i.children;var l={id:null,rootSegmentID:-1,parentFlushed:!1,pendingTasks:0,forceClientRender:!1,completedSegments:[],byteSize:0,fallbackAbortableTasks:a=new Set,errorDigest:null},c=un(0,s.chunks.length,l,s.formatContext,!1,!1);s.children.push(c),s.lastPushedText=!1;var d=un(0,0,null,s.formatContext,!1,!1);d.parentFlushed=!0,t.blockedBoundary=l,t.blockedSegment=d;try{if(bn(e,t,i),d.lastPushedText&&d.textEmbedded&&d.chunks.push(U),d.status=1,Sn(l,d),0===l.pendingTasks)break e}catch(t){d.status=4,l.forceClientRender=!0,l.errorDigest=mn(e,t)}finally{t.blockedBoundary=n,t.blockedSegment=s}t=dn(e,o,n,c,a,t.legacyContext,t.context,t.treeContext),e.pingedTasks.push(t)}return}if("object"==typeof n&&null!==n)switch(n.$$typeof){case ut:if(i=hn(e,t,n.render,i,s),0!==Gt){n=t.treeContext,t.treeContext=Mt(n,1,0);try{_n(e,t,i)}finally{t.treeContext=n}}else _n(e,t,i);return;case ht:return void fn(e,t,n=n.type,i=vn(n,i),s);case ct:if(s=i.children,n=n._context,i=i.value,o=n._currentValue,n._currentValue=i,At=i={parent:a=At,depth:null===a?0:a.depth+1,context:n,parentValue:o,value:i},t.context=i,_n(e,t,s),null===(e=At))throw Error(r(403));return i=e.parentValue,e.context._currentValue=i===yt?e.context._defaultValue:i,e=At=e.parent,void(t.context=e);case dt:return void _n(e,t,i=(i=i.children)(n._currentValue));case gt:return void fn(e,t,n=(s=n._init)(n._payload),i=vn(n,i),void 0)}throw Error(r(130,null==n?n:typeof n,""))}switch(o=oe((s=t.blockedSegment).chunks,n,i,e.responseState,s.formatContext),s.lastPushedText=!1,a=s.formatContext,s.formatContext=function(e,t,n){switch(t){case"select":return F(1,null!=n.value?n.value:n.defaultValue);case"svg":return F(2,null);case"math":return F(3,null);case"foreignObject":return F(1,null);case"table":return F(4,null);case"thead":case"tbody":case"tfoot":return F(5,null);case"colgroup":return F(7,null);case"tr":return F(6,null)}return 4<=e.insertionMode||0===e.insertionMode?F(1,null):e}(a,n,i),bn(e,t,o),s.formatContext=a,n){case"area":case"base":case"br":case"col":case"embed":case"hr":case"img":case"input":case"keygen":case"link":case"meta":case"param":case"source":case"track":case"wbr":break;default:s.chunks.push(ae,u(n),le)}s.lastPushedText=!1}}function _n(e,t,n){if(t.node=n,"object"==typeof n&&null!==n){switch(n.$$typeof){case rt:return void fn(e,t,n.type,n.props,n.ref);case st:throw Error(r(257));case gt:var i=n._init;return void _n(e,t,n=i(n._payload))}if(I(n))return void yn(e,t,n);if(null===n||"object"!=typeof n?i=null:i="function"==typeof(i=bt&&n[bt]||n["@@iterator"])?i:null,i&&(i=i.call(n))){if(!(n=i.next()).done){var s=[];do{s.push(n.value),n=i.next()}while(!n.done);yn(e,t,s)}return}throw e=Object.prototype.toString.call(n),Error(r(31,"[object Object]"===e?"object with keys {"+Object.keys(n).join(", ")+"}":e))}"string"==typeof n?(i=t.blockedSegment).lastPushedText=B(t.blockedSegment.chunks,n,e.responseState,i.lastPushedText):"number"==typeof n&&((i=t.blockedSegment).lastPushedText=B(t.blockedSegment.chunks,""+n,e.responseState,i.lastPushedText))}function yn(e,t,n){for(var i=n.length,r=0;r<i;r++){var s=t.treeContext;t.treeContext=Mt(s,i,r);try{bn(e,t,n[r])}finally{t.treeContext=s}}}function bn(e,t,n){var i=t.blockedSegment.formatContext,r=t.legacyContext,s=t.context;try{return _n(e,t,n)}catch(l){if(Zt(),"object"!=typeof l||null===l||"function"!=typeof l.then)throw t.blockedSegment.formatContext=i,t.legacyContext=r,t.context=s,Tt(s),l;n=l;var o=t.blockedSegment,a=un(0,o.chunks.length,null,o.formatContext,o.lastPushedText,!0);o.children.push(a),o.lastPushedText=!1,e=dn(e,t.node,t.blockedBoundary,a,t.abortSet,t.legacyContext,t.context,t.treeContext).ping,n.then(e,e),t.blockedSegment.formatContext=i,t.legacyContext=r,t.context=s,Tt(s)}}function En(e){var t=e.blockedBoundary;(e=e.blockedSegment).status=3,An(this,t,e)}function wn(e,t,n){var i=e.blockedBoundary;e.blockedSegment.status=3,null===i?(t.allPendingTasks--,2!==t.status&&(t.status=2,null!==t.destination&&t.destination.close())):(i.pendingTasks--,i.forceClientRender||(i.forceClientRender=!0,e=void 0===n?Error(r(432)):n,i.errorDigest=t.onError(e),i.parentFlushed&&t.clientRenderedBoundaries.push(i)),i.fallbackAbortableTasks.forEach((function(e){return wn(e,t,n)})),i.fallbackAbortableTasks.clear(),t.allPendingTasks--,0===t.allPendingTasks&&(i=t.onAllReady)())}function Sn(e,t){if(0===t.chunks.length&&1===t.children.length&&null===t.children[0].boundary){var n=t.children[0];n.id=t.id,n.parentFlushed=!0,1===n.status&&Sn(e,n)}else e.completedSegments.push(t)}function An(e,t,n){if(null===t){if(n.parentFlushed){if(null!==e.completedRootSegment)throw Error(r(389));e.completedRootSegment=n}e.pendingRootTasks--,0===e.pendingRootTasks&&(e.onShellError=cn,(t=e.onShellReady)())}else t.pendingTasks--,t.forceClientRender||(0===t.pendingTasks?(n.parentFlushed&&1===n.status&&Sn(t,n),t.parentFlushed&&e.completedBoundaries.push(t),t.fallbackAbortableTasks.forEach(En,e),t.fallbackAbortableTasks.clear()):n.parentFlushed&&1===n.status&&(Sn(t,n),1===t.completedSegments.length&&t.parentFlushed&&e.partialBoundaries.push(t)));e.allPendingTasks--,0===e.allPendingTasks&&(e=e.onAllReady)()}function Cn(e){if(2!==e.status){var t=At,n=an.current;an.current=sn;var i=on;on=e.responseState;try{var r,s=e.pingedTasks;for(r=0;r<s.length;r++){var o=s[r],a=e,l=o.blockedSegment;if(0===l.status){Tt(o.context);try{_n(a,o,o.node),l.lastPushedText&&l.textEmbedded&&l.chunks.push(U),o.abortSet.delete(o),l.status=1,An(a,o.blockedBoundary,l)}catch(e){if(Zt(),"object"==typeof e&&null!==e&&"function"==typeof e.then){var c=o.ping;e.then(c,c)}else{o.abortSet.delete(o),l.status=4;var d=o.blockedBoundary,u=e,m=mn(a,u);if(null===d?pn(a,u):(d.pendingTasks--,d.forceClientRender||(d.forceClientRender=!0,d.errorDigest=m,d.parentFlushed&&a.clientRenderedBoundaries.push(d))),a.allPendingTasks--,0===a.allPendingTasks)(0,a.onAllReady)()}}}}s.splice(0,r),null!==e.destination&&Pn(e,e.destination)}catch(t){mn(e,t),pn(e,t)}finally{on=i,an.current=n,n===sn&&Tt(t)}}}function xn(e,t,n){switch(n.parentFlushed=!0,n.status){case 0:var i=n.id=e.nextSegmentId++;return n.lastPushedText=!1,n.textEmbedded=!1,e=e.responseState,a(t,ce),a(t,e.placeholderPrefix),a(t,e=u(i.toString(16))),l(t,de);case 1:n.status=2;var s=!0;i=n.chunks;var o=0;n=n.children;for(var c=0;c<n.length;c++){for(s=n[c];o<s.index;o++)a(t,i[o]);s=kn(e,t,s)}for(;o<i.length-1;o++)a(t,i[o]);return o<i.length&&(s=l(t,i[o])),s;default:throw Error(r(390))}}function kn(e,t,n){var i=n.boundary;if(null===i)return xn(e,t,n);if(i.parentFlushed=!0,i.forceClientRender)i=i.errorDigest,l(t,he),a(t,ve),i&&(a(t,_e),a(t,u(x(i))),a(t,fe)),l(t,ye),xn(e,t,n);else if(0<i.pendingTasks){i.rootSegmentID=e.nextSegmentId++,0<i.completedSegments.length&&e.partialBoundaries.push(i);var s=e.responseState,o=s.nextSuspenseID++;s=m(s.boundaryPrefix+o.toString(16)),i=i.id=s,be(t,e.responseState,i),xn(e,t,n)}else if(i.byteSize>e.progressiveChunkSize)i.rootSegmentID=e.nextSegmentId++,e.completedBoundaries.push(i),be(t,e.responseState,i.id),xn(e,t,n);else{if(l(t,ue),1!==(n=i.completedSegments).length)throw Error(r(391));kn(e,t,n[0])}return l(t,ge)}function Rn(e,t,n){return function(e,t,n,i){switch(n.insertionMode){case 0:case 1:return a(e,Ee),a(e,t.segmentPrefix),a(e,u(i.toString(16))),l(e,we);case 2:return a(e,Ae),a(e,t.segmentPrefix),a(e,u(i.toString(16))),l(e,Ce);case 3:return a(e,ke),a(e,t.segmentPrefix),a(e,u(i.toString(16))),l(e,Re);case 4:return a(e,Te),a(e,t.segmentPrefix),a(e,u(i.toString(16))),l(e,Pe);case 5:return a(e,De),a(e,t.segmentPrefix),a(e,u(i.toString(16))),l(e,Me);case 6:return a(e,Le),a(e,t.segmentPrefix),a(e,u(i.toString(16))),l(e,Fe);case 7:return a(e,Be),a(e,t.segmentPrefix),a(e,u(i.toString(16))),l(e,Ve);default:throw Error(r(397))}}(t,e.responseState,n.formatContext,n.id),kn(e,t,n),function(e,t){switch(t.insertionMode){case 0:case 1:return l(e,Se);case 2:return l(e,xe);case 3:return l(e,Ie);case 4:return l(e,Ne);case 5:return l(e,Oe);case 6:return l(e,Ue);case 7:return l(e,je);default:throw Error(r(397))}}(t,n.formatContext)}function In(e,t,n){for(var i=n.completedSegments,s=0;s<i.length;s++)Tn(e,t,n,i[s]);if(i.length=0,e=e.responseState,i=n.id,n=n.rootSegmentID,a(t,e.startInlineScript),e.sentCompleteBoundaryFunction?a(t,Je):(e.sentCompleteBoundaryFunction=!0,a(t,Ke)),null===i)throw Error(r(395));return n=u(n.toString(16)),a(t,i),a(t,qe),a(t,e.segmentPrefix),a(t,n),l(t,$e)}function Tn(e,t,n,i){if(2===i.status)return!0;var s=i.id;if(-1===s){if(-1===(i.id=n.rootSegmentID))throw Error(r(392));return Rn(e,t,i)}return Rn(e,t,i),a(t,(e=e.responseState).startInlineScript),e.sentCompleteSegmentFunction?a(t,We):(e.sentCompleteSegmentFunction=!0,a(t,ze)),a(t,e.segmentPrefix),a(t,s=u(s.toString(16))),a(t,He),a(t,e.placeholderPrefix),a(t,s),l(t,Ge)}function Pn(e,t){s=new Uint8Array(512),o=0;try{var n=e.completedRootSegment;if(null!==n&&0===e.pendingRootTasks){kn(e,t,n),e.completedRootSegment=null;var i=e.responseState.bootstrapChunks;for(n=0;n<i.length-1;n++)a(t,i[n]);n<i.length&&l(t,i[n])}var d,m=e.clientRenderedBoundaries;for(d=0;d<m.length;d++){var p=m[d];i=t;var h=e.responseState,g=p.id,v=p.errorDigest,f=p.errorMessage,_=p.errorComponentStack;if(a(i,h.startInlineScript),h.sentClientRenderFunction?a(i,Ze):(h.sentClientRenderFunction=!0,a(i,Ye)),null===g)throw Error(r(395));if(a(i,g),a(i,Xe),(v||f||_)&&(a(i,et),a(i,u(nt(v||"")))),(f||_)&&(a(i,et),a(i,u(nt(f||"")))),_&&(a(i,et),a(i,u(nt(_)))),!l(i,Qe))return e.destination=null,d++,void m.splice(0,d)}m.splice(0,d);var y=e.completedBoundaries;for(d=0;d<y.length;d++)if(!In(e,t,y[d]))return e.destination=null,d++,void y.splice(0,d);y.splice(0,d),c(t),s=new Uint8Array(512),o=0;var b=e.partialBoundaries;for(d=0;d<b.length;d++){var E=b[d];e:{m=e,p=t;var w=E.completedSegments;for(h=0;h<w.length;h++)if(!Tn(m,p,E,w[h])){h++,w.splice(0,h);var S=!1;break e}w.splice(0,h),S=!0}if(!S)return e.destination=null,d++,void b.splice(0,d)}b.splice(0,d);var A=e.completedBoundaries;for(d=0;d<A.length;d++)if(!In(e,t,A[d]))return e.destination=null,d++,void A.splice(0,d);A.splice(0,d)}finally{c(t),0===e.allPendingTasks&&0===e.pingedTasks.length&&0===e.clientRenderedBoundaries.length&&0===e.completedBoundaries.length&&t.close()}}function Nn(e,t){try{var n=e.abortableTasks;n.forEach((function(n){return wn(n,e,t)})),n.clear(),null!==e.destination&&Pn(e,e.destination)}catch(t){mn(e,t),pn(e,t)}}t.renderToReadableStream=function(e,t){return new Promise((function(n,i){var r,s,o=new Promise((function(e,t){s=e,r=t})),a=function(e,t,n,i,r,s,o,a,l){var c=[],d=new Set;return(n=un(t={destination:null,responseState:t,progressiveChunkSize:void 0===i?12800:i,status:0,fatalError:null,nextSegmentId:0,allPendingTasks:0,pendingRootTasks:0,completedRootSegment:null,abortableTasks:d,pingedTasks:c,clientRenderedBoundaries:[],completedBoundaries:[],partialBoundaries:[],onError:void 0===r?ln:r,onAllReady:void 0===s?cn:s,onShellReady:void 0===o?cn:o,onShellError:void 0===a?cn:a,onFatalError:void 0===l?cn:l},0,null,n,!1,!1)).parentFlushed=!0,e=dn(t,e,null,n,d,wt,null,Dt),c.push(e),t}(e,function(e,t,n,i,r){e=void 0===e?"":e,t=void 0===t?T:m('<script nonce="'+x(t)+'">');var s=[];if(void 0!==n&&s.push(t,u((""+n).replace(O,L)),P),void 0!==i)for(n=0;n<i.length;n++)s.push(N,u(x(i[n])),M);if(void 0!==r)for(i=0;i<r.length;i++)s.push(D,u(x(r[i])),M);return{bootstrapChunks:s,startInlineScript:t,placeholderPrefix:m(e+"P:"),segmentPrefix:m(e+"S:"),boundaryPrefix:e+"B:",idPrefix:e,nextSuspenseID:0,sentCompleteSegmentFunction:!1,sentCompleteBoundaryFunction:!1,sentClientRenderFunction:!1}}(t?t.identifierPrefix:void 0,t?t.nonce:void 0,t?t.bootstrapScriptContent:void 0,t?t.bootstrapScripts:void 0,t?t.bootstrapModules:void 0),function(e){return F("http://www.w3.org/2000/svg"===e?2:"http://www.w3.org/1998/Math/MathML"===e?3:0,null)}(t?t.namespaceURI:void 0),t?t.progressiveChunkSize:void 0,t?t.onError:void 0,s,(function(){var e=new ReadableStream({type:"bytes",pull:function(e){if(1===a.status)a.status=2,p(e,a.fatalError);else if(2!==a.status&&null===a.destination){a.destination=e;try{Pn(a,e)}catch(e){mn(a,e),pn(a,e)}}},cancel:function(){Nn(a)}},{highWaterMark:0});e.allReady=o,n(e)}),(function(e){o.catch((function(){})),i(e)}),r);if(t&&t.signal){var l=t.signal,c=function(){Nn(a,l.reason),l.removeEventListener("abort",c)};l.addEventListener("abort",c)}Cn(a)}))},t.version="18.3.1"},"./node_modules/react-dom/server.browser.js":(e,t,n)=>{"use strict";var i,r;i=n("./node_modules/react-dom/cjs/react-dom-server-legacy.browser.production.min.js"),r=n("./node_modules/react-dom/cjs/react-dom-server.browser.production.min.js"),i.version,i.renderToString,t.qV=i.renderToStaticMarkup,i.renderToNodeStream,i.renderToStaticNodeStream,r.renderToReadableStream},"./node_modules/react-is/cjs/react-is.production.min.js":(e,t)=>{"use strict";var n="function"==typeof Symbol&&Symbol.for,i=n?Symbol.for("react.element"):60103,r=n?Symbol.for("react.portal"):60106,s=n?Symbol.for("react.fragment"):60107,o=n?Symbol.for("react.strict_mode"):60108,a=n?Symbol.for("react.profiler"):60114,l=n?Symbol.for("react.provider"):60109,c=n?Symbol.for("react.context"):60110,d=n?Symbol.for("react.async_mode"):60111,u=n?Symbol.for("react.concurrent_mode"):60111,m=n?Symbol.for("react.forward_ref"):60112,p=n?Symbol.for("react.suspense"):60113,h=n?Symbol.for("react.suspense_list"):60120,g=n?Symbol.for("react.memo"):60115,v=n?Symbol.for("react.lazy"):60116,f=n?Symbol.for("react.block"):60121,_=n?Symbol.for("react.fundamental"):60117,y=n?Symbol.for("react.responder"):60118,b=n?Symbol.for("react.scope"):60119;function E(e){if("object"==typeof e&&null!==e){var t=e.$$typeof;switch(t){case i:switch(e=e.type){case d:case u:case s:case a:case o:case p:return e;default:switch(e=e&&e.$$typeof){case c:case m:case v:case g:case l:return e;default:return t}}case r:return t}}}function w(e){return E(e)===u}t.AsyncMode=d,t.ConcurrentMode=u,t.ContextConsumer=c,t.ContextProvider=l,t.Element=i,t.ForwardRef=m,t.Fragment=s,t.Lazy=v,t.Memo=g,t.Portal=r,t.Profiler=a,t.StrictMode=o,t.Suspense=p,t.isAsyncMode=function(e){return w(e)||E(e)===d},t.isConcurrentMode=w,t.isContextConsumer=function(e){return E(e)===c},t.isContextProvider=function(e){return E(e)===l},t.isElement=function(e){return"object"==typeof e&&null!==e&&e.$$typeof===i},t.isForwardRef=function(e){return E(e)===m},t.isFragment=function(e){return E(e)===s},t.isLazy=function(e){return E(e)===v},t.isMemo=function(e){return E(e)===g},t.isPortal=function(e){return E(e)===r},t.isProfiler=function(e){return E(e)===a},t.isStrictMode=function(e){return E(e)===o},t.isSuspense=function(e){return E(e)===p},t.isValidElementType=function(e){return"string"==typeof e||"function"==typeof e||e===s||e===u||e===a||e===o||e===p||e===h||"object"==typeof e&&null!==e&&(e.$$typeof===v||e.$$typeof===g||e.$$typeof===l||e.$$typeof===c||e.$$typeof===m||e.$$typeof===_||e.$$typeof===y||e.$$typeof===b||e.$$typeof===f)},t.typeOf=E},"./node_modules/react-is/index.js":(e,t,n)=>{"use strict";e.exports=n("./node_modules/react-is/cjs/react-is.production.min.js")},"./node_modules/react-redux/node_modules/react-is/cjs/react-is.production.min.js":(e,t)=>{"use strict";var n=60103,i=60106,r=60107,s=60108,o=60114,a=60109,l=60110,c=60112,d=60113,u=60120,m=60115,p=60116,h=60121,g=60122,v=60117,f=60129,_=60131;if("function"==typeof Symbol&&Symbol.for){var y=Symbol.for;n=y("react.element"),i=y("react.portal"),r=y("react.fragment"),s=y("react.strict_mode"),o=y("react.profiler"),a=y("react.provider"),l=y("react.context"),c=y("react.forward_ref"),d=y("react.suspense"),u=y("react.suspense_list"),m=y("react.memo"),p=y("react.lazy"),h=y("react.block"),g=y("react.server.block"),v=y("react.fundamental"),f=y("react.debug_trace_mode"),_=y("react.legacy_hidden")}function b(e){if("object"==typeof e&&null!==e){var t=e.$$typeof;switch(t){case n:switch(e=e.type){case r:case o:case s:case d:case u:return e;default:switch(e=e&&e.$$typeof){case l:case c:case p:case m:case a:return e;default:return t}}case i:return t}}}t.isContextConsumer=function(e){return b(e)===l}},"./node_modules/react-redux/node_modules/react-is/index.js":(e,t,n)=>{"use strict";e.exports=n("./node_modules/react-redux/node_modules/react-is/cjs/react-is.production.min.js")},"./node_modules/sanitize-filename/index.js":(e,t,n)=>{"use strict";var i=n("./node_modules/truncate-utf8-bytes/browser.js"),r=/[\/\?<>\\:\*\|"]/g,s=/[\x00-\x1f\x80-\x9f]/g,o=/^\.+$/,a=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,l=/[\. ]+$/;function c(e,t){if("string"!=typeof e)throw new Error("Input must be string");var n=e.replace(r,t).replace(s,t).replace(o,t).replace(a,t).replace(l,t);return i(n,255)}e.exports=function(e,t){var n=t&&t.replacement||"",i=c(e,n);return""===n?i:c(i,"")}},"./node_modules/truncate-utf8-bytes/browser.js":(e,t,n)=>{"use strict";var i=n("./node_modules/truncate-utf8-bytes/lib/truncate.js"),r=n("./node_modules/utf8-byte-length/browser.js");e.exports=i.bind(null,r)},"./node_modules/truncate-utf8-bytes/lib/truncate.js":e=>{"use strict";function t(e){return e>=55296&&e<=56319}function n(e){return e>=56320&&e<=57343}e.exports=function(e,i,r){if("string"!=typeof i)throw new Error("Input must be string");for(var s,o,a=i.length,l=0,c=0;c<a;c+=1){if(s=i.charCodeAt(c),o=i[c],t(s)&&n(i.charCodeAt(c+1))&&(o+=i[c+=1]),(l+=e(o))===r)return i.slice(0,c+1);if(l>r)return i.slice(0,c-o.length+1)}return i}},"./node_modules/utf8-byte-length/browser.js":e=>{"use strict";function t(e){return e>=55296&&e<=56319}function n(e){return e>=56320&&e<=57343}e.exports=function(e){if("string"!=typeof e)throw new Error("Input must be string");for(var i=e.length,r=0,s=null,o=null,a=0;a<i;a++)n(s=e.charCodeAt(a))?null!=o&&t(o)?r+=1:r+=3:s<=127?r+=1:s>=128&&s<=2047?r+=2:s>=2048&&s<=65535&&(r+=3),o=s;return r}},"./node_modules/what-input/dist/what-input.js":function(e){var t;t=function(){return function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={exports:{},id:i,loaded:!1};return e[i].call(r.exports,r,r.exports,n),r.loaded=!0,r.exports}return n.m=e,n.c=t,n.p="",n(0)}([function(e,t){"use strict";e.exports=function(){if("undefined"==typeof document||"undefined"==typeof window)return{ask:function(){return"initial"},element:function(){return null},ignoreKeys:function(){},specificKeys:function(){},registerOnChange:function(){},unRegisterOnChange:function(){}};var e=document.documentElement,t=null,n="initial",i=n,r=Date.now(),s=!1,o=["button","input","select","textarea"],a=[],l=[16,17,18,91,93],c=[],d={keydown:"keyboard",keyup:"keyboard",mousedown:"mouse",mousemove:"mouse",MSPointerDown:"pointer",MSPointerMove:"pointer",pointerdown:"pointer",pointermove:"pointer",touchstart:"touch",touchend:"touch"},u=!1,m={x:null,y:null},p={2:"touch",3:"touch",4:"mouse"},h=!1;try{var g=Object.defineProperty({},"passive",{get:function(){h=!0}});window.addEventListener("test",null,g)}catch(e){}var v=function(){var e=!h||{passive:!0,capture:!0};document.addEventListener("DOMContentLoaded",f,!0),window.PointerEvent?(window.addEventListener("pointerdown",_,!0),window.addEventListener("pointermove",b,!0)):window.MSPointerEvent?(window.addEventListener("MSPointerDown",_,!0),window.addEventListener("MSPointerMove",b,!0)):(window.addEventListener("mousedown",_,!0),window.addEventListener("mousemove",b,!0),"ontouchstart"in window&&(window.addEventListener("touchstart",_,e),window.addEventListener("touchend",_,!0))),window.addEventListener(x(),b,e),window.addEventListener("keydown",_,!0),window.addEventListener("keyup",_,!0),window.addEventListener("focusin",E,!0),window.addEventListener("focusout",w,!0)},f=function(){if(s=!("false"===e.getAttribute("data-whatpersist")||"false"===document.body.getAttribute("data-whatpersist")))try{window.sessionStorage.getItem("what-input")&&(n=window.sessionStorage.getItem("what-input")),window.sessionStorage.getItem("what-intent")&&(i=window.sessionStorage.getItem("what-intent"))}catch(e){}y("input"),y("intent")},_=function(e){var t=e.which,r=d[e.type];"pointer"===r&&(r=A(e));var s=!c.length&&-1===l.indexOf(t),a=c.length&&-1!==c.indexOf(t),u="keyboard"===r&&t&&(s||a)||"mouse"===r||"touch"===r;if(C(r)&&(u=!1),u&&n!==r&&(S("input",n=r),y("input")),u&&i!==r){var m=document.activeElement;m&&m.nodeName&&(-1===o.indexOf(m.nodeName.toLowerCase())||"button"===m.nodeName.toLowerCase()&&!I(m,"form"))&&(S("intent",i=r),y("intent"))}},y=function(t){e.setAttribute("data-what"+t,"input"===t?n:i),k(t)},b=function(e){var t=d[e.type];"pointer"===t&&(t=A(e)),R(e),(!u&&!C(t)||u&&"wheel"===e.type||"mousewheel"===e.type||"DOMMouseScroll"===e.type)&&i!==t&&(S("intent",i=t),y("intent"))},E=function(n){n.target.nodeName?(t=n.target.nodeName.toLowerCase(),e.setAttribute("data-whatelement",t),n.target.classList&&n.target.classList.length&&e.setAttribute("data-whatclasses",n.target.classList.toString().replace(" ",","))):w()},w=function(){t=null,e.removeAttribute("data-whatelement"),e.removeAttribute("data-whatclasses")},S=function(e,t){if(s)try{window.sessionStorage.setItem("what-"+e,t)}catch(e){}},A=function(e){return"number"==typeof e.pointerType?p[e.pointerType]:"pen"===e.pointerType?"touch":e.pointerType},C=function(e){var t=Date.now(),i="mouse"===e&&"touch"===n&&t-r<200;return r=t,i},x=function(){return"onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll"},k=function(e){for(var t=0,r=a.length;t<r;t++)a[t].type===e&&a[t].fn.call(void 0,"input"===e?n:i)},R=function(e){m.x!==e.screenX||m.y!==e.screenY?(u=!1,m.x=e.screenX,m.y=e.screenY):u=!0},I=function(e,t){var n=window.Element.prototype;if(n.matches||(n.matches=n.msMatchesSelector||n.webkitMatchesSelector),n.closest)return e.closest(t);do{if(e.matches(t))return e;e=e.parentElement||e.parentNode}while(null!==e&&1===e.nodeType);return null};return"addEventListener"in window&&Array.prototype.indexOf&&(d[x()]="mouse",v()),{ask:function(e){return"intent"===e?i:n},element:function(){return t},ignoreKeys:function(e){l=e},specificKeys:function(e){c=e},registerOnChange:function(e,t){a.push({fn:e,type:t||"input"})},unRegisterOnChange:function(e){var t=function(e){for(var t=0,n=a.length;t<n;t++)if(a[t].fn===e)return t}(e);(t||0===t)&&a.splice(t,1)},clearStorage:function(){window.sessionStorage.clear()}}}()}])},e.exports=t()},"./src/effects lazy recursive ^\\.\\/.*$ referencedExports: default":(e,t,n)=>{var i={"./":["./src/effects/index.ts",9],"./ICanvasEffect":["./src/effects/ICanvasEffect.ts",7,5215],"./ICanvasEffect.ts":["./src/effects/ICanvasEffect.ts",7,5215],"./confetti":["./src/effects/confetti/index.ts",9,2382],"./confetti/":["./src/effects/confetti/index.ts",9,2382],"./confetti/index":["./src/effects/confetti/index.ts",9,2382],"./confetti/index.ts":["./src/effects/confetti/index.ts",9,2382],"./effect":["./src/effects/effect.ts",9,3508],"./effect.ts":["./src/effects/effect.ts",9,3508],"./fireworks":["./src/effects/fireworks/index.ts",9,3636],"./fireworks/":["./src/effects/fireworks/index.ts",9,3636],"./fireworks/index":["./src/effects/fireworks/index.ts",9,3636],"./fireworks/index.ts":["./src/effects/fireworks/index.ts",9,3636],"./hearts":["./src/effects/hearts/index.ts",9,1095],"./hearts/":["./src/effects/hearts/index.ts",9,1095],"./hearts/index":["./src/effects/hearts/index.ts",9,1095],"./hearts/index.ts":["./src/effects/hearts/index.ts",9,1095],"./index":["./src/effects/index.ts",9],"./index.ts":["./src/effects/index.ts",9],"./rainfall":["./src/effects/rainfall/index.ts",9,3197],"./rainfall/":["./src/effects/rainfall/index.ts",9,3197],"./rainfall/index":["./src/effects/rainfall/index.ts",9,3197],"./rainfall/index.ts":["./src/effects/rainfall/index.ts",9,3197],"./snowfall":["./src/effects/snowfall/index.ts",9,2792],"./snowfall/":["./src/effects/snowfall/index.ts",9,2792],"./snowfall/index":["./src/effects/snowfall/index.ts",9,2792],"./snowfall/index.ts":["./src/effects/snowfall/index.ts",9,2792],"./spaceinvaders":["./src/effects/spaceinvaders/index.ts",9,4522],"./spaceinvaders/":["./src/effects/spaceinvaders/index.ts",9,4522],"./spaceinvaders/index":["./src/effects/spaceinvaders/index.ts",9,4522],"./spaceinvaders/index.ts":["./src/effects/spaceinvaders/index.ts",9,4522],"./utils":["./src/effects/utils.ts",9],"./utils.ts":["./src/effects/utils.ts",9]};function r(e){if(!n.o(i,e))return Promise.resolve().then((()=>{var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}));var t=i[e],r=t[0];return Promise.all(t.slice(2).map(n.e)).then((()=>n.t(r,16|t[1])))}r.keys=()=>Object.keys(i),r.id="./src/effects lazy recursive ^\\.\\/.*$ referencedExports: default",e.exports=r},"./node_modules/@vector-im/compound-design-tokens/assets/web/icons/check-circle-solid.js":(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n("./node_modules/react/index.js"),r=n("./node_modules/react/jsx-runtime.js");function s(e,t){return(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,r.jsx)("path",{d:"m10.6 13.8-2.15-2.15a.948.948 0 0 0-.7-.275.948.948 0 0 0-.7.275.948.948 0 0 0-.275.7.95.95 0 0 0 .275.7L9.9 15.9c.2.2.433.3.7.3.267 0 .5-.1.7-.3l5.65-5.65a.948.948 0 0 0 .275-.7.948.948 0 0 0-.275-.7.948.948 0 0 0-.7-.275.948.948 0 0 0-.7.275L10.6 13.8ZM12 22a9.738 9.738 0 0 1-3.9-.788 10.099 10.099 0 0 1-3.175-2.137c-.9-.9-1.612-1.958-2.137-3.175A9.738 9.738 0 0 1 2 12a9.74 9.74 0 0 1 .788-3.9 10.099 10.099 0 0 1 2.137-3.175c.9-.9 1.958-1.612 3.175-2.137A9.738 9.738 0 0 1 12 2a9.74 9.74 0 0 1 3.9.788 10.098 10.098 0 0 1 3.175 2.137c.9.9 1.613 1.958 2.137 3.175A9.738 9.738 0 0 1 22 12a9.738 9.738 0 0 1-.788 3.9 10.098 10.098 0 0 1-2.137 3.175c-.9.9-1.958 1.613-3.175 2.137A9.738 9.738 0 0 1 12 22Z"})})}s.displayName="CheckCircleSolidIcon";const o=(0,i.forwardRef)(s)},"./node_modules/@vector-im/compound-design-tokens/assets/web/icons/minus.js":(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n("./node_modules/react/index.js"),r=n("./node_modules/react/jsx-runtime.js");function s(e,t){return(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,r.jsx)("path",{d:"M6 13a.967.967 0 0 1-.713-.287A.968.968 0 0 1 5 12c0-.283.096-.52.287-.713A.967.967 0 0 1 6 11h12a.97.97 0 0 1 .712.287c.192.192.288.43.288.713s-.096.52-.288.713A.968.968 0 0 1 18 13H6Z"})})}s.displayName="MinusIcon";const o=(0,i.forwardRef)(s)},"./node_modules/@vector-im/compound-design-tokens/assets/web/icons/plus.js":(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n("./node_modules/react/index.js"),r=n("./node_modules/react/jsx-runtime.js");function s(e,t){return(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,r.jsx)("path",{d:"M11 13H6a.967.967 0 0 1-.713-.287A.968.968 0 0 1 5 12c0-.283.096-.52.287-.713A.967.967 0 0 1 6 11h5V6c0-.283.096-.52.287-.713A.968.968 0 0 1 12 5c.283 0 .52.096.713.287.191.192.287.43.287.713v5h5a.97.97 0 0 1 .712.287c.192.192.288.43.288.713s-.096.52-.288.713A.968.968 0 0 1 18 13h-5v5a.97.97 0 0 1-.287.712A.968.968 0 0 1 12 19a.968.968 0 0 1-.713-.288A.968.968 0 0 1 11 18v-5Z"})})}s.displayName="PlusIcon";const o=(0,i.forwardRef)(s)}}]);
//# sourceMappingURL=4613.js.map