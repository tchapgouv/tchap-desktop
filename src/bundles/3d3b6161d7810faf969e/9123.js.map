{"version":3,"file":"bundles/3d3b6161d7810faf969e/9123.js","mappings":"6mBAmBKA,EAAK,SAALA,GAAK,OAALA,EAAK,uBAALA,EAAK,YAALA,CAAK,EAALA,GAAK,IA2BK,MAAMC,UAA8BC,EAAAA,cACxCC,WAAAA,CAAYC,GACfC,MAAMD,IAAOE,EAAAA,EAAAA,GAAA,qBAgBMC,UACnBC,KAAKC,SAAS,CACVC,WAAOC,IAEX,MAAMC,EAAMC,EAAAA,EAAgBC,UAC5B,UAE4CF,EAAIG,cAAcC,eAQhDC,EAAAA,EAAAA,KAA0BV,UAC5B,MAAMW,EAASN,EAAIO,YACnB,IAAKD,EACD,MAAM,IAAIE,MAAM,sEAQdR,EAAIG,cAAcM,IAAI,4BAItBH,EAAOI,gBAAgB,UAnB3BC,EAAAA,EAAAA,KAAoBhB,cAuB9BC,KAAKC,SAAS,CACVe,MAAOxB,EAAMyB,MAErB,CAAE,MAAOC,GACLC,EAAAA,EAAOjB,MAAM,4BAA6BgB,GAK1ClB,KAAKC,SAAS,CACVC,OAAO,GAEf,MACHJ,EAAAA,EAAAA,GAAA,iBAEkB,KACfE,KAAKJ,MAAMwB,YAAW,EAAM,KAC/BtB,EAAAA,EAAAA,GAAA,eAEgB,KACbE,KAAKJ,MAAMwB,YAAW,EAAK,IApE3BpB,KAAKqB,MAAQ,CACTL,MAAOxB,EAAM8B,UACbC,WAAY,GACZC,iBAAiB,EACjBC,kBAAmB,GACnBC,QAAQ,EACRC,YAAY,EAEpB,CAEOC,iBAAAA,GACH5B,KAAK6B,cACT,CA2DQC,eAAAA,GACJ,OACIpC,EAAAA,cAAA,WACIA,EAAAA,cAACqC,EAAAA,EAAO,MAGpB,CAEQC,eAAAA,GACJ,OACItC,EAAAA,cAAA,WACIA,EAAAA,cAAA,UAAIuC,EAAAA,EAAAA,IAAG,2CACPvC,EAAAA,cAACwC,EAAAA,EAAa,CAACC,eAAeF,EAAAA,EAAAA,IAAG,aAAcG,qBAAsBpC,KAAKqC,OAAQC,WAAW,IAGzG,CAEQC,aAAAA,CAAcvB,GAClB,OAAQA,GACJ,KAAKxB,EAAM8B,UACP,OAAOW,EAAAA,EAAAA,IAAG,uCACd,KAAKzC,EAAMyB,KACP,OAAOgB,EAAAA,EAAAA,IAAG,sCACd,QACI,OAAOA,EAAAA,EAAAA,IAAG,oCAEtB,CAEOO,MAAAA,GACH,IAAIC,EACJ,GAAIzC,KAAKqB,MAAMnB,MACXuC,EACI/C,EAAAA,cAAA,WACIA,EAAAA,cAAA,UAAIuC,EAAAA,EAAAA,IAAG,6CACPvC,EAAAA,cAACwC,EAAAA,EAAa,CACVC,eAAeF,EAAAA,EAAAA,IAAG,gBAClBG,qBAAsBpC,KAAK6B,aAC3BS,WAAW,EACXI,SAAU1C,KAAK0C,iBAK3B,OAAQ1C,KAAKqB,MAAML,OACf,KAAKxB,EAAM8B,UACPmB,EAAUzC,KAAK8B,kBACf,MACJ,KAAKtC,EAAMyB,KACPwB,EAAUzC,KAAKgC,kBAK3B,OACItC,EAAAA,cAACiD,EAAAA,EAAU,CACPC,UAAU,2BACVxB,WAAYpB,KAAKJ,MAAMwB,WACvByB,MAAO7C,KAAKuC,cAAcvC,KAAKqB,MAAML,OACrCsB,UAAW,CAAC9C,EAAMyB,MAAM6B,SAAS9C,KAAKqB,MAAML,QAE5CtB,EAAAA,cAAA,WAAM+C,GAGlB,E","sources":["webpack://element-web/./src/async-components/views/dialogs/security/CreateKeyBackupDialog.tsx"],"sourcesContent":["/*\nCopyright 2024 New Vector Ltd.\nCopyright 2019, 2020 The Matrix.org Foundation C.I.C.\nCopyright 2018, 2019 New Vector Ltd\n\nSPDX-License-Identifier: AGPL-3.0-only OR GPL-3.0-only\nPlease see LICENSE files in the repository root for full details.\n*/\n\nimport React from \"react\";\nimport { logger } from \"matrix-js-sdk/src/logger\";\n\nimport { MatrixClientPeg } from \"../../../../MatrixClientPeg\";\nimport { _t } from \"../../../../languageHandler\";\nimport { accessSecretStorage, withSecretStorageKeyCache } from \"../../../../SecurityManager\";\nimport Spinner from \"../../../../components/views/elements/Spinner\";\nimport BaseDialog from \"../../../../components/views/dialogs/BaseDialog\";\nimport DialogButtons from \"../../../../components/views/elements/DialogButtons\";\n\nenum Phase {\n    BackingUp = \"backing_up\",\n    Done = \"done\",\n}\n\ninterface IProps {\n    onFinished(done?: boolean): void;\n}\n\ninterface IState {\n    phase: Phase;\n    passPhrase: string;\n    passPhraseValid: boolean;\n    passPhraseConfirm: string;\n    copied: boolean;\n    downloaded: boolean;\n    error?: boolean;\n}\n\n/**\n * Walks the user through the process of setting up e2e key backups to a new backup, and storing the decryption key in\n * SSSS.\n *\n * Uses {@link accessSecretStorage}, which means that if 4S is not already configured, it will be bootstrapped (which\n * involves displaying an {@link CreateSecretStorageDialog} so the user can enter a passphrase and/or download the 4S\n * key).\n */\nexport default class CreateKeyBackupDialog extends React.PureComponent<IProps, IState> {\n    public constructor(props: IProps) {\n        super(props);\n\n        this.state = {\n            phase: Phase.BackingUp,\n            passPhrase: \"\",\n            passPhraseValid: false,\n            passPhraseConfirm: \"\",\n            copied: false,\n            downloaded: false,\n        };\n    }\n\n    public componentDidMount(): void {\n        this.createBackup();\n    }\n\n    private createBackup = async (): Promise<void> => {\n        this.setState({\n            error: undefined,\n        });\n        const cli = MatrixClientPeg.safeGet();\n        try {\n            // Check if 4S already set up\n            const secretStorageAlreadySetup = await cli.secretStorage.hasKey();\n\n            if (!secretStorageAlreadySetup) {\n                // bootstrap secret storage; that will also create a backup version\n                await accessSecretStorage(async (): Promise<void> => {\n                    // do nothing, all is now set up correctly\n                });\n            } else {\n                await withSecretStorageKeyCache(async () => {\n                    const crypto = cli.getCrypto();\n                    if (!crypto) {\n                        throw new Error(\"End-to-end encryption is disabled - unable to create backup.\");\n                    }\n\n                    // Before we reset the backup, let's make sure we can access secret storage, to\n                    // reduce the chance of us getting into a broken state where we have an outdated\n                    // secret in secret storage.\n                    // `SecretStorage.get` will ask the user to enter their passphrase/key if necessary;\n                    // it will then be cached for the actual backup reset operation.\n                    await cli.secretStorage.get(\"m.megolm_backup.v1\");\n\n                    // We now know we can store the new backup key in secret storage, so it is safe to\n                    // go ahead with the reset.\n                    await crypto.resetKeyBackup();\n                });\n            }\n\n            this.setState({\n                phase: Phase.Done,\n            });\n        } catch (e) {\n            logger.error(\"Error creating key backup\", e);\n            // TODO: If creating a version succeeds, but backup fails, should we\n            // delete the version, disable backup, or do nothing?  If we just\n            // disable without deleting, we'll enable on next app reload since\n            // it is trusted.\n            this.setState({\n                error: true,\n            });\n        }\n    };\n\n    private onCancel = (): void => {\n        this.props.onFinished(false);\n    };\n\n    private onDone = (): void => {\n        this.props.onFinished(true);\n    };\n\n    private renderBusyPhase(): JSX.Element {\n        return (\n            <div>\n                <Spinner />\n            </div>\n        );\n    }\n\n    private renderPhaseDone(): JSX.Element {\n        return (\n            <div>\n                <p>{_t(\"settings|key_backup|backup_in_progress\")}</p>\n                <DialogButtons primaryButton={_t(\"action|ok\")} onPrimaryButtonClick={this.onDone} hasCancel={false} />\n            </div>\n        );\n    }\n\n    private titleForPhase(phase: Phase): string {\n        switch (phase) {\n            case Phase.BackingUp:\n                return _t(\"settings|key_backup|backup_starting\");\n            case Phase.Done:\n                return _t(\"settings|key_backup|backup_success\");\n            default:\n                return _t(\"settings|key_backup|create_title\");\n        }\n    }\n\n    public render(): React.ReactNode {\n        let content;\n        if (this.state.error) {\n            content = (\n                <div>\n                    <p>{_t(\"settings|key_backup|cannot_create_backup\")}</p>\n                    <DialogButtons\n                        primaryButton={_t(\"action|retry\")}\n                        onPrimaryButtonClick={this.createBackup}\n                        hasCancel={true}\n                        onCancel={this.onCancel}\n                    />\n                </div>\n            );\n        } else {\n            switch (this.state.phase) {\n                case Phase.BackingUp:\n                    content = this.renderBusyPhase();\n                    break;\n                case Phase.Done:\n                    content = this.renderPhaseDone();\n                    break;\n            }\n        }\n\n        return (\n            <BaseDialog\n                className=\"mx_CreateKeyBackupDialog\"\n                onFinished={this.props.onFinished}\n                title={this.titleForPhase(this.state.phase)}\n                hasCancel={[Phase.Done].includes(this.state.phase)}\n            >\n                <div>{content}</div>\n            </BaseDialog>\n        );\n    }\n}\n"],"names":["Phase","CreateKeyBackupDialog","React","constructor","props","super","_defineProperty","async","this","setState","error","undefined","cli","MatrixClientPeg","safeGet","secretStorage","hasKey","withSecretStorageKeyCache","crypto","getCrypto","Error","get","resetKeyBackup","accessSecretStorage","phase","Done","e","logger","onFinished","state","BackingUp","passPhrase","passPhraseValid","passPhraseConfirm","copied","downloaded","componentDidMount","createBackup","renderBusyPhase","Spinner","renderPhaseDone","_t","DialogButtons","primaryButton","onPrimaryButtonClick","onDone","hasCancel","titleForPhase","render","content","onCancel","BaseDialog","className","title","includes"],"sourceRoot":""}