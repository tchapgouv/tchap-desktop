"use strict";(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[7766],{"./src/components/views/location/LocationButton.tsx":(e,t,o)=>{o.r(t),o.d(t,{default:()=>ae});var n=o("./node_modules/react/index.js"),s=o("./node_modules/classnames/index.js"),a=o.n(s),i=o("./src/languageHandler.tsx"),r=o("./src/components/views/rooms/CollapsibleButton.tsx"),l=o("./src/components/structures/ContextMenu.tsx"),c=o("./src/components/views/rooms/MessageComposerButtons.tsx"),m=o("./node_modules/@babel/runtime/helpers/esm/extends.js"),d=o("./src/contexts/MatrixClientContext.tsx"),p=o("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),u=o("./node_modules/maplibre-gl/dist/maplibre-gl.js"),h=o.n(u),_=o("./node_modules/matrix-js-sdk/src/logger.ts"),v=o("./node_modules/matrix-js-sdk/src/matrix.ts"),g=o("./src/Modal.tsx"),b=o("./src/utils/WellKnownUtils.ts"),k=o("./src/utils/beacon/index.ts"),x=o("./src/utils/location/index.ts"),y=o("./src/components/views/dialogs/ErrorDialog.tsx"),E=o("./src/components/views/elements/AccessibleButton.tsx"),C=o("./src/components/views/location/MapError.tsx"),A=o("./src/DateUtils.ts"),L=o("./src/components/views/elements/Dropdown.tsx");const S={fifteenMins:9e5,oneHour:36e5,eightHours:288e5},w=S.fifteenMins,f=e=>(0,i._t)("location_sharing|live_share_button",{duration:(0,A.a3)(e)}),M=({timeout:e,onChange:t})=>{const o=Object.values(S).map((e=>({key:e.toString(),duration:e,label:f(e)})));Object.values(S).includes(e)||o.push({key:e.toString(),duration:e,label:f(e)});return n.createElement(L.A,{id:"live-duration",label:f(e),value:e.toString(),onOptionChange:e=>{t(+e)},className:"mx_LiveDurationDropdown"},o.map((({key:e,label:t})=>n.createElement("div",{key:e},t))))};var N=o("./src/components/views/dialogs/QuestionDialog.tsx"),T=o("./src/SdkConfig.ts"),P=o("./src/stores/OwnBeaconStore.ts"),B=o("./src/utils/local-room.ts");let O=function(e){return e.Own="Own",e.Pin="Pin",e.Live="Live",e}({});const D=(e,t,o)=>{const{modalParams:n,errorMessage:s}="M_FORBIDDEN"===e.errcode?(e=>{const t=e===O.Live?"Insufficient permissions to start sharing your live location":"Insufficient permissions to send your location";return{modalParams:{title:(0,i._t)("location_sharing|error_no_perms_title"),description:(0,i._t)("location_sharing|error_no_perms_description"),button:(0,i._t)("action|ok"),hasCancelButton:!1,onFinished:()=>{}},errorMessage:t}})(o):((e,t)=>{const o=e===O.Live?"We couldn't start sharing your live location":"We couldn't send your location";return{modalParams:{title:(0,i._t)("location_sharing|error_send_title"),description:(0,i._t)("location_sharing|error_send_description",{brand:T.Ay.get().brand}),button:(0,i._t)("action|try_again"),cancelButton:(0,i._t)("action|cancel"),onFinished:e=>{e&&t()}},errorMessage:o}})(o,t);_.v.error(s,e),g.Ay.createDialog(N.A,n)};var F=o("./src/components/views/location/Marker.tsx");const I=e=>e===O.Own||e===O.Live;class j extends n.Component{constructor(e,t){super(e,t),(0,p.A)(this,"map",void 0),(0,p.A)(this,"geolocate",void 0),(0,p.A)(this,"marker",void 0),(0,p.A)(this,"getMarkerId",(()=>"mx_MLocationPicker_marker")),(0,p.A)(this,"addMarkerToMap",(()=>{var e;this.marker=new(h().Marker)({element:null!==(e=document.getElementById(this.getMarkerId()))&&void 0!==e?e:void 0,anchor:"bottom",offset:[0,-1]}).setLngLat(new(h().LngLat)(0,0)).addTo(this.map)})),(0,p.A)(this,"updateStyleUrl",(e=>{var t;const o=null===(t=(0,b.XP)(e))||void 0===t?void 0:t.map_style_url;var n;o&&(null===(n=this.map)||void 0===n||n.setStyle(o))})),(0,p.A)(this,"onGeolocate",(e=>{var t;this.marker||this.addMarkerToMap(),this.setState({position:(0,k.v9)(e)}),null===(t=this.marker)||void 0===t||t.setLngLat(new(h().LngLat)(e.coords.longitude,e.coords.latitude))})),(0,p.A)(this,"onClick",(e=>{var t;this.marker||this.addMarkerToMap(),null===(t=this.marker)||void 0===t||t.setLngLat(e.lngLat),this.setState({position:{timestamp:Date.now(),latitude:e.lngLat.lat,longitude:e.lngLat.lng}})})),(0,p.A)(this,"onGeolocateError",(e=>{var t;(_.v.error("Could not fetch location",e),I(this.props.shareType)&&(this.props.onFinished(),g.Ay.createDialog(y.A,{title:(0,i._t)("location_sharing|error_fetch_location"),description:(0,x.Ff)(e.code)})),this.geolocate)&&(null===(t=this.map)||void 0===t||t.removeControl(this.geolocate))})),(0,p.A)(this,"onTimeoutChange",(e=>{this.setState({timeout:e})})),(0,p.A)(this,"onOk",(()=>{const{timeout:e,position:t}=this.state;this.props.onChoose(t?{uri:(0,k.mt)(t),timestamp:t.timestamp,timeout:e}:{timeout:e}),this.props.onFinished()})),this.state={position:void 0,timeout:w,error:void 0}}componentDidMount(){this.context.on(v.ClientEvent.ClientWellKnown,this.updateStyleUrl);try{if(this.map=new(h().Map)({container:"mx_LocationPicker_map",style:(0,x.M0)(this.context),center:[0,0],zoom:1}),this.geolocate=new(h().GeolocateControl)({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!1}),this.map.addControl(this.geolocate),this.map.on("error",(e=>{_.v.error("Failed to load map: check map_style_url in config.json has a valid URL and API key",e.error),this.setState({error:x.$X.MapStyleUrlNotReachable})})),this.map.on("load",(()=>{var e;null===(e=this.geolocate)||void 0===e||e.trigger()})),this.geolocate.on("error",this.onGeolocateError),I(this.props.shareType)&&this.geolocate.on("geolocate",this.onGeolocate),this.props.shareType===O.Pin){const e=new(h().NavigationControl)({showCompass:!1,showZoom:!0});this.map.addControl(e,"bottom-right"),this.map.on("click",this.onClick)}}catch(e){_.v.error("Failed to render map",e);const t=null==e?void 0:e.message;let o;o=t===x.$X.MapStyleUrlNotConfigured?x.$X.MapStyleUrlNotConfigured:t.includes("Failed to initialize WebGL")?x.$X.WebGLNotEnabled:x.$X.Default,this.setState({error:o})}}componentWillUnmount(){var e,t,o;null===(e=this.geolocate)||void 0===e||e.off("error",this.onGeolocateError),null===(t=this.geolocate)||void 0===t||t.off("geolocate",this.onGeolocate),null===(o=this.map)||void 0===o||o.off("click",this.onClick),this.context.off(v.ClientEvent.ClientWellKnown,this.updateStyleUrl)}render(){return this.state.error?n.createElement("div",{className:"mx_LocationPicker mx_LocationPicker_hasError"},n.createElement(C.p,{error:this.state.error,onFinished:this.props.onFinished})):n.createElement("div",{className:"mx_LocationPicker"},n.createElement("div",{id:"mx_LocationPicker_map"}),this.props.shareType===O.Pin&&n.createElement("div",{className:"mx_LocationPicker_pinText"},n.createElement("span",null,this.state.position?(0,i._t)("location_sharing|click_move_pin"):(0,i._t)("location_sharing|click_drop_pin"))),n.createElement("div",{className:"mx_LocationPicker_footer"},n.createElement("form",{onSubmit:this.onOk},this.props.shareType===O.Live&&n.createElement(M,{onChange:this.onTimeoutChange,timeout:this.state.timeout}),n.createElement(E.A,{type:"submit",element:"button",kind:"primary",className:"mx_LocationPicker_submitButton",disabled:!this.state.position,onClick:this.onOk},(0,i._t)("location_sharing|share_button")))),n.createElement("div",{id:this.getMarkerId()},!!this.marker&&n.createElement(F.A,{roomMember:I(this.props.shareType)?this.props.sender:void 0,useMemberColor:this.props.shareType===O.Live})))}}(0,p.A)(j,"contextType",d.Ay);const U=j;var G=o("./src/settings/SettingsStore.ts"),H=o("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/close.js"),W=o("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/chevron-left.js");const R=({onBack:e,onCancel:t,displayBack:o})=>n.createElement("div",{className:"mx_ShareDialogButtons"},o&&n.createElement(E.A,{className:"mx_ShareDialogButtons_button left","aria-label":(0,i._t)("action|back"),onClick:e,element:"button"},n.createElement(W.A,{className:"mx_ShareDialogButtons_button-icon"})),n.createElement(E.A,{className:"mx_ShareDialogButtons_button right","aria-label":(0,i._t)("action|close"),onClick:t,element:"button"},n.createElement(H.A,{className:"mx_ShareDialogButtons_button-icon"})));var $=o("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),z=o("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/location-pin-solid.js"),X=o("./src/stores/OwnProfileStore.ts"),V=o("./src/components/views/avatars/BaseAvatar.tsx"),K=o("./src/components/views/typography/Heading.tsx"),J=o("./src/components/views/beacon/StyledLiveBeaconIcon.tsx");const Y=["onClick","label","shareType"],Z=()=>{var e,t;const o=(0,n.useContext)(d.Ay).getSafeUserId(),s=null!==(e=X.V.instance.displayName)&&void 0!==e?e:void 0,a="36px",i=null!==(t=X.V.instance.getHttpAvatarUrl(parseInt(a,10)))&&void 0!==t?t:void 0;return n.createElement("div",{className:`mx_ShareType_option-icon ${O.Own}`},n.createElement(V.A,{idName:o,name:s,url:i,size:a,className:"mx_UserMenu_userAvatar_BaseAvatar"}))},q=e=>{let{onClick:t,label:o,shareType:s}=e,a=(0,$.A)(e,Y);return n.createElement(E.A,(0,m.A)({element:"button",className:"mx_ShareType_option",onClick:null!=t?t:null},a),s===O.Own&&n.createElement(Z,null),s===O.Pin&&n.createElement(z.A,{className:`mx_ShareType_option-icon ${O.Pin}`}),s===O.Live&&n.createElement(J.A,{className:`mx_ShareType_option-icon ${O.Live}`}),o)},Q=({setShareType:e,enabledShareTypes:t})=>{const o={[O.Own]:(0,i._t)("location_sharing|share_type_own"),[O.Live]:(0,i._t)("location_sharing|share_type_live"),[O.Pin]:(0,i._t)("location_sharing|share_type_pin")};return n.createElement("div",{className:"mx_ShareType"},n.createElement(z.A,{className:"mx_ShareType_badge"}),n.createElement(K.A,{className:"mx_ShareType_heading",size:"3"},(0,i._t)("location_sharing|share_type_prompt")),n.createElement("div",{className:"mx_ShareType_wrapper_options"},t.map((t=>n.createElement(q,{key:t,onClick:()=>e(t),label:o[t],shareType:t})))))};var ee=o("./src/components/views/elements/LabelledToggleSwitch.tsx");const te=({onSubmit:e})=>{const[t,o]=(0,n.useState)(!1);return n.createElement("div",{className:"mx_EnableLiveShare"},n.createElement(J.A,{className:"mx_EnableLiveShare_icon"}),n.createElement(K.A,{className:"mx_EnableLiveShare_heading",size:"3"},(0,i._t)("location_sharing|live_enable_heading")),n.createElement("p",{className:"mx_EnableLiveShare_description"},(0,i._t)("location_sharing|live_enable_description")),n.createElement(ee.A,{value:t,onChange:o,label:(0,i._t)("location_sharing|live_toggle_label")}),n.createElement(E.A,{className:"mx_EnableLiveShare_button",element:"button",kind:"primary",onClick:e,disabled:!t},(0,i._t)("action|ok")))};var oe=o("./src/hooks/useSettings.ts"),ne=o("./src/settings/SettingLevel.ts");const se=({menuPosition:e,onFinished:t,sender:o,roomId:s,openMenu:a,relation:r})=>{const c=(0,n.useContext)(d.Ay),p=(e=>{const t=[O.Own];return e||t.push(O.Live),t.push(O.Pin),t})(r),u=(0,oe.ny)("feature_location_share_live"),h=p.length>1,[_,g]=(0,n.useState)(h?void 0:O.Own),b=X.V.instance.displayName,k=c.getSafeUserId(),x=_===O.Live?((e,t,o,n)=>async({timeout:e})=>{const s=(0,i._t)("location_sharing|live_description",{displayName:o});try{await P.g.instance.createLiveBeacon(t,v.ContentHelpers.makeBeaconInfoContent(null!=e?e:3e5,!0,s,v.LocationAssetType.Self))}catch(e){D(e,n,O.Live)}})(0,s,b||k,a):((e,t,o,n,s)=>async({uri:a,timestamp:i})=>{if(a)try{const s=(null==n?void 0:n.rel_type)===v.THREAD_RELATION_TYPE.name&&(null==n?void 0:n.event_id)||null,r=o===O.Pin?v.LocationAssetType.Pin:v.LocationAssetType.Self,l=v.ContentHelpers.makeLocationContent(void 0,a,i,void 0,r);await(0,B.Y)(t,(t=>e.sendMessage(t,s,l)),e)}catch(e){D(e,s,o)}})(c,s,null!=_?_:O.Own,r,a),y=_===O.Live&&!u;return n.createElement(l.Ay,(0,m.A)({},e,{onFinished:t,managed:!1}),n.createElement("div",{className:"mx_LocationShareMenu"},y&&n.createElement(te,{onSubmit:()=>{G.A.setValue("feature_location_share_live",null,ne.p.DEVICE,!0)}}),!y&&!!_&&n.createElement(U,{sender:o,shareType:_,onChoose:x,onFinished:t}),!_&&n.createElement(Q,{setShareType:g,enabledShareTypes:p}),n.createElement(R,{displayBack:!!_&&h,onBack:()=>g(void 0),onCancel:t})))},ae=({roomId:e,sender:t,menuPosition:o,relation:s})=>{const m=(0,n.useContext)(c.ZF),[d,p,u,h]=(0,l.EF)(),_=e=>{h(e),null==m||m()};let v=null;if(d){var g;const a=null!==(g=null!=o?o:p.current&&(0,l.qv)(p.current.getBoundingClientRect()))&&void 0!==g?g:{};v=n.createElement(se,{menuPosition:a,onFinished:_,sender:t,roomId:e,openMenu:u,relation:s})}const b=a()("mx_MessageComposer_button",{mx_MessageComposer_button_highlight:d});return n.createElement(n.Fragment,null,n.createElement(r.J,{className:b,iconClassName:"mx_MessageComposer_location",onClick:u,title:(0,i._t)("common|location"),inputRef:p}),v)}},"./src/components/views/location/Marker.tsx":(e,t,o)=>{o.d(t,{A:()=>m});var n=o("./node_modules/react/index.js"),s=o("./node_modules/classnames/index.js"),a=o.n(s),i=o("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/location-pin-solid.js"),r=o("./src/utils/FormattingUtils.ts"),l=o("./src/components/views/avatars/MemberAvatar.tsx");const c=({tooltip:e,children:t})=>{const[o,s]=(0,n.useState)(!1);if(!e)return n.createElement(n.Fragment,null,t);return n.createElement("div",{onMouseEnter:()=>s(!0),onClick:e=>{e.stopPropagation(),s(!o)},onMouseLeave:()=>s(!1)},t,o&&e)},m=n.forwardRef((({id:e,roomMember:t,useMemberColor:o,tooltip:s},m)=>{const d=o&&t?(0,r.yJ)(t.userId):"";return n.createElement("div",{ref:m,id:e,className:a()("mx_Marker",d,{mx_Marker_defaultColor:!d})},n.createElement(c,{tooltip:s},n.createElement("div",{className:"mx_Marker_border"},t?n.createElement(l.A,{member:t,size:"36px",viewUserOnClick:!1,hideTitle:!!s}):n.createElement(i.A,{className:"mx_Marker_icon"}))))}))}}]);
//# sourceMappingURL=7766.js.map