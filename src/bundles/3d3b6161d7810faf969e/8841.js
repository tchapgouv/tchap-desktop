/*! For license information please see 8841.js.LICENSE.txt */
(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[8841],{"./node_modules/@vector-im/compound-design-tokens/icons/overflow-horizontal.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="icons/overflow-horizontal.103407e.svg"},"./res/img/e2e/verified-deprecated.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/e2e/verified-deprecated.9030dfd.svg"},"./res/img/element-icons/settings/inactive.svg":(e,t,n)=>{"use strict";n.d(t,{I:()=>a});var i,s=n("./node_modules/react/index.js");function r(){return r=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},r.apply(null,arguments)}var o=function(e,t){return s.createElement("svg",r({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 8 14",role:"presentation","aria-hidden":!0,ref:t},e),i||(i=s.createElement("path",{fill:"currentColor",d:"M1.333.333C.6.333 0 .933 0 1.666l.007 2.12c0 .354.14.687.386.94L2.667 7 .393 9.286a1.33 1.33 0 0 0-.386.94L0 12.333c0 .733.6 1.333 1.333 1.333h5.334c.733 0 1.333-.6 1.333-1.333v-2.107c0-.353-.14-.693-.387-.94L5.333 7l2.274-2.267C7.86 4.48 8 4.14 8 3.786v-2.12C8 .933 7.4.333 6.667.333zm5.334 9.94v1.393c0 .367-.3.667-.667.667H2a.67.67 0 0 1-.667-.667v-1.393c0-.18.074-.347.194-.473L4 7.333l2.473 2.473c.12.12.194.294.194.467"})))},a=(0,s.forwardRef)(o)},"./src/DecryptionFailureTracker.ts":(e,t,n)=>{"use strict";n.d(t,{o:()=>p});var i,s=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=n("./node_modules/bloom-filters/dist/bloom/scalable-bloom-filter.js"),o=n.n(r),a=n("./node_modules/matrix-js-sdk/src/matrix.ts"),l=n("./node_modules/matrix-js-sdk/src/crypto-api/index.ts"),c=n("./src/PosthogAnalytics.ts"),d=n("./src/utils/crypto/index.ts");function h(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}const u="mx_decryption_failure_event_ids";class m{constructor(e,t,n,i,r,o){(0,s.A)(this,"timeToDecryptMillis",void 0),this.failedEventId=e,this.errorCode=t,this.ts=n,this.isFederated=i,this.wasVisibleToUser=r,this.userTrustsOwnIdentity=o}}class p{constructor(e,t,n=!0){if((0,s.A)(this,"failures",new Map),(0,s.A)(this,"visibleEvents",new Set),(0,s.A)(this,"reportedEvents",new(o())),(0,s.A)(this,"checkInterval",null),(0,s.A)(this,"trackInterval",null),(0,s.A)(this,"baseProperties",{}),(0,s.A)(this,"userDomain",void 0),(0,s.A)(this,"userTrustsOwnIdentity",void 0),(0,s.A)(this,"checkingVerificationStatus",!1),(0,s.A)(this,"retryVerificationStatus",!1),this.fn=e,this.errorCodeMapFn=t,this.checkReportedEvents=n,!e||"function"!=typeof e)throw new Error("DecryptionFailureTracker requires tracking function");if("function"!=typeof t)throw new Error("DecryptionFailureTracker second constructor argument should be a function")}static get instance(){return p.internalInstance}loadReportedEvents(){const e=localStorage.getItem(u);this.reportedEvents=e?o().fromJSON(JSON.parse(e)):new(o())}saveReportedEvents(){localStorage.setItem(u,JSON.stringify(this.reportedEvents.saveAsJSON()))}eventDecrypted(e,t){if(e.getWireContent().algorithm!=d.Q)return;const n=e.decryptionFailureReason;if(null===n)return void this.removeDecryptionFailuresForEvent(e,t);const i=e.getId();if(this.reportedEvents.has(i)&&this.checkReportedEvents)return;const s=this.failures.get(i),r=s?s.ts:t,o=e.getSender(),a=null==o?void 0:o.replace(/^.*?:/,"");let l;void 0!==this.userDomain&&void 0!==a&&(l=this.userDomain!==a);const c=this.visibleEvents.has(i);this.failures.set(i,new m(i,n,r,l,c,this.userTrustsOwnIdentity))}addVisibleEvent(e){const t=e.getId();if(this.reportedEvents.has(t)&&this.checkReportedEvents)return;const n=this.failures.get(t);n&&(n.wasVisibleToUser=!0),this.visibleEvents.add(t)}removeDecryptionFailuresForEvent(e,t){const n=e.getId(),i=this.failures.get(n);if(i){this.failures.delete(n);const e=t-i.ts;if(e<p.GRACE_PERIOD_MS)return;e<=p.MAXIMUM_LATE_DECRYPTION_PERIOD&&(i.timeToDecryptMillis=e),this.reportFailure(i)}}async handleKeysChanged(e){if(this.checkingVerificationStatus)this.retryVerificationStatus=!0;else{this.checkingVerificationStatus=!0;try{do{this.retryVerificationStatus=!1,this.userTrustsOwnIdentity=(await e.getCrypto().getUserVerificationStatus(e.getUserId())).isCrossSigningVerified()}while(this.retryVerificationStatus)}finally{this.checkingVerificationStatus=!1}}}async start(e){this.loadReportedEvents(),await this.calculateClientProperties(e),this.registerHandlers(e),this.checkInterval=window.setInterval((()=>this.checkFailures(Date.now())),p.CHECK_INTERVAL_MS)}async calculateClientProperties(e){var t;const n={};this.baseProperties=n,this.userDomain=null!==(t=e.getDomain())&&void 0!==t?t:void 0,"matrix.org"===this.userDomain?n.isMatrixDotOrg=!0:void 0!==this.userDomain&&(n.isMatrixDotOrg=!1);const i=e.getCrypto();if(i){i.getVersion().startsWith("Rust SDK")?n.cryptoSDK="Rust":n.cryptoSDK="Legacy",this.userTrustsOwnIdentity=(await i.getUserVerificationStatus(e.getUserId())).isCrossSigningVerified()}}registerHandlers(e){const t=e=>this.eventDecrypted(e,Date.now()),n=()=>{this.handleKeysChanged(e).catch((e=>{console.log("Error handling KeysChanged event",e)}))},i=()=>{e.removeListener(a.MatrixEventEvent.Decrypted,t),e.removeListener(l.CryptoEvent.KeysChanged,n),e.removeListener(a.HttpApiEvent.SessionLoggedOut,i),this.stop()};e.on(a.MatrixEventEvent.Decrypted,t),e.on(l.CryptoEvent.KeysChanged,n),e.on(a.HttpApiEvent.SessionLoggedOut,i)}stop(){this.checkInterval&&clearInterval(this.checkInterval),this.trackInterval&&clearInterval(this.trackInterval),this.userTrustsOwnIdentity=void 0,this.failures=new Map,this.visibleEvents=new Set}checkFailures(e){const t=new Map;for(const[n,i]of this.failures)void 0!==i.timeToDecryptMillis||e>i.ts+p.MAXIMUM_LATE_DECRYPTION_PERIOD?this.reportFailure(i):t.set(n,i);this.failures=t,this.saveReportedEvents()}reportFailure(e){var t;const n=e.errorCode,i=this.errorCodeMapFn(n),s={timeToDecryptMillis:null!==(t=e.timeToDecryptMillis)&&void 0!==t?t:-1,wasVisibleToUser:e.wasVisibleToUser};void 0!==e.isFederated&&(s.isFederated=e.isFederated),void 0!==e.userTrustsOwnIdentity&&(s.userTrustsOwnIdentity=e.userTrustsOwnIdentity),this.baseProperties&&Object.assign(s,this.baseProperties),this.fn(i,n,s),this.reportedEvents.add(e.failedEventId),this.visibleEvents.delete(e.failedEventId)}}i=p,(0,s.A)(p,"internalInstance",new i(((e,t,n)=>{const i=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?h(Object(n),!0).forEach((function(t){(0,s.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):h(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({eventName:"Error",domain:"E2EE",name:e,context:`mxc_crypto_error_type_${t}`},n);c.Vo.instance.trackEvent(i)}),(e=>{switch(e){case l.DecryptionFailureCode.MEGOLM_UNKNOWN_INBOUND_SESSION_ID:case l.DecryptionFailureCode.MEGOLM_KEY_WITHHELD:return"OlmKeysNotSentError";case l.DecryptionFailureCode.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE:return"RoomKeysWithheldForUnverifiedDevice";case l.DecryptionFailureCode.OLM_UNKNOWN_MESSAGE_INDEX:return"OlmIndexError";case l.DecryptionFailureCode.HISTORICAL_MESSAGE_NO_KEY_BACKUP:case l.DecryptionFailureCode.HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED:case l.DecryptionFailureCode.HISTORICAL_MESSAGE_WORKING_BACKUP:return"HistoricalMessage";case l.DecryptionFailureCode.HISTORICAL_MESSAGE_USER_NOT_JOINED:return"ExpectedDueToMembership";case l.DecryptionFailureCode.SENDER_IDENTITY_PREVIOUSLY_VERIFIED:return"ExpectedVerificationViolation";case l.DecryptionFailureCode.UNSIGNED_SENDER_DEVICE:return"ExpectedSentByInsecureDevice";default:return"UnknownError"}}))),(0,s.A)(p,"CHECK_INTERVAL_MS",4e4),(0,s.A)(p,"GRACE_PERIOD_MS",4e3),(0,s.A)(p,"MAXIMUM_LATE_DECRYPTION_PERIOD",6e4)},"./src/Lifecycle.ts":(e,t,n)=>{"use strict";n.d(t,{AK:()=>Dn,hP:()=>Tn,yl:()=>Pn,kQ:()=>qn,b:()=>Kn,L6:()=>kn,ri:()=>Gn,MV:()=>Sn,S4:()=>Fn,QC:()=>Un,hF:()=>zn,NN:()=>$n});var i=n("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),s=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=n("./node_modules/matrix-js-sdk/src/matrix.ts"),o=n("./node_modules/matrix-js-sdk/src/logger.ts"),a=n("./src/MatrixClientPeg.ts"),l=n("./src/modules/ModuleRunner.ts"),c=n("./src/indexing/EventIndexPeg.ts"),d=n("./src/utils/createMatrixClient.ts"),h=n("./src/Notifier.ts"),u=n("./src/UserActivity.ts"),m=n("./src/dispatcher/dispatcher.ts"),p=n("./src/utils/Timer.ts");const v=new class{constructor(){(0,s.A)(this,"unavailableTimer",void 0),(0,s.A)(this,"dispatcherRef",void 0),(0,s.A)(this,"state",void 0),(0,s.A)(this,"onAction",(e=>{var t;"user_activity"===e.action&&(this.setState(r.SetPresence.Online),null===(t=this.unavailableTimer)||void 0===t||t.restart())}))}async start(){for(this.unavailableTimer=new p.A(18e4),this.dispatcherRef=m.A.register(this.onAction);this.unavailableTimer;)try{await this.unavailableTimer.finished(),this.setState(r.SetPresence.Unavailable)}catch{}}stop(){var e;m.A.unregister(this.dispatcherRef),this.dispatcherRef=void 0,null===(e=this.unavailableTimer)||void 0===e||e.abort(),this.unavailableTimer=void 0}getState(){var e;return null!==(e=this.state)&&void 0!==e?e:null}async setState(e){if(e===this.state)return;const t=this.state;if(this.state=e,!a.J.safeGet().isGuest())try{await a.J.safeGet().setSyncPresence(this.state),o.v.debug("Presence:",e)}catch(e){o.v.error("Failed to set presence:",e),this.state=t}}};var g=n("./src/utils/DMRoomMap.ts"),f=n("./src/Modal.tsx"),_=n("./src/stores/ActiveWidgetStore.ts"),y=n("./src/PlatformPeg.ts"),E=n("./src/Login.ts"),x=n("./src/utils/StorageManager.ts"),w=n("./src/utils/StorageAccess.ts"),A=n("./src/settings/SettingsStore.ts"),C=n("./src/settings/SettingLevel.ts"),b=n("./src/stores/ToastStore.ts"),S=n("./src/integrations/IntegrationManagers.ts"),R=n("./src/mjolnir/Mjolnir.ts"),I=n("./node_modules/matrix-js-sdk/src/crypto-api/index.ts"),k=n("./src/PosthogAnalytics.ts"),T=n("./src/languageHandler.tsx"),D=n("./src/components/views/toasts/GenericToast.tsx"),N=n("./src/dispatcher/actions.ts");const M="mx_snooze_bulk_unverified_device_nag",O="reviewsessions",P=e=>{b.A.sharedInstance().addOrReplaceToast({key:O,title:(0,T._t)("encryption|verification|unverified_sessions_toast_title"),icon:"verification_warning",props:{description:(0,T._t)("encryption|verification|unverified_sessions_toast_description"),primaryLabel:(0,T._t)("action|review"),onPrimaryClick:()=>{he.sharedInstance().dismissUnverifiedSessions(e),m.A.dispatch({action:N.r.ViewUserDeviceSettings})},secondaryLabel:(0,T._t)("encryption|verification|unverified_sessions_toast_reject"),onSecondaryClick:()=>{he.sharedInstance().dismissUnverifiedSessions(e),(()=>{try{localStorage.setItem(M,String(Date.now()))}catch(e){o.v.error("Failed to persist bulk unverified device nag snooze",e)}})()}},component:D.A,priority:50})};var j=n("./src/components/views/dialogs/security/SetupEncryptionDialog.tsx"),F=n("./src/SecurityManager.ts"),U=n("./src/stores/SetupEncryptionStore.ts"),B=n("./src/components/views/elements/Spinner.tsx");const L="setupencryption",V=e=>{switch(e){case K.SET_UP_ENCRYPTION:return(0,T._t)("encryption|set_up_toast_title");case K.VERIFY_THIS_SESSION:return(0,T._t)("encryption|verify_toast_title")}},H=e=>{switch(e){case K.SET_UP_ENCRYPTION:return"secure_backup";case K.VERIFY_THIS_SESSION:return"verification_warning"}},G=e=>{switch(e){case K.SET_UP_ENCRYPTION:return(0,T._t)("action|enable");case K.VERIFY_THIS_SESSION:return(0,T._t)("action|verify")}},z=e=>{switch(e){case K.SET_UP_ENCRYPTION:return(0,T._t)("encryption|set_up_toast_description");case K.VERIFY_THIS_SESSION:return(0,T._t)("encryption|verify_toast_description")}};let K=function(e){return e.SET_UP_ENCRYPTION="set_up_encryption",e.VERIFY_THIS_SESSION="verify_this_session",e}({});const q=()=>{he.sharedInstance().dismissEncryptionSetup()},J=e=>{if(l.r.instance.extensions.cryptoSetup.setupEncryptionNeeded({kind:e,storeProvider:{getInstance:()=>U.s.sharedInstance()}}))return;b.A.sharedInstance().addOrReplaceToast({key:L,title:V(e),icon:H(e),props:{description:z(e),primaryLabel:G(e),onPrimaryClick:async()=>{if(e===K.VERIFY_THIS_SESSION)f.Ay.createDialog(j.A,{},void 0,!1,!0);else{const e=f.Ay.createDialog(B.A,void 0,"mx_Dialog_spinner",!1,!0);try{await(0,F.cb)()}finally{e.close()}}},secondaryLabel:(0,T._t)("encryption|verification|unverified_sessions_toast_reject"),onSecondaryClick:q,destructive:"secondary"},component:D.A,priority:e===K.VERIFY_THIS_SESSION?95:40})},W=()=>{b.A.sharedInstance().dismissToast(L)};var Y=n("./node_modules/react/index.js"),$=n("./src/utils/device/isDeviceVerified.ts"),Q=n("./src/utils/device/parseUserAgent.ts"),X=n("./src/components/views/settings/devices/DeviceMetaData.tsx");function Z(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function ee(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Z(Object(n),!0).forEach((function(t){(0,s.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Z(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function te(e){return"unverified_session_"+e}const ne=async e=>{const t=a.J.safeGet(),n=await t.getDevice(e),i=ee(ee({},n),{},{isVerified:await(0,$.z)(t,e),deviceType:Q.b.Unknown});b.A.sharedInstance().addOrReplaceToast({key:te(e),title:(0,T._t)("encryption|verification|unverified_session_toast_title"),icon:"verification_warning",props:{description:n.display_name,detail:Y.createElement(X.e,{device:i}),primaryLabel:(0,T._t)("encryption|verification|unverified_session_toast_accept"),onPrimaryClick:()=>{he.sharedInstance().dismissUnverifiedSessions([e])},secondaryLabel:(0,T._t)("action|no"),onSecondaryClick:()=>{he.sharedInstance().dismissUnverifiedSessions([e]),m.A.dispatch({action:N.r.ViewUserDeviceSettings})},destructive:"secondary"},component:D.A,priority:80})},ie=e=>{b.A.sharedInstance().dismissToast(te(e))};var se=n("./src/utils/WellKnownUtils.ts"),re=n("./src/Views.ts");var oe=n("./src/SdkConfig.ts"),ae=n("./src/utils/device/clientInformation.ts"),le=n("./src/settings/UIFeature.ts"),ce=n("./src/utils/crypto/deviceInfo.ts"),de=n("./src/utils/arrays.ts");class he{constructor(){(0,s.A)(this,"dispatcherRef",void 0),(0,s.A)(this,"dismissed",new Set),(0,s.A)(this,"dismissedThisDeviceToast",!1),(0,s.A)(this,"keyBackupInfo",null),(0,s.A)(this,"keyBackupFetchedAt",null),(0,s.A)(this,"ourDeviceIdsAtStart",null),(0,s.A)(this,"displayingToastsForDeviceIds",new Set),(0,s.A)(this,"running",!1),(0,s.A)(this,"client",void 0),(0,s.A)(this,"shouldRecordClientInformation",!1),(0,s.A)(this,"enableBulkUnverifiedSessionsReminder",!0),(0,s.A)(this,"deviceClientInformationSettingWatcherRef",void 0),(0,s.A)(this,"analyticsVerificationState",void 0),(0,s.A)(this,"analyticsRecoveryState",void 0),(0,s.A)(this,"onDevicesUpdated",(async(e,t)=>{if(!this.client)return;if(t)return;const n=this.client.getSafeUserId();e.includes(n)&&await this.ensureDeviceIdsAtStartPopulated(),this.recheck()})),(0,s.A)(this,"onUserTrustStatusChanged",(e=>{this.client&&e===this.client.getUserId()&&this.recheck()})),(0,s.A)(this,"onCrossSingingKeysChanged",(()=>{this.recheck()})),(0,s.A)(this,"onAccountData",(e=>{(e.getType().startsWith("m.secret_storage.")||e.getType().startsWith("m.cross_signing.")||"m.megolm_backup.v1"===e.getType())&&this.recheck()})),(0,s.A)(this,"onSync",((e,t)=>{"PREPARED"===e&&null===t&&this.recheck()})),(0,s.A)(this,"onRoomStateEvents",(e=>{e.getType()===r.EventType.RoomEncryption&&this.recheck()})),(0,s.A)(this,"onAction",(({action:e})=>{e===N.r.OnLoggedIn&&(this.recheck(),this.updateClientInformation())})),(0,s.A)(this,"checkKeyBackupStatus",(async()=>{var e;if(this.keyBackupStatusChecked||!this.client)return;const t=await(null===(e=this.client.getCrypto())||void 0===e?void 0:e.getActiveSessionBackupVersion());this.keyBackupStatusChecked=!!t,t||m.A.dispatch({action:N.r.ReportKeyBackupNotEnabled})})),(0,s.A)(this,"keyBackupStatusChecked",!1),(0,s.A)(this,"onRecordClientInformationSettingChange",((e,t,n,i,s)=>{const r=this.shouldRecordClientInformation;this.shouldRecordClientInformation=!!s,this.shouldRecordClientInformation!==r&&this.updateClientInformation()})),(0,s.A)(this,"updateClientInformation",(async()=>{if(this.client)try{var e;if(this.shouldRecordClientInformation)await(0,ae.Zx)(this.client,oe.Ay.get(),null!==(e=y.A.get())&&void 0!==e?e:void 0);else await(0,ae.BW)(this.client)}catch(e){o.v.error("Failed to update client information",e)}}))}static sharedInstance(){return window.mxDeviceListener||(window.mxDeviceListener=new he),window.mxDeviceListener}start(e){this.running=!0,this.client=e,this.client.on(I.CryptoEvent.DevicesUpdated,this.onDevicesUpdated),this.client.on(I.CryptoEvent.UserTrustStatusChanged,this.onUserTrustStatusChanged),this.client.on(I.CryptoEvent.KeysChanged,this.onCrossSingingKeysChanged),this.client.on(r.ClientEvent.AccountData,this.onAccountData),this.client.on(r.ClientEvent.Sync,this.onSync),this.client.on(r.RoomStateEvent.Events,this.onRoomStateEvents),this.shouldRecordClientInformation=A.A.getValue("deviceClientInformationOptIn"),this.enableBulkUnverifiedSessionsReminder=A.A.getValue(le.f.BulkUnverifiedSessionsReminder),this.deviceClientInformationSettingWatcherRef=A.A.watchSetting("deviceClientInformationOptIn",null,this.onRecordClientInformationSettingChange),this.dispatcherRef=m.A.register(this.onAction),this.recheck(),this.updateClientInformation()}stop(){this.running=!1,this.client&&(this.client.removeListener(I.CryptoEvent.DevicesUpdated,this.onDevicesUpdated),this.client.removeListener(I.CryptoEvent.UserTrustStatusChanged,this.onUserTrustStatusChanged),this.client.removeListener(I.CryptoEvent.KeysChanged,this.onCrossSingingKeysChanged),this.client.removeListener(r.ClientEvent.AccountData,this.onAccountData),this.client.removeListener(r.ClientEvent.Sync,this.onSync),this.client.removeListener(r.RoomStateEvent.Events,this.onRoomStateEvents)),A.A.unwatchSetting(this.deviceClientInformationSettingWatcherRef),m.A.unregister(this.dispatcherRef),this.dispatcherRef=void 0,this.dismissed.clear(),this.dismissedThisDeviceToast=!1,this.keyBackupInfo=null,this.keyBackupFetchedAt=null,this.keyBackupStatusChecked=!1,this.ourDeviceIdsAtStart=null,this.displayingToastsForDeviceIds=new Set,this.client=void 0}async dismissUnverifiedSessions(e){o.v.log("Dismissing unverified sessions: "+Array.from(e).join(","));for(const t of e)this.dismissed.add(t);this.recheck()}dismissEncryptionSetup(){this.dismissedThisDeviceToast=!0,this.recheck()}async ensureDeviceIdsAtStartPopulated(){null===this.ourDeviceIdsAtStart&&(this.ourDeviceIdsAtStart=await this.getDeviceIds())}async getDeviceIds(){const e=this.client;return e?await(0,ce.a)(e,e.getSafeUserId()):new Set}async getKeyBackupInfo(){if(!this.client)return null;const e=(new Date).getTime(),t=this.client.getCrypto();return t?((!this.keyBackupInfo||!this.keyBackupFetchedAt||this.keyBackupFetchedAt<e-3e5)&&(this.keyBackupInfo=await t.getKeyBackupInfo(),this.keyBackupFetchedAt=e),this.keyBackupInfo):null}async shouldShowSetupEncryptionToast(){if((0,F.kq)())return!1;const e=this.client,t=null==e?void 0:e.getCrypto();return!(!e||!t)&&await(0,de.qM)(e.getRooms(),(({roomId:e})=>t.isEncryptionEnabledInRoom(e)))}recheck(){this.doRecheck().catch((e=>{e instanceof r.ClientStoppedError||o.v.error("Error during `DeviceListener.recheck`",e)}))}async doRecheck(){var e;if(!this.running||!this.client)return;const t=this.client;if(!await t.isVersionSupported("v1.1"))return;const n=t.getCrypto();if(!n)return;if(!t.isInitialSyncComplete())return;const i=await n.isCrossSigningReady(),s=await n.isSecretStorageReady(),r=i&&s;var a;await this.reportCryptoSessionStateToAnalytics(t),this.dismissedThisDeviceToast||r?(W(),this.checkKeyBackupStatus()):await this.shouldShowSetupEncryptionToast()&&(await n.getUserDeviceInfo([t.getSafeUserId()]),!await n.getCrossSigningKeyId()&&await n.userHasCrossSigningKeys()?(J(K.VERIFY_THIS_SESSION),this.checkKeyBackupStatus()):(await t.waitForClientWellKnown(),(0,se.R$)(t)&&(null===(a=window.matrixChat)||void 0===a?void 0:a.state.view)===re.A.LOGGED_IN?(W(),(0,F.cb)()):J(K.SET_UP_ENCRYPTION))),await this.ensureDeviceIdsAtStartPopulated();const l=new Set,c=new Set,d=i&&Boolean(null===(e=await n.getDeviceVerificationStatus(t.getSafeUserId(),t.deviceId))||void 0===e?void 0:e.crossSigningVerified);if(i){const e=await this.getDeviceIds();for(const i of e){if(i===t.deviceId)continue;const e=await n.getDeviceVerificationStatus(t.getSafeUserId(),i);var h;if(!(null!=e&&e.crossSigningVerified||this.dismissed.has(i)))null!==(h=this.ourDeviceIdsAtStart)&&void 0!==h&&h.has(i)?l.add(i):c.add(i)}}o.v.debug("Old unverified sessions: "+Array.from(l).join(",")),o.v.debug("New unverified sessions: "+Array.from(c).join(",")),o.v.debug("Currently showing toasts for: "+Array.from(this.displayingToastsForDeviceIds).join(","));const u=(()=>{try{const e=localStorage.getItem(M),t=Number.parseInt(e||"",10);return Number.isInteger(t)&&t+6048e5>Date.now()}catch{return!1}})();l.size>0&&d&&this.enableBulkUnverifiedSessionsReminder&&!u?P(l):b.A.sharedInstance().dismissToast(O);for(const e of c)ne(e);for(const e of this.displayingToastsForDeviceIds)c.has(e)||(o.v.debug("Hiding unverified session toast for "+e),ie(e));this.displayingToastsForDeviceIds=c}async reportCryptoSessionStateToAnalytics(e){const t=e.getCrypto(),n=await t.isSecretStorageReady(),i=await t.getCrossSigningStatus(),s=await this.getKeyBackupInfo(),r=null!=await e.secretStorage.getDefaultKeyId(),o=await t.getDeviceVerificationStatus(e.getUserId(),e.getDeviceId()),a=null!=o&&o.signedByOwner&&null!=o&&o.crossSigningVerified?"Verified":"NotVerified";let l;if(r){const e=i.privateKeysCachedLocally.masterKey&&i.privateKeysCachedLocally.selfSigningKey&&i.privateKeysCachedLocally.userSigningKey;if(null!=s){const i=null!=await t.getSessionBackupPrivateKey();l=n&&e&&i?"Enabled":"Incomplete"}else l=n&&e?"Enabled":"Incomplete"}else l="Disabled";this.analyticsVerificationState===a&&this.analyticsRecoveryState===l||(this.analyticsRecoveryState=l,this.analyticsVerificationState=a,k.Vo.instance.setProperty("recoveryState",l),k.Vo.instance.setProperty("verificationState",a),k.Vo.instance.trackEvent({eventName:"CryptoSessionState",verificationState:a,recoveryState:l}))}}var ue=n("./src/widgets/Jitsi.ts"),me=n("./src/BasePlatform.ts"),pe=n("./src/stores/ThreepidInviteStore.ts"),ve=n("./src/LegacyCallHandler.tsx");const ge={};var fe=n("./src/components/views/dialogs/ErrorDialog.tsx"),_e=n("./src/components/views/dialogs/QuestionDialog.tsx"),ye=n("./src/components/views/dialogs/BugReportDialog.tsx"),Ee=n("./src/components/views/dialogs/BaseDialog.tsx"),xe=n("./src/components/views/elements/DialogButtons.tsx");class we extends Y.Component{constructor(...e){super(...e),(0,s.A)(this,"sendBugReport",(()=>{f.Ay.createDialog(ye.A,{error:this.props.error})})),(0,s.A)(this,"onClearStorageClick",(()=>{f.Ay.createDialog(_e.A,{title:(0,T._t)("action|sign_out"),description:Y.createElement("div",null,(0,T._t)("error|session_restore|clear_storage_description")),button:(0,T._t)("action|sign_out"),danger:!0,onFinished:this.props.onFinished})})),(0,s.A)(this,"onRefreshClick",(()=>{window.location.reload()}))}render(){const e=oe.Ay.get().brand,t=Y.createElement("button",{onClick:this.onClearStorageClick,className:"danger"},(0,T._t)("error|session_restore|clear_storage_button"));let n;return n=oe.Ay.get().bug_report_endpoint_url?Y.createElement(xe.A,{primaryButton:(0,T._t)("bug_reporting|send_logs"),onPrimaryButtonClick:this.sendBugReport,focus:!0,hasCancel:!1},t):Y.createElement(xe.A,{primaryButton:(0,T._t)("action|refresh"),onPrimaryButtonClick:this.onRefreshClick,focus:!0,hasCancel:!1},t),Y.createElement(Ee.A,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:(0,T._t)("error|session_restore|title"),contentId:"mx_Dialog_content",hasCancel:!1},Y.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},Y.createElement("p",null,(0,T._t)("error|session_restore|description_1")),Y.createElement("p",null,(0,T._t)("error|session_restore|description_2",{brand:e})),Y.createElement("p",null,(0,T._t)("error|session_restore|description_3"))),n)}}var Ae=n("./src/components/views/elements/AccessibleButton.tsx");class Ce extends Y.Component{constructor(...e){super(...e),(0,s.A)(this,"sendBugReport",(e=>{e.preventDefault(),f.Ay.createDialog(ye.A,{})})),(0,s.A)(this,"onSignOutClick",(()=>{this.props.onFinished(!0)}))}render(){let e;return oe.Ay.get().bug_report_endpoint_url&&(e=(0,T._t)("bug_reporting|log_request",{},{a:e=>Y.createElement(Ae.A,{kind:"link_inline",onClick:this.sendBugReport},e)})),Y.createElement(Ee.A,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:(0,T._t)("error|storage_evicted_title"),contentId:"mx_Dialog_content",hasCancel:!1},Y.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},Y.createElement("p",null,(0,T._t)("error|storage_evicted_description_1")),Y.createElement("p",null,(0,T._t)("error|storage_evicted_description_2")," ",e)),Y.createElement(xe.A,{primaryButton:(0,T._t)("action|sign_out"),onPrimaryButtonClick:this.onSignOutClick,focus:!0,hasCancel:!1}))}}var be=n("./src/sentry.ts"),Se=n("./node_modules/classnames/index.js"),Re=n.n(Se),Ie=n("./src/components/views/dialogs/RoomSettingsDialog.tsx"),ke=n("./node_modules/matrix-js-sdk/src/types.ts"),Te=n("./node_modules/@vector-im/compound-design-tokens/icons/overflow-horizontal.svg"),De=n("./src/hooks/useSettings.ts"),Ne=n("./src/settings/enums/Layout.ts"),Me=n("./src/Avatar.ts"),Oe=n("./src/components/views/rooms/EventTile.tsx"),Pe=n("./src/components/structures/SearchBox.tsx"),je=n("./src/components/views/avatars/DecoratedRoomAvatar.tsx"),Fe=n("./src/components/structures/AutoHideScrollbar.tsx"),Ue=n("./src/stores/notifications/StaticNotificationState.ts"),Be=n("./src/components/views/rooms/NotificationBadge.tsx"),Le=n("./src/stores/room-list/algorithms/tag-sorting/RecentAlgorithm.ts"),Ve=n("./src/autocomplete/QueryMatcher.ts"),He=n("./src/components/views/elements/TruncatedList.tsx"),Ge=n("./src/components/views/rooms/EntityTile.tsx"),ze=n("./src/components/views/avatars/BaseAvatar.tsx"),Ke=n("./src/utils/EventUtils.ts"),qe=n("./src/utils/location/index.ts"),Je=n("./src/components/views/rooms/RoomContextDetails.tsx"),We=n("./src/accessibility/RovingTabIndex.tsx"),Ye=n("./src/KeyBindingsManager.ts"),$e=n("./src/accessibility/KeyboardShortcuts.ts");const Qe=["m.relates_to"];function Xe(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Ze(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Xe(Object(n),!0).forEach((function(t){(0,s.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Xe(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var et=function(e){return e[e.CanSend=0]="CanSend",e[e.Sending=1]="Sending",e[e.Sent=2]="Sent",e[e.Failed=3]="Failed",e}(et||{});const tt=({room:e,type:t,content:n,matrixClient:i,onFinished:s})=>{const[r,o]=(0,Y.useState)(et.CanSend),[a,l,c]=(0,We.A9)();let d,h,u,p=!1;r===et.CanSend?(d="mx_ForwardList_canSend",e.maySendMessage()||(p=!0,h=(0,T._t)("forward|no_perms_title"))):r===et.Sending?(d="mx_ForwardList_sending",p=!0,h=(0,T._t)("forward|sending"),u=Y.createElement("div",{className:"mx_ForwardList_sendIcon","aria-label":h})):r===et.Sent?(d="mx_ForwardList_sent",p=!0,h=(0,T._t)("forward|sent"),u=Y.createElement("div",{className:"mx_ForwardList_sendIcon","aria-label":h})):(d="mx_ForwardList_sendFailed",p=!0,h=(0,T._t)("timeline|send_state_failed"),u=Y.createElement(Be.A,{notification:Ue.d.RED_EXCLAMATION}));const v=`mx_ForwardDialog_entry_${e.roomId}`;return Y.createElement("div",{className:Re()("mx_ForwardList_entry",{mx_ForwardList_entry_active:l}),"aria-labelledby":`${v}_name`,"aria-describedby":`${v}_send`,role:"listitem",ref:c,onFocus:a,id:v},Y.createElement(Ae.A,{className:"mx_ForwardList_roomButton",onClick:t=>{m.A.dispatch({action:N.r.ViewRoom,room_id:e.roomId,metricsTrigger:"WebForwardShortcut",metricsViaKeyboard:"click"!==t.type}),s(!0)},title:(0,T._t)("forward|open_room"),placement:"top",tabIndex:l?0:-1},Y.createElement(je.A,{room:e,size:"32px",tooltipProps:{tabIndex:l?0:-1}}),Y.createElement("span",{className:"mx_ForwardList_entry_name",id:`${v}_name`},e.name),Y.createElement(Je.n,{component:"span",className:"mx_ForwardList_entry_detail",room:e})),Y.createElement(Ae.A,{kind:r===et.Failed?"danger_outline":"primary_outline",className:`mx_ForwardList_sendButton ${d}`,onClick:async()=>{o(et.Sending);try{await i.sendEvent(e.roomId,t,n),o(et.Sent)}catch{o(et.Failed)}},disabled:p,title:h,placement:"top",tabIndex:l?0:-1,id:`${v}_send`},Y.createElement("div",{className:"mx_ForwardList_sendLabel"},(0,T._t)("forward|send_label")),u))},nt=({matrixClient:e,event:t,permalinkCreator:n,onFinished:s})=>{const o=e.getSafeUserId(),[a,l]=(0,Y.useState)({});(0,Y.useEffect)((()=>{e.getProfileInfo(o).then((e=>l(e)))}),[e,o]);const{type:c,content:d}=(e=>{const t=e.getContent(),{"m.relates_to":n}=t,s=(0,i.A)(t,Qe),o=r.M_BEACON.matches(e.getType())?r.EventType.RoomMessage:e.getType();if((0,Ke.wq)(e)&&(0,qe.qy)(s)||r.M_BEACON.matches(e.getType())){const t=r.M_TIMESTAMP.findIn(s),n=(0,qe.jm)(e);return{type:o,content:Ze(Ze({},s),r.ContentHelpers.makeLocationContent(void 0,n,t||Date.now(),void 0,r.LocationAssetType.Pin))}}return{type:o,content:s}})(t),h=new r.MatrixEvent({type:"m.room.message",sender:o,content:d,unsigned:{age:97},event_id:"$9999999999999999999999999999999999999999999",room_id:t.getRoomId(),origin_server_ts:t.getTs()});h.sender={name:a.displayname||o,rawDisplayName:a.displayname,userId:o,getAvatarUrl:(...e)=>(0,Me.r4)({avatarUrl:a.avatar_url},30,30,"crop"),getMxcAvatarUrl:()=>a.avatar_url};const[u,m]=(0,Y.useState)(""),p=u.toLowerCase(),v=(0,De.ti)("layout"),g=(0,De.ti)("feature_dynamic_room_predecessors");let f=(0,Y.useMemo)((()=>(0,Le.pP)(e.getVisibleRooms(g).filter((e=>e.getMyMembership()===ke.O.Join&&!e.isSpaceRoom())))),[e,g]);p&&(f=new Ve.A(f,{keys:["name"],funcs:[e=>(0,de.Bo)([e.getCanonicalAlias(),...e.getAltAliases()])],shouldMatchWordsOnly:!1}).match(p));const[_,y]=(0,Y.useState)(20);function E(e,t){const n=(0,T._t)("common|and_n_others",{count:e});return Y.createElement(Ge.A,{className:"mx_EntityTile_ellipsis",avatarJsx:Y.createElement(ze.A,{url:Te.A,name:"...",size:"36px"}),name:n,showPresence:!1,onClick:()=>y(t)})}return Y.createElement(Ee.A,{title:(0,T._t)("common|forward_message"),className:"mx_ForwardDialog",contentId:"mx_ForwardList",onFinished:s,fixedWidth:!1},Y.createElement("h3",null,(0,T._t)("forward|message_preview_heading")),Y.createElement("div",{className:Re()("mx_ForwardDialog_preview",{mx_IRCLayout:v==Ne.P.IRC})},Y.createElement(Oe.Ay,{mxEvent:h,layout:v,permalinkCreator:n,as:"div",inhibitInteraction:!0})),Y.createElement("hr",null),Y.createElement(We.Se,{handleUpDown:!0,handleInputFields:!0,onKeyDown:(e,t)=>{let n=!0;var i;(0,Ye.zM)().getAccessibilityAction(e)===$e.bY.Enter?null===(i=t.activeNode)||void 0===i||null===(i=i.querySelector(".mx_ForwardList_sendButton"))||void 0===i||i.click():n=!1;n&&(e.preventDefault(),e.stopPropagation())},scrollIntoView:{block:"center"}},(({onKeyDownHandler:t})=>Y.createElement("div",{className:"mx_ForwardList",id:"mx_ForwardList"},Y.createElement(We.ui.Consumer,null,(e=>{var n;return Y.createElement(Pe.A,{className:"mx_textinput_icon mx_textinput_search",placeholder:(0,T._t)("forward|filter_placeholder"),onSearch:t=>{m(t),setTimeout((()=>{const t=e.state.nodes[0];var n;t&&(e.dispatch({type:We.ZU.SetFocus,payload:{node:t}}),null==t||null===(n=t.scrollIntoView)||void 0===n||n.call(t,{block:"nearest"}))}))},autoFocus:!0,onKeyDown:t,"aria-activedescendant":null===(n=e.state.activeNode)||void 0===n?void 0:n.id,"aria-owns":"mx_ForwardDialog_resultsList"})})),Y.createElement(Fe.A,{className:"mx_ForwardList_content"},f.length>0?Y.createElement("div",{className:"mx_ForwardList_results"},Y.createElement(He.A,{id:"mx_ForwardDialog_resultsList",className:"mx_ForwardList_resultsList",truncateAt:_,createOverflowElement:E,getChildren:(t,n)=>f.slice(t,n).map((t=>Y.createElement(tt,{key:t.roomId,room:t,type:c,content:d,matrixClient:e,onFinished:s}))),getChildCount:()=>f.length})):Y.createElement("span",{className:"mx_ForwardList_noResults"},(0,T._t)("common|no_results")))))))};var it=n("./src/createRoom.ts"),st=n("./src/Markdown.ts"),rt=n("./src/components/views/elements/StyledRadioButton.tsx"),ot=n("./src/components/views/elements/Field.tsx"),at=n("./src/components/views/elements/LabelledCheckbox.tsx");const lt=["org.matrix.msc3215.room.moderation.moderated_by"];var ct=function(e){return e.Disagreement="org.matrix.msc3215.abuse.nature.disagreement",e.Toxic="org.matrix.msc3215.abuse.nature.toxic",e.Illegal="org.matrix.msc3215.abuse.nature.illegal",e.Spam="org.matrix.msc3215.abuse.nature.spam",e.Other="org.matrix.msc3215.abuse.nature.other",e}(ct||{}),dt=function(e){return e.Admin="non-standard.abuse.nature.admin",e}(dt||{});class ht extends Y.Component{constructor(e){super(e),(0,s.A)(this,"moderation",void 0),(0,s.A)(this,"componentDidMount",(async()=>{const e=a.J.safeGet().getCrypto(),t=this.props.mxEvent.getRoomId();e&&t&&this.setState({isRoomEncrypted:await e.isEncryptionEnabledInRoom(t)})})),(0,s.A)(this,"onIgnoreUserTooChanged",(e=>{this.setState({ignoreUserToo:e})})),(0,s.A)(this,"onReasonChange",(({target:{value:e}})=>{this.setState({reason:e})})),(0,s.A)(this,"onNatureChosen",(e=>{this.setState({nature:e.currentTarget.value})})),(0,s.A)(this,"onCancel",(()=>{this.props.onFinished(!1)})),(0,s.A)(this,"onSubmit",(async()=>{let e=this.state.reason||"";if(e=e.trim(),this.moderation){if(!this.state.nature||(this.state.nature==ct.Other||this.state.nature==dt.Admin)&&!e)return void this.setState({err:(0,T._t)("report_content|missing_reason")})}else if(!e)return void this.setState({err:(0,T._t)("report_content|missing_reason")});this.setState({busy:!0,err:void 0});try{const e=a.J.safeGet(),t=this.props.mxEvent;if(this.moderation&&this.state.nature!==dt.Admin){const n=this.state.nature,i=await(0,it.EP)(e,this.moderation.moderationBotUserId);if(!i)throw new T.P7("report_content|error_create_room_moderation_bot");await e.sendEvent(i,"org.matrix.msc3215.abuse.report",{event_id:t.getId(),room_id:t.getRoomId(),moderated_by_id:this.moderation.moderationRoomId,nature:n,reporter:e.getUserId(),comment:this.state.reason.trim()})}else await e.reportEvent(t.getRoomId(),t.getId(),-100,this.state.reason.trim());this.state.ignoreUserToo&&await e.setIgnoredUsers([...e.getIgnoredUsers(),t.getSender()]),this.props.onFinished(!0)}catch(e){o.v.error(e),this.setState({busy:!1,err:e instanceof Error?e.message:String(e)})}}));let t=null,n=null;if(A.A.getValue("feature_report_to_moderators")){const i=a.J.safeGet().getRoom(e.mxEvent.getRoomId());for(const e of lt){const s=null==i?void 0:i.currentState.getStateEvents(e,e);if(!s)continue;if(Array.isArray(s))throw new TypeError(`getStateEvents(${e}, ${e}) should return at most one state event`);const r=s.event;if(!("content"in r)||"object"!=typeof r.content){console.debug("Moderation error","state event",e,"should have an object field `content`, got",r);continue}const o=r.content;"room_id"in o&&"string"==typeof o.room_id?"user_id"in o&&"string"==typeof o.user_id?(t=o.room_id,n=o.user_id):console.debug("Moderation error","state event",e,"should have a string field `content.user_id`, got",r):console.debug("Moderation error","state event",e,"should have a string field `content.room_id`, got",r)}t&&n&&(this.moderation={moderationRoomId:t,moderationBotUserId:n})}this.state={reason:"",busy:!1,err:void 0,nature:void 0,ignoreUserToo:!1,isRoomEncrypted:!1}}render(){var e;let t,n;this.state.err&&(t=Y.createElement("div",{className:"error"},this.state.err)),this.state.busy&&(n=Y.createElement("div",{className:"progress"},Y.createElement(B.A,null)));const i=Y.createElement(at.A,{value:this.state.ignoreUserToo,label:(0,T._t)("report_content|ignore_user"),byline:(0,T._t)("report_content|hide_messages_from_user"),onChange:this.onIgnoreUserTooChanged,disabled:this.state.busy}),s=null===(e=oe.Ay.getObject("report_event"))||void 0===e?void 0:e.get("admin_message_md","adminMessageMD");let r;if(s){const e=new st.A(s).toHTML({externalLinks:!0});r=Y.createElement("p",{dangerouslySetInnerHTML:{__html:e}})}if(this.moderation){const e=oe.Ay.get("validated_server_config").hsName;let s;switch(this.state.nature){case ct.Disagreement:s=(0,T._t)("report_content|nature_disagreement");break;case ct.Toxic:s=(0,T._t)("report_content|nature_toxic");break;case ct.Illegal:s=(0,T._t)("report_content|nature_illegal");break;case ct.Spam:s=(0,T._t)("report_content|nature_spam");break;case dt.Admin:s=this.state.isRoomEncrypted?(0,T._t)("report_content|nature_nonstandard_admin_encrypted",{homeserver:e}):(0,T._t)("report_content|nature_nonstandard_admin",{homeserver:e});break;case ct.Other:s=(0,T._t)("report_content|nature_other");break;default:s=(0,T._t)("report_content|nature")}return Y.createElement(Ee.A,{className:"mx_ReportEventDialog",onFinished:this.props.onFinished,title:(0,T._t)("action|report_content"),contentId:"mx_ReportEventDialog"},Y.createElement("div",null,Y.createElement(rt.A,{name:"nature",value:ct.Disagreement,checked:this.state.nature==ct.Disagreement,onChange:this.onNatureChosen},(0,T._t)("report_content|disagree")),Y.createElement(rt.A,{name:"nature",value:ct.Toxic,checked:this.state.nature==ct.Toxic,onChange:this.onNatureChosen},(0,T._t)("report_content|toxic_behaviour")),Y.createElement(rt.A,{name:"nature",value:ct.Illegal,checked:this.state.nature==ct.Illegal,onChange:this.onNatureChosen},(0,T._t)("report_content|illegal_content")),Y.createElement(rt.A,{name:"nature",value:ct.Spam,checked:this.state.nature==ct.Spam,onChange:this.onNatureChosen},(0,T._t)("report_content|spam_or_propaganda")),Y.createElement(rt.A,{name:"nature",value:dt.Admin,checked:this.state.nature==dt.Admin,onChange:this.onNatureChosen},(0,T._t)("report_content|report_entire_room")),Y.createElement(rt.A,{name:"nature",value:ct.Other,checked:this.state.nature==ct.Other,onChange:this.onNatureChosen},(0,T._t)("report_content|other_label")),Y.createElement("p",null,s),Y.createElement(ot.A,{className:"mx_ReportEventDialog_reason",element:"textarea",label:(0,T._t)("room_settings|permissions|ban_reason"),rows:5,onChange:this.onReasonChange,value:this.state.reason,disabled:this.state.busy}),n,t,i),Y.createElement(xe.A,{primaryButton:(0,T._t)("action|send_report"),onPrimaryButtonClick:this.onSubmit,focus:!0,onCancel:this.onCancel,disabled:this.state.busy}))}return Y.createElement(Ee.A,{className:"mx_ReportEventDialog",onFinished:this.props.onFinished,title:(0,T._t)("report_content|report_content_to_homeserver"),contentId:"mx_ReportEventDialog"},Y.createElement("div",{className:"mx_ReportEventDialog",id:"mx_ReportEventDialog"},Y.createElement("p",null,(0,T._t)("report_content|description")),r,Y.createElement(ot.A,{className:"mx_ReportEventDialog_reason",element:"textarea",label:(0,T._t)("room_settings|permissions|ban_reason"),rows:5,onChange:this.onReasonChange,value:this.state.reason,disabled:this.state.busy}),n,t,i),Y.createElement(xe.A,{primaryButton:(0,T._t)("action|send_report"),onPrimaryButtonClick:this.onSubmit,focus:!0,onCancel:this.onCancel,disabled:this.state.busy}))}}var ut=n("./src/components/structures/TabbedView.tsx"),mt=n("./src/components/views/elements/StyledCheckbox.tsx"),pt=n("./src/components/views/elements/RoomName.tsx");let vt=function(e){return e.Appearance="SPACE_PREFERENCE_APPEARANCE_TAB",e}({});var gt=n("./src/components/views/settings/tabs/SettingsTab.tsx"),ft=n("./src/components/views/settings/shared/SettingsSection.tsx"),_t=n("./src/components/views/settings/shared/SettingsSubsection.tsx");const yt=({space:e})=>{const t=(0,De.ti)("Spaces.showPeopleInSpace",e.roomId);return Y.createElement(gt.A,null,Y.createElement(ft.X,{heading:(0,T._t)("space|preferences|sections_section")},Y.createElement(_t.P,null,Y.createElement(mt.A,{checked:!!t,onChange:n=>{A.A.setValue("Spaces.showPeopleInSpace",e.roomId,C.p.ROOM_ACCOUNT,!t)}},(0,T._t)("Direct Messages")),Y.createElement(_t.s,null,(0,T._t)("space|preferences|show_people_in_space",{spaceName:e.name})))))},Et=({space:e,onFinished:t})=>{const n=[new ut.oz(vt.Appearance,(0,T.AO)("common|appearance"),"mx_SpacePreferencesDialog_appearanceIcon",Y.createElement(yt,{space:e}))];return Y.createElement(Ee.A,{className:"mx_SpacePreferencesDialog",hasCancel:!0,onFinished:t,title:(0,T._t)("common|preferences"),fixedWidth:!1},Y.createElement("h4",null,Y.createElement(pt.A,{room:e})),Y.createElement("div",{className:"mx_SettingsDialog_content"},Y.createElement(ut.Ay,{tabs:n,activeTabId:vt.Appearance,onChange:()=>{}})))};var xt=n("./src/hooks/useDispatcher.ts"),wt=n("./src/components/views/spaces/SpaceBasicSettings.tsx"),At=n("./src/editor/serialize.ts"),Ct=n("./src/utils/leave-behaviour.ts"),bt=n("./src/hooks/room/useTopic.ts");const St=({matrixClient:e,space:t})=>{var n,i,s;const[a,l]=(0,Y.useState)(!1),[c,d]=(0,Y.useState)(""),h=e.getUserId(),[u,m]=(0,Y.useState)(null),p=t.currentState.maySendStateEvent(r.EventType.RoomAvatar,h),v=null!==u,[g,f]=(0,Y.useState)(t.name),_=t.currentState.maySendStateEvent(r.EventType.RoomName,h),y=g!==t.name,E=null!==(n=null===(i=(0,bt.e)(t))||void 0===i?void 0:i.text)&&void 0!==n?n:"",[x,w]=(0,Y.useState)(E),A=t.currentState.maySendStateEvent(r.EventType.RoomTopic,h),C=x!==E;return Y.createElement(gt.A,null,Y.createElement(ft.X,{heading:(0,T._t)("common|general")},Y.createElement("div",null,Y.createElement("div",null,(0,T._t)("room_settings|general|description_space")),c&&Y.createElement("div",{className:"mx_SpaceRoomView_errorText"},c),Y.createElement(wt.A,{avatarUrl:null!==(s=(0,Me.ze)(t,80,80,"crop"))&&void 0!==s?s:void 0,avatarDisabled:a||!p,setAvatar:m,name:g,nameDisabled:a||!_,setName:f,topic:x,topicDisabled:a||!A,setTopic:w}),Y.createElement(Ae.A,{onClick:()=>{m(null),f(t.name),w(E)},disabled:a||!(v||y||C),kind:"link"},(0,T._t)("action|cancel")),Y.createElement(Ae.A,{onClick:async()=>{l(!0);const n=[];if(v&&(u?n.push((async()=>{const{content_uri:n}=await e.uploadContent(u);await e.sendStateEvent(t.roomId,r.EventType.RoomAvatar,{url:n},"")})()):n.push(e.sendStateEvent(t.roomId,r.EventType.RoomAvatar,{},""))),y&&n.push(e.setRoomName(t.roomId,g)),C){const i=(0,At.Ro)(x,{forceHTML:!1});n.push(e.setRoomTopic(t.roomId,x,i))}const i=await Promise.allSettled(n);l(!1);const s=i.filter((e=>"rejected"===e.status));s.length>0&&(o.v.error("Failed to save space settings: ",s),d((0,T._t)("room_settings|general|error_save_space_settings")))},disabled:a,kind:"primary"},a?(0,T._t)("common|saving"):(0,T._t)("room_settings|general|save"))),Y.createElement(_t.P,{heading:(0,T._t)("room_settings|general|leave_space")},Y.createElement(Ae.A,{kind:"danger",onClick:()=>{(0,Ct.e)(t)}},(0,T._t)("room_settings|general|leave_space")))))};class Rt extends Y.Component{constructor(...e){super(...e),(0,s.A)(this,"state",{verifyRemove:!1}),(0,s.A)(this,"onRemove",(e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!0})})),(0,s.A)(this,"onDontRemove",(e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!1})})),(0,s.A)(this,"onActuallyRemove",(e=>{e.stopPropagation(),e.preventDefault(),this.props.onRemove&&this.props.onRemove(this.props.index),this.setState({verifyRemove:!1})}))}render(){return this.state.verifyRemove?Y.createElement("div",{className:"mx_EditableItem"},Y.createElement("span",{className:"mx_EditableItem_promptText"},(0,T._t)("common|are_you_sure")),Y.createElement(Ae.A,{onClick:this.onActuallyRemove,kind:"primary_sm",className:"mx_EditableItem_confirmBtn"},(0,T._t)("action|yes")),Y.createElement(Ae.A,{onClick:this.onDontRemove,kind:"danger_sm",className:"mx_EditableItem_confirmBtn"},(0,T._t)("action|no"))):Y.createElement("div",{className:"mx_EditableItem"},Y.createElement("div",{onClick:this.onRemove,className:"mx_EditableItem_delete",title:(0,T._t)("action|remove"),role:"button"}),Y.createElement("span",{className:"mx_EditableItem_item"},this.props.value))}}class It extends Y.PureComponent{constructor(...e){super(...e),(0,s.A)(this,"onItemAdded",(e=>{var t,n;e.stopPropagation(),e.preventDefault(),null===(t=(n=this.props).onItemAdded)||void 0===t||t.call(n,this.props.newItem)})),(0,s.A)(this,"onItemRemoved",(e=>{var t,n;null===(t=(n=this.props).onItemRemoved)||void 0===t||t.call(n,e)})),(0,s.A)(this,"onNewItemChanged",(e=>{var t,n;null===(t=(n=this.props).onNewItemChanged)||void 0===t||t.call(n,e.target.value)}))}renderNewItemField(){return Y.createElement("form",{onSubmit:this.onItemAdded,autoComplete:"off",noValidate:!0,className:"mx_EditableItemList_newItem"},Y.createElement(ot.A,{label:this.props.placeholder,type:"text",autoComplete:"off",value:this.props.newItem||"",onChange:this.onNewItemChanged,list:this.props.suggestionsListId}),Y.createElement(Ae.A,{onClick:this.onItemAdded,kind:"primary",disabled:!this.props.newItem},(0,T._t)("action|add")))}render(){const e=this.props.items.map(((e,t)=>this.props.canRemove?Y.createElement(Rt,{key:e,index:t,value:e,onRemove:this.onItemRemoved}):Y.createElement("li",{key:e},e))),t=this.props.canRemove?e:Y.createElement("ul",null,e),n=this.props.items.length>0?this.props.itemsLabel:this.props.noItemsLabel;return Y.createElement("div",{className:"mx_EditableItemList",id:this.props.id},Y.createElement("div",{className:"mx_EditableItemList_label"},n),t,this.props.canEdit?this.renderNewItemField():Y.createElement("div",null))}}var kt=n("./src/components/views/elements/LabelledToggleSwitch.tsx");const Tt={};class Dt extends Y.PureComponent{constructor(e){super(e),(0,s.A)(this,"onRoomPublishChange",(()=>{const e=this.state.isRoomPublished,t=!e;this.setState({isRoomPublished:t});a.J.safeGet().setRoomDirectoryVisibility(this.props.roomId,t?r.Visibility.Public:r.Visibility.Private).catch((()=>{this.showError(),this.setState({isRoomPublished:e})}))})),this.state={isRoomPublished:!1}}showError(){f.Ay.createDialog(fe.A,{title:(0,T._t)("room_settings|general|error_publishing"),description:(0,T._t)("room_settings|general|error_publishing_detail")})}componentDidMount(){a.J.safeGet().getRoomDirectoryVisibility(this.props.roomId).then((e=>{this.setState({isRoomPublished:"public"===e.visibility})}))}render(){var e;const t=a.J.safeGet(),n=t.getRoom(this.props.roomId),i=n&&n.getJoinRule()!==r.JoinRule.Invite,s=(!1===(null===(e=Tt.requireCanonicalAliasAccessToPublish)||void 0===e?void 0:e.call(Tt))||this.props.canSetCanonicalAlias)&&(i||this.state.isRoomPublished);return Y.createElement(kt.A,{value:this.state.isRoomPublished,onChange:this.onRoomPublishChange,disabled:!s,label:(0,T._t)("room_settings|general|publish_toggle",{domain:t.getDomain()})})}}var Nt=n("./src/components/views/elements/RoomAliasField.tsx"),Mt=n("./src/contexts/MatrixClientContext.tsx"),Ot=n("./src/components/views/settings/SettingsFieldset.tsx");class Pt extends It{constructor(...e){super(...e),(0,s.A)(this,"aliasField",(0,Y.createRef)()),(0,s.A)(this,"onAliasAdded",(async e=>{e.preventDefault(),this.aliasField.current&&(await this.aliasField.current.validate({allowEmpty:!1}),this.aliasField.current.isValid?this.props.onItemAdded&&this.props.onItemAdded(this.props.newItem):(this.aliasField.current.focus(),this.aliasField.current.validate({allowEmpty:!1,focused:!0})))}))}renderNewItemField(){return Y.createElement("form",{onSubmit:this.onAliasAdded,autoComplete:"off",noValidate:!0,className:"mx_EditableItemList_newItem"},Y.createElement(Nt.A,{ref:this.aliasField,onChange:e=>{var t,n;return null===(t=(n=this.props).onNewItemChanged)||void 0===t?void 0:t.call(n,e)},value:this.props.newItem||"",domain:this.props.domain,roomId:this.props.roomId}),Y.createElement(Ae.A,{onClick:this.onAliasAdded,kind:"primary"},(0,T._t)("action|add")))}}class jt extends Y.Component{constructor(e,t){super(e,t),(0,s.A)(this,"onNewAliasChanged",(e=>{this.setState({newAlias:e})})),(0,s.A)(this,"onLocalAliasAdded",(e=>{if(!e||0===e.length)return;const t=this.context.getDomain();e.includes(":")||(e+=":"+t),this.context.createAlias(e,this.props.roomId).then((()=>{this.setState({localAliases:this.state.localAliases.concat(e),newAlias:void 0}),this.state.canonicalAlias||this.changeCanonicalAlias(e)})).catch((e=>{o.v.error(e),f.Ay.createDialog(fe.A,{title:(0,T._t)("room_settings|general|error_creating_alias_title"),description:(0,T._t)("room_settings|general|error_creating_alias_description")})}))})),(0,s.A)(this,"onLocalAliasDeleted",(e=>{const t=this.state.localAliases[e];this.context.deleteAlias(t).then((()=>{const e=this.state.localAliases.filter((e=>e!==t));this.setState({localAliases:e}),this.state.canonicalAlias===t&&this.changeCanonicalAlias(null)})).catch((e=>{let t;o.v.error(e),t="M_FORBIDDEN"===e.errcode?(0,T._t)("room_settings|general|error_deleting_alias_description_forbidden"):(0,T._t)("room_settings|general|error_deleting_alias_description"),f.Ay.createDialog(fe.A,{title:(0,T._t)("room_settings|general|error_deleting_alias_title"),description:t})}))})),(0,s.A)(this,"onLocalAliasesToggled",(e=>{e.target.open&&(this.props.canSetCanonicalAlias||0!==this.state.localAliases.length||this.loadLocalAliases()),this.setState({detailsOpen:e.currentTarget.open})})),(0,s.A)(this,"onCanonicalAliasChange",(e=>{this.changeCanonicalAlias(e.target.value)})),(0,s.A)(this,"onNewAltAliasChanged",(e=>{this.setState({newAltAlias:e})})),(0,s.A)(this,"onAltAliasAdded",(e=>{const t=this.state.altAliases.slice();t.some((t=>t.trim()===e.trim()))||(t.push(e.trim()),this.changeAltAliases(t),this.setState({newAltAlias:""}))})),(0,s.A)(this,"onAltAliasDeleted",(e=>{const t=this.state.altAliases.slice();t.splice(e,1),this.changeAltAliases(t)}));const n={altAliases:[],localAliases:[],canonicalAlias:null,updatingCanonicalAlias:!1,localAliasesLoading:!1,detailsOpen:!1};if(e.canonicalAliasEvent){const t=e.canonicalAliasEvent.getContent(),i=t.alt_aliases;Array.isArray(i)&&(n.altAliases=i.slice()),n.canonicalAlias=t.alias}this.state=n}componentDidMount(){this.props.canSetCanonicalAlias&&this.loadLocalAliases()}async loadLocalAliases(){this.setState({localAliasesLoading:!0});try{const e=this.context;let t=[];const n=await e.getLocalAliases(this.props.roomId);Array.isArray(null==n?void 0:n.aliases)&&(t=n.aliases),this.setState({localAliases:t}),0===t.length&&this.setState({detailsOpen:!0})}finally{this.setState({localAliasesLoading:!1})}}changeCanonicalAlias(e){if(!this.props.canSetCanonicalAlias)return;const t=this.state.canonicalAlias;this.setState({canonicalAlias:e,updatingCanonicalAlias:!0});const n={alt_aliases:this.state.altAliases};e&&(n.alias=e),this.context.sendStateEvent(this.props.roomId,r.EventType.RoomCanonicalAlias,n,"").catch((e=>{o.v.error(e),f.Ay.createDialog(fe.A,{title:(0,T._t)("room_settings|general|error_updating_canonical_alias_title"),description:(0,T._t)("room_settings|general|error_updating_canonical_alias_description")}),this.setState({canonicalAlias:t})})).finally((()=>{this.setState({updatingCanonicalAlias:!1})}))}changeAltAliases(e){if(!this.props.canSetCanonicalAlias)return;this.setState({updatingCanonicalAlias:!0});const t={};this.state.canonicalAlias&&(t.alias=this.state.canonicalAlias),e&&(t.alt_aliases=e),this.context.sendStateEvent(this.props.roomId,r.EventType.RoomCanonicalAlias,t,"").then((()=>{this.setState({altAliases:e})})).catch((e=>{o.v.error(e),f.Ay.createDialog(fe.A,{title:(0,T._t)("room_settings|general|error_updating_canonical_alias_title"),description:(0,T._t)("room_settings|general|error_updating_alias_description")})})).finally((()=>{this.setState({updatingCanonicalAlias:!1})}))}getAliases(){return this.state.altAliases.concat(this.getLocalNonAltAliases())}getLocalNonAltAliases(){const{altAliases:e}=this.state;return this.state.localAliases.filter((t=>!e.includes(t)))}render(){var e;const t=this.context,n=t.getDomain(),i=null===(e=t.getRoom(this.props.roomId))||void 0===e?void 0:e.isSpaceRoom();let s=!1;const r=this.state.canonicalAlias||"",o=Y.createElement(ot.A,{onChange:this.onCanonicalAliasChange,value:r,disabled:this.state.updatingCanonicalAlias||!this.props.canSetCanonicalAlias,element:"select",id:"canonicalAlias",label:(0,T._t)("room_settings|general|canonical_alias_field_label")},Y.createElement("option",{value:"",key:"unset"},(0,T._t)("room_settings|alias_not_specified")),this.getAliases().map(((e,t)=>(e===this.state.canonicalAlias&&(s=!0),Y.createElement("option",{value:e,key:t},e)))),s||!this.state.canonicalAlias?"":Y.createElement("option",{value:this.state.canonicalAlias,key:"arbitrary"},this.state.canonicalAlias));let a;return a=this.state.localAliasesLoading?Y.createElement(B.A,null):Y.createElement(Pt,{id:"roomAliases",items:this.state.localAliases,newItem:this.state.newAlias,onNewItemChanged:this.onNewAliasChanged,canRemove:this.props.canSetAliases,canEdit:this.props.canSetAliases,onItemAdded:this.onLocalAliasAdded,onItemRemoved:this.onLocalAliasDeleted,noItemsLabel:i?(0,T._t)("room_settings|general|no_aliases_space"):(0,T._t)("room_settings|general|no_aliases_room"),placeholder:(0,T._t)("room_settings|general|local_alias_field_label"),domain:n}),Y.createElement(Y.Fragment,null,Y.createElement(Ot.A,{legend:(0,T._t)("room_settings|general|published_aliases_section"),description:Y.createElement(Y.Fragment,null,i?(0,T._t)("room_settings|general|published_aliases_explainer_space"):(0,T._t)("room_settings|general|published_aliases_explainer_room"),"",(0,T._t)("room_settings|general|published_aliases_description"))},o,this.props.hidePublishSetting?null:Y.createElement(Dt,{roomId:this.props.roomId,canSetCanonicalAlias:this.props.canSetCanonicalAlias}),Y.createElement("datalist",{id:"mx_AliasSettings_altRecommendations"},this.getLocalNonAltAliases().map((e=>Y.createElement("option",{value:e,key:e}))),";"),Y.createElement(Pt,{id:"roomAltAliases",items:this.state.altAliases,newItem:this.state.newAltAlias,onNewItemChanged:this.onNewAltAliasChanged,canRemove:this.props.canSetCanonicalAlias,canEdit:this.props.canSetCanonicalAlias,onItemAdded:this.onAltAliasAdded,onItemRemoved:this.onAltAliasDeleted,suggestionsListId:"mx_AliasSettings_altRecommendations",itemsLabel:(0,T._t)("room_settings|general|aliases_items_label"),noItemsLabel:(0,T._t)("room_settings|general|aliases_no_items_label"),placeholder:(0,T._t)("room_settings|general|new_alias_placeholder"),roomId:this.props.roomId})),Y.createElement(Ot.A,{legend:(0,T._t)("room_settings|general|local_aliases_section"),description:i?(0,T._t)("room_settings|general|local_aliases_explainer_space",{localDomain:n}):(0,T._t)("room_settings|general|local_aliases_explainer_room",{localDomain:n})},Y.createElement("details",{onToggle:this.onLocalAliasesToggled,open:this.state.detailsOpen},Y.createElement("summary",{className:"mx_AliasSettings_localAddresses"},this.state.detailsOpen?(0,T._t)("room_list|show_less"):(0,T._t)("common|show_more")),a)))}}(0,s.A)(jt,"contextType",Mt.Ay),(0,s.A)(jt,"defaultProps",{canSetAliases:!1,canSetCanonicalAlias:!1});var Ft=n("./src/hooks/useStateToggle.ts"),Ut=n("./src/hooks/useLocalEcho.ts"),Bt=n("./src/components/views/settings/JoinRuleSettings.tsx"),Lt=n("./src/hooks/useRoomState.ts"),Vt=n("./src/hooks/useAsyncMemo.ts");const Ht=({matrixClient:e,space:t,closeSettingsFn:n})=>{const[i,s]=(0,Y.useState)(""),o=(0,Vt.e)((async()=>e.isVersionSupported("v1.4").then((t=>t||e.doesServerSupportUnstableFeature("org.matrix.msc3827.stable")))),[e],!1),a=e.getUserId(),l=(0,Lt.U)(t,(e=>e.getJoinRule())),[c,d]=(0,Ut.W)((()=>{var e;return(null===(e=t.currentState.getStateEvents(r.EventType.RoomGuestAccess,""))||void 0===e||null===(e=e.getContent())||void 0===e?void 0:e.guest_access)===r.GuestAccess.CanJoin}),(n=>e.sendStateEvent(t.roomId,r.EventType.RoomGuestAccess,{guest_access:n?r.GuestAccess.CanJoin:r.GuestAccess.Forbidden},"")),(()=>s((0,T._t)("room_settings|visibility|error_update_guest_access")))),[h,u]=(0,Ut.W)((()=>{var e;return(null===(e=t.currentState.getStateEvents(r.EventType.RoomHistoryVisibility,""))||void 0===e||null===(e=e.getContent())||void 0===e?void 0:e.history_visibility)||r.HistoryVisibility.Shared}),(n=>e.sendStateEvent(t.roomId,r.EventType.RoomHistoryVisibility,{history_visibility:n},"")),(()=>s((0,T._t)("room_settings|visibility|error_update_history_visibility")))),[m,p]=(0,Ft.X)(),v=t.currentState.maySendStateEvent(r.EventType.RoomGuestAccess,a),g=t.currentState.maySendStateEvent(r.EventType.RoomHistoryVisibility,a),f=t.currentState.mayClientSendStateEvent(r.EventType.RoomCanonicalAlias,e),_=t.currentState.getStateEvents(r.EventType.RoomCanonicalAlias,"");let y,E;return l===r.JoinRule.Public&&(y=Y.createElement("div",null,Y.createElement(Ae.A,{onClick:p,kind:"link",className:"mx_SettingsTab_showAdvanced","aria-expanded":m},m?(0,T._t)("action|hide_advanced"):(0,T._t)("action|show_advanced")),m&&Y.createElement("div",{className:"mx_SettingsTab_toggleWithDescription"},Y.createElement(kt.A,{value:c,onChange:d,disabled:!v,label:(0,T._t)("room_settings|visibility|guest_access_label")}),Y.createElement("p",null,(0,T._t)("room_settings|visibility|guest_access_explainer"),Y.createElement("br",null),(0,T._t)("room_settings|visibility|guest_access_explainer_public_space"))))),t.getJoinRule()===r.JoinRule.Public&&(E=Y.createElement(ft.X,{heading:(0,T._t)("room_settings|visibility|alias_section")},Y.createElement(jt,{roomId:t.roomId,canSetCanonicalAlias:f,canSetAliases:!0,canonicalAliasEvent:null!=_?_:void 0,hidePublishSetting:!o}))),Y.createElement(gt.A,null,Y.createElement(ft.X,{heading:(0,T._t)("room_settings|visibility|title")},i&&Y.createElement("div",{className:"mx_SpaceRoomView_errorText"},i),Y.createElement(Ot.A,{legend:(0,T._t)("room_settings|access|title"),description:(0,T._t)("room_settings|access|description_space",{spaceName:t.name})},Y.createElement(Bt.A,{room:t,onError:()=>s((0,T._t)("room_settings|visibility|error_failed_save")),closeSettingsFn:n}),y,Y.createElement("div",{className:"mx_SettingsTab_toggleWithDescription"},Y.createElement(kt.A,{value:h===r.HistoryVisibility.WorldReadable,onChange:e=>{u(e?r.HistoryVisibility.WorldReadable:r.HistoryVisibility.Shared)},disabled:!g,label:(0,T._t)("room_settings|visibility|history_visibility_anyone_space")}),Y.createElement("p",null,(0,T._t)("room_settings|visibility|history_visibility_anyone_space_description"),Y.createElement("br",null),Y.createElement("strong",null,(0,T._t)("room_settings|visibility|history_visibility_anyone_space_recommendation"))))),E))};var Gt=n("./src/components/views/settings/tabs/room/AdvancedRoomSettingsTab.tsx"),zt=n("./src/components/views/settings/tabs/room/RolesRoomSettingsTab.tsx");let Kt=function(e){return e.General="SPACE_GENERAL_TAB",e.Visibility="SPACE_VISIBILITY_TAB",e.Roles="SPACE_ROLES_TAB",e.Advanced="SPACE_ADVANCED_TAB",e}({});const qt=({matrixClient:e,space:t,onFinished:n})=>{(0,xt.F)(m.A,(e=>{e.action===N.r.AfterLeaveRoom&&e.room_id===t.roomId&&n()}));const i=(0,Y.useMemo)((()=>[new ut.oz(Kt.General,(0,T.AO)("common|general"),"mx_SpaceSettingsDialog_generalIcon",Y.createElement(St,{matrixClient:e,space:t})),new ut.oz(Kt.Visibility,(0,T.AO)("room_settings|visibility|title"),"mx_SpaceSettingsDialog_visibilityIcon",Y.createElement(Ht,{matrixClient:e,space:t,closeSettingsFn:n})),new ut.oz(Kt.Roles,(0,T.AO)("room_settings|permissions|title"),"mx_RoomSettingsDialog_rolesIcon",Y.createElement(zt.A,{room:t})),A.A.getValue(le.f.AdvancedSettings)?new ut.oz(Kt.Advanced,(0,T.AO)("common|advanced"),"mx_RoomSettingsDialog_warningIcon",Y.createElement(Gt.A,{room:t,closeSettingsFn:n})):null].filter(Boolean)),[e,t,n]),[s,r]=Y.useState(Kt.General);return Y.createElement(Ee.A,{title:(0,T._t)("space_settings|title",{spaceName:t.name||(0,T._t)("common|unnamed_space")}),className:"mx_SpaceSettingsDialog",contentId:"mx_SpaceSettingsDialog",onFinished:n,fixedWidth:!1},Y.createElement("div",{className:"mx_SpaceSettingsDialog_content",id:"mx_SpaceSettingsDialog"},Y.createElement(ut.Ay,{tabs:i,activeTabId:s,onChange:r})))};var Jt,Wt=n("./src/components/views/dialogs/InviteDialog.tsx"),Yt=n("./src/components/views/dialogs/AddExistingToSpaceDialog.tsx"),$t=n("./src/PosthogTrackers.ts"),Qt=n("./src/utils/space.tsx"),Xt=n("./src/contexts/SDKContext.ts");class Zt{constructor(){(0,s.A)(this,"isRegistered",!1),(0,s.A)(this,"matrixClient",void 0),(0,s.A)(this,"onDispatch",(e=>{if(this.matrixClient)switch(e.action){case"open_room_settings":f.Ay.createDialog(Ie.A,{roomId:e.room_id||Xt.M.instance.roomViewStore.getRoomId(),initialTabId:e.initial_tab_id},void 0,!1,!0);break;case N.r.OpenForwardDialog:f.Ay.createDialog(nt,{matrixClient:this.matrixClient,event:e.event,permalinkCreator:e.permalinkCreator});break;case N.r.OpenReportEventDialog:f.Ay.createDialog(ht,{mxEvent:e.event},"mx_Dialog_reportEvent");break;case N.r.OpenSpacePreferences:f.Ay.createDialog(Et,{space:e.space},void 0,!1,!0);break;case N.r.OpenSpaceSettings:f.Ay.createDialog(qt,{matrixClient:e.space.client,space:e.space},void 0,!1,!0);break;case N.r.OpenInviteDialog:f.Ay.createDialog(Wt.A,{kind:e.kind,call:e.call,roomId:e.roomId},Re()("mx_InviteDialog_flexWrapper",e.className),!1,!0).finished.then((t=>{var n;null===(n=e.onFinishedCallback)||void 0===n||n.call(e,t)}));break;case N.r.OpenAddToExistingSpaceDialog:{const t=e.space;f.Ay.createDialog(Yt.Ay,{onCreateRoomClick:e=>{(0,Qt.PT)(t),$t.A.trackInteraction("WebAddExistingToSpaceDialogCreateRoomButton",e)},onAddSubspaceClick:()=>(0,Qt.K1)(t),space:t,onFinished:e=>{e&&Xt.M.instance.roomViewStore.getRoomId()===t.roomId&&m.A.fire(N.r.UpdateSpaceHierarchy)}},"mx_AddExistingToSpaceDialog_wrapper");break}}}))}prepare(e){this.matrixClient=e,this.isRegistered||(m.A.register(this.onDispatch),this.isRegistered=!0)}}Jt=Zt,(0,s.A)(Zt,"instance",new Jt);var en=n("./src/utils/ErrorUtils.tsx"),tn=n("./src/utils/oidc/authorize.ts"),nn=n("./src/utils/oidc/error.ts"),sn=n("./src/utils/oidc/persistOidcSettings.ts"),rn=n("./node_modules/matrix-js-sdk/src/utils/decryptAESSecretStorageItem.ts"),on=n("./node_modules/matrix-js-sdk/src/utils/encryptAESSecretStorageItem.ts");const an="mx_access_token",ln="mx_refresh_token",cn="access_token",dn="refresh_token",hn="mx_has_access_token",un="mx_has_refresh_token";async function mn(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);const n=await crypto.subtle.importKey("raw",t,"HKDF",!1,["deriveBits"]);return t.fill(0),new Uint8Array(await crypto.subtle.deriveBits({name:"HKDF",hash:"SHA-256",salt:new Uint8Array(32),info:new Uint8Array(0)},n,256))}async function pn(e,t,n){if("string"==typeof t)return t;if(!e)throw new Error(`Error decrypting secret ${n}: no pickle key found.`);const i=await mn(e),s=await(0,rn.A)(t,i,n);return i.fill(0),s}async function vn(e,t,n,i,s){if(n?localStorage.setItem(s,"true"):localStorage.removeItem(s),i){let s;if(n)try{const e=await mn(i);s=await(0,on.A)(n,e,t),e.fill(0)}catch(e){o.v.warn(`Could not encrypt token for ${t}`,e)}try{await w.x7("account",e,s||n)}catch{n?localStorage.setItem(e,n):localStorage.removeItem(e)}}else try{await w.x7("account",e,n)}catch{n?localStorage.setItem(e,n):localStorage.removeItem(e)}}async function gn(e,t){return vn(an,cn,e,t,hn)}async function fn(e,t){return vn(ln,dn,e,t,un)}class _n extends r.OidcTokenRefresher{constructor(e,t,n,i,r,o){super(e,t,i,n,r),(0,s.A)(this,"deviceId",void 0),this.userId=o,this.deviceId=i}async persistTokens({accessToken:e,refreshToken:t}){var n,i;const s=null!==(n=await(null===(i=y.A.get())||void 0===i?void 0:i.getPickleKey(this.userId,this.deviceId)))&&void 0!==n?n:void 0;await gn(e,s),await fn(t,s)}}var yn=n("./src/SupportedBrowser.ts");const En=["roomId"];function xn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function wn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?xn(Object(n),!0).forEach((function(t){(0,s.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):xn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const An="mx_hs_url",Cn="mx_is_url";m.A.register((e=>{if(e.action===N.r.TriggerLogout)Wn();else if(e.action===N.r.OverwriteLogin){const t=e;$n(!1),Bn(t.credentials,!0,!0).catch((e=>{o.v.warn("Failed to overwrite login",e)}))}}));let bn=!1;async function Sn(){bn=!0,$n()}function Rn(){if(bn)throw new In("session lock has been released")}class In extends Error{}async function kn(e={}){try{let t=e.enableGuest||!1;const n=e.guestHsUrl,i=e.guestIsUrl,s=e.fragmentQueryParams||{},a=e.defaultDeviceDisplayName;if(t&&!n&&(o.v.warn("Cannot enable guest access: can't determine HS URL to use"),t=!1),t&&n&&s.guest_user_id&&s.guest_access_token)return o.v.log("Using guest access credentials"),Bn({userId:s.guest_user_id,accessToken:s.guest_access_token,homeserverUrl:n,identityServerUrl:i,guest:!0},!0,!1).then((()=>!0));return!!await Fn({ignoreGuest:Boolean(e.ignoreGuest)})||!bn&&(!(!t||!n)&&function(e,t,n){o.v.log(`Doing guest login on ${e}`);return(0,r.createClient)({baseUrl:e}).registerGuest({body:{initial_device_display_name:n}}).then((n=>(o.v.log(`Registered as guest: ${n.user_id}`),Bn({userId:n.user_id,deviceId:n.device_id,accessToken:n.access_token,homeserverUrl:e,identityServerUrl:t,guest:!0},!0,!0).then((()=>!0)))),(e=>(o.v.error("Failed to register as guest",e),!1)))}(n,i,a))}catch(e){return!(e instanceof Ln)&&(!bn&&async function(e){o.v.error("Unable to load session",e);const t=f.Ay.createDialog(we,{error:e}),[n]=await t.finished;if(n)return await Yn(),!1;return kn()}(e))}}async function Tn(){const{hsUrl:e,userId:t,hasAccessToken:n,isGuest:i}=await Pn();return e&&t&&n?[t,!!i]:[null,null]}async function Dn(e,t,n){return e.code&&e.state?(console.log("We have OIDC params - attempting OIDC login"),async function(e){try{const{accessToken:t,refreshToken:n,homeserverUrl:i,identityServerUrl:s,idToken:a,clientId:l,issuer:c}=await(0,tn.Y)(e),{user_id:d,device_id:h,is_guest:u}=await async function(e,t,n){try{const i=(0,r.createClient)({baseUrl:t,accessToken:e,idBaseUrl:n});return await i.whoami()}catch(e){throw o.v.error("Failed to retrieve userId using accessToken",e),new Error("Failed to retrieve userId using accessToken")}}(t,i,s),m={accessToken:t,refreshToken:n,homeserverUrl:i,identityServerUrl:s,deviceId:h,userId:d,isGuest:u};return o.v.debug("Logged in via OIDC native flow"),await Nn(m),(0,sn.UF)(l,c,a),!0}catch(e){return o.v.error("Failed to login via OIDC",e),await Mn((0,nn.v)(e)),!1}}(e)):function(e,t,n){var i;if(!e.loginToken)return Promise.resolve(!1);console.log("We have token login params - attempting token login");const s=localStorage.getItem(me.FL),a=null!==(i=localStorage.getItem(me.U7))&&void 0!==i?i:void 0;if(!s)return o.v.warn("Cannot log in with token: can't determine HS URL to use"),Mn((0,T._t)("auth|sso_failed_missing_storage")),Promise.resolve(!1);return(0,E.b)(s,a,"m.login.token",{token:e.loginToken,initial_device_display_name:t}).then((async function(e){return o.v.log("Logged in with token"),await Nn(e),!0})).catch((e=>{const t=()=>{var e;const t=(0,r.createClient)({baseUrl:s,idBaseUrl:a}),i=localStorage.getItem(me.ot)||void 0;null===(e=y.A.get())||void 0===e||e.startSingleSignOn(t,"sso",n,i,r.SSOAction.LOGIN)};return Mn((0,en.Y0)(e,{hsUrl:s,hsName:s}),t),o.v.error("Failed to log in with login token:",e),!1}))}(e,t,n)}async function Nn(e){await Yn(),await Vn(e),sessionStorage.setItem("mx_fresh_login",String(!0))}async function Mn(e,t){f.Ay.createDialog(fe.A,{title:(0,T._t)("auth|oidc|error_title"),description:e,button:(0,T._t)("action|try_again"),onFinished:t?e=>e&&t():void 0})}async function On(e){let t;try{t=await w.Gt("account",e)}catch(t){o.v.error(`StorageManager.idbLoad failed for account:${e}`,t)}var n;if(!t&&(t=null!==(n=localStorage.getItem(e))&&void 0!==n?n:void 0,t))try{await w.x7("account",e,t),localStorage.removeItem(e)}catch(t){o.v.error(`migration of token ${e} to IndexedDB failed`,t)}return t}async function Pn(){var e,t,n,i;const s=null!==(e=localStorage.getItem(An))&&void 0!==e?e:void 0,r=null!==(t=localStorage.getItem(Cn))&&void 0!==t?t:void 0,o=await On(an),a=await On(ln),l="true"===localStorage.getItem(hn)||!!o,c="true"===localStorage.getItem(un)||!!a,d=null!==(n=localStorage.getItem("mx_user_id"))&&void 0!==n?n:void 0,h=null!==(i=localStorage.getItem("mx_device_id"))&&void 0!==i?i:void 0;let u;return u=null!==localStorage.getItem("mx_is_guest")?"true"===localStorage.getItem("mx_is_guest"):"true"===localStorage.getItem("matrix-is-guest"),{hsUrl:s,isUrl:r,hasAccessToken:l,accessToken:o,refreshToken:a,hasRefreshToken:c,userId:d,deviceId:h,isGuest:u}}async function jn(){if(await async function(){const{finished:e}=f.Ay.createDialog(Ce),[t]=await e;return!!t}())throw await Yn(),new Ln("Aborting login in progress because of storage inconsistency")}async function Fn(e){const t=null==e?void 0:e.ignoreGuest;if(!localStorage)return!1;const{hsUrl:n,isUrl:i,hasAccessToken:s,accessToken:r,refreshToken:a,userId:l,deviceId:c,isGuest:d}=await Pn();if(s&&!r&&await jn(),r&&l&&n){var h,u;if(t&&d)return o.v.log("Ignoring stored guest account: "+l),!1;const e=null!==(h=await(null===(u=y.A.get())||void 0===u?void 0:u.getPickleKey(l,null!=c?c:"")))&&void 0!==h?h:void 0;e?o.v.log(`Got pickle key for ${l}|${c}`):o.v.log(`No pickle key available for ${l}|${c}`);const s=await pn(e,r,cn),m=a&&await pn(e,a,dn),p="true"===sessionStorage.getItem("mx_fresh_login");return sessionStorage.removeItem("mx_fresh_login"),o.v.log(`Restoring session for ${l}`),await Bn({userId:l,deviceId:c,accessToken:s,refreshToken:m,homeserverUrl:n,identityServerUrl:i,guest:d,pickleKey:null!=e?e:void 0,freshLogin:p},!1,!1),!0}return o.v.log("No previous session found."),!1}async function Un(e){var t;e.freshLogin=!0,$n();const n=e.userId&&e.deviceId?await(null===(t=y.A.get())||void 0===t?void 0:t.createPickleKey(e.userId,e.deviceId)):null;return n?o.v.log(`Created pickle key for ${e.userId}|${e.deviceId}`):o.v.log("Pickle key not created"),Bn(wn(wn({},e),{},{pickleKey:null!=n?n:void 0}),!0,!0)}async function Bn(e,t,n){Rn(),e.guest=Boolean(e.guest);const i=Kn();o.v.log("setLoggedIn: mxid: "+e.userId+" deviceId: "+e.deviceId+" guest: "+e.guest+" hs: "+e.homeserverUrl+" softLogout: "+i," freshLogin: "+e.freshLogin),t&&await Yn();const s=await x.zV();s.dataInLocalStorage&&s.cryptoInited&&!s.dataInCryptoStore&&await jn();const l=await async function(e){if(!e.refreshToken)return;const t=(0,sn.HB)();if(t)try{const n=(0,sn.rW)(),i=(0,sn.ag)(),s=y.A.get().getOidcCallbackUrl().href,r=e.deviceId;if(!r)throw new Error("Expected deviceId in user credentials.");const o=new _n(t,n,s,r,i,e.userId);return await o.oidcClientReady,o}catch(e){o.v.error("Failed to initialise OIDC token refresher",e)}}(e);Rn(),a.J.replaceUsingCreds(e,null==l?void 0:l.doRefreshAccessToken.bind(l));const c=a.J.safeGet();if((0,be.Tm)(e.userId),k.Vo.instance.isEnabled()&&k.Vo.instance.startListeningToSettingsChanges(c),localStorage)try{await Vn(e),sessionStorage.removeItem("mx_fresh_login")}catch(e){o.v.warn("Error using local storage: can't persist session!",e)}else o.v.warn("No local storage available: can't persist session!");Rn(),m.A.fire(N.r.OnLoggedIn);const d={};e.pickleKey&&(43===e.pickleKey.length?d.rustCryptoStoreKey=(0,r.decodeBase64)(e.pickleKey):d.rustCryptoStorePassword=e.pickleKey);try{await Jn(c,!i,d)}finally{var h;null===(h=d.rustCryptoStoreKey)||void 0===h||h.fill(0)}return A.A.runMigrations(n),n&&!e.guest&&localStorage.setItem("must_verify_device","true"),c}class Ln extends Error{}async function Vn(e){var t;localStorage.setItem(An,e.homeserverUrl),e.identityServerUrl&&localStorage.setItem(Cn,e.identityServerUrl),localStorage.setItem("mx_user_id",e.userId),localStorage.setItem("mx_is_guest",JSON.stringify(e.guest)),await gn(e.accessToken,e.pickleKey),await fn(e.refreshToken,e.pickleKey),e.pickleKey?localStorage.setItem("mx_has_pickle_key",String(!0)):"true"===localStorage.getItem("mx_has_pickle_key")&&o.v.error("Expected a pickle key, but none provided.  Encryption may not work."),e.deviceId&&localStorage.setItem("mx_device_id",e.deviceId),null===(t=l.r.instance.extensions.cryptoSetup)||void 0===t||t.persistCredentials(e),o.v.log(`Session persisted for ${e.userId}`)}let Hn=!1;function Gn(e){var t,n;const i=a.J.get();i&&(k.Vo.instance.logout(),i.isGuest()?setTimeout(Wn,0):(Hn=!0,null===(t=y.A.get())||void 0===t||t.destroyPickleKey(i.getSafeUserId(),null!==(n=i.getDeviceId())&&void 0!==n?n:""),async function(e,t){if(null!=t&&t.isUserAuthenticatedWithOidc){var n,i;const s=null!==(n=e.getAccessToken())&&void 0!==n?n:void 0,r=null!==(i=e.getRefreshToken())&&void 0!==i?i:void 0;await t.revokeTokens(s,r)}else await e.logout(!0)}(i,e).then(Wn,(e=>{o.v.warn("Failed to call logout API: token will not be invalidated",e),Wn()}))))}function zn(){a.J.get()&&(localStorage.setItem("mx_soft_logout","true"),o.v.log("Soft logout initiated"),Hn=!0,m.A.dispatch({action:"on_client_not_viable"}),$n(!1))}function Kn(){return"true"===localStorage.getItem("mx_soft_logout")}function qn(){return Hn}async function Jn(e,t,n){o.v.log("Lifecycle: Starting MatrixClient"),m.A.dispatch({action:"will_start_client"},!0),Xt.M.instance.typingStore.reset(),b.A.sharedInstance().reset(),Zt.instance.prepare(e),h.default.start(),u.A.sharedInstance().start(),g.A.makeShared(e).start(),S.J.sharedInstance().startWatching(),_.A.instance.start(),ve.Ay.instance.start(),(0,yn.o7)(),R.u.sharedInstance().start(),t?(await c.A.init(),await a.J.start(n)):(o.v.warn("Caller requested only auxiliary services be started"),await a.J.assign(n)),Rn(),he.sharedInstance().start(e),A.A.getValue("lowBandwidth")||v.start(),ue.k.getInstance().start(),m.A.dispatch({action:"client_started"}),Kn()&&zn()}async function Wn(){var e,t;m.A.fire(N.r.OnLoggedOut,!0),$n(),await Yn({deleteEverything:!0}),null===(e=ge.onLoggedOutAndStorageCleared)||void 0===e||e.call(ge),await(null===(t=y.A.get())||void 0===t?void 0:t.clearStorage()),A.A.reset(),oe.Ay.get().logout_redirect_url&&(o.v.log("Redirecting to external provider to finish logout"),window.setTimeout((()=>{window.location.href=oe.Ay.get().logout_redirect_url}),100)),Hn=!1}async function Yn(e){var t;if(window.localStorage){const t=A.A.getValueAt(C.p.DEVICE,"language",null,!0,!0),n=pe.A.instance.getWireInvites(),s=window.localStorage.getItem("mx_registration_time");window.localStorage.clear();try{await w.N6("account",an)}catch(e){o.v.error("idbDelete failed for account:mx_access_token",e)}null!=e&&e.deleteEverything||(t&&await A.A.setValue("language",null,C.p.DEVICE,t),n.forEach((e=>{let{roomId:t}=e,n=(0,i.A)(e,En);pe.A.instance.storeInvite(t,n)})),s&&window.localStorage.setItem("mx_registration_time",s))}null===(t=window.sessionStorage)||void 0===t||t.clear();const n=(0,d.A)({baseUrl:""});await c.A.deleteEventIndex(),await n.clearStores()}function $n(e=!0){var t;h.default.stop(),ve.Ay.instance.stop(),u.A.sharedInstance().stop(),Xt.M.instance.typingStore.reset(),v.stop(),_.A.instance.stop(),S.J.sharedInstance().stopWatching(),R.u.sharedInstance().stop(),he.sharedInstance().stop(),null===(t=g.A.shared())||void 0===t||t.stop(),c.A.stop();const n=a.J.get();n&&(n.stopClient(),n.removeAllListeners(),e&&(a.J.unset(),c.A.unset(),n.store.destroy()))}window.mxLoginWithAccessToken=async(e,t)=>{const n=(0,r.createClient)({baseUrl:e,accessToken:t}),{user_id:i}=await n.whoami();await Bn({homeserverUrl:e,accessToken:t,userId:i},!0,!1)}},"./src/Login.ts":(e,t,n)=>{"use strict";n.d(t,{A:()=>c,b:()=>h});var i=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=n("./node_modules/matrix-js-sdk/src/matrix.ts"),r=n("./node_modules/matrix-js-sdk/src/logger.ts"),o=n("./src/modules/ModuleRunner.ts"),a=n("./src/PlatformPeg.ts");var l=n("./src/SdkConfig.ts");class c{constructor(e,t,n,s){(0,i.A)(this,"flows",[]),(0,i.A)(this,"defaultDeviceDisplayName",void 0),(0,i.A)(this,"delegatedAuthentication",void 0),(0,i.A)(this,"tempClient",null),this.hsUrl=e,this.isUrl=t,this.fallbackHsUrl=n,this.defaultDeviceDisplayName=s.defaultDeviceDisplayName,this.delegatedAuthentication=s.delegatedAuthentication}getHomeserverUrl(){return this.hsUrl}getIdentityServerUrl(){return this.isUrl}setHomeserverUrl(e){this.tempClient=null,this.hsUrl=e}setIdentityServerUrl(e){this.tempClient=null,this.isUrl=e}setDelegatedAuthentication(e){this.tempClient=null,this.delegatedAuthentication=e}createTemporaryClient(){return this.tempClient||(this.tempClient=(0,s.createClient)({baseUrl:this.hsUrl,idBaseUrl:this.isUrl})),this.tempClient}async getFlows(e){if(this.delegatedAuthentication)try{return[await d(this.delegatedAuthentication,l.Ay.get().oidc_static_clients,e)]}catch(e){r.v.error(e)}const t=this.createTemporaryClient(),{flows:n}=await t.loginFlows(),i=n.find((e=>"m.login.sso"===e.type&&s.DELEGATED_OIDC_COMPATIBILITY.findIn(e)));return this.flows=i?[i]:n,this.flows}loginViaPassword(e,t,n,i){const s=!!e&&e.indexOf("@")>0;let o;o=t&&n?{type:"m.id.phone",country:t,phone:n,number:n}:s?{type:"m.id.thirdparty",medium:"email",address:e}:{type:"m.id.user",user:e};const a={password:i,identifier:o,initial_device_display_name:this.defaultDeviceDisplayName},l=e=>h(this.fallbackHsUrl,this.isUrl,"m.login.password",a).catch((t=>{throw r.v.log("fallback HS login failed",t),e}));let c=null;return h(this.hsUrl,this.isUrl,"m.login.password",a).catch((e=>{if(c=e,403===e.httpStatus&&this.fallbackHsUrl)return l(c);throw c})).catch((e=>{throw r.v.log("Login failed",e),e}))}}const d=async(e,t,n)=>{if(n&&!(e=>{const t=e.metadata.prompt_values_supported;return Array.isArray(t)&&(null==t?void 0:t.includes("create"))})(e))throw new Error("Registration is not supported by OP");const i=await(async(e,t)=>{const n=((e,t)=>{var n;const i=e.endsWith("/")?e:e+"/";return null==t||null===(n=t[i])||void 0===n?void 0:n.client_id})(e.metadata.issuer,t);return n?(r.v.debug(`Using static clientId for issuer ${e.metadata.issuer}`),n):await(0,s.registerOidcClient)(e,await a.A.get().getOidcClientMetadata())})(e,t);return{type:"oidcNativeFlow",clientId:i}};async function h(e,t,n,i){const a=(0,s.createClient)({baseUrl:e,idBaseUrl:t}),l=await a.login(n,i),c=l.well_known;var d,h;c&&(null!==(d=c["m.homeserver"])&&void 0!==d&&d.base_url&&(e=c["m.homeserver"].base_url,r.v.log(`Overrode homeserver setting with ${e} from login response`)),null!==(h=c["m.identity_server"])&&void 0!==h&&h.base_url&&(t=c["m.identity_server"].base_url,r.v.log(`Overrode IS setting with ${t} from login response`)));const u={homeserverUrl:e,identityServerUrl:t,userId:l.user_id,deviceId:l.device_id,accessToken:l.access_token};return o.r.instance.extensions.cryptoSetup.examineLoginResponse(l,u),u}},"./src/components/structures/auth/SetupEncryptionBody.tsx":(e,t,n)=>{"use strict";n.d(t,{A:()=>v});var i=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=n("./node_modules/react/index.js"),r=n("./node_modules/matrix-js-sdk/src/logger.ts"),o=n("./src/languageHandler.tsx"),a=n("./src/MatrixClientPeg.ts"),l=n("./src/Modal.tsx"),c=n("./src/components/views/dialogs/VerificationRequestDialog.tsx"),d=n("./src/stores/SetupEncryptionStore.ts"),h=n("./src/components/views/right_panel/EncryptionPanel.tsx"),u=n("./src/components/views/elements/AccessibleButton.tsx"),m=n("./src/components/views/elements/Spinner.tsx"),p=n("./src/tchap/util/TchapUrls.ts");class v extends s.Component{constructor(e){super(e),(0,i.A)(this,"onStoreUpdate",(()=>{const e=d.s.sharedInstance();e.phase!==d.a.Finished?this.setState({phase:e.phase,verificationRequest:e.verificationRequest,backupInfo:e.backupInfo,lostKeys:e.lostKeys()}):this.props.onFinished()})),(0,i.A)(this,"onUsePassphraseClick",(async()=>{d.s.sharedInstance().usePassPhrase()})),(0,i.A)(this,"onVerifyClick",(()=>{var e;const t=a.J.safeGet(),n=t.getSafeUserId(),i=t.getCrypto().requestOwnUserVerification();this.props.onFinished(),l.Ay.createDialog(c.A,{verificationRequestPromise:i,member:null!==(e=t.getUser(n))&&void 0!==e?e:void 0,onFinished:async()=>{(await i).cancel(),this.props.onFinished()}})})),(0,i.A)(this,"onSkipConfirmClick",(()=>{d.s.sharedInstance().skipConfirm()})),(0,i.A)(this,"onSkipBackClick",(()=>{d.s.sharedInstance().returnAfterSkip()})),(0,i.A)(this,"onResetClick",(e=>{e.preventDefault();d.s.sharedInstance().reset()})),(0,i.A)(this,"onResetConfirmClick",(()=>{this.props.onFinished();d.s.sharedInstance().resetConfirm()})),(0,i.A)(this,"onResetBackClick",(()=>{d.s.sharedInstance().returnAfterReset()})),(0,i.A)(this,"onDoneClick",(()=>{d.s.sharedInstance().done()})),(0,i.A)(this,"onEncryptionPanelClose",(()=>{this.props.onFinished()}));const t=d.s.sharedInstance();t.start(),this.state={phase:t.phase,verificationRequest:t.verificationRequest,backupInfo:t.backupInfo,lostKeys:t.lostKeys()}}componentDidMount(){d.s.sharedInstance().on("update",this.onStoreUpdate)}componentWillUnmount(){const e=d.s.sharedInstance();e.off("update",this.onStoreUpdate),e.stop()}render(){const e=a.J.safeGet(),{phase:t,lostKeys:n}=this.state;if(this.state.verificationRequest&&e.getUser(this.state.verificationRequest.otherUserId))return s.createElement(h.A,{layout:"dialog",verificationRequest:this.state.verificationRequest,onClose:this.onEncryptionPanelClose,member:e.getUser(this.state.verificationRequest.otherUserId),isRoomEncrypted:!1});if(t===d.a.Intro){if(n)return s.createElement("div",null,s.createElement("p",null,(0,o._t)("<p>The Tchap team is working on the deployment of a new feature to prevent encryption key loss.</p><p> You can access it in the section :</p><p>Security and privacy > Secure Backup</p>",{},{p:e=>s.createElement("p",null,e)})),s.createElement("div",{className:"mx_CompleteSecurity_actionRow"},s.createElement(u.A,{kind:"primary",onClick:this.onResetConfirmClick},(0,o._t)("Set up"))));{const e=d.s.sharedInstance();let t,n,r;e.keyInfo&&(i=e.keyInfo,Boolean(i.passphrase&&i.passphrase.salt&&i.passphrase.iterations))?t=(0,o._t)("encryption|verification|verify_using_key_or_phrase"):e.keyInfo&&(t=(0,o._t)("encryption|verification|verify_using_key")),t&&(n=s.createElement(u.A,{kind:"primary",onClick:this.onUsePassphraseClick},t)),e.hasDevicesToVerifyAgainst&&(r=s.createElement(u.A,{kind:"primary",onClick:this.onVerifyClick},(0,o._t)("encryption|verification|verify_using_device")));const a=e=>s.createElement(u.A,{kind:"link_inline",onClick:()=>{window.open(p.A.helpVerifyDevicesPage,"_blank")}},e),l=s.createElement(u.A,{kind:"primary_outline",onClick:()=>{window.open(p.A.helpVerifyDevicesPage,"_blank")}},(0,o._t)("common|help"));return s.createElement("div",null,s.createElement("p",null,(0,o._t)("encryption|verification|verification_description")," ",(0,o._t)("encryption|verification|help_link",{},{a})),s.createElement("div",{className:"mx_CompleteSecurity_actionRow"},r,n,l),s.createElement("div",{className:"mx_SetupEncryptionBody_reset"},(0,o._t)("encryption|reset_all_button",void 0,{a:e=>s.createElement(u.A,{kind:"link_inline",className:"mx_SetupEncryptionBody_reset_link",onClick:this.onResetClick},e)})))}}if(t===d.a.Done){let e;return e=this.state.backupInfo?s.createElement("p",null,(0,o._t)("encryption|verification|verification_success_with_backup")):s.createElement("p",null,(0,o._t)("encryption|verification|verification_success_without_backup")),s.createElement("div",null,s.createElement("div",{className:"mx_CompleteSecurity_heroIcon mx_E2EIcon_verified"}),e,s.createElement("div",{className:"mx_CompleteSecurity_actionRow"},s.createElement(u.A,{kind:"primary",onClick:this.onDoneClick},(0,o._t)("action|done"))))}return t===d.a.ConfirmSkip?s.createElement("div",null,s.createElement("p",null,(0,o._t)("encryption|verification|verification_skip_warning")),s.createElement("div",{className:"mx_CompleteSecurity_actionRow"},s.createElement(u.A,{kind:"danger_outline",onClick:this.onSkipConfirmClick},(0,o._t)("encryption|verification|verify_later")),s.createElement(u.A,{kind:"primary",onClick:this.onSkipBackClick},(0,o._t)("action|go_back")))):t===d.a.ConfirmReset?s.createElement("div",null,s.createElement("p",null,(0,o._t)("encryption|verification|verify_reset_warning_1")),s.createElement("p",null,(0,o._t)("encryption|verification|verify_reset_warning_2")),s.createElement("div",{className:"mx_CompleteSecurity_actionRow"},s.createElement(u.A,{kind:"danger_outline",onClick:this.onResetConfirmClick},(0,o._t)("encryption|verification|reset_proceed_prompt")),s.createElement(u.A,{kind:"primary",onClick:this.onResetBackClick},(0,o._t)("action|go_back")))):t===d.a.Busy||t===d.a.Loading?s.createElement(m.A,null):void r.v.log(`SetupEncryptionBody: Unknown phase ${t}`);var i}}},"./src/components/structures/grouper/LateEventGrouper.ts":(e,t,n)=>{"use strict";n.d(t,{R:()=>s});const i="io.element.late_event";function s(e){return e.getUnsigned()[i]}},"./src/components/views/dialogs/VerificationRequestDialog.tsx":(e,t,n)=>{"use strict";n.d(t,{A:()=>l});var i=n("./node_modules/react/index.js"),s=n("./src/MatrixClientPeg.ts"),r=n("./src/languageHandler.tsx"),o=n("./src/components/views/dialogs/BaseDialog.tsx"),a=n("./src/components/views/right_panel/EncryptionPanel.tsx");class l extends i.Component{constructor(e){super(e),this.state={verificationRequest:this.props.verificationRequest}}componentDidMount(){var e;null===(e=this.props.verificationRequestPromise)||void 0===e||e.then((e=>{this.setState({verificationRequest:e})}))}render(){const e=this.state.verificationRequest,t=null==e?void 0:e.otherUserId,n=this.props.member||(t?s.J.safeGet().getUser(t):null),l=(0,r._t)("Incoming Verification Request");return n?i.createElement(o.A,{className:"mx_InfoDialog",onFinished:this.props.onFinished,contentId:"mx_Dialog_content",title:l,hasCancel:!0},i.createElement(a.A,{layout:"dialog",verificationRequest:this.props.verificationRequest,verificationRequestPromise:this.props.verificationRequestPromise,onClose:this.props.onFinished,member:n,isRoomEncrypted:!1})):null}}},"./src/components/views/dialogs/security/SetupEncryptionDialog.tsx":(e,t,n)=>{"use strict";n.d(t,{A:()=>d});var i=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=n("./node_modules/react/index.js"),r=n("./src/components/structures/auth/SetupEncryptionBody.tsx"),o=n("./src/components/views/dialogs/BaseDialog.tsx"),a=n("./src/languageHandler.tsx"),l=n("./src/stores/SetupEncryptionStore.ts");function c(e){return e===l.a.Done?n("./res/img/e2e/verified-deprecated.svg").A:n("./res/img/e2e/warning-deprecated.svg").A}class d extends s.Component{constructor(e){super(e),(0,i.A)(this,"store",void 0),(0,i.A)(this,"onStoreUpdate",(()=>{this.setState({icon:c(this.store.phase)})})),this.store=l.s.sharedInstance(),this.state={icon:c(this.store.phase)}}componentDidMount(){this.store.on("update",this.onStoreUpdate)}componentWillUnmount(){this.store.removeListener("update",this.onStoreUpdate)}render(){return s.createElement(o.A,{headerImage:this.state.icon,onFinished:this.props.onFinished,title:(0,a._t)("encryption|verify_toast_title")},s.createElement(r.A,{onFinished:this.props.onFinished}))}}},"./src/components/views/elements/LabelledCheckbox.tsx":(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n("./node_modules/react/index.js"),s=n("./node_modules/classnames/index.js"),r=n.n(s),o=n("./src/components/views/elements/StyledCheckbox.tsx");const a=({value:e,label:t,byline:n,disabled:s,onChange:a,className:l})=>i.createElement("label",{className:r()("mx_LabelledCheckbox",l)},i.createElement(o.A,{disabled:s,checked:e,onChange:e=>a(e.target.checked)}),i.createElement("div",{className:"mx_LabelledCheckbox_labels"},i.createElement("span",{className:"mx_LabelledCheckbox_label"},t),n?i.createElement("span",{className:"mx_LabelledCheckbox_byline"},n):null))},"./src/components/views/elements/RoomName.tsx":(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n("./node_modules/react/index.js"),s=n("./node_modules/matrix-js-sdk/src/matrix.ts"),r=n("./src/hooks/useEventEmitter.ts");const o=({room:e,children:t})=>{const[n,o]=(0,i.useState)(null==e?void 0:e.name);return(0,r.YK)(e,s.RoomEvent.Name,(()=>{o(null==e?void 0:e.name)})),(0,i.useEffect)((()=>{o(null==e?void 0:e.name)}),[e]),t?t(null!=n?n:""):i.createElement(i.Fragment,null,n||"")}},"./src/components/views/messages/DisambiguatedProfile.tsx":(e,t,n)=>{"use strict";n.d(t,{A:()=>c});var i=n("./node_modules/react/index.js"),s=n("./node_modules/classnames/index.js"),r=n.n(s),o=n("./src/languageHandler.tsx"),a=n("./src/utils/FormattingUtils.ts"),l=n("./src/customisations/UserIdentifier.ts");class c extends i.Component{render(){const{fallbackName:e,member:t,colored:n,emphasizeDisplayName:s,withTooltip:c,onClick:d}=this.props,h=(null==t?void 0:t.rawDisplayName)||e,u=null==t?void 0:t.userId;let m,p,v;if(n&&(m=(0,a.yJ)(null!=u?u:"")),u){var g,f;const e=null!==(g=null===(f=l.A.getDisplayUserIdentifier)||void 0===f?void 0:f.call(l.A,u,{withDisplayName:!0,roomId:t.roomId}))&&void 0!==g?g:u;null!=t&&t.disambiguate&&(p=i.createElement("span",{className:"mx_DisambiguatedProfile_mxid"},e)),v=(0,o._t)("timeline|disambiguated_profile",{displayName:h,matrixId:e})}const _=r()(m,{mx_DisambiguatedProfile_displayName:s});return i.createElement("div",{className:"mx_DisambiguatedProfile",title:c?v:void 0,onClick:d},i.createElement("span",{className:_,dir:"auto"},h),p)}}},"./src/components/views/messages/SenderProfile.tsx":(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n("./node_modules/react/index.js"),s=n("./node_modules/matrix-js-sdk/src/matrix.ts"),r=n("./src/components/views/messages/DisambiguatedProfile.tsx"),o=n("./src/hooks/room/useRoomMemberProfile.ts");function a({mxEvent:e,onClick:t,withTooltip:n}){var a;const l=(0,o.s)({userId:e.getSender(),member:e.sender});return e.getContent().msgtype!==s.MsgType.Emote?i.createElement(r.A,{fallbackName:null!==(a=e.getSender())&&void 0!==a?a:"",onClick:t,member:l,colored:!0,emphasizeDisplayName:!0,withTooltip:n}):i.createElement(i.Fragment,null)}},"./src/components/views/rooms/EntityTile.tsx":(e,t,n)=>{"use strict";n.d(t,{A:()=>v,C:()=>u});var i=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=n("./node_modules/react/index.js"),r=n("./node_modules/classnames/index.js"),o=n.n(r),a=n("./src/components/views/elements/AccessibleButton.tsx"),l=n("./src/languageHandler.tsx"),c=n("./src/components/views/rooms/E2EIcon.tsx"),d=n("./src/components/views/avatars/BaseAvatar.tsx"),h=n("./src/components/views/rooms/PresenceLabel.tsx");let u=function(e){return e.Admin="admin",e.Moderator="moderator",e}({});const m={[u.Admin]:(0,l.AO)("power_level|admin"),[u.Moderator]:(0,l.AO)("power_level|mod")},p={offline:"mx_EntityTile_offline",online:"mx_EntityTile_online",unavailable:"mx_EntityTile_unavailable","io.element.unreachable":"mx_EntityTile_unreachable"};class v extends s.PureComponent{constructor(e){super(e),this.state={hover:!1}}getPresenceLabel(){if(!this.props.showPresence)return;const e=this.props.presenceLastActiveAgo?Date.now()-(this.props.presenceLastTs-this.props.presenceLastActiveAgo):-1;return s.createElement(h.A,{activeAgo:e,currentlyActive:this.props.presenceCurrentlyActive,presenceState:this.props.presenceState})}render(){const e={mx_EntityTile:!0};this.props.className&&(e[this.props.className]=!0);var t,n;e[(t=this.props.presenceState,n=this.props.presenceLastActiveAgo,!1===this.props.showPresence?"mx_EntityTile_online_beenactive":"offline"===t?n?p.offline+"_beenactive":p.offline+"_neveractive":t?p[t]:p.offline+"_neveractive")]=!0;const i=this.props.nameJSX||this.props.name,r=s.createElement("div",{className:"mx_EntityTile_details"},s.createElement("div",{className:"mx_EntityTile_name"},i),this.getPresenceLabel());let h;const u=this.props.powerStatus;if(u){const e=(0,l._t)(m[u]);h=s.createElement("div",{className:"mx_EntityTile_power"},e)}let v;const{e2eStatus:g}=this.props;g&&(v=s.createElement(c.A,{status:g,isUser:!0,bordered:!0}));const f=this.props.avatarJsx||s.createElement(d.A,{name:this.props.name,size:"36px","aria-hidden":"true"});return s.createElement("div",null,s.createElement(a.A,{className:o()(e),title:this.props.title,onClick:this.props.onClick},s.createElement("div",{className:"mx_EntityTile_avatar"},f,v),r,h))}}(0,i.A)(v,"defaultProps",{onClick:()=>{},presenceState:"offline",presenceLastActiveAgo:0,presenceLastTs:0,showInviteButton:!1,showPresence:!0})},"./src/components/views/rooms/EventPreview.tsx":(e,t,n)=>{"use strict";n.d(t,{B:()=>g,BM:()=>f,c5:()=>_});var i=n("./node_modules/@babel/runtime/helpers/esm/extends.js"),s=n("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),r=n("./node_modules/react/index.js"),o=n("./node_modules/matrix-js-sdk/src/matrix.ts"),a=n("./node_modules/classnames/index.js"),l=n.n(a),c=n("./src/languageHandler.tsx"),d=n("./src/stores/room-list/MessagePreviewStore.ts"),h=n("./src/hooks/useAsyncMemo.ts"),u=n("./src/contexts/MatrixClientContext.tsx"),m=n("./src/hooks/useEventEmitter.ts");const p=["mxEvent","className"],v=["preview","className"];function g(e){let{mxEvent:t,className:n}=e,o=(0,s.A)(e,p);const a=_(t);return a?r.createElement(f,(0,i.A)({},o,{preview:a,className:n})):null}function f(e){let{preview:[t,n],className:o}=e,a=(0,s.A)(e,v);const d=l()("mx_EventPreview",o);return n?r.createElement("span",(0,i.A)({},a,{className:d}),(0,c._t)("event_preview|preview",{prefix:n,preview:t},{bold:e=>r.createElement("span",{className:"mx_EventPreview_prefix"},e)})):r.createElement("span",(0,i.A)({},a,{className:d,title:t}),t)}function _(e){const t=(0,r.useContext)(u.Ay),[n,i]=(0,r.useState)(null==e?void 0:e.getContent());(0,m.YK)(null!=e?e:void 0,o.MatrixEventEvent.Replaced,(()=>{i(e.getContent())}));const s=(null==e?void 0:e.shouldAttemptDecryption())||(null==e?void 0:e.isBeingDecrypted());return(0,m.YK)(s&&null!=e?e:void 0,o.MatrixEventEvent.Decrypted,(()=>{i(e.getContent())})),(0,h.e)((async()=>!e||e.isRedacted()||e.isDecryptionFailure()?null:(await t.decryptEventIfNeeded(e),[d.X.instance.generatePreviewForEvent(e),y(e.getType(),null==n?void 0:n.msgtype)])),[e,n],null)}function y(e,t){if(e===o.M_POLL_START.name)return(0,c._t)("event_preview|prefix|poll");switch(t){case o.MsgType.Audio:return(0,c._t)("event_preview|prefix|audio");case o.MsgType.Image:return(0,c._t)("event_preview|prefix|image");case o.MsgType.Video:return(0,c._t)("event_preview|prefix|video");case o.MsgType.File:return(0,c._t)("event_preview|prefix|file");default:return null}}},"./src/components/views/rooms/EventTile.tsx":(e,t,n)=>{"use strict";n.d(t,{f3:()=>jt,Ay:()=>Ft,CH:()=>Pt});var i=n("./node_modules/@babel/runtime/helpers/esm/extends.js"),s=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=n("./node_modules/react/index.js"),o=n("./node_modules/classnames/index.js"),a=n.n(o),l=n("./node_modules/matrix-js-sdk/src/matrix.ts"),c=n("./node_modules/matrix-js-sdk/src/logger.ts"),d=n("./node_modules/matrix-js-sdk/src/webrtc/call.ts"),h=n("./node_modules/matrix-js-sdk/src/crypto-api/index.ts"),u=n("./node_modules/@vector-im/compound-web/dist/components/Tooltip/Tooltip.js"),m=n("./src/languageHandler.tsx"),p=n("./src/dispatcher/dispatcher.ts"),v=n("./src/utils/permalinks/Permalinks.ts"),g=n("./src/settings/SettingsStore.ts"),f=n("./src/utils/FormattingUtils.ts"),_=n("./src/dispatcher/actions.ts"),y=n("./src/components/views/elements/Spinner.tsx"),E=n("./src/components/views/rooms/ReplyTile.tsx"),x=n("./src/components/views/elements/Pill.tsx"),w=n("./src/components/views/elements/AccessibleButton.tsx"),A=n("./src/utils/Reply.ts"),C=n("./src/contexts/RoomContext.ts"),b=n("./src/MatrixClientPeg.ts");class S extends r.Component{constructor(e,t){super(e,t),(0,s.A)(this,"unmounted",!1),(0,s.A)(this,"room",void 0),(0,s.A)(this,"blockquoteRef",r.createRef()),(0,s.A)(this,"canCollapse",(()=>this.state.events.length>1)),(0,s.A)(this,"collapse",(()=>{this.initialize()})),(0,s.A)(this,"onQuoteClick",(async()=>{if(!this.state.loadedEv)return;const e=[this.state.loadedEv,...this.state.events];let t=null;e.length>0&&(t=await this.getNextEvent(e[0])),this.setState({loadedEv:t,events:e}),p.A.fire(_.r.FocusSendMessageComposer)})),this.state={events:[],loadedEv:null,loading:!0,err:!1},this.room=this.matrixClient.getRoom(this.props.parentEv.getRoomId())}get matrixClient(){return b.J.safeGet()}componentDidMount(){this.unmounted=!1,this.initialize(),this.trySetExpandableQuotes()}componentDidUpdate(){var e,t;null===(e=(t=this.props).onHeightChanged)||void 0===e||e.call(t),this.trySetExpandableQuotes()}componentWillUnmount(){this.unmounted=!0}trySetExpandableQuotes(){if(void 0===this.props.isQuoteExpanded&&this.blockquoteRef.current){const e=this.blockquoteRef.current.querySelector(".mx_EventTile_body");if(e){const t=e.querySelector("code"),n=!!t&&t.offsetHeight>=60;(e.offsetHeight>=60||n)&&this.props.setQuoteExpanded(!1)}}}async initialize(){const{parentEv:e}=this.props,t=await this.getEvent((0,A.Ul)(e));if(!this.unmounted)if(t){const e=await this.getNextEvent(t);this.setState({events:[t],loadedEv:e,loading:!1})}else this.setState({err:!0})}async getNextEvent(e){try{const t=(0,A.Ul)(e);return t?await this.getEvent(t):null}catch{return null}}async getEvent(e){var t;if(!e)return null;const n=this.room.findEventById(e);if(n)return n;try{await this.matrixClient.getEventTimeline(this.room.getUnfilteredTimelineSet(),e)}catch{return null}return null!==(t=this.room.findEventById(e))&&void 0!==t?t:null}getReplyChainColorClass(e){return(0,f.yJ)(e.getSender()).replace("Username","ReplyChain")}render(){let e;if(this.state.err)e=r.createElement("blockquote",{className:"mx_ReplyChain mx_ReplyChain_error"},(0,m._t)("timeline|reply|error_loading"));else if(this.state.loadedEv&&(0,A.c$)(this.state.events[0])){const t=this.state.loadedEv,n=this.matrixClient.getRoom(t.getRoomId());e=r.createElement("blockquote",{className:`mx_ReplyChain ${this.getReplyChainColorClass(t)}`},(0,m._t)("timeline|reply|in_reply_to",{},{a:e=>r.createElement(w.A,{kind:"link_inline",className:"mx_ReplyChain_show",onClick:this.onQuoteClick},e),pill:r.createElement(x.ab,{type:x.yL.UserMention,room:null!=n?n:void 0,url:(0,v.Ne)(t.getSender()),shouldShowPillAvatar:g.A.getValue("Pill.shouldShowPillAvatar")})}))}else if(this.props.forExport){const t=(0,A.Ul)(this.props.parentEv);e=r.createElement("p",{className:"mx_ReplyChain_Export"},(0,m._t)("timeline|reply|in_reply_to_for_export",{},{a:e=>r.createElement("a",{className:"mx_reply_anchor",href:`#${t}`,"data-scroll-to":t}," ",e," ")}))}else this.state.loading&&(e=r.createElement(y.A,{w:16,h:16}));const{isQuoteExpanded:t}=this.props,n=this.state.events.map((e=>{const n=a()({mx_ReplyChain:!0,[this.getReplyChainColorClass(e)]:!0,"mx_ReplyChain--expanded":!0===t,"mx_ReplyChain--collapsed":!1===t});return r.createElement("blockquote",{ref:this.blockquoteRef,className:n,key:e.getId()},r.createElement(E.A,{mxEvent:e,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator,toggleExpandedQuote:()=>this.props.setQuoteExpanded(!this.props.isQuoteExpanded),getRelationsForEvent:this.props.getRelationsForEvent}))}));return r.createElement("div",{className:"mx_ReplyChain_wrapper"},r.createElement("div",null,e),r.createElement("div",null,n))}}(0,s.A)(S,"contextType",C.Ay);var R=n("./src/settings/enums/Layout.ts"),I=n("./src/DateUtils.ts"),k=n("./src/components/views/messages/DecryptionFailureBody.tsx"),T=n("./src/components/views/avatars/RoomAvatar.tsx"),D=n("./src/components/views/context_menus/MessageContextMenu.tsx"),N=n("./src/components/structures/ContextMenu.tsx"),M=n("./src/utils/objects.ts"),O=n("./src/stores/notifications/StaticNotificationState.ts"),P=n("./src/components/views/rooms/NotificationBadge.tsx"),j=n("./src/PlatformPeg.ts"),F=n("./src/components/views/avatars/MemberAvatar.tsx"),U=n("./src/components/views/messages/SenderProfile.tsx"),B=n("./src/components/views/messages/MessageTimestamp.tsx"),L=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/overflow-horizontal.js"),V=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/threads.js"),H=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/unpin.js"),G=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/pin.js"),z=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/delete.js"),K=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/restart.js"),q=n("./node_modules/react/jsx-runtime.js");function J(e,t){return(0,q.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,q.jsx)("path",{d:"M9.405 5.708c.39-.391.39-1.025 0-1.416a.996.996 0 0 0-1.412 0L3.294 9.006a1.004 1.004 0 0 0 0 1.416l4.699 4.714a.996.996 0 0 0 1.412 0c.39-.39.39-1.025 0-1.416L6.36 10.666h9.154c1.887 0 3.485 1.604 3.485 3.667C19 16.396 17.402 18 15.515 18h-2.093a1 1 0 1 0 0 2h2.093C18.58 20 21 17.425 21 14.333c0-3.092-2.419-5.666-5.485-5.666H6.456l2.949-2.959Z"})})}J.displayName="ReplyIcon";const W=(0,r.forwardRef)(J);var Y;function $(){return $=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},$.apply(null,arguments)}var Q=function(e,t){return r.createElement("svg",$({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0,ref:t},e),Y||(Y=r.createElement("path",{stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M3 14h12M5 10.5l7-7"})))},X=(0,r.forwardRef)(Q);var Z;function ee(){return ee=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},ee.apply(null,arguments)}var te=function(e,t){return r.createElement("svg",ee({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0,ref:t},e),Z||(Z=r.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M20 1a1 1 0 0 0-1 1v2h-2a1 1 0 1 0 0 2h2v2a1 1 0 1 0 2 0V6h2a1 1 0 1 0 0-2h-2V2a1 1 0 0 0-1-1M7 9.5C7 8.67 7.67 8 8.5 8s1.5.67 1.5 1.5S9.33 11 8.5 11 7 10.33 7 9.5m8.5 1.5c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5M12 17.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5M4 12a8 8 0 0 1 9.774-7.803 1 1 0 1 0 .442-1.95A10 10 0 0 0 12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10q0-.318-.02-.632a1 1 0 1 0-1.996.125q.015.25.016.507a8 8 0 1 1-16 0",clipRule:"evenodd"})))},ne=(0,r.forwardRef)(te);var ie;function se(){return se=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},se.apply(null,arguments)}var re=function(e,t){return r.createElement("svg",se({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 11 14",role:"presentation","aria-hidden":!0,ref:t},e),ie||(ie=r.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M.22 8.494a.753.753 0 0 1 1.062-.002l3.724 3.7L8.718 8.48a.753.753 0 0 1 1.062-.002.747.747 0 0 1 .002 1.06L5.54 13.78a.753.753 0 0 1-1.063.002L.221 9.552a.747.747 0 0 1-.002-1.058m9.562-2.988a.753.753 0 0 1-1.062.002l-3.724-3.7L1.283 5.52a.753.753 0 0 1-1.062.002.747.747 0 0 1-.002-1.06L4.462.22A.753.753 0 0 1 5.524.218l4.257 4.23a.747.747 0 0 1 .001 1.058",clipRule:"evenodd"})))},oe=(0,r.forwardRef)(re);var ae;function le(){return le=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},le.apply(null,arguments)}var ce=function(e,t){return r.createElement("svg",le({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 11 14",role:"presentation","aria-hidden":!0,ref:t},e),ae||(ae=r.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M.22.234A.753.753 0 0 1 1.281.232l3.724 3.7L8.718.22A.753.753 0 0 1 9.781.218a.747.747 0 0 1 .001 1.06L5.54 5.52a.753.753 0 0 1-1.063.002L.221 1.292A.747.747 0 0 1 .219.235m9.562 13.532a.753.753 0 0 1-1.062.002l-3.724-3.7-3.713 3.712a.753.753 0 0 1-1.062.002.747.747 0 0 1-.002-1.06L4.462 8.48a.753.753 0 0 1 1.062-.002l4.257 4.23a.747.747 0 0 1 .001 1.058",clipRule:"evenodd"})))},de=(0,r.forwardRef)(ce);var he=n("./src/utils/EventUtils.ts"),ue=n("./src/accessibility/Toolbar.tsx"),me=n("./src/accessibility/RovingTabIndex.tsx"),pe=n("./src/Resend.ts"),ve=n("./src/utils/MediaEventHelper.ts"),ge=n("./src/utils/FileDownloader.ts"),fe=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/download.js"),_e=n("./src/tchap/components/views/elements/BlockedIcon.tsx"),ye=function(e){return e[e.Pristine=0]="Pristine",e[e.Scanning=1]="Scanning",e[e.Safe=2]="Safe",e[e.Untrusted=3]="Untrusted",e[e.Error=4]="Error",e}(ye||{});class Ee extends r.PureComponent{constructor(e){super(e),(0,s.A)(this,"downloader",new ge.s),(0,s.A)(this,"onDownloadClick",(async()=>{if(this.state.downloadState===ye.Scanning)return;if(this.state.blob)return this.doDownload();this.setState({downloadState:ye.Scanning});const e=this.props.mediaEventHelperGet().media;if(!await Promise.all([e.scanSource(),e.scanThumbnail()]).then((([e,t])=>{const n=e&&t;return this.setState({downloadState:n?ye.Safe:ye.Untrusted}),n})).catch((()=>{this.setState({downloadState:ye.Error})})))return;const t=await this.props.mediaEventHelperGet().sourceBlob.value;this.setState({blob:t}),await this.doDownload()})),this.state={downloadState:ye.Pristine}}async doDownload(){return this.downloader.download({blob:this.state.blob,name:this.props.mediaEventHelperGet().fileName})}render(){let e,t,n=!1;switch(this.state.downloadState){case ye.Pristine:case ye.Safe:e=r.createElement(fe.A,null),t=(0,m._t)("action|download");break;case ye.Scanning:e=this.renderSpinner(),n=!0,t=(0,m._t)("Scanning");break;case ye.Untrusted:e=this.renderBlockedIcon(),t=(0,m._t)("Content blocked");break;case ye.Error:e=this.renderBlockedIcon(),t=(0,m._t)("Scan unavailable")}const i=a()({mx_MessageActionBar_iconButton:!0,mx_MessageActionBar_downloadButton:!0,mx_MessageActionBar_downloadSpinnerButton:n});return r.createElement(me.k,{className:i,title:t,onClick:this.onDownloadClick,disabled:this.disabled},e)}renderBlockedIcon(){return r.createElement(_e.k,{className:"mx_BlockedIcon_messageContext"})}renderSpinner(){return r.createElement(y.A,{w:18,h:18})}get disabled(){return[ye.Scanning,ye.Error,ye.Untrusted].includes(this.state.downloadState)}}var xe=n("./src/components/views/emojipicker/ReactionPicker.tsx"),we=n("./src/components/views/right_panel/context.ts"),Ae=n("./src/Keyboard.ts"),Ce=n("./src/accessibility/KeyboardShortcuts.ts"),be=n("./src/tchap/util/TchapUIFeature.ts"),Se=n("./src/utils/PinningUtils.ts"),Re=n("./src/PosthogTrackers.ts");const Ie=({mxEvent:e,getTile:t,getReplyChain:n,permalinkCreator:s,onFocusChange:o,getRelationsForEvent:a})=>{const[l,c,d,h]=(0,N.EF)(),[u,p]=(0,me.A9)(c);(0,r.useEffect)((()=>{o(l)}),[o,l]);const v=(0,r.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),d(),u()}),[d,u]);let g;if(l&&c.current){const o=null==t?void 0:t(),l=n(),d=c.current.getBoundingClientRect();g=r.createElement(D.A,(0,i.A)({},(0,N.qv)(d),{mxEvent:e,permalinkCreator:s,eventTileOps:o&&o.getEventTileOps?o.getEventTileOps():void 0,collapseReplyChain:null!=l&&l.canCollapse()?l.collapse:void 0,onFinished:h,getRelationsForEvent:a}))}return r.createElement(r.Fragment,null,r.createElement(N.oW,{className:"mx_MessageActionBar_iconButton mx_MessageActionBar_optionsButton",title:(0,m._t)("common|options"),onClick:v,onContextMenu:v,isExpanded:l,ref:c,onFocus:u,tabIndex:p?0:-1,placement:"left"},r.createElement(L.A,null)),g)},ke=({mxEvent:e,reactions:t,onFocusChange:n})=>{const[s,o,a,l]=(0,N.EF)(),[c,d]=(0,me.A9)(o);let h;if((0,r.useEffect)((()=>{n(s)}),[n,s]),s&&o.current){const n=o.current.getBoundingClientRect();h=r.createElement(N.Ay,(0,i.A)({},(0,N.qv)(n),{onFinished:l,managed:!1}),r.createElement(xe.A,{mxEvent:e,reactions:t,onFinished:l}))}const u=(0,r.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),a(),c()}),[a,c]);return r.createElement(r.Fragment,null,r.createElement(N.oW,{className:"mx_MessageActionBar_iconButton",title:(0,m._t)("action|react"),onClick:u,onContextMenu:u,isExpanded:s,ref:o,onFocus:c,tabIndex:d?0:-1,placement:"left"},r.createElement(ne,null)),h)},Te=({mxEvent:e})=>{var t;const n=(0,r.useContext)(we.E),i=null==e||null===(t=e.getRelation())||void 0===t?void 0:t.rel_type,s=!!i&&i!==l.RelationType.Thread,o=t=>{t.preventDefault(),t.stopPropagation();const i=e.getThread();null!=i&&i.rootEvent&&!e.isThreadRoot?p.A.dispatch({action:_.r.ShowThread,rootEvent:i.rootEvent,initialEvent:e,scroll_into_view:!0,highlighted:!0,push:n.isCard}):p.A.dispatch({action:_.r.ShowThread,rootEvent:e,push:n.isCard})},a=s?(0,m._t)("threads|error_start_thread_existing_relation"):(0,m._t)("action|reply_in_thread");return r.createElement(me.k,{className:"mx_MessageActionBar_iconButton mx_MessageActionBar_threadButton",disabled:s,title:a,onClick:o,onContextMenu:o,placement:"left"},r.createElement(V.A,null))};class De extends r.PureComponent{constructor(...e){super(...e),(0,s.A)(this,"onDecrypted",(()=>{this.forceUpdate()})),(0,s.A)(this,"onBeforeRedaction",(()=>{this.forceUpdate()})),(0,s.A)(this,"onRoomEvent",(e=>{e&&e.getType()===l.EventType.RoomPinnedEvents&&this.forceUpdate()})),(0,s.A)(this,"onSent",(()=>{this.forceUpdate()})),(0,s.A)(this,"onFocusChange",(e=>{var t,n;null===(t=(n=this.props).onFocusChange)||void 0===t||t.call(n,e)})),(0,s.A)(this,"onReplyClick",(e=>{e.preventDefault(),e.stopPropagation(),p.A.dispatch({action:"reply_to_event",event:this.props.mxEvent,context:this.context.timelineRenderingType})})),(0,s.A)(this,"onEditClick",(e=>{e.preventDefault(),e.stopPropagation(),(0,he.ju)(b.J.safeGet(),this.props.mxEvent,this.context.timelineRenderingType,this.props.getRelationsForEvent)})),(0,s.A)(this,"forbiddenThreadHeadMsgType",[l.MsgType.KeyVerificationRequest]),(0,s.A)(this,"onResendClick",(e=>{e.preventDefault(),e.stopPropagation(),this.runActionOnFailedEv((e=>pe.A.resend(b.J.safeGet(),e)))})),(0,s.A)(this,"onCancelClick",(e=>{this.runActionOnFailedEv((e=>pe.A.removeFromQueue(b.J.safeGet(),e)),(e=>(0,he.d1)(e.status)))})),(0,s.A)(this,"onPinClick",(async(e,t)=>{e.preventDefault(),e.stopPropagation(),await Se.A.pinOrUnpinEvent(b.J.safeGet(),this.props.mxEvent),Re.A.trackPinUnpinMessage(t?"Pin":"Unpin","Timeline")}))}componentDidMount(){var e;this.props.mxEvent.status&&this.props.mxEvent.status!==l.EventStatus.SENT&&this.props.mxEvent.on(l.MatrixEventEvent.Status,this.onSent);b.J.safeGet().decryptEventIfNeeded(this.props.mxEvent),this.props.mxEvent.isBeingDecrypted()&&this.props.mxEvent.once(l.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.on(l.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),null===(e=this.context.room)||void 0===e||null===(e=e.getLiveTimeline().getState(l.EventTimeline.FORWARDS))||void 0===e||e.on(l.RoomStateEvent.Events,this.onRoomEvent)}componentWillUnmount(){var e;this.props.mxEvent.off(l.MatrixEventEvent.Status,this.onSent),this.props.mxEvent.off(l.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.off(l.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),null===(e=this.context.room)||void 0===e||null===(e=e.getLiveTimeline().getState(l.EventTimeline.FORWARDS))||void 0===e||e.off(l.RoomStateEvent.Events,this.onRoomEvent)}get showReplyInThreadAction(){const e=this.context.timelineRenderingType!==C.Ae.Thread,t=!this.forbiddenThreadHeadMsgType.includes(this.props.mxEvent.getContent().msgtype)&&!l.M_BEACON_INFO.matches(this.props.mxEvent.getType());return be.A.isFeatureActiveForHomeserver("feature_thread")&&e&&t}runActionOnFailedEv(e,t){t||(t=()=>!0);const n=this.props.mxEvent,i=n.replacingEvent(),s=[n.localRedactionEvent(),i,n];for(const n of s)if(n&&t(n)){e(n);break}}render(){var e,t;const n=[];if((0,he.wQ)(b.J.safeGet(),this.props.mxEvent)&&n.push(r.createElement(me.k,{className:"mx_MessageActionBar_iconButton",title:(0,m._t)("action|edit"),onClick:this.onEditClick,onContextMenu:this.onEditClick,key:"edit",placement:"left"},r.createElement(X,null))),Se.A.canPin(b.J.safeGet(),this.props.mxEvent)||Se.A.canUnpin(b.J.safeGet(),this.props.mxEvent)){const e=Se.A.isPinned(b.J.safeGet(),this.props.mxEvent);n.push(r.createElement(me.k,{className:"mx_MessageActionBar_iconButton",title:e?(0,m._t)("action|unpin"):(0,m._t)("action|pin"),onClick:t=>this.onPinClick(t,e),onContextMenu:t=>this.onPinClick(t,e),key:"pin",placement:"left"},e?r.createElement(H.A,null):r.createElement(G.A,null)))}const i=r.createElement(me.k,{className:"mx_MessageActionBar_iconButton",title:(0,m._t)("action|delete"),onClick:this.onCancelClick,onContextMenu:this.onCancelClick,key:"cancel",placement:"left"},r.createElement(z.A,null)),s=r.createElement(Te,{mxEvent:this.props.mxEvent,key:"reply_thread"}),o=this.props.mxEvent,c=null===(e=o.replacingEvent())||void 0===e?void 0:e.status,d=null===(t=o.localRedactionEvent())||void 0===t?void 0:t.status,h=(0,he.d1)(o.status)||(0,he.d1)(c)||(0,he.d1)(d),u=[o.status,c,d].includes(l.EventStatus.NOT_SENT);if(h&&u)n.splice(0,0,r.createElement(me.k,{className:"mx_MessageActionBar_iconButton mx_MessageActionBar_retryButton",title:(0,m._t)("action|retry"),onClick:this.onResendClick,onContextMenu:this.onResendClick,key:"resend",placement:"left"},r.createElement(K.A,null))),n.push(i);else{if((0,he.qe)(this.props.mxEvent)?(this.context.canSendMessages&&(this.showReplyInThreadAction&&n.splice(0,0,s),n.splice(0,0,r.createElement(me.k,{className:"mx_MessageActionBar_iconButton",title:(0,m._t)("action|reply"),onClick:this.onReplyClick,onContextMenu:this.onReplyClick,key:"reply",placement:"left"},r.createElement(W,null)))),this.context.canReact&&!this.context.search&&n.splice(0,0,r.createElement(ke,{mxEvent:this.props.mxEvent,reactions:this.props.reactions,onFocusChange:this.onFocusChange,key:"react"})),ve.j.isEligible(this.props.mxEvent)&&n.splice(0,0,r.createElement(Ee,{mxEvent:this.props.mxEvent,mediaEventHelperGet:()=>{var e,t;return null===(e=this.props.getTile())||void 0===e||null===(t=e.getMediaHelper)||void 0===t?void 0:t.call(e)},key:"download"}))):this.context.timelineRenderingType===C.Ae.Room&&this.props.mxEvent.getThread()&&n.unshift(s),h&&n.push(i),void 0!==this.props.isQuoteExpanded&&(0,A.c$)(this.props.mxEvent)){const e=a()({mx_MessageActionBar_iconButton:!0,mx_MessageActionBar_expandCollapseMessageButton:!0});n.push(r.createElement(me.k,{className:e,title:this.props.isQuoteExpanded?(0,m._t)("timeline|mab|collapse_reply_chain"):(0,m._t)("timeline|mab|expand_reply_chain"),caption:(0,m._t)(Ce.hm[Ae.Uz.SHIFT])+" + "+(0,m._t)("action|click"),onClick:this.props.toggleThreadExpanded,key:"expand",placement:"left"},this.props.isQuoteExpanded?r.createElement(de,null):r.createElement(oe,null)))}n.push(r.createElement(Ie,{mxEvent:this.props.mxEvent,getReplyChain:this.props.getReplyChain,getTile:this.props.getTile,permalinkCreator:this.props.permalinkCreator,onFocusChange:this.onFocusChange,key:"menu",getRelationsForEvent:this.props.getRelationsForEvent}))}return r.createElement(ue.A,{className:"mx_MessageActionBar","aria-label":(0,m._t)("timeline|mab|label"),"aria-live":"off"},n)}}(0,s.A)(De,"contextType",C.Ay);var Ne=n("./node_modules/lodash/lodash.js"),Me=n("./node_modules/matrix-js-sdk/src/NamespacedValue.ts"),Oe=n("./src/accessibility/context_menu/ContextMenuTooltipButton.tsx"),Pe=n("./src/customisations/Media.ts"),je=n("./src/HtmlUtils.tsx"),Fe=n("./src/contexts/MatrixClientContext.tsx");class Ue extends r.PureComponent{render(){const{content:e,reactionEvents:t,mxEvent:n,children:i}=this.props,s=this.context.getRoom(n.getRoomId());if(s){const n=[];let a;for(const e of t){var o;const t=s.getMember(e.getSender()),i=null!==(o=null==t?void 0:t.name)&&void 0!==o?o:e.getSender();n.push(i),a=this.props.customReactionImagesEnabled&&Le.findIn(e.getContent())||void 0}const l=(0,je.aS)(e)||a,c=(0,f.ki)(n,6),d=l?(0,m._t)("timeline|reactions|tooltip_caption",{shortName:l}):void 0;return r.createElement(u.m,{description:c,caption:d,placement:"right"},i)}return i}}(0,s.A)(Ue,"contextType",Fe.Ay);class Be extends r.PureComponent{constructor(...e){super(...e),(0,s.A)(this,"onClick",(()=>{const{mxEvent:e,myReactionEvent:t,content:n}=this.props;t?this.context.redactEvent(e.getRoomId(),t.getId()):(this.context.sendEvent(e.getRoomId(),l.EventType.Reaction,{"m.relates_to":{rel_type:l.RelationType.Annotation,event_id:e.getId(),key:n}}),p.A.dispatch({action:"message_sent"}))}))}render(){const{mxEvent:e,content:t,count:n,reactionEvents:i,myReactionEvent:s}=this.props,o=a()({mx_ReactionsRowButton:!0,mx_ReactionsRowButton_selected:!!s}),l=this.context.getRoom(e.getRoomId());let c,d;if(l){const e=[];for(const t of i){const n=l.getMember(t.getSender());e.push((null==n?void 0:n.name)||t.getSender()),d=this.props.customReactionImagesEnabled&&Le.findIn(t.getContent())||void 0}const n=(0,f.ki)(e,6);c=t?(0,m._t)("timeline|reactions|label",{reactors:n,content:d||t}):n}let h=r.createElement("span",{className:"mx_ReactionsRowButton_content","aria-hidden":"true"},t);if(this.props.customReactionImagesEnabled&&t.startsWith("mxc://")){const e=(0,Pe.lH)(t).srcHttp;e&&(h=r.createElement("img",{className:"mx_ReactionsRowButton_content",alt:d||(0,m._t)("timeline|reactions|custom_reaction_fallback_label"),src:e,width:"16",height:"16"}))}return r.createElement(Ue,{mxEvent:this.props.mxEvent,content:t,reactionEvents:i,customReactionImagesEnabled:this.props.customReactionImagesEnabled},r.createElement(w.A,{className:o,"aria-label":c,onClick:this.onClick,disabled:this.props.disabled},h,r.createElement("span",{className:"mx_ReactionsRowButton_count","aria-hidden":"true"},n)))}}(0,s.A)(Be,"contextType",Fe.Ay);const Le=new Me.qr("shortcode","com.beeper.reaction.shortcode"),Ve=({mxEvent:e,reactions:t})=>{const[n,s,o,l]=(0,N.EF)();let c;if(n&&s.current){const n=s.current.getBoundingClientRect();c=r.createElement(N.Ay,(0,i.A)({},(0,N.qv)(n),{onFinished:l,managed:!1}),r.createElement(xe.A,{mxEvent:e,reactions:t,onFinished:l}))}return r.createElement(r.Fragment,null,r.createElement(Oe.o,{className:a()("mx_ReactionsRow_addReactionButton",{mx_ReactionsRow_addReactionButton_active:n}),title:(0,m._t)("timeline|reactions|add_reaction_prompt"),onClick:o,onContextMenu:e=>{e.preventDefault(),o()},isExpanded:n,ref:s}),c)};class He extends r.PureComponent{constructor(e,t){super(e,t),(0,s.A)(this,"onDecrypted",(()=>{this.forceUpdate()})),(0,s.A)(this,"onReactionsChange",(()=>{this.setState({myReactions:this.getMyReactions()}),this.forceUpdate()})),(0,s.A)(this,"onShowAllClick",(()=>{this.setState({showAll:!0})})),this.state={myReactions:this.getMyReactions(),showAll:!1}}componentDidMount(){const{mxEvent:e,reactions:t}=this.props;(e.isBeingDecrypted()||e.shouldAttemptDecryption())&&e.once(l.MatrixEventEvent.Decrypted,this.onDecrypted),t&&(t.on(l.RelationsEvent.Add,this.onReactionsChange),t.on(l.RelationsEvent.Remove,this.onReactionsChange),t.on(l.RelationsEvent.Redaction,this.onReactionsChange))}componentWillUnmount(){const{mxEvent:e,reactions:t}=this.props;e.off(l.MatrixEventEvent.Decrypted,this.onDecrypted),t&&(t.off(l.RelationsEvent.Add,this.onReactionsChange),t.off(l.RelationsEvent.Remove,this.onReactionsChange),t.off(l.RelationsEvent.Redaction,this.onReactionsChange))}componentDidUpdate(e){this.props.reactions&&e.reactions!==this.props.reactions&&(this.props.reactions.on(l.RelationsEvent.Add,this.onReactionsChange),this.props.reactions.on(l.RelationsEvent.Remove,this.onReactionsChange),this.props.reactions.on(l.RelationsEvent.Redaction,this.onReactionsChange),this.onReactionsChange())}getMyReactions(){var e,t;const n=this.props.reactions;if(!n)return null;const i=null===(e=this.context.room)||void 0===e?void 0:e.client.getUserId();if(!i)return null;const s=null===(t=n.getAnnotationsBySender())||void 0===t?void 0:t[i];return s?[...s.values()]:null}render(){var e,t;const{mxEvent:n,reactions:i}=this.props,{myReactions:s,showAll:o}=this.state;if(!i||!(0,he.qe)(n))return null;const a=g.A.getValue("feature_render_reaction_images");let l,c,d=null===(e=i.getSortedAnnotationsByKey())||void 0===e?void 0:e.map((([e,t])=>{if(!t.size)return null;const i=(0,Ne.uniqBy)([...t],(e=>e.getSender())),o=null==s?void 0:s.find((t=>{var n;return!t.isRedacted()&&(null===(n=t.getRelation())||void 0===n?void 0:n.key)===e}));return r.createElement(Be,{key:e,content:e,count:i.length,mxEvent:n,reactionEvents:i,myReactionEvent:o,customReactionImagesEnabled:a,disabled:!this.context.canReact||o&&!o.isRedacted()&&!this.context.canSelfRedact})})).filter((e=>!!e));return null!==(t=d)&&void 0!==t&&t.length?(d.length>9&&!o&&(d=d.slice(0,8),l=r.createElement(w.A,{kind:"link_inline",className:"mx_ReactionsRow_showAll",onClick:this.onShowAllClick},(0,m._t)("action|show_all"))),this.context.canReact&&(c=r.createElement(Ve,{mxEvent:n,reactions:i})),r.createElement("div",{className:"mx_ReactionsRow",role:"toolbar","aria-label":(0,m._t)("common|reactions")},d,l,c)):null}}(0,s.A)(He,"contextType",C.Ay);var Ge=n("./src/utils/EventRenderingUtils.ts"),ze=n("./src/utils/strings.ts"),Ke=n("./src/DecryptionFailureTracker.ts"),qe=n("./src/components/views/messages/RedactedBody.tsx"),Je=n("./src/Modal.tsx"),We=n("./src/SdkConfig.ts"),Ye=n("./src/components/views/dialogs/BugReportDialog.tsx"),$e=n("./src/components/structures/ViewSource.tsx");class Qe extends r.Component{constructor(e){super(e),(0,s.A)(this,"onBugReport",(()=>{Je.Ay.createDialog(Ye.A,{label:"react-soft-crash-tile",error:this.state.error})})),(0,s.A)(this,"onViewSource",(()=>{Je.Ay.createDialog($e.A,{mxEvent:this.props.mxEvent},"mx_Dialog_viewsource")})),this.state={}}static getDerivedStateFromError(e){return{error:e}}render(){if(this.state.error){const{mxEvent:e}=this.props,t={mx_EventTile:!0,mx_EventTile_info:!0,mx_EventTile_content:!0,mx_EventTile_tileError:!0};let n,i;return We.Ay.get().bug_report_endpoint_url&&(n=r.createElement(r.Fragment,null,"",r.createElement(w.A,{kind:"link",onClick:this.onBugReport},(0,m._t)("bug_reporting|submit_debug_logs")))),e&&g.A.getValue("developerMode")&&(i=r.createElement(r.Fragment,null,"",r.createElement(w.A,{onClick:this.onViewSource,kind:"link"},(0,m._t)("action|view_source")))),r.createElement("li",{className:a()(t),"data-layout":this.props.layout},r.createElement("div",{className:"mx_EventTile_line"},r.createElement("span",null,(0,m._t)("timeline|error_rendering_message"),e&&` (${e.getType()})`,n,i)))}return this.props.children}}var Xe=n("./src/events/EventTileFactory.tsx"),Ze=n("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),et=n("./node_modules/@vector-im/compound-web/dist/components/Icon/IndicatorIcon/IndicatorIcon.js"),tt=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/threads-solid.js"),nt=n("./src/hooks/useEventEmitter.ts"),it=n("./src/hooks/useUnreadNotifications.ts"),st=n("./src/utils/notifications.ts"),rt=n("./src/components/views/rooms/EventPreview.tsx"),ot=n("./src/components/views/elements/ExternalLink.tsx"),at=n("./src/tchap/util/TchapUrls.ts"),lt=n("./src/contexts/ScopedRoomContext.tsx");const ct=["mxEvent","thread"],dt=({thread:e,showDisplayname:t=!1})=>{var n,i,s;const o=null!==(n=(0,nt.DY)(e,l.ThreadEvent.Update,(()=>e.replyToEvent)))&&void 0!==n?n:void 0,a=(0,rt.c5)(o);return a&&o?r.createElement(r.Fragment,null,r.createElement(F.A,{member:o.sender,fallbackUserId:o.getSender(),size:"24px",className:"mx_ThreadSummary_avatar"}),t&&r.createElement("div",{className:"mx_ThreadSummary_sender"},null!==(i=null===(s=o.sender)||void 0===s?void 0:s.name)&&void 0!==i?i:o.getSender()),o.isDecryptionFailure()?r.createElement("div",{className:"mx_ThreadSummary_content mx_DecryptionFailureBody",title:(0,m._t)("timeline|decryption_failure|unable_to_decrypt")},r.createElement("span",{className:"mx_ThreadSummary_message-preview"},(0,m._t)("threads|unable_to_decrypt_with_info_message",{},{a:e=>r.createElement(ot.A,{href:at.A.lockedMessagesPage},e)}))):r.createElement(rt.BM,{preview:a,className:"mx_ThreadSummary_content"})):null},ht=e=>{let{mxEvent:t,thread:n}=e,s=(0,Ze.A)(e,ct);const o=(0,lt.ME)("narrow"),a=(0,r.useContext)(we.E),c=(0,nt.DY)(n,l.ThreadEvent.Update,(()=>n.length)),{level:d}=(0,it.X)(n.room,n.id);if(!c)return null;let h=c;return o.narrow||(h=(0,m._t)("threads|count_of_reply",{count:c})),r.createElement(w.A,(0,i.A)({},s,{className:"mx_ThreadSummary",onClick:e=>{p.A.dispatch({action:_.r.ShowThread,rootEvent:t,push:a.isCard}),Re.A.trackInteraction("WebRoomTimelineThreadSummaryButton",e)},"aria-label":(0,m._t)("threads|open_thread")}),r.createElement(et.N,{size:"24px",indicator:(0,st.W7)(d)},r.createElement(tt.A,null)),r.createElement("span",{className:"mx_ThreadSummary_replies_amount"},h),r.createElement(dt,{thread:n,showDisplayname:!o.narrow}),r.createElement("div",{className:"mx_ThreadSummary_chevron"}))};class ut extends r.Component{constructor(e){super(e),(0,s.A)(this,"nodes",{}),(0,s.A)(this,"children",{}),this.updateChildren(this.props.children)}componentDidUpdate(){this.updateChildren(this.props.children)}applyStyles(e,t){Object.entries(t).forEach((([t,n])=>{e.style[t]=n}))}updateChildren(e){const t=this.children||{};this.children={},r.Children.toArray(e).forEach((e=>{if(function(e){return"object"==typeof e&&"type"in e}(e))if(t[e.key]){const n=t[e.key],i=this.nodes[n.key];i&&i.style.left!==e.props.style.left&&this.applyStyles(i,{left:e.props.style.left}),this.children[e.key]=r.cloneElement(n,e.props,e.props.children)}else{const t={},n=e.props.style,i=this.props.startStyles;if(i.length>0){const e=i[0];t.style=e}t.ref=t=>this.collectNode(e.key,t,n),this.children[e.key]=r.cloneElement(e,t)}}))}collectNode(e,t,n){const i="bigint"==typeof e?Number(e):e;if(t&&void 0===this.nodes[i]&&this.props.startStyles.length>0){const e=this.props.startStyles;for(let n=1;n<e.length;++n)this.applyStyles(t,e[n]);window.setTimeout((()=>{this.applyStyles(t,n)}),0)}t?this.nodes[i]=t:delete this.nodes[i],this.props.innerRef&&(this.props.innerRef.current=t)}render(){return r.createElement(r.Fragment,null,Object.values(this.children))}}(0,s.A)(ut,"defaultProps",{startStyles:[]});var mt=n("./src/utils/units.ts");class pt extends r.PureComponent{constructor(e){super(e),(0,s.A)(this,"avatar",(0,r.createRef)()),this.state={suppressDisplay:!this.props.suppressAnimation}}componentWillUnmount(){const e=this.props.readReceiptPosition;e&&(this.props.checkUnmounting&&this.props.checkUnmounting()||this.buildReadReceiptInfo(e))}componentDidMount(){this.state.suppressDisplay&&this.animateMarker()}componentDidUpdate(e){const t=e.offset!==this.props.offset,n=e.hidden!==this.props.hidden;(t||n)&&this.animateMarker()}buildReadReceiptInfo(e={}){const t=this.avatar.current,n=null==t?void 0:t.offsetParent;if(!n||!n.getBoundingClientRect)return c.v.warn(`ReadReceiptMarker for ${this.props.fallbackUserId} has no valid horizontalContainer`),e.top=0,e.right=0,e;const i=t.getBoundingClientRect();return e.top=i.top,e.right=i.right-n.getBoundingClientRect().right,e}animateMarker(){var e;const t=this.props.readReceiptPosition,n=null!==(e=this.buildReadReceiptInfo().top)&&void 0!==e?e:0,i=t&&void 0!==t.top?t.top:-gt,s=[];null!=t&&t.right&&s.push({top:i-n,right:t.right}),s.push({top:i-n,right:0}),this.setState({suppressDisplay:!1,startStyles:s})}render(){var e;if(this.state.suppressDisplay)return r.createElement("div",{ref:this.avatar});const t={right:(0,mt.c)(this.props.offset),top:"0px"};return r.createElement(ut,{startStyles:this.state.startStyles,innerRef:this.avatar},r.createElement(F.A,{member:null!==(e=this.props.member)&&void 0!==e?e:null,fallbackUserId:this.props.fallbackUserId,"aria-hidden":"true","aria-live":"off",size:"14px",style:t,hideTitle:!0,tabIndex:-1}))}}var vt=n("./src/components/structures/AutoHideScrollbar.tsx");const gt=16;function ft({readReceipts:e,readReceiptMap:t,checkUnmounting:n,suppressAnimation:s,isTwelveHour:o}){const[a,l,c,d]=(0,N.EF)(),h=e.length>4?3:4,p=function(e,t){return(0,f.ki)(e,t)}(e.map((e=>{var t,n;return null!==(t=null===(n=e.roomMember)||void 0===n?void 0:n.name)&&void 0!==t?t:e.userId})),h);if(0===e.length)return r.createElement("div",{className:"mx_EventTile_msgOption"},r.createElement("div",{className:"mx_ReadReceiptGroup"},r.createElement("div",{className:"mx_ReadReceiptGroup_button"},r.createElement("span",{className:"mx_ReadReceiptGroup_container"}))));const v=e.map(((e,i)=>{const{hidden:a,position:l}=function(e,t){return e<t?{hidden:!1,position:e}:{hidden:!0,position:0}}(i,h),c=e.userId;let d;return t&&(d=t[c],d||(d={},t[c]=d)),r.createElement(pt,{key:c,member:e.roomMember,fallbackUserId:c,offset:10*l,hidden:a,readReceiptPosition:d,checkUnmounting:n,suppressAnimation:s,timestamp:e.ts,showTwelveHour:o})})).reverse();let g;const _=e.length-h;let y;if(_>0&&(g=r.createElement("span",{className:"mx_ReadReceiptGroup_remainder","aria-live":"off"},"+",_)),a&&l.current){const t=l.current.getBoundingClientRect();y=r.createElement(N.Ay,(0,i.A)({menuClassName:"mx_ReadReceiptGroup_popup",onFinished:d},(0,N.qv)(t)),r.createElement(vt.A,null,r.createElement(yt,{className:"mx_ReadReceiptGroup_title"},(0,m._t)("timeline|read_receipt_title",{count:e.length})),e.map((e=>r.createElement(_t,(0,i.A)({key:e.userId},e,{isTwelveHour:o,onAfterClick:d}))))))}return r.createElement("div",{className:"mx_EventTile_msgOption"},r.createElement(u.m,{label:(0,m._t)("timeline|read_receipt_title",{count:e.length}),caption:p,placement:"top-end"},r.createElement("div",{className:"mx_ReadReceiptGroup",role:"group","aria-label":(0,m._t)("timeline|read_receipts_label")},r.createElement(w.A,{className:"mx_ReadReceiptGroup_button",ref:l,"aria-label":p,"aria-haspopup":"true",onClick:c},g,r.createElement("span",{className:"mx_ReadReceiptGroup_container",style:{width:10*Math.min(h,e.length)+gt-10}},v)),y)))}function _t({userId:e,roomMember:t,ts:n,isTwelveHour:i,onAfterClick:s}){var o,a;return r.createElement(u.m,{description:null!==(o=null==t?void 0:t.rawDisplayName)&&void 0!==o?o:e,caption:e,placement:"top"},r.createElement("div",null,r.createElement(N.Dr,{className:"mx_ReadReceiptGroup_person",onClick:()=>{p.A.dispatch({action:_.r.ViewUser,member:null!=t?t:{userId:e},push:!1}),null==s||s()}},r.createElement(F.A,{member:t,fallbackUserId:e,size:"24px","aria-hidden":"true","aria-live":"off",resizeMethod:"crop",hideTitle:!0}),r.createElement("div",{className:"mx_ReadReceiptGroup_name"},r.createElement("p",null,null!==(a=null==t?void 0:t.name)&&void 0!==a?a:e),r.createElement("p",{className:"mx_ReadReceiptGroup_secondary"},(0,I.Yq)(new Date(n),i))))))}function yt({className:e,children:t}){const[n,,i]=(0,me.A9)();return r.createElement("h3",{className:e,role:"menuitem",onFocus:n,tabIndex:-1,ref:i},t)}var Et=n("./src/utils/localRoom/isLocalRoom.ts"),xt=n("./src/models/Call.ts"),wt=n("./src/components/views/rooms/NotificationBadge/StatelessNotificationBadge.tsx");function At({room:e,threadId:t,forceDot:n}){const{symbol:i,count:s,level:o}=(0,it.X)(e,t);return r.createElement(wt.V,{symbol:i,count:s,level:o,forceDot:n})}var Ct,bt=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/link.js");function St(){return St=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},St.apply(null,arguments)}var Rt=function(e,t){return r.createElement("svg",St({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",role:"presentation","aria-hidden":!0,ref:t},e),Ct||(Ct=r.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M1 2.75A.75.75 0 0 1 1.75 2h.005a.75.75 0 0 1 0 1.5H1.75A.75.75 0 0 1 1 2.75m2.495 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.005a.75.75 0 0 1 0 1.5h-.005a.75.75 0 0 1-.75-.75M1 6.75A.75.75 0 0 1 1.75 6h8.5a.75.75 0 0 1 0 1.5h-8.5A.75.75 0 0 1 1 6.75m0 3A.75.75 0 0 1 1.75 9h4.5a.75.75 0 0 1 0 1.5h-4.5A.75.75 0 0 1 1 9.75m0 4a.75.75 0 0 1 .75-.75h.005a.75.75 0 0 1 0 1.5H1.75a.75.75 0 0 1-.75-.75m2.495 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.005a.75.75 0 0 1 0 1.5h-.005a.75.75 0 0 1-.75-.75",clipRule:"evenodd"})))},It=(0,r.forwardRef)(Rt);function kt({viewInRoom:e,copyLinkToThread:t}){return r.createElement(ue.A,{className:"mx_MessageActionBar","aria-label":(0,m._t)("timeline|mab|label"),"aria-live":"off"},r.createElement(me.k,{className:"mx_MessageActionBar_iconButton",onClick:e,title:(0,m._t)("timeline|mab|view_in_room"),key:"view_in_room"},r.createElement(It,null)),r.createElement(me.k,{className:"mx_MessageActionBar_iconButton",onClick:t,title:(0,m._t)("timeline|mab|copy_link_thread"),key:"copy_link_to_thread"},r.createElement(bt.A,null)))}var Tt=n("./src/components/structures/grouper/LateEventGrouper.ts"),Dt=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/pin-solid.js");function Nt(){return r.createElement("div",{className:"mx_PinnedMessageBadge"},r.createElement(Dt.A,{width:"16px",height:"16px"}),(0,m._t)("room|pinned_message_badge"))}function Mt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Ot(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Mt(Object(n),!0).forEach((function(t){(0,s.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Mt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Pt(e){return!(!(0,Xe.S8)(e)&&e.getType()!==l.EventType.RoomMessageEncrypted)}class jt extends r.Component{constructor(e,t){super(e,t),(0,s.A)(this,"suppressReadReceiptAnimation",void 0),(0,s.A)(this,"isListeningForReceipts",void 0),(0,s.A)(this,"tile",(0,r.createRef)()),(0,s.A)(this,"replyChain",(0,r.createRef)()),(0,s.A)(this,"ref",(0,r.createRef)()),(0,s.A)(this,"unmounted",!1),(0,s.A)(this,"updateThread",(e=>{this.setState({thread:e})})),(0,s.A)(this,"onNewThread",(e=>{if(e.id===this.props.mxEvent.getId()){this.updateThread(e);const t=b.J.safeGet().getRoom(this.props.mxEvent.getRoomId());null==t||t.off(l.ThreadEvent.New,this.onNewThread)}})),(0,s.A)(this,"viewInRoom",(e=>{e.preventDefault(),e.stopPropagation(),p.A.dispatch({action:_.r.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId(),metricsTrigger:void 0})})),(0,s.A)(this,"copyLinkToThread",(async e=>{e.preventDefault(),e.stopPropagation();const{permalinkCreator:t,mxEvent:n}=this.props;if(!t)return;const i=t.forEvent(n.getId());await(0,ze.nC)(i)})),(0,s.A)(this,"onRoomReceipt",((e,t)=>{t===b.J.safeGet().getRoom(this.props.mxEvent.getRoomId())&&(this.shouldShowSentReceipt||this.shouldShowSendingReceipt||this.isListeningForReceipts)&&this.forceUpdate((()=>{this.shouldShowSentReceipt||this.shouldShowSendingReceipt||(b.J.safeGet().removeListener(l.RoomEvent.Receipt,this.onRoomReceipt),this.isListeningForReceipts=!1)}))})),(0,s.A)(this,"onDecrypted",(()=>{this.verifyEvent(),this.forceUpdate(this.props.onHeightChanged)})),(0,s.A)(this,"onUserVerificationChanged",((e,t)=>{e===this.props.mxEvent.getSender()&&this.verifyEvent()})),(0,s.A)(this,"onReplaced",(()=>{this.verifyEvent()})),(0,s.A)(this,"onSenderProfileClick",(()=>{p.A.dispatch({action:_.r.ComposerInsert,userId:this.props.mxEvent.getSender(),timelineRenderingType:this.context.timelineRenderingType})})),(0,s.A)(this,"onPermalinkClicked",(e=>{e.preventDefault(),p.A.dispatch({action:_.r.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId(),metricsTrigger:this.context.timelineRenderingType===C.Ae.Search?"MessageSearch":void 0})})),(0,s.A)(this,"onActionBarFocusChange",(e=>{this.setState({actionBarFocused:e})})),(0,s.A)(this,"getTile",(()=>this.tile.current)),(0,s.A)(this,"getReplyChain",(()=>this.replyChain.current)),(0,s.A)(this,"getReactions",(()=>{var e;if(!this.props.showReactions||!this.props.getRelationsForEvent)return null;const t=this.props.mxEvent.getId();return null!==(e=this.props.getRelationsForEvent(t,"m.annotation","m.reaction"))&&void 0!==e?e:null})),(0,s.A)(this,"onReactionsCreated",((e,t)=>{"m.annotation"===e&&"m.reaction"===t&&this.setState({reactions:this.getReactions()})})),(0,s.A)(this,"onContextMenu",(e=>{this.showContextMenu(e)})),(0,s.A)(this,"onTimestampContextMenu",(e=>{var t;this.showContextMenu(e,null===(t=this.props.permalinkCreator)||void 0===t?void 0:t.forEvent(this.props.mxEvent.getId()))})),(0,s.A)(this,"onCloseMenu",(()=>{this.setState({contextMenu:void 0,actionBarFocused:!1})})),(0,s.A)(this,"setQuoteExpanded",(e=>{this.setState({isQuoteExpanded:e})}));const n=this.thread;this.state={actionBarFocused:!1,shieldColour:h.EventShieldColour.NONE,shieldReason:null,reactions:this.getReactions(),hover:!1,thread:n},this.suppressReadReceiptAnimation=!0,this.isListeningForReceipts=!1}get isEligibleForSpecialReceipt(){if(this.props.readReceipts&&this.props.readReceipts.length>0)return!1;if(!this.props.mxEvent)return!1;if(!b.J.safeGet().getRoom(this.props.mxEvent.getRoomId()))return!1;const e=b.J.safeGet().getSafeUserId();return this.props.mxEvent.getSender()===e&&Pt(this.props.mxEvent)}get shouldShowSentReceipt(){if(!this.isEligibleForSpecialReceipt)return!1;if(!this.props.lastSuccessful)return!1;if(this.props.eventSendStatus&&this.props.eventSendStatus!==l.EventStatus.SENT)return!1;const e=this.props.readReceipts||[],t=b.J.safeGet().getUserId();return!e.some((e=>e.userId!==t))}get shouldShowSendingReceipt(){return!!this.isEligibleForSpecialReceipt&&!(!this.props.eventSendStatus||this.props.eventSendStatus===l.EventStatus.SENT)}componentDidMount(){this.unmounted=!1,this.suppressReadReceiptAnimation=!1;const e=b.J.safeGet();this.props.forExport||(e.on(h.CryptoEvent.UserTrustStatusChanged,this.onUserVerificationChanged),this.props.mxEvent.on(l.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.on(l.MatrixEventEvent.Replaced,this.onReplaced),Ke.o.instance.addVisibleEvent(this.props.mxEvent),this.props.showReactions&&this.props.mxEvent.on(l.MatrixEventEvent.RelationsCreated,this.onReactionsCreated),(this.shouldShowSentReceipt||this.shouldShowSendingReceipt)&&(e.on(l.RoomEvent.Receipt,this.onRoomReceipt),this.isListeningForReceipts=!0)),this.props.mxEvent.on(l.ThreadEvent.Update,this.updateThread),e.decryptEventIfNeeded(this.props.mxEvent);const t=e.getRoom(this.props.mxEvent.getRoomId());null==t||t.on(l.ThreadEvent.New,this.onNewThread),this.verifyEvent()}shouldComponentUpdate(e,t){return!!(0,M.No)(this.state,t)||!this.propsEqual(this.props,e)}componentWillUnmount(){const e=b.J.get();if(e){e.removeListener(h.CryptoEvent.UserTrustStatusChanged,this.onUserVerificationChanged),e.removeListener(l.RoomEvent.Receipt,this.onRoomReceipt);const t=e.getRoom(this.props.mxEvent.getRoomId());null==t||t.off(l.ThreadEvent.New,this.onNewThread)}this.isListeningForReceipts=!1,this.props.mxEvent.removeListener(l.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.removeListener(l.MatrixEventEvent.Replaced,this.onReplaced),this.props.showReactions&&this.props.mxEvent.removeListener(l.MatrixEventEvent.RelationsCreated,this.onReactionsCreated),this.props.mxEvent.off(l.ThreadEvent.Update,this.updateThread),this.unmounted=!1}componentDidUpdate(e,t){t.shieldColour!==this.state.shieldColour&&this.props.onHeightChanged&&this.props.onHeightChanged(),this.isListeningForReceipts||!this.shouldShowSentReceipt&&!this.shouldShowSendingReceipt||(b.J.safeGet().on(l.RoomEvent.Receipt,this.onRoomReceipt),this.isListeningForReceipts=!0),e.eventSendStatus!==this.props.eventSendStatus&&this.verifyEvent()}get thread(){let e=this.props.mxEvent.getThread();if(!e){var t;const n=b.J.safeGet().getRoom(this.props.mxEvent.getRoomId());e=null!==(t=null==n?void 0:n.findThreadForEvent(this.props.mxEvent))&&void 0!==t?t:void 0}return null!=e?e:null}renderThreadPanelSummary(){return this.state.thread?r.createElement("div",{className:"mx_ThreadPanel_replies"},r.createElement("span",{className:"mx_ThreadPanel_replies_amount"},this.state.thread.length),r.createElement(dt,{thread:this.state.thread})):null}renderThreadInfo(){return this.state.thread&&this.state.thread.id===this.props.mxEvent.getId()?r.createElement(ht,{mxEvent:this.props.mxEvent,thread:this.state.thread}):this.context.timelineRenderingType===C.Ae.Search&&this.props.mxEvent.threadRootId?this.props.highlightLink?r.createElement("a",{className:"mx_ThreadSummary_icon",href:this.props.highlightLink},(0,m._t)("timeline|thread_info_basic")):r.createElement("p",{className:"mx_ThreadSummary_icon"},(0,m._t)("timeline|thread_info_basic")):void 0}verifyEvent(){this.doVerifyEvent().catch((e=>{const t=this.props.mxEvent;c.v.error(`Error getting encryption info on event ${t.getId()} in room ${t.getRoomId()}`,e)}))}async doVerifyEvent(){var e,t,n;const i=null!==(e=this.props.mxEvent.replacingEvent())&&void 0!==e?e:this.props.mxEvent;if(!i.isEncrypted()||i.isRedacted())return void this.setState({shieldColour:h.EventShieldColour.NONE,shieldReason:null});const s=null!==(t=await(null===(n=b.J.safeGet().getCrypto())||void 0===n?void 0:n.getEncryptionInfoForEvent(i)))&&void 0!==t?t:null;this.unmounted||(null!==s?this.setState({shieldColour:s.shieldColour,shieldReason:s.shieldReason}):this.setState({shieldColour:h.EventShieldColour.NONE,shieldReason:null}))}propsEqual(e,t){const n=Object.keys(e),i=Object.keys(t);if(n.length!==i.length)return!1;for(let i=0;i<n.length;i++){const s=n[i];if(!t.hasOwnProperty(s))return!1;if("readReceipts"===s){const n=e[s],i=t[s];if(n===i)continue;if(!n||!i)return!1;if(n.length!==i.length)return!1;for(let e=0;e<n.length;e++){if(n[e].userId!==i[e].userId)return!1;if(n[e].roomMember!==i[e].roomMember)return!1}}else if(e[s]!==t[s])return!1}return!0}shouldHighlight(){if(this.props.forExport)return!1;if(this.context.timelineRenderingType===C.Ae.Notification)return!1;if(this.context.timelineRenderingType===C.Ae.ThreadsList)return!1;const e=b.J.safeGet(),t=e.getPushActionsForEvent(this.props.mxEvent.replacingEvent()||this.props.mxEvent),n=this.props.mxEvent.replacingEvent()?e.getPushActionsForEvent(this.props.mxEvent):void 0;return!!(null!=t&&t.tweaks||null!=n&&n.tweaks)&&(this.props.mxEvent.getSender()!==e.credentials.userId&&!!(null!=t&&t.tweaks.highlight||null!=n&&n.tweaks.highlight))}renderE2EPadlock(){var e;const t=null!==(e=this.props.mxEvent.replacingEvent())&&void 0!==e?e:this.props.mxEvent;if((0,Et.F)(t.getRoomId()))return null;if(t.isDecryptionFailure())switch(t.decryptionFailureReason){case h.DecryptionFailureCode.SENDER_IDENTITY_PREVIOUSLY_VERIFIED:case h.DecryptionFailureCode.UNSIGNED_SENDER_DEVICE:return null;default:return r.createElement(Bt,null)}if(this.state.shieldColour!==h.EventShieldColour.NONE){let e;switch(this.state.shieldReason){case null:case h.EventShieldReason.UNKNOWN:e=(0,m._t)("error|unknown");break;case h.EventShieldReason.UNVERIFIED_IDENTITY:e=(0,m._t)("encryption|event_shield_reason_unverified_identity");break;case h.EventShieldReason.UNSIGNED_DEVICE:e=(0,m._t)("encryption|event_shield_reason_unsigned_device");break;case h.EventShieldReason.UNKNOWN_DEVICE:e=(0,m._t)("encryption|event_shield_reason_unknown_device");break;case h.EventShieldReason.AUTHENTICITY_NOT_GUARANTEED:e=(0,m._t)("encryption|event_shield_reason_authenticity_not_guaranteed");break;case h.EventShieldReason.MISMATCHED_SENDER_KEY:e=(0,m._t)("encryption|event_shield_reason_mismatched_sender_key");break;case h.EventShieldReason.SENT_IN_CLEAR:e=(0,m._t)("common|unencrypted");break;case h.EventShieldReason.VERIFICATION_VIOLATION:e=(0,m._t)("timeline|decryption_failure|sender_identity_previously_verified")}return this.state.shieldColour===h.EventShieldColour.GREY?r.createElement(Vt,{icon:Lt.Normal,title:e}):r.createElement(Vt,{icon:Lt.Warning,title:e})}if(this.context.isRoomEncrypted){if(t.status===l.EventStatus.ENCRYPTING)return null;if(t.status===l.EventStatus.NOT_SENT)return null;if(t.isState())return null;if(t.isRedacted())return null;if(!t.isEncrypted())return r.createElement(Ut,null)}return null}showContextMenu(e,t){var n;const i=e.target,s=i instanceof HTMLAnchorElement?i:i.closest("a");i instanceof HTMLImageElement||(null!==(n=j.A.get())&&void 0!==n&&n.allowOverridingNativeContextMenus()||!(0,ze.j5)()&&!s)&&(this.props.editState||(e.preventDefault(),e.stopPropagation(),this.setState({contextMenu:{position:{left:e.clientX,top:e.clientY,bottom:e.clientY},link:(null==s?void 0:s.href)||t},actionBarFocused:!0})))}shouldHideEvent(){var e;return(null===(e=this.props.callEventGrouper)||void 0===e?void 0:e.hangupReason)===d.Il.Replaced}renderContextMenu(){if(!this.state.contextMenu)return null;const e=this.getTile(),t=this.getReplyChain(),n=null!=e&&e.getEventTileOps?e.getEventTileOps():void 0,s=null!=t&&t.canCollapse()?t.collapse:void 0;return r.createElement(D.A,(0,i.A)({},(0,N.ps)(this.state.contextMenu.position),{mxEvent:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator,eventTileOps:n,collapseReplyChain:s,onFinished:this.onCloseMenu,rightClick:!0,reactions:this.state.reactions,link:this.state.contextMenu.link,getRelationsForEvent:this.props.getRelationsForEvent}))}render(){var e,t,n;const i=this.props.mxEvent.getContent().msgtype,s=this.props.mxEvent.getType(),{hasRenderer:o,isBubbleMessage:d,isInfoMessage:h,isLeftAlignedBubbleMessage:u,noBubbleEvent:v,isSeeingThroughMessageHiddenForModeration:g}=(0,Ge.v)(b.J.safeGet(),this.props.mxEvent,this.context.showHiddenEvents,this.shouldHideEvent()),{isQuoteExpanded:f}=this.state;if(!o){const{mxEvent:e}=this.props;return c.v.warn(`Event type not supported: type:${s} isState:${e.isState()}`),r.createElement("div",{className:"mx_EventTile mx_EventTile_info mx_MNoticeBody"},r.createElement("div",{className:"mx_EventTile_line"},(0,m._t)("timeline|error_no_renderer")))}const y=ve.j.isEligible(this.props.mxEvent),E=a()("mx_EventTile_line",{mx_EventTile_mediaLine:y,mx_EventTile_image:this.props.mxEvent.getType()===l.EventType.RoomMessage&&this.props.mxEvent.getContent().msgtype===l.MsgType.Image,mx_EventTile_sticker:this.props.mxEvent.getType()===l.EventType.Sticker,mx_EventTile_emote:this.props.mxEvent.getType()===l.EventType.RoomMessage&&this.props.mxEvent.getContent().msgtype===l.MsgType.Emote}),x=["sending","queued","encrypting"].includes(this.props.eventSendStatus),w=(0,Xe.S8)(this.props.mxEvent)&&this.props.isRedacted,D=this.props.mxEvent.isDecryptionFailure();let N=this.props.continuation;this.context.timelineRenderingType!==C.Ae.Room&&this.context.timelineRenderingType!==C.Ae.Search&&this.context.timelineRenderingType!==C.Ae.Thread&&this.props.layout!==R.P.Bubble&&(N=!1);const M=this.context.timelineRenderingType===C.Ae.Notification,O=!!this.props.editState,P=a()({mx_EventTile_bubbleContainer:d,mx_EventTile_leftAlignedBubble:u,mx_EventTile:!0,mx_EventTile_isEditing:O,mx_EventTile_info:h,mx_EventTile_12hr:this.props.isTwelveHour,mx_EventTile_sending:!O&&x,mx_EventTile_highlight:this.shouldHighlight(),mx_EventTile_selected:this.props.isSelectedEvent||this.state.contextMenu,mx_EventTile_continuation:N||s===l.EventType.CallInvite||xt.Ho.CALL_EVENT_TYPE.matches(s),mx_EventTile_last:this.props.last,mx_EventTile_lastInSection:this.props.lastInSection,mx_EventTile_contextual:this.props.contextual,mx_EventTile_actionBarFocused:this.state.actionBarFocused,mx_EventTile_bad:D,mx_EventTile_emote:i===l.MsgType.Emote,mx_EventTile_noSender:this.props.hideSender,mx_EventTile_clamp:this.context.timelineRenderingType===C.Ae.ThreadsList||M,mx_EventTile_noBubble:v}),j=null!==this.props.eventSendStatus?"off":void 0;let L="#";this.props.permalinkCreator&&(L=this.props.permalinkCreator.forEvent(this.props.mxEvent.getId()));const V=this.props.mxEvent.status?void 0:this.props.mxEvent.getId();let H,G,z=null,K=null;if(M?(H="24px",G=!0):h?(H="14px",G=!1):this.context.timelineRenderingType===C.Ae.ThreadsList||this.context.timelineRenderingType===C.Ae.Thread&&!this.props.continuation?(H="32px",G=!0):s===l.EventType.RoomCreate||d?(H=null,G=!1):this.props.layout==R.P.IRC?(H="14px",G=!0):this.props.continuation&&this.context.timelineRenderingType!==C.Ae.File||s===l.EventType.CallInvite||xt.Ho.CALL_EVENT_TYPE.matches(s)?(H=null,G=!1):this.context.timelineRenderingType===C.Ae.File?(H="20px",G=!0):(H="30px",G=!0),this.props.mxEvent.sender&&null!==H){let e=null;e=this.props.mxEvent.getContent().third_party_invite?this.props.mxEvent.target:this.props.mxEvent.sender;const t=!this.props.inhibitInteraction&&![C.Ae.ThreadsList,C.Ae.Notification].includes(this.context.timelineRenderingType);z=r.createElement("div",{className:"mx_EventTile_avatar"},r.createElement(F.A,{member:e,size:H,viewUserOnClick:t,forceHistorical:this.props.mxEvent.getType()===l.EventType.RoomMember}))}G&&!0!==this.props.hideSender&&(K=this.context.timelineRenderingType===C.Ae.Room||this.context.timelineRenderingType===C.Ae.Search||this.context.timelineRenderingType===C.Ae.Pinned||this.context.timelineRenderingType===C.Ae.Thread?r.createElement(U.A,{onClick:this.onSenderProfileClick,mxEvent:this.props.mxEvent}):this.context.timelineRenderingType===C.Ae.ThreadsList?r.createElement(U.A,{mxEvent:this.props.mxEvent,withTooltip:!0}):r.createElement(U.A,{mxEvent:this.props.mxEvent}));const q=!O&&!this.props.forExport?r.createElement(De,{mxEvent:this.props.mxEvent,reactions:this.state.reactions,permalinkCreator:this.props.permalinkCreator,getTile:this.getTile,getReplyChain:this.getReplyChain,onFocusChange:this.onActionBarFocusChange,isQuoteExpanded:f,toggleThreadExpanded:()=>this.setQuoteExpanded(!f),getRelationsForEvent:this.props.getRelationsForEvent}):void 0,J=this.props.mxEvent.getTs()&&!this.props.hideTimestamp&&(this.props.alwaysShowTimestamps||this.props.last||this.state.hover||this.state.actionBarFocused||Boolean(this.state.contextMenu));let W=this.context.timelineRenderingType!==C.Ae.ThreadsList?this.props.mxEvent.getTs():null===(e=this.state.thread)||void 0===e||null===(e=e.replyToEvent)||void 0===e?void 0:e.getTs();"number"!=typeof W&&(W=this.props.mxEvent.getTs());const Y=r.createElement(B.A,{showRelative:this.context.timelineRenderingType===C.Ae.ThreadsList,showTwelveHour:this.props.isTwelveHour,ts:W,receivedTs:null===(t=(0,Tt.R)(this.props.mxEvent))||void 0===t?void 0:t.received_ts}),$=J&&W?Y:null;let Q,X;Se.A.isPinned(b.J.safeGet(),this.props.mxEvent)&&(Q=r.createElement(Nt,null)),w||(X=r.createElement(He,{mxEvent:this.props.mxEvent,reactions:this.state.reactions,key:"mx_EventTile_reactionsRow"}));const Z=Boolean(X&&this.state.reactions||Q),ee=this.props.hideTimestamp?null:r.createElement("a",{href:L,onClick:this.onPermalinkClicked,"aria-label":(0,I.fU)(new Date(this.props.mxEvent.getTs()),this.props.isTwelveHour),onContextMenu:this.onTimestampContextMenu},$),te=this.props.layout===R.P.IRC,ne=te?null:ee,ie=te?ee:null,se=this.props.layout===R.P.Bubble?Y:void 0,re=!te&&!d&&this.renderE2EPadlock(),oe=te&&!d&&this.renderE2EPadlock();let ae,le;if(this.shouldShowSentReceipt||this.shouldShowSendingReceipt)ae=r.createElement(Ht,{messageState:this.props.mxEvent.getAssociatedStatus()});else if(this.props.showReadReceipts){var ce,de;ae=r.createElement(ft,{readReceipts:null!==(ce=this.props.readReceipts)&&void 0!==ce?ce:[],readReceiptMap:null!==(de=this.props.readReceiptMap)&&void 0!==de?de:{},checkUnmounting:this.props.checkUnmounting,suppressAnimation:this.suppressReadReceiptAnimation,isTwelveHour:this.props.isTwelveHour})}(0,Xe.bN)(this.props.mxEvent,b.J.safeGet(),this.context.showHiddenEvents)&&(0,A.c$)(this.props.mxEvent)&&(le=r.createElement(S,{parentEv:this.props.mxEvent,onHeightChanged:this.props.onHeightChanged,ref:this.replyChain,forExport:this.props.forExport,permalinkCreator:this.props.permalinkCreator,layout:this.props.layout,alwaysShowTimestamps:this.props.alwaysShowTimestamps||this.state.hover,isQuoteExpanded:f,setQuoteExpanded:this.setQuoteExpanded,getRelationsForEvent:this.props.getRelationsForEvent}));const he=(null===(n=this.props.mxEvent)||void 0===n?void 0:n.getSender())===b.J.safeGet().getUserId();switch(this.context.timelineRenderingType){case C.Ae.Thread:return r.createElement(this.props.as||"li",{ref:this.ref,className:P,"aria-live":j,"aria-atomic":!0,"data-scroll-tokens":V,"data-has-reply":!!le,"data-layout":this.props.layout,"data-self":he,"data-event-id":this.props.mxEvent.getId(),onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1})},[r.createElement("div",{className:"mx_EventTile_senderDetails",key:"mx_EventTile_senderDetails"},z,K),r.createElement("div",{className:E,key:"mx_EventTile_line",onContextMenu:this.onContextMenu},this.renderContextMenu(),le,(0,Xe.rd)(C.Ae.Thread,Ot(Ot({},this.props),{},{ref:this.tile,isSeeingThroughMessageHiddenForModeration:g,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:()=>this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator}),this.context.showHiddenEvents),q,r.createElement("a",{href:L,onClick:this.onPermalinkClicked},$),ae),Z&&r.createElement("div",{className:"mx_EventTile_footer",key:"mx_EventTile_footer"},(this.props.layout===R.P.Group||!he)&&Q,X,this.props.layout===R.P.Bubble&&he&&Q)]);case C.Ae.Notification:case C.Ae.ThreadsList:{const e=b.J.safeGet().getRoom(this.props.mxEvent.getRoomId());return r.createElement(this.props.as||"li",{ref:this.ref,className:P,tabIndex:-1,"aria-live":j,"aria-atomic":"true","data-scroll-tokens":V,"data-layout":this.props.layout,"data-shape":this.context.timelineRenderingType,"data-self":he,"data-has-reply":!!le,onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1}),onClick:e=>{const t=e.currentTarget;let n=-1;switch(t.parentElement&&(n=Array.from(t.parentElement.children).indexOf(t)),this.context.timelineRenderingType){case C.Ae.Notification:this.viewInRoom(e);break;case C.Ae.ThreadsList:p.A.dispatch({action:_.r.ShowThread,rootEvent:this.props.mxEvent,push:!0}),Re.A.trackInteraction("WebThreadsPanelThreadItem",e,null!=n?n:-1)}}},r.createElement(r.Fragment,null,r.createElement("div",{className:"mx_EventTile_details"},K,M&&e?r.createElement("span",{className:"mx_EventTile_truncated"}," ",(0,m._t)("timeline|in_room_name",{room:e.name},{strong:e=>r.createElement("strong",null,e)})):"",$,r.createElement(At,{room:e||void 0,threadId:this.props.mxEvent.getId(),forceDot:!0})),M&&e?r.createElement("div",{className:"mx_EventTile_avatar"},r.createElement(T.A,{room:e,size:"28px"})):z,r.createElement("div",{className:E,key:"mx_EventTile_line"},r.createElement("div",{className:"mx_EventTile_body"},this.props.mxEvent.isRedacted()?r.createElement(qe.A,{mxEvent:this.props.mxEvent}):this.props.mxEvent.isDecryptionFailure()?r.createElement(k.A,{mxEvent:this.props.mxEvent}):r.createElement(rt.B,{mxEvent:this.props.mxEvent})),this.renderThreadPanelSummary()),this.context.timelineRenderingType===C.Ae.ThreadsList&&r.createElement(kt,{viewInRoom:this.viewInRoom,copyLinkToThread:this.copyLinkToThread}),ae))}case C.Ae.File:return r.createElement(this.props.as||"li",{className:P,"aria-live":j,"aria-atomic":!0,"data-scroll-tokens":V},[r.createElement("a",{className:"mx_EventTile_senderDetailsLink",key:"mx_EventTile_senderDetailsLink",href:L,onClick:this.onPermalinkClicked},r.createElement("div",{className:"mx_EventTile_senderDetails",onContextMenu:this.onTimestampContextMenu},z,K,$)),r.createElement("div",{className:E,key:"mx_EventTile_line",onContextMenu:this.onContextMenu},this.renderContextMenu(),(0,Xe.rd)(C.Ae.File,Ot(Ot({},this.props),{},{ref:this.tile,isSeeingThroughMessageHiddenForModeration:g,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator}),this.context.showHiddenEvents))]);default:return r.createElement(this.props.as||"li",{ref:this.ref,className:P,tabIndex:-1,"aria-live":j,"aria-atomic":"true","data-scroll-tokens":V,"data-layout":this.props.layout,"data-self":he,"data-event-id":this.props.mxEvent.getId(),"data-has-reply":!!le,onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1})},r.createElement(r.Fragment,null,ie,K,oe,z,r.createElement("div",{className:E,key:"mx_EventTile_line",onContextMenu:this.onContextMenu},this.renderContextMenu(),ne,re,le,(0,Xe.rd)(this.context.timelineRenderingType,Ot(Ot({},this.props),{},{ref:this.tile,isSeeingThroughMessageHiddenForModeration:g,timestamp:se,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator}),this.context.showHiddenEvents),q,this.props.layout===R.P.IRC&&r.createElement(r.Fragment,null,Z&&r.createElement("div",{className:"mx_EventTile_footer"},Q,X),this.renderThreadInfo())),this.props.layout!==R.P.IRC&&r.createElement(r.Fragment,null,Z&&r.createElement("div",{className:"mx_EventTile_footer"},(this.props.layout===R.P.Group||!he)&&Q,X,this.props.layout===R.P.Bubble&&he&&Q),this.renderThreadInfo()),ae))}}}(0,s.A)(jt,"defaultProps",{onHeightChanged:function(){},forExport:!1,layout:R.P.Group}),(0,s.A)(jt,"contextType",C.Ay);const Ft=(0,r.forwardRef)(((e,t)=>{var n;return r.createElement(r.Fragment,null,r.createElement(Qe,{mxEvent:e.mxEvent,layout:null!==(n=e.layout)&&void 0!==n?n:R.P.Group},r.createElement(jt,(0,i.A)({ref:t},e))))}));function Ut(e){return r.createElement(Vt,(0,i.A)({title:(0,m._t)("common|unencrypted"),icon:Lt.Warning},e))}function Bt(e){return r.createElement(Vt,(0,i.A)({title:(0,m._t)("timeline|undecryptable_tooltip"),icon:Lt.DecryptionFailure},e))}var Lt=function(e){return e.Normal="normal",e.Warning="warning",e.DecryptionFailure="decryption_failure",e}(Lt||{});class Vt extends r.Component{constructor(e){super(e),this.state={hover:!1}}render(){const e=`mx_EventTile_e2eIcon mx_EventTile_e2eIcon_${this.props.icon}`;return r.createElement(u.m,{label:this.props.title,isTriggerInteractive:!0},r.createElement("div",{className:e,tabIndex:0,"aria-label":(0,m._t)("timeline|e2e_state")}))}}function Ht({messageState:e}){const t=!e||"sent"===e,n="not_sent"===e,i=a()({mx_EventTile_receiptSent:t,mx_EventTile_receiptSending:!t&&!n});let s;n&&(s=r.createElement(P.A,{notification:O.d.RED_EXCLAMATION}));let o=(0,m._t)("timeline|send_state_sending");return"encrypting"===e?o=(0,m._t)("timeline|send_state_encrypting"):t?o=(0,m._t)("timeline|send_state_sent"):n&&(o=(0,m._t)("timeline|send_state_failed")),r.createElement("div",{className:"mx_EventTile_msgOption"},r.createElement("div",{className:"mx_ReadReceiptGroup"},r.createElement(u.m,{label:o,placement:"top-end"},r.createElement("div",{className:"mx_ReadReceiptGroup_button",role:"status"},r.createElement("span",{className:"mx_ReadReceiptGroup_container"},r.createElement("span",{className:i},s))))))}},"./src/components/views/rooms/ReplyTile.tsx":(e,t,n)=>{"use strict";n.d(t,{A:()=>k});var i=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=n("./node_modules/react/index.js"),r=n("./node_modules/classnames/index.js"),o=n.n(r),a=n("./node_modules/matrix-js-sdk/src/matrix.ts"),l=n("./node_modules/matrix-js-sdk/src/logger.ts"),c=n("./src/languageHandler.tsx"),d=n("./src/dispatcher/dispatcher.ts"),h=n("./src/dispatcher/actions.ts"),u=n("./src/components/views/messages/SenderProfile.tsx"),m=n("./src/components/views/elements/Spinner.tsx"),p=n("./src/utils/FileUtils.ts"),v=n("./src/tchap/components/views/messages/OriginalImageBody.tsx");class g extends v.A{constructor(...e){super(...e),(0,i.A)(this,"onClick",(e=>{e.preventDefault()}))}wrapImage(e,t){return t}render(){if(this.state.error)return super.render();const e=this.props.mxEvent.getContent(),t=this.state.contentUrl?this.messageContent(this.state.contentUrl,this.state.thumbUrl,e,44):void 0;return s.createElement("div",{className:"mx_MImageReplyBody"},t)}}var f=n("./src/tchap/components/views/elements/BlockedIcon.tsx"),_=n("./src/tchap/components/views/elements/ContentScanningStatus.tsx");class y extends s.PureComponent{constructor(e){super(e),this.state={isScanning:!0,isSafe:!1,hasError:!1},Promise.all([this.media.scanSource(),this.media.scanThumbnail()]).then((async([e,t])=>{const n=e&&t;this.setState({isScanning:!1,isSafe:n})})).catch((()=>{this.setState({isScanning:!1,hasError:!0})}))}render(){return this.state.isScanning?s.createElement(s.Fragment,null,s.createElement("div",{className:"mx_MImageBody mx_MImageBody_pending",style:{height:44}},s.createElement(m.A,null)),s.createElement(_.v,{fileName:this.fileName,status:"scanning"})):this.state.hasError?s.createElement(s.Fragment,null,s.createElement("div",{className:"mx_MImageBody mx_MImageBody_error",style:{height:44}},s.createElement(f.k,{className:"mx_MImageBody_BlockedIcon"})),s.createElement(_.v,{fileName:this.fileName,status:"error"})):this.state.isSafe?s.createElement(s.Fragment,null,this.renderOriginal(),s.createElement(_.v,{status:"done"})):s.createElement(s.Fragment,null,s.createElement("div",{className:"mx_MImageBody mx_MImageBody_unsafe",style:{height:44}},s.createElement(f.k,{className:"mx_MImageBody_BlockedIcon"})),s.createElement(_.v,{fileName:this.fileName,status:"unsafe"}))}renderOriginal(){return s.createElement(g,this.props)}get media(){return this.props.mediaEventHelper.media}get fileName(){return(0,p.q)(this.content,(0,c._t)("common|image"),!0,!1)}get content(){return this.props.mxEvent.getContent()}}var E=n("./src/utils/EventUtils.ts"),x=n("./src/utils/EventRenderingUtils.ts"),w=n("./src/components/views/messages/MFileBody.tsx"),A=n("./src/components/views/avatars/MemberAvatar.tsx"),C=n("./src/components/views/messages/MVoiceMessageBody.tsx"),b=n("./src/events/EventTileFactory.tsx"),S=n("./src/MatrixClientPeg.ts");function R(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function I(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?R(Object(n),!0).forEach((function(t){(0,i.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):R(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class k extends s.PureComponent{constructor(...e){super(...e),(0,i.A)(this,"anchorElement",(0,s.createRef)()),(0,i.A)(this,"onDecrypted",(()=>{this.forceUpdate(),this.props.onHeightChanged&&this.props.onHeightChanged()})),(0,i.A)(this,"onEventRequiresUpdate",(()=>{this.forceUpdate()})),(0,i.A)(this,"onClick",(e=>{const t=e.target;"a"===t.tagName.toLowerCase()&&null!==t.closest("a")&&t!==this.anchorElement.current||(e.preventDefault(),this.props.toggleExpandedQuote&&e.shiftKey?this.props.toggleExpandedQuote():d.A.dispatch({action:h.r.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId(),metricsTrigger:void 0}))}))}componentDidMount(){this.props.mxEvent.on(a.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.on(a.MatrixEventEvent.BeforeRedaction,this.onEventRequiresUpdate),this.props.mxEvent.on(a.MatrixEventEvent.Replaced,this.onEventRequiresUpdate)}componentWillUnmount(){this.props.mxEvent.removeListener(a.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.removeListener(a.MatrixEventEvent.BeforeRedaction,this.onEventRequiresUpdate),this.props.mxEvent.removeListener(a.MatrixEventEvent.Replaced,this.onEventRequiresUpdate)}render(){const e=this.props.mxEvent,t=e.getContent().msgtype,n=e.getType(),{hasRenderer:i,isInfoMessage:r,isSeeingThroughMessageHiddenForModeration:d}=(0,x.v)(S.J.safeGet(),e,!1);if(!i){const{mxEvent:e}=this.props;return l.v.warn(`Event type not supported: type:${e.getType()} isState:${e.isState()}`),s.createElement("div",{className:"mx_ReplyTile mx_ReplyTile_info mx_MNoticeBody"},(0,c._t)("timeline|error_no_renderer"))}const h=o()("mx_ReplyTile",{mx_ReplyTile_inline:t===a.MsgType.Emote,mx_ReplyTile_info:r&&!e.isRedacted(),mx_ReplyTile_audio:t===a.MsgType.Audio,mx_ReplyTile_video:t===a.MsgType.Video});let m,p="#";this.props.permalinkCreator&&(p=this.props.permalinkCreator.forEvent(e.getId()));r||n===a.EventType.RoomCreate||(m=s.createElement("div",{className:"mx_ReplyTile_sender"},s.createElement(A.A,{member:e.sender,fallbackUserId:e.getSender(),size:"16px"}),s.createElement(u.A,{mxEvent:e})));const v={[a.MsgType.Image]:y,[a.MsgType.Audio]:(0,E.Mp)(e)?C.A:w.A,[a.MsgType.Video]:w.A},g={[a.EventType.Sticker]:y};return s.createElement("div",{className:h},s.createElement("a",{href:p,onClick:this.onClick,ref:this.anchorElement},m,(0,b.BP)(I(I({},this.props),{},{ref:void 0,showUrlPreview:!1,overrideBodyTypes:v,overrideEventTypes:g,maxImageHeight:96,isSeeingThroughMessageHiddenForModeration:d,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator}),!1)))}}(0,i.A)(k,"defaultProps",{onHeightChanged:()=>{}})},"./src/components/views/rooms/RoomContextDetails.tsx":(e,t,n)=>{"use strict";n.d(t,{n:()=>m});var i=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=n("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),r=n("./node_modules/react/index.js"),o=n("./src/stores/spaces/SpaceStore.ts"),a=n("./src/languageHandler.tsx"),l=n("./src/utils/DMRoomMap.ts"),c=n("./src/utils/FormattingUtils.ts");const d=["room","component"];function h(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?h(Object(n),!0).forEach((function(t){(0,i.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):h(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function m(e){let{room:t,component:n}=e,i=(0,s.A)(e,d);const h=function(e){const t=l.A.shared().getUserIdForRoomId(e.roomId),n=e.getMembers().length>2;if(!e.isSpaceRoom()&&t&&!n)return{details:t};const[i,s,...r]=o.Ay.instance.getKnownParents(e.roomId);if(s&&(null==r||!r.length)){var d,h;const t=null===(d=e.client.getRoom(i))||void 0===d?void 0:d.name,n=null===(h=e.client.getRoom(s))||void 0===h?void 0:h.name;return{details:(0,c.ki)([null!=t?t:"",null!=n?n:""]),ariaLabel:(0,a._t)("in_space1_and_space2",{space1Name:t,space2Name:n})}}if(i){var u,m;const t=null!==(u=null===(m=e.client.getRoom(i))||void 0===m?void 0:m.name)&&void 0!==u?u:"",n=r.length;return n>0?{details:(0,c.ki)([t,...r],1),ariaLabel:(0,a._t)("in_space_and_n_other_spaces",{spaceName:t,count:n})}:{details:t,ariaLabel:(0,a._t)("in_space",{spaceName:t})}}return{details:e.getCanonicalAlias()}}(t);return h?r.createElement(null!=n?n:"div",u(u({},i),{},{"aria-label":h.ariaLabel}),[h.details]):r.createElement(r.Fragment,null)}},"./src/components/views/settings/devices/DeviceMetaData.tsx":(e,t,n)=>{"use strict";n.d(t,{e:()=>d});var i=n("./node_modules/react/index.js"),s=n("./res/img/element-icons/settings/inactive.svg"),r=n("./src/components/views/settings/devices/filter.ts"),o=n("./src/DateUtils.ts"),a=n("./src/languageHandler.tsx");const l=(e,t=(new Date).getTime())=>{if(e+5184e5>=t){const t=new Date(e);return(0,o.Yq)(t)}return(0,o.fw)(new Date(e))},c=({value:e,id:t})=>e?i.createElement("span",null,e):null,d=({device:e})=>{const t=(e=>{if((0,r.Wf)(e)&&e.last_seen_ts)return{id:"inactive",value:i.createElement(i.Fragment,null,i.createElement(s.I,{className:"mx_DeviceTile_inactiveIcon"}),(0,a._t)("settings|sessions|inactive_days",{inactiveAgeDays:r.B1})+` (${l(e.last_seen_ts)})`)}})(e),n=e.last_seen_ts&&`${(0,a._t)("settings|sessions|last_activity")} ${l(e.last_seen_ts)}`,o=e.isVerified?(0,a._t)("common|verified"):(0,a._t)("common|unverified"),d=t?[t,{id:"lastSeenIp",value:e.last_seen_ip}]:[{id:"isVerified",value:o},{id:"lastActivity",value:n},{id:"lastSeenIp",value:e.last_seen_ip},{id:"deviceId",value:e.device_id}];return i.createElement(i.Fragment,null,d.map((({id:e,value:t},n)=>t?i.createElement(i.Fragment,{key:e},!!n&&"  ",i.createElement(c,{id:e,value:t})):null)))}},"./src/components/views/settings/devices/filter.ts":(e,t,n)=>{"use strict";n.d(t,{B1:()=>r,Im:()=>l,Wf:()=>o});var i=n("./src/components/views/settings/devices/types.ts");const s=7776e6,r=90,o=e=>!!e.last_seen_ts&&e.last_seen_ts<Date.now()-s,a={[i.e.Verified]:e=>!!e.isVerified,[i.e.Unverified]:e=>!e.isVerified,[i.e.Inactive]:o},l=(e,t)=>{const n=t.map((e=>a[e]));return n.length?e.filter((e=>n.every((t=>t(e))))):e}},"./src/components/views/settings/devices/types.ts":(e,t,n)=>{"use strict";n.d(t,{e:()=>i});let i=function(e){return e.Verified="Verified",e.Unverified="Unverified",e.Inactive="Inactive",e.Unverifiable="Unverifiable",e}({})},"./src/hooks/room/useTopic.ts":(e,t,n)=>{"use strict";n.d(t,{B:()=>a,e:()=>o});var i=n("./node_modules/react/index.js"),s=n("./node_modules/matrix-js-sdk/src/matrix.ts"),r=n("./src/hooks/useEventEmitter.ts");const o=e=>{var t;const n=null==e||null===(t=e.currentState)||void 0===t||null===(t=t.getStateEvents(s.EventType.RoomTopic,""))||void 0===t?void 0:t.getContent();return n?s.ContentHelpers.parseTopicContent(n):null};function a(e){const[t,n]=(0,i.useState)(o(e));return(0,r.YK)(null==e?void 0:e.currentState,s.RoomStateEvent.Events,(t=>{t.getType()===s.EventType.RoomTopic&&n(o(e))})),(0,i.useEffect)((()=>{n(o(e))}),[e]),t}},"./src/indexing/EventIndexPeg.ts":(e,t,n)=>{"use strict";n.d(t,{A:()=>g});var i=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=n("./node_modules/matrix-js-sdk/src/logger.ts"),r=n("./src/PlatformPeg.ts"),o=n("./node_modules/events/events.js"),a=n("./node_modules/matrix-js-sdk/src/matrix.ts"),l=n("./node_modules/matrix-js-sdk/src/types.ts"),c=n("./node_modules/matrix-js-sdk/src/utils.ts"),d=n("./src/MatrixClientPeg.ts"),h=n("./src/settings/SettingsStore.ts"),u=n("./src/settings/SettingLevel.ts"),m=n("./src/utils/arrays.ts");class p extends o.EventEmitter{constructor(...e){super(...e),(0,i.A)(this,"crawlerCheckpoints",[]),(0,i.A)(this,"crawler",null),(0,i.A)(this,"currentCheckpoint",null),(0,i.A)(this,"onSync",(async(e,t,n)=>{var i;const s=null===(i=r.A.get())||void 0===i?void 0:i.getEventIndexingManager();if(s){if("PREPARED"===t&&"SYNCING"===e){return await s.isEventIndexEmpty()&&await this.addInitialCheckpoints(),void this.startCrawler()}"SYNCING"===t&&"SYNCING"===e&&await s.commitLiveEvents()}})),(0,i.A)(this,"onRoomTimeline",(async(e,t,n,i,s)=>{if(!t)return;const r=d.J.safeGet();return r.isRoomEncrypted(e.getRoomId())?e.isRedaction()?this.redactEvent(e):void(!n&&s&&s.liveEvent&&!e.isRedacted()&&(await r.decryptEventIfNeeded(e),await this.addLiveEventToIndex(e))):void 0})),(0,i.A)(this,"onRoomStateEvent",(async(e,t)=>{d.J.safeGet().isRoomEncrypted(t.roomId)&&(e.getType()!==a.EventType.RoomEncryption||await this.isRoomIndexed(t.roomId)||(s.v.log("EventIndex: Adding a checkpoint for a newly encrypted room",t.roomId),this.addRoomCheckpoint(t.roomId,!0)))})),(0,i.A)(this,"redactEvent",(async e=>{var t;const n=null===(t=r.A.get())||void 0===t?void 0:t.getEventIndexingManager();if(!n)return;const i=e.getAssociatedId();if(i)try{await n.deleteEvent(i)}catch(e){s.v.log("EventIndex: Error deleting event from index",e)}})),(0,i.A)(this,"onTimelineReset",(async e=>{e&&d.J.safeGet().isRoomEncrypted(e.roomId)&&(s.v.log("EventIndex: Adding a checkpoint because of a limited timeline",e.roomId),this.addRoomCheckpoint(e.roomId,!1))}))}async init(){var e;const t=null===(e=r.A.get())||void 0===e?void 0:e.getEventIndexingManager();t&&(this.crawlerCheckpoints=await t.loadCheckpoints(),s.v.log("EventIndex: Loaded checkpoints",this.crawlerCheckpoints),this.registerListeners())}registerListeners(){const e=d.J.safeGet();e.on(a.ClientEvent.Sync,this.onSync),e.on(a.RoomEvent.Timeline,this.onRoomTimeline),e.on(a.RoomEvent.TimelineReset,this.onTimelineReset),e.on(a.RoomStateEvent.Events,this.onRoomStateEvent)}removeListeners(){const e=d.J.get();null!==e&&(e.removeListener(a.ClientEvent.Sync,this.onSync),e.removeListener(a.RoomEvent.Timeline,this.onRoomTimeline),e.removeListener(a.RoomEvent.TimelineReset,this.onTimelineReset),e.removeListener(a.RoomStateEvent.Events,this.onRoomStateEvent))}async addInitialCheckpoints(){var e;const t=null===(e=r.A.get())||void 0===e?void 0:e.getEventIndexingManager();if(!t)return;const n=d.J.safeGet(),i=n.getRooms(),o=await(0,m.j7)(i,(async e=>{var t;return Boolean(await(null===(t=n.getCrypto())||void 0===t?void 0:t.isEncryptionEnabledInRoom(e.roomId)))}));s.v.log("EventIndex: Adding initial crawler checkpoints"),await Promise.all(o.map((async e=>{const n=e.getLiveTimeline().getPaginationToken(a.Direction.Backward),i={roomId:e.roomId,token:n,direction:a.Direction.Backward,fullCrawl:!0},r={roomId:e.roomId,token:n,direction:a.Direction.Forward};try{i.token&&(await t.addCrawlerCheckpoint(i),this.crawlerCheckpoints.push(i)),r.token&&(await t.addCrawlerCheckpoint(r),this.crawlerCheckpoints.push(r))}catch(t){s.v.log("EventIndex: Error adding initial checkpoints for room",e.roomId,i,r,t)}})))}isValidEvent(e){const t=[a.EventType.RoomMessage,a.EventType.RoomName,a.EventType.RoomTopic].includes(e.getType())&&!e.isRedacted()&&!e.isDecryptionFailure();let n=!0,i=!0;if(e.getType()!==a.EventType.RoomMessage||e.isRedacted())e.getType()!==a.EventType.RoomTopic||e.isRedacted()?e.getType()!==a.EventType.RoomName||e.isRedacted()||e.getContent().name||(i=!1):e.getContent().topic||(i=!1);else{const t=e.getContent().msgtype;n=!!t&&!t.startsWith("m.key.verification"),e.getContent().body||(i=!1)}return t&&n&&i}eventToJson(e){const t=e.getEffectiveEvent();return e.isEncrypted()?(t.curve25519Key=e.getSenderKey(),t.ed25519Key=e.getClaimedEd25519Key(),t.algorithm=e.getWireContent().algorithm,t.forwardingCurve25519KeyChain=e.getForwardingCurve25519KeyChain()):(delete t.curve25519Key,delete t.ed25519Key,delete t.algorithm,delete t.forwardingCurve25519KeyChain),t}async addLiveEventToIndex(e){var t,n,i;const s=null===(t=r.A.get())||void 0===t?void 0:t.getEventIndexingManager();if(!s||!this.isValidEvent(e))return;const o=this.eventToJson(e),a={displayname:null===(n=e.sender)||void 0===n?void 0:n.rawDisplayName,avatar_url:null===(i=e.sender)||void 0===i?void 0:i.getMxcAvatarUrl()};await s.addEventToIndex(o,a)}emitNewCheckpoint(){this.emit("changedCheckpoint",this.currentRoom())}async addEventsFromLiveTimeline(e){const t=e.getEvents();for(let e=0;e<t.length;e++){const n=t[e];await this.addLiveEventToIndex(n)}}async addRoomCheckpoint(e,t=!1){var n;const i=null===(n=r.A.get())||void 0===n?void 0:n.getEventIndexingManager();if(!i)return;const o=d.J.safeGet().getRoom(e);if(!o)return;const l=o.getLiveTimeline(),c=l.getPaginationToken(a.Direction.Backward);if(!c)return void await this.addEventsFromLiveTimeline(l);const h={roomId:o.roomId,token:c,fullCrawl:t,direction:a.Direction.Backward};s.v.log("EventIndex: Adding checkpoint",h);try{await i.addCrawlerCheckpoint(h)}catch(e){s.v.log("EventIndex: Error adding new checkpoint for room",o.roomId,h,e)}this.crawlerCheckpoints.push(h)}async crawlerFunc(){var e;let t=!1;const n=d.J.safeGet(),i=null===(e=r.A.get())||void 0===e?void 0:e.getEventIndexingManager();if(!i)return;this.crawler={cancel:()=>{t=!0}};let o=!1;for(;!t;){let e=h.A.getValueAt(u.p.DEVICE,"crawlerSleepTime");if(e=Math.max(e,100),o&&(e=5e3),null!==this.currentCheckpoint&&(this.currentCheckpoint=null,this.emitNewCheckpoint()),await(0,c.yy)(e),t)break;const r=this.crawlerCheckpoints.shift();if(void 0===r){o=!0;continue}this.currentCheckpoint=r,this.emitNewCheckpoint(),o=!1;const d=n.getEventMapper({preventReEmit:!0});let m;try{m=await n.createMessagesRequest(r.roomId,r.token,100,r.direction)}catch(e){if(e instanceof a.HTTPError&&403===e.httpStatus){s.v.log("EventIndex: Removing checkpoint as we don't have ","permissions to fetch messages from this room.",r);try{await i.removeCrawlerCheckpoint(r)}catch(e){s.v.log("EventIndex: Error removing checkpoint",r,e)}continue}s.v.log("EventIndex: Error crawling using checkpoint:",r,",",e),this.crawlerCheckpoints.push(r);continue}if(t){this.crawlerCheckpoints.push(r);break}if(0===m.chunk.length){s.v.log("EventIndex: Done with the checkpoint",r);try{await i.removeCrawlerCheckpoint(r)}catch(e){s.v.log("EventIndex: Error removing checkpoint",r,e)}continue}const p=m.chunk.map(d);let v=[];void 0!==m.state&&(v=m.state.map(d));const g={};v.forEach((e=>{e.getContent().membership===l.O.Join&&(g[e.getSender()]={displayname:e.getContent().displayname,avatar_url:e.getContent().avatar_url})}));const f=p.filter((e=>e.isEncrypted())).map((e=>n.decryptEventIfNeeded(e,{emit:!1})));await Promise.all(f);const _=p.filter(this.isValidEvent),y=p.filter((e=>e.isRedaction())),E=_.map((e=>{const t=this.eventToJson(e);let n={};t.sender in g&&(n=g[t.sender]);return{event:t,profile:n}}));let x=null;m.end&&(x={roomId:r.roomId,token:m.end,fullCrawl:r.fullCrawl,direction:r.direction});try{for(let e=0;e<y.length;e++){const t=y[e],n=t.getAssociatedId();n?await i.deleteEvent(n):s.v.warn("EventIndex: Redaction event doesn't contain a valid associated event id",t)}const e=await i.addHistoricEvents(E,x,r);if(!x){s.v.log("EventIndex: The server didn't return a valid ","new checkpoint, not continuing the crawl.",r);continue}!0===e&&!0!==x.fullCrawl?(s.v.log("EventIndex: Checkpoint had already all events","added, stopping the crawl",r),await i.removeCrawlerCheckpoint(x)):(!0===e&&s.v.log("EventIndex: Checkpoint had already all events","added, but continuing due to a full crawl",r),this.crawlerCheckpoints.push(x))}catch(e){s.v.log("EventIndex: Error during a crawl",e),this.crawlerCheckpoints.push(r)}}this.crawler=null}startCrawler(){null===this.crawler&&this.crawlerFunc()}stopCrawler(){null!==this.crawler&&this.crawler.cancel()}async close(){var e;const t=null===(e=r.A.get())||void 0===e?void 0:e.getEventIndexingManager();this.removeListeners(),this.stopCrawler(),await(null==t?void 0:t.closeEventIndex())}async search(e){var t;const n=null===(t=r.A.get())||void 0===t?void 0:t.getEventIndexingManager();return null==n?void 0:n.searchEventIndex(e)}async loadFileEvents(e,t=10,n,i=a.EventTimeline.BACKWARDS){var o;const c=d.J.safeGet(),h=null===(o=r.A.get())||void 0===o?void 0:o.getEventIndexingManager();if(!h)return[];const u={roomId:e.roomId,limit:t};let m;n&&(u.fromEvent=n,u.direction=i);try{m=await h.loadFileEvents(u)}catch(e){return s.v.log("EventIndex: Error getting file events",e),[]}const p=c.getEventMapper();return m.map((t=>{const n=p(t.event),i=new a.RoomMember(e.roomId,n.getSender());i.name=t.profile.displayname+" ("+n.getSender()+")";const s=p({content:{membership:l.O.Join,avatar_url:t.profile.avatar_url,displayname:t.profile.displayname},type:a.EventType.RoomMember,event_id:n.getId()+":eventIndex",room_id:n.getRoomId(),sender:n.getSender(),origin_server_ts:n.getTs(),state_key:n.getSender()});return i.events.member=s,n.sender=i,n}))}async populateFileTimeline(e,t,n,i=10,r,o=a.EventTimeline.BACKWARDS){const l=await this.loadFileEvents(n,i,r,o);null===r&&(l.reverse(),o=o==a.EventTimeline.BACKWARDS?a.EventTimeline.FORWARDS:a.EventTimeline.BACKWARDS),l.forEach((n=>{e.eventIdToTimeline(n.getId())||e.addEventToTimeline(n,t,{toStartOfTimeline:o==a.EventTimeline.BACKWARDS,fromCache:!1,addToState:!1})}));let c=!1,d="";return l.length>0&&(d=l[l.length-1].getId(),c=!0),s.v.log("EventIndex: Populating file panel with",l.length,"events and setting the pagination token to",d),t.setPaginationToken(d,a.EventTimeline.BACKWARDS),c}paginateTimelineWindow(e,t,n,i){const s=t.getTimelineIndex(n);if(!s)return Promise.resolve(!1);if(s.pendingPaginate)return s.pendingPaginate;if(t.extend(n,i))return Promise.resolve(!0);const r=(async(e,t,n,i,s)=>{var r;const o=t.timeline,a=o.getTimelineSet(),l=null!==(r=o.getPaginationToken(i))&&void 0!==r?r:void 0,c=await this.populateFileTimeline(a,o,n,s,l,i);return t.pendingPaginate=void 0,e.extend(i,s),c})(t,s,e,n,i);return s.pendingPaginate=r,r}async getStats(){var e;const t=null===(e=r.A.get())||void 0===e?void 0:e.getEventIndexingManager();return null==t?void 0:t.getStats()}async isRoomIndexed(e){var t;const n=null===(t=r.A.get())||void 0===t?void 0:t.getEventIndexingManager();return null==n?void 0:n.isRoomIndexed(e)}currentRoom(){if(null===this.currentCheckpoint&&0===this.crawlerCheckpoints.length)return null;const e=d.J.safeGet();return null!==this.currentCheckpoint?e.getRoom(this.currentCheckpoint.roomId):e.getRoom(this.crawlerCheckpoints[0].roomId)}crawlingRooms(){const e=new Set,t=new Set;this.crawlerCheckpoints.forEach(((e,n)=>{t.add(e.roomId)})),null!==this.currentCheckpoint&&t.add(this.currentCheckpoint.roomId);const n=d.J.safeGet();return n.getRooms().filter((e=>n.isRoomEncrypted(e.roomId))).forEach(((t,n)=>{e.add(t.roomId)})),{crawlingRooms:t,totalRooms:e}}}class v{constructor(){(0,i.A)(this,"index",null),(0,i.A)(this,"error",void 0),(0,i.A)(this,"_supportIsInstalled",!1)}async init(){var e;const t=null===(e=r.A.get())||void 0===e?void 0:e.getEventIndexingManager();return t?(this._supportIsInstalled=await t.supportsEventIndexing(),this.supportIsInstalled()?h.A.getValueAt(u.p.DEVICE,"enableEventIndexing")?this.initEventIndex():(s.v.log("EventIndex: Event indexing is disabled, not initializing"),!1):(s.v.log("EventIndex: Event indexing isn't installed for the platform, not initializing."),!1)):(s.v.log("EventIndex: Platform doesn't support event indexing, not initializing."),!1)}async initEventIndex(){var e;const t=new p,n=null===(e=r.A.get())||void 0===e?void 0:e.getEventIndexingManager(),i=d.J.get();if(!n||!i)throw new Error("Unable to init event index");const o=i.getUserId(),a=i.getDeviceId();try{await n.initEventIndex(o,a);const e=await n.getUserVersion(),i=await n.isEventIndexEmpty();i?await n.setUserVersion(1):0!==e||i||(await n.closeEventIndex(),await this.deleteEventIndex(),await n.initEventIndex(o,a),await n.setUserVersion(1)),s.v.log("EventIndex: Successfully initialized the event index"),await t.init()}catch(e){return s.v.log("EventIndex: Error initializing the event index",e),this.error=e,!1}return this.index=t,!0}platformHasSupport(){var e;return null!=(null===(e=r.A.get())||void 0===e?void 0:e.getEventIndexingManager())}supportIsInstalled(){return this._supportIsInstalled}get(){return this.index}start(){null!==this.index&&this.index.startCrawler()}stop(){null!==this.index&&this.index.stopCrawler()}async unset(){null!==this.index&&(await this.index.close(),this.index=null)}async deleteEventIndex(){var e;const t=null===(e=r.A.get())||void 0===e?void 0:e.getEventIndexingManager();t&&(await this.unset(),s.v.log("EventIndex: Deleting event index."),await t.deleteEventIndex())}}window.mxEventIndexPeg||(window.mxEventIndexPeg=new v);const g=window.mxEventIndexPeg},"./src/stores/SetupEncryptionStore.ts":(e,t,n)=>{"use strict";n.d(t,{a:()=>m,s:()=>p});var i=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=n("./node_modules/events/events.js"),r=n.n(s),o=n("./node_modules/matrix-js-sdk/src/crypto-api/index.ts"),a=n("./node_modules/matrix-js-sdk/src/logger.ts"),l=n("./src/MatrixClientPeg.ts"),c=n("./src/SecurityManager.ts"),d=n("./src/contexts/SDKContext.ts"),h=n("./src/utils/arrays.ts"),u=n("./src/utils/device/dehydration.ts");let m=function(e){return e[e.Loading=0]="Loading",e[e.Intro=1]="Intro",e[e.Busy=2]="Busy",e[e.Done=3]="Done",e[e.ConfirmSkip=4]="ConfirmSkip",e[e.Finished=5]="Finished",e[e.ConfirmReset=6]="ConfirmReset",e}({});class p extends(r()){constructor(...e){super(...e),(0,i.A)(this,"started",void 0),(0,i.A)(this,"phase",void 0),(0,i.A)(this,"verificationRequest",null),(0,i.A)(this,"backupInfo",null),(0,i.A)(this,"keyId",null),(0,i.A)(this,"keyInfo",null),(0,i.A)(this,"hasDevicesToVerifyAgainst",void 0),(0,i.A)(this,"onUserTrustStatusChanged",(async e=>{var t;if(e!==l.J.safeGet().getSafeUserId())return;await(null===(t=l.J.safeGet().getCrypto())||void 0===t?void 0:t.getCrossSigningKeyId())&&(this.phase=m.Done,this.emit("update"))})),(0,i.A)(this,"onVerificationRequest",(e=>{this.setActiveVerificationRequest(e)})),(0,i.A)(this,"onVerificationRequestChange",(async()=>{var e,t;if((null===(e=this.verificationRequest)||void 0===e?void 0:e.phase)===o.VerificationPhase.Cancelled)this.verificationRequest.off(o.VerificationRequestEvent.Change,this.onVerificationRequestChange),this.verificationRequest=null,this.emit("update");else if((null===(t=this.verificationRequest)||void 0===t?void 0:t.phase)===o.VerificationPhase.Done){var n;this.verificationRequest.off(o.VerificationRequestEvent.Change,this.onVerificationRequestChange),this.verificationRequest=null;const e=await(null===(n=l.J.safeGet().getCrypto())||void 0===n?void 0:n.getCrossSigningKeyId());this.phase=e?m.Done:m.Busy,this.emit("update")}}))}static sharedInstance(){return window.mxSetupEncryptionStore||(window.mxSetupEncryptionStore=new p),window.mxSetupEncryptionStore}start(){if(this.started)return;this.started=!0,this.phase=m.Loading;const e=l.J.safeGet();e.on(o.CryptoEvent.VerificationRequestReceived,this.onVerificationRequest),e.on(o.CryptoEvent.UserTrustStatusChanged,this.onUserTrustStatusChanged);const t=e.getCrypto().getVerificationRequestsToDeviceInProgress(e.getUserId());t.length&&this.setActiveVerificationRequest(t[t.length-1]),this.fetchKeyInfo()}stop(){var e;if(!this.started)return;this.started=!1,null===(e=this.verificationRequest)||void 0===e||e.off(o.VerificationRequestEvent.Change,this.onVerificationRequestChange);const t=l.J.get();t&&(t.removeListener(o.CryptoEvent.VerificationRequestReceived,this.onVerificationRequest),t.removeListener(o.CryptoEvent.UserTrustStatusChanged,this.onUserTrustStatusChanged))}async fetchKeyInfo(){var e,t;if(!this.started)return;const n=l.J.safeGet(),i=await n.secretStorage.isStored("m.cross_signing.master");null===i||0===Object.keys(i).length?(this.keyId=null,this.keyInfo=null):(this.keyId=Object.keys(i)[0],this.keyInfo=i[this.keyId]);const s=n.getUserId(),r=n.getCrypto(),o=null!==(e=null===(t=(await r.getUserDeviceInfo([s])).get(s))||void 0===t?void 0:t.values())&&void 0!==e?e:[];this.hasDevicesToVerifyAgainst=await(0,h.rm)(o,(async e=>{if(e.dehydrated)return!1;if(!e.getIdentityKey())return!1;const t=await r.getDeviceVerificationStatus(s,e.deviceId);return!(null==t||!t.signedByOwner)})),this.phase=m.Intro,this.emit("update")}async usePassPhrase(){a.v.debug("SetupEncryptionStore.usePassphrase"),this.phase=m.Busy,this.emit("update");try{var e,t,n;const i=l.J.safeGet(),s=null!==(e=await(null===(t=i.getCrypto())||void 0===t?void 0:t.getKeyBackupInfo()))&&void 0!==e?e:null;this.backupInfo=s,this.emit("update"),await new Promise(((e,t)=>{(0,c.cb)((async()=>{var t,n;(a.v.debug("SetupEncryptionStore.usePassphrase: cross-signing and secret storage set up; checking dehydration and backup in the background"),e(),await(0,u.b)(),s)&&(await(null===(t=i.getCrypto())||void 0===t?void 0:t.loadSessionBackupPrivateKeyFromSecretStorage()),await(null===(n=i.getCrypto())||void 0===n?void 0:n.restoreKeyBackup()))})).catch(t)})),await(null===(n=i.getCrypto())||void 0===n?void 0:n.getCrossSigningKeyId())&&(a.v.debug("SetupEncryptionStore.usePassphrase: done"),this.phase=m.Done,this.emit("update"))}catch(e){e instanceof c.qQ?a.v.debug("SetupEncryptionStore.usePassphrase: user cancelled access to secret storage"):a.v.log("SetupEncryptionStore.usePassphrase: error",e),this.phase=m.Intro,this.emit("update")}}skip(){this.phase=m.ConfirmSkip,this.emit("update")}skipConfirm(){this.phase=m.Finished,this.emit("update")}returnAfterSkip(){this.phase=m.Intro,this.emit("update")}reset(){this.phase=m.ConfirmReset,this.emit("update")}async resetConfirm(){try{await(0,c.cb)((async()=>{this.phase=m.Finished}),{forceReset:!0,resetCrossSigning:!0,accountPassword:d.M.instance.accountPasswordStore.getPassword()})}catch(e){a.v.error("Error resetting cross-signing",e),this.phase=m.Intro}this.emit("update")}returnAfterReset(){this.phase=m.Intro,this.emit("update")}done(){this.phase=m.Finished,this.emit("update")}async setActiveVerificationRequest(e){this.started&&e.otherUserId===l.J.safeGet().getUserId()&&(this.verificationRequest&&this.verificationRequest.off(o.VerificationRequestEvent.Change,this.onVerificationRequestChange),this.verificationRequest=e,await e.accept(),e.on(o.VerificationRequestEvent.Change,this.onVerificationRequestChange),this.emit("update"))}lostKeys(){return!this.hasDevicesToVerifyAgainst&&!this.keyInfo}}},"./src/stores/ThreepidInviteStore.ts":(e,t,n)=>{"use strict";n.d(t,{A:()=>c});var i=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=n("./node_modules/events/events.js"),r=n.n(s),o=n("./node_modules/rfc4648/lib/rfc4648.js");function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}const l="mx_threepid_invite_";class c extends(r()){static get instance(){return c._instance||(c._instance=new c),c._instance}storeInvite(e,t){const n=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){(0,i.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({roomId:e},t),s=this.generateIdOf(n);return localStorage.setItem(`${l}${s}`,JSON.stringify(n)),this.translateInvite(n)}getWireInvites(){const e=[];for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t);if(null!=n&&n.startsWith(l))try{e.push(JSON.parse(localStorage.getItem(n)))}catch(e){console.warn("Failed to parse 3pid invite",e)}}return e}getInvites(){return this.getWireInvites().map((e=>this.translateInvite(e)))}pickBestInvite(){return this.getInvites()[0]}resolveInvite(e){localStorage.removeItem(`${l}${e.id}`)}generateIdOf(e){return o.RG.stringify((new TextEncoder).encode(JSON.stringify(e)))}translateInvite(e){return{id:this.generateIdOf(e),roomId:e.roomId,toEmail:e.email,signUrl:e.signurl,roomName:e.room_name,roomAvatarUrl:e.room_avatar_url,inviterName:e.inviter_name}}translateToWireFormat(e){return{email:e.toEmail,signurl:e.signUrl,room_name:e.roomName,room_avatar_url:e.roomAvatarUrl,inviter_name:e.inviterName}}}(0,i.A)(c,"_instance",void 0)},"./src/utils/EventRenderingUtils.ts":(e,t,n)=>{"use strict";n.d(t,{v:()=>c});var i=n("./node_modules/matrix-js-sdk/src/matrix.ts"),s=n("./src/settings/SettingsStore.ts"),r=n("./src/events/EventTileFactory.tsx"),o=n("./src/utils/EventUtils.ts"),a=n("./src/models/Call.ts");const l=(e,t,n,s)=>!(n||s||e===i.EventType.RoomMessage||e===i.EventType.RoomMessageEncrypted||e===i.EventType.Sticker||e===i.EventType.RoomCreate||i.M_POLL_START.matches(e)||i.M_POLL_END.matches(e)||i.M_BEACON_INFO.matches(e));function c(e,t,n,c){const d=t.getContent(),h=d.msgtype,u=t.getType();let m=!1;if(s.A.getValue("feature_msc3531_hide_messages_pending_moderation"))switch((0,o.$k)(t,e)){case o.H3.VISIBLE_FOR_ALL:case o.H3.HIDDEN_TO_CURRENT_USER:break;case o.H3.SEE_THROUGH_FOR_CURRENT_USER:m=!0}let p=(0,r.Sj)(t,e,n),v=u.startsWith("m.key.verification")||u===i.EventType.RoomMessage&&(null==h?void 0:h.startsWith("m.key.verification"))||u===i.EventType.RoomCreate||u===i.EventType.RoomEncryption||p===r.ur;const g=!v&&(u===i.EventType.CallInvite||a.Ho.CALL_EVENT_TYPE.matches(u));let f=l(u,d,v,g);const _=u===i.EventType.RoomMessage&&h===i.MsgType.Emote||i.M_POLL_START.matches(u)||i.M_BEACON_INFO.matches(u)||(0,o.wq)(t);return!c&&(0,r.bN)(t,e,n)||(p=(0,r.Sj)(t,e,n,!0),p===r.DD&&(v=!1,f=!0)),{hasRenderer:!!p,isInfoMessage:f,isBubbleMessage:v,isLeftAlignedBubbleMessage:g,noBubbleEvent:_,isSeeingThroughMessageHiddenForModeration:m}}},"./src/utils/device/clientInformation.ts":(e,t,n)=>{"use strict";n.d(t,{BW:()=>a,Uh:()=>c,Zx:()=>r,eD:()=>o});const i="io.element.matrix_client_information.",s=e=>`${i}${e}`,r=async(e,t,n)=>{const i=e.getDeviceId(),{brand:r}=t,o=await(null==n?void 0:n.getAppVersion()),a=s(i),l=(()=>{if(window.electron)return;const e=new URL(window.location.href);return[e.host,e.pathname.replace(/\/$/,"")].join("")})();await e.setAccountData(a,{name:r,version:o,url:l})},o=(e,t)=>{Array.from(t.store.accountData.values()).forEach((n=>{if(!n.getType().startsWith(i))return;const[,s]=n.getType().split(i);s&&!e.includes(s)&&t.deleteAccountData(n.getType())}))},a=async e=>{const t=e.getDeviceId(),n=s(t),i=c(e,t);(i.name||i.version||i.url)&&await e.deleteAccountData(n)},l=e=>e&&"string"==typeof e?e:void 0,c=(e,t)=>{const n=e.getAccountData(s(t));if(!n)return{};const{name:i,version:r,url:o}=n.getContent();return{name:l(i),version:l(r),url:l(o)}}},"./src/utils/device/dehydration.ts":(e,t,n)=>{"use strict";n.d(t,{b:()=>r});var i=n("./node_modules/matrix-js-sdk/src/logger.ts"),s=n("./src/MatrixClientPeg.ts");async function r(e=!1){const t=s.J.safeGet().getCrypto();await async function(e){if(!e)return!1;if(!await e.isDehydrationSupported())return!1;const t=await s.J.safeGet().waitForClientWellKnown();return!(null==t||!t["org.matrix.msc3814"])}(t)&&(i.v.log("Device dehydration enabled"),await t.startDehydration(e))}},"./src/utils/device/isDeviceVerified.ts":(e,t,n)=>{"use strict";n.d(t,{z:()=>i});const i=async(e,t)=>{var n;const i=await(null===(n=e.getCrypto())||void 0===n?void 0:n.getDeviceVerificationStatus(e.getSafeUserId(),t));return i?i.crossSigningVerified:null}},"./src/utils/oidc/authorize.ts":(e,t,n)=>{"use strict";n.d(t,{N:()=>a,Y:()=>l});var i=n("./node_modules/matrix-js-sdk/src/oidc/authorize.ts"),s=n("./node_modules/matrix-js-sdk/src/randomstring.ts"),r=n("./src/utils/oidc/error.ts"),o=n("./src/PlatformPeg.ts");const a=async(e,t,n,r,a)=>{var l;const c=o.A.get().getOidcCallbackUrl().href,d=(0,s.DU)(10),h=a?"create":void 0,u=await(0,i.R2)({metadata:e.metadata,redirectUri:c,clientId:t,homeserverUrl:n,identityServerUrl:r,nonce:d,prompt:h,urlState:null===(l=o.A.get())||void 0===l?void 0:l.getOidcClientState()});window.location.href=u},l=async e=>{const{code:t,state:n}=(e=>{const t=e.code,n=e.state;if(!t||"string"!=typeof t||!n||"string"!=typeof n)throw new Error(r.D.InvalidQueryParameters);return{code:t,state:n}})(e),{homeserverUrl:s,tokenResponse:o,idTokenClaims:a,identityServerUrl:l,oidcClientSettings:c}=await(0,i.SU)(t,n);return{homeserverUrl:s,identityServerUrl:l,accessToken:o.access_token,refreshToken:o.refresh_token,idToken:o.id_token,clientId:c.clientId,issuer:c.issuer,idTokenClaims:a}}},"./src/utils/oidc/error.ts":(e,t,n)=>{"use strict";n.d(t,{D:()=>r,v:()=>o});var i=n("./node_modules/matrix-js-sdk/src/oidc/error.ts"),s=n("./src/languageHandler.tsx");let r=function(e){return e.InvalidQueryParameters="Invalid query parameters for OIDC native login. `code` and `state` are required.",e}({});const o=e=>{switch(e.message){case i.u.MissingOrInvalidStoredState:return(0,s._t)("auth|oidc|missing_or_invalid_stored_state");case r.InvalidQueryParameters:case i.u.CodeExchangeFailed:case i.u.InvalidBearerTokenResponse:case i.u.InvalidIdToken:default:return(0,s._t)("auth|oidc|generic_auth_error")}}},"./node_modules/base64-arraybuffer/dist/base64-arraybuffer.es5.js":(e,t,n)=>{"use strict";n.r(t),n.d(t,{decode:()=>a,encode:()=>o});for(var i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s="undefined"==typeof Uint8Array?[]:new Uint8Array(256),r=0;r<64;r++)s[i.charCodeAt(r)]=r;var o=function(e){var t,n=new Uint8Array(e),s=n.length,r="";for(t=0;t<s;t+=3)r+=i[n[t]>>2],r+=i[(3&n[t])<<4|n[t+1]>>4],r+=i[(15&n[t+1])<<2|n[t+2]>>6],r+=i[63&n[t+2]];return s%3==2?r=r.substring(0,r.length-1)+"=":s%3==1&&(r=r.substring(0,r.length-2)+"=="),r},a=function(e){var t,n,i,r,o,a=.75*e.length,l=e.length,c=0;"="===e[e.length-1]&&(a--,"="===e[e.length-2]&&a--);var d=new ArrayBuffer(a),h=new Uint8Array(d);for(t=0;t<l;t+=4)n=s[e.charCodeAt(t)],i=s[e.charCodeAt(t+1)],r=s[e.charCodeAt(t+2)],o=s[e.charCodeAt(t+3)],h[c++]=n<<2|i>>4,h[c++]=(15&i)<<4|r>>2,h[c++]=(3&r)<<6|63&o;return d}},"./node_modules/cuint/index.js":(e,t,n)=>{t.UINT32=n("./node_modules/cuint/lib/uint32.js"),t.UINT64=n("./node_modules/cuint/lib/uint64.js")},"./node_modules/cuint/lib/uint32.js":function(e,t){var n;!function(){i(Math.pow(36,5)),i(Math.pow(16,7)),i(Math.pow(10,9)),i(Math.pow(2,30)),i(36),i(16),i(10),i(2);function i(e,t){return this instanceof i?(this._low=0,this._high=0,this.remainder=null,void 0===t?r.call(this,e):"string"==typeof e?o.call(this,e,t):void s.call(this,e,t)):new i(e,t)}function s(e,t){return this._low=0|e,this._high=0|t,this}function r(e){return this._low=65535&e,this._high=e>>>16,this}function o(e,t){var n=parseInt(e,t||10);return this._low=65535&n,this._high=n>>>16,this}i.prototype.fromBits=s,i.prototype.fromNumber=r,i.prototype.fromString=o,i.prototype.toNumber=function(){return 65536*this._high+this._low},i.prototype.toString=function(e){return this.toNumber().toString(e||10)},i.prototype.add=function(e){var t=this._low+e._low,n=t>>>16;return n+=this._high+e._high,this._low=65535&t,this._high=65535&n,this},i.prototype.subtract=function(e){return this.add(e.clone().negate())},i.prototype.multiply=function(e){var t,n,i=this._high,s=this._low,r=e._high,o=e._low;return t=(n=s*o)>>>16,t+=i*o,t&=65535,t+=s*r,this._low=65535&n,this._high=65535&t,this},i.prototype.div=function(e){if(0==e._low&&0==e._high)throw Error("division by zero");if(0==e._high&&1==e._low)return this.remainder=new i(0),this;if(e.gt(this))return this.remainder=this.clone(),this._low=0,this._high=0,this;if(this.eq(e))return this.remainder=new i(0),this._low=1,this._high=0,this;for(var t=e.clone(),n=-1;!this.lt(t);)t.shiftLeft(1,!0),n++;for(this.remainder=this.clone(),this._low=0,this._high=0;n>=0;n--)t.shiftRight(1),this.remainder.lt(t)||(this.remainder.subtract(t),n>=16?this._high|=1<<n-16:this._low|=1<<n);return this},i.prototype.negate=function(){var e=1+(65535&~this._low);return this._low=65535&e,this._high=~this._high+(e>>>16)&65535,this},i.prototype.equals=i.prototype.eq=function(e){return this._low==e._low&&this._high==e._high},i.prototype.greaterThan=i.prototype.gt=function(e){return this._high>e._high||!(this._high<e._high)&&this._low>e._low},i.prototype.lessThan=i.prototype.lt=function(e){return this._high<e._high||!(this._high>e._high)&&this._low<e._low},i.prototype.or=function(e){return this._low|=e._low,this._high|=e._high,this},i.prototype.and=function(e){return this._low&=e._low,this._high&=e._high,this},i.prototype.not=function(){return this._low=65535&~this._low,this._high=65535&~this._high,this},i.prototype.xor=function(e){return this._low^=e._low,this._high^=e._high,this},i.prototype.shiftRight=i.prototype.shiftr=function(e){return e>16?(this._low=this._high>>e-16,this._high=0):16==e?(this._low=this._high,this._high=0):(this._low=this._low>>e|this._high<<16-e&65535,this._high>>=e),this},i.prototype.shiftLeft=i.prototype.shiftl=function(e,t){return e>16?(this._high=this._low<<e-16,this._low=0,t||(this._high&=65535)):16==e?(this._high=this._low,this._low=0):(this._high=this._high<<e|this._low>>16-e,this._low=this._low<<e&65535,t||(this._high&=65535)),this},i.prototype.rotateLeft=i.prototype.rotl=function(e){var t=this._high<<16|this._low;return t=t<<e|t>>>32-e,this._low=65535&t,this._high=t>>>16,this},i.prototype.rotateRight=i.prototype.rotr=function(e){var t=this._high<<16|this._low;return t=t>>>e|t<<32-e,this._low=65535&t,this._high=t>>>16,this},i.prototype.clone=function(){return new i(this._low,this._high)},void 0===(n=function(){return i}.apply(t,[]))||(e.exports=n)}()},"./node_modules/cuint/lib/uint64.js":function(e,t){var n;!function(){var i={16:r(Math.pow(16,5)),10:r(Math.pow(10,5)),2:r(Math.pow(2,5))},s={16:r(16),10:r(10),2:r(2)};function r(e,t,n,i){return this instanceof r?(this.remainder=null,"string"==typeof e?l.call(this,e,t):void 0===t?a.call(this,e):void o.apply(this,arguments)):new r(e,t,n,i)}function o(e,t,n,i){return void 0===n?(this._a00=65535&e,this._a16=e>>>16,this._a32=65535&t,this._a48=t>>>16,this):(this._a00=0|e,this._a16=0|t,this._a32=0|n,this._a48=0|i,this)}function a(e){return this._a00=65535&e,this._a16=e>>>16,this._a32=0,this._a48=0,this}function l(e,t){t=t||10,this._a00=0,this._a16=0,this._a32=0,this._a48=0;for(var n=i[t]||new r(Math.pow(t,5)),s=0,o=e.length;s<o;s+=5){var a=Math.min(5,o-s),l=parseInt(e.slice(s,s+a),t);this.multiply(a<5?new r(Math.pow(t,a)):n).add(new r(l))}return this}r.prototype.fromBits=o,r.prototype.fromNumber=a,r.prototype.fromString=l,r.prototype.toNumber=function(){return 65536*this._a16+this._a00},r.prototype.toString=function(e){var t=s[e=e||10]||new r(e);if(!this.gt(t))return this.toNumber().toString(e);for(var n=this.clone(),i=new Array(64),o=63;o>=0&&(n.div(t),i[o]=n.remainder.toNumber().toString(e),n.gt(t));o--);return i[o-1]=n.toNumber().toString(e),i.join("")},r.prototype.add=function(e){var t=this._a00+e._a00,n=t>>>16,i=(n+=this._a16+e._a16)>>>16,s=(i+=this._a32+e._a32)>>>16;return s+=this._a48+e._a48,this._a00=65535&t,this._a16=65535&n,this._a32=65535&i,this._a48=65535&s,this},r.prototype.subtract=function(e){return this.add(e.clone().negate())},r.prototype.multiply=function(e){var t=this._a00,n=this._a16,i=this._a32,s=this._a48,r=e._a00,o=e._a16,a=e._a32,l=t*r,c=l>>>16,d=(c+=t*o)>>>16;c&=65535,d+=(c+=n*r)>>>16;var h=(d+=t*a)>>>16;return d&=65535,h+=(d+=n*o)>>>16,d&=65535,h+=(d+=i*r)>>>16,h+=t*e._a48,h&=65535,h+=n*a,h&=65535,h+=i*o,h&=65535,h+=s*r,this._a00=65535&l,this._a16=65535&c,this._a32=65535&d,this._a48=65535&h,this},r.prototype.div=function(e){if(0==e._a16&&0==e._a32&&0==e._a48){if(0==e._a00)throw Error("division by zero");if(1==e._a00)return this.remainder=new r(0),this}if(e.gt(this))return this.remainder=this.clone(),this._a00=0,this._a16=0,this._a32=0,this._a48=0,this;if(this.eq(e))return this.remainder=new r(0),this._a00=1,this._a16=0,this._a32=0,this._a48=0,this;for(var t=e.clone(),n=-1;!this.lt(t);)t.shiftLeft(1,!0),n++;for(this.remainder=this.clone(),this._a00=0,this._a16=0,this._a32=0,this._a48=0;n>=0;n--)t.shiftRight(1),this.remainder.lt(t)||(this.remainder.subtract(t),n>=48?this._a48|=1<<n-48:n>=32?this._a32|=1<<n-32:n>=16?this._a16|=1<<n-16:this._a00|=1<<n);return this},r.prototype.negate=function(){var e=1+(65535&~this._a00);return this._a00=65535&e,e=(65535&~this._a16)+(e>>>16),this._a16=65535&e,e=(65535&~this._a32)+(e>>>16),this._a32=65535&e,this._a48=~this._a48+(e>>>16)&65535,this},r.prototype.equals=r.prototype.eq=function(e){return this._a48==e._a48&&this._a00==e._a00&&this._a32==e._a32&&this._a16==e._a16},r.prototype.greaterThan=r.prototype.gt=function(e){return this._a48>e._a48||!(this._a48<e._a48)&&(this._a32>e._a32||!(this._a32<e._a32)&&(this._a16>e._a16||!(this._a16<e._a16)&&this._a00>e._a00))},r.prototype.lessThan=r.prototype.lt=function(e){return this._a48<e._a48||!(this._a48>e._a48)&&(this._a32<e._a32||!(this._a32>e._a32)&&(this._a16<e._a16||!(this._a16>e._a16)&&this._a00<e._a00))},r.prototype.or=function(e){return this._a00|=e._a00,this._a16|=e._a16,this._a32|=e._a32,this._a48|=e._a48,this},r.prototype.and=function(e){return this._a00&=e._a00,this._a16&=e._a16,this._a32&=e._a32,this._a48&=e._a48,this},r.prototype.xor=function(e){return this._a00^=e._a00,this._a16^=e._a16,this._a32^=e._a32,this._a48^=e._a48,this},r.prototype.not=function(){return this._a00=65535&~this._a00,this._a16=65535&~this._a16,this._a32=65535&~this._a32,this._a48=65535&~this._a48,this},r.prototype.shiftRight=r.prototype.shiftr=function(e){return(e%=64)>=48?(this._a00=this._a48>>e-48,this._a16=0,this._a32=0,this._a48=0):e>=32?(e-=32,this._a00=65535&(this._a32>>e|this._a48<<16-e),this._a16=this._a48>>e&65535,this._a32=0,this._a48=0):e>=16?(e-=16,this._a00=65535&(this._a16>>e|this._a32<<16-e),this._a16=65535&(this._a32>>e|this._a48<<16-e),this._a32=this._a48>>e&65535,this._a48=0):(this._a00=65535&(this._a00>>e|this._a16<<16-e),this._a16=65535&(this._a16>>e|this._a32<<16-e),this._a32=65535&(this._a32>>e|this._a48<<16-e),this._a48=this._a48>>e&65535),this},r.prototype.shiftLeft=r.prototype.shiftl=function(e,t){return(e%=64)>=48?(this._a48=this._a00<<e-48,this._a32=0,this._a16=0,this._a00=0):e>=32?(e-=32,this._a48=this._a16<<e|this._a00>>16-e,this._a32=this._a00<<e&65535,this._a16=0,this._a00=0):e>=16?(e-=16,this._a48=this._a32<<e|this._a16>>16-e,this._a32=65535&(this._a16<<e|this._a00>>16-e),this._a16=this._a00<<e&65535,this._a00=0):(this._a48=this._a48<<e|this._a32>>16-e,this._a32=65535&(this._a32<<e|this._a16>>16-e),this._a16=65535&(this._a16<<e|this._a00>>16-e),this._a00=this._a00<<e&65535),t||(this._a48&=65535),this},r.prototype.rotateLeft=r.prototype.rotl=function(e){if(0==(e%=64))return this;if(e>=32){var t=this._a00;if(this._a00=this._a32,this._a32=t,t=this._a48,this._a48=this._a16,this._a16=t,32==e)return this;e-=32}var n=this._a48<<16|this._a32,i=this._a16<<16|this._a00,s=n<<e|i>>>32-e,r=i<<e|n>>>32-e;return this._a00=65535&r,this._a16=r>>>16,this._a32=65535&s,this._a48=s>>>16,this},r.prototype.rotateRight=r.prototype.rotr=function(e){if(0==(e%=64))return this;if(e>=32){var t=this._a00;if(this._a00=this._a32,this._a32=t,t=this._a48,this._a48=this._a16,this._a16=t,32==e)return this;e-=32}var n=this._a48<<16|this._a32,i=this._a16<<16|this._a00,s=n>>>e|i<<32-e,r=i>>>e|n<<32-e;return this._a00=65535&r,this._a16=r>>>16,this._a32=65535&s,this._a48=s>>>16,this},r.prototype.clone=function(){return new r(this._a00,this._a16,this._a32,this._a48)},void 0===(n=function(){return r}.apply(t,[]))||(e.exports=n)}()},"./node_modules/reflect-metadata/Reflect.js":(e,t,n)=>{var i,s=n("./node_modules/process/browser.js");!function(e){!function(){var t="object"==typeof n.g?n.g:"object"==typeof self?self:"object"==typeof this?this:Function("return this;")(),i=r(e);function r(e,t){return function(n,i){"function"!=typeof e[n]&&Object.defineProperty(e,n,{configurable:!0,writable:!0,value:i}),t&&t(n,i)}}void 0===t.Reflect?t.Reflect=e:i=r(t.Reflect,i),function(e){var t=Object.prototype.hasOwnProperty,n="function"==typeof Symbol,i=n&&void 0!==Symbol.toPrimitive?Symbol.toPrimitive:"@@toPrimitive",r=n&&void 0!==Symbol.iterator?Symbol.iterator:"@@iterator",o="function"==typeof Object.create,a={__proto__:[]}instanceof Array,l=!o&&!a,c={create:o?function(){return se(Object.create(null))}:a?function(){return se({__proto__:null})}:function(){return se({})},has:l?function(e,n){return t.call(e,n)}:function(e,t){return t in e},get:l?function(e,n){return t.call(e,n)?e[n]:void 0}:function(e,t){return e[t]}},d=Object.getPrototypeOf(Function),h="object"==typeof s&&s.env&&"true"===s.env.REFLECT_METADATA_USE_MAP_POLYFILL,u=h||"function"!=typeof Map||"function"!=typeof Map.prototype.entries?te():Map,m=h||"function"!=typeof Set||"function"!=typeof Set.prototype.entries?ne():Set,p=new(h||"function"!=typeof WeakMap?ie():WeakMap);function v(e,t,n,i){if(j(n)){if(!K(e))throw new TypeError;if(!J(t))throw new TypeError;return b(e,t)}if(!K(e))throw new TypeError;if(!B(t))throw new TypeError;if(!B(i)&&!j(i)&&!F(i))throw new TypeError;return F(i)&&(i=void 0),S(e,t,n=z(n),i)}function g(e,t){function n(n,i){if(!B(n))throw new TypeError;if(!j(i)&&!W(i))throw new TypeError;N(e,t,n,i)}return n}function f(e,t,n,i){if(!B(n))throw new TypeError;return j(i)||(i=z(i)),N(e,t,n,i)}function _(e,t,n){if(!B(t))throw new TypeError;return j(n)||(n=z(n)),I(e,t,n)}function y(e,t,n){if(!B(t))throw new TypeError;return j(n)||(n=z(n)),k(e,t,n)}function E(e,t,n){if(!B(t))throw new TypeError;return j(n)||(n=z(n)),T(e,t,n)}function x(e,t,n){if(!B(t))throw new TypeError;return j(n)||(n=z(n)),D(e,t,n)}function w(e,t){if(!B(e))throw new TypeError;return j(t)||(t=z(t)),M(e,t)}function A(e,t){if(!B(e))throw new TypeError;return j(t)||(t=z(t)),O(e,t)}function C(e,t,n){if(!B(t))throw new TypeError;j(n)||(n=z(n));var i=R(t,n,!1);if(j(i))return!1;if(!i.delete(e))return!1;if(i.size>0)return!0;var s=p.get(t);return s.delete(n),s.size>0||p.delete(t),!0}function b(e,t){for(var n=e.length-1;n>=0;--n){var i=(0,e[n])(t);if(!j(i)&&!F(i)){if(!J(i))throw new TypeError;t=i}}return t}function S(e,t,n,i){for(var s=e.length-1;s>=0;--s){var r=(0,e[s])(t,n,i);if(!j(r)&&!F(r)){if(!B(r))throw new TypeError;i=r}}return i}function R(e,t,n){var i=p.get(e);if(j(i)){if(!n)return;i=new u,p.set(e,i)}var s=i.get(t);if(j(s)){if(!n)return;s=new u,i.set(t,s)}return s}function I(e,t,n){if(k(e,t,n))return!0;var i=ee(t);return!F(i)&&I(e,i,n)}function k(e,t,n){var i=R(t,n,!1);return!j(i)&&H(i.has(e))}function T(e,t,n){if(k(e,t,n))return D(e,t,n);var i=ee(t);return F(i)?void 0:T(e,i,n)}function D(e,t,n){var i=R(t,n,!1);if(!j(i))return i.get(e)}function N(e,t,n,i){R(n,i,!0).set(e,t)}function M(e,t){var n=O(e,t),i=ee(e);if(null===i)return n;var s=M(i,t);if(s.length<=0)return n;if(n.length<=0)return s;for(var r=new m,o=[],a=0,l=n;a<l.length;a++){var c=l[a];r.has(c)||(r.add(c),o.push(c))}for(var d=0,h=s;d<h.length;d++){c=h[d];r.has(c)||(r.add(c),o.push(c))}return o}function O(e,t){var n=[],i=R(e,t,!1);if(j(i))return n;for(var s=$(i.keys()),r=0;;){var o=X(s);if(!o)return n.length=r,n;var a=Q(o);try{n[r]=a}catch(e){try{Z(s)}finally{throw e}}r++}}function P(e){if(null===e)return 1;switch(typeof e){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return null===e?1:6;default:return 6}}function j(e){return void 0===e}function F(e){return null===e}function U(e){return"symbol"==typeof e}function B(e){return"object"==typeof e?null!==e:"function"==typeof e}function L(e,t){switch(P(e)){case 0:case 1:case 2:case 3:case 4:case 5:return e}var n=3===t?"string":5===t?"number":"default",s=Y(e,i);if(void 0!==s){var r=s.call(e,n);if(B(r))throw new TypeError;return r}return V(e,"default"===n?"number":n)}function V(e,t){if("string"===t){var n=e.toString;if(q(n))if(!B(s=n.call(e)))return s;if(q(i=e.valueOf))if(!B(s=i.call(e)))return s}else{var i;if(q(i=e.valueOf))if(!B(s=i.call(e)))return s;var s,r=e.toString;if(q(r))if(!B(s=r.call(e)))return s}throw new TypeError}function H(e){return!!e}function G(e){return""+e}function z(e){var t=L(e,3);return U(t)?t:G(t)}function K(e){return Array.isArray?Array.isArray(e):e instanceof Object?e instanceof Array:"[object Array]"===Object.prototype.toString.call(e)}function q(e){return"function"==typeof e}function J(e){return"function"==typeof e}function W(e){switch(P(e)){case 3:case 4:return!0;default:return!1}}function Y(e,t){var n=e[t];if(null!=n){if(!q(n))throw new TypeError;return n}}function $(e){var t=Y(e,r);if(!q(t))throw new TypeError;var n=t.call(e);if(!B(n))throw new TypeError;return n}function Q(e){return e.value}function X(e){var t=e.next();return!t.done&&t}function Z(e){var t=e.return;t&&t.call(e)}function ee(e){var t=Object.getPrototypeOf(e);if("function"!=typeof e||e===d)return t;if(t!==d)return t;var n=e.prototype,i=n&&Object.getPrototypeOf(n);if(null==i||i===Object.prototype)return t;var s=i.constructor;return"function"!=typeof s||s===e?t:s}function te(){var e={},t=[],n=function(){function e(e,t,n){this._index=0,this._keys=e,this._values=t,this._selector=n}return e.prototype["@@iterator"]=function(){return this},e.prototype[r]=function(){return this},e.prototype.next=function(){var e=this._index;if(e>=0&&e<this._keys.length){var n=this._selector(this._keys[e],this._values[e]);return e+1>=this._keys.length?(this._index=-1,this._keys=t,this._values=t):this._index++,{value:n,done:!1}}return{value:void 0,done:!0}},e.prototype.throw=function(e){throw this._index>=0&&(this._index=-1,this._keys=t,this._values=t),e},e.prototype.return=function(e){return this._index>=0&&(this._index=-1,this._keys=t,this._values=t),{value:e,done:!0}},e}();return function(){function t(){this._keys=[],this._values=[],this._cacheKey=e,this._cacheIndex=-2}return Object.defineProperty(t.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),t.prototype.has=function(e){return this._find(e,!1)>=0},t.prototype.get=function(e){var t=this._find(e,!1);return t>=0?this._values[t]:void 0},t.prototype.set=function(e,t){var n=this._find(e,!0);return this._values[n]=t,this},t.prototype.delete=function(t){var n=this._find(t,!1);if(n>=0){for(var i=this._keys.length,s=n+1;s<i;s++)this._keys[s-1]=this._keys[s],this._values[s-1]=this._values[s];return this._keys.length--,this._values.length--,t===this._cacheKey&&(this._cacheKey=e,this._cacheIndex=-2),!0}return!1},t.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=e,this._cacheIndex=-2},t.prototype.keys=function(){return new n(this._keys,this._values,i)},t.prototype.values=function(){return new n(this._keys,this._values,s)},t.prototype.entries=function(){return new n(this._keys,this._values,o)},t.prototype["@@iterator"]=function(){return this.entries()},t.prototype[r]=function(){return this.entries()},t.prototype._find=function(e,t){return this._cacheKey!==e&&(this._cacheIndex=this._keys.indexOf(this._cacheKey=e)),this._cacheIndex<0&&t&&(this._cacheIndex=this._keys.length,this._keys.push(e),this._values.push(void 0)),this._cacheIndex},t}();function i(e,t){return e}function s(e,t){return t}function o(e,t){return[e,t]}}function ne(){return function(){function e(){this._map=new u}return Object.defineProperty(e.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),e.prototype.has=function(e){return this._map.has(e)},e.prototype.add=function(e){return this._map.set(e,e),this},e.prototype.delete=function(e){return this._map.delete(e)},e.prototype.clear=function(){this._map.clear()},e.prototype.keys=function(){return this._map.keys()},e.prototype.values=function(){return this._map.values()},e.prototype.entries=function(){return this._map.entries()},e.prototype["@@iterator"]=function(){return this.keys()},e.prototype[r]=function(){return this.keys()},e}()}function ie(){var e=16,n=c.create(),i=s();return function(){function e(){this._key=s()}return e.prototype.has=function(e){var t=r(e,!1);return void 0!==t&&c.has(t,this._key)},e.prototype.get=function(e){var t=r(e,!1);return void 0!==t?c.get(t,this._key):void 0},e.prototype.set=function(e,t){return r(e,!0)[this._key]=t,this},e.prototype.delete=function(e){var t=r(e,!1);return void 0!==t&&delete t[this._key]},e.prototype.clear=function(){this._key=s()},e}();function s(){var e;do{e="@@WeakMap@@"+l()}while(c.has(n,e));return n[e]=!0,e}function r(e,n){if(!t.call(e,i)){if(!n)return;Object.defineProperty(e,i,{value:c.create()})}return e[i]}function o(e,t){for(var n=0;n<t;++n)e[n]=255*Math.random()|0;return e}function a(e){return"function"==typeof Uint8Array?"undefined"!=typeof crypto?crypto.getRandomValues(new Uint8Array(e)):"undefined"!=typeof msCrypto?msCrypto.getRandomValues(new Uint8Array(e)):o(new Uint8Array(e),e):o(new Array(e),e)}function l(){var t=a(e);t[6]=79&t[6]|64,t[8]=191&t[8]|128;for(var n="",i=0;i<e;++i){var s=t[i];4!==i&&6!==i&&8!==i||(n+="-"),s<16&&(n+="0"),n+=s.toString(16).toLowerCase()}return n}}function se(e){return e.__=void 0,delete e.__,e}e("decorate",v),e("metadata",g),e("defineMetadata",f),e("hasMetadata",_),e("hasOwnMetadata",y),e("getMetadata",E),e("getOwnMetadata",x),e("getMetadataKeys",w),e("getOwnMetadataKeys",A),e("deleteMetadata",C)}(i)}()}(i||(i={}))},"./node_modules/seedrandom/index.js":(e,t,n)=>{var i=n("./node_modules/seedrandom/lib/alea.js"),s=n("./node_modules/seedrandom/lib/xor128.js"),r=n("./node_modules/seedrandom/lib/xorwow.js"),o=n("./node_modules/seedrandom/lib/xorshift7.js"),a=n("./node_modules/seedrandom/lib/xor4096.js"),l=n("./node_modules/seedrandom/lib/tychei.js"),c=n("./node_modules/seedrandom/seedrandom.js");c.alea=i,c.xor128=s,c.xorwow=r,c.xorshift7=o,c.xor4096=a,c.tychei=l,e.exports=c},"./node_modules/seedrandom/lib/alea.js":function(e,t,n){var i;!function(e,s){function r(e){var t=this,n=function(){var e=4022871197,t=function(t){t=String(t);for(var n=0;n<t.length;n++){var i=.02519603282416938*(e+=t.charCodeAt(n));i-=e=i>>>0,e=(i*=e)>>>0,e+=4294967296*(i-=e)}return 2.3283064365386963e-10*(e>>>0)};return t}();t.next=function(){var e=2091639*t.s0+2.3283064365386963e-10*t.c;return t.s0=t.s1,t.s1=t.s2,t.s2=e-(t.c=0|e)},t.c=1,t.s0=n(" "),t.s1=n(" "),t.s2=n(" "),t.s0-=n(e),t.s0<0&&(t.s0+=1),t.s1-=n(e),t.s1<0&&(t.s1+=1),t.s2-=n(e),t.s2<0&&(t.s2+=1),n=null}function o(e,t){return t.c=e.c,t.s0=e.s0,t.s1=e.s1,t.s2=e.s2,t}function a(e,t){var n=new r(e),i=t&&t.state,s=n.next;return s.int32=function(){return 4294967296*n.next()|0},s.double=function(){return s()+11102230246251565e-32*(2097152*s()|0)},s.quick=s,i&&("object"==typeof i&&o(i,n),s.state=function(){return o(n,{})}),s}s&&s.exports?s.exports=a:n.amdD&&n.amdO?void 0===(i=function(){return a}.call(t,n,t,s))||(s.exports=i):this.alea=a}(0,e=n.nmd(e),n.amdD)},"./node_modules/seedrandom/lib/tychei.js":function(e,t,n){var i;!function(e,s){function r(e){var t=this,n="";t.next=function(){var e=t.b,n=t.c,i=t.d,s=t.a;return e=e<<25^e>>>7^n,n=n-i|0,i=i<<24^i>>>8^s,s=s-e|0,t.b=e=e<<20^e>>>12^n,t.c=n=n-i|0,t.d=i<<16^n>>>16^s,t.a=s-e|0},t.a=0,t.b=0,t.c=-1640531527,t.d=1367130551,e===Math.floor(e)?(t.a=e/4294967296|0,t.b=0|e):n+=e;for(var i=0;i<n.length+20;i++)t.b^=0|n.charCodeAt(i),t.next()}function o(e,t){return t.a=e.a,t.b=e.b,t.c=e.c,t.d=e.d,t}function a(e,t){var n=new r(e),i=t&&t.state,s=function(){return(n.next()>>>0)/4294967296};return s.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},s.int32=n.next,s.quick=s,i&&("object"==typeof i&&o(i,n),s.state=function(){return o(n,{})}),s}s&&s.exports?s.exports=a:n.amdD&&n.amdO?void 0===(i=function(){return a}.call(t,n,t,s))||(s.exports=i):this.tychei=a}(0,e=n.nmd(e),n.amdD)},"./node_modules/seedrandom/lib/xor128.js":function(e,t,n){var i;!function(e,s){function r(e){var t=this,n="";t.x=0,t.y=0,t.z=0,t.w=0,t.next=function(){var e=t.x^t.x<<11;return t.x=t.y,t.y=t.z,t.z=t.w,t.w^=t.w>>>19^e^e>>>8},e===(0|e)?t.x=e:n+=e;for(var i=0;i<n.length+64;i++)t.x^=0|n.charCodeAt(i),t.next()}function o(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}function a(e,t){var n=new r(e),i=t&&t.state,s=function(){return(n.next()>>>0)/4294967296};return s.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},s.int32=n.next,s.quick=s,i&&("object"==typeof i&&o(i,n),s.state=function(){return o(n,{})}),s}s&&s.exports?s.exports=a:n.amdD&&n.amdO?void 0===(i=function(){return a}.call(t,n,t,s))||(s.exports=i):this.xor128=a}(0,e=n.nmd(e),n.amdD)},"./node_modules/seedrandom/lib/xor4096.js":function(e,t,n){var i;!function(e,s){function r(e){var t=this;t.next=function(){var e,n,i=t.w,s=t.X,r=t.i;return t.w=i=i+1640531527|0,n=s[r+34&127],e=s[r=r+1&127],n^=n<<13,e^=e<<17,n^=n>>>15,e^=e>>>12,n=s[r]=n^e,t.i=r,n+(i^i>>>16)|0},function(e,t){var n,i,s,r,o,a=[],l=128;for(t===(0|t)?(i=t,t=null):(t+="\0",i=0,l=Math.max(l,t.length)),s=0,r=-32;r<l;++r)t&&(i^=t.charCodeAt((r+32)%t.length)),0===r&&(o=i),i^=i<<10,i^=i>>>15,i^=i<<4,i^=i>>>13,r>=0&&(o=o+1640531527|0,s=0==(n=a[127&r]^=i+o)?s+1:0);for(s>=128&&(a[127&(t&&t.length||0)]=-1),s=127,r=512;r>0;--r)i=a[s+34&127],n=a[s=s+1&127],i^=i<<13,n^=n<<17,i^=i>>>15,n^=n>>>12,a[s]=i^n;e.w=o,e.X=a,e.i=s}(t,e)}function o(e,t){return t.i=e.i,t.w=e.w,t.X=e.X.slice(),t}function a(e,t){null==e&&(e=+new Date);var n=new r(e),i=t&&t.state,s=function(){return(n.next()>>>0)/4294967296};return s.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},s.int32=n.next,s.quick=s,i&&(i.X&&o(i,n),s.state=function(){return o(n,{})}),s}s&&s.exports?s.exports=a:n.amdD&&n.amdO?void 0===(i=function(){return a}.call(t,n,t,s))||(s.exports=i):this.xor4096=a}(0,e=n.nmd(e),n.amdD)},"./node_modules/seedrandom/lib/xorshift7.js":function(e,t,n){var i;!function(e,s){function r(e){var t=this;t.next=function(){var e,n,i=t.x,s=t.i;return e=i[s],n=(e^=e>>>7)^e<<24,n^=(e=i[s+1&7])^e>>>10,n^=(e=i[s+3&7])^e>>>3,n^=(e=i[s+4&7])^e<<7,e=i[s+7&7],n^=(e^=e<<13)^e<<9,i[s]=n,t.i=s+1&7,n},function(e,t){var n,i=[];if(t===(0|t))i[0]=t;else for(t=""+t,n=0;n<t.length;++n)i[7&n]=i[7&n]<<15^t.charCodeAt(n)+i[n+1&7]<<13;for(;i.length<8;)i.push(0);for(n=0;n<8&&0===i[n];++n);for(8==n?i[7]=-1:i[n],e.x=i,e.i=0,n=256;n>0;--n)e.next()}(t,e)}function o(e,t){return t.x=e.x.slice(),t.i=e.i,t}function a(e,t){null==e&&(e=+new Date);var n=new r(e),i=t&&t.state,s=function(){return(n.next()>>>0)/4294967296};return s.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},s.int32=n.next,s.quick=s,i&&(i.x&&o(i,n),s.state=function(){return o(n,{})}),s}s&&s.exports?s.exports=a:n.amdD&&n.amdO?void 0===(i=function(){return a}.call(t,n,t,s))||(s.exports=i):this.xorshift7=a}(0,e=n.nmd(e),n.amdD)},"./node_modules/seedrandom/lib/xorwow.js":function(e,t,n){var i;!function(e,s){function r(e){var t=this,n="";t.next=function(){var e=t.x^t.x>>>2;return t.x=t.y,t.y=t.z,t.z=t.w,t.w=t.v,(t.d=t.d+362437|0)+(t.v=t.v^t.v<<4^e^e<<1)|0},t.x=0,t.y=0,t.z=0,t.w=0,t.v=0,e===(0|e)?t.x=e:n+=e;for(var i=0;i<n.length+64;i++)t.x^=0|n.charCodeAt(i),i==n.length&&(t.d=t.x<<10^t.x>>>4),t.next()}function o(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t.v=e.v,t.d=e.d,t}function a(e,t){var n=new r(e),i=t&&t.state,s=function(){return(n.next()>>>0)/4294967296};return s.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},s.int32=n.next,s.quick=s,i&&("object"==typeof i&&o(i,n),s.state=function(){return o(n,{})}),s}s&&s.exports?s.exports=a:n.amdD&&n.amdO?void 0===(i=function(){return a}.call(t,n,t,s))||(s.exports=i):this.xorwow=a}(0,e=n.nmd(e),n.amdD)},"./node_modules/seedrandom/seedrandom.js":function(e,t,n){var i;!function(s,r,o){var a,l=256,c=o.pow(l,6),d=o.pow(2,52),h=2*d,u=255;function m(e,t,n){var i=[],u=f(g((t=1==t?{entropy:!0}:t||{}).entropy?[e,_(r)]:null==e?function(){try{var e;return a&&(e=a.randomBytes)?e=e(l):(e=new Uint8Array(l),(s.crypto||s.msCrypto).getRandomValues(e)),_(e)}catch(e){var t=s.navigator,n=t&&t.plugins;return[+new Date,s,n,s.screen,_(r)]}}():e,3),i),m=new p(i),y=function(){for(var e=m.g(6),t=c,n=0;e<d;)e=(e+n)*l,t*=l,n=m.g(1);for(;e>=h;)e/=2,t/=2,n>>>=1;return(e+n)/t};return y.int32=function(){return 0|m.g(4)},y.quick=function(){return m.g(4)/4294967296},y.double=y,f(_(m.S),r),(t.pass||n||function(e,t,n,i){return i&&(i.S&&v(i,m),e.state=function(){return v(m,{})}),n?(o.random=e,t):e})(y,u,"global"in t?t.global:this==o,t.state)}function p(e){var t,n=e.length,i=this,s=0,r=i.i=i.j=0,o=i.S=[];for(n||(e=[n++]);s<l;)o[s]=s++;for(s=0;s<l;s++)o[s]=o[r=u&r+e[s%n]+(t=o[s])],o[r]=t;(i.g=function(e){for(var t,n=0,s=i.i,r=i.j,o=i.S;e--;)t=o[s=u&s+1],n=n*l+o[u&(o[s]=o[r=u&r+t])+(o[r]=t)];return i.i=s,i.j=r,n})(l)}function v(e,t){return t.i=e.i,t.j=e.j,t.S=e.S.slice(),t}function g(e,t){var n,i=[],s=typeof e;if(t&&"object"==s)for(n in e)try{i.push(g(e[n],t-1))}catch(e){}return i.length?i:"string"==s?e:e+"\0"}function f(e,t){for(var n,i=e+"",s=0;s<i.length;)t[u&s]=u&(n^=19*t[u&s])+i.charCodeAt(s++);return _(t)}function _(e){return String.fromCharCode.apply(0,e)}if(f(o.random(),r),e.exports){e.exports=m;try{a=n("?d4c0")}catch(e){}}else void 0===(i=function(){return m}.call(t,n,t,e))||(e.exports=i)}("undefined"!=typeof self?self:this,[],Math)},"./node_modules/xxhashjs/lib/index.js":(e,t,n)=>{e.exports={h32:n("./node_modules/xxhashjs/lib/xxhash.js"),h64:n("./node_modules/xxhashjs/lib/xxhash64.js")}},"./node_modules/xxhashjs/lib/xxhash.js":(e,t,n)=>{var i=n("./node_modules/cuint/index.js").UINT32;i.prototype.xxh_update=function(e,t){var n,i,o=r._low,a=r._high;n=(i=e*o)>>>16,n+=t*o,n&=65535,n+=e*a;var l=this._low+(65535&i),c=l>>>16,d=(c+=this._high+(65535&n))<<16|65535&l;c=(d=d<<13|d>>>19)>>>16,n=(i=(l=65535&d)*(o=s._low))>>>16,n+=c*o,n&=65535,n+=l*(a=s._high),this._low=65535&i,this._high=65535&n};var s=i("2654435761"),r=i("2246822519"),o=i("3266489917"),a=i("668265263"),l=i("374761393");function c(){return 2==arguments.length?new c(arguments[1]).update(arguments[0]).digest():this instanceof c?void d.call(this,arguments[0]):new c(arguments[0])}function d(e){return this.seed=e instanceof i?e.clone():i(e),this.v1=this.seed.clone().add(s).add(r),this.v2=this.seed.clone().add(r),this.v3=this.seed.clone(),this.v4=this.seed.clone().subtract(s),this.total_len=0,this.memsize=0,this.memory=null,this}c.prototype.init=d,c.prototype.update=function(e){var t,n="string"==typeof e;n&&(e=function(e){for(var t=[],n=0,i=e.length;n<i;n++){var s=e.charCodeAt(n);s<128?t.push(s):s<2048?t.push(192|s>>6,128|63&s):s<55296||s>=57344?t.push(224|s>>12,128|s>>6&63,128|63&s):(n++,s=65536+((1023&s)<<10|1023&e.charCodeAt(n)),t.push(240|s>>18,128|s>>12&63,128|s>>6&63,128|63&s))}return new Uint8Array(t)}(e),n=!1,t=!0),"undefined"!=typeof ArrayBuffer&&e instanceof ArrayBuffer&&(t=!0,e=new Uint8Array(e));var i=0,s=e.length,r=i+s;if(0==s)return this;if(this.total_len+=s,0==this.memsize&&(this.memory=n?"":t?new Uint8Array(16):new Buffer(16)),this.memsize+s<16)return n?this.memory+=e:t?this.memory.set(e.subarray(0,s),this.memsize):e.copy(this.memory,this.memsize,0,s),this.memsize+=s,this;if(this.memsize>0){n?this.memory+=e.slice(0,16-this.memsize):t?this.memory.set(e.subarray(0,16-this.memsize),this.memsize):e.copy(this.memory,this.memsize,0,16-this.memsize);var o=0;n?(this.v1.xxh_update(this.memory.charCodeAt(o+1)<<8|this.memory.charCodeAt(o),this.memory.charCodeAt(o+3)<<8|this.memory.charCodeAt(o+2)),o+=4,this.v2.xxh_update(this.memory.charCodeAt(o+1)<<8|this.memory.charCodeAt(o),this.memory.charCodeAt(o+3)<<8|this.memory.charCodeAt(o+2)),o+=4,this.v3.xxh_update(this.memory.charCodeAt(o+1)<<8|this.memory.charCodeAt(o),this.memory.charCodeAt(o+3)<<8|this.memory.charCodeAt(o+2)),o+=4,this.v4.xxh_update(this.memory.charCodeAt(o+1)<<8|this.memory.charCodeAt(o),this.memory.charCodeAt(o+3)<<8|this.memory.charCodeAt(o+2))):(this.v1.xxh_update(this.memory[o+1]<<8|this.memory[o],this.memory[o+3]<<8|this.memory[o+2]),o+=4,this.v2.xxh_update(this.memory[o+1]<<8|this.memory[o],this.memory[o+3]<<8|this.memory[o+2]),o+=4,this.v3.xxh_update(this.memory[o+1]<<8|this.memory[o],this.memory[o+3]<<8|this.memory[o+2]),o+=4,this.v4.xxh_update(this.memory[o+1]<<8|this.memory[o],this.memory[o+3]<<8|this.memory[o+2])),i+=16-this.memsize,this.memsize=0,n&&(this.memory="")}if(i<=r-16){var a=r-16;do{n?(this.v1.xxh_update(e.charCodeAt(i+1)<<8|e.charCodeAt(i),e.charCodeAt(i+3)<<8|e.charCodeAt(i+2)),i+=4,this.v2.xxh_update(e.charCodeAt(i+1)<<8|e.charCodeAt(i),e.charCodeAt(i+3)<<8|e.charCodeAt(i+2)),i+=4,this.v3.xxh_update(e.charCodeAt(i+1)<<8|e.charCodeAt(i),e.charCodeAt(i+3)<<8|e.charCodeAt(i+2)),i+=4,this.v4.xxh_update(e.charCodeAt(i+1)<<8|e.charCodeAt(i),e.charCodeAt(i+3)<<8|e.charCodeAt(i+2))):(this.v1.xxh_update(e[i+1]<<8|e[i],e[i+3]<<8|e[i+2]),i+=4,this.v2.xxh_update(e[i+1]<<8|e[i],e[i+3]<<8|e[i+2]),i+=4,this.v3.xxh_update(e[i+1]<<8|e[i],e[i+3]<<8|e[i+2]),i+=4,this.v4.xxh_update(e[i+1]<<8|e[i],e[i+3]<<8|e[i+2])),i+=4}while(i<=a)}return i<r&&(n?this.memory+=e.slice(i):t?this.memory.set(e.subarray(i,r),this.memsize):e.copy(this.memory,this.memsize,i,r),this.memsize=r-i),this},c.prototype.digest=function(){var e,t,n=this.memory,c="string"==typeof n,d=0,h=this.memsize,u=new i;for((e=this.total_len>=16?this.v1.rotl(1).add(this.v2.rotl(7).add(this.v3.rotl(12).add(this.v4.rotl(18)))):this.seed.clone().add(l)).add(u.fromNumber(this.total_len));d<=h-4;)c?u.fromBits(n.charCodeAt(d+1)<<8|n.charCodeAt(d),n.charCodeAt(d+3)<<8|n.charCodeAt(d+2)):u.fromBits(n[d+1]<<8|n[d],n[d+3]<<8|n[d+2]),e.add(u.multiply(o)).rotl(17).multiply(a),d+=4;for(;d<h;)u.fromBits(c?n.charCodeAt(d++):n[d++],0),e.add(u.multiply(l)).rotl(11).multiply(s);return t=e.clone().shiftRight(15),e.xor(t).multiply(r),t=e.clone().shiftRight(13),e.xor(t).multiply(o),t=e.clone().shiftRight(16),e.xor(t),this.init(this.seed),e},e.exports=c},"./node_modules/xxhashjs/lib/xxhash64.js":(e,t,n)=>{var i=n("./node_modules/cuint/index.js").UINT64,s=i("11400714785074694791"),r=i("14029467366897019727"),o=i("1609587929392839161"),a=i("9650029242287828579"),l=i("2870177450012600261");function c(){return 2==arguments.length?new c(arguments[1]).update(arguments[0]).digest():this instanceof c?void d.call(this,arguments[0]):new c(arguments[0])}function d(e){return this.seed=e instanceof i?e.clone():i(e),this.v1=this.seed.clone().add(s).add(r),this.v2=this.seed.clone().add(r),this.v3=this.seed.clone(),this.v4=this.seed.clone().subtract(s),this.total_len=0,this.memsize=0,this.memory=null,this}c.prototype.init=d,c.prototype.update=function(e){var t,n="string"==typeof e;n&&(e=function(e){for(var t=[],n=0,i=e.length;n<i;n++){var s=e.charCodeAt(n);s<128?t.push(s):s<2048?t.push(192|s>>6,128|63&s):s<55296||s>=57344?t.push(224|s>>12,128|s>>6&63,128|63&s):(n++,s=65536+((1023&s)<<10|1023&e.charCodeAt(n)),t.push(240|s>>18,128|s>>12&63,128|s>>6&63,128|63&s))}return new Uint8Array(t)}(e),n=!1,t=!0),"undefined"!=typeof ArrayBuffer&&e instanceof ArrayBuffer&&(t=!0,e=new Uint8Array(e));var o=0,a=e.length,l=o+a;if(0==a)return this;if(this.total_len+=a,0==this.memsize&&(this.memory=n?"":t?new Uint8Array(32):new Buffer(32)),this.memsize+a<32)return n?this.memory+=e:t?this.memory.set(e.subarray(0,a),this.memsize):e.copy(this.memory,this.memsize,0,a),this.memsize+=a,this;if(this.memsize>0){n?this.memory+=e.slice(0,32-this.memsize):t?this.memory.set(e.subarray(0,32-this.memsize),this.memsize):e.copy(this.memory,this.memsize,0,32-this.memsize);var c=0;if(n)h=i(this.memory.charCodeAt(c+1)<<8|this.memory.charCodeAt(c),this.memory.charCodeAt(c+3)<<8|this.memory.charCodeAt(c+2),this.memory.charCodeAt(c+5)<<8|this.memory.charCodeAt(c+4),this.memory.charCodeAt(c+7)<<8|this.memory.charCodeAt(c+6)),this.v1.add(h.multiply(r)).rotl(31).multiply(s),c+=8,h=i(this.memory.charCodeAt(c+1)<<8|this.memory.charCodeAt(c),this.memory.charCodeAt(c+3)<<8|this.memory.charCodeAt(c+2),this.memory.charCodeAt(c+5)<<8|this.memory.charCodeAt(c+4),this.memory.charCodeAt(c+7)<<8|this.memory.charCodeAt(c+6)),this.v2.add(h.multiply(r)).rotl(31).multiply(s),c+=8,h=i(this.memory.charCodeAt(c+1)<<8|this.memory.charCodeAt(c),this.memory.charCodeAt(c+3)<<8|this.memory.charCodeAt(c+2),this.memory.charCodeAt(c+5)<<8|this.memory.charCodeAt(c+4),this.memory.charCodeAt(c+7)<<8|this.memory.charCodeAt(c+6)),this.v3.add(h.multiply(r)).rotl(31).multiply(s),c+=8,h=i(this.memory.charCodeAt(c+1)<<8|this.memory.charCodeAt(c),this.memory.charCodeAt(c+3)<<8|this.memory.charCodeAt(c+2),this.memory.charCodeAt(c+5)<<8|this.memory.charCodeAt(c+4),this.memory.charCodeAt(c+7)<<8|this.memory.charCodeAt(c+6)),this.v4.add(h.multiply(r)).rotl(31).multiply(s);else h=i(this.memory[c+1]<<8|this.memory[c],this.memory[c+3]<<8|this.memory[c+2],this.memory[c+5]<<8|this.memory[c+4],this.memory[c+7]<<8|this.memory[c+6]),this.v1.add(h.multiply(r)).rotl(31).multiply(s),c+=8,h=i(this.memory[c+1]<<8|this.memory[c],this.memory[c+3]<<8|this.memory[c+2],this.memory[c+5]<<8|this.memory[c+4],this.memory[c+7]<<8|this.memory[c+6]),this.v2.add(h.multiply(r)).rotl(31).multiply(s),c+=8,h=i(this.memory[c+1]<<8|this.memory[c],this.memory[c+3]<<8|this.memory[c+2],this.memory[c+5]<<8|this.memory[c+4],this.memory[c+7]<<8|this.memory[c+6]),this.v3.add(h.multiply(r)).rotl(31).multiply(s),c+=8,h=i(this.memory[c+1]<<8|this.memory[c],this.memory[c+3]<<8|this.memory[c+2],this.memory[c+5]<<8|this.memory[c+4],this.memory[c+7]<<8|this.memory[c+6]),this.v4.add(h.multiply(r)).rotl(31).multiply(s);o+=32-this.memsize,this.memsize=0,n&&(this.memory="")}if(o<=l-32){var d=l-32;do{var h;if(n)h=i(e.charCodeAt(o+1)<<8|e.charCodeAt(o),e.charCodeAt(o+3)<<8|e.charCodeAt(o+2),e.charCodeAt(o+5)<<8|e.charCodeAt(o+4),e.charCodeAt(o+7)<<8|e.charCodeAt(o+6)),this.v1.add(h.multiply(r)).rotl(31).multiply(s),o+=8,h=i(e.charCodeAt(o+1)<<8|e.charCodeAt(o),e.charCodeAt(o+3)<<8|e.charCodeAt(o+2),e.charCodeAt(o+5)<<8|e.charCodeAt(o+4),e.charCodeAt(o+7)<<8|e.charCodeAt(o+6)),this.v2.add(h.multiply(r)).rotl(31).multiply(s),o+=8,h=i(e.charCodeAt(o+1)<<8|e.charCodeAt(o),e.charCodeAt(o+3)<<8|e.charCodeAt(o+2),e.charCodeAt(o+5)<<8|e.charCodeAt(o+4),e.charCodeAt(o+7)<<8|e.charCodeAt(o+6)),this.v3.add(h.multiply(r)).rotl(31).multiply(s),o+=8,h=i(e.charCodeAt(o+1)<<8|e.charCodeAt(o),e.charCodeAt(o+3)<<8|e.charCodeAt(o+2),e.charCodeAt(o+5)<<8|e.charCodeAt(o+4),e.charCodeAt(o+7)<<8|e.charCodeAt(o+6)),this.v4.add(h.multiply(r)).rotl(31).multiply(s);else h=i(e[o+1]<<8|e[o],e[o+3]<<8|e[o+2],e[o+5]<<8|e[o+4],e[o+7]<<8|e[o+6]),this.v1.add(h.multiply(r)).rotl(31).multiply(s),h=i(e[(o+=8)+1]<<8|e[o],e[o+3]<<8|e[o+2],e[o+5]<<8|e[o+4],e[o+7]<<8|e[o+6]),this.v2.add(h.multiply(r)).rotl(31).multiply(s),h=i(e[(o+=8)+1]<<8|e[o],e[o+3]<<8|e[o+2],e[o+5]<<8|e[o+4],e[o+7]<<8|e[o+6]),this.v3.add(h.multiply(r)).rotl(31).multiply(s),h=i(e[(o+=8)+1]<<8|e[o],e[o+3]<<8|e[o+2],e[o+5]<<8|e[o+4],e[o+7]<<8|e[o+6]),this.v4.add(h.multiply(r)).rotl(31).multiply(s);o+=8}while(o<=d)}return o<l&&(n?this.memory+=e.slice(o):t?this.memory.set(e.subarray(o,l),this.memsize):e.copy(this.memory,this.memsize,o,l),this.memsize=l-o),this},c.prototype.digest=function(){var e,t,n=this.memory,c="string"==typeof n,d=0,h=this.memsize,u=new i;for(this.total_len>=32?((e=this.v1.clone().rotl(1)).add(this.v2.clone().rotl(7)),e.add(this.v3.clone().rotl(12)),e.add(this.v4.clone().rotl(18)),e.xor(this.v1.multiply(r).rotl(31).multiply(s)),e.multiply(s).add(a),e.xor(this.v2.multiply(r).rotl(31).multiply(s)),e.multiply(s).add(a),e.xor(this.v3.multiply(r).rotl(31).multiply(s)),e.multiply(s).add(a),e.xor(this.v4.multiply(r).rotl(31).multiply(s)),e.multiply(s).add(a)):e=this.seed.clone().add(l),e.add(u.fromNumber(this.total_len));d<=h-8;)c?u.fromBits(n.charCodeAt(d+1)<<8|n.charCodeAt(d),n.charCodeAt(d+3)<<8|n.charCodeAt(d+2),n.charCodeAt(d+5)<<8|n.charCodeAt(d+4),n.charCodeAt(d+7)<<8|n.charCodeAt(d+6)):u.fromBits(n[d+1]<<8|n[d],n[d+3]<<8|n[d+2],n[d+5]<<8|n[d+4],n[d+7]<<8|n[d+6]),u.multiply(r).rotl(31).multiply(s),e.xor(u).rotl(27).multiply(s).add(a),d+=8;for(d+4<=h&&(c?u.fromBits(n.charCodeAt(d+1)<<8|n.charCodeAt(d),n.charCodeAt(d+3)<<8|n.charCodeAt(d+2),0,0):u.fromBits(n[d+1]<<8|n[d],n[d+3]<<8|n[d+2],0,0),e.xor(u.multiply(s)).rotl(23).multiply(r).add(o),d+=4);d<h;)u.fromBits(c?n.charCodeAt(d++):n[d++],0,0,0),e.xor(u.multiply(l)).rotl(11).multiply(s);return t=e.clone().shiftRight(33),e.xor(t).multiply(r),t=e.clone().shiftRight(29),e.xor(t).multiply(o),t=e.clone().shiftRight(32),e.xor(t),this.init(this.seed),e},e.exports=c},"?d4c0":()=>{},"./node_modules/bloom-filters/dist/base-filter.js":function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var s=i(n("./node_modules/seedrandom/index.js")),r=i(n("./node_modules/bloom-filters/dist/hashing/hashing.js")),o=n("./node_modules/bloom-filters/dist/utils.js"),a=function(){function e(){this._seed=(0,o.getDefaultSeed)(),this._rng=(0,s.default)("".concat(this._seed)),this._hashing=new r.default}return Object.defineProperty(e.prototype,"seed",{get:function(){return this._seed},set:function(e){this._seed=e,this._rng=(0,s.default)("".concat(this._seed))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"random",{get:function(){return this._rng},enumerable:!1,configurable:!0}),e.prototype.nextInt32=function(){return this._rng.int32()},e.prototype.saveAsJSON=function(){throw new Error("not-implemented")},e.fromJSON=function(e){throw new Error("not-implemented")},e}();t.default=a},"./node_modules/bloom-filters/dist/bloom/bit-set.js":(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n("./node_modules/base64-arraybuffer/dist/base64-arraybuffer.es5.js"),s=function(){function e(e){var t=8-e%8;this.size=e+([0,8].includes(t)?0:t),this.array=new Uint8Array(Math.ceil(this.size/8))}return e.prototype.has=function(e){var t=Math.floor(e/8),n=1<<e%8;return!!(this.array[t]&n)},e.prototype.add=function(e){var t=Math.floor(e/8),n=1<<e%8;this.array[t]=this.array[t]|n},e.prototype.max=function(){for(var t=this.array.length-1;t>=0;t--){var n=this.array[t];if(n)return e.highBit(n)+8*t}return 0},e.prototype.bitCount=function(){for(var t=0,n=0;n<this.array.length;n++)t+=e.countBits(this.array[n]);return t},e.prototype.equals=function(e){if(e.size!==this.size)return!1;for(var t=0;t<this.array.length;t++)if(this.array[t]!==e.array[t])return!1;return!0},e.prototype.export=function(){return{size:this.size,content:(0,i.encode)(this.array)}},e.import=function(t){if("number"!=typeof t.size)throw Error("BitSet missing size");if("string"!=typeof t.content)throw Error("BitSet: missing content");var n=new e(t.size),s=(0,i.decode)(t.content);return n.array=new Uint8Array(s),n},e.highBit=function(e){for(var t=7,n=1<<t;t>=0&&(n&e)!==n;)n>>>=1,t--;return t},e.countBits=function(e){for(var t=1&e;0!==e;)t+=1&(e>>>=1);return t},e}();t.default=s},"./node_modules/bloom-filters/dist/bloom/partitioned-bloom-filter.js":function(e,t,n){"use strict";var i,s=this&&this.__extends||(i=function(e,t){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},i(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),r=this&&this.__decorate||function(e,t,n,i){var s,r=arguments.length,o=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(r<3?s(o):r>3?s(t,n,o):s(t,n))||o);return r>3&&o&&Object.defineProperty(t,n,o),o},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},a=this&&this.__param||function(e,t){return function(n,i){t(n,i,e)}},l=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var c=l(n("./node_modules/bloom-filters/dist/base-filter.js")),d=n("./node_modules/bloom-filters/dist/exportable.js"),h=n("./node_modules/bloom-filters/dist/utils.js"),u=l(n("./node_modules/bloom-filters/dist/bloom/bit-set.js"));var m=function(e){function t(t,n,i,s){var r=e.call(this)||this;return r._size=t,r._nbHashes=n,r._loadFactor=i,r._m=Math.ceil(r._size/r._nbHashes),r._filter=(0,h.allocateArray)(r._nbHashes,(function(){return new u.default(r._m)})),r._capacity=void 0!==s?s:function(e,t,n){return Math.ceil(e*(Math.log(t)*Math.log(1-t))/(-n*Math.log(t)))}(r._size,i,n),r}var n;return s(t,e),n=t,t.create=function(e,t,i){void 0===i&&(i=.5);var s=function(e,t,n){return Math.ceil(e*-Math.log(t)/(Math.log(n)*Math.log(1-n)))}(e,t,i),r=function(e,t){return Math.ceil(Math.log(e)/Math.log(t))}(t,i);return new n(s,r,i,e)},t.from=function(e,t,i){void 0===i&&(i=.5);var s=Array.from(e),r=n.create(s.length,t,i);return s.forEach((function(e){return r.add(e)})),r},Object.defineProperty(t.prototype,"capacity",{get:function(){return this._capacity},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._size},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"loadFactor",{get:function(){return this._loadFactor},enumerable:!1,configurable:!0}),t.prototype.add=function(e){for(var t=this._hashing.getIndexes(e,this._m,this._nbHashes,this.seed),n=0;n<this._nbHashes;n++)this._filter[n].add(t[n])},t.prototype.has=function(e){for(var t=this._hashing.getIndexes(e,this._m,this._nbHashes,this.seed),n=0;n<this._nbHashes;n++)if(!this._filter[n].has(t[n]))return!1;return!0},t.prototype.rate=function(){var e=this._currentload();return Math.pow(e,this._nbHashes)},t.prototype.equals=function(e){return this._size===e._size&&this._nbHashes===e._nbHashes&&this._loadFactor===e._loadFactor&&this._filter.every((function(t,n){return e._filter[n].equals(t)}))},t.prototype._currentload=function(){return this._filter.map((function(e){return e.bitCount()})).reduce((function(e,t){return e+t}),0)/this._size},r([(0,d.Field)(),o("design:type",Number)],t.prototype,"_size",void 0),r([(0,d.Field)(),o("design:type",Number)],t.prototype,"_nbHashes",void 0),r([(0,d.Field)(),o("design:type",Number)],t.prototype,"_loadFactor",void 0),r([(0,d.Field)(),o("design:type",Number)],t.prototype,"_m",void 0),r([(0,d.Field)((function(e){return e.map((function(e){return e.export()}))}),(function(e){return e.map((function(e){if(Array.isArray(e)){var t=new u.default(e.length);return e.forEach((function(e,n){0!==e&&t.add(n)})),t}return u.default.import(e)}))})),o("design:type",Array)],t.prototype,"_filter",void 0),r([(0,d.Field)(),o("design:type",Number)],t.prototype,"_capacity",void 0),t=n=r([(0,d.AutoExportable)("PartitionedBloomFilter",["_seed"]),a(0,(0,d.Parameter)("_size")),a(1,(0,d.Parameter)("_nbHashes")),a(2,(0,d.Parameter)("_loadFactor")),a(3,(0,d.Parameter)("_capacity")),o("design:paramtypes",[Number,Number,Number,Number])],t)}(c.default);t.default=m},"./node_modules/bloom-filters/dist/bloom/scalable-bloom-filter.js":function(e,t,n){"use strict";var i,s=this&&this.__extends||(i=function(e,t){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},i(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),r=this&&this.__decorate||function(e,t,n,i){var s,r=arguments.length,o=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(r<3?s(o):r>3?s(t,n,o):s(t,n))||o);return r>3&&o&&Object.defineProperty(t,n,o),o},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},a=this&&this.__param||function(e,t){return function(n,i){t(n,i,e)}},l=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var c=l(n("./node_modules/bloom-filters/dist/base-filter.js")),d=n("./node_modules/bloom-filters/dist/exportable.js"),h=l(n("./node_modules/bloom-filters/dist/bloom/partitioned-bloom-filter.js")),u=l(n("./node_modules/seedrandom/index.js")),m=function(e){function t(t,n,i){void 0===t&&(t=8),void 0===n&&(n=.01),void 0===i&&(i=.5);var s=e.call(this)||this;return s._filters=[],s._initial_size=t,s._error_rate=n,s._ratio=i,s._filters.push(h.default.create(s._initial_size,s._error_rate,s._ratio)),s._filters[s._filters.length-1].seed=s.seed,s}var n;return s(t,e),n=t,Object.defineProperty(t.prototype,"seed",{get:function(){return this._seed},set:function(e){var t=this;this._seed=e,this._rng=(0,u.default)("".concat(this._seed)),this._filters.forEach((function(e){e.seed=t.seed}))},enumerable:!1,configurable:!0}),t.prototype.add=function(e){var t=this._filters[this._filters.length-1];if(t._currentload()>t._loadFactor){var i=this._initial_size*Math.pow(n._s,this._filters.length+1)*Math.LN2,s=this._error_rate*Math.pow(this._ratio,this._filters.length);this._filters.push(h.default.create(i,s,this._ratio)),this._filters[this._filters.length-1].seed=this.seed}this._filters[this._filters.length-1].add(e)},t.prototype.has=function(e){return this._filters.some((function(t){return t.has(e)}))},t.prototype.capacity=function(){return this._filters.map((function(e){return e._capacity})).reduce((function(e,t){return e+t}),0)},t.prototype.rate=function(){return this._filters[this._filters.length-1].rate()},t.prototype.equals=function(e){return this.seed===e.seed&&this._ratio===e._ratio&&this.capacity()===e.capacity()&&this._filters.every((function(t,n){return e._filters[n].equals(t)}))},t.create=function(e,t,i){return void 0===i&&(i=.5),new n(e,t,i)},t._s=2,r([(0,d.Field)(),o("design:type",Number)],t.prototype,"_initial_size",void 0),r([(0,d.Field)(),o("design:type",Number)],t.prototype,"_error_rate",void 0),r([(0,d.Field)(),o("design:type",Number)],t.prototype,"_ratio",void 0),r([(0,d.Field)((function(e){return e.map((function(e){return e.saveAsJSON()}))}),(function(e){return e.map((function(e){return h.default.fromJSON(e)}))})),o("design:type",Array)],t.prototype,"_filters",void 0),t=n=r([(0,d.AutoExportable)("ScalableBloomFilter",["_seed"]),a(0,(0,d.Parameter)("_initial_size")),a(1,(0,d.Parameter)("_error_rate")),a(2,(0,d.Parameter)("_ratio")),o("design:paramtypes",[Object,Object,Object])],t)}(c.default);t.default=m},"./node_modules/bloom-filters/dist/exportable.js":function(e,t,n){"use strict";var i=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var i,s,r=n.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(i=r.next()).done;)o.push(i.value)}catch(e){s={error:e}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(s)throw s.error}}return o},s=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var i,s=0,r=t.length;s<r;s++)!i&&s in t||(i||(i=Array.prototype.slice.call(t,0,s)),i[s]=t[s]);return e.concat(i||Array.prototype.slice.call(t))};function r(e){return null==e?e:Array.isArray(e)?e.map(r):"object"==typeof e?"saveAsJSON"in e?e.saveAsJSON():Object.assign({},e):e}Object.defineProperty(t,"__esModule",{value:!0}),t.AutoExportable=t.Parameter=t.Field=t.Exportable=t.cloneObject=t.cloneField=void 0,n("./node_modules/reflect-metadata/Reflect.js"),t.cloneField=r,t.cloneObject=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return function(n){var i={type:e};return t.forEach((function(e){i[e]=r(n[e])})),i}},t.Exportable=function(e){return function(t){return t.prototype.saveAsJSON=function(){return e.export(this)},t.fromJSON=function(t){return e.import(t)},t}};var o=Symbol("bloom-filters:exportable:class-name"),a=Symbol("bloom-filters:exportable:fields"),l=Symbol("bloom-filters:exportable:constructor-parameters");t.Field=function(e,t){return void 0===e&&(e=r),void 0===t&&(t=function(e){return e}),function(n,i){var s=[];Reflect.hasMetadata(a,n)&&(s=Reflect.getMetadata(a,n)),s.push({name:i,exporter:e,importer:t}),Reflect.defineMetadata(a,s,n)}},t.Parameter=function(e){return function(t,n,i){var s=new Map;Reflect.hasMetadata(l,t)&&(s=Reflect.getMetadata(l,t)),s.set(e,i),Reflect.defineMetadata(l,s,t)}},t.AutoExportable=function(e,t){return void 0===t&&(t=[]),function(n){if(Reflect.defineMetadata(o,e,n.prototype),!Reflect.hasMetadata(a,n.prototype)||0===t.length)throw new SyntaxError("No exported fields declared when @AutoExportable is called");Reflect.hasMetadata(l,n)||Reflect.defineMetadata(l,new Map,n),n.prototype.saveAsJSON=function(){var e=this,i={type:Reflect.getMetadata(o,n.prototype)};return Reflect.getMetadata(a,n.prototype).forEach((function(t){i[t.name]=t.exporter(e[t.name])})),t.forEach((function(t){i[t]=r(e[t])})),i},n.fromJSON=function(e){var r=Reflect.getMetadata(o,n.prototype),c=Reflect.getMetadata(l,n),d=Reflect.getMetadata(a,n.prototype);if(e.type!==r)throw new Error("Cannot create an object ".concat(r,' from a JSON export with type "').concat(e.type,'"'));var h=[],u=[];t.map((function(e){return{name:e,importer:function(e){return e}}})).concat(d).forEach((function(t){if(!(t.name in e))throw new Error('Invalid import: required field "'.concat(t,'" not found in JSON export "').concat(e,'"'));c.has(t.name)?h[c.get(t.name)]=t.importer(e[t.name]):u.push({name:t.name,value:t.importer(e[t.name])})}));var m=new(n.bind.apply(n,s([void 0],i(h),!1)));return u.forEach((function(e){m[e.name]=e.value})),m}}}},"./node_modules/bloom-filters/dist/hashing/hashing.js":function(e,t,n){"use strict";var i=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var i,s,r=n.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(i=r.next()).done;)o.push(i.value)}catch(e){s={error:e}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(s)throw s.error}}return o},s=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var i,s=0,r=t.length;s<r;s++)!i&&s in t||(i||(i=Array.prototype.slice.call(t,0,s)),i[s]=t[s]);return e.concat(i||Array.prototype.slice.call(t))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var o=r(n("./node_modules/xxhashjs/lib/index.js")),a=n("./node_modules/bloom-filters/dist/utils.js"),l=function(){function e(){}return e.prototype.doubleHashing=function(e,t,n,i){return Math.abs((t+e*n+Math.floor((Math.pow(e,3)-e)/6))%i)},e.prototype.getDistinctIndexes=function(e,t,n,r){void 0===r&&(r=(0,a.getDefaultSeed)());for(var o=0,l=new Set,c=this.hashTwice(e,r);l.size<n;){var d=c.first%t;l.has(d)||l.add(d),c.first=(c.first+c.second)%t,c.second=(c.second+o)%t,++o>t&&(r++,c=this.hashTwice(e,r))}return s([],i(l.values()),!1)},e.prototype.getIndexes=function(e,t,n,i){void 0===i&&(i=(0,a.getDefaultSeed)());for(var s=[],r=this.hashTwice(e,i),o=0;o<n;o++)s.push(this.doubleHashing(o,r.first,r.second,t));return s},e.prototype.serialize=function(e,t){return t||(t=(0,a.getDefaultSeed)()),Number(o.default.h64(e,t).toNumber())},e.prototype.hashTwice=function(e,t){return void 0===t&&(t=(0,a.getDefaultSeed)()),{first:this.serialize(e,t+1),second:this.serialize(e,t+2)}},e.prototype.hashTwiceAsString=function(e,t){var n=this.hashTwice(e,t),i=n.first,s=n.second;return{first:(0,a.numberToHex)(i),second:(0,a.numberToHex)(s)}},e.prototype.hashTwiceIntAndString=function(e,t){void 0===t&&(t=(0,a.getDefaultSeed)());var n=this.hashIntAndString(e,t+1),i=this.hashIntAndString(e,t+2);return{int:{first:n.int,second:i.int},string:{first:n.string,second:i.string}}},e.prototype.hashAsInt=function(e,t){return void 0===t&&(t=(0,a.getDefaultSeed)()),this.serialize(e,t)},e.prototype.hashIntAndString=function(e,t){var n=this.hashAsInt(e,t);return{int:n,string:(0,a.numberToHex)(n)}},e}();t.default=l},"./node_modules/bloom-filters/dist/utils.js":function(e,t){"use strict";var n=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],i=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(t,"__esModule",{value:!0}),t.getDefaultSeed=t.isEmptyBuffer=t.xorBuffer=t.randomInt=t.numberToHex=t.allocateArray=t.BufferError=void 0,t.BufferError="The buffer class must be available, if you are a browser user use the buffer package (https://www.npmjs.com/package/buffer)",t.allocateArray=function(e,t){for(var n=new Array(e),i="function"==typeof t?t:function(){return t},s=0;s<e;s++)n[s]=i();return n},t.numberToHex=function(e){var t=Number(e).toString(16);return t.length%4!=0&&(t="0".repeat(4-t.length%4)+t),t},t.randomInt=function(e,t,n){void 0===n&&(n=Math.random),e=Math.ceil(e),t=Math.floor(t);var i=n();return Math.floor(i*(t-e+1))+e},t.xorBuffer=function(e,t){for(var n=Math.max(e.length,t.length),i=Buffer.allocUnsafe(n).fill(0),s=0;s<n;++s)s<e.length&&s<t.length?i[n-s-1]=e[e.length-s-1]^t[t.length-s-1]:s<e.length&&s>=t.length?i[n-s-1]^=e[e.length-s-1]:s<t.length&&s>=e.length&&(i[n-s-1]^=t[t.length-s-1]);for(var r=0,o=i.values(),a=o.next();!a.done&&0===a.value;)r++,a=o.next();return i.slice(r)},t.isEmptyBuffer=function(e){var t,i;if(null===e||!e)return!0;try{for(var s=n(e),r=s.next();!r.done;r=s.next()){if(0!==r.value)return!1}}catch(e){t={error:e}}finally{try{r&&!r.done&&(i=s.return)&&i.call(s)}finally{if(t)throw t.error}}return!0},t.getDefaultSeed=function(){return 78187493520}},"./node_modules/@vector-im/compound-design-tokens/assets/web/icons/overflow-horizontal.js":(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n("./node_modules/react/index.js"),s=n("./node_modules/react/jsx-runtime.js");function r(e,t){return(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,s.jsx)("path",{d:"M6 14c-.55 0-1.02-.196-1.412-.588A1.926 1.926 0 0 1 4 12c0-.55.196-1.02.588-1.412A1.926 1.926 0 0 1 6 10c.55 0 1.02.196 1.412.588.392.391.588.862.588 1.412 0 .55-.196 1.02-.588 1.412A1.926 1.926 0 0 1 6 14Zm6 0c-.55 0-1.02-.196-1.412-.588A1.926 1.926 0 0 1 10 12c0-.55.196-1.02.588-1.412A1.926 1.926 0 0 1 12 10c.55 0 1.02.196 1.412.588.392.391.588.862.588 1.412 0 .55-.196 1.02-.588 1.412A1.926 1.926 0 0 1 12 14Zm6 0c-.55 0-1.02-.196-1.413-.588A1.926 1.926 0 0 1 16 12c0-.55.196-1.02.587-1.412A1.926 1.926 0 0 1 18 10c.55 0 1.02.196 1.413.588.391.391.587.862.587 1.412 0 .55-.196 1.02-.587 1.412A1.926 1.926 0 0 1 18 14Z"})})}r.displayName="OverflowHorizontalIcon";const o=(0,i.forwardRef)(r)},"./node_modules/@vector-im/compound-design-tokens/assets/web/icons/pin-solid.js":(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n("./node_modules/react/index.js"),s=n("./node_modules/react/jsx-runtime.js");function r(e,t){return(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,s.jsx)("path",{d:"M5.769 2.857A.5.5 0 0 1 6.119 2h11.762a.5.5 0 0 1 .35.857L16.15 4.9a.5.5 0 0 0-.15.357v4.487a.5.5 0 0 0 .15.356l3.7 3.644a.5.5 0 0 1 .15.356v1.4a.5.5 0 0 1-.5.5H13v6a1 1 0 1 1-2 0v-6H4.5a.5.5 0 0 1-.5-.5v-1.4a.5.5 0 0 1 .15-.356l3.7-3.644A.5.5 0 0 0 8 9.744V5.257a.5.5 0 0 0-.15-.357L5.77 2.857Z"})})}r.displayName="PinSolidIcon";const o=(0,i.forwardRef)(r)},"./node_modules/@vector-im/compound-design-tokens/assets/web/icons/pin.js":(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n("./node_modules/react/index.js"),s=n("./node_modules/react/jsx-runtime.js");function r(e,t){return(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M6.119 2a.5.5 0 0 0-.35.857L7.85 4.9a.5.5 0 0 1 .15.357v4.487a.5.5 0 0 1-.15.356l-3.7 3.644A.5.5 0 0 0 4 14.1v1.4a.5.5 0 0 0 .5.5H11v6a1 1 0 1 0 2 0v-6h6.5a.5.5 0 0 0 .5-.5v-1.4a.5.5 0 0 0-.15-.356l-3.7-3.644a.5.5 0 0 1-.15-.356V5.257a.5.5 0 0 1 .15-.357l2.081-2.043a.5.5 0 0 0-.35-.857H6.119ZM10 4h4v5.744a2.5 2.5 0 0 0 .746 1.781L17.26 14H6.74l2.514-2.475A2.5 2.5 0 0 0 10 9.744V4Z",clipRule:"evenodd"})})}r.displayName="PinIcon";const o=(0,i.forwardRef)(r)},"./node_modules/@vector-im/compound-design-tokens/assets/web/icons/restart.js":(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n("./node_modules/react/index.js"),s=n("./node_modules/react/jsx-runtime.js");function r(e,t){return(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,s.jsx)("path",{d:"M18.93 8A8 8 0 1 1 4 12a1 1 0 1 0-2 0c0 5.523 4.477 10 10 10s10-4.477 10-10a9.966 9.966 0 0 0-.832-4A10.002 10.002 0 0 0 12 2a9.985 9.985 0 0 0-8 3.999V4a1 1 0 0 0-2 0v4a1 1 0 0 0 1 1h4a1 1 0 0 0 0-2H5.755A7.985 7.985 0 0 1 12 4a7.997 7.997 0 0 1 6.93 4Z"})})}r.displayName="RestartIcon";const o=(0,i.forwardRef)(r)},"./node_modules/@vector-im/compound-design-tokens/assets/web/icons/threads-solid.js":(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n("./node_modules/react/index.js"),s=n("./node_modules/react/jsx-runtime.js");function r(e,t){return(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,s.jsx)("path",{d:"M4 3h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6l-2.293 2.293c-.63.63-1.707.184-1.707-.707V5a2 2 0 0 1 2-2Zm3 7h10a.97.97 0 0 0 .712-.287A.967.967 0 0 0 18 9a.967.967 0 0 0-.288-.713A.968.968 0 0 0 17 8H7a.968.968 0 0 0-.713.287A.968.968 0 0 0 6 9c0 .283.096.52.287.713.192.191.43.287.713.287Zm0 4h6c.283 0 .52-.096.713-.287A.968.968 0 0 0 14 13a.968.968 0 0 0-.287-.713A.968.968 0 0 0 13 12H7a.967.967 0 0 0-.713.287A.968.968 0 0 0 6 13c0 .283.096.52.287.713.192.191.43.287.713.287Z"})})}r.displayName="ThreadsSolidIcon";const o=(0,i.forwardRef)(r)},"./node_modules/@vector-im/compound-design-tokens/assets/web/icons/unpin.js":(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n("./node_modules/react/index.js"),s=n("./node_modules/react/jsx-runtime.js");function r(e,t){return(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:[(0,s.jsx)("path",{fillRule:"evenodd",d:"M5.457 2.083a1 1 0 0 0-1.414 1.414L8.04 7.494v2.25a.5.5 0 0 1-.15.356l-3.7 3.644a.5.5 0 0 0-.15.356v1.4a.5.5 0 0 0 .5.5h6.5v6a1 1 0 0 0 2 0v-6h3.506l4.497 4.497a1 1 0 0 0 1.414-1.414l-17-17ZM14.546 14 10.04 9.494v.25a2.5 2.5 0 0 1-.746 1.781L6.78 14h7.766Z",clipRule:"evenodd"}),(0,s.jsx)("path",{d:"M14.04 4v3.85l2.015 2.015a.5.5 0 0 1-.015-.12V5.257a.5.5 0 0 1 .15-.357l2.081-2.043a.5.5 0 0 0-.35-.857h-9.73l2 2h3.849Z"})]})}r.displayName="UnpinIcon";const o=(0,i.forwardRef)(r)}}]);
//# sourceMappingURL=8841.js.map